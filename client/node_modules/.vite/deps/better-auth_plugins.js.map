{
  "version": 3,
  "sources": ["../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/client.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/utils/plugin-helper.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/admin/error-codes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/admin/has-permission.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/admin/routes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/admin/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/admin/admin.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/anonymous/error-codes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/anonymous/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/anonymous/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/adapter.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/rate-limit.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/routes/verify-api-key.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/routes/create-api-key.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/routes/delete-all-expired-api-keys.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/routes/delete-api-key.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/routes/get-api-key.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/routes/list-api-keys.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/routes/update-api-key.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/routes/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/client/parser.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/api-key/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/bearer/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/utils/middleware-response.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/captcha/constants.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/captcha/error-codes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/captcha/utils.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/captcha/verify-handlers/captchafox.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/captcha/verify-handlers/cloudflare-turnstile.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/captcha/verify-handlers/google-recaptcha.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/captcha/verify-handlers/h-captcha.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/captcha/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/custom-session/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/device-authorization/error-codes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/device-authorization/routes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/device-authorization/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/device-authorization/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/email-otp/utils.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/email-otp/otp-token.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/email-otp/routes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/email-otp/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/providers/auth0.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/providers/hubspot.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/providers/keycloak.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/providers/line.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/providers/microsoft-entra-id.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/providers/okta.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/providers/patreon.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/providers/slack.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/error-codes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/routes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/generic-oauth/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/haveibeenpwned/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/jwt/adapter.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/jwt/utils.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/jwt/sign.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/jwt/verify.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/jwt/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/jwt/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/last-login-method/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/magic-link/utils.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/magic-link/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/oidc-provider/error.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/oidc-provider/utils/prompt.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/oidc-provider/authorize.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/oidc-provider/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/oidc-provider/utils.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/oidc-provider/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/mcp/authorize.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/mcp/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/multi-session/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/oauth-proxy/utils.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/oauth-proxy/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/utils/boolean.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/one-tap/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/one-time-token/utils.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/one-time-token/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/open-api/generator.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/open-api/logo.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/open-api/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/adapter.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/access/statement.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/utils/shim.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/call.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/error-codes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/permission.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/has-permission.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/routes/crud-access-control.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/routes/crud-invites.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/routes/crud-members.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/routes/crud-org.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/routes/crud-team.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/organization/organization.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/phone-number/error-codes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/phone-number/routes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/phone-number/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/phone-number/index.ts", "../../../../node_modules/.bun/@noble+hashes@2.0.1/node_modules/@noble/hashes/src/sha3.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/utils/hashing.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/siwe/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/siwe/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/error-code.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/constant.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/verify-two-factor.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/backup-codes/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/utils.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/otp/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/schema.ts", "../../../../node_modules/.bun/@better-auth+utils@0.3.0/node_modules/@better-auth/utils/dist/base32.mjs", "../../../../node_modules/.bun/@better-auth+utils@0.3.0/node_modules/@better-auth/utils/dist/otp.mjs", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/totp/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/two-factor/index.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/username/error-codes.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/username/schema.ts", "../../../../node_modules/.bun/better-auth@1.4.10+2d8ddc2d470fbe56/node_modules/better-auth/src/plugins/username/index.ts"],
  "sourcesContent": ["import type { BetterAuthClientPlugin } from \"@better-auth/core\";\nimport type { twoFactor as twoFa } from \".\";\n\nexport const twoFactorClient = (\n\toptions?:\n\t\t| {\n\t\t\t\t/**\n\t\t\t\t * a redirect function to call if a user needs to verify\n\t\t\t\t * their two factor\n\t\t\t\t */\n\t\t\t\tonTwoFactorRedirect?: () => void | Promise<void>;\n\t\t  }\n\t\t| undefined,\n) => {\n\treturn {\n\t\tid: \"two-factor\",\n\t\t$InferServerPlugin: {} as ReturnType<typeof twoFa>,\n\t\tatomListeners: [\n\t\t\t{\n\t\t\t\tmatcher: (path) => path.startsWith(\"/two-factor/\"),\n\t\t\t\tsignal: \"$sessionSignal\",\n\t\t\t},\n\t\t],\n\t\tpathMethods: {\n\t\t\t\"/two-factor/disable\": \"POST\",\n\t\t\t\"/two-factor/enable\": \"POST\",\n\t\t\t\"/two-factor/send-otp\": \"POST\",\n\t\t\t\"/two-factor/generate-backup-codes\": \"POST\",\n\t\t},\n\t\tfetchPlugins: [\n\t\t\t{\n\t\t\t\tid: \"two-factor\",\n\t\t\t\tname: \"two-factor\",\n\t\t\t\thooks: {\n\t\t\t\t\tasync onSuccess(context) {\n\t\t\t\t\t\tif (context.data?.twoFactorRedirect) {\n\t\t\t\t\t\t\tif (options?.onTwoFactorRedirect) {\n\t\t\t\t\t\t\t\tawait options.onTwoFactorRedirect();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t],\n\t} satisfies BetterAuthClientPlugin;\n};\n\nexport type * from \"./backup-codes\";\nexport type * from \"./otp\";\nexport type * from \"./totp\";\nexport type * from \"./types\";\n", "import { APIError } from \"better-call\";\n\nexport const getEndpointResponse = async <T>(ctx: {\n\tcontext: {\n\t\treturned?: unknown;\n\t};\n}) => {\n\tconst returned = ctx.context.returned;\n\tif (!returned) {\n\t\treturn null;\n\t}\n\tif (returned instanceof Response) {\n\t\tif (returned.status !== 200) {\n\t\t\treturn null;\n\t\t}\n\t\treturn (await returned.clone().json()) as T;\n\t}\n\tif (returned instanceof APIError) {\n\t\treturn null;\n\t}\n\treturn returned as T;\n};\n", "// NOTE: Error code const must be all capital of string (ref https://github.com/better-auth/better-auth/issues/4386)\nimport { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const ADMIN_ERROR_CODES = defineErrorCodes({\n\tFAILED_TO_CREATE_USER: \"Failed to create user\",\n\tUSER_ALREADY_EXISTS: \"User already exists.\",\n\tUSER_ALREADY_EXISTS_USE_ANOTHER_EMAIL:\n\t\t\"User already exists. Use another email.\",\n\tYOU_CANNOT_BAN_YOURSELF: \"You cannot ban yourself\",\n\tYOU_ARE_NOT_ALLOWED_TO_CHANGE_USERS_ROLE:\n\t\t\"You are not allowed to change users role\",\n\tYOU_ARE_NOT_ALLOWED_TO_CREATE_USERS: \"You are not allowed to create users\",\n\tYOU_ARE_NOT_ALLOWED_TO_LIST_USERS: \"You are not allowed to list users\",\n\tYOU_ARE_NOT_ALLOWED_TO_LIST_USERS_SESSIONS:\n\t\t\"You are not allowed to list users sessions\",\n\tYOU_ARE_NOT_ALLOWED_TO_BAN_USERS: \"You are not allowed to ban users\",\n\tYOU_ARE_NOT_ALLOWED_TO_IMPERSONATE_USERS:\n\t\t\"You are not allowed to impersonate users\",\n\tYOU_ARE_NOT_ALLOWED_TO_REVOKE_USERS_SESSIONS:\n\t\t\"You are not allowed to revoke users sessions\",\n\tYOU_ARE_NOT_ALLOWED_TO_DELETE_USERS: \"You are not allowed to delete users\",\n\tYOU_ARE_NOT_ALLOWED_TO_SET_USERS_PASSWORD:\n\t\t\"You are not allowed to set users password\",\n\tBANNED_USER: \"You have been banned from this application\",\n\tYOU_ARE_NOT_ALLOWED_TO_GET_USER: \"You are not allowed to get user\",\n\tNO_DATA_TO_UPDATE: \"No data to update\",\n\tYOU_ARE_NOT_ALLOWED_TO_UPDATE_USERS: \"You are not allowed to update users\",\n\tYOU_CANNOT_REMOVE_YOURSELF: \"You cannot remove yourself\",\n\tYOU_ARE_NOT_ALLOWED_TO_SET_NON_EXISTENT_VALUE:\n\t\t\"You are not allowed to set a non-existent role value\",\n\tYOU_CANNOT_IMPERSONATE_ADMINS: \"You cannot impersonate admins\",\n\tINVALID_ROLE_TYPE: \"Invalid role type\",\n});\n", "import { defaultRoles } from \"./access\";\nimport type { AdminOptions } from \"./types\";\n\ntype PermissionExclusive =\n\t| {\n\t\t\t/**\n\t\t\t * @deprecated Use `permissions` instead\n\t\t\t */\n\t\t\tpermission: { [key: string]: string[] };\n\t\t\tpermissions?: never | undefined;\n\t  }\n\t| {\n\t\t\tpermissions: { [key: string]: string[] };\n\t\t\tpermission?: never | undefined;\n\t  };\n\nexport const hasPermission = (\n\tinput: {\n\t\tuserId?: string | undefined;\n\t\trole?: string | undefined;\n\t\toptions?: AdminOptions | undefined;\n\t} & PermissionExclusive,\n) => {\n\tif (input.userId && input.options?.adminUserIds?.includes(input.userId)) {\n\t\treturn true;\n\t}\n\tif (!input.permissions && !input.permission) {\n\t\treturn false;\n\t}\n\tconst roles = (input.role || input.options?.defaultRole || \"user\").split(\",\");\n\tconst acRoles = input.options?.roles || defaultRoles;\n\tfor (const role of roles) {\n\t\tconst _role = acRoles[role as keyof typeof acRoles];\n\t\tconst result = _role?.authorize(input.permission ?? input.permissions);\n\t\tif (result?.success) {\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n};\n", "import {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport type { Session } from \"@better-auth/core/db\";\nimport type { Where } from \"@better-auth/core/db/adapter\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport * as z from \"zod\";\nimport { APIError, getSessionFromCtx } from \"../../api\";\nimport { deleteSessionCookie, setSessionCookie } from \"../../cookies\";\nimport { parseUserOutput } from \"../../db/schema\";\nimport { getDate } from \"../../utils/date\";\nimport type { AccessControl } from \"../access\";\nimport type { defaultStatements } from \"./access\";\nimport { ADMIN_ERROR_CODES } from \"./error-codes\";\nimport { hasPermission } from \"./has-permission\";\nimport type {\n\tAdminOptions,\n\tInferAdminRolesFromOption,\n\tSessionWithImpersonatedBy,\n\tUserWithRole,\n} from \"./types\";\n\n/**\n * Ensures a valid session, if not will throw.\n * Will also provide additional types on the user to include role types.\n */\nconst adminMiddleware = createAuthMiddleware(async (ctx) => {\n\tconst session = await getSessionFromCtx(ctx);\n\tif (!session) {\n\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t}\n\treturn {\n\t\tsession,\n\t} as {\n\t\tsession: {\n\t\t\tuser: UserWithRole;\n\t\t\tsession: Session;\n\t\t};\n\t};\n});\n\nfunction parseRoles(roles: string | string[]): string {\n\treturn Array.isArray(roles) ? roles.join(\",\") : roles;\n}\n\nconst setRoleBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user id\",\n\t}),\n\trole: z\n\t\t.union([\n\t\t\tz.string().meta({\n\t\t\t\tdescription: \"The role to set. `admin` or `user` by default\",\n\t\t\t}),\n\t\t\tz.array(\n\t\t\t\tz.string().meta({\n\t\t\t\t\tdescription: \"The roles to set. `admin` or `user` by default\",\n\t\t\t\t}),\n\t\t\t),\n\t\t])\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"The role to set, this can be a string or an array of strings. Eg: `admin` or `[admin, user]`\",\n\t\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/admin/set-role`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.setRole`\n *\n * **client:**\n * `authClient.admin.setRole`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-set-role)\n */\nexport const setRole = <O extends AdminOptions>(opts: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/set-role\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: setRoleBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"setUserRole\",\n\t\t\t\t\tsummary: \"Set the role of a user\",\n\t\t\t\t\tdescription: \"Set the role of a user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"User role updated\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\tuserId: string;\n\t\t\t\t\t\trole: InferAdminRolesFromOption<O> | InferAdminRolesFromOption<O>[];\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst canSetRole = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: ctx.context.session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"set-role\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canSetRole) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CHANGE_USERS_ROLE,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst roles = opts.roles;\n\t\t\tif (roles) {\n\t\t\t\tconst inputRoles = Array.isArray(ctx.body.role)\n\t\t\t\t\t? ctx.body.role\n\t\t\t\t\t: [ctx.body.role];\n\t\t\t\tfor (const role of inputRoles) {\n\t\t\t\t\tif (!roles[role as keyof typeof roles]) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\t\tADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_SET_NON_EXISTENT_VALUE,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst updatedUser = await ctx.context.internalAdapter.updateUser(\n\t\t\t\tctx.body.userId,\n\t\t\t\t{\n\t\t\t\t\trole: parseRoles(ctx.body.role),\n\t\t\t\t},\n\t\t\t);\n\t\t\treturn ctx.json({\n\t\t\t\tuser: updatedUser as UserWithRole,\n\t\t\t});\n\t\t},\n\t);\n\nconst getUserQuerySchema = z.object({\n\tid: z.string().meta({\n\t\tdescription: \"The id of the User\",\n\t}),\n});\n\nexport const getUser = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/get-user\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: getUserQuerySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"getUser\",\n\t\t\t\t\tsummary: \"Get an existing user\",\n\t\t\t\t\tdescription: \"Get an existing user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"User\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { id } = ctx.query;\n\n\t\t\tconst canGetUser = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: ctx.context.session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"get\"],\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (!canGetUser) {\n\t\t\t\tthrow ctx.error(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_GET_USER,\n\t\t\t\t\tcode: \"YOU_ARE_NOT_ALLOWED_TO_GET_USER\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst user = await ctx.context.internalAdapter.findUserById(id);\n\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn parseUserOutput(ctx.context.options, user);\n\t\t},\n\t);\n\nconst createUserBodySchema = z.object({\n\temail: z.string().meta({\n\t\tdescription: \"The email of the user\",\n\t}),\n\tpassword: z.string().meta({\n\t\tdescription: \"The password of the user\",\n\t}),\n\tname: z.string().meta({\n\t\tdescription: \"The name of the user\",\n\t}),\n\trole: z\n\t\t.union([\n\t\t\tz.string().meta({\n\t\t\t\tdescription: \"The role of the user\",\n\t\t\t}),\n\t\t\tz.array(\n\t\t\t\tz.string().meta({\n\t\t\t\t\tdescription: \"The roles of user\",\n\t\t\t\t}),\n\t\t\t),\n\t\t])\n\t\t.optional()\n\t\t.meta({\n\t\t\tdescription: `A string or array of strings representing the roles to apply to the new user. Eg: \\\"user\\\"`,\n\t\t}),\n\t/**\n\t * extra fields for user\n\t */\n\tdata: z.record(z.string(), z.any()).optional().meta({\n\t\tdescription:\n\t\t\t\"Extra fields for the user. Including custom additional fields.\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/admin/create-user`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.createUser`\n *\n * **client:**\n * `authClient.admin.createUser`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-create-user)\n */\nexport const createUser = <O extends AdminOptions>(opts: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/create-user\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: createUserBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"createUser\",\n\t\t\t\t\tsummary: \"Create a new user\",\n\t\t\t\t\tdescription: \"Create a new user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"User created\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\temail: string;\n\t\t\t\t\t\tpassword: string;\n\t\t\t\t\t\tname: string;\n\t\t\t\t\t\trole?:\n\t\t\t\t\t\t\t| (InferAdminRolesFromOption<O> | InferAdminRolesFromOption<O>[])\n\t\t\t\t\t\t\t| undefined;\n\t\t\t\t\t\tdata?: Record<string, any> | undefined;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await getSessionFromCtx<{ role: string }>(ctx);\n\t\t\tif (!session && (ctx.request || ctx.headers)) {\n\t\t\t\tthrow ctx.error(\"UNAUTHORIZED\");\n\t\t\t}\n\t\t\tif (session) {\n\t\t\t\tconst canCreateUser = hasPermission({\n\t\t\t\t\tuserId: session.user.id,\n\t\t\t\t\trole: session.user.role,\n\t\t\t\t\toptions: opts,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tuser: [\"create\"],\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tif (!canCreateUser) {\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CREATE_USERS,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst email = ctx.body.email.toLowerCase();\n\t\t\tconst isValidEmail = z.email().safeParse(email);\n\t\t\tif (!isValidEmail.success) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst existUser =\n\t\t\t\tawait ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\tif (existUser) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = await ctx.context.internalAdapter.createUser<UserWithRole>({\n\t\t\t\temail: email,\n\t\t\t\tname: ctx.body.name,\n\t\t\t\trole:\n\t\t\t\t\t(ctx.body.role && parseRoles(ctx.body.role)) ??\n\t\t\t\t\topts?.defaultRole ??\n\t\t\t\t\t\"user\",\n\t\t\t\t...ctx.body.data,\n\t\t\t});\n\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.FAILED_TO_CREATE_USER,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst hashedPassword = await ctx.context.password.hash(ctx.body.password);\n\t\t\tawait ctx.context.internalAdapter.linkAccount({\n\t\t\t\taccountId: user.id,\n\t\t\t\tproviderId: \"credential\",\n\t\t\t\tpassword: hashedPassword,\n\t\t\t\tuserId: user.id,\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\tuser: user as UserWithRole,\n\t\t\t});\n\t\t},\n\t);\n\nconst adminUpdateUserBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user id\",\n\t}),\n\tdata: z.record(z.any(), z.any()).meta({\n\t\tdescription: \"The user data to update\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/admin/update-user`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.adminUpdateUser`\n *\n * **client:**\n * `authClient.admin.updateUser`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-update-user)\n */\nexport const adminUpdateUser = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/update-user\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: adminUpdateUserBodySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"updateUser\",\n\t\t\t\t\tsummary: \"Update a user\",\n\t\t\t\t\tdescription: \"Update a user's details\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"User updated\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst canUpdateUser = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: ctx.context.session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"update\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canUpdateUser) {\n\t\t\t\tthrow ctx.error(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_USERS,\n\t\t\t\t\tcode: \"YOU_ARE_NOT_ALLOWED_TO_UPDATE_USERS\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (Object.keys(ctx.body.data).length === 0) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.NO_DATA_TO_UPDATE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Role changes must be guarded by `user:set-role` and validated against the role allow-list.\n\t\t\tif (Object.prototype.hasOwnProperty.call(ctx.body.data, \"role\")) {\n\t\t\t\tconst canSetRole = hasPermission({\n\t\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\t\trole: ctx.context.session.user.role,\n\t\t\t\t\toptions: opts,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tuser: [\"set-role\"],\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tif (!canSetRole) {\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CHANGE_USERS_ROLE,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst roleValue = (ctx.body.data as Record<string, any>).role;\n\t\t\t\tconst inputRoles = Array.isArray(roleValue) ? roleValue : [roleValue];\n\t\t\t\tfor (const role of inputRoles) {\n\t\t\t\t\tif (typeof role !== \"string\") {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: ADMIN_ERROR_CODES.INVALID_ROLE_TYPE,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (opts.roles && !opts.roles[role as keyof typeof opts.roles]) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\t\tADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_SET_NON_EXISTENT_VALUE,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t(ctx.body.data as Record<string, any>).role = parseRoles(\n\t\t\t\t\tinputRoles as string[],\n\t\t\t\t);\n\t\t\t}\n\t\t\tconst updatedUser = await ctx.context.internalAdapter.updateUser(\n\t\t\t\tctx.body.userId,\n\t\t\t\tctx.body.data,\n\t\t\t);\n\n\t\t\treturn ctx.json(updatedUser as UserWithRole);\n\t\t},\n\t);\n\nconst listUsersQuerySchema = z.object({\n\tsearchValue: z.string().optional().meta({\n\t\tdescription: 'The value to search for. Eg: \"some name\"',\n\t}),\n\tsearchField: z\n\t\t.enum([\"email\", \"name\"])\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The field to search in, defaults to email. Can be `email` or `name`. Eg: \"name\"',\n\t\t})\n\t\t.optional(),\n\tsearchOperator: z\n\t\t.enum([\"contains\", \"starts_with\", \"ends_with\"])\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The operator to use for the search. Can be `contains`, `starts_with` or `ends_with`. Eg: \"contains\"',\n\t\t})\n\t\t.optional(),\n\tlimit: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The number of users to return\",\n\t\t})\n\t\t.or(z.number())\n\t\t.optional(),\n\toffset: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The offset to start from\",\n\t\t})\n\t\t.or(z.number())\n\t\t.optional(),\n\tsortBy: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The field to sort by\",\n\t\t})\n\t\t.optional(),\n\tsortDirection: z\n\t\t.enum([\"asc\", \"desc\"])\n\t\t.meta({\n\t\t\tdescription: \"The direction to sort by\",\n\t\t})\n\t\t.optional(),\n\tfilterField: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The field to filter by\",\n\t\t})\n\t\t.optional(),\n\tfilterValue: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The value to filter by\",\n\t\t})\n\t\t.or(z.number())\n\t\t.or(z.boolean())\n\t\t.optional(),\n\tfilterOperator: z\n\t\t.enum([\"eq\", \"ne\", \"lt\", \"lte\", \"gt\", \"gte\", \"contains\"])\n\t\t.meta({\n\t\t\tdescription: \"The operator to use for the filter\",\n\t\t})\n\t\t.optional(),\n});\n\nexport const listUsers = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/list-users\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tuse: [adminMiddleware],\n\t\t\tquery: listUsersQuerySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"listUsers\",\n\t\t\t\t\tsummary: \"List users\",\n\t\t\t\t\tdescription: \"List users\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"List of users\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tusers: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\ttotal: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tlimit: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\toffset: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"users\", \"total\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst canListUsers = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"list\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canListUsers) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_LIST_USERS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst where: Where[] = [];\n\n\t\t\tif (ctx.query?.searchValue) {\n\t\t\t\twhere.push({\n\t\t\t\t\tfield: ctx.query.searchField || \"email\",\n\t\t\t\t\toperator: ctx.query.searchOperator || \"contains\",\n\t\t\t\t\tvalue: ctx.query.searchValue,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (ctx.query?.filterValue) {\n\t\t\t\twhere.push({\n\t\t\t\t\tfield: ctx.query.filterField || \"email\",\n\t\t\t\t\toperator: ctx.query.filterOperator || \"eq\",\n\t\t\t\t\tvalue: ctx.query.filterValue,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst users = await ctx.context.internalAdapter.listUsers(\n\t\t\t\t\tNumber(ctx.query?.limit) || undefined,\n\t\t\t\t\tNumber(ctx.query?.offset) || undefined,\n\t\t\t\t\tctx.query?.sortBy\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tfield: ctx.query.sortBy,\n\t\t\t\t\t\t\t\tdirection: ctx.query.sortDirection || \"asc\",\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: undefined,\n\t\t\t\t\twhere.length ? where : undefined,\n\t\t\t\t);\n\t\t\t\tconst total = await ctx.context.internalAdapter.countTotalUsers(\n\t\t\t\t\twhere.length ? where : undefined,\n\t\t\t\t);\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tusers: users as UserWithRole[],\n\t\t\t\t\ttotal: total,\n\t\t\t\t\tlimit: Number(ctx.query?.limit) || undefined,\n\t\t\t\t\toffset: Number(ctx.query?.offset) || undefined,\n\t\t\t\t});\n\t\t\t} catch {\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tusers: [],\n\t\t\t\t\ttotal: 0,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t);\n\nconst listUserSessionsBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user id\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/admin/list-user-sessions`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.listUserSessions`\n *\n * **client:**\n * `authClient.admin.listUserSessions`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-list-user-sessions)\n */\nexport const listUserSessions = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/list-user-sessions\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tuse: [adminMiddleware],\n\t\t\tbody: listUserSessionsBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"listUserSessions\",\n\t\t\t\t\tsummary: \"List user sessions\",\n\t\t\t\t\tdescription: \"List user sessions\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"List of user sessions\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsessions: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst canListSessions = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tsession: [\"list\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canListSessions) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_LIST_USERS_SESSIONS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst sessions: SessionWithImpersonatedBy[] =\n\t\t\t\tawait ctx.context.internalAdapter.listSessions(ctx.body.userId);\n\t\t\treturn {\n\t\t\t\tsessions: sessions,\n\t\t\t};\n\t\t},\n\t);\n\nconst unbanUserBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user id\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/admin/unban-user`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.unbanUser`\n *\n * **client:**\n * `authClient.admin.unbanUser`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-unban-user)\n */\nexport const unbanUser = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/unban-user\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: unbanUserBodySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"unbanUser\",\n\t\t\t\t\tsummary: \"Unban a user\",\n\t\t\t\t\tdescription: \"Unban a user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"User unbanned\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst canBanUser = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"ban\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canBanUser) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_BAN_USERS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst user = await ctx.context.internalAdapter.updateUser(\n\t\t\t\tctx.body.userId,\n\t\t\t\t{\n\t\t\t\t\tbanned: false,\n\t\t\t\t\tbanExpires: null,\n\t\t\t\t\tbanReason: null,\n\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t},\n\t\t\t);\n\t\t\treturn ctx.json({\n\t\t\t\tuser: user,\n\t\t\t});\n\t\t},\n\t);\n\nconst banUserBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user id\",\n\t}),\n\t/**\n\t * Reason for the ban\n\t */\n\tbanReason: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The reason for the ban\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * Number of seconds until the ban expires\n\t */\n\tbanExpiresIn: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription: \"The number of seconds until the ban expires\",\n\t\t})\n\t\t.optional(),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/admin/ban-user`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.banUser`\n *\n * **client:**\n * `authClient.admin.banUser`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-ban-user)\n */\nexport const banUser = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/ban-user\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: banUserBodySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"banUser\",\n\t\t\t\t\tsummary: \"Ban a user\",\n\t\t\t\t\tdescription: \"Ban a user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"User banned\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst canBanUser = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"ban\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canBanUser) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_BAN_USERS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst foundUser = await ctx.context.internalAdapter.findUserById(\n\t\t\t\tctx.body.userId,\n\t\t\t);\n\n\t\t\tif (!foundUser) {\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (ctx.body.userId === ctx.context.session.user.id) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_CANNOT_BAN_YOURSELF,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = await ctx.context.internalAdapter.updateUser(\n\t\t\t\tctx.body.userId,\n\t\t\t\t{\n\t\t\t\t\tbanned: true,\n\t\t\t\t\tbanReason:\n\t\t\t\t\t\tctx.body.banReason || opts?.defaultBanReason || \"No reason\",\n\t\t\t\t\tbanExpires: ctx.body.banExpiresIn\n\t\t\t\t\t\t? getDate(ctx.body.banExpiresIn, \"sec\")\n\t\t\t\t\t\t: opts?.defaultBanExpiresIn\n\t\t\t\t\t\t\t? getDate(opts.defaultBanExpiresIn, \"sec\")\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t},\n\t\t\t);\n\t\t\t//revoke all sessions\n\t\t\tawait ctx.context.internalAdapter.deleteSessions(ctx.body.userId);\n\t\t\treturn ctx.json({\n\t\t\t\tuser: user,\n\t\t\t});\n\t\t},\n\t);\n\nconst impersonateUserBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user id\",\n\t}),\n});\n/**\n * ### Endpoint\n *\n * POST `/admin/impersonate-user`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.impersonateUser`\n *\n * **client:**\n * `authClient.admin.impersonateUser`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-impersonate-user)\n */\nexport const impersonateUser = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/impersonate-user\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: impersonateUserBodySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"impersonateUser\",\n\t\t\t\t\tsummary: \"Impersonate a user\",\n\t\t\t\t\tdescription: \"Impersonate a user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Impersonation session created\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst canImpersonateUser = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: ctx.context.session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"impersonate\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canImpersonateUser) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_IMPERSONATE_USERS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst targetUser = (await ctx.context.internalAdapter.findUserById(\n\t\t\t\tctx.body.userId,\n\t\t\t)) as UserWithRole | null;\n\n\t\t\tif (!targetUser) {\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: \"User not found\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst adminRoles = (\n\t\t\t\tArray.isArray(opts.adminRoles)\n\t\t\t\t\t? opts.adminRoles\n\t\t\t\t\t: opts.adminRoles?.split(\",\") || []\n\t\t\t).map((role) => role.trim());\n\t\t\tconst targetUserRole = (\n\t\t\t\ttargetUser.role ||\n\t\t\t\topts.defaultRole ||\n\t\t\t\t\"user\"\n\t\t\t).split(\",\");\n\t\t\tif (\n\t\t\t\topts.allowImpersonatingAdmins !== true &&\n\t\t\t\t(targetUserRole.some((role) => adminRoles.includes(role)) ||\n\t\t\t\t\topts.adminUserIds?.includes(targetUser.id))\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_CANNOT_IMPERSONATE_ADMINS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\ttargetUser.id,\n\t\t\t\ttrue,\n\t\t\t\t{\n\t\t\t\t\timpersonatedBy: ctx.context.session.user.id,\n\t\t\t\t\texpiresAt: opts?.impersonationSessionDuration\n\t\t\t\t\t\t? getDate(opts.impersonationSessionDuration, \"sec\")\n\t\t\t\t\t\t: getDate(60 * 60, \"sec\"), // 1 hour\n\t\t\t\t},\n\t\t\t\ttrue,\n\t\t\t);\n\t\t\tif (!session) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.FAILED_TO_CREATE_USER,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst authCookies = ctx.context.authCookies;\n\t\t\tdeleteSessionCookie(ctx);\n\t\t\tconst dontRememberMeCookie = await ctx.getSignedCookie(\n\t\t\t\tctx.context.authCookies.dontRememberToken.name,\n\t\t\t\tctx.context.secret,\n\t\t\t);\n\t\t\tconst adminCookieProp = ctx.context.createAuthCookie(\"admin_session\");\n\t\t\tawait ctx.setSignedCookie(\n\t\t\t\tadminCookieProp.name,\n\t\t\t\t`${ctx.context.session.session.token}:${dontRememberMeCookie || \"\"}`,\n\t\t\t\tctx.context.secret,\n\t\t\t\tauthCookies.sessionToken.options,\n\t\t\t);\n\t\t\tawait setSessionCookie(\n\t\t\t\tctx,\n\t\t\t\t{\n\t\t\t\t\tsession: session,\n\t\t\t\t\tuser: targetUser,\n\t\t\t\t},\n\t\t\t\ttrue,\n\t\t\t);\n\t\t\treturn ctx.json({\n\t\t\t\tsession: session,\n\t\t\t\tuser: targetUser,\n\t\t\t});\n\t\t},\n\t);\n\n/**\n * ### Endpoint\n *\n * POST `/admin/stop-impersonating`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.stopImpersonating`\n *\n * **client:**\n * `authClient.admin.stopImpersonating`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-stop-impersonating)\n */\nexport const stopImpersonating = () =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/stop-impersonating\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\trequireHeaders: true,\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await getSessionFromCtx<\n\t\t\t\t{},\n\t\t\t\t{\n\t\t\t\t\timpersonatedBy: string;\n\t\t\t\t}\n\t\t\t>(ctx);\n\t\t\tif (!session) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t\t\t}\n\t\t\tif (!session.session.impersonatedBy) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"You are not impersonating anyone\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = await ctx.context.internalAdapter.findUserById(\n\t\t\t\tsession.session.impersonatedBy,\n\t\t\t);\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: \"Failed to find user\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adminCookieName =\n\t\t\t\tctx.context.createAuthCookie(\"admin_session\").name;\n\t\t\tconst adminCookie = await ctx.getSignedCookie(\n\t\t\t\tadminCookieName,\n\t\t\t\tctx.context.secret,\n\t\t\t);\n\n\t\t\tif (!adminCookie) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: \"Failed to find admin session\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst [adminSessionToken, dontRememberMeCookie] = adminCookie?.split(\":\");\n\t\t\tconst adminSession = await ctx.context.internalAdapter.findSession(\n\t\t\t\tadminSessionToken!,\n\t\t\t);\n\t\t\tif (!adminSession || adminSession.session.userId !== user.id) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: \"Failed to find admin session\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tawait ctx.context.internalAdapter.deleteSession(session.session.token);\n\t\t\tawait setSessionCookie(ctx, adminSession, !!dontRememberMeCookie);\n\t\t\tawait ctx.setSignedCookie(adminCookieName, \"\", ctx.context.secret, {\n\t\t\t\t...ctx.context.authCookies.sessionToken.options,\n\t\t\t\tmaxAge: 0,\n\t\t\t});\n\t\t\treturn ctx.json(adminSession);\n\t\t},\n\t);\n\nconst revokeUserSessionBodySchema = z.object({\n\tsessionToken: z.string().meta({\n\t\tdescription: \"The session token\",\n\t}),\n});\n/**\n * ### Endpoint\n *\n * POST `/admin/revoke-user-session`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.revokeUserSession`\n *\n * **client:**\n * `authClient.admin.revokeUserSession`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-revoke-user-session)\n */\nexport const revokeUserSession = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/revoke-user-session\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: revokeUserSessionBodySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"revokeUserSession\",\n\t\t\t\t\tsummary: \"Revoke a user session\",\n\t\t\t\t\tdescription: \"Revoke a user session\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Session revoked\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst canRevokeSession = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tsession: [\"revoke\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canRevokeSession) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_REVOKE_USERS_SESSIONS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait ctx.context.internalAdapter.deleteSession(ctx.body.sessionToken);\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst revokeUserSessionsBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user id\",\n\t}),\n});\n/**\n * ### Endpoint\n *\n * POST `/admin/revoke-user-sessions`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.revokeUserSessions`\n *\n * **client:**\n * `authClient.admin.revokeUserSessions`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-revoke-user-sessions)\n */\nexport const revokeUserSessions = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/revoke-user-sessions\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: revokeUserSessionsBodySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"revokeUserSessions\",\n\t\t\t\t\tsummary: \"Revoke all user sessions\",\n\t\t\t\t\tdescription: \"Revoke all user sessions\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Sessions revoked\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst canRevokeSession = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tsession: [\"revoke\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canRevokeSession) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_REVOKE_USERS_SESSIONS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait ctx.context.internalAdapter.deleteSessions(ctx.body.userId);\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst removeUserBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user id\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/admin/remove-user`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.removeUser`\n *\n * **client:**\n * `authClient.admin.removeUser`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-remove-user)\n */\nexport const removeUser = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/remove-user\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: removeUserBodySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"removeUser\",\n\t\t\t\t\tsummary: \"Remove a user\",\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"Delete a user and all their sessions and accounts. Cannot be undone.\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"User removed\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst canDeleteUser = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"delete\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canDeleteUser) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_DELETE_USERS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (ctx.body.userId === ctx.context.session.user.id) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_CANNOT_REMOVE_YOURSELF,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst user = await ctx.context.internalAdapter.findUserById(\n\t\t\t\tctx.body.userId,\n\t\t\t);\n\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: \"User not found\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait ctx.context.internalAdapter.deleteUser(ctx.body.userId);\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst setUserPasswordBodySchema = z.object({\n\tnewPassword: z.string().nonempty(\"newPassword cannot be empty\").meta({\n\t\tdescription: \"The new password\",\n\t}),\n\tuserId: z.coerce.string().nonempty(\"userId cannot be empty\").meta({\n\t\tdescription: \"The user id\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/admin/set-user-password`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.setUserPassword`\n *\n * **client:**\n * `authClient.admin.setUserPassword`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-set-user-password)\n */\nexport const setUserPassword = (opts: AdminOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/admin/set-user-password\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: setUserPasswordBodySchema,\n\t\t\tuse: [adminMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"setUserPassword\",\n\t\t\t\t\tsummary: \"Set a user's password\",\n\t\t\t\t\tdescription: \"Set a user's password\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Password set\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst canSetUserPassword = hasPermission({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\trole: ctx.context.session.user.role,\n\t\t\t\toptions: opts,\n\t\t\t\tpermissions: {\n\t\t\t\t\tuser: [\"set-password\"],\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!canSetUserPassword) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ADMIN_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_SET_USERS_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst { newPassword, userId } = ctx.body;\n\t\t\tconst minPasswordLength = ctx.context.password.config.minPasswordLength;\n\t\t\tif (newPassword.length < minPasswordLength) {\n\t\t\t\tctx.context.logger.error(\"Password is too short\");\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_SHORT,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst maxPasswordLength = ctx.context.password.config.maxPasswordLength;\n\t\t\tif (newPassword.length > maxPasswordLength) {\n\t\t\t\tctx.context.logger.error(\"Password is too long\");\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_LONG,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst hashedPassword = await ctx.context.password.hash(newPassword);\n\t\t\tawait ctx.context.internalAdapter.updatePassword(userId, hashedPassword);\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst userHasPermissionBodySchema = z\n\t.object({\n\t\tuserId: z.coerce.string().optional().meta({\n\t\t\tdescription: `The user id. Eg: \"user-id\"`,\n\t\t}),\n\t\trole: z.string().optional().meta({\n\t\t\tdescription: `The role to check permission for. Eg: \"admin\"`,\n\t\t}),\n\t})\n\t.and(\n\t\tz.union([\n\t\t\tz.object({\n\t\t\t\tpermission: z.record(z.string(), z.array(z.string())),\n\t\t\t\tpermissions: z.undefined(),\n\t\t\t}),\n\t\t\tz.object({\n\t\t\t\tpermission: z.undefined(),\n\t\t\t\tpermissions: z.record(z.string(), z.array(z.string())),\n\t\t\t}),\n\t\t]),\n\t);\n\n/**\n * ### Endpoint\n *\n * POST `/admin/has-permission`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.userHasPermission`\n *\n * **client:**\n * `authClient.admin.hasPermission`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/admin#api-method-admin-has-permission)\n */\nexport const userHasPermission = <O extends AdminOptions>(opts: O) => {\n\ttype DefaultStatements = typeof defaultStatements;\n\ttype Statements =\n\t\tO[\"ac\"] extends AccessControl<infer S> ? S : DefaultStatements;\n\n\ttype PermissionType = {\n\t\t[key in keyof Statements]?: Array<\n\t\t\tStatements[key] extends readonly unknown[]\n\t\t\t\t? Statements[key][number]\n\t\t\t\t: never\n\t\t>;\n\t};\n\ttype PermissionExclusive =\n\t\t| {\n\t\t\t\t/**\n\t\t\t\t * @deprecated Use `permissions` instead\n\t\t\t\t */\n\t\t\t\tpermission: PermissionType;\n\t\t\t\tpermissions?: never | undefined;\n\t\t  }\n\t\t| {\n\t\t\t\tpermissions: PermissionType;\n\t\t\t\tpermission?: never | undefined;\n\t\t  };\n\n\treturn createAuthEndpoint(\n\t\t\"/admin/has-permission\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: userHasPermissionBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Check if the user has permission\",\n\t\t\t\t\trequestBody: {\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tpermission: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The permission to check\",\n\t\t\t\t\t\t\t\t\t\t\tdeprecated: true,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The permission to check\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"permissions\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"success\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as PermissionExclusive & {\n\t\t\t\t\t\tuserId?: string | undefined;\n\t\t\t\t\t\trole?: InferAdminRolesFromOption<O> | undefined;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (!ctx.body?.permission && !ctx.body?.permissions) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"invalid permission check. no permission(s) were passed.\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\n\t\t\tif (!session && (ctx.request || ctx.headers)) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t\t\t}\n\t\t\tif (!session && !ctx.body.userId && !ctx.body.role) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"user id or role is required\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user =\n\t\t\t\tsession?.user ||\n\t\t\t\t(ctx.body.role\n\t\t\t\t\t? { id: ctx.body.userId || \"\", role: ctx.body.role }\n\t\t\t\t\t: null) ||\n\t\t\t\t(ctx.body.userId\n\t\t\t\t\t? ((await ctx.context.internalAdapter.findUserById(\n\t\t\t\t\t\t\tctx.body.userId as string,\n\t\t\t\t\t\t)) as { role?: string | undefined; id: string })\n\t\t\t\t\t: null);\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"user not found\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst result = hasPermission({\n\t\t\t\tuserId: user.id,\n\t\t\t\trole: user.role,\n\t\t\t\toptions: opts as AdminOptions,\n\t\t\t\tpermissions: (ctx.body.permissions ?? ctx.body.permission) as any,\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\terror: null,\n\t\t\t\tsuccess: result,\n\t\t\t});\n\t\t},\n\t);\n};\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\n\nexport const schema = {\n\tuser: {\n\t\tfields: {\n\t\t\trole: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t\tinput: false,\n\t\t\t},\n\t\t\tbanned: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdefaultValue: false,\n\t\t\t\trequired: false,\n\t\t\t\tinput: false,\n\t\t\t},\n\t\t\tbanReason: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t\tinput: false,\n\t\t\t},\n\t\t\tbanExpires: {\n\t\t\t\ttype: \"date\",\n\t\t\t\trequired: false,\n\t\t\t\tinput: false,\n\t\t\t},\n\t\t},\n\t},\n\tsession: {\n\t\tfields: {\n\t\t\timpersonatedBy: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t},\n\t},\n} satisfies BetterAuthPluginDBSchema;\n\nexport type AdminSchema = typeof schema;\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { createAuthMiddleware } from \"@better-auth/core/api\";\nimport { BetterAuthError } from \"@better-auth/core/error\";\nimport { APIError } from \"../../api\";\nimport { mergeSchema } from \"../../db/schema\";\nimport { getEndpointResponse } from \"../../utils/plugin-helper\";\nimport { defaultRoles } from \"./access\";\nimport { ADMIN_ERROR_CODES } from \"./error-codes\";\nimport {\n\tadminUpdateUser,\n\tbanUser,\n\tcreateUser,\n\tgetUser,\n\timpersonateUser,\n\tlistUserSessions,\n\tlistUsers,\n\tremoveUser,\n\trevokeUserSession,\n\trevokeUserSessions,\n\tsetRole,\n\tsetUserPassword,\n\tstopImpersonating,\n\tunbanUser,\n\tuserHasPermission,\n} from \"./routes\";\nimport { schema } from \"./schema\";\nimport type {\n\tAdminOptions,\n\tSessionWithImpersonatedBy,\n\tUserWithRole,\n} from \"./types\";\n\nexport const admin = <O extends AdminOptions>(options?: O | undefined) => {\n\tconst opts = {\n\t\t...(options || {}),\n\t\tdefaultRole: options?.defaultRole ?? \"user\",\n\t\tadminRoles: options?.adminRoles ?? [\"admin\"],\n\t\tbannedUserMessage:\n\t\t\toptions?.bannedUserMessage ??\n\t\t\t\"You have been banned from this application. Please contact support if you believe this is an error.\",\n\t} as O &\n\t\tRequired<\n\t\t\tPick<AdminOptions, \"defaultRole\" | \"adminRoles\" | \"bannedUserMessage\">\n\t\t>;\n\n\tif (options?.adminRoles) {\n\t\tconst adminRoles = Array.isArray(options.adminRoles)\n\t\t\t? options.adminRoles\n\t\t\t: [...options.adminRoles.split(\",\")];\n\t\tconst invalidRoles = adminRoles.filter(\n\t\t\t(role) =>\n\t\t\t\t!Object.keys(options?.roles || defaultRoles)\n\t\t\t\t\t.map((r) => r.toLowerCase())\n\t\t\t\t\t.includes(role.toLowerCase()),\n\t\t);\n\t\tif (invalidRoles.length > 0) {\n\t\t\tthrow new BetterAuthError(\n\t\t\t\t`Invalid admin roles: ${invalidRoles.join(\", \")}. Admin roles must be defined in the 'roles' configuration.`,\n\t\t\t);\n\t\t}\n\t}\n\n\treturn {\n\t\tid: \"admin\",\n\t\tinit() {\n\t\t\treturn {\n\t\t\t\toptions: {\n\t\t\t\t\tdatabaseHooks: {\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tcreate: {\n\t\t\t\t\t\t\t\tasync before(user) {\n\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\t\t\trole: options?.defaultRole ?? \"user\",\n\t\t\t\t\t\t\t\t\t\t\t...user,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\tcreate: {\n\t\t\t\t\t\t\t\tasync before(session, ctx) {\n\t\t\t\t\t\t\t\t\tif (!ctx) {\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tconst user = (await ctx.context.internalAdapter.findUserById(\n\t\t\t\t\t\t\t\t\t\tsession.userId,\n\t\t\t\t\t\t\t\t\t)) as UserWithRole;\n\n\t\t\t\t\t\t\t\t\tif (user.banned) {\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\tuser.banExpires &&\n\t\t\t\t\t\t\t\t\t\t\tnew Date(user.banExpires).getTime() < Date.now()\n\t\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\t\tawait ctx.context.internalAdapter.updateUser(\n\t\t\t\t\t\t\t\t\t\t\t\tsession.userId,\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\tbanned: false,\n\t\t\t\t\t\t\t\t\t\t\t\t\tbanReason: null,\n\t\t\t\t\t\t\t\t\t\t\t\t\tbanExpires: null,\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\tctx &&\n\t\t\t\t\t\t\t\t\t\t\t(ctx.path.startsWith(\"/callback\") ||\n\t\t\t\t\t\t\t\t\t\t\t\tctx.path.startsWith(\"/oauth2/callback\"))\n\t\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\t\tconst redirectURI =\n\t\t\t\t\t\t\t\t\t\t\t\tctx.context.options.onAPIError?.errorURL ||\n\t\t\t\t\t\t\t\t\t\t\t\t`${ctx.context.baseURL}/error`;\n\t\t\t\t\t\t\t\t\t\t\tthrow ctx.redirect(\n\t\t\t\t\t\t\t\t\t\t\t\t`${redirectURI}?error=banned&error_description=${opts.bannedUserMessage}`,\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\t\t\t\t\t\tmessage: opts.bannedUserMessage,\n\t\t\t\t\t\t\t\t\t\t\tcode: \"BANNED_USER\",\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn context.path === \"/list-sessions\";\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst response =\n\t\t\t\t\t\t\tawait getEndpointResponse<SessionWithImpersonatedBy[]>(ctx);\n\n\t\t\t\t\t\tif (!response) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst newJson = response.filter((session) => {\n\t\t\t\t\t\t\treturn !session.impersonatedBy;\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn ctx.json(newJson);\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tendpoints: {\n\t\t\tsetRole: setRole(opts),\n\t\t\tgetUser: getUser(opts),\n\t\t\tcreateUser: createUser(opts),\n\t\t\tadminUpdateUser: adminUpdateUser(opts),\n\t\t\tlistUsers: listUsers(opts),\n\t\t\tlistUserSessions: listUserSessions(opts),\n\t\t\tunbanUser: unbanUser(opts),\n\t\t\tbanUser: banUser(opts),\n\t\t\timpersonateUser: impersonateUser(opts),\n\t\t\tstopImpersonating: stopImpersonating(),\n\t\t\trevokeUserSession: revokeUserSession(opts),\n\t\t\trevokeUserSessions: revokeUserSessions(opts),\n\t\t\tremoveUser: removeUser(opts),\n\t\t\tsetUserPassword: setUserPassword(opts),\n\t\t\tuserHasPermission: userHasPermission(opts as O),\n\t\t},\n\t\t$ERROR_CODES: ADMIN_ERROR_CODES,\n\t\tschema: mergeSchema(schema, opts.schema),\n\t\toptions: options as NoInfer<O>,\n\t} satisfies BetterAuthPlugin;\n};\n", "import { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const ANONYMOUS_ERROR_CODES = defineErrorCodes({\n\tINVALID_EMAIL_FORMAT: \"Email was not generated in a valid format\",\n\tFAILED_TO_CREATE_USER: \"Failed to create user\",\n\tCOULD_NOT_CREATE_SESSION: \"Could not create session\",\n\tANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY:\n\t\t\"Anonymous users cannot sign in again anonymously\",\n});\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\n\nexport const schema = {\n\tuser: {\n\t\tfields: {\n\t\t\tisAnonymous: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\trequired: false,\n\t\t\t\tinput: false,\n\t\t\t\tdefaultValue: false,\n\t\t\t},\n\t\t},\n\t},\n} satisfies BetterAuthPluginDBSchema;\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport { generateId } from \"@better-auth/core/utils\";\nimport * as z from \"zod\";\nimport { APIError, getSessionFromCtx } from \"../../api\";\nimport { parseSetCookieHeader, setSessionCookie } from \"../../cookies\";\nimport { mergeSchema } from \"../../db/schema\";\nimport { ANONYMOUS_ERROR_CODES } from \"./error-codes\";\nimport { schema } from \"./schema\";\nimport type { AnonymousOptions } from \"./types\";\n\nasync function getAnonUserEmail(\n\toptions: AnonymousOptions | undefined,\n): Promise<string> {\n\tconst customEmail = await options?.generateRandomEmail?.();\n\tif (customEmail) {\n\t\tconst validation = z.email().safeParse(customEmail);\n\t\tif (!validation.success) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: ANONYMOUS_ERROR_CODES.INVALID_EMAIL_FORMAT,\n\t\t\t});\n\t\t}\n\t\treturn customEmail;\n\t}\n\n\tconst id = generateId();\n\tif (options?.emailDomainName) {\n\t\treturn `temp-${id}@${options.emailDomainName}`;\n\t}\n\n\treturn `temp@${id}.com`;\n}\n\nexport const anonymous = (options?: AnonymousOptions | undefined) => {\n\treturn {\n\t\tid: \"anonymous\",\n\t\tendpoints: {\n\t\t\tsignInAnonymous: createAuthEndpoint(\n\t\t\t\t\"/sign-in/anonymous\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Sign in anonymously\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Sign in anonymously\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\t// If the current request already has a valid anonymous session, we should\n\t\t\t\t\t// reject any further attempts to create another anonymous user. This\n\t\t\t\t\t// prevents an anonymous user from signing in anonymously again while they\n\t\t\t\t\t// are already authenticated.\n\t\t\t\t\tconst existingSession = await getSessionFromCtx<{\n\t\t\t\t\t\tisAnonymous: boolean;\n\t\t\t\t\t}>(ctx, { disableRefresh: true });\n\t\t\t\t\tif (existingSession?.user.isAnonymous) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\t\tANONYMOUS_ERROR_CODES.ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst email = await getAnonUserEmail(options);\n\t\t\t\t\tconst name = (await options?.generateName?.(ctx)) || \"Anonymous\";\n\t\t\t\t\tconst newUser = await ctx.context.internalAdapter.createUser({\n\t\t\t\t\t\temail,\n\t\t\t\t\t\temailVerified: false,\n\t\t\t\t\t\tisAnonymous: true,\n\t\t\t\t\t\tname,\n\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t});\n\t\t\t\t\tif (!newUser) {\n\t\t\t\t\t\tthrow ctx.error(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\t\tmessage: ANONYMOUS_ERROR_CODES.FAILED_TO_CREATE_USER,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\tnewUser.id,\n\t\t\t\t\t);\n\t\t\t\t\tif (!session) {\n\t\t\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\tmessage: ANONYMOUS_ERROR_CODES.COULD_NOT_CREATE_SESSION,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\tsession,\n\t\t\t\t\t\tuser: newUser,\n\t\t\t\t\t});\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\ttoken: session.token,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tid: newUser.id,\n\t\t\t\t\t\t\temail: newUser.email,\n\t\t\t\t\t\t\temailVerified: newUser.emailVerified,\n\t\t\t\t\t\t\tname: newUser.name,\n\t\t\t\t\t\t\tcreatedAt: newUser.createdAt,\n\t\t\t\t\t\t\tupdatedAt: newUser.updatedAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(ctx) {\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/sign-in\") ||\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/sign-up\") ||\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/callback\") ||\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/oauth2/callback\") ||\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/magic-link/verify\") ||\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/email-otp/verify-email\") ||\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/one-tap/callback\") ||\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/passkey/verify-authentication\") ||\n\t\t\t\t\t\t\tctx.path?.startsWith(\"/phone-number/verify\") ||\n\t\t\t\t\t\t\tfalse\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst setCookie = ctx.context.responseHeaders?.get(\"set-cookie\");\n\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * We can consider the user is about to sign in or sign up\n\t\t\t\t\t\t * if the response contains a session token.\n\t\t\t\t\t\t */\n\t\t\t\t\t\tconst sessionTokenName = ctx.context.authCookies.sessionToken.name;\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * The user is about to link their account.\n\t\t\t\t\t\t */\n\t\t\t\t\t\tconst sessionCookie = parseSetCookieHeader(setCookie || \"\")\n\t\t\t\t\t\t\t.get(sessionTokenName)\n\t\t\t\t\t\t\t?.value.split(\".\")[0]!;\n\n\t\t\t\t\t\tif (!sessionCookie) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * Make sure the user had an anonymous session.\n\t\t\t\t\t\t */\n\t\t\t\t\t\tconst session = await getSessionFromCtx<{ isAnonymous: boolean }>(\n\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdisableRefresh: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (!session || !session.user.isAnonymous) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (ctx.path === \"/sign-in/anonymous\" && !ctx.context.newSession) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\t\t\tANONYMOUS_ERROR_CODES.ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst newSession = ctx.context.newSession;\n\t\t\t\t\t\tif (!newSession) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// At this point the user is linking their previous anonymous account with a\n\t\t\t\t\t\t// new credential (email / social). Invoke the provided callback so that the\n\t\t\t\t\t\t// integrator can perform any additional logic such as transferring data\n\t\t\t\t\t\t// from the anonymous user to the new user.\n\t\t\t\t\t\tif (options?.onLinkAccount) {\n\t\t\t\t\t\t\tawait options?.onLinkAccount?.({\n\t\t\t\t\t\t\t\tanonymousUser: session,\n\t\t\t\t\t\t\t\tnewUser: newSession,\n\t\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!options?.disableDeleteAnonymousUser) {\n\t\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteUser(session.user.id);\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\toptions,\n\t\tschema: mergeSchema(schema, options?.schema),\n\t\t$ERROR_CODES: ANONYMOUS_ERROR_CODES,\n\t} satisfies BetterAuthPlugin;\n};\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport type { SecondaryStorage } from \"@better-auth/core/db\";\nimport type { PredefinedApiKeyOptions } from \"./routes\";\nimport type { ApiKey } from \"./types\";\n\n/**\n * Generate storage key for API key by hashed key\n */\nfunction getStorageKeyByHashedKey(hashedKey: string): string {\n\treturn `api-key:${hashedKey}`;\n}\n\n/**\n * Generate storage key for API key by ID\n */\nfunction getStorageKeyById(id: string): string {\n\treturn `api-key:by-id:${id}`;\n}\n\n/**\n * Generate storage key for user's API key list\n */\nfunction getStorageKeyByUserId(userId: string): string {\n\treturn `api-key:by-user:${userId}`;\n}\n\n/**\n * Serialize API key for storage\n */\nfunction serializeApiKey(apiKey: ApiKey): string {\n\treturn JSON.stringify({\n\t\t...apiKey,\n\t\tcreatedAt: apiKey.createdAt.toISOString(),\n\t\tupdatedAt: apiKey.updatedAt.toISOString(),\n\t\texpiresAt: apiKey.expiresAt?.toISOString() ?? null,\n\t\tlastRefillAt: apiKey.lastRefillAt?.toISOString() ?? null,\n\t\tlastRequest: apiKey.lastRequest?.toISOString() ?? null,\n\t});\n}\n\n/**\n * Deserialize API key from storage\n */\nfunction deserializeApiKey(data: unknown): ApiKey | null {\n\tif (!data || typeof data !== \"string\") {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tconst parsed = JSON.parse(data);\n\t\treturn {\n\t\t\t...parsed,\n\t\t\tcreatedAt: new Date(parsed.createdAt),\n\t\t\tupdatedAt: new Date(parsed.updatedAt),\n\t\t\texpiresAt: parsed.expiresAt ? new Date(parsed.expiresAt) : null,\n\t\t\tlastRefillAt: parsed.lastRefillAt ? new Date(parsed.lastRefillAt) : null,\n\t\t\tlastRequest: parsed.lastRequest ? new Date(parsed.lastRequest) : null,\n\t\t} as ApiKey;\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Get the storage instance to use (custom methods take precedence)\n */\nfunction getStorageInstance(\n\tctx: GenericEndpointContext,\n\topts: PredefinedApiKeyOptions,\n): SecondaryStorage | null {\n\tif (opts.customStorage) {\n\t\treturn opts.customStorage as SecondaryStorage;\n\t}\n\treturn ctx.context.secondaryStorage || null;\n}\n\n/**\n * Calculate TTL in seconds for an API key\n */\nfunction calculateTTL(apiKey: ApiKey): number | undefined {\n\tif (apiKey.expiresAt) {\n\t\tconst now = Date.now();\n\t\tconst expiresAt = new Date(apiKey.expiresAt).getTime();\n\t\tconst ttlSeconds = Math.floor((expiresAt - now) / 1000);\n\t\t// Only set TTL if expiration is in the future\n\t\tif (ttlSeconds > 0) {\n\t\t\treturn ttlSeconds;\n\t\t}\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Get API key from secondary storage by hashed key\n */\nasync function getApiKeyFromStorage(\n\tctx: GenericEndpointContext,\n\thashedKey: string,\n\tstorage: SecondaryStorage,\n): Promise<ApiKey | null> {\n\tconst key = getStorageKeyByHashedKey(hashedKey);\n\tconst data = await storage.get(key);\n\treturn deserializeApiKey(data);\n}\n\n/**\n * Get API key from secondary storage by ID\n */\nasync function getApiKeyByIdFromStorage(\n\tctx: GenericEndpointContext,\n\tid: string,\n\tstorage: SecondaryStorage,\n): Promise<ApiKey | null> {\n\tconst key = getStorageKeyById(id);\n\tconst data = await storage.get(key);\n\treturn deserializeApiKey(data);\n}\n\n/**\n * Store API key in secondary storage\n */\nasync function setApiKeyInStorage(\n\tctx: GenericEndpointContext,\n\tapiKey: ApiKey,\n\tstorage: SecondaryStorage,\n\tttl?: number | undefined,\n): Promise<void> {\n\tconst serialized = serializeApiKey(apiKey);\n\tconst hashedKey = apiKey.key;\n\tconst id = apiKey.id;\n\n\t// Store by hashed key (primary lookup)\n\tawait storage.set(getStorageKeyByHashedKey(hashedKey), serialized, ttl);\n\n\t// Store by ID (for ID-based lookups)\n\tawait storage.set(getStorageKeyById(id), serialized, ttl);\n\n\t// Update user's API key list\n\tconst userKey = getStorageKeyByUserId(apiKey.userId);\n\tconst userListData = await storage.get(userKey);\n\tlet userIds: string[] = [];\n\n\tif (userListData && typeof userListData === \"string\") {\n\t\ttry {\n\t\t\tuserIds = JSON.parse(userListData);\n\t\t} catch {\n\t\t\tuserIds = [];\n\t\t}\n\t} else if (Array.isArray(userListData)) {\n\t\tuserIds = userListData;\n\t}\n\n\tif (!userIds.includes(id)) {\n\t\tuserIds.push(id);\n\t\tawait storage.set(userKey, JSON.stringify(userIds));\n\t}\n}\n\n/**\n * Delete API key from secondary storage\n */\nasync function deleteApiKeyFromStorage(\n\tctx: GenericEndpointContext,\n\tapiKey: ApiKey,\n\tstorage: SecondaryStorage,\n): Promise<void> {\n\tconst hashedKey = apiKey.key;\n\tconst id = apiKey.id;\n\tconst userId = apiKey.userId;\n\n\t// Delete by hashed key\n\tawait storage.delete(getStorageKeyByHashedKey(hashedKey));\n\n\t// Delete by ID\n\tawait storage.delete(getStorageKeyById(id));\n\n\t// Update user's API key list\n\tconst userKey = getStorageKeyByUserId(userId);\n\tconst userListData = await storage.get(userKey);\n\tlet userIds: string[] = [];\n\n\tif (userListData && typeof userListData === \"string\") {\n\t\ttry {\n\t\t\tuserIds = JSON.parse(userListData);\n\t\t} catch {\n\t\t\tuserIds = [];\n\t\t}\n\t} else if (Array.isArray(userListData)) {\n\t\tuserIds = userListData;\n\t}\n\n\tconst filteredIds = userIds.filter((keyId) => keyId !== id);\n\tif (filteredIds.length === 0) {\n\t\tawait storage.delete(userKey);\n\t} else {\n\t\tawait storage.set(userKey, JSON.stringify(filteredIds));\n\t}\n}\n\n/**\n * Unified getter for API keys with support for all storage modes\n */\nexport async function getApiKey(\n\tctx: GenericEndpointContext,\n\thashedKey: string,\n\topts: PredefinedApiKeyOptions,\n): Promise<ApiKey | null> {\n\tconst storage = getStorageInstance(ctx, opts);\n\n\t// Database mode only\n\tif (opts.storage === \"database\") {\n\t\treturn await ctx.context.adapter.findOne<ApiKey>({\n\t\t\tmodel: \"apikey\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"key\",\n\t\t\t\t\tvalue: hashedKey,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\t}\n\n\t// Secondary storage mode with fallback\n\tif (opts.storage === \"secondary-storage\" && opts.fallbackToDatabase) {\n\t\tif (storage) {\n\t\t\tconst cached = await getApiKeyFromStorage(ctx, hashedKey, storage);\n\t\t\tif (cached) {\n\t\t\t\treturn cached;\n\t\t\t}\n\t\t}\n\t\tconst dbKey = await ctx.context.adapter.findOne<ApiKey>({\n\t\t\tmodel: \"apikey\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"key\",\n\t\t\t\t\tvalue: hashedKey,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\tif (dbKey && storage) {\n\t\t\t// Populate secondary storage for future reads\n\t\t\tconst ttl = calculateTTL(dbKey);\n\t\t\tawait setApiKeyInStorage(ctx, dbKey, storage, ttl);\n\t\t}\n\n\t\treturn dbKey;\n\t}\n\n\t// Secondary storage mode only\n\tif (opts.storage === \"secondary-storage\") {\n\t\tif (!storage) {\n\t\t\treturn null;\n\t\t}\n\t\treturn await getApiKeyFromStorage(ctx, hashedKey, storage);\n\t}\n\n\t// Default fallback\n\treturn await ctx.context.adapter.findOne<ApiKey>({\n\t\tmodel: \"apikey\",\n\t\twhere: [\n\t\t\t{\n\t\t\t\tfield: \"key\",\n\t\t\t\tvalue: hashedKey,\n\t\t\t},\n\t\t],\n\t});\n}\n\n/**\n * Unified getter for API keys by ID\n */\nexport async function getApiKeyById(\n\tctx: GenericEndpointContext,\n\tid: string,\n\topts: PredefinedApiKeyOptions,\n): Promise<ApiKey | null> {\n\tconst storage = getStorageInstance(ctx, opts);\n\n\t// Database mode only\n\tif (opts.storage === \"database\") {\n\t\treturn await ctx.context.adapter.findOne<ApiKey>({\n\t\t\tmodel: \"apikey\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: id,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\t}\n\n\t// Secondary storage mode with fallback\n\tif (opts.storage === \"secondary-storage\" && opts.fallbackToDatabase) {\n\t\tif (storage) {\n\t\t\tconst cached = await getApiKeyByIdFromStorage(ctx, id, storage);\n\t\t\tif (cached) {\n\t\t\t\treturn cached;\n\t\t\t}\n\t\t}\n\t\tconst dbKey = await ctx.context.adapter.findOne<ApiKey>({\n\t\t\tmodel: \"apikey\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: id,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\tif (dbKey && storage) {\n\t\t\t// Populate secondary storage for future reads\n\t\t\tconst ttl = calculateTTL(dbKey);\n\t\t\tawait setApiKeyInStorage(ctx, dbKey, storage, ttl);\n\t\t}\n\n\t\treturn dbKey;\n\t}\n\n\t// Secondary storage mode only\n\tif (opts.storage === \"secondary-storage\") {\n\t\tif (!storage) {\n\t\t\treturn null;\n\t\t}\n\t\treturn await getApiKeyByIdFromStorage(ctx, id, storage);\n\t}\n\n\t// Default fallback\n\treturn await ctx.context.adapter.findOne<ApiKey>({\n\t\tmodel: \"apikey\",\n\t\twhere: [\n\t\t\t{\n\t\t\t\tfield: \"id\",\n\t\t\t\tvalue: id,\n\t\t\t},\n\t\t],\n\t});\n}\n\n/**\n * Unified setter for API keys with support for all storage modes\n */\nexport async function setApiKey(\n\tctx: GenericEndpointContext,\n\tapiKey: ApiKey,\n\topts: PredefinedApiKeyOptions,\n): Promise<void> {\n\tconst storage = getStorageInstance(ctx, opts);\n\tconst ttl = calculateTTL(apiKey);\n\n\t// Database mode only - handled by adapter in route handlers\n\tif (opts.storage === \"database\") {\n\t\treturn;\n\t}\n\n\t// Secondary storage mode (with or without fallback)\n\tif (opts.storage === \"secondary-storage\") {\n\t\tif (!storage) {\n\t\t\tthrow new Error(\n\t\t\t\t\"Secondary storage is required when storage mode is 'secondary-storage'\",\n\t\t\t);\n\t\t}\n\t\tawait setApiKeyInStorage(ctx, apiKey, storage, ttl);\n\t\treturn;\n\t}\n}\n\n/**\n * Unified deleter for API keys with support for all storage modes\n */\nexport async function deleteApiKey(\n\tctx: GenericEndpointContext,\n\tapiKey: ApiKey,\n\topts: PredefinedApiKeyOptions,\n): Promise<void> {\n\tconst storage = getStorageInstance(ctx, opts);\n\n\t// Database mode only - handled by adapter in route handlers\n\tif (opts.storage === \"database\") {\n\t\treturn;\n\t}\n\n\t// Secondary storage mode (with or without fallback)\n\tif (opts.storage === \"secondary-storage\") {\n\t\tif (!storage) {\n\t\t\tthrow new Error(\n\t\t\t\t\"Secondary storage is required when storage mode is 'secondary-storage'\",\n\t\t\t);\n\t\t}\n\t\tawait deleteApiKeyFromStorage(ctx, apiKey, storage);\n\t\treturn;\n\t}\n}\n\n/**\n * List API keys for a user with support for all storage modes\n */\nexport async function listApiKeys(\n\tctx: GenericEndpointContext,\n\tuserId: string,\n\topts: PredefinedApiKeyOptions,\n): Promise<ApiKey[]> {\n\tconst storage = getStorageInstance(ctx, opts);\n\n\t// Database mode only\n\tif (opts.storage === \"database\") {\n\t\treturn await ctx.context.adapter.findMany<ApiKey>({\n\t\t\tmodel: \"apikey\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\tvalue: userId,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\t}\n\n\t// Secondary storage mode with fallback\n\tif (opts.storage === \"secondary-storage\" && opts.fallbackToDatabase) {\n\t\tconst userKey = getStorageKeyByUserId(userId);\n\n\t\tif (storage) {\n\t\t\tconst userListData = await storage.get(userKey);\n\t\t\tlet userIds: string[] = [];\n\n\t\t\tif (userListData && typeof userListData === \"string\") {\n\t\t\t\ttry {\n\t\t\t\t\tuserIds = JSON.parse(userListData);\n\t\t\t\t} catch {\n\t\t\t\t\tuserIds = [];\n\t\t\t\t}\n\t\t\t} else if (Array.isArray(userListData)) {\n\t\t\t\tuserIds = userListData;\n\t\t\t}\n\n\t\t\tif (userIds.length > 0) {\n\t\t\t\tconst apiKeys: ApiKey[] = [];\n\t\t\t\tfor (const id of userIds) {\n\t\t\t\t\tconst apiKey = await getApiKeyByIdFromStorage(ctx, id, storage);\n\t\t\t\t\tif (apiKey) {\n\t\t\t\t\t\tapiKeys.push(apiKey);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn apiKeys;\n\t\t\t}\n\t\t}\n\t\t// Fallback to database\n\t\tconst dbKeys = await ctx.context.adapter.findMany<ApiKey>({\n\t\t\tmodel: \"apikey\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\tvalue: userId,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\t// Populate secondary storage with fetched keys\n\t\tif (storage && dbKeys.length > 0) {\n\t\t\tconst userIds: string[] = [];\n\t\t\tfor (const apiKey of dbKeys) {\n\t\t\t\t// Store each key in secondary storage\n\t\t\t\tconst ttl = calculateTTL(apiKey);\n\t\t\t\tawait setApiKeyInStorage(ctx, apiKey, storage, ttl);\n\t\t\t\tuserIds.push(apiKey.id);\n\t\t\t}\n\t\t\t// Update user's key list in secondary storage\n\t\t\tawait storage.set(userKey, JSON.stringify(userIds));\n\t\t}\n\n\t\treturn dbKeys;\n\t}\n\n\t// Secondary storage mode only\n\tif (opts.storage === \"secondary-storage\") {\n\t\tif (!storage) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst userKey = getStorageKeyByUserId(userId);\n\t\tconst userListData = await storage.get(userKey);\n\t\tlet userIds: string[] = [];\n\n\t\tif (userListData && typeof userListData === \"string\") {\n\t\t\ttry {\n\t\t\t\tuserIds = JSON.parse(userListData);\n\t\t\t} catch {\n\t\t\t\treturn [];\n\t\t\t}\n\t\t} else if (Array.isArray(userListData)) {\n\t\t\tuserIds = userListData;\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst apiKeys: ApiKey[] = [];\n\t\tfor (const id of userIds) {\n\t\t\tconst apiKey = await getApiKeyByIdFromStorage(ctx, id, storage);\n\t\t\tif (apiKey) {\n\t\t\t\tapiKeys.push(apiKey);\n\t\t\t}\n\t\t}\n\n\t\treturn apiKeys;\n\t}\n\n\t// Default fallback\n\treturn await ctx.context.adapter.findMany<ApiKey>({\n\t\tmodel: \"apikey\",\n\t\twhere: [\n\t\t\t{\n\t\t\t\tfield: \"userId\",\n\t\t\t\tvalue: userId,\n\t\t\t},\n\t\t],\n\t});\n}\n", "import { ERROR_CODES } from \".\";\nimport type { PredefinedApiKeyOptions } from \"./routes\";\nimport type { ApiKey } from \"./types\";\n\ninterface RateLimitResult {\n\tsuccess: boolean;\n\tmessage: string | null;\n\ttryAgainIn: number | null;\n\tupdate: Partial<ApiKey> | null;\n}\n\n/**\n * Determines if a request is allowed based on rate limiting parameters.\n *\n * @returns An object indicating whether the request is allowed and, if not,\n *          a message and updated ApiKey data.\n */\nexport function isRateLimited(\n\t/**\n\t * The ApiKey object containing rate limiting information\n\t */\n\tapiKey: ApiKey,\n\topts: PredefinedApiKeyOptions,\n): RateLimitResult {\n\tconst now = new Date();\n\tconst lastRequest = apiKey.lastRequest;\n\tconst rateLimitTimeWindow = apiKey.rateLimitTimeWindow;\n\tconst rateLimitMax = apiKey.rateLimitMax;\n\tlet requestCount = apiKey.requestCount;\n\n\tif (opts.rateLimit.enabled === false)\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: null,\n\t\t\tupdate: { lastRequest: now },\n\t\t\ttryAgainIn: null,\n\t\t};\n\n\tif (apiKey.rateLimitEnabled === false)\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: null,\n\t\t\tupdate: { lastRequest: now },\n\t\t\ttryAgainIn: null,\n\t\t};\n\n\tif (rateLimitTimeWindow === null || rateLimitMax === null) {\n\t\t// Rate limiting is disabled.\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: null,\n\t\t\tupdate: null,\n\t\t\ttryAgainIn: null,\n\t\t};\n\t}\n\n\tif (lastRequest === null) {\n\t\t// No previous requests, so allow the first one.\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: null,\n\t\t\tupdate: { lastRequest: now, requestCount: 1 },\n\t\t\ttryAgainIn: null,\n\t\t};\n\t}\n\n\tconst timeSinceLastRequest = now.getTime() - new Date(lastRequest).getTime();\n\n\tif (timeSinceLastRequest > rateLimitTimeWindow) {\n\t\t// Time window has passed, reset the request count.\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: null,\n\t\t\tupdate: { lastRequest: now, requestCount: 1 },\n\t\t\ttryAgainIn: null,\n\t\t};\n\t}\n\n\tif (requestCount >= rateLimitMax) {\n\t\t// Rate limit exceeded.\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tmessage: ERROR_CODES.RATE_LIMIT_EXCEEDED,\n\t\t\tupdate: null,\n\t\t\ttryAgainIn: Math.ceil(rateLimitTimeWindow - timeSinceLastRequest),\n\t\t};\n\t}\n\n\t// Request is allowed.\n\trequestCount++;\n\treturn {\n\t\tsuccess: true,\n\t\tmessage: null,\n\t\ttryAgainIn: null,\n\t\tupdate: { lastRequest: now, requestCount: requestCount },\n\t};\n}\n", "import type { AuthContext, GenericEndpointContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { safeJSONParse } from \"@better-auth/core/utils\";\nimport * as z from \"zod\";\nimport { APIError } from \"../../../api\";\nimport { role } from \"../../access\";\nimport { API_KEY_TABLE_NAME, ERROR_CODES } from \"..\";\nimport { defaultKeyHasher } from \"../\";\nimport { deleteApiKey, getApiKey, setApiKey } from \"../adapter\";\nimport { isRateLimited } from \"../rate-limit\";\nimport type { apiKeySchema } from \"../schema\";\nimport type { ApiKey } from \"../types\";\nimport type { PredefinedApiKeyOptions } from \".\";\n\nexport async function validateApiKey({\n\thashedKey,\n\tctx,\n\topts,\n\tschema,\n\tpermissions,\n}: {\n\thashedKey: string;\n\topts: PredefinedApiKeyOptions;\n\tschema: ReturnType<typeof apiKeySchema>;\n\tpermissions?: Record<string, string[]> | undefined;\n\tctx: GenericEndpointContext;\n}) {\n\tconst apiKey = await getApiKey(ctx, hashedKey, opts);\n\n\tif (!apiKey) {\n\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\tmessage: ERROR_CODES.INVALID_API_KEY,\n\t\t});\n\t}\n\n\tif (apiKey.enabled === false) {\n\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\tmessage: ERROR_CODES.KEY_DISABLED,\n\t\t\tcode: \"KEY_DISABLED\" as const,\n\t\t});\n\t}\n\n\tif (apiKey.expiresAt) {\n\t\tconst now = Date.now();\n\t\tconst expiresAt = new Date(apiKey.expiresAt).getTime();\n\t\tif (now > expiresAt) {\n\t\t\tconst deleteExpiredKey = async () => {\n\t\t\t\tif (opts.storage === \"secondary-storage\" && opts.fallbackToDatabase) {\n\t\t\t\t\tawait deleteApiKey(ctx, apiKey, opts);\n\t\t\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\t\twhere: [{ field: \"id\", value: apiKey.id }],\n\t\t\t\t\t});\n\t\t\t\t} else if (opts.storage === \"secondary-storage\") {\n\t\t\t\t\tawait deleteApiKey(ctx, apiKey, opts);\n\t\t\t\t} else {\n\t\t\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\t\twhere: [{ field: \"id\", value: apiKey.id }],\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (opts.deferUpdates) {\n\t\t\t\tctx.context.runInBackground(\n\t\t\t\t\tdeleteExpiredKey().catch((error) => {\n\t\t\t\t\t\tctx.context.logger.error(\"Deferred update failed:\", error);\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tawait deleteExpiredKey();\n\t\t\t}\n\n\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\tmessage: ERROR_CODES.KEY_EXPIRED,\n\t\t\t\tcode: \"KEY_EXPIRED\" as const,\n\t\t\t});\n\t\t}\n\t}\n\n\tif (permissions) {\n\t\tconst apiKeyPermissions = apiKey.permissions\n\t\t\t? safeJSONParse<{\n\t\t\t\t\t[key: string]: string[];\n\t\t\t\t}>(apiKey.permissions)\n\t\t\t: null;\n\n\t\tif (!apiKeyPermissions) {\n\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\tmessage: ERROR_CODES.KEY_NOT_FOUND,\n\t\t\t\tcode: \"KEY_NOT_FOUND\" as const,\n\t\t\t});\n\t\t}\n\t\tconst r = role(apiKeyPermissions as any);\n\t\tconst result = r.authorize(permissions);\n\t\tif (!result.success) {\n\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\tmessage: ERROR_CODES.KEY_NOT_FOUND,\n\t\t\t\tcode: \"KEY_NOT_FOUND\" as const,\n\t\t\t});\n\t\t}\n\t}\n\n\tlet remaining = apiKey.remaining;\n\tlet lastRefillAt = apiKey.lastRefillAt;\n\n\tif (apiKey.remaining === 0 && apiKey.refillAmount === null) {\n\t\tconst deleteExhaustedKey = async () => {\n\t\t\tif (opts.storage === \"secondary-storage\" && opts.fallbackToDatabase) {\n\t\t\t\tawait deleteApiKey(ctx, apiKey, opts);\n\t\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\twhere: [{ field: \"id\", value: apiKey.id }],\n\t\t\t\t});\n\t\t\t} else if (opts.storage === \"secondary-storage\") {\n\t\t\t\tawait deleteApiKey(ctx, apiKey, opts);\n\t\t\t} else {\n\t\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\twhere: [{ field: \"id\", value: apiKey.id }],\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t\tif (opts.deferUpdates) {\n\t\t\tctx.context.runInBackground(\n\t\t\t\tdeleteExhaustedKey().catch((error) => {\n\t\t\t\t\tctx.context.logger.error(\"Deferred update failed:\", error);\n\t\t\t\t}),\n\t\t\t);\n\t\t} else {\n\t\t\tawait deleteExhaustedKey();\n\t\t}\n\n\t\tthrow new APIError(\"TOO_MANY_REQUESTS\", {\n\t\t\tmessage: ERROR_CODES.USAGE_EXCEEDED,\n\t\t\tcode: \"USAGE_EXCEEDED\" as const,\n\t\t});\n\t} else if (remaining !== null) {\n\t\tlet now = Date.now();\n\t\tconst refillInterval = apiKey.refillInterval;\n\t\tconst refillAmount = apiKey.refillAmount;\n\t\tlet lastTime = new Date(lastRefillAt ?? apiKey.createdAt).getTime();\n\n\t\tif (refillInterval && refillAmount) {\n\t\t\t// if they provide refill info, then we should refill once the interval is reached.\n\n\t\t\tconst timeSinceLastRequest = now - lastTime;\n\t\t\tif (timeSinceLastRequest > refillInterval) {\n\t\t\t\tremaining = refillAmount;\n\t\t\t\tlastRefillAt = new Date();\n\t\t\t}\n\t\t}\n\n\t\tif (remaining === 0) {\n\t\t\t// if there are no more remaining requests, than the key is invalid\n\t\t\tthrow new APIError(\"TOO_MANY_REQUESTS\", {\n\t\t\t\tmessage: ERROR_CODES.USAGE_EXCEEDED,\n\t\t\t\tcode: \"USAGE_EXCEEDED\" as const,\n\t\t\t});\n\t\t} else {\n\t\t\tremaining--;\n\t\t}\n\t}\n\n\tconst { message, success, update, tryAgainIn } = isRateLimited(apiKey, opts);\n\n\tif (success === false) {\n\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\tmessage: message ?? undefined,\n\t\t\tcode: \"RATE_LIMITED\" as const,\n\t\t\tdetails: {\n\t\t\t\ttryAgainIn,\n\t\t\t},\n\t\t});\n\t}\n\n\tconst updated: ApiKey = {\n\t\t...apiKey,\n\t\t...update,\n\t\tremaining,\n\t\tlastRefillAt,\n\t\tupdatedAt: new Date(),\n\t};\n\n\tconst performUpdate = async (): Promise<ApiKey | null> => {\n\t\tif (opts.storage === \"database\") {\n\t\t\treturn ctx.context.adapter.update<ApiKey>({\n\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\twhere: [{ field: \"id\", value: apiKey.id }],\n\t\t\t\tupdate: { ...updated, id: undefined },\n\t\t\t});\n\t\t} else if (\n\t\t\topts.storage === \"secondary-storage\" &&\n\t\t\topts.fallbackToDatabase\n\t\t) {\n\t\t\tconst dbUpdated = await ctx.context.adapter.update<ApiKey>({\n\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\twhere: [{ field: \"id\", value: apiKey.id }],\n\t\t\t\tupdate: { ...updated, id: undefined },\n\t\t\t});\n\t\t\tif (dbUpdated) {\n\t\t\t\tawait setApiKey(ctx, dbUpdated, opts);\n\t\t\t}\n\t\t\treturn dbUpdated;\n\t\t} else {\n\t\t\tawait setApiKey(ctx, updated, opts);\n\t\t\treturn updated;\n\t\t}\n\t};\n\n\tlet newApiKey: ApiKey | null = null;\n\n\tif (opts.deferUpdates) {\n\t\tctx.context.runInBackground(\n\t\t\tperformUpdate()\n\t\t\t\t.then(() => {})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tctx.context.logger.error(\"Failed to update API key:\", error);\n\t\t\t\t}),\n\t\t);\n\t\tnewApiKey = updated;\n\t} else {\n\t\tnewApiKey = await performUpdate();\n\t\tif (!newApiKey) {\n\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\tmessage: ERROR_CODES.FAILED_TO_UPDATE_API_KEY,\n\t\t\t\tcode: \"INTERNAL_SERVER_ERROR\" as const,\n\t\t\t});\n\t\t}\n\t}\n\n\treturn newApiKey;\n}\n\nconst verifyApiKeyBodySchema = z.object({\n\tkey: z.string().meta({\n\t\tdescription: \"The key to verify\",\n\t}),\n\tpermissions: z\n\t\t.record(z.string(), z.array(z.string()))\n\t\t.meta({\n\t\t\tdescription: \"The permissions to verify.\",\n\t\t})\n\t\t.optional(),\n});\n\nexport function verifyApiKey({\n\topts,\n\tschema,\n\tdeleteAllExpiredApiKeys,\n}: {\n\topts: PredefinedApiKeyOptions;\n\tschema: ReturnType<typeof apiKeySchema>;\n\tdeleteAllExpiredApiKeys(\n\t\tctx: AuthContext,\n\t\tbyPassLastCheckTime?: boolean | undefined,\n\t): Promise<void>;\n}) {\n\treturn createAuthEndpoint(\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: verifyApiKeyBodySchema,\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { key } = ctx.body;\n\n\t\t\tif (key.length < opts.defaultKeyLength) {\n\t\t\t\t// if the key is shorter than the default key length, than we know the key is invalid.\n\t\t\t\t// we can't check if the key is exactly equal to the default key length, because\n\t\t\t\t// a prefix may be added to the key.\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tvalid: false,\n\t\t\t\t\terror: {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_API_KEY,\n\t\t\t\t\t\tcode: \"KEY_NOT_FOUND\" as const,\n\t\t\t\t\t},\n\t\t\t\t\tkey: null,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (opts.customAPIKeyValidator) {\n\t\t\t\tconst isValid = await opts.customAPIKeyValidator({ ctx, key });\n\t\t\t\tif (!isValid) {\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tvalid: false,\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_API_KEY,\n\t\t\t\t\t\t\tcode: \"KEY_NOT_FOUND\" as const,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tkey: null,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst hashed = opts.disableKeyHashing ? key : await defaultKeyHasher(key);\n\n\t\t\tlet apiKey: ApiKey | null = null;\n\n\t\t\ttry {\n\t\t\t\tapiKey = await validateApiKey({\n\t\t\t\t\thashedKey: hashed,\n\t\t\t\t\tpermissions: ctx.body.permissions,\n\t\t\t\t\tctx,\n\t\t\t\t\topts,\n\t\t\t\t\tschema,\n\t\t\t\t});\n\n\t\t\t\tif (opts.deferUpdates) {\n\t\t\t\t\tctx.context.runInBackground(\n\t\t\t\t\t\tdeleteAllExpiredApiKeys(ctx.context).catch((err) => {\n\t\t\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t\t\t\"Failed to delete expired API keys:\",\n\t\t\t\t\t\t\t\terr,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}),\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tif (error instanceof APIError) {\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tvalid: false,\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tmessage: error.body?.message,\n\t\t\t\t\t\t\tcode: error.body?.code as string,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tkey: null,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tvalid: false,\n\t\t\t\t\terror: {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_API_KEY,\n\t\t\t\t\t\tcode: \"INVALID_API_KEY\" as const,\n\t\t\t\t\t},\n\t\t\t\t\tkey: null,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst { key: _, ...returningApiKey } = apiKey ?? {\n\t\t\t\tkey: 1,\n\t\t\t\tpermissions: undefined,\n\t\t\t};\n\t\t\tif (\"metadata\" in returningApiKey) {\n\t\t\t\treturningApiKey.metadata =\n\t\t\t\t\tschema.apikey.fields.metadata.transform.output(\n\t\t\t\t\t\treturningApiKey.metadata as never as string,\n\t\t\t\t\t);\n\t\t\t}\n\n\t\t\treturningApiKey.permissions = returningApiKey.permissions\n\t\t\t\t? safeJSONParse<{\n\t\t\t\t\t\t[key: string]: string[];\n\t\t\t\t\t}>(returningApiKey.permissions)\n\t\t\t\t: null;\n\n\t\t\treturn ctx.json({\n\t\t\t\tvalid: true,\n\t\t\t\terror: null,\n\t\t\t\tkey: apiKey === null ? null : (returningApiKey as Omit<ApiKey, \"key\">),\n\t\t\t});\n\t\t},\n\t);\n}\n", "import type { AuthContext, Awaitable } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { safeJSONParse } from \"@better-auth/core/utils\";\nimport * as z from \"zod\";\nimport { APIError, getSessionFromCtx } from \"../../../api\";\nimport { generateId } from \"../../../utils\";\nimport { getDate } from \"../../../utils/date\";\nimport { API_KEY_TABLE_NAME, ERROR_CODES } from \"..\";\nimport { defaultKeyHasher } from \"../\";\nimport { setApiKey } from \"../adapter\";\nimport type { apiKeySchema } from \"../schema\";\nimport type { ApiKey } from \"../types\";\nimport type { PredefinedApiKeyOptions } from \".\";\n\nconst createApiKeyBodySchema = z.object({\n\tname: z.string().meta({ description: \"Name of the Api Key\" }).optional(),\n\texpiresIn: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription: \"Expiration time of the Api Key in seconds\",\n\t\t})\n\t\t.min(1)\n\t\t.optional()\n\t\t.nullable()\n\t\t.default(null),\n\n\tuserId: z.coerce\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'User Id of the user that the Api Key belongs to. server-only. Eg: \"user-id\"',\n\t\t})\n\t\t.optional(),\n\tprefix: z\n\t\t.string()\n\t\t.meta({ description: \"Prefix of the Api Key\" })\n\t\t.regex(/^[a-zA-Z0-9_-]+$/, {\n\t\t\tmessage:\n\t\t\t\t\"Invalid prefix format, must be alphanumeric and contain only underscores and hyphens.\",\n\t\t})\n\t\t.optional(),\n\tremaining: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription: \"Remaining number of requests. Server side only\",\n\t\t})\n\t\t.min(0)\n\t\t.optional()\n\t\t.nullable()\n\t\t.default(null),\n\tmetadata: z.any().optional(),\n\trefillAmount: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Amount to refill the remaining count of the Api Key. server-only. Eg: 100\",\n\t\t})\n\t\t.min(1)\n\t\t.optional(),\n\trefillInterval: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Interval to refill the Api Key in milliseconds. server-only. Eg: 1000\",\n\t\t})\n\t\t.optional(),\n\trateLimitTimeWindow: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"The duration in milliseconds where each request is counted. Once the `maxRequests` is reached, the request will be rejected until the `timeWindow` has passed, at which point the `timeWindow` will be reset. server-only. Eg: 1000\",\n\t\t})\n\t\t.optional(),\n\trateLimitMax: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Maximum amount of requests allowed within a window. Once the `maxRequests` is reached, the request will be rejected until the `timeWindow` has passed, at which point the `timeWindow` will be reset. server-only. Eg: 100\",\n\t\t})\n\t\t.optional(),\n\trateLimitEnabled: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Whether the key has rate limiting enabled. server-only. Eg: true\",\n\t\t})\n\t\t.optional(),\n\tpermissions: z\n\t\t.record(z.string(), z.array(z.string()))\n\t\t.meta({\n\t\t\tdescription: \"Permissions of the Api Key.\",\n\t\t})\n\t\t.optional(),\n});\n\nexport function createApiKey({\n\tkeyGenerator,\n\topts,\n\tschema,\n\tdeleteAllExpiredApiKeys,\n}: {\n\tkeyGenerator: (options: {\n\t\tlength: number;\n\t\tprefix: string | undefined;\n\t}) => Awaitable<string>;\n\topts: PredefinedApiKeyOptions;\n\tschema: ReturnType<typeof apiKeySchema>;\n\tdeleteAllExpiredApiKeys(\n\t\tctx: AuthContext,\n\t\tbyPassLastCheckTime?: boolean | undefined,\n\t): void;\n}) {\n\treturn createAuthEndpoint(\n\t\t\"/api-key/create\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: createApiKeyBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Create a new API key for a user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"API key created successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the API key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Creation timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Last update timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Name of the API key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tprefix: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Prefix of the API key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tstart: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Starting characters of the key (if configured)\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tkey: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The full API key (only returned on creation)\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tenabled: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the key is enabled\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Expiration timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"ID of the user owning the key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tlastRefillAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Last refill timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tlastRequest: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Last request timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Metadata associated with the key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitMax: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Maximum requests in time window\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitTimeWindow: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Rate limit time window in milliseconds\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tremaining: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Remaining requests\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trefillAmount: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Amount to refill\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trefillInterval: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Refill interval in milliseconds\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitEnabled: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether rate limiting is enabled\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequestCount: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Current request count in window\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\t\titems: { type: \"string\" },\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Permissions associated with the key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"key\",\n\t\t\t\t\t\t\t\t\t\t\t\"enabled\",\n\t\t\t\t\t\t\t\t\t\t\t\"userId\",\n\t\t\t\t\t\t\t\t\t\t\t\"rateLimitEnabled\",\n\t\t\t\t\t\t\t\t\t\t\t\"requestCount\",\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst {\n\t\t\t\tname,\n\t\t\t\texpiresIn,\n\t\t\t\tprefix,\n\t\t\t\tremaining,\n\t\t\t\tmetadata,\n\t\t\t\trefillAmount,\n\t\t\t\trefillInterval,\n\t\t\t\tpermissions,\n\t\t\t\trateLimitMax,\n\t\t\t\trateLimitTimeWindow,\n\t\t\t\trateLimitEnabled,\n\t\t\t} = ctx.body;\n\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\tconst authRequired = ctx.request || ctx.headers;\n\t\t\tconst user =\n\t\t\t\tauthRequired && !session\n\t\t\t\t\t? null\n\t\t\t\t\t: session?.user || { id: ctx.body.userId };\n\n\t\t\tif (!user?.id) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: ERROR_CODES.UNAUTHORIZED_SESSION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (session && ctx.body.userId && session?.user.id !== ctx.body.userId) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: ERROR_CODES.UNAUTHORIZED_SESSION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (authRequired) {\n\t\t\t\t// if this endpoint was being called from the client,\n\t\t\t\t// we must make sure they can't use server-only properties.\n\t\t\t\tif (\n\t\t\t\t\trefillAmount !== undefined ||\n\t\t\t\t\trefillInterval !== undefined ||\n\t\t\t\t\trateLimitMax !== undefined ||\n\t\t\t\t\trateLimitTimeWindow !== undefined ||\n\t\t\t\t\trateLimitEnabled !== undefined ||\n\t\t\t\t\tpermissions !== undefined ||\n\t\t\t\t\tremaining !== null\n\t\t\t\t) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.SERVER_ONLY_PROPERTY,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if metadata is defined, than check that it's an object.\n\t\t\tif (metadata) {\n\t\t\t\tif (opts.enableMetadata === false) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.METADATA_DISABLED,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (typeof metadata !== \"object\") {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_METADATA_TYPE,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// make sure that if they pass a refill amount, they also pass a refill interval\n\t\t\tif (refillAmount && !refillInterval) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.REFILL_AMOUNT_AND_INTERVAL_REQUIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t\t// make sure that if they pass a refill interval, they also pass a refill amount\n\t\t\tif (refillInterval && !refillAmount) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.REFILL_INTERVAL_AND_AMOUNT_REQUIRED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (expiresIn) {\n\t\t\t\tif (opts.keyExpiration.disableCustomExpiresTime === true) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.KEY_DISABLED_EXPIRATION,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst expiresIn_in_days = expiresIn / (60 * 60 * 24);\n\n\t\t\t\tif (opts.keyExpiration.minExpiresIn > expiresIn_in_days) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.EXPIRES_IN_IS_TOO_SMALL,\n\t\t\t\t\t});\n\t\t\t\t} else if (opts.keyExpiration.maxExpiresIn < expiresIn_in_days) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.EXPIRES_IN_IS_TOO_LARGE,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (prefix) {\n\t\t\t\tif (prefix.length < opts.minimumPrefixLength) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_PREFIX_LENGTH,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (prefix.length > opts.maximumPrefixLength) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_PREFIX_LENGTH,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (name) {\n\t\t\t\tif (name.length < opts.minimumNameLength) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_NAME_LENGTH,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (name.length > opts.maximumNameLength) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_NAME_LENGTH,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else if (opts.requireName) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.NAME_REQUIRED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdeleteAllExpiredApiKeys(ctx.context);\n\n\t\t\tconst key = await keyGenerator({\n\t\t\t\tlength: opts.defaultKeyLength,\n\t\t\t\tprefix: prefix || opts.defaultPrefix,\n\t\t\t});\n\n\t\t\tconst hashed = opts.disableKeyHashing ? key : await defaultKeyHasher(key);\n\n\t\t\tlet start: string | null = null;\n\n\t\t\tif (opts.startingCharactersConfig.shouldStore) {\n\t\t\t\tstart = key.substring(\n\t\t\t\t\t0,\n\t\t\t\t\topts.startingCharactersConfig.charactersLength,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst defaultPermissions = opts.permissions?.defaultPermissions\n\t\t\t\t? typeof opts.permissions.defaultPermissions === \"function\"\n\t\t\t\t\t? await opts.permissions.defaultPermissions(user.id, ctx)\n\t\t\t\t\t: opts.permissions.defaultPermissions\n\t\t\t\t: undefined;\n\t\t\tconst permissionsToApply = permissions\n\t\t\t\t? JSON.stringify(permissions)\n\t\t\t\t: defaultPermissions\n\t\t\t\t\t? JSON.stringify(defaultPermissions)\n\t\t\t\t\t: undefined;\n\n\t\t\tlet data: Omit<ApiKey, \"id\"> = {\n\t\t\t\tcreatedAt: new Date(),\n\t\t\t\tupdatedAt: new Date(),\n\t\t\t\tname: name ?? null,\n\t\t\t\tprefix: prefix ?? opts.defaultPrefix ?? null,\n\t\t\t\tstart: start,\n\t\t\t\tkey: hashed,\n\t\t\t\tenabled: true,\n\t\t\t\texpiresAt: expiresIn\n\t\t\t\t\t? getDate(expiresIn, \"sec\")\n\t\t\t\t\t: opts.keyExpiration.defaultExpiresIn\n\t\t\t\t\t\t? getDate(opts.keyExpiration.defaultExpiresIn, \"sec\")\n\t\t\t\t\t\t: null,\n\t\t\t\tuserId: user.id,\n\t\t\t\tlastRefillAt: null,\n\t\t\t\tlastRequest: null,\n\t\t\t\tmetadata: null,\n\t\t\t\trateLimitMax: rateLimitMax ?? opts.rateLimit.maxRequests ?? null,\n\t\t\t\trateLimitTimeWindow:\n\t\t\t\t\trateLimitTimeWindow ?? opts.rateLimit.timeWindow ?? null,\n\t\t\t\tremaining:\n\t\t\t\t\tremaining === null ? remaining : (remaining ?? refillAmount ?? null),\n\t\t\t\trefillAmount: refillAmount ?? null,\n\t\t\t\trefillInterval: refillInterval ?? null,\n\t\t\t\trateLimitEnabled:\n\t\t\t\t\trateLimitEnabled === undefined\n\t\t\t\t\t\t? (opts.rateLimit.enabled ?? true)\n\t\t\t\t\t\t: rateLimitEnabled,\n\t\t\t\trequestCount: 0,\n\t\t\t\t//@ts-expect-error - we intentionally save the permissions as string on DB.\n\t\t\t\tpermissions: permissionsToApply,\n\t\t\t};\n\n\t\t\tif (metadata) {\n\t\t\t\t//@ts-expect-error - we intentionally save the metadata as string on DB.\n\t\t\t\tdata.metadata = schema.apikey.fields.metadata.transform.input(metadata);\n\t\t\t}\n\n\t\t\tlet apiKey: ApiKey;\n\n\t\t\tif (opts.storage === \"secondary-storage\" && opts.fallbackToDatabase) {\n\t\t\t\tapiKey = await ctx.context.adapter.create<Omit<ApiKey, \"id\">, ApiKey>({\n\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\tdata: data,\n\t\t\t\t});\n\t\t\t\tawait setApiKey(ctx, apiKey, opts);\n\t\t\t} else if (opts.storage === \"secondary-storage\") {\n\t\t\t\tconst id =\n\t\t\t\t\tctx.context.generateId({\n\t\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\t}) ?? generateId();\n\t\t\t\tapiKey = {\n\t\t\t\t\t...data,\n\t\t\t\t\tid,\n\t\t\t\t} as ApiKey;\n\t\t\t\tawait setApiKey(ctx, apiKey, opts);\n\t\t\t} else {\n\t\t\t\tapiKey = await ctx.context.adapter.create<Omit<ApiKey, \"id\">, ApiKey>({\n\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\tdata: data,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\t...(apiKey as ApiKey),\n\t\t\t\tkey: key,\n\t\t\t\tmetadata: metadata ?? null,\n\t\t\t\tpermissions: apiKey.permissions\n\t\t\t\t\t? safeJSONParse(apiKey.permissions)\n\t\t\t\t\t: null,\n\t\t\t});\n\t\t},\n\t);\n}\n", "import type { AuthContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\n\nexport function deleteAllExpiredApiKeysEndpoint({\n\tdeleteAllExpiredApiKeys,\n}: {\n\tdeleteAllExpiredApiKeys(\n\t\tctx: AuthContext,\n\t\tbyPassLastCheckTime?: boolean | undefined,\n\t): Promise<void>;\n}) {\n\treturn createAuthEndpoint(\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t},\n\t\tasync (ctx) => {\n\t\t\ttry {\n\t\t\t\tawait deleteAllExpiredApiKeys(ctx.context, true);\n\t\t\t} catch (error) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\"[API KEY PLUGIN] Failed to delete expired API keys:\",\n\t\t\t\t\terror,\n\t\t\t\t);\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({ success: true, error: null });\n\t\t},\n\t);\n}\n", "import type { AuthContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport * as z from \"zod\";\nimport { APIError, sessionMiddleware } from \"../../../api\";\nimport { API_KEY_TABLE_NAME, ERROR_CODES } from \"..\";\nimport {\n\tdeleteApiKey as deleteApiKeyFromStorage,\n\tgetApiKeyById,\n} from \"../adapter\";\nimport type { apiKeySchema } from \"../schema\";\nimport type { ApiKey } from \"../types\";\nimport type { PredefinedApiKeyOptions } from \".\";\n\nconst deleteApiKeyBodySchema = z.object({\n\tkeyId: z.string().meta({\n\t\tdescription: \"The id of the Api Key\",\n\t}),\n});\n\nexport function deleteApiKey({\n\topts,\n\tschema,\n\tdeleteAllExpiredApiKeys,\n}: {\n\topts: PredefinedApiKeyOptions;\n\tschema: ReturnType<typeof apiKeySchema>;\n\tdeleteAllExpiredApiKeys(\n\t\tctx: AuthContext,\n\t\tbyPassLastCheckTime?: boolean | undefined,\n\t): void;\n}) {\n\treturn createAuthEndpoint(\n\t\t\"/api-key/delete\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: deleteApiKeyBodySchema,\n\t\t\tuse: [sessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Delete an existing API key\",\n\t\t\t\t\trequestBody: {\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tkeyId: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The id of the API key to delete\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"keyId\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"API key deleted successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the API key was successfully deleted\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"success\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { keyId } = ctx.body;\n\t\t\tconst session = ctx.context.session;\n\t\t\tif (session.user.banned === true) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: ERROR_CODES.USER_BANNED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet apiKey: ApiKey | null = null;\n\n\t\t\tapiKey = await getApiKeyById(ctx, keyId, opts);\n\n\t\t\tif (!apiKey || apiKey.userId !== session.user.id) {\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: ERROR_CODES.KEY_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tif (opts.storage === \"secondary-storage\" && opts.fallbackToDatabase) {\n\t\t\t\t\tawait deleteApiKeyFromStorage(ctx, apiKey, opts);\n\t\t\t\t\tawait ctx.context.adapter.delete<ApiKey>({\n\t\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t\tvalue: apiKey.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t} else if (opts.storage === \"database\") {\n\t\t\t\t\tawait ctx.context.adapter.delete<ApiKey>({\n\t\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t\tvalue: apiKey.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tawait deleteApiKeyFromStorage(ctx, apiKey, opts);\n\t\t\t\t}\n\t\t\t} catch (error: any) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: error?.message,\n\t\t\t\t});\n\t\t\t}\n\t\t\tdeleteAllExpiredApiKeys(ctx.context);\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n}\n", "import type { AuthContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { safeJSONParse } from \"@better-auth/core/utils\";\nimport * as z from \"zod\";\nimport { APIError, sessionMiddleware } from \"../../../api\";\nimport { ERROR_CODES } from \"..\";\nimport { getApiKeyById } from \"../adapter\";\nimport type { apiKeySchema } from \"../schema\";\nimport type { ApiKey } from \"../types\";\nimport type { PredefinedApiKeyOptions } from \".\";\n\nconst getApiKeyQuerySchema = z.object({\n\tid: z.string().meta({\n\t\tdescription: \"The id of the Api Key\",\n\t}),\n});\n\nexport function getApiKey({\n\topts,\n\tschema,\n\tdeleteAllExpiredApiKeys,\n}: {\n\topts: PredefinedApiKeyOptions;\n\tschema: ReturnType<typeof apiKeySchema>;\n\tdeleteAllExpiredApiKeys(\n\t\tctx: AuthContext,\n\t\tbyPassLastCheckTime?: boolean | undefined,\n\t): void;\n}) {\n\treturn createAuthEndpoint(\n\t\t\"/api-key/get\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: getApiKeyQuerySchema,\n\t\t\tuse: [sessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Retrieve an existing API key by ID\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"API key retrieved successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"ID\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The name of the key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tstart: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Shows the first few characters of the API key, including the prefix. This allows you to show those few characters in the UI to make it easier for users to identify the API key.\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tprefix: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The API Key prefix. Stored as plain text.\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The owner of the user id\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trefillInterval: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The interval in milliseconds between refills of the `remaining` count. Example: 3600000 // refill every hour (3600000ms = 1h)\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trefillAmount: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The amount to refill\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tlastRefillAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The last refill date\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tenabled: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Sets if key is enabled or disabled\",\n\t\t\t\t\t\t\t\t\t\t\t\tdefault: true,\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitEnabled: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Whether the key has rate limiting enabled\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitTimeWindow: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The duration in milliseconds\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitMax: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Maximum amount of requests allowed within a window\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequestCount: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The number of requests made within the rate limit time window\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tremaining: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Remaining requests (every time api key is used this should updated and should be updated on refill as well)\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tlastRequest: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"When last request occurred\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Expiry date of a key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"created at\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"updated at\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Extra metadata about the apiKey\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Permissions for the api key (stored as JSON string)\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\"userId\",\n\t\t\t\t\t\t\t\t\t\t\t\"enabled\",\n\t\t\t\t\t\t\t\t\t\t\t\"rateLimitEnabled\",\n\t\t\t\t\t\t\t\t\t\t\t\"requestCount\",\n\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { id } = ctx.query;\n\n\t\t\tconst session = ctx.context.session;\n\n\t\t\tlet apiKey: ApiKey | null = null;\n\n\t\t\tapiKey = await getApiKeyById(ctx, id, opts);\n\n\t\t\t// Verify ownership\n\t\t\tif (apiKey && apiKey.userId !== session.user.id) {\n\t\t\t\tapiKey = null;\n\t\t\t}\n\n\t\t\tif (!apiKey) {\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: ERROR_CODES.KEY_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdeleteAllExpiredApiKeys(ctx.context);\n\n\t\t\t// convert metadata string back to object\n\t\t\tapiKey.metadata = schema.apikey.fields.metadata.transform.output(\n\t\t\t\tapiKey.metadata as never as string,\n\t\t\t);\n\n\t\t\tconst { key: _key, ...returningApiKey } = apiKey;\n\n\t\t\treturn ctx.json({\n\t\t\t\t...returningApiKey,\n\t\t\t\tpermissions: returningApiKey.permissions\n\t\t\t\t\t? safeJSONParse<{\n\t\t\t\t\t\t\t[key: string]: string[];\n\t\t\t\t\t\t}>(returningApiKey.permissions)\n\t\t\t\t\t: null,\n\t\t\t});\n\t\t},\n\t);\n}\n", "import type { AuthContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { safeJSONParse } from \"@better-auth/core/utils\";\nimport { sessionMiddleware } from \"../../../api\";\nimport { listApiKeys as listApiKeysFromStorage } from \"../adapter\";\nimport type { apiKeySchema } from \"../schema\";\nimport type { ApiKey } from \"../types\";\nimport type { PredefinedApiKeyOptions } from \".\";\nexport function listApiKeys({\n\topts,\n\tschema,\n\tdeleteAllExpiredApiKeys,\n}: {\n\topts: PredefinedApiKeyOptions;\n\tschema: ReturnType<typeof apiKeySchema>;\n\tdeleteAllExpiredApiKeys(\n\t\tctx: AuthContext,\n\t\tbyPassLastCheckTime?: boolean | undefined,\n\t): void;\n}) {\n\treturn createAuthEndpoint(\n\t\t\"/api-key/list\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tuse: [sessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"List all API keys for the authenticated user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"API keys retrieved successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"ID\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The name of the key\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tstart: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Shows the first few characters of the API key, including the prefix. This allows you to show those few characters in the UI to make it easier for users to identify the API key.\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tprefix: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The API Key prefix. Stored as plain text.\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The owner of the user id\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trefillInterval: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The interval in milliseconds between refills of the `remaining` count. Example: 3600000 // refill every hour (3600000ms = 1h)\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trefillAmount: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The amount to refill\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tlastRefillAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The last refill date\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tenabled: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Sets if key is enabled or disabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdefault: true,\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trateLimitEnabled: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Whether the key has rate limiting enabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trateLimitTimeWindow: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The duration in milliseconds\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trateLimitMax: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Maximum amount of requests allowed within a window\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequestCount: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The number of requests made within the rate limit time window\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tremaining: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Remaining requests (every time api key is used this should updated and should be updated on refill as well)\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tlastRequest: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"When last request occurred\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Expiry date of a key\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"created at\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"updated at\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Extra metadata about the apiKey\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Permissions for the api key (stored as JSON string)\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"userId\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"enabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"rateLimitEnabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"requestCount\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tlet apiKeys: ApiKey[];\n\n\t\t\tapiKeys = await listApiKeysFromStorage(ctx, session.user.id, opts);\n\n\t\t\tdeleteAllExpiredApiKeys(ctx.context);\n\t\t\tapiKeys = apiKeys.map((apiKey) => {\n\t\t\t\treturn {\n\t\t\t\t\t...apiKey,\n\t\t\t\t\tmetadata: schema.apikey.fields.metadata.transform.output(\n\t\t\t\t\t\tapiKey.metadata as never as string,\n\t\t\t\t\t),\n\t\t\t\t};\n\t\t\t});\n\n\t\t\tlet returningApiKey = apiKeys.map((x) => {\n\t\t\t\tconst { key: _key, ...returningApiKey } = x;\n\t\t\t\treturn {\n\t\t\t\t\t...returningApiKey,\n\t\t\t\t\tpermissions: returningApiKey.permissions\n\t\t\t\t\t\t? safeJSONParse<{\n\t\t\t\t\t\t\t\t[key: string]: string[];\n\t\t\t\t\t\t\t}>(returningApiKey.permissions)\n\t\t\t\t\t\t: null,\n\t\t\t\t};\n\t\t\t});\n\n\t\t\treturn ctx.json(returningApiKey);\n\t\t},\n\t);\n}\n", "import type { AuthContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { safeJSONParse } from \"@better-auth/core/utils\";\nimport * as z from \"zod\";\nimport { APIError, getSessionFromCtx } from \"../../../api\";\nimport { getDate } from \"../../../utils/date\";\nimport { API_KEY_TABLE_NAME, ERROR_CODES } from \"..\";\nimport { getApiKeyById, setApiKey } from \"../adapter\";\nimport type { apiKeySchema } from \"../schema\";\nimport type { ApiKey } from \"../types\";\nimport type { PredefinedApiKeyOptions } from \".\";\n\nconst updateApiKeyBodySchema = z.object({\n\tkeyId: z.string().meta({\n\t\tdescription: \"The id of the Api Key\",\n\t}),\n\tuserId: z.coerce\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The id of the user which the api key belongs to. server-only. Eg: \"some-user-id\"',\n\t\t})\n\t\t.optional(),\n\tname: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The name of the key\",\n\t\t})\n\t\t.optional(),\n\tenabled: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"Whether the Api Key is enabled or not\",\n\t\t})\n\t\t.optional(),\n\tremaining: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription: \"The number of remaining requests\",\n\t\t})\n\t\t.min(1)\n\t\t.optional(),\n\trefillAmount: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription: \"The refill amount\",\n\t\t})\n\t\t.optional(),\n\trefillInterval: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription: \"The refill interval\",\n\t\t})\n\t\t.optional(),\n\tmetadata: z.any().optional(),\n\texpiresIn: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription: \"Expiration time of the Api Key in seconds\",\n\t\t})\n\t\t.min(1)\n\t\t.optional()\n\t\t.nullable(),\n\trateLimitEnabled: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"Whether the key has rate limiting enabled.\",\n\t\t})\n\t\t.optional(),\n\trateLimitTimeWindow: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"The duration in milliseconds where each request is counted. server-only. Eg: 1000\",\n\t\t})\n\t\t.optional(),\n\trateLimitMax: z\n\t\t.number()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Maximum amount of requests allowed within a window. Once the `maxRequests` is reached, the request will be rejected until the `timeWindow` has passed, at which point the `timeWindow` will be reset. server-only. Eg: 100\",\n\t\t})\n\t\t.optional(),\n\tpermissions: z\n\t\t.record(z.string(), z.array(z.string()))\n\t\t.meta({\n\t\t\tdescription: \"Update the permissions on the API Key. server-only.\",\n\t\t})\n\t\t.optional()\n\t\t.nullable(),\n});\n\nexport function updateApiKey({\n\topts,\n\tschema,\n\tdeleteAllExpiredApiKeys,\n}: {\n\topts: PredefinedApiKeyOptions;\n\tschema: ReturnType<typeof apiKeySchema>;\n\tdeleteAllExpiredApiKeys(\n\t\tctx: AuthContext,\n\t\tbyPassLastCheckTime?: boolean | undefined,\n\t): void;\n}) {\n\treturn createAuthEndpoint(\n\t\t\"/api-key/update\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: updateApiKeyBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Update an existing API key by ID\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"API key updated successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"ID\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The name of the key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tstart: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Shows the first few characters of the API key, including the prefix. This allows you to show those few characters in the UI to make it easier for users to identify the API key.\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tprefix: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The API Key prefix. Stored as plain text.\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The owner of the user id\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trefillInterval: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The interval in milliseconds between refills of the `remaining` count. Example: 3600000 // refill every hour (3600000ms = 1h)\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trefillAmount: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The amount to refill\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tlastRefillAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The last refill date\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tenabled: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Sets if key is enabled or disabled\",\n\t\t\t\t\t\t\t\t\t\t\t\tdefault: true,\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitEnabled: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Whether the key has rate limiting enabled\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitTimeWindow: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The duration in milliseconds\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trateLimitMax: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Maximum amount of requests allowed within a window\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequestCount: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The number of requests made within the rate limit time window\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tremaining: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Remaining requests (every time api key is used this should updated and should be updated on refill as well)\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tlastRequest: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"When last request occurred\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Expiry date of a key\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"created at\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"updated at\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Extra metadata about the apiKey\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Permissions for the api key (stored as JSON string)\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\"userId\",\n\t\t\t\t\t\t\t\t\t\t\t\"enabled\",\n\t\t\t\t\t\t\t\t\t\t\t\"rateLimitEnabled\",\n\t\t\t\t\t\t\t\t\t\t\t\"requestCount\",\n\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst {\n\t\t\t\tkeyId,\n\t\t\t\texpiresIn,\n\t\t\t\tenabled,\n\t\t\t\tmetadata,\n\t\t\t\trefillAmount,\n\t\t\t\trefillInterval,\n\t\t\t\tremaining,\n\t\t\t\tname,\n\t\t\t\tpermissions,\n\t\t\t\trateLimitEnabled,\n\t\t\t\trateLimitTimeWindow,\n\t\t\t\trateLimitMax,\n\t\t\t} = ctx.body;\n\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\tconst authRequired = ctx.request || ctx.headers;\n\t\t\tconst user =\n\t\t\t\tauthRequired && !session\n\t\t\t\t\t? null\n\t\t\t\t\t: session?.user || { id: ctx.body.userId };\n\n\t\t\tif (!user?.id) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: ERROR_CODES.UNAUTHORIZED_SESSION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (session && ctx.body.userId && session?.user.id !== ctx.body.userId) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: ERROR_CODES.UNAUTHORIZED_SESSION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (authRequired) {\n\t\t\t\t// if this endpoint was being called from the client,\n\t\t\t\t// we must make sure they can't use server-only properties.\n\t\t\t\tif (\n\t\t\t\t\trefillAmount !== undefined ||\n\t\t\t\t\trefillInterval !== undefined ||\n\t\t\t\t\trateLimitMax !== undefined ||\n\t\t\t\t\trateLimitTimeWindow !== undefined ||\n\t\t\t\t\trateLimitEnabled !== undefined ||\n\t\t\t\t\tremaining !== undefined ||\n\t\t\t\t\tpermissions !== undefined\n\t\t\t\t) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.SERVER_ONLY_PROPERTY,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet apiKey: ApiKey | null = null;\n\n\t\t\tapiKey = await getApiKeyById(ctx, keyId, opts);\n\n\t\t\t// Verify ownership\n\t\t\tif (apiKey && apiKey.userId !== user.id) {\n\t\t\t\tapiKey = null;\n\t\t\t}\n\n\t\t\tif (!apiKey) {\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: ERROR_CODES.KEY_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet newValues: Partial<ApiKey> = {};\n\n\t\t\tif (name !== undefined) {\n\t\t\t\tif (name.length < opts.minimumNameLength) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_NAME_LENGTH,\n\t\t\t\t\t});\n\t\t\t\t} else if (name.length > opts.maximumNameLength) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_NAME_LENGTH,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tnewValues.name = name;\n\t\t\t}\n\n\t\t\tif (enabled !== undefined) {\n\t\t\t\tnewValues.enabled = enabled;\n\t\t\t}\n\t\t\tif (expiresIn !== undefined) {\n\t\t\t\tif (opts.keyExpiration.disableCustomExpiresTime === true) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.KEY_DISABLED_EXPIRATION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (expiresIn !== null) {\n\t\t\t\t\t// if expires is not null, check if it's under the valid range\n\t\t\t\t\t// if it IS null, this means the user wants to disable expiration time on the key\n\t\t\t\t\tconst expiresIn_in_days = expiresIn / (60 * 60 * 24);\n\n\t\t\t\t\tif (expiresIn_in_days < opts.keyExpiration.minExpiresIn) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.EXPIRES_IN_IS_TOO_SMALL,\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (expiresIn_in_days > opts.keyExpiration.maxExpiresIn) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.EXPIRES_IN_IS_TOO_LARGE,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tnewValues.expiresAt = expiresIn ? getDate(expiresIn, \"sec\") : null;\n\t\t\t}\n\n\t\t\tif (metadata !== undefined && opts.enableMetadata === true) {\n\t\t\t\tif (typeof metadata !== \"object\") {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_METADATA_TYPE,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t//@ts-expect-error - we need this to be a string to save into DB.\n\t\t\t\tnewValues.metadata =\n\t\t\t\t\tschema.apikey.fields.metadata.transform.input(metadata);\n\t\t\t}\n\t\t\tif (remaining !== undefined) {\n\t\t\t\tnewValues.remaining = remaining;\n\t\t\t}\n\t\t\tif (refillAmount !== undefined || refillInterval !== undefined) {\n\t\t\t\tif (refillAmount !== undefined && refillInterval === undefined) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.REFILL_AMOUNT_AND_INTERVAL_REQUIRED,\n\t\t\t\t\t});\n\t\t\t\t} else if (refillInterval !== undefined && refillAmount === undefined) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ERROR_CODES.REFILL_INTERVAL_AND_AMOUNT_REQUIRED,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tnewValues.refillAmount = refillAmount;\n\t\t\t\tnewValues.refillInterval = refillInterval;\n\t\t\t}\n\n\t\t\tif (rateLimitEnabled !== undefined) {\n\t\t\t\tnewValues.rateLimitEnabled = rateLimitEnabled;\n\t\t\t}\n\t\t\tif (rateLimitTimeWindow !== undefined) {\n\t\t\t\tnewValues.rateLimitTimeWindow = rateLimitTimeWindow;\n\t\t\t}\n\t\t\tif (rateLimitMax !== undefined) {\n\t\t\t\tnewValues.rateLimitMax = rateLimitMax;\n\t\t\t}\n\n\t\t\tif (permissions !== undefined) {\n\t\t\t\t//@ts-expect-error - we need this to be a string to save into DB.\n\t\t\t\tnewValues.permissions = JSON.stringify(permissions);\n\t\t\t}\n\n\t\t\tif (Object.keys(newValues).length === 0) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.NO_VALUES_TO_UPDATE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet newApiKey: ApiKey = apiKey;\n\t\t\ttry {\n\t\t\t\tif (opts.storage === \"secondary-storage\" && opts.fallbackToDatabase) {\n\t\t\t\t\tconst dbUpdated = await ctx.context.adapter.update<ApiKey>({\n\t\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t\tvalue: apiKey.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t\tupdate: newValues,\n\t\t\t\t\t});\n\t\t\t\t\tif (dbUpdated) {\n\t\t\t\t\t\tawait setApiKey(ctx, dbUpdated, opts);\n\t\t\t\t\t\tnewApiKey = dbUpdated;\n\t\t\t\t\t}\n\t\t\t\t} else if (opts.storage === \"database\") {\n\t\t\t\t\tconst result = await ctx.context.adapter.update<ApiKey>({\n\t\t\t\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t\tvalue: apiKey.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t\tupdate: newValues,\n\t\t\t\t\t});\n\t\t\t\t\tif (result) newApiKey = result;\n\t\t\t\t} else {\n\t\t\t\t\tconst updated: ApiKey = {\n\t\t\t\t\t\t...apiKey,\n\t\t\t\t\t\t...newValues,\n\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t};\n\t\t\t\t\tawait setApiKey(ctx, updated, opts);\n\t\t\t\t\tnewApiKey = updated;\n\t\t\t\t}\n\t\t\t} catch (error: any) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: error?.message,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdeleteAllExpiredApiKeys(ctx.context);\n\n\t\t\t// transform metadata from string back to object\n\t\t\tnewApiKey.metadata = schema.apikey.fields.metadata.transform.output(\n\t\t\t\tnewApiKey.metadata as never as string,\n\t\t\t);\n\n\t\t\tconst { key: _key, ...returningApiKey } = newApiKey;\n\n\t\t\treturn ctx.json({\n\t\t\t\t...returningApiKey,\n\t\t\t\tpermissions: returningApiKey.permissions\n\t\t\t\t\t? safeJSONParse<{\n\t\t\t\t\t\t\t[key: string]: string[];\n\t\t\t\t\t\t}>(returningApiKey.permissions)\n\t\t\t\t\t: null,\n\t\t\t});\n\t\t},\n\t);\n}\n", "import type { AuthContext, Awaitable } from \"@better-auth/core\";\nimport { API_KEY_TABLE_NAME } from \"..\";\nimport type { apiKeySchema } from \"../schema\";\nimport type { ApiKey, ApiKeyOptions } from \"../types\";\nimport { createApiKey } from \"./create-api-key\";\nimport { deleteAllExpiredApiKeysEndpoint } from \"./delete-all-expired-api-keys\";\nimport { deleteApiKey } from \"./delete-api-key\";\nimport { getApiKey } from \"./get-api-key\";\nimport { listApiKeys } from \"./list-api-keys\";\nimport { updateApiKey } from \"./update-api-key\";\nimport { verifyApiKey } from \"./verify-api-key\";\n\nexport type PredefinedApiKeyOptions = ApiKeyOptions &\n\tRequired<\n\t\tPick<\n\t\t\tApiKeyOptions,\n\t\t\t| \"apiKeyHeaders\"\n\t\t\t| \"defaultKeyLength\"\n\t\t\t| \"keyExpiration\"\n\t\t\t| \"rateLimit\"\n\t\t\t| \"maximumPrefixLength\"\n\t\t\t| \"minimumPrefixLength\"\n\t\t\t| \"maximumNameLength\"\n\t\t\t| \"disableKeyHashing\"\n\t\t\t| \"minimumNameLength\"\n\t\t\t| \"requireName\"\n\t\t\t| \"enableMetadata\"\n\t\t\t| \"enableSessionForAPIKeys\"\n\t\t\t| \"startingCharactersConfig\"\n\t\t\t| \"storage\"\n\t\t\t| \"fallbackToDatabase\"\n\t\t\t| \"deferUpdates\"\n\t\t>\n\t> & {\n\t\tkeyExpiration: Required<ApiKeyOptions[\"keyExpiration\"]>;\n\t\tstartingCharactersConfig: Required<\n\t\t\tApiKeyOptions[\"startingCharactersConfig\"]\n\t\t>;\n\t};\n\nlet lastChecked: Date | null = null;\n\nexport async function deleteAllExpiredApiKeys(\n\tctx: AuthContext,\n\tbyPassLastCheckTime = false,\n): Promise<void> {\n\tif (lastChecked && !byPassLastCheckTime) {\n\t\tconst now = new Date();\n\t\tconst diff = now.getTime() - lastChecked.getTime();\n\t\tif (diff < 10000) {\n\t\t\treturn;\n\t\t}\n\t}\n\tlastChecked = new Date();\n\tawait ctx.adapter\n\t\t.deleteMany({\n\t\t\tmodel: API_KEY_TABLE_NAME,\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"expiresAt\" satisfies keyof ApiKey,\n\t\t\t\t\toperator: \"lt\",\n\t\t\t\t\tvalue: new Date(),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfield: \"expiresAt\",\n\t\t\t\t\toperator: \"ne\",\n\t\t\t\t\tvalue: null,\n\t\t\t\t},\n\t\t\t],\n\t\t})\n\t\t.catch((error) => {\n\t\t\tctx.logger.error(`Failed to delete expired API keys:`, error);\n\t\t});\n}\n\nexport function createApiKeyRoutes({\n\tkeyGenerator,\n\topts,\n\tschema,\n}: {\n\tkeyGenerator: (options: {\n\t\tlength: number;\n\t\tprefix: string | undefined;\n\t}) => Awaitable<string>;\n\topts: PredefinedApiKeyOptions;\n\tschema: ReturnType<typeof apiKeySchema>;\n}) {\n\treturn {\n\t\tcreateApiKey: createApiKey({\n\t\t\tkeyGenerator,\n\t\t\topts,\n\t\t\tschema,\n\t\t\tdeleteAllExpiredApiKeys,\n\t\t}),\n\t\tverifyApiKey: verifyApiKey({ opts, schema, deleteAllExpiredApiKeys }),\n\t\tgetApiKey: getApiKey({ opts, schema, deleteAllExpiredApiKeys }),\n\t\tupdateApiKey: updateApiKey({ opts, schema, deleteAllExpiredApiKeys }),\n\t\tdeleteApiKey: deleteApiKey({ opts, schema, deleteAllExpiredApiKeys }),\n\t\tlistApiKeys: listApiKeys({ opts, schema, deleteAllExpiredApiKeys }),\n\t\tdeleteAllExpiredApiKeys: deleteAllExpiredApiKeysEndpoint({\n\t\t\tdeleteAllExpiredApiKeys,\n\t\t}),\n\t};\n}\n", "const PROTO_POLLUTION_PATTERNS = {\n\tproto:\n\t\t/\"(?:_|\\\\u0{2}5[Ff]){2}(?:p|\\\\u0{2}70)(?:r|\\\\u0{2}72)(?:o|\\\\u0{2}6[Ff])(?:t|\\\\u0{2}74)(?:o|\\\\u0{2}6[Ff])(?:_|\\\\u0{2}5[Ff]){2}\"\\s*:/,\n\tconstructor:\n\t\t/\"(?:c|\\\\u0063)(?:o|\\\\u006[Ff])(?:n|\\\\u006[Ee])(?:s|\\\\u0073)(?:t|\\\\u0074)(?:r|\\\\u0072)(?:u|\\\\u0075)(?:c|\\\\u0063)(?:t|\\\\u0074)(?:o|\\\\u006[Ff])(?:r|\\\\u0072)\"\\s*:/,\n\tprotoShort: /\"__proto__\"\\s*:/,\n\tconstructorShort: /\"constructor\"\\s*:/,\n} as const;\n\nconst JSON_SIGNATURE =\n\t/^\\s*[\"[{]|^\\s*-?\\d{1,16}(\\.\\d{1,17})?([Ee][+-]?\\d+)?\\s*$/;\n\nconst SPECIAL_VALUES = {\n\ttrue: true,\n\tfalse: false,\n\tnull: null,\n\tundefined: undefined,\n\tnan: Number.NaN,\n\tinfinity: Number.POSITIVE_INFINITY,\n\t\"-infinity\": Number.NEGATIVE_INFINITY,\n} as const;\n\nconst ISO_DATE_REGEX =\n\t/^(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})(?:\\.(\\d{1,7}))?(?:Z|([+-])(\\d{2}):(\\d{2}))$/;\n\ntype ParseOptions = {\n\t/** Throw errors instead of returning the original value */\n\tstrict?: boolean | undefined;\n\t/** Log warnings when suspicious patterns are detected */\n\twarnings?: boolean | undefined;\n\t/** Custom reviver function */\n\treviver?: ((key: string, value: any) => any) | undefined;\n\t/** Automatically convert ISO date strings to Date objects */\n\tparseDates?: boolean | undefined;\n};\n\nfunction isValidDate(date: Date): boolean {\n\treturn date instanceof Date && !isNaN(date.getTime());\n}\n\nfunction parseISODate(value: string): Date | null {\n\tconst match = ISO_DATE_REGEX.exec(value);\n\tif (!match) return null;\n\n\tconst [\n\t\t,\n\t\tyear,\n\t\tmonth,\n\t\tday,\n\t\thour,\n\t\tminute,\n\t\tsecond,\n\t\tms,\n\t\toffsetSign,\n\t\toffsetHour,\n\t\toffsetMinute,\n\t] = match;\n\n\tlet date = new Date(\n\t\tDate.UTC(\n\t\t\tparseInt(year!, 10),\n\t\t\tparseInt(month!, 10) - 1,\n\t\t\tparseInt(day!, 10),\n\t\t\tparseInt(hour!, 10),\n\t\t\tparseInt(minute!, 10),\n\t\t\tparseInt(second!, 10),\n\t\t\tms ? parseInt(ms.padEnd(3, \"0\"), 10) : 0,\n\t\t),\n\t);\n\n\tif (offsetSign) {\n\t\tconst offset =\n\t\t\t(parseInt(offsetHour!, 10) * 60 + parseInt(offsetMinute!, 10)) *\n\t\t\t(offsetSign === \"+\" ? -1 : 1);\n\t\tdate.setUTCMinutes(date.getUTCMinutes() + offset);\n\t}\n\n\treturn isValidDate(date) ? date : null;\n}\n\nfunction betterJSONParse<T = unknown>(\n\tvalue: unknown,\n\toptions: ParseOptions = {},\n): T {\n\tconst {\n\t\tstrict = false,\n\t\twarnings = false,\n\t\treviver,\n\t\tparseDates = true,\n\t} = options;\n\n\tif (typeof value !== \"string\") {\n\t\treturn value as T;\n\t}\n\n\tconst trimmed = value.trim();\n\n\tif (\n\t\ttrimmed.length > 0 &&\n\t\ttrimmed[0] === '\"' &&\n\t\ttrimmed.endsWith('\"') &&\n\t\t!trimmed.slice(1, -1).includes('\"')\n\t) {\n\t\treturn trimmed.slice(1, -1) as T;\n\t}\n\n\tconst lowerValue = trimmed.toLowerCase();\n\tif (lowerValue.length <= 9 && lowerValue in SPECIAL_VALUES) {\n\t\treturn SPECIAL_VALUES[lowerValue as keyof typeof SPECIAL_VALUES] as T;\n\t}\n\n\tif (!JSON_SIGNATURE.test(trimmed)) {\n\t\tif (strict) {\n\t\t\tthrow new SyntaxError(\"[better-json] Invalid JSON\");\n\t\t}\n\t\treturn value as T;\n\t}\n\n\tconst hasProtoPattern = Object.entries(PROTO_POLLUTION_PATTERNS).some(\n\t\t([key, pattern]) => {\n\t\t\tconst matches = pattern.test(trimmed);\n\t\t\tif (matches && warnings) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[better-json] Detected potential prototype pollution attempt using ${key} pattern`,\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn matches;\n\t\t},\n\t);\n\n\tif (hasProtoPattern && strict) {\n\t\tthrow new Error(\n\t\t\t\"[better-json] Potential prototype pollution attempt detected\",\n\t\t);\n\t}\n\n\ttry {\n\t\tconst secureReviver = (key: string, value: any) => {\n\t\t\tif (\n\t\t\t\tkey === \"__proto__\" ||\n\t\t\t\t(key === \"constructor\" &&\n\t\t\t\t\tvalue &&\n\t\t\t\t\ttypeof value === \"object\" &&\n\t\t\t\t\t\"prototype\" in value)\n\t\t\t) {\n\t\t\t\tif (warnings) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`[better-json] Dropping \"${key}\" key to prevent prototype pollution`,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tif (parseDates && typeof value === \"string\") {\n\t\t\t\tconst date = parseISODate(value);\n\t\t\t\tif (date) {\n\t\t\t\t\treturn date;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn reviver ? reviver(key, value) : value;\n\t\t};\n\n\t\treturn JSON.parse(trimmed, secureReviver);\n\t} catch (error) {\n\t\tif (strict) {\n\t\t\tthrow error;\n\t\t}\n\t\treturn value as T;\n\t}\n}\n\nexport function parseJSON<T = unknown>(\n\tvalue: unknown,\n\toptions: ParseOptions = { strict: true },\n): T {\n\treturn betterJSONParse<T>(value, options);\n}\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\nimport { parseJSON } from \"../../client/parser\";\n\nexport const apiKeySchema = ({\n\ttimeWindow,\n\trateLimitMax,\n}: {\n\ttimeWindow: number;\n\trateLimitMax: number;\n}) =>\n\t({\n\t\tapikey: {\n\t\t\tfields: {\n\t\t\t\t/**\n\t\t\t\t * The name of the key.\n\t\t\t\t */\n\t\t\t\tname: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * Shows the first few characters of the API key\n\t\t\t\t * This allows you to show those few characters in the UI to make it easier for users to identify the API key.\n\t\t\t\t */\n\t\t\t\tstart: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The prefix of the key.\n\t\t\t\t */\n\t\t\t\tprefix: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The hashed key value.\n\t\t\t\t */\n\t\t\t\tkey: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\trequired: true,\n\t\t\t\t\tinput: false,\n\t\t\t\t\tindex: true,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The user id of the user who created the key.\n\t\t\t\t */\n\t\t\t\tuserId: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\treferences: { model: \"user\", field: \"id\", onDelete: \"cascade\" },\n\t\t\t\t\trequired: true,\n\t\t\t\t\tinput: false,\n\t\t\t\t\tindex: true,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The interval to refill the key in milliseconds.\n\t\t\t\t */\n\t\t\t\trefillInterval: {\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The amount to refill the remaining count of the key.\n\t\t\t\t */\n\t\t\t\trefillAmount: {\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The date and time when the key was last refilled.\n\t\t\t\t */\n\t\t\t\tlastRefillAt: {\n\t\t\t\t\ttype: \"date\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * Whether the key is enabled.\n\t\t\t\t */\n\t\t\t\tenabled: {\n\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t\tdefaultValue: true,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * Whether the key has rate limiting enabled.\n\t\t\t\t */\n\t\t\t\trateLimitEnabled: {\n\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t\tdefaultValue: true,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The time window in milliseconds for the rate limit.\n\t\t\t\t */\n\t\t\t\trateLimitTimeWindow: {\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t\tdefaultValue: timeWindow,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The maximum number of requests allowed within the `rateLimitTimeWindow`.\n\t\t\t\t */\n\t\t\t\trateLimitMax: {\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t\tdefaultValue: rateLimitMax,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The number of requests made within the rate limit time window\n\t\t\t\t */\n\t\t\t\trequestCount: {\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t\tdefaultValue: 0,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The remaining number of requests before the key is revoked.\n\t\t\t\t *\n\t\t\t\t * If this is null, then the key is not revoked.\n\t\t\t\t *\n\t\t\t\t * If `refillInterval` & `refillAmount` are provided, than this will refill accordingly.\n\t\t\t\t */\n\t\t\t\tremaining: {\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The date and time of the last request made to the key.\n\t\t\t\t */\n\t\t\t\tlastRequest: {\n\t\t\t\t\ttype: \"date\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The date and time when the key will expire.\n\t\t\t\t */\n\t\t\t\texpiresAt: {\n\t\t\t\t\ttype: \"date\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The date and time when the key was created.\n\t\t\t\t */\n\t\t\t\tcreatedAt: {\n\t\t\t\t\ttype: \"date\",\n\t\t\t\t\trequired: true,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The date and time when the key was last updated.\n\t\t\t\t */\n\t\t\t\tupdatedAt: {\n\t\t\t\t\ttype: \"date\",\n\t\t\t\t\trequired: true,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The permissions of the key.\n\t\t\t\t */\n\t\t\t\tpermissions: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: false,\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * Any additional metadata you want to store with the key.\n\t\t\t\t */\n\t\t\t\tmetadata: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tinput: true,\n\t\t\t\t\ttransform: {\n\t\t\t\t\t\tinput(value) {\n\t\t\t\t\t\t\treturn JSON.stringify(value);\n\t\t\t\t\t\t},\n\t\t\t\t\t\toutput(value) {\n\t\t\t\t\t\t\tif (!value) return null;\n\t\t\t\t\t\t\treturn parseJSON<any>(value as string);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}) satisfies BetterAuthPluginDBSchema;\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { createAuthMiddleware } from \"@better-auth/core/api\";\nimport { defineErrorCodes } from \"@better-auth/core/utils\";\nimport { base64Url } from \"@better-auth/utils/base64\";\nimport { createHash } from \"@better-auth/utils/hash\";\nimport { APIError } from \"../../api\";\nimport { generateRandomString } from \"../../crypto/random\";\nimport { mergeSchema } from \"../../db\";\nimport { getDate } from \"../../utils/date\";\nimport { getIp } from \"../../utils/get-request-ip\";\nimport { createApiKeyRoutes, deleteAllExpiredApiKeys } from \"./routes\";\nimport { validateApiKey } from \"./routes/verify-api-key\";\nimport { apiKeySchema } from \"./schema\";\nimport type { ApiKeyOptions } from \"./types\";\n\nexport const defaultKeyHasher = async (key: string) => {\n\tconst hash = await createHash(\"SHA-256\").digest(\n\t\tnew TextEncoder().encode(key),\n\t);\n\tconst hashed = base64Url.encode(new Uint8Array(hash), {\n\t\tpadding: false,\n\t});\n\treturn hashed;\n};\n\nexport const ERROR_CODES = defineErrorCodes({\n\tINVALID_METADATA_TYPE: \"metadata must be an object or undefined\",\n\tREFILL_AMOUNT_AND_INTERVAL_REQUIRED:\n\t\t\"refillAmount is required when refillInterval is provided\",\n\tREFILL_INTERVAL_AND_AMOUNT_REQUIRED:\n\t\t\"refillInterval is required when refillAmount is provided\",\n\tUSER_BANNED: \"User is banned\",\n\tUNAUTHORIZED_SESSION: \"Unauthorized or invalid session\",\n\tKEY_NOT_FOUND: \"API Key not found\",\n\tKEY_DISABLED: \"API Key is disabled\",\n\tKEY_EXPIRED: \"API Key has expired\",\n\tUSAGE_EXCEEDED: \"API Key has reached its usage limit\",\n\tKEY_NOT_RECOVERABLE: \"API Key is not recoverable\",\n\tEXPIRES_IN_IS_TOO_SMALL:\n\t\t\"The expiresIn is smaller than the predefined minimum value.\",\n\tEXPIRES_IN_IS_TOO_LARGE:\n\t\t\"The expiresIn is larger than the predefined maximum value.\",\n\tINVALID_REMAINING: \"The remaining count is either too large or too small.\",\n\tINVALID_PREFIX_LENGTH: \"The prefix length is either too large or too small.\",\n\tINVALID_NAME_LENGTH: \"The name length is either too large or too small.\",\n\tMETADATA_DISABLED: \"Metadata is disabled.\",\n\tRATE_LIMIT_EXCEEDED: \"Rate limit exceeded.\",\n\tNO_VALUES_TO_UPDATE: \"No values to update.\",\n\tKEY_DISABLED_EXPIRATION: \"Custom key expiration values are disabled.\",\n\tINVALID_API_KEY: \"Invalid API key.\",\n\tINVALID_USER_ID_FROM_API_KEY: \"The user id from the API key is invalid.\",\n\tINVALID_API_KEY_GETTER_RETURN_TYPE:\n\t\t\"API Key getter returned an invalid key type. Expected string.\",\n\tSERVER_ONLY_PROPERTY:\n\t\t\"The property you're trying to set can only be set from the server auth instance only.\",\n\tFAILED_TO_UPDATE_API_KEY: \"Failed to update API key\",\n\tNAME_REQUIRED: \"API Key name is required.\",\n});\n\nexport const API_KEY_TABLE_NAME = \"apikey\";\n\nexport const apiKey = (options?: ApiKeyOptions | undefined) => {\n\tconst opts = {\n\t\t...options,\n\t\tapiKeyHeaders: options?.apiKeyHeaders ?? \"x-api-key\",\n\t\tdefaultKeyLength: options?.defaultKeyLength || 64,\n\t\tmaximumPrefixLength: options?.maximumPrefixLength ?? 32,\n\t\tminimumPrefixLength: options?.minimumPrefixLength ?? 1,\n\t\tmaximumNameLength: options?.maximumNameLength ?? 32,\n\t\tminimumNameLength: options?.minimumNameLength ?? 1,\n\t\tenableMetadata: options?.enableMetadata ?? false,\n\t\tdisableKeyHashing: options?.disableKeyHashing ?? false,\n\t\trequireName: options?.requireName ?? false,\n\t\tstorage: options?.storage ?? \"database\",\n\t\trateLimit: {\n\t\t\tenabled:\n\t\t\t\toptions?.rateLimit?.enabled === undefined\n\t\t\t\t\t? true\n\t\t\t\t\t: options?.rateLimit?.enabled,\n\t\t\ttimeWindow: options?.rateLimit?.timeWindow ?? 1000 * 60 * 60 * 24,\n\t\t\tmaxRequests: options?.rateLimit?.maxRequests ?? 10,\n\t\t},\n\t\tkeyExpiration: {\n\t\t\tdefaultExpiresIn: options?.keyExpiration?.defaultExpiresIn ?? null,\n\t\t\tdisableCustomExpiresTime:\n\t\t\t\toptions?.keyExpiration?.disableCustomExpiresTime ?? false,\n\t\t\tmaxExpiresIn: options?.keyExpiration?.maxExpiresIn ?? 365,\n\t\t\tminExpiresIn: options?.keyExpiration?.minExpiresIn ?? 1,\n\t\t},\n\t\tstartingCharactersConfig: {\n\t\t\tshouldStore: options?.startingCharactersConfig?.shouldStore ?? true,\n\t\t\tcharactersLength:\n\t\t\t\toptions?.startingCharactersConfig?.charactersLength ?? 6,\n\t\t},\n\t\tenableSessionForAPIKeys: options?.enableSessionForAPIKeys ?? false,\n\t\tfallbackToDatabase: options?.fallbackToDatabase ?? false,\n\t\tcustomStorage: options?.customStorage,\n\t\tdeferUpdates: options?.deferUpdates ?? false,\n\t} satisfies ApiKeyOptions;\n\n\tconst schema = mergeSchema(\n\t\tapiKeySchema({\n\t\t\trateLimitMax: opts.rateLimit.maxRequests,\n\t\t\ttimeWindow: opts.rateLimit.timeWindow,\n\t\t}),\n\t\topts.schema,\n\t);\n\n\tconst getter =\n\t\topts.customAPIKeyGetter ||\n\t\t((ctx) => {\n\t\t\tif (Array.isArray(opts.apiKeyHeaders)) {\n\t\t\t\tfor (const header of opts.apiKeyHeaders) {\n\t\t\t\t\tconst value = ctx.headers?.get(header);\n\t\t\t\t\tif (value) {\n\t\t\t\t\t\treturn value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn ctx.headers?.get(opts.apiKeyHeaders);\n\t\t\t}\n\t\t});\n\n\tconst keyGenerator =\n\t\topts.customKeyGenerator ||\n\t\t(async (options: { length: number; prefix: string | undefined }) => {\n\t\t\tconst key = generateRandomString(options.length, \"a-z\", \"A-Z\");\n\t\t\treturn `${options.prefix || \"\"}${key}`;\n\t\t});\n\n\tconst routes = createApiKeyRoutes({ keyGenerator, opts, schema });\n\n\treturn {\n\t\tid: \"api-key\",\n\t\t$ERROR_CODES: ERROR_CODES,\n\t\thooks: {\n\t\t\tbefore: [\n\t\t\t\t{\n\t\t\t\t\tmatcher: (ctx) => !!getter(ctx) && opts.enableSessionForAPIKeys,\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst key = getter(ctx)!;\n\n\t\t\t\t\t\tif (typeof key !== \"string\") {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_API_KEY_GETTER_RETURN_TYPE,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (key.length < opts.defaultKeyLength) {\n\t\t\t\t\t\t\t// if the key is shorter than the default key length, than we know the key is invalid.\n\t\t\t\t\t\t\t// we can't check if the key is exactly equal to the default key length, because\n\t\t\t\t\t\t\t// a prefix may be added to the key.\n\t\t\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_API_KEY,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (opts.customAPIKeyValidator) {\n\t\t\t\t\t\t\tconst isValid = await opts.customAPIKeyValidator({ ctx, key });\n\t\t\t\t\t\t\tif (!isValid) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_API_KEY,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst hashed = opts.disableKeyHashing\n\t\t\t\t\t\t\t? key\n\t\t\t\t\t\t\t: await defaultKeyHasher(key);\n\n\t\t\t\t\t\tconst apiKey = await validateApiKey({\n\t\t\t\t\t\t\thashedKey: hashed,\n\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\topts,\n\t\t\t\t\t\t\tschema,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tconst cleanupTask = deleteAllExpiredApiKeys(ctx.context).catch(\n\t\t\t\t\t\t\t(err) => {\n\t\t\t\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t\t\t\t\"Failed to delete expired API keys:\",\n\t\t\t\t\t\t\t\t\terr,\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (opts.deferUpdates) {\n\t\t\t\t\t\t\tctx.context.runInBackground(cleanupTask);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst user = await ctx.context.internalAdapter.findUserById(\n\t\t\t\t\t\t\tapiKey.userId,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (!user) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USER_ID_FROM_API_KEY,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst session = {\n\t\t\t\t\t\t\tuser,\n\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\tid: apiKey.id,\n\t\t\t\t\t\t\t\ttoken: key,\n\t\t\t\t\t\t\t\tuserId: apiKey.userId,\n\t\t\t\t\t\t\t\tuserAgent: ctx.request?.headers.get(\"user-agent\") ?? null,\n\t\t\t\t\t\t\t\tipAddress: ctx.request\n\t\t\t\t\t\t\t\t\t? getIp(ctx.request, ctx.context.options)\n\t\t\t\t\t\t\t\t\t: null,\n\t\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t\t\texpiresAt:\n\t\t\t\t\t\t\t\t\tapiKey.expiresAt ||\n\t\t\t\t\t\t\t\t\tgetDate(\n\t\t\t\t\t\t\t\t\t\tctx.context.options.session?.expiresIn || 60 * 60 * 24 * 7, // 7 days\n\t\t\t\t\t\t\t\t\t\t\"ms\",\n\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t// Always set the session context for API key authentication\n\t\t\t\t\t\tctx.context.session = session;\n\n\t\t\t\t\t\tif (ctx.path === \"/get-session\") {\n\t\t\t\t\t\t\treturn session;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tcontext: ctx,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tendpoints: {\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/api-key/create`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.createApiKey`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.apiKey.create`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/api-key#api-method-api-key-create)\n\t\t\t */\n\t\t\tcreateApiKey: routes.createApiKey,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/api-key/verify`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.verifyApiKey`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/api-key#api-method-api-key-verify)\n\t\t\t */\n\t\t\tverifyApiKey: routes.verifyApiKey,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * GET `/api-key/get`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.getApiKey`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.apiKey.get`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/api-key#api-method-api-key-get)\n\t\t\t */\n\t\t\tgetApiKey: routes.getApiKey,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/api-key/update`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.updateApiKey`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.apiKey.update`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/api-key#api-method-api-key-update)\n\t\t\t */\n\t\t\tupdateApiKey: routes.updateApiKey,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/api-key/delete`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.deleteApiKey`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.apiKey.delete`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/api-key#api-method-api-key-delete)\n\t\t\t */\n\t\t\tdeleteApiKey: routes.deleteApiKey,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * GET `/api-key/list`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.listApiKeys`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.apiKey.list`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/api-key#api-method-api-key-list)\n\t\t\t */\n\t\t\tlistApiKeys: routes.listApiKeys,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/api-key/delete-all-expired-api-keys`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.deleteAllExpiredApiKeys`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/api-key#api-method-api-key-delete-all-expired-api-keys)\n\t\t\t */\n\t\t\tdeleteAllExpiredApiKeys: routes.deleteAllExpiredApiKeys,\n\t\t},\n\t\tschema,\n\t\toptions,\n\t} satisfies BetterAuthPlugin;\n};\n\nexport type * from \"./types\";\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { createAuthMiddleware } from \"@better-auth/core/api\";\nimport { createHMAC } from \"@better-auth/utils/hmac\";\nimport { serializeSignedCookie } from \"better-call\";\nimport { parseSetCookieHeader } from \"../../cookies\";\n\nexport interface BearerOptions {\n\t/**\n\t * If true, only signed tokens\n\t * will be converted to session\n\t * cookies\n\t *\n\t * @default false\n\t */\n\trequireSignature?: boolean | undefined;\n}\n\n/**\n * Converts bearer token to session cookie\n */\nexport const bearer = (options?: BearerOptions | undefined) => {\n\treturn {\n\t\tid: \"bearer\",\n\t\thooks: {\n\t\t\tbefore: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn Boolean(\n\t\t\t\t\t\t\tcontext.request?.headers.get(\"authorization\") ||\n\t\t\t\t\t\t\t\tcontext.headers?.get(\"authorization\"),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (c) => {\n\t\t\t\t\t\tconst token =\n\t\t\t\t\t\t\tc.request?.headers.get(\"authorization\")?.replace(\"Bearer \", \"\") ||\n\t\t\t\t\t\t\tc.headers?.get(\"Authorization\")?.replace(\"Bearer \", \"\");\n\t\t\t\t\t\tif (!token) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet signedToken = \"\";\n\t\t\t\t\t\tif (token.includes(\".\")) {\n\t\t\t\t\t\t\tsignedToken = token.replace(\"=\", \"\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif (options?.requireSignature) {\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tsignedToken = (\n\t\t\t\t\t\t\t\tawait serializeSignedCookie(\"\", token, c.context.secret)\n\t\t\t\t\t\t\t).replace(\"=\", \"\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst decodedToken = decodeURIComponent(signedToken);\n\t\t\t\t\t\t\tconst isValid = await createHMAC(\n\t\t\t\t\t\t\t\t\"SHA-256\",\n\t\t\t\t\t\t\t\t\"base64urlnopad\",\n\t\t\t\t\t\t\t).verify(\n\t\t\t\t\t\t\t\tc.context.secret,\n\t\t\t\t\t\t\t\tdecodedToken.split(\".\")[0]!,\n\t\t\t\t\t\t\t\tdecodedToken.split(\".\")[1]!,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tif (!isValid) {\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst existingHeaders = (c.request?.headers ||\n\t\t\t\t\t\t\tc.headers) as Headers;\n\t\t\t\t\t\tconst headers = new Headers({\n\t\t\t\t\t\t\t...Object.fromEntries(existingHeaders?.entries()),\n\t\t\t\t\t\t});\n\t\t\t\t\t\theaders.append(\n\t\t\t\t\t\t\t\"cookie\",\n\t\t\t\t\t\t\t`${c.context.authCookies.sessionToken.name}=${signedToken}`,\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tcontext: {\n\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst setCookie = ctx.context.responseHeaders?.get(\"set-cookie\");\n\t\t\t\t\t\tif (!setCookie) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst parsedCookies = parseSetCookieHeader(setCookie);\n\t\t\t\t\t\tconst cookieName = ctx.context.authCookies.sessionToken.name;\n\t\t\t\t\t\tconst sessionCookie = parsedCookies.get(cookieName);\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t!sessionCookie ||\n\t\t\t\t\t\t\t!sessionCookie.value ||\n\t\t\t\t\t\t\tsessionCookie[\"max-age\"] === 0\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst token = sessionCookie.value;\n\t\t\t\t\t\tconst exposedHeaders =\n\t\t\t\t\t\t\tctx.context.responseHeaders?.get(\n\t\t\t\t\t\t\t\t\"access-control-expose-headers\",\n\t\t\t\t\t\t\t) || \"\";\n\t\t\t\t\t\tconst headersSet = new Set(\n\t\t\t\t\t\t\texposedHeaders\n\t\t\t\t\t\t\t\t.split(\",\")\n\t\t\t\t\t\t\t\t.map((header) => header.trim())\n\t\t\t\t\t\t\t\t.filter(Boolean),\n\t\t\t\t\t\t);\n\t\t\t\t\t\theadersSet.add(\"set-auth-token\");\n\t\t\t\t\t\tctx.setHeader(\"set-auth-token\", token);\n\t\t\t\t\t\tctx.setHeader(\n\t\t\t\t\t\t\t\"Access-Control-Expose-Headers\",\n\t\t\t\t\t\t\tArray.from(headersSet).join(\", \"),\n\t\t\t\t\t\t);\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\toptions,\n\t} satisfies BetterAuthPlugin;\n};\n", "type Params = {\n\tmessage: string;\n\tstatus: number;\n};\n\nexport const middlewareResponse = ({ message, status }: Params) => ({\n\tresponse: new Response(\n\t\tJSON.stringify({\n\t\t\tmessage,\n\t\t}),\n\t\t{\n\t\t\tstatus,\n\t\t},\n\t),\n});\n", "import type { Provider } from \"./types\";\n\nexport const defaultEndpoints = [\n\t\"/sign-up/email\",\n\t\"/sign-in/email\",\n\t\"/request-password-reset\",\n];\n\nexport const Providers = {\n\tCLOUDFLARE_TURNSTILE: \"cloudflare-turnstile\",\n\tGOOGLE_RECAPTCHA: \"google-recaptcha\",\n\tHCAPTCHA: \"hcaptcha\",\n\tCAPTCHAFOX: \"captchafox\",\n} as const;\n\nexport const siteVerifyMap: Record<Provider, string> = {\n\t[Providers.CLOUDFLARE_TURNSTILE]:\n\t\t\"https://challenges.cloudflare.com/turnstile/v0/siteverify\",\n\t[Providers.GOOGLE_RECAPTCHA]:\n\t\t\"https://www.google.com/recaptcha/api/siteverify\",\n\t[Providers.HCAPTCHA]: \"https://api.hcaptcha.com/siteverify\",\n\t[Providers.CAPTCHAFOX]: \"https://api.captchafox.com/siteverify\",\n};\n", "// These error codes are returned by the API\nimport { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const EXTERNAL_ERROR_CODES = defineErrorCodes({\n\tVERIFICATION_FAILED: \"Captcha verification failed\",\n\tMISSING_RESPONSE: \"Missing CAPTCHA response\",\n\tUNKNOWN_ERROR: \"Something went wrong\",\n});\n\n// These error codes are only visible in the server logs\nexport const INTERNAL_ERROR_CODES = defineErrorCodes({\n\tMISSING_SECRET_KEY: \"Missing secret key\",\n\tSERVICE_UNAVAILABLE: \"CAPTCHA service unavailable\",\n});\n", "export const encodeToURLParams = (obj: Record<string, any>): string => {\n\tif (typeof obj !== \"object\" || obj === null || Array.isArray(obj)) {\n\t\tthrow new Error(\"Input must be a non-null object.\");\n\t}\n\n\tconst params = new URLSearchParams();\n\n\tfor (const [key, value] of Object.entries(obj)) {\n\t\tif (value !== undefined && value !== null) {\n\t\t\tparams.append(key, String(value));\n\t\t}\n\t}\n\n\treturn params.toString();\n};\n", "import { betterFetch } from \"@better-fetch/fetch\";\nimport { middlewareResponse } from \"../../../utils/middleware-response\";\nimport { EXTERNAL_ERROR_CODES, INTERNAL_ERROR_CODES } from \"../error-codes\";\nimport { encodeToURLParams } from \"../utils\";\n\ntype Params = {\n\tsiteVerifyURL: string;\n\tsecretKey: string;\n\tcaptchaResponse: string;\n\tsiteKey?: string | undefined;\n\tremoteIP?: string | undefined;\n};\n\ntype SiteVerifyResponse = {\n\tsuccess: boolean;\n\tchallenge_ts: number;\n\thostname: string;\n\t\"error-codes\":\n\t\t| Array<\n\t\t\t\t| \"missing-input-secret\"\n\t\t\t\t| \"invalid-input-secret\"\n\t\t\t\t| \"invalid-input-sitekey\"\n\t\t\t\t| \"missing-input-response\"\n\t\t\t\t| \"invalid-input-response\"\n\t\t\t\t| \"expired-input-response\"\n\t\t\t\t| \"timeout-or-duplicate\"\n\t\t\t\t| \"bad-request\"\n\t\t  >\n\t\t| undefined;\n\tinsights: Record<string, unknown> | undefined; // ENTERPRISE feature: insights into verification.\n};\n\nexport const captchaFox = async ({\n\tsiteVerifyURL,\n\tcaptchaResponse,\n\tsecretKey,\n\tsiteKey,\n\tremoteIP,\n}: Params) => {\n\tconst response = await betterFetch<SiteVerifyResponse>(siteVerifyURL, {\n\t\tmethod: \"POST\",\n\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\tbody: encodeToURLParams({\n\t\t\tsecret: secretKey,\n\t\t\tresponse: captchaResponse,\n\t\t\t...(siteKey && { sitekey: siteKey }),\n\t\t\t...(remoteIP && { remoteIp: remoteIP }),\n\t\t}),\n\t});\n\n\tif (!response.data || response.error) {\n\t\tthrow new Error(INTERNAL_ERROR_CODES.SERVICE_UNAVAILABLE);\n\t}\n\n\tif (!response.data.success) {\n\t\treturn middlewareResponse({\n\t\t\tmessage: EXTERNAL_ERROR_CODES.VERIFICATION_FAILED,\n\t\t\tstatus: 403,\n\t\t});\n\t}\n\n\treturn undefined;\n};\n", "import { betterFetch } from \"@better-fetch/fetch\";\nimport { middlewareResponse } from \"../../../utils/middleware-response\";\nimport { EXTERNAL_ERROR_CODES, INTERNAL_ERROR_CODES } from \"../error-codes\";\n\ntype Params = {\n\tsiteVerifyURL: string;\n\tsecretKey: string;\n\tcaptchaResponse: string;\n\tremoteIP?: string | undefined;\n};\n\ntype SiteVerifyResponse = {\n\tsuccess: boolean;\n\t\"error-codes\"?: string[] | undefined;\n\tchallenge_ts?: string | undefined;\n\thostname?: string | undefined;\n\taction?: string | undefined;\n\tcdata?: string | undefined;\n\tmetadata?:\n\t\t| {\n\t\t\t\tinteractive: boolean;\n\t\t  }\n\t\t| undefined;\n\tmessages?: string[] | undefined;\n};\n\nexport const cloudflareTurnstile = async ({\n\tsiteVerifyURL,\n\tcaptchaResponse,\n\tsecretKey,\n\tremoteIP,\n}: Params) => {\n\tconst response = await betterFetch<SiteVerifyResponse>(siteVerifyURL, {\n\t\tmethod: \"POST\",\n\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\tbody: JSON.stringify({\n\t\t\tsecret: secretKey,\n\t\t\tresponse: captchaResponse,\n\t\t\t...(remoteIP && { remoteip: remoteIP }),\n\t\t}),\n\t});\n\n\tif (!response.data || response.error) {\n\t\tthrow new Error(INTERNAL_ERROR_CODES.SERVICE_UNAVAILABLE);\n\t}\n\n\tif (!response.data.success) {\n\t\treturn middlewareResponse({\n\t\t\tmessage: EXTERNAL_ERROR_CODES.VERIFICATION_FAILED,\n\t\t\tstatus: 403,\n\t\t});\n\t}\n\n\treturn undefined;\n};\n", "import { betterFetch } from \"@better-fetch/fetch\";\nimport { middlewareResponse } from \"../../../utils/middleware-response\";\nimport { EXTERNAL_ERROR_CODES, INTERNAL_ERROR_CODES } from \"../error-codes\";\nimport { encodeToURLParams } from \"../utils\";\n\ntype Params = {\n\tsiteVerifyURL: string;\n\tsecretKey: string;\n\tcaptchaResponse: string;\n\tminScore?: number | undefined;\n\tremoteIP?: string | undefined;\n};\n\ntype SiteVerifyResponse = {\n\tsuccess: boolean;\n\tchallenge_ts: string;\n\thostname: string;\n\t\"error-codes\":\n\t\t| Array<\n\t\t\t\t| \"missing-input-secret\"\n\t\t\t\t| \"invalid-input-secret\"\n\t\t\t\t| \"missing-input-response\"\n\t\t\t\t| \"invalid-input-response\"\n\t\t\t\t| \"bad-request\"\n\t\t\t\t| \"timeout-or-duplicate\"\n\t\t  >\n\t\t| undefined;\n};\n\ntype SiteVerifyV3Response = SiteVerifyResponse & {\n\tscore: number;\n};\n\nconst isV3 = (\n\tresponse: SiteVerifyResponse | SiteVerifyV3Response,\n): response is SiteVerifyV3Response => {\n\treturn \"score\" in response && typeof response.score === \"number\";\n};\n\nexport const googleRecaptcha = async ({\n\tsiteVerifyURL,\n\tcaptchaResponse,\n\tsecretKey,\n\tminScore = 0.5,\n\tremoteIP,\n}: Params) => {\n\tconst response = await betterFetch<SiteVerifyResponse | SiteVerifyV3Response>(\n\t\tsiteVerifyURL,\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\t\tbody: encodeToURLParams({\n\t\t\t\tsecret: secretKey,\n\t\t\t\tresponse: captchaResponse,\n\t\t\t\t...(remoteIP && { remoteip: remoteIP }),\n\t\t\t}),\n\t\t},\n\t);\n\n\tif (!response.data || response.error) {\n\t\tthrow new Error(INTERNAL_ERROR_CODES.SERVICE_UNAVAILABLE);\n\t}\n\n\tif (\n\t\t!response.data.success ||\n\t\t(isV3(response.data) && response.data.score < minScore)\n\t) {\n\t\treturn middlewareResponse({\n\t\t\tmessage: EXTERNAL_ERROR_CODES.VERIFICATION_FAILED,\n\t\t\tstatus: 403,\n\t\t});\n\t}\n\n\treturn undefined;\n};\n", "import { betterFetch } from \"@better-fetch/fetch\";\nimport { middlewareResponse } from \"../../../utils/middleware-response\";\nimport { EXTERNAL_ERROR_CODES, INTERNAL_ERROR_CODES } from \"../error-codes\";\nimport { encodeToURLParams } from \"../utils\";\n\ntype Params = {\n\tsiteVerifyURL: string;\n\tsecretKey: string;\n\tcaptchaResponse: string;\n\tsiteKey?: string | undefined;\n\tremoteIP?: string | undefined;\n};\n\ntype SiteVerifyResponse = {\n\tsuccess: boolean;\n\tchallenge_ts: number;\n\thostname: string;\n\tcredit: true | false | undefined;\n\t\"error-codes\":\n\t\t| Array<\n\t\t\t\t| \"missing-input-secret\"\n\t\t\t\t| \"invalid-input-secret\"\n\t\t\t\t| \"missing-input-response\"\n\t\t\t\t| \"invalid-input-response\"\n\t\t\t\t| \"expired-input-response\"\n\t\t\t\t| \"already-seen-response\"\n\t\t\t\t| \"bad-request\"\n\t\t\t\t| \"missing-remoteip\"\n\t\t\t\t| \"invalid-remoteip\"\n\t\t\t\t| \"not-using-dummy-passcode\"\n\t\t\t\t| \"sitekey-secret-mismatch\"\n\t\t  >\n\t\t| undefined;\n\tscore: number | undefined; // ENTERPRISE feature: a score denoting malicious activity.\n\tscore_reason: Array<unknown> | undefined; // ENTERPRISE feature: reason(s) for score.\n};\n\nexport const hCaptcha = async ({\n\tsiteVerifyURL,\n\tcaptchaResponse,\n\tsecretKey,\n\tsiteKey,\n\tremoteIP,\n}: Params) => {\n\tconst response = await betterFetch<SiteVerifyResponse>(siteVerifyURL, {\n\t\tmethod: \"POST\",\n\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\tbody: encodeToURLParams({\n\t\t\tsecret: secretKey,\n\t\t\tresponse: captchaResponse,\n\t\t\t...(siteKey && { sitekey: siteKey }),\n\t\t\t...(remoteIP && { remoteip: remoteIP }),\n\t\t}),\n\t});\n\n\tif (!response.data || response.error) {\n\t\tthrow new Error(INTERNAL_ERROR_CODES.SERVICE_UNAVAILABLE);\n\t}\n\n\tif (!response.data.success) {\n\t\treturn middlewareResponse({\n\t\t\tmessage: EXTERNAL_ERROR_CODES.VERIFICATION_FAILED,\n\t\t\tstatus: 403,\n\t\t});\n\t}\n\n\treturn undefined;\n};\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { getIp } from \"../../utils/get-request-ip\";\nimport { middlewareResponse } from \"../../utils/middleware-response\";\nimport { defaultEndpoints, Providers, siteVerifyMap } from \"./constants\";\nimport { EXTERNAL_ERROR_CODES, INTERNAL_ERROR_CODES } from \"./error-codes\";\nimport type { CaptchaOptions } from \"./types\";\nimport * as verifyHandlers from \"./verify-handlers\";\n\nexport const captcha = (options: CaptchaOptions) =>\n\t({\n\t\tid: \"captcha\",\n\t\tonRequest: async (request, ctx) => {\n\t\t\ttry {\n\t\t\t\tconst endpoints = options.endpoints?.length\n\t\t\t\t\t? options.endpoints\n\t\t\t\t\t: defaultEndpoints;\n\n\t\t\t\tif (!endpoints.some((endpoint) => request.url.includes(endpoint)))\n\t\t\t\t\treturn undefined;\n\n\t\t\t\tif (!options.secretKey) {\n\t\t\t\t\tthrow new Error(INTERNAL_ERROR_CODES.MISSING_SECRET_KEY);\n\t\t\t\t}\n\n\t\t\t\tconst captchaResponse = request.headers.get(\"x-captcha-response\");\n\t\t\t\tconst remoteUserIP = getIp(request, ctx.options) ?? undefined;\n\n\t\t\t\tif (!captchaResponse) {\n\t\t\t\t\treturn middlewareResponse({\n\t\t\t\t\t\tmessage: EXTERNAL_ERROR_CODES.MISSING_RESPONSE,\n\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst siteVerifyURL =\n\t\t\t\t\toptions.siteVerifyURLOverride || siteVerifyMap[options.provider];\n\n\t\t\t\tconst handlerParams = {\n\t\t\t\t\tsiteVerifyURL,\n\t\t\t\t\tcaptchaResponse,\n\t\t\t\t\tsecretKey: options.secretKey,\n\t\t\t\t\tremoteIP: remoteUserIP,\n\t\t\t\t};\n\n\t\t\t\tif (options.provider === Providers.CLOUDFLARE_TURNSTILE) {\n\t\t\t\t\treturn await verifyHandlers.cloudflareTurnstile(handlerParams);\n\t\t\t\t}\n\n\t\t\t\tif (options.provider === Providers.GOOGLE_RECAPTCHA) {\n\t\t\t\t\treturn await verifyHandlers.googleRecaptcha({\n\t\t\t\t\t\t...handlerParams,\n\t\t\t\t\t\tminScore: options.minScore,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (options.provider === Providers.HCAPTCHA) {\n\t\t\t\t\treturn await verifyHandlers.hCaptcha({\n\t\t\t\t\t\t...handlerParams,\n\t\t\t\t\t\tsiteKey: options.siteKey,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (options.provider === Providers.CAPTCHAFOX) {\n\t\t\t\t\treturn await verifyHandlers.captchaFox({\n\t\t\t\t\t\t...handlerParams,\n\t\t\t\t\t\tsiteKey: options.siteKey,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch (_error) {\n\t\t\t\tconst errorMessage =\n\t\t\t\t\t_error instanceof Error ? _error.message : undefined;\n\n\t\t\t\tctx.logger.error(errorMessage ?? \"Unknown error\", {\n\t\t\t\t\tendpoint: request.url,\n\t\t\t\t\tmessage: _error,\n\t\t\t\t});\n\n\t\t\t\treturn middlewareResponse({\n\t\t\t\t\tmessage: EXTERNAL_ERROR_CODES.UNKNOWN_ERROR,\n\t\t\t\t\tstatus: 500,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\toptions,\n\t}) satisfies BetterAuthPlugin;\n", "import type {\n\tBetterAuthOptions,\n\tBetterAuthPlugin,\n\tGenericEndpointContext,\n} from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport * as z from \"zod\";\nimport { getSession } from \"../../api\";\nimport type { InferSession, InferUser } from \"../../types\";\nimport { getEndpointResponse } from \"../../utils/plugin-helper\";\n\nconst getSessionQuerySchema = z.optional(\n\tz.object({\n\t\t/**\n\t\t * If cookie cache is enabled, it will disable the cache\n\t\t * and fetch the session from the database\n\t\t */\n\t\tdisableCookieCache: z\n\t\t\t.boolean()\n\t\t\t.meta({\n\t\t\t\tdescription: \"Disable cookie cache and fetch session from database\",\n\t\t\t})\n\t\t\t.or(z.string().transform((v) => v === \"true\"))\n\t\t\t.optional(),\n\t\tdisableRefresh: z\n\t\t\t.boolean()\n\t\t\t.meta({\n\t\t\t\tdescription:\n\t\t\t\t\t\"Disable session refresh. Useful for checking session status, without updating the session\",\n\t\t\t})\n\t\t\t.optional(),\n\t}),\n);\n\nexport type CustomSessionPluginOptions = {\n\t/**\n\t * This option is used to determine if the list-device-sessions endpoint should be mutated to the custom session data.\n\t * @default false\n\t */\n\tshouldMutateListDeviceSessionsEndpoint?: boolean | undefined;\n};\n\nexport const customSession = <\n\tReturns extends Record<string, any>,\n\tO extends BetterAuthOptions = BetterAuthOptions,\n>(\n\tfn: (\n\t\tsession: {\n\t\t\tuser: InferUser<O>;\n\t\t\tsession: InferSession<O>;\n\t\t},\n\t\tctx: GenericEndpointContext,\n\t) => Promise<Returns>,\n\toptions?: O | undefined,\n\tpluginOptions?: CustomSessionPluginOptions | undefined,\n) => {\n\treturn {\n\t\tid: \"custom-session\",\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher: (ctx) =>\n\t\t\t\t\t\tctx.path === \"/multi-session/list-device-sessions\" &&\n\t\t\t\t\t\t(pluginOptions?.shouldMutateListDeviceSessionsEndpoint ?? false),\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst response = await getEndpointResponse<[]>(ctx);\n\t\t\t\t\t\tif (!response) return;\n\t\t\t\t\t\tconst newResponse = await Promise.all(\n\t\t\t\t\t\t\tresponse.map(async (v) => await fn(v, ctx)),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn ctx.json(newResponse);\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tendpoints: {\n\t\t\tgetSession: createAuthEndpoint(\n\t\t\t\t\"/get-session\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tquery: getSessionQuerySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\tCUSTOM_SESSION: true,\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Get custom session data\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\trequireHeaders: true,\n\t\t\t\t},\n\t\t\t\tasync (ctx): Promise<Returns | null> => {\n\t\t\t\t\tconst session = await getSession()({\n\t\t\t\t\t\t...ctx,\n\t\t\t\t\t\tasResponse: false,\n\t\t\t\t\t\theaders: ctx.headers,\n\t\t\t\t\t\treturnHeaders: true,\n\t\t\t\t\t}).catch((e) => {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t});\n\t\t\t\t\tif (!session?.response) {\n\t\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t\t}\n\t\t\t\t\tconst fnResult = await fn(session.response as any, ctx);\n\n\t\t\t\t\tconst setCookie = session.headers.get(\"set-cookie\");\n\t\t\t\t\tif (setCookie) {\n\t\t\t\t\t\tctx.setHeader(\"set-cookie\", setCookie);\n\t\t\t\t\t\tsession.headers.delete(\"set-cookie\");\n\t\t\t\t\t}\n\n\t\t\t\t\tsession.headers.forEach((value, key) => {\n\t\t\t\t\t\tctx.setHeader(key, value);\n\t\t\t\t\t});\n\t\t\t\t\treturn ctx.json(fnResult);\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\t$Infer: {\n\t\t\tSession: {} as Awaited<ReturnType<typeof fn>>,\n\t\t},\n\t\toptions: pluginOptions,\n\t} satisfies BetterAuthPlugin;\n};\n", "import { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const DEVICE_AUTHORIZATION_ERROR_CODES = defineErrorCodes({\n\tINVALID_DEVICE_CODE: \"Invalid device code\",\n\tEXPIRED_DEVICE_CODE: \"Device code has expired\",\n\tEXPIRED_USER_CODE: \"User code has expired\",\n\tAUTHORIZATION_PENDING: \"Authorization pending\",\n\tACCESS_DENIED: \"Access denied\",\n\tINVALID_USER_CODE: \"Invalid user code\",\n\tDEVICE_CODE_ALREADY_PROCESSED: \"Device code already processed\",\n\tPOLLING_TOO_FREQUENTLY: \"Polling too frequently\",\n\tUSER_NOT_FOUND: \"User not found\",\n\tFAILED_TO_CREATE_SESSION: \"Failed to create session\",\n\tINVALID_DEVICE_CODE_STATUS: \"Invalid device code status\",\n\tAUTHENTICATION_REQUIRED: \"Authentication required\",\n});\n", "import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { getSessionFromCtx } from \"../../api/routes/session\";\nimport { generateRandomString } from \"../../crypto\";\nimport { ms } from \"../../utils/time\";\nimport type { DeviceAuthorizationOptions } from \".\";\nimport { DEVICE_AUTHORIZATION_ERROR_CODES } from \"./error-codes\";\nimport type { DeviceCode } from \"./schema\";\n\n/* cspell:disable-next-line */\nconst defaultCharset = \"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\";\n\nconst deviceCodeBodySchema = z.object({\n\tclient_id: z.string().meta({\n\t\tdescription: \"The client ID of the application\",\n\t}),\n\tscope: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"Space-separated list of scopes\",\n\t\t})\n\t\t.optional(),\n});\n\nconst deviceCodeErrorSchema = z.object({\n\terror: z.enum([\"invalid_request\", \"invalid_client\"]).meta({\n\t\tdescription: \"Error code\",\n\t}),\n\terror_description: z.string().meta({\n\t\tdescription: \"Detailed error description\",\n\t}),\n});\n\nexport const deviceCode = (opts: DeviceAuthorizationOptions) => {\n\tconst generateDeviceCode = async () => {\n\t\tif (opts.generateDeviceCode) {\n\t\t\treturn opts.generateDeviceCode();\n\t\t}\n\t\treturn defaultGenerateDeviceCode(opts.deviceCodeLength);\n\t};\n\n\tconst generateUserCode = async () => {\n\t\tif (opts.generateUserCode) {\n\t\t\treturn opts.generateUserCode();\n\t\t}\n\t\treturn defaultGenerateUserCode(opts.userCodeLength);\n\t};\n\treturn createAuthEndpoint(\n\t\t\"/device/code\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: deviceCodeBodySchema,\n\t\t\terror: deviceCodeErrorSchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: `Request a device and user code\n\nFollow [rfc8628#section-3.2](https://datatracker.ietf.org/doc/html/rfc8628#section-3.2)`,\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tdevice_code: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The device verification code\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser_code: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The user code to display\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tverification_uri: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The URL for user verification. Defaults to /device if not configured.\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tverification_uri_complete: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The complete URL with user code as query parameter.\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\texpires_in: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Lifetime in seconds of the device code\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tinterval: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Minimum polling interval in seconds\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t400: {\n\t\t\t\t\t\t\tdescription: \"Error response\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [\"invalid_request\", \"invalid_client\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\terror_description: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (opts.validateClient) {\n\t\t\t\tconst isValid = await opts.validateClient(ctx.body.client_id);\n\t\t\t\tif (!isValid) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\terror_description: \"Invalid client ID\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (opts.onDeviceAuthRequest) {\n\t\t\t\tawait opts.onDeviceAuthRequest(ctx.body.client_id, ctx.body.scope);\n\t\t\t}\n\n\t\t\tconst deviceCode = await generateDeviceCode();\n\t\t\tconst userCode = await generateUserCode();\n\t\t\tconst expiresIn = ms(opts.expiresIn);\n\t\t\tconst expiresAt = new Date(Date.now() + expiresIn);\n\n\t\t\tawait ctx.context.adapter.create({\n\t\t\t\tmodel: \"deviceCode\",\n\t\t\t\tdata: {\n\t\t\t\t\tdeviceCode,\n\t\t\t\t\tuserCode,\n\t\t\t\t\texpiresAt,\n\t\t\t\t\tstatus: \"pending\",\n\t\t\t\t\tpollingInterval: ms(opts.interval),\n\t\t\t\t\tclientId: ctx.body.client_id,\n\t\t\t\t\tscope: ctx.body.scope,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tconst { verificationUri, verificationUriComplete } =\n\t\t\t\tbuildVerificationUris(\n\t\t\t\t\topts.verificationUri,\n\t\t\t\t\tctx.context.baseURL,\n\t\t\t\t\tuserCode,\n\t\t\t\t);\n\n\t\t\treturn ctx.json(\n\t\t\t\t{\n\t\t\t\t\tdevice_code: deviceCode,\n\t\t\t\t\tuser_code: userCode,\n\t\t\t\t\tverification_uri: verificationUri,\n\t\t\t\t\tverification_uri_complete: verificationUriComplete,\n\t\t\t\t\texpires_in: Math.floor(expiresIn / 1000),\n\t\t\t\t\tinterval: Math.floor(ms(opts.interval) / 1000),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t\"Cache-Control\": \"no-store\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\t\t},\n\t);\n};\n\nconst deviceTokenBodySchema = z.object({\n\tgrant_type: z.literal(\"urn:ietf:params:oauth:grant-type:device_code\").meta({\n\t\tdescription: \"The grant type for device flow\",\n\t}),\n\tdevice_code: z.string().meta({\n\t\tdescription: \"The device verification code\",\n\t}),\n\tclient_id: z.string().meta({\n\t\tdescription: \"The client ID of the application\",\n\t}),\n});\n\nconst deviceTokenErrorSchema = z.object({\n\terror: z\n\t\t.enum([\n\t\t\t\"authorization_pending\",\n\t\t\t\"slow_down\",\n\t\t\t\"expired_token\",\n\t\t\t\"access_denied\",\n\t\t\t\"invalid_request\",\n\t\t\t\"invalid_grant\",\n\t\t])\n\t\t.meta({\n\t\t\tdescription: \"Error code\",\n\t\t}),\n\terror_description: z.string().meta({\n\t\tdescription: \"Detailed error description\",\n\t}),\n});\n\nexport const deviceToken = (opts: DeviceAuthorizationOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/device/token\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: deviceTokenBodySchema,\n\t\t\terror: deviceTokenErrorSchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: `Exchange device code for access token\n\nFollow [rfc8628#section-3.4](https://datatracker.ietf.org/doc/html/rfc8628#section-3.4)`,\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t400: {\n\t\t\t\t\t\t\tdescription: \"Error response\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"authorization_pending\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"slow_down\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"expired_token\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"access_denied\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"invalid_request\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"invalid_grant\",\n\t\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\terror_description: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { device_code, client_id } = ctx.body;\n\n\t\t\tif (opts.validateClient) {\n\t\t\t\tconst isValid = await opts.validateClient(client_id);\n\t\t\t\tif (!isValid) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\terror_description: \"Invalid client ID\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst deviceCodeRecord = await ctx.context.adapter.findOne<{\n\t\t\t\tid: string;\n\t\t\t\tdeviceCode: string;\n\t\t\t\tuserCode: string;\n\t\t\t\tuserId?: string | undefined;\n\t\t\t\texpiresAt: Date;\n\t\t\t\tstatus: string;\n\t\t\t\tlastPolledAt?: Date | undefined;\n\t\t\t\tpollingInterval?: number | undefined;\n\t\t\t\tclientId?: string | undefined;\n\t\t\t\tscope?: string | undefined;\n\t\t\t}>({\n\t\t\t\tmodel: \"deviceCode\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"deviceCode\",\n\t\t\t\t\t\tvalue: device_code,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\tif (!deviceCodeRecord) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\terror_description:\n\t\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.INVALID_DEVICE_CODE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tdeviceCodeRecord.clientId &&\n\t\t\t\tdeviceCodeRecord.clientId !== client_id\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\terror_description: \"Client ID mismatch\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Check for rate limiting\n\t\t\tif (deviceCodeRecord.lastPolledAt && deviceCodeRecord.pollingInterval) {\n\t\t\t\tconst timeSinceLastPoll =\n\t\t\t\t\tDate.now() - new Date(deviceCodeRecord.lastPolledAt).getTime();\n\t\t\t\tconst minInterval = deviceCodeRecord.pollingInterval;\n\n\t\t\t\tif (timeSinceLastPoll < minInterval) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\terror: \"slow_down\",\n\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.POLLING_TOO_FREQUENTLY,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Update last polled time\n\t\t\tawait ctx.context.adapter.update({\n\t\t\t\tmodel: \"deviceCode\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: deviceCodeRecord.id,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\tlastPolledAt: new Date(),\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (deviceCodeRecord.expiresAt < new Date()) {\n\t\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\t\tmodel: \"deviceCode\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\tvalue: deviceCodeRecord.id,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t});\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\terror: \"expired_token\",\n\t\t\t\t\terror_description:\n\t\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.EXPIRED_DEVICE_CODE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (deviceCodeRecord.status === \"pending\") {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\terror: \"authorization_pending\",\n\t\t\t\t\terror_description:\n\t\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.AUTHORIZATION_PENDING,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (deviceCodeRecord.status === \"denied\") {\n\t\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\t\tmodel: \"deviceCode\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\tvalue: deviceCodeRecord.id,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t});\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\terror: \"access_denied\",\n\t\t\t\t\terror_description: DEVICE_AUTHORIZATION_ERROR_CODES.ACCESS_DENIED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (deviceCodeRecord.status === \"approved\" && deviceCodeRecord.userId) {\n\t\t\t\tconst user = await ctx.context.internalAdapter.findUserById(\n\t\t\t\t\tdeviceCodeRecord.userId,\n\t\t\t\t);\n\n\t\t\t\tif (!user) {\n\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\terror: \"server_error\",\n\t\t\t\t\t\terror_description: DEVICE_AUTHORIZATION_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\tuser.id,\n\t\t\t\t);\n\n\t\t\t\tif (!session) {\n\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\terror: \"server_error\",\n\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Set new session context for hooks and plugins\n\t\t\t\t// (matches setSessionCookie logic)\n\t\t\t\tctx.context.setNewSession({\n\t\t\t\t\tsession,\n\t\t\t\t\tuser,\n\t\t\t\t});\n\n\t\t\t\t// If secondary storage is enabled, store the session data in the secondary storage\n\t\t\t\t// (matches setSessionCookie logic)\n\t\t\t\tif (ctx.context.options.secondaryStorage) {\n\t\t\t\t\tawait ctx.context.secondaryStorage?.set(\n\t\t\t\t\t\tsession.token,\n\t\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\t\tuser,\n\t\t\t\t\t\t\tsession,\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tMath.floor(\n\t\t\t\t\t\t\t(new Date(session.expiresAt).getTime() - Date.now()) / 1000,\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\t// Delete the device code after successful authorization\n\t\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\t\tmodel: \"deviceCode\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\tvalue: deviceCodeRecord.id,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t});\n\n\t\t\t\t// Return OAuth 2.0 compliant token response\n\t\t\t\treturn ctx.json(\n\t\t\t\t\t{\n\t\t\t\t\t\taccess_token: session.token,\n\t\t\t\t\t\ttoken_type: \"Bearer\",\n\t\t\t\t\t\texpires_in: Math.floor(\n\t\t\t\t\t\t\t(new Date(session.expiresAt).getTime() - Date.now()) / 1000,\n\t\t\t\t\t\t),\n\t\t\t\t\t\tscope: deviceCodeRecord.scope || \"\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"Cache-Control\": \"no-store\",\n\t\t\t\t\t\t\tPragma: \"no-cache\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\terror: \"server_error\",\n\t\t\t\terror_description:\n\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.INVALID_DEVICE_CODE_STATUS,\n\t\t\t});\n\t\t},\n\t);\n\nexport const deviceVerify = createAuthEndpoint(\n\t\"/device\",\n\t{\n\t\tmethod: \"GET\",\n\t\tquery: z.object({\n\t\t\tuser_code: z.string().meta({\n\t\t\t\tdescription: \"The user code to verify\",\n\t\t\t}),\n\t\t}),\n\t\terror: z.object({\n\t\t\terror: z.enum([\"invalid_request\"]).meta({\n\t\t\t\tdescription: \"Error code\",\n\t\t\t}),\n\t\t\terror_description: z.string().meta({\n\t\t\t\tdescription: \"Detailed error description\",\n\t\t\t}),\n\t\t}),\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Verify user code and get device authorization status\",\n\t\t\t\tresponses: {\n\t\t\t\t\t200: {\n\t\t\t\t\t\tdescription: \"Device authorization status\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tuser_code: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The user code to verify\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tenum: [\"pending\", \"approved\", \"denied\"],\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Current status of the device authorization\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst { user_code } = ctx.query;\n\t\tconst cleanUserCode = user_code.replace(/-/g, \"\");\n\n\t\tconst deviceCodeRecord = await ctx.context.adapter.findOne<DeviceCode>({\n\t\t\tmodel: \"deviceCode\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"userCode\",\n\t\t\t\t\tvalue: cleanUserCode,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\tif (!deviceCodeRecord) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\terror: \"invalid_request\",\n\t\t\t\terror_description: DEVICE_AUTHORIZATION_ERROR_CODES.INVALID_USER_CODE,\n\t\t\t});\n\t\t}\n\n\t\tif (deviceCodeRecord.expiresAt < new Date()) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\terror: \"expired_token\",\n\t\t\t\terror_description: DEVICE_AUTHORIZATION_ERROR_CODES.EXPIRED_USER_CODE,\n\t\t\t});\n\t\t}\n\n\t\treturn ctx.json({\n\t\t\tuser_code: user_code,\n\t\t\tstatus: deviceCodeRecord.status,\n\t\t});\n\t},\n);\n\nexport const deviceApprove = createAuthEndpoint(\n\t\"/device/approve\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\tuserCode: z.string().meta({\n\t\t\t\tdescription: \"The user code to approve\",\n\t\t\t}),\n\t\t}),\n\t\terror: z.object({\n\t\t\terror: z\n\t\t\t\t.enum([\n\t\t\t\t\t\"invalid_request\",\n\t\t\t\t\t\"expired_token\",\n\t\t\t\t\t\"device_code_already_processed\",\n\t\t\t\t])\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"Error code\",\n\t\t\t\t}),\n\t\t\terror_description: z.string().meta({\n\t\t\t\tdescription: \"Detailed error description\",\n\t\t\t}),\n\t\t}),\n\t\trequireHeaders: true,\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Approve device authorization\",\n\t\t\t\tresponses: {\n\t\t\t\t\t200: {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst session = await getSessionFromCtx(ctx);\n\t\tif (!session) {\n\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\terror: \"unauthorized\",\n\t\t\t\terror_description:\n\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.AUTHENTICATION_REQUIRED,\n\t\t\t});\n\t\t}\n\n\t\tconst { userCode } = ctx.body;\n\t\tconst cleanUserCode = userCode.replace(/-/g, \"\");\n\n\t\tconst deviceCodeRecord = await ctx.context.adapter.findOne<DeviceCode>({\n\t\t\tmodel: \"deviceCode\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"userCode\",\n\t\t\t\t\tvalue: cleanUserCode,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\tif (!deviceCodeRecord) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\terror: \"invalid_request\",\n\t\t\t\terror_description: DEVICE_AUTHORIZATION_ERROR_CODES.INVALID_USER_CODE,\n\t\t\t});\n\t\t}\n\n\t\tif (deviceCodeRecord.expiresAt < new Date()) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\terror: \"expired_token\",\n\t\t\t\terror_description: DEVICE_AUTHORIZATION_ERROR_CODES.EXPIRED_USER_CODE,\n\t\t\t});\n\t\t}\n\n\t\tif (deviceCodeRecord.status !== \"pending\") {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\terror: \"invalid_request\",\n\t\t\t\terror_description:\n\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.DEVICE_CODE_ALREADY_PROCESSED,\n\t\t\t});\n\t\t}\n\n\t\t// Update device code with approved status and user ID\n\t\tawait ctx.context.adapter.update({\n\t\t\tmodel: \"deviceCode\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: deviceCodeRecord.id,\n\t\t\t\t},\n\t\t\t],\n\t\t\tupdate: {\n\t\t\t\tstatus: \"approved\",\n\t\t\t\tuserId: session.user.id,\n\t\t\t},\n\t\t});\n\n\t\treturn ctx.json({\n\t\t\tsuccess: true,\n\t\t});\n\t},\n);\n\nexport const deviceDeny = createAuthEndpoint(\n\t\"/device/deny\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\tuserCode: z.string().meta({\n\t\t\t\tdescription: \"The user code to deny\",\n\t\t\t}),\n\t\t}),\n\t\terror: z.object({\n\t\t\terror: z.enum([\"invalid_request\", \"expired_token\"]).meta({\n\t\t\t\tdescription: \"Error code\",\n\t\t\t}),\n\t\t\terror_description: z.string().meta({\n\t\t\t\tdescription: \"Detailed error description\",\n\t\t\t}),\n\t\t}),\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Deny device authorization\",\n\t\t\t\tresponses: {\n\t\t\t\t\t200: {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst { userCode } = ctx.body;\n\t\tconst cleanUserCode = userCode.replace(/-/g, \"\");\n\n\t\tconst deviceCodeRecord = await ctx.context.adapter.findOne<DeviceCode>({\n\t\t\tmodel: \"deviceCode\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"userCode\",\n\t\t\t\t\tvalue: cleanUserCode,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\tif (!deviceCodeRecord) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\terror: \"invalid_request\",\n\t\t\t\terror_description: DEVICE_AUTHORIZATION_ERROR_CODES.INVALID_USER_CODE,\n\t\t\t});\n\t\t}\n\n\t\tif (deviceCodeRecord.expiresAt < new Date()) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\terror: \"expired_token\",\n\t\t\t\terror_description: DEVICE_AUTHORIZATION_ERROR_CODES.EXPIRED_USER_CODE,\n\t\t\t});\n\t\t}\n\n\t\tif (deviceCodeRecord.status !== \"pending\") {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\terror: \"invalid_request\",\n\t\t\t\terror_description:\n\t\t\t\t\tDEVICE_AUTHORIZATION_ERROR_CODES.DEVICE_CODE_ALREADY_PROCESSED,\n\t\t\t});\n\t\t}\n\n\t\t// Update device code with denied status\n\t\tawait ctx.context.adapter.update({\n\t\t\tmodel: \"deviceCode\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: deviceCodeRecord.id,\n\t\t\t\t},\n\t\t\t],\n\t\t\tupdate: {\n\t\t\t\tstatus: \"denied\",\n\t\t\t},\n\t\t});\n\n\t\treturn ctx.json({\n\t\t\tsuccess: true,\n\t\t});\n\t},\n);\n\n/**\n * @internal\n */\nconst buildVerificationUris = (\n\tverificationUri: string | undefined,\n\tbaseURL: string,\n\tuserCode: string,\n): {\n\tverificationUri: string;\n\tverificationUriComplete: string;\n} => {\n\tconst uri = verificationUri || \"/device\";\n\n\tlet verificationUrl: URL;\n\ttry {\n\t\tverificationUrl = new URL(uri);\n\t} catch {\n\t\tverificationUrl = new URL(uri, baseURL);\n\t}\n\n\tconst verificationUriCompleteUrl = new URL(verificationUrl);\n\tverificationUriCompleteUrl.searchParams.set(\"user_code\", userCode);\n\n\tconst verificationUriString = verificationUrl.toString();\n\tconst verificationUriCompleteString = verificationUriCompleteUrl.toString();\n\n\treturn {\n\t\tverificationUri: verificationUriString,\n\t\tverificationUriComplete: verificationUriCompleteString,\n\t};\n};\n\n/**\n * @internal\n */\nconst defaultGenerateDeviceCode = (length: number) => {\n\treturn generateRandomString(length, \"a-z\", \"A-Z\", \"0-9\");\n};\n\n/**\n * @internal\n */\nconst defaultGenerateUserCode = (length: number) => {\n\tconst chars = new Uint8Array(length);\n\treturn Array.from(crypto.getRandomValues(chars))\n\t\t.map((byte) => defaultCharset[byte % defaultCharset.length])\n\t\t.join(\"\");\n};\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\nimport * as z from \"zod\";\n\nexport const schema = {\n\tdeviceCode: {\n\t\tfields: {\n\t\t\tdeviceCode: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\tuserCode: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\tuserId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t\texpiresAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\tstatus: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\tlastPolledAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t\tpollingInterval: {\n\t\t\t\ttype: \"number\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t\tclientId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t\tscope: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t},\n\t},\n} satisfies BetterAuthPluginDBSchema;\n\nconst deviceCode = z.object({\n\tid: z.string(),\n\tdeviceCode: z.string(),\n\tuserCode: z.string(),\n\tuserId: z.string().optional(),\n\texpiresAt: z.date(),\n\tstatus: z.string(),\n\tlastPolledAt: z.date().optional(),\n\tpollingInterval: z.number().optional(),\n\tclientId: z.string().optional(),\n\tscope: z.string().optional(),\n});\n\nexport type DeviceCode = z.infer<typeof deviceCode>;\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport * as z from \"zod\";\nimport { mergeSchema } from \"../../db\";\nimport type { InferOptionSchema } from \"../../types/plugins\";\nimport type { TimeString } from \"../../utils/time\";\nimport { ms } from \"../../utils/time\";\nimport { DEVICE_AUTHORIZATION_ERROR_CODES } from \"./error-codes\";\nimport {\n\tdeviceApprove,\n\tdeviceCode,\n\tdeviceDeny,\n\tdeviceToken,\n\tdeviceVerify,\n} from \"./routes\";\nimport { schema } from \"./schema\";\n\nconst timeStringSchema = z.custom<TimeString>(\n\t(val) => {\n\t\tif (typeof val !== \"string\") return false;\n\t\ttry {\n\t\t\tms(val as TimeString);\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t},\n\t{\n\t\tmessage:\n\t\t\t\"Invalid time string format. Use formats like '30m', '5s', '1h', etc.\",\n\t},\n);\n\nexport const deviceAuthorizationOptionsSchema = z.object({\n\texpiresIn: timeStringSchema\n\t\t.default(\"30m\")\n\t\t.describe(\n\t\t\t\"Time in seconds until the device code expires. Use formats like '30m', '5s', '1h', etc.\",\n\t\t),\n\tinterval: timeStringSchema\n\t\t.default(\"5s\")\n\t\t.describe(\n\t\t\t\"Time in seconds between polling attempts. Use formats like '30m', '5s', '1h', etc.\",\n\t\t),\n\tdeviceCodeLength: z\n\t\t.number()\n\t\t.int()\n\t\t.positive()\n\t\t.default(40)\n\t\t.describe(\n\t\t\t\"Length of the device code to be generated. Default is 40 characters.\",\n\t\t),\n\tuserCodeLength: z\n\t\t.number()\n\t\t.int()\n\t\t.positive()\n\t\t.default(8)\n\t\t.describe(\n\t\t\t\"Length of the user code to be generated. Default is 8 characters.\",\n\t\t),\n\tgenerateDeviceCode: z\n\t\t.custom<() => string | Promise<string>>(\n\t\t\t(val) => typeof val === \"function\",\n\t\t\t{\n\t\t\t\tmessage:\n\t\t\t\t\t\"generateDeviceCode must be a function that returns a string or a promise that resolves to a string.\",\n\t\t\t},\n\t\t)\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"Function to generate a device code. If not provided, a default random string generator will be used.\",\n\t\t),\n\tgenerateUserCode: z\n\t\t.custom<() => string | Promise<string>>(\n\t\t\t(val) => typeof val === \"function\",\n\t\t\t{\n\t\t\t\tmessage:\n\t\t\t\t\t\"generateUserCode must be a function that returns a string or a promise that resolves to a string.\",\n\t\t\t},\n\t\t)\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"Function to generate a user code. If not provided, a default random string generator will be used.\",\n\t\t),\n\tvalidateClient: z\n\t\t.custom<(clientId: string) => boolean | Promise<boolean>>(\n\t\t\t(val) => typeof val === \"function\",\n\t\t\t{\n\t\t\t\tmessage:\n\t\t\t\t\t\"validateClient must be a function that returns a boolean or a promise that resolves to a boolean.\",\n\t\t\t},\n\t\t)\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"Function to validate the client ID. If not provided, no validation will be performed.\",\n\t\t),\n\tonDeviceAuthRequest: z\n\t\t.custom<\n\t\t\t(clientId: string, scope: string | undefined) => void | Promise<void>\n\t\t>((val) => typeof val === \"function\", {\n\t\t\tmessage:\n\t\t\t\t\"onDeviceAuthRequest must be a function that returns void or a promise that resolves to void.\",\n\t\t})\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"Function to handle device authorization requests. If not provided, no additional actions will be taken.\",\n\t\t),\n\tverificationUri: z\n\t\t.string()\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"The URI where users verify their device code. Can be an absolute URL (https://example.com/device) or relative path (/custom-path). This will be returned as verification_uri in the device code response. If not provided, defaults to /device.\",\n\t\t),\n\tschema: z.custom<InferOptionSchema<typeof schema>>(() => true),\n});\n\nexport type DeviceAuthorizationOptions = z.infer<\n\ttypeof deviceAuthorizationOptionsSchema\n>;\n\nexport const deviceAuthorization = (\n\toptions: Partial<DeviceAuthorizationOptions> = {},\n) => {\n\tconst opts = deviceAuthorizationOptionsSchema.parse(options);\n\n\treturn {\n\t\tid: \"device-authorization\",\n\t\tschema: mergeSchema(schema, options?.schema),\n\t\tendpoints: {\n\t\t\tdeviceCode: deviceCode(opts),\n\t\t\tdeviceToken: deviceToken(opts),\n\t\t\tdeviceVerify,\n\t\t\tdeviceApprove,\n\t\t\tdeviceDeny,\n\t\t},\n\t\t$ERROR_CODES: DEVICE_AUTHORIZATION_ERROR_CODES,\n\t\toptions,\n\t} satisfies BetterAuthPlugin;\n};\n\nexport type * from \"../../utils/time\";\n", "import { base64Url } from \"@better-auth/utils/base64\";\nimport { createHash } from \"@better-auth/utils/hash\";\nexport const defaultKeyHasher = async (otp: string) => {\n\tconst hash = await createHash(\"SHA-256\").digest(\n\t\tnew TextEncoder().encode(otp),\n\t);\n\tconst hashed = base64Url.encode(new Uint8Array(hash), {\n\t\tpadding: false,\n\t});\n\treturn hashed;\n};\n\nexport function splitAtLastColon(input: string): [string, string] {\n\tconst idx = input.lastIndexOf(\":\");\n\tif (idx === -1) {\n\t\treturn [input, \"\"];\n\t}\n\treturn [input.slice(0, idx), input.slice(idx + 1)];\n}\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport {\n\tconstantTimeEqual,\n\tsymmetricDecrypt,\n\tsymmetricEncrypt,\n} from \"../../crypto\";\nimport type { EmailOTPOptions } from \"./types\";\nimport { defaultKeyHasher } from \"./utils\";\n\nexport async function storeOTP(\n\tctx: GenericEndpointContext,\n\topts: EmailOTPOptions,\n\totp: string,\n) {\n\tif (opts.storeOTP === \"encrypted\") {\n\t\treturn await symmetricEncrypt({\n\t\t\tkey: ctx.context.secret,\n\t\t\tdata: otp,\n\t\t});\n\t}\n\tif (opts.storeOTP === \"hashed\") {\n\t\treturn await defaultKeyHasher(otp);\n\t}\n\tif (typeof opts.storeOTP === \"object\" && \"hash\" in opts.storeOTP) {\n\t\treturn await opts.storeOTP.hash(otp);\n\t}\n\tif (typeof opts.storeOTP === \"object\" && \"encrypt\" in opts.storeOTP) {\n\t\treturn await opts.storeOTP.encrypt(otp);\n\t}\n\n\treturn otp;\n}\n\nexport async function verifyStoredOTP(\n\tctx: GenericEndpointContext,\n\topts: EmailOTPOptions,\n\tstoredOtp: string,\n\totp: string,\n): Promise<boolean> {\n\tif (opts.storeOTP === \"encrypted\") {\n\t\tconst decryptedOtp = await symmetricDecrypt({\n\t\t\tkey: ctx.context.secret,\n\t\t\tdata: storedOtp,\n\t\t});\n\t\treturn constantTimeEqual(decryptedOtp, otp);\n\t}\n\tif (opts.storeOTP === \"hashed\") {\n\t\tconst hashedOtp = await defaultKeyHasher(otp);\n\t\treturn constantTimeEqual(hashedOtp, storedOtp);\n\t}\n\tif (typeof opts.storeOTP === \"object\" && \"hash\" in opts.storeOTP) {\n\t\tconst hashedOtp = await opts.storeOTP.hash(otp);\n\t\treturn constantTimeEqual(hashedOtp, storedOtp);\n\t}\n\tif (typeof opts.storeOTP === \"object\" && \"decrypt\" in opts.storeOTP) {\n\t\tconst decryptedOtp = await opts.storeOTP.decrypt(storedOtp);\n\t\treturn constantTimeEqual(decryptedOtp, otp);\n\t}\n\n\treturn constantTimeEqual(otp, storedOtp);\n}\n", "import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { defineErrorCodes } from \"@better-auth/core/utils\";\nimport * as z from \"zod\";\nimport { APIError, getSessionFromCtx } from \"../../api\";\nimport { setCookieCache, setSessionCookie } from \"../../cookies\";\nimport { generateRandomString, symmetricDecrypt } from \"../../crypto\";\nimport { getDate } from \"../../utils/date\";\nimport { storeOTP, verifyStoredOTP } from \"./otp-token\";\nimport type { EmailOTPOptions } from \"./types\";\nimport { splitAtLastColon } from \"./utils\";\n\nconst types = [\"email-verification\", \"sign-in\", \"forget-password\"] as const;\n\ntype WithRequired<T, K extends keyof T> = T & { [P in K]-?: T[P] };\n\ntype RequiredEmailOTPOptions = WithRequired<\n\tEmailOTPOptions,\n\t\"expiresIn\" | \"generateOTP\" | \"storeOTP\"\n>;\n\nexport const ERROR_CODES = defineErrorCodes({\n\tOTP_EXPIRED: \"OTP expired\",\n\tINVALID_OTP: \"Invalid OTP\",\n\tTOO_MANY_ATTEMPTS: \"Too many attempts\",\n});\n\nconst sendVerificationOTPBodySchema = z.object({\n\temail: z.string({}).meta({\n\t\tdescription: \"Email address to send the OTP\",\n\t}),\n\ttype: z.enum(types).meta({\n\t\tdescription: \"Type of the OTP\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/email-otp/send-verification-otp`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.sendVerificationOTP`\n *\n * **client:**\n * `authClient.emailOtp.sendVerificationOtp`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/email-otp#api-method-email-otp-send-verification-otp)\n */\nexport const sendVerificationOTP = (opts: RequiredEmailOTPOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/email-otp/send-verification-otp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: sendVerificationOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"sendEmailVerificationOTP\",\n\t\t\t\t\tdescription: \"Send a verification OTP to an email\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (!opts?.sendVerificationOTP) {\n\t\t\t\tctx.context.logger.error(\"send email verification is not implemented\");\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"send email verification is not implemented\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst email = ctx.body.email.toLowerCase();\n\t\t\tconst isValidEmail = z.email().safeParse(email);\n\t\t\tif (!isValidEmail.success) {\n\t\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL,\n\t\t\t\t});\n\t\t\t}\n\t\t\tlet otp =\n\t\t\t\topts.generateOTP({ email, type: ctx.body.type }, ctx) ||\n\t\t\t\tdefaultOTPGenerator(opts);\n\n\t\t\tlet storedOTP = await storeOTP(ctx, opts, otp);\n\n\t\t\tawait ctx.context.internalAdapter\n\t\t\t\t.createVerificationValue({\n\t\t\t\t\tvalue: `${storedOTP}:0`,\n\t\t\t\t\tidentifier: `${ctx.body.type}-otp-${email}`,\n\t\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t\t})\n\t\t\t\t.catch(async (error) => {\n\t\t\t\t\t// might be duplicate key error\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationByIdentifier(\n\t\t\t\t\t\t`${ctx.body.type}-otp-${email}`,\n\t\t\t\t\t);\n\t\t\t\t\t//try again\n\t\t\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\t\t\tvalue: `${storedOTP}:0`,\n\t\t\t\t\t\tidentifier: `${ctx.body.type}-otp-${email}`,\n\t\t\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\tif (!user) {\n\t\t\t\tif (ctx.body.type === \"sign-in\" && !opts.disableSignUp) {\n\t\t\t\t\t// allow\n\t\t\t\t} else {\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationByIdentifier(\n\t\t\t\t\t\t`${ctx.body.type}-otp-${email}`,\n\t\t\t\t\t);\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\topts.sendVerificationOTP(\n\t\t\t\t\t{\n\t\t\t\t\t\temail,\n\t\t\t\t\t\totp,\n\t\t\t\t\t\ttype: ctx.body.type,\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t),\n\t\t\t);\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst createVerificationOTPBodySchema = z.object({\n\temail: z.string({}).meta({\n\t\tdescription: \"Email address to send the OTP\",\n\t}),\n\ttype: z.enum(types).meta({\n\t\trequired: true,\n\t\tdescription: \"Type of the OTP\",\n\t}),\n});\n\nexport const createVerificationOTP = (opts: RequiredEmailOTPOptions) =>\n\tcreateAuthEndpoint(\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: createVerificationOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"createEmailVerificationOTP\",\n\t\t\t\t\tdescription: \"Create a verification OTP for an email\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst email = ctx.body.email.toLowerCase();\n\t\t\tconst otp =\n\t\t\t\topts.generateOTP({ email, type: ctx.body.type }, ctx) ||\n\t\t\t\tdefaultOTPGenerator(opts);\n\t\t\tlet storedOTP = await storeOTP(ctx, opts, otp);\n\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\tvalue: `${storedOTP}:0`,\n\t\t\t\tidentifier: `${ctx.body.type}-otp-${email}`,\n\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t});\n\t\t\treturn otp;\n\t\t},\n\t);\n\nconst getVerificationOTPBodySchema = z.object({\n\temail: z.string({}).meta({\n\t\tdescription: \"Email address the OTP was sent to\",\n\t}),\n\ttype: z.enum(types).meta({\n\t\trequired: true,\n\t\tdescription: \"Type of the OTP\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * GET `/email-otp/get-verification-otp`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.getVerificationOTP`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/email-otp#api-method-email-otp-get-verification-otp)\n */\nexport const getVerificationOTP = (opts: RequiredEmailOTPOptions) =>\n\tcreateAuthEndpoint(\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: getVerificationOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"getEmailVerificationOTP\",\n\t\t\t\t\tdescription: \"Get a verification OTP for an email\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"OTP retrieved successfully or not found/expired\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\totp: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The stored OTP, or null if not found or expired\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"otp\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst email = ctx.query.email.toLowerCase();\n\t\t\tconst verificationValue =\n\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t`${ctx.query.type}-otp-${email}`,\n\t\t\t\t);\n\t\t\tif (!verificationValue || verificationValue.expiresAt < new Date()) {\n\t\t\t\treturn ctx.json({\n\t\t\t\t\totp: null,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (\n\t\t\t\topts.storeOTP === \"hashed\" ||\n\t\t\t\t(typeof opts.storeOTP === \"object\" && \"hash\" in opts.storeOTP)\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"OTP is hashed, cannot return the plain text OTP\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet [storedOtp, _attempts] = splitAtLastColon(verificationValue.value);\n\t\t\tlet otp = storedOtp;\n\t\t\tif (opts.storeOTP === \"encrypted\") {\n\t\t\t\totp = await symmetricDecrypt({\n\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\tdata: storedOtp,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (typeof opts.storeOTP === \"object\" && \"decrypt\" in opts.storeOTP) {\n\t\t\t\totp = await opts.storeOTP.decrypt(storedOtp);\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\totp,\n\t\t\t});\n\t\t},\n\t);\n\nconst checkVerificationOTPBodySchema = z.object({\n\temail: z.string().meta({\n\t\tdescription: \"Email address the OTP was sent to\",\n\t}),\n\ttype: z.enum(types).meta({\n\t\trequired: true,\n\t\tdescription: \"Type of the OTP\",\n\t}),\n\totp: z.string().meta({\n\t\trequired: true,\n\t\tdescription: \"OTP to verify\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * GET `/email-otp/check-verification-otp`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.checkVerificationOTP`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/email-otp#api-method-email-otp-check-verification-otp)\n */\nexport const checkVerificationOTP = (opts: RequiredEmailOTPOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/email-otp/check-verification-otp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: checkVerificationOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"verifyEmailWithOTP\",\n\t\t\t\t\tdescription: \"Verify an email with an OTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst email = ctx.body.email.toLowerCase();\n\t\t\tconst isValidEmail = z.email().safeParse(email);\n\t\t\tif (!isValidEmail.success) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst verificationValue =\n\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t`${ctx.body.type}-otp-${email}`,\n\t\t\t\t);\n\t\t\tif (!verificationValue) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (verificationValue.expiresAt < new Date()) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.OTP_EXPIRED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst [otpValue, attempts] = splitAtLastColon(verificationValue.value);\n\t\t\tconst allowedAttempts = opts?.allowedAttempts || 3;\n\t\t\tif (attempts && parseInt(attempts) >= allowedAttempts) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ERROR_CODES.TOO_MANY_ATTEMPTS,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst verified = await verifyStoredOTP(ctx, opts, otpValue, ctx.body.otp);\n\t\t\tif (!verified) {\n\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: `${otpValue}:${parseInt(attempts || \"0\") + 1}`,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst verifyEmailOTPBodySchema = z.object({\n\temail: z.string({}).meta({\n\t\tdescription: \"Email address to verify\",\n\t}),\n\totp: z.string().meta({\n\t\trequired: true,\n\t\tdescription: \"OTP to verify\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/email-otp/verify-email`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.verifyEmailOTP`\n *\n * **client:**\n * `authClient.emailOtp.verifyEmail`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/email-otp#api-method-email-otp-verify-email)\n */\nexport const verifyEmailOTP = (opts: RequiredEmailOTPOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/email-otp/verify-email\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: verifyEmailOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Verify email with OTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the verification was successful\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Session token if autoSignInAfterVerification is enabled, otherwise null\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"status\", \"token\", \"user\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst email = ctx.body.email.toLowerCase();\n\t\t\tconst isValidEmail = z.email().safeParse(email);\n\t\t\tif (!isValidEmail.success) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst verificationValue =\n\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t`email-verification-otp-${email}`,\n\t\t\t\t);\n\n\t\t\tif (!verificationValue) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (verificationValue.expiresAt < new Date()) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.OTP_EXPIRED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst [otpValue, attempts] = splitAtLastColon(verificationValue.value);\n\t\t\tconst allowedAttempts = opts?.allowedAttempts || 3;\n\t\t\tif (attempts && parseInt(attempts) >= allowedAttempts) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ERROR_CODES.TOO_MANY_ATTEMPTS,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst verified = await verifyStoredOTP(ctx, opts, otpValue, ctx.body.otp);\n\t\t\tif (!verified) {\n\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: `${otpValue}:${parseInt(attempts || \"0\") + 1}`,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\tverificationValue.id,\n\t\t\t);\n\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\tif (!user) {\n\t\t\t\t/**\n\t\t\t\t * safe to leak the existence of a user, given the user has already the OTP from the\n\t\t\t\t * email\n\t\t\t\t */\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst updatedUser = await ctx.context.internalAdapter.updateUser(\n\t\t\t\tuser.user.id,\n\t\t\t\t{\n\t\t\t\t\temail,\n\t\t\t\t\temailVerified: true,\n\t\t\t\t},\n\t\t\t);\n\t\t\tawait ctx.context.options.emailVerification?.onEmailVerification?.(\n\t\t\t\tupdatedUser,\n\t\t\t\tctx.request,\n\t\t\t);\n\n\t\t\tif (ctx.context.options.emailVerification?.autoSignInAfterVerification) {\n\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\tupdatedUser.id,\n\t\t\t\t);\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession,\n\t\t\t\t\tuser: updatedUser,\n\t\t\t\t});\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t\ttoken: session.token,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tid: updatedUser.id,\n\t\t\t\t\t\temail: updatedUser.email,\n\t\t\t\t\t\temailVerified: updatedUser.emailVerified,\n\t\t\t\t\t\tname: updatedUser.name,\n\t\t\t\t\t\timage: updatedUser.image,\n\t\t\t\t\t\tcreatedAt: updatedUser.createdAt,\n\t\t\t\t\t\tupdatedAt: updatedUser.updatedAt,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst currentSession = await getSessionFromCtx(ctx);\n\t\t\tif (currentSession && updatedUser.emailVerified) {\n\t\t\t\tconst dontRememberMeCookie = await ctx.getSignedCookie(\n\t\t\t\t\tctx.context.authCookies.dontRememberToken.name,\n\t\t\t\t\tctx.context.secret,\n\t\t\t\t);\n\t\t\t\tawait setCookieCache(\n\t\t\t\t\tctx,\n\t\t\t\t\t{\n\t\t\t\t\t\tsession: currentSession.session,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t...currentSession.user,\n\t\t\t\t\t\t\temailVerified: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t!!dontRememberMeCookie,\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t\ttoken: null,\n\t\t\t\tuser: {\n\t\t\t\t\tid: updatedUser.id,\n\t\t\t\t\temail: updatedUser.email,\n\t\t\t\t\temailVerified: updatedUser.emailVerified,\n\t\t\t\t\tname: updatedUser.name,\n\t\t\t\t\timage: updatedUser.image,\n\t\t\t\t\tcreatedAt: updatedUser.createdAt,\n\t\t\t\t\tupdatedAt: updatedUser.updatedAt,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t);\n\nconst signInEmailOTPBodySchema = z.object({\n\temail: z.string({}).meta({\n\t\tdescription: \"Email address to sign in\",\n\t}),\n\totp: z.string().meta({\n\t\trequired: true,\n\t\tdescription: \"OTP sent to the email\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/sign-in/email-otp`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.signInEmailOTP`\n *\n * **client:**\n * `authClient.signIn.emailOtp`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/email-otp#api-method-sign-in-email-otp)\n */\nexport const signInEmailOTP = (opts: RequiredEmailOTPOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/sign-in/email-otp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: signInEmailOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"signInWithEmailOTP\",\n\t\t\t\t\tdescription: \"Sign in with email and OTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Session token for the authenticated session\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"token\", \"user\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst email = ctx.body.email.toLowerCase();\n\t\t\tconst verificationValue =\n\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t`sign-in-otp-${email}`,\n\t\t\t\t);\n\t\t\tif (!verificationValue) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (verificationValue.expiresAt < new Date()) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.OTP_EXPIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst [otpValue, attempts] = splitAtLastColon(verificationValue.value);\n\t\t\tconst allowedAttempts = opts?.allowedAttempts || 3;\n\t\t\tif (attempts && parseInt(attempts) >= allowedAttempts) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ERROR_CODES.TOO_MANY_ATTEMPTS,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst verified = await verifyStoredOTP(ctx, opts, otpValue, ctx.body.otp);\n\t\t\tif (!verified) {\n\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: `${otpValue}:${parseInt(attempts || \"0\") + 1}`,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\tverificationValue.id,\n\t\t\t);\n\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\tif (!user) {\n\t\t\t\tif (opts.disableSignUp) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst newUser = await ctx.context.internalAdapter.createUser({\n\t\t\t\t\temail,\n\t\t\t\t\temailVerified: true,\n\t\t\t\t\tname: \"\",\n\t\t\t\t});\n\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\tnewUser.id,\n\t\t\t\t);\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession,\n\t\t\t\t\tuser: newUser,\n\t\t\t\t});\n\t\t\t\treturn ctx.json({\n\t\t\t\t\ttoken: session.token,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tid: newUser.id,\n\t\t\t\t\t\temail: newUser.email,\n\t\t\t\t\t\temailVerified: newUser.emailVerified,\n\t\t\t\t\t\tname: newUser.name,\n\t\t\t\t\t\timage: newUser.image,\n\t\t\t\t\t\tcreatedAt: newUser.createdAt,\n\t\t\t\t\t\tupdatedAt: newUser.updatedAt,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (!user.user.emailVerified) {\n\t\t\t\tawait ctx.context.internalAdapter.updateUser(user.user.id, {\n\t\t\t\t\temailVerified: true,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\tuser.user.id,\n\t\t\t);\n\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\tsession,\n\t\t\t\tuser: user.user,\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\ttoken: session.token,\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.user.id,\n\t\t\t\t\temail: user.user.email,\n\t\t\t\t\temailVerified: user.user.emailVerified,\n\t\t\t\t\tname: user.user.name,\n\t\t\t\t\timage: user.user.image,\n\t\t\t\t\tcreatedAt: user.user.createdAt,\n\t\t\t\t\tupdatedAt: user.user.updatedAt,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t);\n\nconst forgetPasswordEmailOTPBodySchema = z.object({\n\temail: z.string().meta({\n\t\tdescription: \"Email address to send the OTP\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/forget-password/email-otp`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.forgetPasswordEmailOTP`\n *\n * **client:**\n * `authClient.forgetPassword.emailOtp`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/email-otp#api-method-forget-password-email-otp)\n */\nexport const forgetPasswordEmailOTP = (opts: RequiredEmailOTPOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/forget-password/email-otp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: forgetPasswordEmailOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"forgetPasswordWithEmailOTP\",\n\t\t\t\t\tdescription: \"Forget password with email and OTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the OTP was sent successfully\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst email = ctx.body.email;\n\t\t\tconst otp =\n\t\t\t\topts.generateOTP({ email, type: \"forget-password\" }, ctx) ||\n\t\t\t\tdefaultOTPGenerator(opts);\n\t\t\tlet storedOTP = await storeOTP(ctx, opts, otp);\n\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\tvalue: `${storedOTP}:0`,\n\t\t\t\tidentifier: `forget-password-otp-${email}`,\n\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t});\n\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\tif (!user) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationByIdentifier(\n\t\t\t\t\t`forget-password-otp-${email}`,\n\t\t\t\t);\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tsuccess: true,\n\t\t\t\t});\n\t\t\t}\n\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\topts.sendVerificationOTP(\n\t\t\t\t\t{\n\t\t\t\t\t\temail,\n\t\t\t\t\t\totp,\n\t\t\t\t\t\ttype: \"forget-password\",\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t),\n\t\t\t);\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst resetPasswordEmailOTPBodySchema = z.object({\n\temail: z.string().meta({\n\t\tdescription: \"Email address to reset the password\",\n\t}),\n\totp: z.string().meta({\n\t\tdescription: \"OTP sent to the email\",\n\t}),\n\tpassword: z.string().meta({\n\t\tdescription: \"New password\",\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/email-otp/reset-password`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.resetPasswordEmailOTP`\n *\n * **client:**\n * `authClient.emailOtp.resetPassword`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/email-otp#api-method-email-otp-reset-password)\n */\nexport const resetPasswordEmailOTP = (opts: RequiredEmailOTPOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/email-otp/reset-password\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: resetPasswordEmailOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"resetPasswordWithEmailOTP\",\n\t\t\t\t\tdescription: \"Reset password with email and OTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontnt: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst email = ctx.body.email;\n\t\t\tconst verificationValue =\n\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t`forget-password-otp-${email}`,\n\t\t\t\t);\n\t\t\tif (!verificationValue) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (verificationValue.expiresAt < new Date()) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.OTP_EXPIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst [otpValue, attempts] = splitAtLastColon(verificationValue.value);\n\t\t\tconst allowedAttempts = opts?.allowedAttempts || 3;\n\t\t\tif (attempts && parseInt(attempts) >= allowedAttempts) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ERROR_CODES.TOO_MANY_ATTEMPTS,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst verified = await verifyStoredOTP(ctx, opts, otpValue, ctx.body.otp);\n\t\t\tif (!verified) {\n\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(\n\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: `${otpValue}:${parseInt(attempts || \"0\") + 1}`,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\tverificationValue.id,\n\t\t\t);\n\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email, {\n\t\t\t\tincludeAccounts: true,\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst minPasswordLength = ctx.context.password.config.minPasswordLength;\n\t\t\tif (ctx.body.password.length < minPasswordLength) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_SHORT,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst maxPasswordLength = ctx.context.password.config.maxPasswordLength;\n\t\t\tif (ctx.body.password.length > maxPasswordLength) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_LONG,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst passwordHash = await ctx.context.password.hash(ctx.body.password);\n\t\t\tlet account = user.accounts?.find(\n\t\t\t\t(account) => account.providerId === \"credential\",\n\t\t\t);\n\t\t\tif (!account) {\n\t\t\t\tawait ctx.context.internalAdapter.createAccount({\n\t\t\t\t\tuserId: user.user.id,\n\t\t\t\t\tproviderId: \"credential\",\n\t\t\t\t\taccountId: user.user.id,\n\t\t\t\t\tpassword: passwordHash,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tawait ctx.context.internalAdapter.updatePassword(\n\t\t\t\t\tuser.user.id,\n\t\t\t\t\tpasswordHash,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (ctx.context.options.emailAndPassword?.onPasswordReset) {\n\t\t\t\tawait ctx.context.options.emailAndPassword.onPasswordReset(\n\t\t\t\t\t{\n\t\t\t\t\t\tuser: user.user,\n\t\t\t\t\t},\n\t\t\t\t\tctx.request,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (!user.user.emailVerified) {\n\t\t\t\tawait ctx.context.internalAdapter.updateUser(user.user.id, {\n\t\t\t\t\temailVerified: true,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (ctx.context.options.emailAndPassword?.revokeSessionsOnPasswordReset) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteSessions(user.user.id);\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst defaultOTPGenerator = (options: EmailOTPOptions) =>\n\tgenerateRandomString(options.otpLength ?? 6, \"0-9\");\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { createAuthMiddleware } from \"@better-auth/core/api\";\nimport { generateRandomString } from \"../../crypto\";\nimport { getDate } from \"../../utils/date\";\nimport { getEndpointResponse } from \"../../utils/plugin-helper\";\nimport { storeOTP } from \"./otp-token\";\nimport {\n\tcheckVerificationOTP,\n\tcreateVerificationOTP,\n\tERROR_CODES,\n\tforgetPasswordEmailOTP,\n\tgetVerificationOTP,\n\tresetPasswordEmailOTP,\n\tsendVerificationOTP,\n\tsignInEmailOTP,\n\tverifyEmailOTP,\n} from \"./routes\";\nimport type { EmailOTPOptions } from \"./types\";\n\nexport type { EmailOTPOptions } from \"./types\";\n\nconst defaultOTPGenerator = (options: EmailOTPOptions) =>\n\tgenerateRandomString(options.otpLength ?? 6, \"0-9\");\n\nexport const emailOTP = (options: EmailOTPOptions) => {\n\tconst opts = {\n\t\texpiresIn: 5 * 60,\n\t\tgenerateOTP: () => defaultOTPGenerator(options),\n\t\tstoreOTP: \"plain\",\n\t\t...options,\n\t} satisfies EmailOTPOptions;\n\n\tconst sendVerificationOTPAction = sendVerificationOTP(opts);\n\n\treturn {\n\t\tid: \"email-otp\",\n\t\tinit(ctx) {\n\t\t\tif (!opts.overrideDefaultEmailVerification) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\toptions: {\n\t\t\t\t\temailVerification: {\n\t\t\t\t\t\tasync sendVerificationEmail(data, request) {\n\t\t\t\t\t\t\tawait ctx.runInBackgroundOrAwait(\n\t\t\t\t\t\t\t\tsendVerificationOTPAction({\n\t\t\t\t\t\t\t\t\t//@ts-expect-error - we need to pass the context\n\t\t\t\t\t\t\t\t\tcontext: ctx,\n\t\t\t\t\t\t\t\t\trequest: request,\n\t\t\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\t\t\temail: data.user.email,\n\t\t\t\t\t\t\t\t\t\ttype: \"email-verification\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tendpoints: {\n\t\t\tsendVerificationOTP: sendVerificationOTPAction,\n\t\t\tcreateVerificationOTP: createVerificationOTP(opts),\n\t\t\tgetVerificationOTP: getVerificationOTP(opts),\n\t\t\tcheckVerificationOTP: checkVerificationOTP(opts),\n\t\t\tverifyEmailOTP: verifyEmailOTP(opts),\n\t\t\tsignInEmailOTP: signInEmailOTP(opts),\n\t\t\tforgetPasswordEmailOTP: forgetPasswordEmailOTP(opts),\n\t\t\tresetPasswordEmailOTP: resetPasswordEmailOTP(opts),\n\t\t},\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn !!(\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/sign-up\") &&\n\t\t\t\t\t\t\topts.sendVerificationOnSignUp &&\n\t\t\t\t\t\t\t!opts.overrideDefaultEmailVerification\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst response = await getEndpointResponse<{\n\t\t\t\t\t\t\tuser: { email: string };\n\t\t\t\t\t\t}>(ctx);\n\t\t\t\t\t\tconst email = response?.user.email;\n\t\t\t\t\t\tif (email) {\n\t\t\t\t\t\t\tconst otp =\n\t\t\t\t\t\t\t\topts.generateOTP({ email, type: ctx.body.type }, ctx) ||\n\t\t\t\t\t\t\t\tdefaultOTPGenerator(opts);\n\t\t\t\t\t\t\tlet storedOTP = await storeOTP(ctx, opts, otp);\n\t\t\t\t\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\t\t\t\t\tvalue: `${storedOTP}:0`,\n\t\t\t\t\t\t\t\tidentifier: `email-verification-otp-${email}`,\n\t\t\t\t\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\t\t\toptions.sendVerificationOTP(\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\temail,\n\t\t\t\t\t\t\t\t\t\totp,\n\t\t\t\t\t\t\t\t\t\ttype: \"email-verification\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\t$ERROR_CODES: ERROR_CODES,\n\t\trateLimit: [\n\t\t\t{\n\t\t\t\tpathMatcher(path) {\n\t\t\t\t\treturn path === \"/email-otp/send-verification-otp\";\n\t\t\t\t},\n\t\t\t\twindow: 60,\n\t\t\t\tmax: 3,\n\t\t\t},\n\t\t\t{\n\t\t\t\tpathMatcher(path) {\n\t\t\t\t\treturn path === \"/email-otp/check-verification-otp\";\n\t\t\t\t},\n\t\t\t\twindow: 60,\n\t\t\t\tmax: 3,\n\t\t\t},\n\t\t\t{\n\t\t\t\tpathMatcher(path) {\n\t\t\t\t\treturn path === \"/email-otp/verify-email\";\n\t\t\t\t},\n\t\t\t\twindow: 60,\n\t\t\t\tmax: 3,\n\t\t\t},\n\t\t\t{\n\t\t\t\tpathMatcher(path) {\n\t\t\t\t\treturn path === \"/sign-in/email-otp\";\n\t\t\t\t},\n\t\t\t\twindow: 60,\n\t\t\t\tmax: 3,\n\t\t\t},\n\t\t],\n\t\toptions,\n\t} satisfies BetterAuthPlugin;\n};\n", "import type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport type { BaseOAuthProviderOptions, GenericOAuthConfig } from \"../index\";\n\nexport interface Auth0Options extends BaseOAuthProviderOptions {\n\t/**\n\t * Auth0 domain (e.g., dev-xxx.eu.auth0.com)\n\t * This will be used to construct the discovery URL.\n\t */\n\tdomain: string;\n}\n\ninterface Auth0Profile {\n\tsub: string;\n\tname?: string;\n\temail?: string;\n\temail_verified?: boolean;\n\tpicture?: string;\n\tnickname?: string;\n\tgiven_name?: string;\n\tfamily_name?: string;\n}\n\n/**\n * Auth0 OAuth provider helper\n *\n * @example\n * ```ts\n * import { genericOAuth, auth0 } from \"better-auth/plugins/generic-oauth\";\n *\n * export const auth = betterAuth({\n *   plugins: [\n *     genericOAuth({\n *       config: [\n *         auth0({\n *           clientId: process.env.AUTH0_CLIENT_ID,\n *           clientSecret: process.env.AUTH0_CLIENT_SECRET,\n *           domain: process.env.AUTH0_DOMAIN,\n *         }),\n *       ],\n *     }),\n *   ],\n * });\n * ```\n */\nexport function auth0(options: Auth0Options): GenericOAuthConfig {\n\tconst defaultScopes = [\"openid\", \"profile\", \"email\"];\n\n\t// Ensure domain doesn't have protocol prefix\n\tconst domain = options.domain.replace(/^https?:\\/\\//, \"\");\n\tconst discoveryUrl = `https://${domain}/.well-known/openid-configuration`;\n\n\tconst getUserInfo = async (\n\t\ttokens: OAuth2Tokens,\n\t): Promise<OAuth2UserInfo | null> => {\n\t\tconst userInfoUrl = `https://${domain}/userinfo`;\n\n\t\tconst { data: profile, error } = await betterFetch<Auth0Profile>(\n\t\t\tuserInfoUrl,\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (error || !profile) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tid: profile.sub,\n\t\t\tname: profile.name ?? profile.nickname ?? undefined,\n\t\t\temail: profile.email ?? undefined,\n\t\t\timage: profile.picture,\n\t\t\temailVerified: profile.email_verified ?? false,\n\t\t};\n\t};\n\n\treturn {\n\t\tproviderId: \"auth0\",\n\t\tdiscoveryUrl,\n\t\tclientId: options.clientId,\n\t\tclientSecret: options.clientSecret,\n\t\tscopes: options.scopes ?? defaultScopes,\n\t\tredirectURI: options.redirectURI,\n\t\tpkce: options.pkce,\n\t\tdisableImplicitSignUp: options.disableImplicitSignUp,\n\t\tdisableSignUp: options.disableSignUp,\n\t\toverrideUserInfo: options.overrideUserInfo,\n\t\tgetUserInfo,\n\t};\n}\n", "import type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport type { BaseOAuthProviderOptions, GenericOAuthConfig } from \"../index\";\n\nexport interface HubSpotOptions extends BaseOAuthProviderOptions {\n\t/**\n\t * OAuth scopes to request.\n\t * @default [\"oauth\"]\n\t */\n\tscopes?: string[];\n}\n\n/**\n * HubSpot access token information response.\n * Based on: https://legacydocs.hubspot.com/docs/methods/oauth2/get-access-token-information\n *\n * The API may return additional fields, but we only use the fields needed for user identification.\n */\ninterface HubSpotProfile extends Record<string, any> {\n\tuser: string;\n\tuser_id: string;\n\thub_domain: string;\n\thub_id: string;\n\tsigned_access_token?: {\n\t\tuserId?: string;\n\t\t[key: string]: any;\n\t};\n}\n\n/**\n * HubSpot OAuth provider helper\n *\n * @example\n * ```ts\n * import { genericOAuth, hubspot } from \"better-auth/plugins/generic-oauth\";\n *\n * export const auth = betterAuth({\n *   plugins: [\n *     genericOAuth({\n *       config: [\n *         hubspot({\n *           clientId: process.env.HUBSPOT_CLIENT_ID,\n *           clientSecret: process.env.HUBSPOT_CLIENT_SECRET,\n *           scopes: [\"oauth\", \"contacts\"],\n *         }),\n *       ],\n *     }),\n *   ],\n * });\n * ```\n */\nexport function hubspot(options: HubSpotOptions): GenericOAuthConfig {\n\tconst defaultScopes = [\"oauth\"];\n\n\tconst getUserInfo = async (\n\t\ttokens: OAuth2Tokens,\n\t): Promise<OAuth2UserInfo | null> => {\n\t\tconst tokenInfoUrl = `https://api.hubapi.com/oauth/v1/access-tokens/${tokens.accessToken}`;\n\n\t\tconst { data: profile, error } = await betterFetch<HubSpotProfile>(\n\t\t\ttokenInfoUrl,\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (error || !profile) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Note: HubSpot's OAuth API only returns the email address in the 'user' field.\n\t\t// It does NOT provide a display name or profile picture. This is a known limitation.\n\t\t// See: https://community.hubspot.com/t5/APIs-Integrations/Profile-photo-is-not-retrieved-with-User-API/m-p/325521\n\t\tconst id = profile.user_id ?? profile.signed_access_token?.userId;\n\n\t\tif (!id) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tid,\n\t\t\tname: profile.user,\n\t\t\temail: profile.user,\n\t\t\timage: undefined,\n\t\t\temailVerified: false,\n\t\t};\n\t};\n\n\treturn {\n\t\tproviderId: \"hubspot\",\n\t\tauthorizationUrl: \"https://app.hubspot.com/oauth/authorize\",\n\t\ttokenUrl: \"https://api.hubapi.com/oauth/v1/token\",\n\t\tclientId: options.clientId,\n\t\tclientSecret: options.clientSecret,\n\t\tscopes: options.scopes ?? defaultScopes,\n\t\tredirectURI: options.redirectURI,\n\t\tauthentication: \"post\",\n\t\tpkce: options.pkce,\n\t\tdisableImplicitSignUp: options.disableImplicitSignUp,\n\t\tdisableSignUp: options.disableSignUp,\n\t\toverrideUserInfo: options.overrideUserInfo,\n\t\tgetUserInfo,\n\t};\n}\n", "import type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport type { BaseOAuthProviderOptions, GenericOAuthConfig } from \"../index\";\n\nexport interface KeycloakOptions extends BaseOAuthProviderOptions {\n\t/**\n\t * Keycloak issuer URL (includes realm, e.g., https://my-domain/realms/MyRealm)\n\t * This will be used to construct the discovery URL.\n\t */\n\tissuer: string;\n}\n\ninterface KeycloakProfile {\n\tsub: string;\n\tname?: string;\n\temail?: string;\n\temail_verified?: boolean;\n\tpicture?: string;\n\tpreferred_username?: string;\n\tgiven_name?: string;\n\tfamily_name?: string;\n}\n\n/**\n * Keycloak OAuth provider helper\n *\n * @example\n * ```ts\n * import { genericOAuth, keycloak } from \"better-auth/plugins/generic-oauth\";\n *\n * export const auth = betterAuth({\n *   plugins: [\n *     genericOAuth({\n *       config: [\n *         keycloak({\n *           clientId: process.env.KEYCLOAK_CLIENT_ID,\n *           clientSecret: process.env.KEYCLOAK_CLIENT_SECRET,\n *           issuer: process.env.KEYCLOAK_ISSUER,\n *         }),\n *       ],\n *     }),\n *   ],\n * });\n * ```\n */\nexport function keycloak(options: KeycloakOptions): GenericOAuthConfig {\n\tconst defaultScopes = [\"openid\", \"profile\", \"email\"];\n\n\t// Ensure issuer ends without trailing slash for proper discovery URL construction\n\tconst issuer = options.issuer.replace(/\\/$/, \"\");\n\tconst discoveryUrl = `${issuer}/.well-known/openid-configuration`;\n\n\tconst getUserInfo = async (\n\t\ttokens: OAuth2Tokens,\n\t): Promise<OAuth2UserInfo | null> => {\n\t\t// Construct userinfo URL from issuer\n\t\tconst userInfoUrl = `${issuer}/protocol/openid-connect/userinfo`;\n\n\t\tconst { data: profile, error } = await betterFetch<KeycloakProfile>(\n\t\t\tuserInfoUrl,\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (error || !profile) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tid: profile.sub,\n\t\t\tname: profile.name ?? profile.preferred_username ?? undefined,\n\t\t\temail: profile.email ?? undefined,\n\t\t\timage: profile.picture,\n\t\t\t// Keycloak provides email_verified per OIDC standard, but availability depends on configuration.\n\t\t\t// We default to false when not provided or not configured.\n\t\t\temailVerified: profile.email_verified ?? false,\n\t\t};\n\t};\n\n\treturn {\n\t\tproviderId: \"keycloak\",\n\t\tdiscoveryUrl,\n\t\tclientId: options.clientId,\n\t\tclientSecret: options.clientSecret,\n\t\tscopes: options.scopes ?? defaultScopes,\n\t\tredirectURI: options.redirectURI,\n\t\tpkce: options.pkce,\n\t\tdisableImplicitSignUp: options.disableImplicitSignUp,\n\t\tdisableSignUp: options.disableSignUp,\n\t\toverrideUserInfo: options.overrideUserInfo,\n\t\tgetUserInfo,\n\t};\n}\n", "import type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport { decodeJwt } from \"jose\";\nimport type { BaseOAuthProviderOptions, GenericOAuthConfig } from \"../index\";\n\nexport interface LineOptions extends BaseOAuthProviderOptions {\n\t/**\n\t * Unique provider identifier for this LINE channel.\n\t * Use different providerIds for different countries/channels (e.g., \"line-jp\", \"line-th\", \"line-tw\").\n\t * @default \"line\"\n\t */\n\tproviderId?: string;\n}\n\ninterface LineIdTokenPayload {\n\tiss: string;\n\tsub: string;\n\taud: string;\n\texp: number;\n\tiat: number;\n\tname?: string;\n\tpicture?: string;\n\temail?: string;\n\tamr?: string[];\n\tnonce?: string;\n}\n\ninterface LineUserInfo {\n\tsub: string;\n\tname?: string;\n\tpicture?: string;\n\temail?: string;\n}\n\n/**\n * LINE OAuth provider helper\n *\n * LINE requires separate channels for different countries (Japan, Thailand, Taiwan, etc.).\n * Each channel has its own clientId and clientSecret. To support multiple countries,\n * call this function multiple times with different providerIds and credentials.\n *\n * @example\n * ```ts\n * import { genericOAuth, line } from \"better-auth/plugins/generic-oauth\";\n *\n * export const auth = betterAuth({\n *   plugins: [\n *     genericOAuth({\n *       config: [\n *         // Japan channel\n *         line({\n *           providerId: \"line-jp\",\n *           clientId: process.env.LINE_JP_CLIENT_ID,\n *           clientSecret: process.env.LINE_JP_CLIENT_SECRET,\n *         }),\n *         // Thailand channel\n *         line({\n *           providerId: \"line-th\",\n *           clientId: process.env.LINE_TH_CLIENT_ID,\n *           clientSecret: process.env.LINE_TH_CLIENT_SECRET,\n *         }),\n *         // Taiwan channel\n *         line({\n *           providerId: \"line-tw\",\n *           clientId: process.env.LINE_TW_CLIENT_ID,\n *           clientSecret: process.env.LINE_TW_CLIENT_SECRET,\n *         }),\n *       ],\n *     }),\n *   ],\n * });\n * ```\n */\nexport function line(options: LineOptions): GenericOAuthConfig {\n\tconst defaultScopes = [\"openid\", \"profile\", \"email\"];\n\tconst authorizationUrl = \"https://access.line.me/oauth2/v2.1/authorize\";\n\tconst tokenUrl = \"https://api.line.me/oauth2/v2.1/token\";\n\tconst userInfoUrl = \"https://api.line.me/oauth2/v2.1/userinfo\";\n\n\tconst getUserInfo = async (\n\t\ttokens: OAuth2Tokens,\n\t): Promise<OAuth2UserInfo | null> => {\n\t\tlet profile: LineUserInfo | LineIdTokenPayload | null = null;\n\n\t\tif (tokens.idToken) {\n\t\t\ttry {\n\t\t\t\tprofile = decodeJwt(tokens.idToken) as LineIdTokenPayload;\n\t\t\t} catch {\n\t\t\t\t// If ID token decoding fails, fall back to UserInfo endpoint\n\t\t\t}\n\t\t}\n\n\t\tif (!profile) {\n\t\t\tconst { data, error } = await betterFetch<LineUserInfo>(userInfoUrl, {\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (error || !data) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tprofile = data;\n\t\t}\n\n\t\tif (!profile) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tid: profile.sub,\n\t\t\tname: profile.name,\n\t\t\temail: profile.email,\n\t\t\timage: profile.picture,\n\t\t\temailVerified: false,\n\t\t};\n\t};\n\n\treturn {\n\t\tproviderId: options.providerId ?? \"line\",\n\t\tauthorizationUrl,\n\t\ttokenUrl,\n\t\tuserInfoUrl,\n\t\tclientId: options.clientId,\n\t\tclientSecret: options.clientSecret,\n\t\tscopes: options.scopes ?? defaultScopes,\n\t\tredirectURI: options.redirectURI,\n\t\tpkce: options.pkce,\n\t\tdisableImplicitSignUp: options.disableImplicitSignUp,\n\t\tdisableSignUp: options.disableSignUp,\n\t\toverrideUserInfo: options.overrideUserInfo,\n\t\tgetUserInfo,\n\t};\n}\n", "import type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport type { BaseOAuthProviderOptions, GenericOAuthConfig } from \"../index\";\n\nexport interface MicrosoftEntraIdOptions extends BaseOAuthProviderOptions {\n\t/**\n\t * Microsoft Entra ID tenant ID.\n\t * Can be a GUID, \"common\", \"organizations\", or \"consumers\"\n\t */\n\ttenantId: string;\n}\n\ninterface MicrosoftEntraIdProfile {\n\tsub: string;\n\tname?: string;\n\temail?: string;\n\tpreferred_username?: string;\n\tpicture?: string;\n\tgiven_name?: string;\n\tfamily_name?: string;\n\temail_verified?: boolean;\n}\n\n/**\n * Microsoft Entra ID (Azure AD) OAuth provider helper\n *\n * @example\n * ```ts\n * import { genericOAuth, microsoftEntraId } from \"better-auth/plugins/generic-oauth\";\n *\n * export const auth = betterAuth({\n *   plugins: [\n *     genericOAuth({\n *       config: [\n *         microsoftEntraId({\n *           clientId: process.env.MS_APP_ID,\n *           clientSecret: process.env.MS_CLIENT_SECRET,\n *           tenantId: process.env.MS_TENANT_ID,\n *         }),\n *       ],\n *     }),\n *   ],\n * });\n * ```\n */\nexport function microsoftEntraId(\n\toptions: MicrosoftEntraIdOptions,\n): GenericOAuthConfig {\n\tconst defaultScopes = [\"openid\", \"profile\", \"email\"];\n\n\tconst tenantId = options.tenantId;\n\tconst authorizationUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/authorize`;\n\tconst tokenUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`;\n\tconst userInfoUrl = \"https://graph.microsoft.com/oidc/userinfo\";\n\n\tconst getUserInfo = async (\n\t\ttokens: OAuth2Tokens,\n\t): Promise<OAuth2UserInfo | null> => {\n\t\tconst { data: profile, error } = await betterFetch<MicrosoftEntraIdProfile>(\n\t\t\tuserInfoUrl,\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (error || !profile) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tid: profile.sub,\n\t\t\tname:\n\t\t\t\tprofile.name ??\n\t\t\t\t(`${profile.given_name ?? \"\"} ${profile.family_name ?? \"\"}`.trim() ||\n\t\t\t\t\tundefined),\n\t\t\temail: profile.email ?? profile.preferred_username ?? undefined,\n\t\t\timage: profile.picture,\n\t\t\t// Note: Microsoft Entra ID does NOT include email_verified claim by default.\n\t\t\t// It must be configured as an optional claim in the app registration.\n\t\t\t// We default to false when not provided\n\t\t\t// The built-in provider hardcodes this to true, assuming Microsoft accounts are verified.\n\t\t\temailVerified: profile.email_verified ?? false,\n\t\t};\n\t};\n\n\treturn {\n\t\tproviderId: \"microsoft-entra-id\",\n\t\tauthorizationUrl,\n\t\ttokenUrl,\n\t\tuserInfoUrl,\n\t\tclientId: options.clientId,\n\t\tclientSecret: options.clientSecret,\n\t\tscopes: options.scopes ?? defaultScopes,\n\t\tredirectURI: options.redirectURI,\n\t\tpkce: options.pkce,\n\t\tdisableImplicitSignUp: options.disableImplicitSignUp,\n\t\tdisableSignUp: options.disableSignUp,\n\t\toverrideUserInfo: options.overrideUserInfo,\n\t\tgetUserInfo,\n\t};\n}\n", "import type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport type { BaseOAuthProviderOptions, GenericOAuthConfig } from \"../index\";\n\nexport interface OktaOptions extends BaseOAuthProviderOptions {\n\t/**\n\t * Okta issuer URL (e.g., https://dev-xxxxx.okta.com/oauth2/default)\n\t * This will be used to construct the discovery URL.\n\t */\n\tissuer: string;\n}\n\ninterface OktaProfile {\n\tsub: string;\n\tname?: string;\n\temail?: string;\n\temail_verified?: boolean;\n\tpicture?: string;\n\tpreferred_username?: string;\n\tgiven_name?: string;\n\tfamily_name?: string;\n}\n\n/**\n * Okta OAuth provider helper\n *\n * @example\n * ```ts\n * import { genericOAuth, okta } from \"better-auth/plugins/generic-oauth\";\n *\n * export const auth = betterAuth({\n *   plugins: [\n *     genericOAuth({\n *       config: [\n *         okta({\n *           clientId: process.env.OKTA_CLIENT_ID,\n *           clientSecret: process.env.OKTA_CLIENT_SECRET,\n *           issuer: process.env.OKTA_ISSUER,\n *         }),\n *       ],\n *     }),\n *   ],\n * });\n * ```\n */\nexport function okta(options: OktaOptions): GenericOAuthConfig {\n\tconst defaultScopes = [\"openid\", \"profile\", \"email\"];\n\n\t// Ensure issuer ends without trailing slash for proper discovery URL construction\n\tconst issuer = options.issuer.replace(/\\/$/, \"\");\n\tconst discoveryUrl = `${issuer}/.well-known/openid-configuration`;\n\n\tconst getUserInfo = async (\n\t\ttokens: OAuth2Tokens,\n\t): Promise<OAuth2UserInfo | null> => {\n\t\tconst userInfoUrl = `${issuer}/v1/userinfo`;\n\n\t\tconst { data: profile, error } = await betterFetch<OktaProfile>(\n\t\t\tuserInfoUrl,\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (error || !profile) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tid: profile.sub,\n\t\t\tname: profile.name ?? profile.preferred_username ?? undefined,\n\t\t\temail: profile.email ?? undefined,\n\t\t\timage: profile.picture,\n\t\t\temailVerified: profile.email_verified ?? false,\n\t\t};\n\t};\n\n\treturn {\n\t\tproviderId: \"okta\",\n\t\tdiscoveryUrl,\n\t\tclientId: options.clientId,\n\t\tclientSecret: options.clientSecret,\n\t\tscopes: options.scopes ?? defaultScopes,\n\t\tredirectURI: options.redirectURI,\n\t\tpkce: options.pkce,\n\t\tdisableImplicitSignUp: options.disableImplicitSignUp,\n\t\tdisableSignUp: options.disableSignUp,\n\t\toverrideUserInfo: options.overrideUserInfo,\n\t\tgetUserInfo,\n\t};\n}\n", "import type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport type { BaseOAuthProviderOptions, GenericOAuthConfig } from \"../index\";\n\nexport interface PatreonOptions extends BaseOAuthProviderOptions {}\n\ninterface PatreonProfile {\n\tdata: {\n\t\tid: string;\n\t\tattributes: {\n\t\t\tfull_name: string;\n\t\t\temail: string;\n\t\t\timage_url: string;\n\t\t\tis_email_verified: boolean;\n\t\t};\n\t};\n}\n\n/**\n * Patreon OAuth provider helper\n *\n * @example\n * ```ts\n * import { genericOAuth, patreon } from \"better-auth/plugins/generic-oauth\";\n *\n * export const auth = betterAuth({\n *   plugins: [\n *     genericOAuth({\n *       config: [\n *         patreon({\n *           clientId: process.env.PATREON_CLIENT_ID,\n *           clientSecret: process.env.PATREON_CLIENT_SECRET,\n *         }),\n *       ],\n *     }),\n *   ],\n * });\n * ```\n */\nexport function patreon(options: PatreonOptions): GenericOAuthConfig {\n\tconst defaultScopes = [\"identity[email]\"];\n\n\tconst getUserInfo = async (\n\t\ttokens: OAuth2Tokens,\n\t): Promise<OAuth2UserInfo | null> => {\n\t\tconst { data: profile, error } = await betterFetch<PatreonProfile>(\n\t\t\t\"https://www.patreon.com/api/oauth2/v2/identity?fields[user]=email,full_name,image_url,is_email_verified\",\n\t\t\t{\n\t\t\t\tmethod: \"GET\",\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (error || !profile) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tid: profile.data.id,\n\t\t\tname: profile.data.attributes.full_name,\n\t\t\temail: profile.data.attributes.email,\n\t\t\timage: profile.data.attributes.image_url,\n\t\t\temailVerified: profile.data.attributes.is_email_verified,\n\t\t};\n\t};\n\n\treturn {\n\t\tproviderId: \"patreon\",\n\t\tauthorizationUrl: \"https://www.patreon.com/oauth2/authorize\",\n\t\ttokenUrl: \"https://www.patreon.com/api/oauth2/token\",\n\t\tclientId: options.clientId,\n\t\tclientSecret: options.clientSecret,\n\t\tscopes: options.scopes ?? defaultScopes,\n\t\tredirectURI: options.redirectURI,\n\t\tpkce: options.pkce,\n\t\tdisableImplicitSignUp: options.disableImplicitSignUp,\n\t\tdisableSignUp: options.disableSignUp,\n\t\toverrideUserInfo: options.overrideUserInfo,\n\t\tgetUserInfo,\n\t};\n}\n", "import type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport type { BaseOAuthProviderOptions, GenericOAuthConfig } from \"../index\";\n\nexport interface SlackOptions extends BaseOAuthProviderOptions {}\n\ninterface SlackProfile {\n\tsub: string;\n\t\"https://slack.com/user_id\": string;\n\t\"https://slack.com/team_id\": string;\n\temail: string;\n\temail_verified: boolean;\n\tname: string;\n\tpicture?: string;\n\tgiven_name?: string;\n\tfamily_name?: string;\n\tlocale?: string;\n\t\"https://slack.com/team_name\"?: string;\n\t\"https://slack.com/team_domain\"?: string;\n\t\"https://slack.com/user_image_512\"?: string;\n\t[key: string]: any;\n}\n\n/**\n * Slack OAuth provider helper\n *\n * @example\n * ```ts\n * import { genericOAuth, slack } from \"better-auth/plugins/generic-oauth\";\n *\n * export const auth = betterAuth({\n *   plugins: [\n *     genericOAuth({\n *       config: [\n *         slack({\n *           clientId: process.env.SLACK_CLIENT_ID,\n *           clientSecret: process.env.SLACK_CLIENT_SECRET,\n *         }),\n *       ],\n *     }),\n *   ],\n * });\n * ```\n */\nexport function slack(options: SlackOptions): GenericOAuthConfig {\n\tconst defaultScopes = [\"openid\", \"profile\", \"email\"];\n\n\tconst getUserInfo = async (\n\t\ttokens: OAuth2Tokens,\n\t): Promise<OAuth2UserInfo | null> => {\n\t\tconst { data: profile, error } = await betterFetch<SlackProfile>(\n\t\t\t\"https://slack.com/api/openid.connect.userInfo\",\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (error || !profile) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\tid: profile[\"https://slack.com/user_id\"] ?? profile.sub,\n\t\t\tname: profile.name,\n\t\t\temail: profile.email,\n\t\t\timage: profile.picture ?? profile[\"https://slack.com/user_image_512\"],\n\t\t\temailVerified: profile.email_verified ?? false,\n\t\t};\n\t};\n\n\treturn {\n\t\tproviderId: \"slack\",\n\t\tauthorizationUrl: \"https://slack.com/openid/connect/authorize\",\n\t\ttokenUrl: \"https://slack.com/api/openid.connect.token\",\n\t\tuserInfoUrl: \"https://slack.com/api/openid.connect.userInfo\",\n\t\tclientId: options.clientId,\n\t\tclientSecret: options.clientSecret,\n\t\tscopes: options.scopes ?? defaultScopes,\n\t\tredirectURI: options.redirectURI,\n\t\tpkce: options.pkce,\n\t\tdisableImplicitSignUp: options.disableImplicitSignUp,\n\t\tdisableSignUp: options.disableSignUp,\n\t\toverrideUserInfo: options.overrideUserInfo,\n\t\tgetUserInfo,\n\t};\n}\n", "import { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const GENERIC_OAUTH_ERROR_CODES = defineErrorCodes({\n\tINVALID_OAUTH_CONFIGURATION: \"Invalid OAuth configuration\",\n\tTOKEN_URL_NOT_FOUND: \"Invalid OAuth configuration. Token URL not found.\",\n\tPROVIDER_CONFIG_NOT_FOUND: \"No config found for provider\",\n\tPROVIDER_ID_REQUIRED: \"Provider ID is required\",\n\tINVALID_OAUTH_CONFIG: \"Invalid OAuth configuration.\",\n\tSESSION_REQUIRED: \"Session is required\",\n});\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport type { OAuth2Tokens, OAuth2UserInfo } from \"@better-auth/core/oauth2\";\nimport {\n\tcreateAuthorizationURL,\n\tvalidateAuthorizationCode,\n} from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport { APIError } from \"better-call\";\nimport { decodeJwt } from \"jose\";\nimport * as z from \"zod\";\nimport { sessionMiddleware } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { handleOAuthUserInfo } from \"../../oauth2/link-account\";\nimport { generateState, parseState } from \"../../oauth2/state\";\nimport { setTokenUtil } from \"../../oauth2/utils\";\nimport type { User } from \"../../types\";\nimport { HIDE_METADATA } from \"../../utils\";\nimport { GENERIC_OAUTH_ERROR_CODES } from \"./error-codes\";\nimport type { GenericOAuthOptions } from \"./types\";\n\nconst signInWithOAuth2BodySchema = z.object({\n\tproviderId: z.string().meta({\n\t\tdescription: \"The provider ID for the OAuth provider\",\n\t}),\n\tcallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The URL to redirect to after sign in\",\n\t\t})\n\t\t.optional(),\n\terrorCallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The URL to redirect to if an error occurs\",\n\t\t})\n\t\t.optional(),\n\tnewUserCallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The URL to redirect to after login if the user is new. Eg: \"/welcome\"',\n\t\t})\n\t\t.optional(),\n\tdisableRedirect: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"Disable redirect\",\n\t\t})\n\t\t.optional(),\n\tscopes: z\n\t\t.array(z.string())\n\t\t.meta({\n\t\t\tdescription: \"Scopes to be passed to the provider authorization request.\",\n\t\t})\n\t\t.optional(),\n\trequestSignUp: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider. Eg: false\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * Any additional data to pass through the oauth flow.\n\t */\n\tadditionalData: z.record(z.string(), z.any()).optional(),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/sign-in/oauth2`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.signInWithOAuth2`\n *\n * **client:**\n * `authClient.signIn.oauth2`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/sign-in#api-method-sign-in-oauth2)\n */\nexport const signInWithOAuth2 = (options: GenericOAuthOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/sign-in/oauth2\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: signInWithOAuth2BodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Sign in with OAuth2\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Sign in with OAuth2\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\turl: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tredirect: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx: GenericEndpointContext) => {\n\t\t\tconst { providerId } = ctx.body;\n\t\t\tconst config = options.config.find((c) => c.providerId === providerId);\n\t\t\tif (!config) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: `${GENERIC_OAUTH_ERROR_CODES.PROVIDER_CONFIG_NOT_FOUND} ${providerId}`,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst {\n\t\t\t\tdiscoveryUrl,\n\t\t\t\tauthorizationUrl,\n\t\t\t\ttokenUrl,\n\t\t\t\tclientId,\n\t\t\t\tclientSecret,\n\t\t\t\tscopes,\n\t\t\t\tredirectURI,\n\t\t\t\tresponseType,\n\t\t\t\tpkce,\n\t\t\t\tprompt,\n\t\t\t\taccessType,\n\t\t\t\tauthorizationUrlParams,\n\t\t\t\tresponseMode,\n\t\t\t} = config;\n\t\t\tlet finalAuthUrl = authorizationUrl;\n\t\t\tlet finalTokenUrl = tokenUrl;\n\t\t\tif (discoveryUrl) {\n\t\t\t\tconst discovery = await betterFetch<{\n\t\t\t\t\tauthorization_endpoint: string;\n\t\t\t\t\ttoken_endpoint: string;\n\t\t\t\t}>(discoveryUrl, {\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\theaders: config.discoveryHeaders,\n\t\t\t\t\tonError(context) {\n\t\t\t\t\t\tctx.context.logger.error(context.error.message, context.error, {\n\t\t\t\t\t\t\tdiscoveryUrl,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tif (discovery.data) {\n\t\t\t\t\tfinalAuthUrl = discovery.data.authorization_endpoint;\n\t\t\t\t\tfinalTokenUrl = discovery.data.token_endpoint;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!finalAuthUrl || !finalTokenUrl) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.INVALID_OAUTH_CONFIGURATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (authorizationUrlParams) {\n\t\t\t\tconst withAdditionalParams = new URL(finalAuthUrl);\n\t\t\t\tfor (const [paramName, paramValue] of Object.entries(\n\t\t\t\t\tauthorizationUrlParams,\n\t\t\t\t)) {\n\t\t\t\t\twithAdditionalParams.searchParams.set(paramName, paramValue);\n\t\t\t\t}\n\t\t\t\tfinalAuthUrl = withAdditionalParams.toString();\n\t\t\t}\n\t\t\tconst additionalParams =\n\t\t\t\ttypeof authorizationUrlParams === \"function\"\n\t\t\t\t\t? authorizationUrlParams(ctx)\n\t\t\t\t\t: authorizationUrlParams;\n\n\t\t\tconst { state, codeVerifier } = await generateState(\n\t\t\t\tctx,\n\t\t\t\tundefined,\n\t\t\t\tctx.body.additionalData,\n\t\t\t);\n\t\t\tconst authUrl = await createAuthorizationURL({\n\t\t\t\tid: providerId,\n\t\t\t\toptions: {\n\t\t\t\t\tclientId,\n\t\t\t\t\tclientSecret,\n\t\t\t\t\tredirectURI,\n\t\t\t\t},\n\t\t\t\tauthorizationEndpoint: finalAuthUrl,\n\t\t\t\tstate,\n\t\t\t\tcodeVerifier: pkce ? codeVerifier : undefined,\n\t\t\t\tscopes: ctx.body.scopes\n\t\t\t\t\t? [...ctx.body.scopes, ...(scopes || [])]\n\t\t\t\t\t: scopes || [],\n\t\t\t\tredirectURI: `${ctx.context.baseURL}/oauth2/callback/${providerId}`,\n\t\t\t\tprompt,\n\t\t\t\taccessType,\n\t\t\t\tresponseType,\n\t\t\t\tresponseMode,\n\t\t\t\tadditionalParams,\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\turl: authUrl.toString(),\n\t\t\t\tredirect: !ctx.body.disableRedirect,\n\t\t\t});\n\t\t},\n\t);\n\nconst OAuth2CallbackQuerySchema = z.object({\n\tcode: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The OAuth2 code\",\n\t\t})\n\t\t.optional(),\n\terror: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The error message, if any\",\n\t\t})\n\t\t.optional(),\n\terror_description: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The error description, if any\",\n\t\t})\n\t\t.optional(),\n\tstate: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The state parameter from the OAuth2 request\",\n\t\t})\n\t\t.optional(),\n});\n\nexport const oAuth2Callback = (options: GenericOAuthOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/oauth2/callback/:providerId\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: OAuth2CallbackQuerySchema,\n\t\t\tmetadata: {\n\t\t\t\t...HIDE_METADATA,\n\t\t\t\tallowedMediaTypes: [\n\t\t\t\t\t\"application/x-www-form-urlencoded\",\n\t\t\t\t\t\"application/json\",\n\t\t\t\t],\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"OAuth2 callback\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"OAuth2 callback\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\turl: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx: GenericEndpointContext) => {\n\t\t\tconst defaultErrorURL =\n\t\t\t\tctx.context.options.onAPIError?.errorURL ||\n\t\t\t\t`${ctx.context.baseURL}/error`;\n\t\t\tif (ctx.query.error || !ctx.query.code) {\n\t\t\t\tthrow ctx.redirect(\n\t\t\t\t\t`${defaultErrorURL}?error=${\n\t\t\t\t\t\tctx.query.error || \"oAuth_code_missing\"\n\t\t\t\t\t}&error_description=${ctx.query.error_description}`,\n\t\t\t\t);\n\t\t\t}\n\t\t\tconst providerId = ctx.params?.providerId;\n\t\t\tif (!providerId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.PROVIDER_ID_REQUIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst providerConfig = options.config.find(\n\t\t\t\t(p) => p.providerId === providerId,\n\t\t\t);\n\n\t\t\tif (!providerConfig) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: `${GENERIC_OAUTH_ERROR_CODES.PROVIDER_CONFIG_NOT_FOUND} ${providerId}`,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet tokens: OAuth2Tokens | undefined = undefined;\n\t\t\tconst parsedState = await parseState(ctx);\n\t\t\tconst {\n\t\t\t\tcallbackURL,\n\t\t\t\tcodeVerifier,\n\t\t\t\terrorURL,\n\t\t\t\trequestSignUp,\n\t\t\t\tnewUserURL,\n\t\t\t\tlink,\n\t\t\t} = parsedState;\n\t\t\tconst code = ctx.query.code;\n\n\t\t\tfunction redirectOnError(error: string) {\n\t\t\t\tconst defaultErrorURL =\n\t\t\t\t\tctx.context.options.onAPIError?.errorURL ||\n\t\t\t\t\t`${ctx.context.baseURL}/error`;\n\t\t\t\tlet url = errorURL || defaultErrorURL;\n\t\t\t\tif (url.includes(\"?\")) {\n\t\t\t\t\turl = `${url}&error=${error}`;\n\t\t\t\t} else {\n\t\t\t\t\turl = `${url}?error=${error}`;\n\t\t\t\t}\n\t\t\t\tthrow ctx.redirect(url);\n\t\t\t}\n\n\t\t\tlet finalTokenUrl = providerConfig.tokenUrl;\n\t\t\tlet finalUserInfoUrl = providerConfig.userInfoUrl;\n\t\t\tif (providerConfig.discoveryUrl) {\n\t\t\t\tconst discovery = await betterFetch<{\n\t\t\t\t\ttoken_endpoint: string;\n\t\t\t\t\tuserinfo_endpoint: string;\n\t\t\t\t}>(providerConfig.discoveryUrl, {\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\theaders: providerConfig.discoveryHeaders,\n\t\t\t\t});\n\t\t\t\tif (discovery.data) {\n\t\t\t\t\tfinalTokenUrl = discovery.data.token_endpoint;\n\t\t\t\t\tfinalUserInfoUrl = discovery.data.userinfo_endpoint;\n\t\t\t\t}\n\t\t\t}\n\t\t\ttry {\n\t\t\t\t// Use custom getToken if provided\n\t\t\t\tif (providerConfig.getToken) {\n\t\t\t\t\ttokens = await providerConfig.getToken({\n\t\t\t\t\t\tcode,\n\t\t\t\t\t\tredirectURI: `${ctx.context.baseURL}/oauth2/callback/${providerConfig.providerId}`,\n\t\t\t\t\t\tcodeVerifier: providerConfig.pkce ? codeVerifier : undefined,\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\t// Standard token exchange with tokenUrlParams support\n\t\t\t\t\tif (!finalTokenUrl) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.INVALID_OAUTH_CONFIG,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst additionalParams =\n\t\t\t\t\t\ttypeof providerConfig.tokenUrlParams === \"function\"\n\t\t\t\t\t\t\t? providerConfig.tokenUrlParams(ctx)\n\t\t\t\t\t\t\t: providerConfig.tokenUrlParams;\n\t\t\t\t\ttokens = await validateAuthorizationCode({\n\t\t\t\t\t\theaders: providerConfig.authorizationHeaders,\n\t\t\t\t\t\tcode,\n\t\t\t\t\t\tcodeVerifier: providerConfig.pkce ? codeVerifier : undefined,\n\t\t\t\t\t\tredirectURI: `${ctx.context.baseURL}/oauth2/callback/${providerConfig.providerId}`,\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\tclientId: providerConfig.clientId,\n\t\t\t\t\t\t\tclientSecret: providerConfig.clientSecret,\n\t\t\t\t\t\t\tredirectURI: providerConfig.redirectURI,\n\t\t\t\t\t\t},\n\t\t\t\t\t\ttokenEndpoint: finalTokenUrl,\n\t\t\t\t\t\tauthentication: providerConfig.authentication,\n\t\t\t\t\t\tadditionalParams,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\te && typeof e === \"object\" && \"name\" in e ? (e.name as string) : \"\",\n\t\t\t\t\te,\n\t\t\t\t);\n\t\t\t\tthrow redirectOnError(\"oauth_code_verification_failed\");\n\t\t\t}\n\t\t\tif (!tokens) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.INVALID_OAUTH_CONFIG,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst userInfo: Omit<User, \"createdAt\" | \"updatedAt\"> =\n\t\t\t\tawait (async function handleUserInfo() {\n\t\t\t\t\tconst userInfo = (\n\t\t\t\t\t\tproviderConfig.getUserInfo\n\t\t\t\t\t\t\t? await providerConfig.getUserInfo(tokens)\n\t\t\t\t\t\t\t: await getUserInfo(tokens, finalUserInfoUrl)\n\t\t\t\t\t) as OAuth2UserInfo | null;\n\t\t\t\t\tif (!userInfo) {\n\t\t\t\t\t\tthrow redirectOnError(\"user_info_is_missing\");\n\t\t\t\t\t}\n\t\t\t\t\tconst mapUser = providerConfig.mapProfileToUser\n\t\t\t\t\t\t? await providerConfig.mapProfileToUser(userInfo)\n\t\t\t\t\t\t: userInfo;\n\t\t\t\t\tconst email = mapUser.email\n\t\t\t\t\t\t? mapUser.email.toLowerCase()\n\t\t\t\t\t\t: userInfo.email?.toLowerCase();\n\t\t\t\t\tif (!email) {\n\t\t\t\t\t\tctx.context.logger.error(\"Unable to get user info\", userInfo);\n\t\t\t\t\t\tthrow redirectOnError(\"email_is_missing\");\n\t\t\t\t\t}\n\t\t\t\t\tconst id = mapUser.id ? String(mapUser.id) : String(userInfo.id);\n\t\t\t\t\tconst name = mapUser.name ? mapUser.name : userInfo.name;\n\t\t\t\t\tif (!name) {\n\t\t\t\t\t\tctx.context.logger.error(\"Unable to get user info\", userInfo);\n\t\t\t\t\t\tthrow redirectOnError(\"name_is_missing\");\n\t\t\t\t\t}\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...userInfo,\n\t\t\t\t\t\t...mapUser,\n\t\t\t\t\t\temail,\n\t\t\t\t\t\tid,\n\t\t\t\t\t\tname,\n\t\t\t\t\t};\n\t\t\t\t})();\n\t\t\tif (link) {\n\t\t\t\tif (\n\t\t\t\t\tctx.context.options.account?.accountLinking?.allowDifferentEmails !==\n\t\t\t\t\t\ttrue &&\n\t\t\t\t\tlink.email !== userInfo.email\n\t\t\t\t) {\n\t\t\t\t\treturn redirectOnError(\"email_doesn't_match\");\n\t\t\t\t}\n\t\t\t\tconst existingAccount =\n\t\t\t\t\tawait ctx.context.internalAdapter.findAccountByProviderId(\n\t\t\t\t\t\tString(userInfo.id),\n\t\t\t\t\t\tproviderConfig.providerId,\n\t\t\t\t\t);\n\t\t\t\tif (existingAccount) {\n\t\t\t\t\tif (existingAccount.userId !== link.userId) {\n\t\t\t\t\t\treturn redirectOnError(\"account_already_linked_to_different_user\");\n\t\t\t\t\t}\n\t\t\t\t\tconst updateData = Object.fromEntries(\n\t\t\t\t\t\tObject.entries({\n\t\t\t\t\t\t\taccessToken: await setTokenUtil(tokens.accessToken, ctx.context),\n\t\t\t\t\t\t\tidToken: tokens.idToken,\n\t\t\t\t\t\t\trefreshToken: await setTokenUtil(\n\t\t\t\t\t\t\t\ttokens.refreshToken,\n\t\t\t\t\t\t\t\tctx.context,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\taccessTokenExpiresAt: tokens.accessTokenExpiresAt,\n\t\t\t\t\t\t\trefreshTokenExpiresAt: tokens.refreshTokenExpiresAt,\n\t\t\t\t\t\t\tscope: tokens.scopes?.join(\",\"),\n\t\t\t\t\t\t}).filter(([_, value]) => value !== undefined),\n\t\t\t\t\t);\n\t\t\t\t\tawait ctx.context.internalAdapter.updateAccount(\n\t\t\t\t\t\texistingAccount.id,\n\t\t\t\t\t\tupdateData,\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tconst newAccount = await ctx.context.internalAdapter.createAccount({\n\t\t\t\t\t\tuserId: link.userId,\n\t\t\t\t\t\tproviderId: providerConfig.providerId,\n\t\t\t\t\t\taccountId: userInfo.id,\n\t\t\t\t\t\taccessToken: await setTokenUtil(tokens.accessToken, ctx.context),\n\t\t\t\t\t\taccessTokenExpiresAt: tokens.accessTokenExpiresAt,\n\t\t\t\t\t\trefreshTokenExpiresAt: tokens.refreshTokenExpiresAt,\n\t\t\t\t\t\tscope: tokens.scopes?.join(\",\"),\n\t\t\t\t\t\trefreshToken: await setTokenUtil(tokens.refreshToken, ctx.context),\n\t\t\t\t\t\tidToken: tokens.idToken,\n\t\t\t\t\t});\n\t\t\t\t\tif (!newAccount) {\n\t\t\t\t\t\treturn redirectOnError(\"unable_to_link_account\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet toRedirectTo: string;\n\t\t\t\ttry {\n\t\t\t\t\tconst url = callbackURL;\n\t\t\t\t\ttoRedirectTo = url.toString();\n\t\t\t\t} catch {\n\t\t\t\t\ttoRedirectTo = callbackURL;\n\t\t\t\t}\n\t\t\t\tthrow ctx.redirect(toRedirectTo);\n\t\t\t}\n\n\t\t\tconst result = await handleOAuthUserInfo(ctx, {\n\t\t\t\tuserInfo,\n\t\t\t\taccount: {\n\t\t\t\t\tproviderId: providerConfig.providerId,\n\t\t\t\t\taccountId: userInfo.id,\n\t\t\t\t\t...tokens,\n\t\t\t\t\tscope: tokens.scopes?.join(\",\"),\n\t\t\t\t},\n\t\t\t\tcallbackURL: callbackURL,\n\t\t\t\tdisableSignUp:\n\t\t\t\t\t(providerConfig.disableImplicitSignUp && !requestSignUp) ||\n\t\t\t\t\tproviderConfig.disableSignUp,\n\t\t\t\toverrideUserInfo: providerConfig.overrideUserInfo,\n\t\t\t});\n\n\t\t\tif (result.error) {\n\t\t\t\treturn redirectOnError(result.error.split(\" \").join(\"_\"));\n\t\t\t}\n\t\t\tconst { session, user } = result.data!;\n\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\tsession,\n\t\t\t\tuser,\n\t\t\t});\n\t\t\tlet toRedirectTo: string;\n\t\t\ttry {\n\t\t\t\tconst url = result.isRegister ? newUserURL || callbackURL : callbackURL;\n\t\t\t\ttoRedirectTo = url.toString();\n\t\t\t} catch {\n\t\t\t\ttoRedirectTo = result.isRegister\n\t\t\t\t\t? newUserURL || callbackURL\n\t\t\t\t\t: callbackURL;\n\t\t\t}\n\t\t\tthrow ctx.redirect(toRedirectTo);\n\t\t},\n\t);\n\nconst OAuth2LinkAccountBodySchema = z.object({\n\tproviderId: z.string(),\n\t/**\n\t * Callback URL to redirect to after the user has signed in.\n\t */\n\tcallbackURL: z.string(),\n\t/**\n\t * Additional scopes to request when linking the account.\n\t * This is useful for requesting additional permissions when\n\t * linking a social account compared to the initial authentication.\n\t */\n\tscopes: z\n\t\t.array(z.string())\n\t\t.meta({\n\t\t\tdescription: \"Additional scopes to request when linking the account\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * The URL to redirect to if there is an error during the link process.\n\t */\n\terrorCallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"The URL to redirect to if there is an error during the link process\",\n\t\t})\n\t\t.optional(),\n});\n/**\n * ### Endpoint\n *\n * POST `/oauth2/link`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.oAuth2LinkAccount`\n *\n * **client:**\n * `authClient.oauth2.link`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/generic-oauth#api-method-oauth2-link)\n */\nexport const oAuth2LinkAccount = (options: GenericOAuthOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/oauth2/link\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: OAuth2LinkAccountBodySchema,\n\t\t\tuse: [sessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Link an OAuth2 account to the current user session\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Authorization URL generated successfully for linking an OAuth2 account\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\turl: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The authorization URL to redirect the user to for linking the OAuth2 account\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tredirect: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates that the client should redirect to the provided URL\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"url\", \"redirect\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (c: GenericEndpointContext) => {\n\t\t\tconst session = c.context.session;\n\t\t\tif (!session) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.SESSION_REQUIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst provider = options.config.find(\n\t\t\t\t(p) => p.providerId === c.body.providerId,\n\t\t\t);\n\t\t\tif (!provider) {\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PROVIDER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst {\n\t\t\t\tproviderId,\n\t\t\t\tclientId,\n\t\t\t\tclientSecret,\n\t\t\t\tredirectURI,\n\t\t\t\tauthorizationUrl,\n\t\t\t\tdiscoveryUrl,\n\t\t\t\tpkce,\n\t\t\t\tscopes,\n\t\t\t\tprompt,\n\t\t\t\taccessType,\n\t\t\t\tauthorizationUrlParams,\n\t\t\t} = provider;\n\n\t\t\tlet finalAuthUrl = authorizationUrl;\n\t\t\tif (!finalAuthUrl) {\n\t\t\t\tif (!discoveryUrl) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.INVALID_OAUTH_CONFIGURATION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst discovery = await betterFetch<{\n\t\t\t\t\tauthorization_endpoint: string;\n\t\t\t\t\ttoken_endpoint: string;\n\t\t\t\t}>(discoveryUrl, {\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\theaders: provider.discoveryHeaders,\n\t\t\t\t\tonError(context) {\n\t\t\t\t\t\tc.context.logger.error(context.error.message, context.error, {\n\t\t\t\t\t\t\tdiscoveryUrl,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tif (discovery.data) {\n\t\t\t\t\tfinalAuthUrl = discovery.data.authorization_endpoint;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!finalAuthUrl) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.INVALID_OAUTH_CONFIGURATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst state = await generateState(\n\t\t\t\tc,\n\t\t\t\t{\n\t\t\t\t\tuserId: session.user.id,\n\t\t\t\t\temail: session.user.email,\n\t\t\t\t},\n\t\t\t\tundefined,\n\t\t\t);\n\n\t\t\tconst additionalParams =\n\t\t\t\ttypeof authorizationUrlParams === \"function\"\n\t\t\t\t\t? authorizationUrlParams(c)\n\t\t\t\t\t: authorizationUrlParams;\n\n\t\t\tconst url = await createAuthorizationURL({\n\t\t\t\tid: providerId,\n\t\t\t\toptions: {\n\t\t\t\t\tclientId,\n\t\t\t\t\tclientSecret,\n\t\t\t\t\tredirectURI:\n\t\t\t\t\t\tredirectURI || `${c.context.baseURL}/oauth2/callback/${providerId}`,\n\t\t\t\t},\n\t\t\t\tauthorizationEndpoint: finalAuthUrl,\n\t\t\t\tstate: state.state,\n\t\t\t\tcodeVerifier: pkce ? state.codeVerifier : undefined,\n\t\t\t\tscopes: c.body.scopes || scopes || [],\n\t\t\t\tredirectURI:\n\t\t\t\t\tredirectURI || `${c.context.baseURL}/oauth2/callback/${providerId}`,\n\t\t\t\tprompt,\n\t\t\t\taccessType,\n\t\t\t\tadditionalParams,\n\t\t\t});\n\n\t\t\treturn c.json({\n\t\t\t\turl: url.toString(),\n\t\t\t\tredirect: true,\n\t\t\t});\n\t\t},\n\t);\n\nexport async function getUserInfo(\n\ttokens: OAuth2Tokens,\n\tfinalUserInfoUrl: string | undefined,\n): Promise<OAuth2UserInfo | null> {\n\tif (tokens.idToken) {\n\t\tconst decoded = decodeJwt(tokens.idToken) as {\n\t\t\tsub: string;\n\t\t\temail_verified: boolean;\n\t\t\temail: string;\n\t\t\tname: string;\n\t\t\tpicture: string;\n\t\t};\n\t\tif (decoded) {\n\t\t\tif (decoded.sub && decoded.email) {\n\t\t\t\treturn {\n\t\t\t\t\tid: decoded.sub,\n\t\t\t\t\temailVerified: decoded.email_verified,\n\t\t\t\t\timage: decoded.picture,\n\t\t\t\t\t...decoded,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!finalUserInfoUrl) {\n\t\treturn null;\n\t}\n\n\tconst userInfo = await betterFetch<{\n\t\temail: string;\n\t\tsub?: string | undefined;\n\t\tname: string;\n\t\temail_verified: boolean;\n\t\tpicture: string;\n\t}>(finalUserInfoUrl, {\n\t\tmethod: \"GET\",\n\t\theaders: {\n\t\t\tAuthorization: `Bearer ${tokens.accessToken}`,\n\t\t},\n\t});\n\treturn {\n\t\tid: userInfo.data?.sub ?? \"\",\n\t\temailVerified: userInfo.data?.email_verified ?? false,\n\t\temail: userInfo.data?.email,\n\t\timage: userInfo.data?.picture,\n\t\tname: userInfo.data?.name,\n\t\t...userInfo.data,\n\t};\n}\n", "import type { AuthContext, BetterAuthPlugin } from \"@better-auth/core\";\nimport type { OAuth2Tokens, OAuthProvider } from \"@better-auth/core/oauth2\";\nimport {\n\tcreateAuthorizationURL,\n\trefreshAccessToken,\n\tvalidateAuthorizationCode,\n} from \"@better-auth/core/oauth2\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport { APIError } from \"better-call\";\nimport { GENERIC_OAUTH_ERROR_CODES } from \"./error-codes\";\nimport {\n\tgetUserInfo,\n\toAuth2Callback,\n\toAuth2LinkAccount,\n\tsignInWithOAuth2,\n} from \"./routes\";\nimport type { GenericOAuthConfig, GenericOAuthOptions } from \"./types\";\n\nexport * from \"./providers\";\nexport type { GenericOAuthConfig, GenericOAuthOptions } from \"./types\";\n\n/**\n * Base type for OAuth provider options.\n * Extracts common fields from GenericOAuthConfig and makes clientSecret required.\n */\nexport type BaseOAuthProviderOptions = Omit<\n\tPick<\n\t\tGenericOAuthConfig,\n\t\t| \"clientId\"\n\t\t| \"clientSecret\"\n\t\t| \"scopes\"\n\t\t| \"redirectURI\"\n\t\t| \"pkce\"\n\t\t| \"disableImplicitSignUp\"\n\t\t| \"disableSignUp\"\n\t\t| \"overrideUserInfo\"\n\t>,\n\t\"clientSecret\"\n> & {\n\t/** OAuth client secret (required for provider options) */\n\tclientSecret: string;\n};\n\n/**\n * A generic OAuth plugin that can be used to add OAuth support to any provider\n */\nexport const genericOAuth = (options: GenericOAuthOptions) => {\n\treturn {\n\t\tid: \"generic-oauth\",\n\t\tinit: (ctx: AuthContext) => {\n\t\t\tconst genericProviders = options.config.map((c) => {\n\t\t\t\tlet finalUserInfoUrl = c.userInfoUrl;\n\t\t\t\treturn {\n\t\t\t\t\tid: c.providerId,\n\t\t\t\t\tname: c.providerId,\n\t\t\t\t\tasync createAuthorizationURL(data: {\n\t\t\t\t\t\tstate: string;\n\t\t\t\t\t\tcodeVerifier: string;\n\t\t\t\t\t\tscopes?: string[] | undefined;\n\t\t\t\t\t\tredirectURI: string;\n\t\t\t\t\t\tdisplay?: string | undefined;\n\t\t\t\t\t\tloginHint?: string | undefined;\n\t\t\t\t\t}) {\n\t\t\t\t\t\tlet finalAuthUrl = c.authorizationUrl;\n\t\t\t\t\t\tif (!finalAuthUrl && c.discoveryUrl) {\n\t\t\t\t\t\t\tconst discovery = await betterFetch<{\n\t\t\t\t\t\t\t\tauthorization_endpoint: string;\n\t\t\t\t\t\t\t\tuserinfo_endpoint: string;\n\t\t\t\t\t\t\t}>(c.discoveryUrl, {\n\t\t\t\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\t\t\t\theaders: c.discoveryHeaders,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (discovery.data) {\n\t\t\t\t\t\t\t\tfinalAuthUrl = discovery.data.authorization_endpoint;\n\t\t\t\t\t\t\t\tfinalUserInfoUrl =\n\t\t\t\t\t\t\t\t\tfinalUserInfoUrl ?? discovery.data.userinfo_endpoint;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!finalAuthUrl) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.INVALID_OAUTH_CONFIGURATION,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn createAuthorizationURL({\n\t\t\t\t\t\t\tid: c.providerId,\n\t\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\t\tclientId: c.clientId,\n\t\t\t\t\t\t\t\tclientSecret: c.clientSecret,\n\t\t\t\t\t\t\t\tredirectURI: c.redirectURI,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tauthorizationEndpoint: finalAuthUrl,\n\t\t\t\t\t\t\tstate: data.state,\n\t\t\t\t\t\t\tcodeVerifier: c.pkce ? data.codeVerifier : undefined,\n\t\t\t\t\t\t\tscopes: c.scopes || [],\n\t\t\t\t\t\t\tredirectURI: `${ctx.baseURL}/oauth2/callback/${c.providerId}`,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\tasync validateAuthorizationCode(data: {\n\t\t\t\t\t\tcode: string;\n\t\t\t\t\t\tredirectURI: string;\n\t\t\t\t\t\tcodeVerifier?: string | undefined;\n\t\t\t\t\t\tdeviceId?: string | undefined;\n\t\t\t\t\t}) {\n\t\t\t\t\t\t// Use custom getToken if provided\n\t\t\t\t\t\tif (c.getToken) {\n\t\t\t\t\t\t\treturn c.getToken(data);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Standard token exchange flow\n\t\t\t\t\t\tlet finalTokenUrl = c.tokenUrl;\n\t\t\t\t\t\tif (c.discoveryUrl) {\n\t\t\t\t\t\t\tconst discovery = await betterFetch<{\n\t\t\t\t\t\t\t\ttoken_endpoint: string;\n\t\t\t\t\t\t\t\tuserinfo_endpoint: string;\n\t\t\t\t\t\t\t}>(c.discoveryUrl, {\n\t\t\t\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\t\t\t\theaders: c.discoveryHeaders,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (discovery.data) {\n\t\t\t\t\t\t\t\tfinalTokenUrl = discovery.data.token_endpoint;\n\t\t\t\t\t\t\t\tfinalUserInfoUrl = discovery.data.userinfo_endpoint;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!finalTokenUrl) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.TOKEN_URL_NOT_FOUND,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn validateAuthorizationCode({\n\t\t\t\t\t\t\theaders: c.authorizationHeaders,\n\t\t\t\t\t\t\tcode: data.code,\n\t\t\t\t\t\t\tcodeVerifier: data.codeVerifier,\n\t\t\t\t\t\t\tredirectURI: data.redirectURI,\n\t\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\t\tclientId: c.clientId,\n\t\t\t\t\t\t\t\tclientSecret: c.clientSecret,\n\t\t\t\t\t\t\t\tredirectURI: c.redirectURI,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttokenEndpoint: finalTokenUrl,\n\t\t\t\t\t\t\tauthentication: c.authentication,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\tasync refreshAccessToken(\n\t\t\t\t\t\trefreshToken: string,\n\t\t\t\t\t): Promise<OAuth2Tokens> {\n\t\t\t\t\t\tlet finalTokenUrl = c.tokenUrl;\n\t\t\t\t\t\tif (c.discoveryUrl) {\n\t\t\t\t\t\t\tconst discovery = await betterFetch<{\n\t\t\t\t\t\t\t\ttoken_endpoint: string;\n\t\t\t\t\t\t\t}>(c.discoveryUrl, {\n\t\t\t\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\t\t\t\theaders: c.discoveryHeaders,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (discovery.data) {\n\t\t\t\t\t\t\t\tfinalTokenUrl = discovery.data.token_endpoint;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!finalTokenUrl) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\tmessage: GENERIC_OAUTH_ERROR_CODES.TOKEN_URL_NOT_FOUND,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn refreshAccessToken({\n\t\t\t\t\t\t\trefreshToken,\n\t\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\t\tclientId: c.clientId,\n\t\t\t\t\t\t\t\tclientSecret: c.clientSecret,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tauthentication: c.authentication,\n\t\t\t\t\t\t\ttokenEndpoint: finalTokenUrl,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\tasync getUserInfo(tokens: OAuth2Tokens) {\n\t\t\t\t\t\tconst userInfo = c.getUserInfo\n\t\t\t\t\t\t\t? await c.getUserInfo(tokens)\n\t\t\t\t\t\t\t: await getUserInfo(tokens, finalUserInfoUrl);\n\t\t\t\t\t\tif (!userInfo) {\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst userMap = await c.mapProfileToUser?.(userInfo);\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\tid: userInfo?.id,\n\t\t\t\t\t\t\t\temail: userInfo?.email,\n\t\t\t\t\t\t\t\temailVerified: userInfo?.emailVerified,\n\t\t\t\t\t\t\t\timage: userInfo?.image,\n\t\t\t\t\t\t\t\tname: userInfo?.name,\n\t\t\t\t\t\t\t\t...userMap,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tdata: userInfo,\n\t\t\t\t\t\t};\n\t\t\t\t\t},\n\t\t\t\t\toptions: {\n\t\t\t\t\t\toverrideUserInfoOnSignIn: c.overrideUserInfo,\n\t\t\t\t\t},\n\t\t\t\t} as OAuthProvider;\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tcontext: {\n\t\t\t\t\tsocialProviders: genericProviders.concat(ctx.socialProviders),\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tendpoints: {\n\t\t\tsignInWithOAuth2: signInWithOAuth2(options),\n\t\t\toAuth2Callback: oAuth2Callback(options),\n\t\t\toAuth2LinkAccount: oAuth2LinkAccount(options),\n\t\t},\n\t\toptions,\n\t\t$ERROR_CODES: GENERIC_OAUTH_ERROR_CODES,\n\t} satisfies BetterAuthPlugin;\n};\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { getCurrentAuthContext } from \"@better-auth/core/context\";\nimport { defineErrorCodes } from \"@better-auth/core/utils\";\nimport { createHash } from \"@better-auth/utils/hash\";\nimport { betterFetch } from \"@better-fetch/fetch\";\nimport { APIError } from \"../../api\";\n\nconst ERROR_CODES = defineErrorCodes({\n\tPASSWORD_COMPROMISED:\n\t\t\"The password you entered has been compromised. Please choose a different password.\",\n});\n\nasync function checkPasswordCompromise(\n\tpassword: string,\n\tcustomMessage?: string | undefined,\n) {\n\tif (!password) return;\n\n\tconst sha1Hash = (\n\t\tawait createHash(\"SHA-1\", \"hex\").digest(password)\n\t).toUpperCase();\n\tconst prefix = sha1Hash.substring(0, 5);\n\tconst suffix = sha1Hash.substring(5);\n\ttry {\n\t\tconst { data, error } = await betterFetch<string>(\n\t\t\t`https://api.pwnedpasswords.com/range/${prefix}`,\n\t\t\t{\n\t\t\t\theaders: {\n\t\t\t\t\t\"Add-Padding\": \"true\",\n\t\t\t\t\t\"User-Agent\": \"BetterAuth Password Checker\",\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (error) {\n\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\tmessage: `Failed to check password. Status: ${error.status}`,\n\t\t\t});\n\t\t}\n\t\tconst lines = data.split(\"\\n\");\n\t\tconst found = lines.some(\n\t\t\t(line) => line.split(\":\")[0]!.toUpperCase() === suffix.toUpperCase(),\n\t\t);\n\n\t\tif (found) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: customMessage || ERROR_CODES.PASSWORD_COMPROMISED,\n\t\t\t\tcode: \"PASSWORD_COMPROMISED\",\n\t\t\t});\n\t\t}\n\t} catch (error) {\n\t\tif (error instanceof APIError) throw error;\n\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\tmessage: \"Failed to check password. Please try again later.\",\n\t\t});\n\t}\n}\n\nexport interface HaveIBeenPwnedOptions {\n\tcustomPasswordCompromisedMessage?: string | undefined;\n\t/**\n\t * Paths to check for password\n\t *\n\t * @default [\"/sign-up/email\", \"/change-password\", \"/reset-password\"]\n\t */\n\tpaths?: string[];\n}\n\nexport const haveIBeenPwned = (options?: HaveIBeenPwnedOptions | undefined) => {\n\tconst paths = options?.paths || [\n\t\t\"/sign-up/email\",\n\t\t\"/change-password\",\n\t\t\"/reset-password\",\n\t];\n\n\treturn {\n\t\tid: \"haveIBeenPwned\",\n\t\tinit(ctx) {\n\t\t\treturn {\n\t\t\t\tcontext: {\n\t\t\t\t\tpassword: {\n\t\t\t\t\t\t...ctx.password,\n\t\t\t\t\t\tasync hash(password) {\n\t\t\t\t\t\t\tconst c = await getCurrentAuthContext();\n\t\t\t\t\t\t\tif (!c.path || !paths.includes(c.path)) {\n\t\t\t\t\t\t\t\treturn ctx.password.hash(password);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tawait checkPasswordCompromise(\n\t\t\t\t\t\t\t\tpassword,\n\t\t\t\t\t\t\t\toptions?.customPasswordCompromisedMessage,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\treturn ctx.password.hash(password);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\toptions,\n\t\t$ERROR_CODES: ERROR_CODES,\n\t} satisfies BetterAuthPlugin;\n};\n", "import type {\n\tBetterAuthOptions,\n\tGenericEndpointContext,\n} from \"@better-auth/core\";\nimport type { DBAdapter } from \"@better-auth/core/db/adapter\";\nimport type { Jwk, JwtOptions } from \"./types\";\n\nexport const getJwksAdapter = (\n\tadapter: DBAdapter<BetterAuthOptions>,\n\toptions?: JwtOptions,\n) => {\n\treturn {\n\t\tgetAllKeys: async (ctx: GenericEndpointContext) => {\n\t\t\tif (options?.adapter?.getJwks) {\n\t\t\t\treturn await options.adapter.getJwks(ctx);\n\t\t\t}\n\t\t\treturn await adapter.findMany<Jwk>({\n\t\t\t\tmodel: \"jwks\",\n\t\t\t});\n\t\t},\n\t\tgetLatestKey: async (ctx: GenericEndpointContext) => {\n\t\t\tif (options?.adapter?.getJwks) {\n\t\t\t\tconst keys = await options.adapter.getJwks(ctx);\n\t\t\t\treturn keys?.sort(\n\t\t\t\t\t(a, b) => b.createdAt.getTime() - a.createdAt.getTime(),\n\t\t\t\t)[0];\n\t\t\t}\n\t\t\tconst keys = await adapter.findMany<Jwk>({\n\t\t\t\tmodel: \"jwks\",\n\t\t\t});\n\t\t\treturn keys?.sort(\n\t\t\t\t(a, b) => b.createdAt.getTime() - a.createdAt.getTime(),\n\t\t\t)[0];\n\t\t},\n\t\tcreateJwk: async (ctx: GenericEndpointContext, webKey: Omit<Jwk, \"id\">) => {\n\t\t\tif (options?.adapter?.createJwk) {\n\t\t\t\treturn await options.adapter.createJwk(webKey, ctx);\n\t\t\t}\n\t\t\tconst jwk = await adapter.create<Omit<Jwk, \"id\">, Jwk>({\n\t\t\t\tmodel: \"jwks\",\n\t\t\t\tdata: {\n\t\t\t\t\t...webKey,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn jwk;\n\t\t},\n\t};\n};\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { exportJWK, generateKeyPair } from \"jose\";\nimport { symmetricEncrypt } from \"../../crypto\";\nimport type { TimeString } from \"../../utils/time\";\nimport { sec } from \"../../utils/time\";\nimport { getJwksAdapter } from \"./adapter\";\nimport type { Jwk, JwtOptions } from \"./types\";\n\n/**\n * Converts an expirationTime to ISO seconds expiration time (the format of JWT exp)\n *\n * See https://github.com/panva/jose/blob/main/src/lib/jwt_claims_set.ts#L245\n *\n * @param expirationTime - see options.jwt.expirationTime\n * @param iat - the iat time to consolidate on\n * @returns\n */\nexport function toExpJWT(\n\texpirationTime: number | Date | string,\n\tiat: number,\n): number {\n\tif (typeof expirationTime === \"number\") {\n\t\treturn expirationTime;\n\t} else if (expirationTime instanceof Date) {\n\t\treturn Math.floor(expirationTime.getTime() / 1000);\n\t} else {\n\t\treturn iat + sec(expirationTime as TimeString);\n\t}\n}\n\nexport async function generateExportedKeyPair(\n\toptions?: JwtOptions | undefined,\n) {\n\tconst { alg, ...cfg } = options?.jwks?.keyPairConfig ?? {\n\t\talg: \"EdDSA\",\n\t\tcrv: \"Ed25519\",\n\t};\n\tconst { publicKey, privateKey } = await generateKeyPair(alg, {\n\t\t...cfg,\n\t\textractable: true,\n\t});\n\n\tconst publicWebKey = await exportJWK(publicKey);\n\tconst privateWebKey = await exportJWK(privateKey);\n\n\treturn { publicWebKey, privateWebKey, alg, cfg };\n}\n\n/**\n * Creates a Jwk on the database\n *\n * @param ctx\n * @param options\n * @returns\n */\nexport async function createJwk(\n\tctx: GenericEndpointContext,\n\toptions?: JwtOptions | undefined,\n) {\n\tconst { publicWebKey, privateWebKey, alg, cfg } =\n\t\tawait generateExportedKeyPair(options);\n\n\tconst stringifiedPrivateWebKey = JSON.stringify(privateWebKey);\n\tconst privateKeyEncryptionEnabled =\n\t\t!options?.jwks?.disablePrivateKeyEncryption;\n\tlet jwk: Omit<Jwk, \"id\"> = {\n\t\talg,\n\t\t...(cfg && \"crv\" in cfg\n\t\t\t? {\n\t\t\t\t\tcrv: (cfg as { crv: (typeof jwk)[\"crv\"] }).crv,\n\t\t\t\t}\n\t\t\t: {}),\n\t\tpublicKey: JSON.stringify(publicWebKey),\n\t\tprivateKey: privateKeyEncryptionEnabled\n\t\t\t? JSON.stringify(\n\t\t\t\t\tawait symmetricEncrypt({\n\t\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\t\tdata: stringifiedPrivateWebKey,\n\t\t\t\t\t}),\n\t\t\t\t)\n\t\t\t: stringifiedPrivateWebKey,\n\t\tcreatedAt: new Date(),\n\t\t...(options?.jwks?.rotationInterval\n\t\t\t? {\n\t\t\t\t\texpiresAt: new Date(\n\t\t\t\t\t\tDate.now() + options.jwks.rotationInterval * 1000,\n\t\t\t\t\t),\n\t\t\t\t}\n\t\t\t: {}),\n\t};\n\n\tconst adapter = getJwksAdapter(ctx.context.adapter, options);\n\tconst key = await adapter.createJwk(ctx, jwk as Jwk);\n\n\treturn key;\n}\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { BetterAuthError } from \"@better-auth/core/error\";\nimport type { JWTPayload } from \"jose\";\nimport { importJWK, SignJWT } from \"jose\";\nimport { symmetricDecrypt } from \"../../crypto\";\nimport { getJwksAdapter } from \"./adapter\";\nimport type { JwtOptions } from \"./types\";\nimport { createJwk, toExpJWT } from \"./utils\";\n\ntype JWTPayloadWithOptional = {\n\t/**\n\t * JWT Issuer\n\t *\n\t * @see {@link https://www.rfc-editor.org/rfc/rfc7519#section-4.1.1 RFC7519#section-4.1.1}\n\t */\n\tiss?: string | undefined;\n\n\t/**\n\t * JWT Subject\n\t *\n\t * @see {@link https://www.rfc-editor.org/rfc/rfc7519#section-4.1.2 RFC7519#section-4.1.2}\n\t */\n\tsub?: string | undefined;\n\n\t/**\n\t * JWT Audience\n\t *\n\t * @see {@link https://www.rfc-editor.org/rfc/rfc7519#section-4.1.3 RFC7519#section-4.1.3}\n\t */\n\taud?: string | string[] | undefined;\n\n\t/**\n\t * JWT ID\n\t *\n\t * @see {@link https://www.rfc-editor.org/rfc/rfc7519#section-4.1.7 RFC7519#section-4.1.7}\n\t */\n\tjti?: string | undefined;\n\n\t/**\n\t * JWT Not Before\n\t *\n\t * @see {@link https://www.rfc-editor.org/rfc/rfc7519#section-4.1.5 RFC7519#section-4.1.5}\n\t */\n\tnbf?: number | undefined;\n\n\t/**\n\t * JWT Expiration Time\n\t *\n\t * @see {@link https://www.rfc-editor.org/rfc/rfc7519#section-4.1.4 RFC7519#section-4.1.4}\n\t */\n\texp?: number | undefined;\n\n\t/**\n\t * JWT Issued At\n\t *\n\t * @see {@link https://www.rfc-editor.org/rfc/rfc7519#section-4.1.6 RFC7519#section-4.1.6}\n\t */\n\tiat?: number | undefined;\n\n\t/** Any other JWT Claim Set member. */\n\t[propName: string]: unknown | undefined;\n};\n\nexport async function signJWT(\n\tctx: GenericEndpointContext,\n\tconfig: {\n\t\toptions?: JwtOptions | undefined;\n\t\tpayload: JWTPayloadWithOptional;\n\t},\n) {\n\tconst { options } = config;\n\tconst payload = config.payload as JWTPayload;\n\n\t// Iat\n\tconst nowSeconds = Math.floor(Date.now() / 1000);\n\tconst iat = payload.iat!;\n\n\t// Exp\n\tlet exp = payload.exp;\n\tconst defaultExp = toExpJWT(\n\t\toptions?.jwt?.expirationTime ?? \"15m\",\n\t\tiat ?? nowSeconds,\n\t);\n\texp = exp ?? defaultExp;\n\n\t// Nbf\n\tconst nbf = payload.nbf!;\n\n\t// Iss\n\tconst iss = payload.iss;\n\tconst defaultIss = options?.jwt?.issuer ?? ctx.context.options.baseURL!;\n\n\t// Aud\n\tconst aud = payload.aud;\n\tconst defaultAud = options?.jwt?.audience ?? ctx.context.options.baseURL!;\n\n\t// Custom/remote signing function\n\tif (options?.jwt?.sign) {\n\t\tconst jwtPayload = {\n\t\t\t...payload,\n\t\t\tiat,\n\t\t\texp,\n\t\t\tnbf,\n\t\t\tiss: iss ?? defaultIss,\n\t\t\taud: aud ?? defaultAud,\n\t\t};\n\t\treturn options.jwt.sign(jwtPayload);\n\t}\n\n\tconst adapter = getJwksAdapter(ctx.context.adapter, options);\n\tlet key = await adapter.getLatestKey(ctx);\n\tif (!key || (key.expiresAt && key.expiresAt < new Date())) {\n\t\tkey = await createJwk(ctx, options);\n\t}\n\tconst privateKeyEncryptionEnabled =\n\t\t!options?.jwks?.disablePrivateKeyEncryption;\n\n\tlet privateWebKey = privateKeyEncryptionEnabled\n\t\t? await symmetricDecrypt({\n\t\t\t\tkey: ctx.context.secret,\n\t\t\t\tdata: JSON.parse(key.privateKey),\n\t\t\t}).catch(() => {\n\t\t\t\tthrow new BetterAuthError(\n\t\t\t\t\t\"Failed to decrypt private key. Make sure the secret currently in use is the same as the one used to encrypt the private key. If you are using a different secret, either clean up your JWKS or disable private key encryption.\",\n\t\t\t\t);\n\t\t\t})\n\t\t: key.privateKey;\n\tconst alg = key.alg ?? options?.jwks?.keyPairConfig?.alg ?? \"EdDSA\";\n\tconst privateKey = await importJWK(JSON.parse(privateWebKey), alg);\n\n\tconst jwt = new SignJWT(payload)\n\t\t.setProtectedHeader({\n\t\t\talg,\n\t\t\tkid: key.id,\n\t\t})\n\t\t.setExpirationTime(exp)\n\t\t.setIssuer(iss ?? defaultIss)\n\t\t.setAudience(aud ?? defaultAud);\n\tif (iat) jwt.setIssuedAt(iat);\n\tif (payload.sub) jwt.setSubject(payload.sub);\n\tif (payload.nbf) jwt.setNotBefore(payload.nbf);\n\tif (payload.jti) jwt.setJti(payload.jti);\n\treturn await jwt.sign(privateKey);\n}\n\nexport async function getJwtToken(\n\tctx: GenericEndpointContext,\n\toptions?: JwtOptions | undefined,\n) {\n\tconst payload = !options?.jwt?.definePayload\n\t\t? ctx.context.session!.user\n\t\t: await options.jwt.definePayload(ctx.context.session!);\n\n\treturn await signJWT(ctx, {\n\t\toptions,\n\t\tpayload: {\n\t\t\tiat: Math.floor(Date.now() / 1000),\n\t\t\t...payload,\n\t\t\tsub:\n\t\t\t\t(await options?.jwt?.getSubject?.(ctx.context.session!)) ??\n\t\t\t\tctx.context.session!.user.id,\n\t\t},\n\t});\n}\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { getCurrentAuthContext } from \"@better-auth/core/context\";\nimport { base64 } from \"@better-auth/utils/base64\";\nimport type { JWTPayload } from \"jose\";\nimport { importJWK, jwtVerify } from \"jose\";\nimport { getJwksAdapter } from \"./adapter\";\nimport type { JwtOptions } from \"./types\";\n\n/**\n * Verify a JWT token using the JWKS public keys\n * Returns the payload if valid, null otherwise\n */\nexport async function verifyJWT<T extends JWTPayload = JWTPayload>(\n\ttoken: string,\n\toptions?: JwtOptions,\n): Promise<(T & Required<Pick<JWTPayload, \"sub\" | \"aud\">>) | null> {\n\tconst ctx = await getCurrentAuthContext();\n\ttry {\n\t\tconst parts = token.split(\".\");\n\t\tif (parts.length !== 3) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst headerStr = new TextDecoder().decode(base64.decode(parts[0]!));\n\t\tconst header = JSON.parse(headerStr);\n\t\tconst kid = header.kid;\n\n\t\tif (!kid) {\n\t\t\tctx.context.logger.debug(\"JWT missing kid in header\");\n\t\t\treturn null;\n\t\t}\n\n\t\t// Get all JWKS keys\n\t\tconst adapter = getJwksAdapter(ctx.context.adapter, options);\n\t\tconst keys = await adapter.getAllKeys(ctx as GenericEndpointContext);\n\n\t\tif (!keys || keys.length === 0) {\n\t\t\tctx.context.logger.debug(\"No JWKS keys available\");\n\t\t\treturn null;\n\t\t}\n\n\t\tconst key = keys.find((k) => k.id === kid);\n\t\tif (!key) {\n\t\t\tctx.context.logger.debug(`No JWKS key found for kid: ${kid}`);\n\t\t\treturn null;\n\t\t}\n\n\t\tconst publicKey = JSON.parse(key.publicKey);\n\t\tconst alg = key.alg ?? options?.jwks?.keyPairConfig?.alg ?? \"EdDSA\";\n\t\tconst cryptoKey = await importJWK(publicKey, alg);\n\n\t\tconst { payload } = await jwtVerify(token, cryptoKey, {\n\t\t\tissuer: options?.jwt?.issuer ?? ctx.context.options.baseURL,\n\t\t\taudience: options?.jwt?.audience ?? ctx.context.options.baseURL,\n\t\t});\n\n\t\tif (!payload.sub || !payload.aud) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn payload as T & Required<Pick<JWTPayload, \"sub\" | \"aud\">>;\n\t} catch (error) {\n\t\tctx.context.logger.debug(\"JWT verification failed\", error);\n\t\treturn null;\n\t}\n}\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\n\nexport const schema = {\n\tjwks: {\n\t\tfields: {\n\t\t\tpublicKey: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\tprivateKey: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\tcreatedAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\texpiresAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t},\n\t},\n} satisfies BetterAuthPluginDBSchema;\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport { BetterAuthError } from \"@better-auth/core/error\";\nimport type { JSONWebKeySet, JWTPayload } from \"jose\";\nimport * as z from \"zod\";\nimport { APIError, sessionMiddleware } from \"../../api\";\nimport { mergeSchema } from \"../../db/schema\";\nimport { getJwksAdapter } from \"./adapter\";\nimport { schema } from \"./schema\";\nimport { getJwtToken, signJWT } from \"./sign\";\nimport type { JwtOptions } from \"./types\";\nimport { createJwk } from \"./utils\";\nimport { verifyJWT as verifyJWTHelper } from \"./verify\";\n\nexport { signJWT } from \"./sign\";\nexport type * from \"./types\";\nexport { createJwk, generateExportedKeyPair, toExpJWT } from \"./utils\";\nexport { verifyJWT } from \"./verify\";\n\nconst signJWTBodySchema = z.object({\n\tpayload: z.record(z.string(), z.any()),\n\toverrideOptions: z.record(z.string(), z.any()).optional(),\n});\n\nconst verifyJWTBodySchema = z.object({\n\ttoken: z.string(),\n\tissuer: z.string().optional(),\n});\n\nexport const jwt = <O extends JwtOptions>(options?: O) => {\n\t// Remote url must be set when using signing function\n\tif (options?.jwt?.sign && !options.jwks?.remoteUrl) {\n\t\tthrow new BetterAuthError(\n\t\t\t\"jwks_config\",\n\t\t\t\"jwks.remoteUrl must be set when using jwt.sign\",\n\t\t);\n\t}\n\n\t// Alg is required to be specified when using remote url (needed in openid metadata)\n\tif (options?.jwks?.remoteUrl && !options.jwks?.keyPairConfig?.alg) {\n\t\tthrow new BetterAuthError(\n\t\t\t\"jwks_config\",\n\t\t\t\"must specify alg when using the oidc plugin and jwks.remoteUrl\",\n\t\t);\n\t}\n\n\tconst jwksPath = options?.jwks?.jwksPath ?? \"/jwks\";\n\tif (\n\t\ttypeof jwksPath !== \"string\" ||\n\t\tjwksPath.length === 0 ||\n\t\t!jwksPath.startsWith(\"/\") ||\n\t\tjwksPath.includes(\"..\")\n\t) {\n\t\tthrow new BetterAuthError(\n\t\t\t\"jwks_config\",\n\t\t\t\"jwksPath must be a non-empty string starting with '/' and not contain '..'\",\n\t\t);\n\t}\n\n\treturn {\n\t\tid: \"jwt\",\n\t\toptions: options as NoInfer<O>,\n\t\tendpoints: {\n\t\t\tgetJwks: createAuthEndpoint(\n\t\t\t\tjwksPath,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\toperationId: \"getJSONWebKeySet\",\n\t\t\t\t\t\t\tdescription: \"Get the JSON Web Key Set\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"JSON Web Key Set retrieved successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tkeys: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Array of public JSON Web Keys\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tkid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Key ID uniquely identifying the key, corresponds to the 'id' from the stored Jwk\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tkty: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Key type (e.g., 'RSA', 'EC', 'OKP')\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\talg: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Algorithm intended for use with the key (e.g., 'EdDSA', 'RS256')\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tuse: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Intended use of the public key (e.g., 'sig' for signature)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tenum: [\"sig\"],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tn: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Modulus for RSA keys (base64url-encoded)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\te: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Exponent for RSA keys (base64url-encoded)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcrv: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Curve name for elliptic curve keys (e.g., 'Ed25519', 'P-256')\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tx: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"X coordinate for elliptic curve keys (base64url-encoded)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ty: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Y coordinate for elliptic curve keys (base64url-encoded)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"kid\", \"kty\", \"alg\"],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"keys\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\t// Disables endpoint if using remote url strategy\n\t\t\t\t\tif (options?.jwks?.remoteUrl) {\n\t\t\t\t\t\tthrow new APIError(\"NOT_FOUND\");\n\t\t\t\t\t}\n\n\t\t\t\t\tconst adapter = getJwksAdapter(ctx.context.adapter, options);\n\n\t\t\t\t\tlet keySets = await adapter.getAllKeys(ctx);\n\n\t\t\t\t\tif (!keySets || keySets?.length === 0) {\n\t\t\t\t\t\tawait createJwk(ctx, options);\n\t\t\t\t\t\tkeySets = await adapter.getAllKeys(ctx);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!keySets?.length) {\n\t\t\t\t\t\tthrow new BetterAuthError(\n\t\t\t\t\t\t\t\"No key sets found. Make sure you have a key in your database.\",\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst now = Date.now();\n\t\t\t\t\tconst DEFAULT_GRACE_PERIOD = 60 * 60 * 24 * 30;\n\t\t\t\t\tconst gracePeriod =\n\t\t\t\t\t\t(options?.jwks?.gracePeriod ?? DEFAULT_GRACE_PERIOD) * 1000;\n\n\t\t\t\t\tconst keys = keySets.filter((key) => {\n\t\t\t\t\t\tif (!key.expiresAt) {\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn key.expiresAt.getTime() + gracePeriod > now;\n\t\t\t\t\t});\n\n\t\t\t\t\tconst keyPairConfig = options?.jwks?.keyPairConfig;\n\t\t\t\t\tconst defaultCrv = keyPairConfig\n\t\t\t\t\t\t? \"crv\" in keyPairConfig\n\t\t\t\t\t\t\t? (keyPairConfig as { crv: string }).crv\n\t\t\t\t\t\t\t: undefined\n\t\t\t\t\t\t: undefined;\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tkeys: keys.map((keySet) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\talg: keySet.alg ?? options?.jwks?.keyPairConfig?.alg ?? \"EdDSA\",\n\t\t\t\t\t\t\t\tcrv: keySet.crv ?? defaultCrv,\n\t\t\t\t\t\t\t\t...JSON.parse(keySet.publicKey),\n\t\t\t\t\t\t\t\tkid: keySet.id,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}),\n\t\t\t\t\t} satisfies JSONWebKeySet as JSONWebKeySet);\n\t\t\t\t},\n\t\t\t),\n\n\t\t\tgetToken: createAuthEndpoint(\n\t\t\t\t\"/token\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\trequireHeaders: true,\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\toperationId: \"getJSONWebToken\",\n\t\t\t\t\t\t\tdescription: \"Get a JWT token\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst jwt = await getJwtToken(ctx, options);\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\ttoken: jwt,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\tsignJWT: createAuthEndpoint(\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t$Infer: {\n\t\t\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\t\t\tpayload: JWTPayload;\n\t\t\t\t\t\t\t\toverrideOptions?: JwtOptions | undefined;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tbody: signJWTBodySchema,\n\t\t\t\t},\n\t\t\t\tasync (c) => {\n\t\t\t\t\tconst jwt = await signJWT(c, {\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\t...options,\n\t\t\t\t\t\t\t...c.body.overrideOptions,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tpayload: c.body.payload,\n\t\t\t\t\t});\n\t\t\t\t\treturn c.json({ token: jwt });\n\t\t\t\t},\n\t\t\t),\n\t\t\tverifyJWT: createAuthEndpoint(\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t$Infer: {\n\t\t\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\t\t\ttoken: string;\n\t\t\t\t\t\t\t\tissuer?: string;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tresponse: {} as {\n\t\t\t\t\t\t\t\tpayload: {\n\t\t\t\t\t\t\t\t\tsub: string;\n\t\t\t\t\t\t\t\t\taud: string;\n\t\t\t\t\t\t\t\t\t[key: string]: any;\n\t\t\t\t\t\t\t\t} | null;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tbody: verifyJWTBodySchema,\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst overrideOptions = ctx.body.issuer\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t...options,\n\t\t\t\t\t\t\t\tjwt: {\n\t\t\t\t\t\t\t\t\t...options?.jwt,\n\t\t\t\t\t\t\t\t\tissuer: ctx.body.issuer,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: options;\n\n\t\t\t\t\tconst payload = await verifyJWTHelper(\n\t\t\t\t\t\tctx.body.token,\n\t\t\t\t\t\toverrideOptions,\n\t\t\t\t\t);\n\n\t\t\t\t\treturn ctx.json({ payload });\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn context.path === \"/get-session\";\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tif (options?.disableSettingJwtHeader) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst session = ctx.context.session || ctx.context.newSession;\n\t\t\t\t\t\tif (session && session.session) {\n\t\t\t\t\t\t\tconst jwt = await getJwtToken(ctx, options);\n\t\t\t\t\t\t\tconst exposedHeaders =\n\t\t\t\t\t\t\t\tctx.context.responseHeaders?.get(\n\t\t\t\t\t\t\t\t\t\"access-control-expose-headers\",\n\t\t\t\t\t\t\t\t) || \"\";\n\t\t\t\t\t\t\tconst headersSet = new Set(\n\t\t\t\t\t\t\t\texposedHeaders\n\t\t\t\t\t\t\t\t\t.split(\",\")\n\t\t\t\t\t\t\t\t\t.map((header) => header.trim())\n\t\t\t\t\t\t\t\t\t.filter(Boolean),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\theadersSet.add(\"set-auth-jwt\");\n\t\t\t\t\t\t\tctx.setHeader(\"set-auth-jwt\", jwt);\n\t\t\t\t\t\t\tctx.setHeader(\n\t\t\t\t\t\t\t\t\"Access-Control-Expose-Headers\",\n\t\t\t\t\t\t\t\tArray.from(headersSet).join(\", \"),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tschema: mergeSchema(schema, options?.schema),\n\t} satisfies BetterAuthPlugin;\n};\n\nexport { getJwtToken };\n", "import type {\n\tBetterAuthPlugin,\n\tGenericEndpointContext,\n} from \"@better-auth/core\";\nimport { createAuthMiddleware } from \"@better-auth/core/api\";\n\n/**\n * Configuration for tracking different authentication methods\n */\nexport interface LastLoginMethodOptions {\n\t/**\n\t * Name of the cookie to store the last login method\n\t * @default \"better-auth.last_used_login_method\"\n\t */\n\tcookieName?: string | undefined;\n\t/**\n\t * Cookie expiration time in seconds\n\t * @default 2592000 (30 days)\n\t */\n\tmaxAge?: number | undefined;\n\t/**\n\t * Custom method to resolve the last login method\n\t * @param ctx - The context from the hook\n\t * @returns The last login method\n\t */\n\tcustomResolveMethod?:\n\t\t| ((ctx: GenericEndpointContext) => string | null)\n\t\t| undefined;\n\t/**\n\t * Store the last login method in the database. This will create a new field in the user table.\n\t * @default false\n\t */\n\tstoreInDatabase?: boolean | undefined;\n\t/**\n\t * Custom schema for the plugin\n\t * @default undefined\n\t */\n\tschema?:\n\t\t| {\n\t\t\t\tuser?: {\n\t\t\t\t\tlastLoginMethod?: string;\n\t\t\t\t};\n\t\t  }\n\t\t| undefined;\n}\n\n/**\n * Plugin to track the last used login method\n */\nexport const lastLoginMethod = <O extends LastLoginMethodOptions>(\n\tuserConfig?: O | undefined,\n) => {\n\tconst paths = [\n\t\t\"/callback/:id\",\n\t\t\"/oauth2/callback/:providerId\",\n\t\t\"/sign-in/email\",\n\t\t\"/sign-up/email\",\n\t];\n\n\tconst defaultResolveMethod = (ctx: GenericEndpointContext) => {\n\t\tif (paths.includes(ctx.path)) {\n\t\t\treturn (\n\t\t\t\tctx.params?.id || ctx.params?.providerId || ctx.path.split(\"/\").pop()\n\t\t\t);\n\t\t}\n\t\tif (ctx.path.includes(\"siwe\")) return \"siwe\";\n\t\tif (ctx.path.includes(\"/passkey/verify-authentication\")) return \"passkey\";\n\t\treturn null;\n\t};\n\n\tconst config = {\n\t\tcookieName: \"better-auth.last_used_login_method\",\n\t\tmaxAge: 60 * 60 * 24 * 30,\n\t\t...userConfig,\n\t} satisfies LastLoginMethodOptions;\n\n\treturn {\n\t\tid: \"last-login-method\",\n\t\tinit(ctx) {\n\t\t\treturn {\n\t\t\t\toptions: {\n\t\t\t\t\tdatabaseHooks: {\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tcreate: {\n\t\t\t\t\t\t\t\tasync before(user, context) {\n\t\t\t\t\t\t\t\t\tif (!config.storeInDatabase) return;\n\t\t\t\t\t\t\t\t\tif (!context) return;\n\t\t\t\t\t\t\t\t\tconst lastUsedLoginMethod =\n\t\t\t\t\t\t\t\t\t\tconfig.customResolveMethod?.(context) ??\n\t\t\t\t\t\t\t\t\t\tdefaultResolveMethod(context);\n\t\t\t\t\t\t\t\t\tif (lastUsedLoginMethod) {\n\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\t\t\t\t...user,\n\t\t\t\t\t\t\t\t\t\t\t\tlastLoginMethod: lastUsedLoginMethod,\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\tcreate: {\n\t\t\t\t\t\t\t\tasync after(session, context) {\n\t\t\t\t\t\t\t\t\tif (!config.storeInDatabase) return;\n\t\t\t\t\t\t\t\t\tif (!context) return;\n\t\t\t\t\t\t\t\t\tconst lastUsedLoginMethod =\n\t\t\t\t\t\t\t\t\t\tconfig.customResolveMethod?.(context) ??\n\t\t\t\t\t\t\t\t\t\tdefaultResolveMethod(context);\n\t\t\t\t\t\t\t\t\tif (lastUsedLoginMethod && session?.userId) {\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\tawait ctx.internalAdapter.updateUser(session.userId, {\n\t\t\t\t\t\t\t\t\t\t\t\tlastLoginMethod: lastUsedLoginMethod,\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\t\t\tctx.logger.error(\n\t\t\t\t\t\t\t\t\t\t\t\t\"Failed to update lastLoginMethod\",\n\t\t\t\t\t\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher() {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst lastUsedLoginMethod =\n\t\t\t\t\t\t\tconfig.customResolveMethod?.(ctx) ?? defaultResolveMethod(ctx);\n\t\t\t\t\t\tif (lastUsedLoginMethod) {\n\t\t\t\t\t\t\tconst setCookie = ctx.context.responseHeaders?.get(\"set-cookie\");\n\t\t\t\t\t\t\tconst sessionTokenName =\n\t\t\t\t\t\t\t\tctx.context.authCookies.sessionToken.name;\n\t\t\t\t\t\t\tconst hasSessionToken =\n\t\t\t\t\t\t\t\tsetCookie && setCookie.includes(sessionTokenName);\n\t\t\t\t\t\t\tif (hasSessionToken) {\n\t\t\t\t\t\t\t\t// Inherit cookie attributes from Better Auth's centralized cookie system\n\t\t\t\t\t\t\t\t// This ensures consistency with cross-origin, cross-subdomain, and security settings\n\t\t\t\t\t\t\t\tconst cookieAttributes = {\n\t\t\t\t\t\t\t\t\t...ctx.context.authCookies.sessionToken.options,\n\t\t\t\t\t\t\t\t\tmaxAge: config.maxAge,\n\t\t\t\t\t\t\t\t\thttpOnly: false, // Override: plugin cookies are not httpOnly\n\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\tctx.setCookie(\n\t\t\t\t\t\t\t\t\tconfig.cookieName,\n\t\t\t\t\t\t\t\t\tlastUsedLoginMethod,\n\t\t\t\t\t\t\t\t\tcookieAttributes,\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tschema: (config.storeInDatabase\n\t\t\t? {\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tfields: {\n\t\t\t\t\t\t\tlastLoginMethod: {\n\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\tinput: false,\n\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\tfieldName:\n\t\t\t\t\t\t\t\t\tconfig.schema?.user?.lastLoginMethod || \"lastLoginMethod\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t: undefined) as O[\"storeInDatabase\"] extends true\n\t\t\t? {\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tfields: {\n\t\t\t\t\t\t\tlastLoginMethod: {\n\t\t\t\t\t\t\t\ttype: \"string\";\n\t\t\t\t\t\t\t\trequired: false;\n\t\t\t\t\t\t\t\tinput: false;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t};\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t: undefined,\n\t\toptions: userConfig as NoInfer<O>,\n\t} satisfies BetterAuthPlugin;\n};\n", "import { base64Url } from \"@better-auth/utils/base64\";\nimport { createHash } from \"@better-auth/utils/hash\";\n\nexport const defaultKeyHasher = async (otp: string) => {\n\tconst hash = await createHash(\"SHA-256\").digest(\n\t\tnew TextEncoder().encode(otp),\n\t);\n\tconst hashed = base64Url.encode(new Uint8Array(hash), {\n\t\tpadding: false,\n\t});\n\treturn hashed;\n};\n", "import type {\n\tAwaitable,\n\tBetterAuthPlugin,\n\tGenericEndpointContext,\n} from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport * as z from \"zod\";\nimport { originCheck } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { generateRandomString } from \"../../crypto\";\nimport { defaultKeyHasher } from \"./utils\";\n\nexport interface MagicLinkOptions {\n\t/**\n\t * Time in seconds until the magic link expires.\n\t * @default (60 * 5) // 5 minutes\n\t */\n\texpiresIn?: number | undefined;\n\t/**\n\t * Send magic link implementation.\n\t */\n\tsendMagicLink: (\n\t\tdata: {\n\t\t\temail: string;\n\t\t\turl: string;\n\t\t\ttoken: string;\n\t\t},\n\t\tctx?: GenericEndpointContext | undefined,\n\t) => Awaitable<void>;\n\t/**\n\t * Disable sign up if user is not found.\n\t *\n\t * @default false\n\t */\n\tdisableSignUp?: boolean | undefined;\n\t/**\n\t * Rate limit configuration.\n\t *\n\t * @default {\n\t *  window: 60,\n\t *  max: 5,\n\t * }\n\t */\n\trateLimit?:\n\t\t| {\n\t\t\t\twindow: number;\n\t\t\t\tmax: number;\n\t\t  }\n\t\t| undefined;\n\t/**\n\t * Custom function to generate a token\n\t */\n\tgenerateToken?: ((email: string) => Awaitable<string>) | undefined;\n\n\t/**\n\t * This option allows you to configure how the token is stored in your database.\n\t * Note: This will not affect the token that's sent, it will only affect the token stored in your database.\n\t *\n\t * @default \"plain\"\n\t */\n\tstoreToken?:\n\t\t| (\n\t\t\t\t| \"plain\"\n\t\t\t\t| \"hashed\"\n\t\t\t\t| { type: \"custom-hasher\"; hash: (token: string) => Promise<string> }\n\t\t  )\n\t\t| undefined;\n}\n\nconst signInMagicLinkBodySchema = z.object({\n\temail: z.email().meta({\n\t\tdescription: \"Email address to send the magic link\",\n\t}),\n\tname: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'User display name. Only used if the user is registering for the first time. Eg: \"my-name\"',\n\t\t})\n\t\t.optional(),\n\tcallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"URL to redirect after magic link verification\",\n\t\t})\n\t\t.optional(),\n\tnewUserCallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"URL to redirect after new user signup. Only used if the user is registering for the first time.\",\n\t\t})\n\t\t.optional(),\n\terrorCallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"URL to redirect after error.\",\n\t\t})\n\t\t.optional(),\n});\nconst magicLinkVerifyQuerySchema = z.object({\n\ttoken: z.string().meta({\n\t\tdescription: \"Verification token\",\n\t}),\n\tcallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'URL to redirect after magic link verification, if not provided the user will be redirected to the root URL. Eg: \"/dashboard\"',\n\t\t})\n\t\t.optional(),\n\terrorCallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"URL to redirect after error.\",\n\t\t})\n\t\t.optional(),\n\tnewUserCallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"URL to redirect after new user signup. Only used if the user is registering for the first time.\",\n\t\t})\n\t\t.optional(),\n});\nexport const magicLink = (options: MagicLinkOptions) => {\n\tconst opts = {\n\t\tstoreToken: \"plain\",\n\t\t...options,\n\t} satisfies MagicLinkOptions;\n\n\tasync function storeToken(ctx: GenericEndpointContext, token: string) {\n\t\tif (opts.storeToken === \"hashed\") {\n\t\t\treturn await defaultKeyHasher(token);\n\t\t}\n\t\tif (\n\t\t\ttypeof opts.storeToken === \"object\" &&\n\t\t\t\"type\" in opts.storeToken &&\n\t\t\topts.storeToken.type === \"custom-hasher\"\n\t\t) {\n\t\t\treturn await opts.storeToken.hash(token);\n\t\t}\n\t\treturn token;\n\t}\n\n\treturn {\n\t\tid: \"magic-link\",\n\t\tendpoints: {\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/sign-in/magic-link`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.signInMagicLink`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.signIn.magicLink`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/sign-in#api-method-sign-in-magic-link)\n\t\t\t */\n\t\t\tsignInMagicLink: createAuthEndpoint(\n\t\t\t\t\"/sign-in/magic-link\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\trequireHeaders: true,\n\t\t\t\t\tbody: signInMagicLinkBodySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\toperationId: \"signInWithMagicLink\",\n\t\t\t\t\t\t\tdescription: \"Sign in with magic link\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst { email } = ctx.body;\n\n\t\t\t\t\tconst verificationToken = opts?.generateToken\n\t\t\t\t\t\t? await opts.generateToken(email)\n\t\t\t\t\t\t: generateRandomString(32, \"a-z\", \"A-Z\");\n\t\t\t\t\tconst storedToken = await storeToken(ctx, verificationToken);\n\t\t\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\t\t\tidentifier: storedToken,\n\t\t\t\t\t\tvalue: JSON.stringify({ email, name: ctx.body.name }),\n\t\t\t\t\t\texpiresAt: new Date(Date.now() + (opts.expiresIn || 60 * 5) * 1000),\n\t\t\t\t\t});\n\t\t\t\t\tconst realBaseURL = new URL(ctx.context.baseURL);\n\t\t\t\t\tconst pathname =\n\t\t\t\t\t\trealBaseURL.pathname === \"/\" ? \"\" : realBaseURL.pathname;\n\t\t\t\t\tconst basePath = pathname ? \"\" : ctx.context.options.basePath || \"\";\n\t\t\t\t\tconst url = new URL(\n\t\t\t\t\t\t`${pathname}${basePath}/magic-link/verify`,\n\t\t\t\t\t\trealBaseURL.origin,\n\t\t\t\t\t);\n\t\t\t\t\turl.searchParams.set(\"token\", verificationToken);\n\t\t\t\t\turl.searchParams.set(\"callbackURL\", ctx.body.callbackURL || \"/\");\n\t\t\t\t\tif (ctx.body.newUserCallbackURL) {\n\t\t\t\t\t\turl.searchParams.set(\n\t\t\t\t\t\t\t\"newUserCallbackURL\",\n\t\t\t\t\t\t\tctx.body.newUserCallbackURL,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif (ctx.body.errorCallbackURL) {\n\t\t\t\t\t\turl.searchParams.set(\"errorCallbackURL\", ctx.body.errorCallbackURL);\n\t\t\t\t\t}\n\t\t\t\t\tawait options.sendMagicLink(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\temail,\n\t\t\t\t\t\t\turl: url.toString(),\n\t\t\t\t\t\t\ttoken: verificationToken,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tctx,\n\t\t\t\t\t);\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tstatus: true,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * GET `/magic-link/verify`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.magicLinkVerify`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.magicLink.verify`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/magic-link#api-method-magic-link-verify)\n\t\t\t */\n\t\t\tmagicLinkVerify: createAuthEndpoint(\n\t\t\t\t\"/magic-link/verify\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tquery: magicLinkVerifyQuerySchema,\n\t\t\t\t\tuse: [\n\t\t\t\t\t\toriginCheck((ctx) => {\n\t\t\t\t\t\t\treturn ctx.query.callbackURL\n\t\t\t\t\t\t\t\t? decodeURIComponent(ctx.query.callbackURL)\n\t\t\t\t\t\t\t\t: \"/\";\n\t\t\t\t\t\t}),\n\t\t\t\t\t\toriginCheck((ctx) => {\n\t\t\t\t\t\t\treturn ctx.query.newUserCallbackURL\n\t\t\t\t\t\t\t\t? decodeURIComponent(ctx.query.newUserCallbackURL)\n\t\t\t\t\t\t\t\t: \"/\";\n\t\t\t\t\t\t}),\n\t\t\t\t\t\toriginCheck((ctx) => {\n\t\t\t\t\t\t\treturn ctx.query.errorCallbackURL\n\t\t\t\t\t\t\t\t? decodeURIComponent(ctx.query.errorCallbackURL)\n\t\t\t\t\t\t\t\t: \"/\";\n\t\t\t\t\t\t}),\n\t\t\t\t\t],\n\t\t\t\t\trequireHeaders: true,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\toperationId: \"verifyMagicLink\",\n\t\t\t\t\t\t\tdescription: \"Verify magic link\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst token = ctx.query.token;\n\t\t\t\t\t// If the first argument provides the origin, it will ignore the second argument of `new URL`.\n\t\t\t\t\t// new URL(\"http://localhost:3001/hello\", \"http://localhost:3000\").toString()\n\t\t\t\t\t// Returns http://localhost:3001/hello\n\t\t\t\t\tconst callbackURL = new URL(\n\t\t\t\t\t\tctx.query.callbackURL\n\t\t\t\t\t\t\t? decodeURIComponent(ctx.query.callbackURL)\n\t\t\t\t\t\t\t: \"/\",\n\t\t\t\t\t\tctx.context.baseURL,\n\t\t\t\t\t).toString();\n\t\t\t\t\tconst errorCallbackURL = new URL(\n\t\t\t\t\t\tctx.query.errorCallbackURL\n\t\t\t\t\t\t\t? decodeURIComponent(ctx.query.errorCallbackURL)\n\t\t\t\t\t\t\t: callbackURL,\n\t\t\t\t\t\tctx.context.baseURL,\n\t\t\t\t\t);\n\n\t\t\t\t\tfunction redirectWithError(error: string): never {\n\t\t\t\t\t\terrorCallbackURL.searchParams.set(\"error\", error);\n\t\t\t\t\t\tthrow ctx.redirect(errorCallbackURL.toString());\n\t\t\t\t\t}\n\n\t\t\t\t\tconst newUserCallbackURL = new URL(\n\t\t\t\t\t\tctx.query.newUserCallbackURL\n\t\t\t\t\t\t\t? decodeURIComponent(ctx.query.newUserCallbackURL)\n\t\t\t\t\t\t\t: callbackURL,\n\t\t\t\t\t\tctx.context.baseURL,\n\t\t\t\t\t).toString();\n\t\t\t\t\tconst storedToken = await storeToken(ctx, token);\n\t\t\t\t\tconst tokenValue =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t\t\tstoredToken,\n\t\t\t\t\t\t);\n\t\t\t\t\tif (!tokenValue) {\n\t\t\t\t\t\tredirectWithError(\"INVALID_TOKEN\");\n\t\t\t\t\t}\n\t\t\t\t\tif (tokenValue.expiresAt < new Date()) {\n\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\t\ttokenValue.id,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tredirectWithError(\"EXPIRED_TOKEN\");\n\t\t\t\t\t}\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\ttokenValue.id,\n\t\t\t\t\t);\n\t\t\t\t\tconst { email, name } = JSON.parse(tokenValue.value) as {\n\t\t\t\t\t\temail: string;\n\t\t\t\t\t\tname?: string | undefined;\n\t\t\t\t\t};\n\t\t\t\t\tlet isNewUser = false;\n\t\t\t\t\tlet user = await ctx.context.internalAdapter\n\t\t\t\t\t\t.findUserByEmail(email)\n\t\t\t\t\t\t.then((res) => res?.user);\n\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tif (!opts.disableSignUp) {\n\t\t\t\t\t\t\tconst newUser = await ctx.context.internalAdapter.createUser({\n\t\t\t\t\t\t\t\temail: email,\n\t\t\t\t\t\t\t\temailVerified: true,\n\t\t\t\t\t\t\t\tname: name || \"\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tisNewUser = true;\n\t\t\t\t\t\t\tuser = newUser;\n\t\t\t\t\t\t\tif (!user) {\n\t\t\t\t\t\t\t\tredirectWithError(\"failed_to_create_user\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tredirectWithError(\"new_user_signup_disabled\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!user.emailVerified) {\n\t\t\t\t\t\tuser = await ctx.context.internalAdapter.updateUser(user.id, {\n\t\t\t\t\t\t\temailVerified: true,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\tuser.id,\n\t\t\t\t\t);\n\n\t\t\t\t\tif (!session) {\n\t\t\t\t\t\tredirectWithError(\"failed_to_create_session\");\n\t\t\t\t\t}\n\n\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\tsession,\n\t\t\t\t\t\tuser,\n\t\t\t\t\t});\n\t\t\t\t\tif (!ctx.query.callbackURL) {\n\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\ttoken: session.token,\n\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\t\t\temailVerified: user.emailVerified,\n\t\t\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t\t\t\tcreatedAt: user.createdAt,\n\t\t\t\t\t\t\t\tupdatedAt: user.updatedAt,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (isNewUser) {\n\t\t\t\t\t\tthrow ctx.redirect(newUserCallbackURL);\n\t\t\t\t\t}\n\t\t\t\t\tthrow ctx.redirect(callbackURL);\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\trateLimit: [\n\t\t\t{\n\t\t\t\tpathMatcher(path) {\n\t\t\t\t\treturn (\n\t\t\t\t\t\tpath.startsWith(\"/sign-in/magic-link\") ||\n\t\t\t\t\t\tpath.startsWith(\"/magic-link/verify\")\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t\twindow: opts.rateLimit?.window || 60,\n\t\t\t\tmax: opts.rateLimit?.max || 5,\n\t\t\t},\n\t\t],\n\t\toptions,\n\t} satisfies BetterAuthPlugin;\n};\n", "import { APIError } from \"better-call\";\n\nclass OIDCProviderError extends APIError {}\n\nexport class InvalidRequest extends OIDCProviderError {\n\tconstructor(error_description: string, error_detail?: string) {\n\t\tsuper(\"BAD_REQUEST\", {\n\t\t\tmessage: \"invalid_request\",\n\t\t\terror_description,\n\t\t\terror_detail,\n\t\t});\n\t}\n}\n", "import { InvalidRequest } from \"../error\";\n\nexport type AuthorizePrompt = \"login\" | \"consent\" | \"select_account\" | \"none\";\nexport type AuthorizePromptSet = ReadonlySet<AuthorizePrompt>;\n\n/**\n * Parse space-separated prompt string into a set of prompts\n *\n * @param prompt\n */\nexport function parsePrompt(prompt: string) {\n\tconst prompts = prompt.split(\" \").map((p) => p.trim());\n\tconst set = new Set<AuthorizePrompt>();\n\tfor (const p of prompts) {\n\t\tif (\n\t\t\tp === \"login\" ||\n\t\t\tp === \"consent\" ||\n\t\t\tp === \"select_account\" ||\n\t\t\tp === \"none\"\n\t\t) {\n\t\t\tset.add(p);\n\t\t}\n\t}\n\n\tif (set.has(\"none\") && set.size > 1) {\n\t\tthrow new InvalidRequest(\"prompt none must only be used alone\");\n\t}\n\n\treturn new Set(set) as AuthorizePromptSet;\n}\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { APIError } from \"better-call\";\nimport { getSessionFromCtx } from \"../../api\";\nimport { generateRandomString } from \"../../crypto\";\nimport { getClient } from \"./index\";\nimport type { AuthorizationQuery, OIDCOptions } from \"./types\";\nimport { parsePrompt } from \"./utils/prompt\";\n\nfunction formatErrorURL(url: string, error: string, description: string) {\n\treturn `${\n\t\turl.includes(\"?\") ? \"&\" : \"?\"\n\t}error=${error}&error_description=${description}`;\n}\n\nfunction getErrorURL(\n\tctx: GenericEndpointContext,\n\terror: string,\n\tdescription: string,\n) {\n\tconst baseURL =\n\t\tctx.context.options.onAPIError?.errorURL || `${ctx.context.baseURL}/error`;\n\tconst formattedURL = formatErrorURL(baseURL, error, description);\n\treturn formattedURL;\n}\n\nexport async function authorize(\n\tctx: GenericEndpointContext,\n\toptions: OIDCOptions,\n) {\n\tconst handleRedirect = (url: string) => {\n\t\tconst fromFetch = ctx.request?.headers.get(\"sec-fetch-mode\") === \"cors\";\n\t\tif (fromFetch) {\n\t\t\treturn ctx.json({\n\t\t\t\tredirect: true,\n\t\t\t\turl,\n\t\t\t});\n\t\t} else {\n\t\t\tthrow ctx.redirect(url);\n\t\t}\n\t};\n\n\tconst opts = {\n\t\tcodeExpiresIn: 600,\n\t\tdefaultScope: \"openid\",\n\t\t...options,\n\t\tscopes: [\n\t\t\t\"openid\",\n\t\t\t\"profile\",\n\t\t\t\"email\",\n\t\t\t\"offline_access\",\n\t\t\t...(options?.scopes || []),\n\t\t],\n\t};\n\tif (!ctx.request) {\n\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\terror_description: \"request not found\",\n\t\t\terror: \"invalid_request\",\n\t\t});\n\t}\n\tconst session = await getSessionFromCtx(ctx);\n\tif (!session) {\n\t\t// Handle prompt=none per OIDC spec - must return error instead of redirecting\n\t\tconst query = ctx.query as AuthorizationQuery;\n\t\tconst promptSet = parsePrompt(query.prompt ?? \"\");\n\t\tif (promptSet.has(\"none\") && query.redirect_uri) {\n\t\t\treturn handleRedirect(\n\t\t\t\tformatErrorURL(\n\t\t\t\t\tquery.redirect_uri,\n\t\t\t\t\t\"login_required\",\n\t\t\t\t\t\"Authentication required but prompt is none\",\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\n\t\t/**\n\t\t * If the user is not logged in, we need to redirect them to the\n\t\t * login page.\n\t\t */\n\t\tawait ctx.setSignedCookie(\n\t\t\t\"oidc_login_prompt\",\n\t\t\tJSON.stringify(ctx.query),\n\t\t\tctx.context.secret,\n\t\t\t{\n\t\t\t\tmaxAge: 600,\n\t\t\t\tpath: \"/\",\n\t\t\t\tsameSite: \"lax\",\n\t\t\t},\n\t\t);\n\t\tconst queryFromURL = ctx.request.url?.split(\"?\")[1]!;\n\t\treturn handleRedirect(`${options.loginPage}?${queryFromURL}`);\n\t}\n\n\tconst query = ctx.query as AuthorizationQuery;\n\tif (!query.client_id) {\n\t\tconst errorURL = getErrorURL(\n\t\t\tctx,\n\t\t\t\"invalid_client\",\n\t\t\t\"client_id is required\",\n\t\t);\n\t\tthrow ctx.redirect(errorURL);\n\t}\n\n\tif (!query.response_type) {\n\t\tconst errorURL = getErrorURL(\n\t\t\tctx,\n\t\t\t\"invalid_request\",\n\t\t\t\"response_type is required\",\n\t\t);\n\t\tthrow ctx.redirect(errorURL);\n\t}\n\n\tconst client = await getClient(\n\t\tctx.query.client_id,\n\t\toptions.trustedClients || [],\n\t);\n\tif (!client) {\n\t\tconst errorURL = getErrorURL(\n\t\t\tctx,\n\t\t\t\"invalid_client\",\n\t\t\t\"client_id is required\",\n\t\t);\n\t\tthrow ctx.redirect(errorURL);\n\t}\n\tconst redirectURI = client.redirectUrls.find(\n\t\t(url) => url === ctx.query.redirect_uri,\n\t);\n\n\tif (!redirectURI || !query.redirect_uri) {\n\t\t/**\n\t\t * show UI error here warning the user that the redirect URI is invalid\n\t\t */\n\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\tmessage: \"Invalid redirect URI\",\n\t\t});\n\t}\n\tif (client.disabled) {\n\t\tconst errorURL = getErrorURL(ctx, \"client_disabled\", \"client is disabled\");\n\t\tthrow ctx.redirect(errorURL);\n\t}\n\n\tif (query.response_type !== \"code\") {\n\t\tconst errorURL = getErrorURL(\n\t\t\tctx,\n\t\t\t\"unsupported_response_type\",\n\t\t\t\"unsupported response type\",\n\t\t);\n\t\tthrow ctx.redirect(errorURL);\n\t}\n\n\tconst requestScope =\n\t\tquery.scope?.split(\" \").filter((s) => s) ||\n\t\topts.defaultScope?.split(\" \") ||\n\t\t[];\n\tconst invalidScopes = requestScope.filter((scope) => {\n\t\treturn !opts.scopes.includes(scope);\n\t});\n\tif (invalidScopes.length) {\n\t\treturn handleRedirect(\n\t\t\tformatErrorURL(\n\t\t\t\tquery.redirect_uri,\n\t\t\t\t\"invalid_scope\",\n\t\t\t\t`The following scopes are invalid: ${invalidScopes.join(\", \")}`,\n\t\t\t),\n\t\t);\n\t}\n\n\tif (\n\t\t(!query.code_challenge || !query.code_challenge_method) &&\n\t\toptions.requirePKCE\n\t) {\n\t\treturn handleRedirect(\n\t\t\tformatErrorURL(query.redirect_uri, \"invalid_request\", \"pkce is required\"),\n\t\t);\n\t}\n\n\tif (!query.code_challenge_method) {\n\t\tquery.code_challenge_method = \"plain\";\n\t}\n\n\tif (\n\t\t![\n\t\t\t\"s256\",\n\t\t\toptions.allowPlainCodeChallengeMethod ? \"plain\" : \"s256\",\n\t\t].includes(query.code_challenge_method?.toLowerCase() || \"\")\n\t) {\n\t\treturn handleRedirect(\n\t\t\tformatErrorURL(\n\t\t\t\tquery.redirect_uri,\n\t\t\t\t\"invalid_request\",\n\t\t\t\t\"invalid code_challenge method\",\n\t\t\t),\n\t\t);\n\t}\n\n\tconst code = generateRandomString(32, \"a-z\", \"A-Z\", \"0-9\");\n\tconst codeExpiresInMs = opts.codeExpiresIn! * 1000;\n\tconst expiresAt = new Date(Date.now() + codeExpiresInMs);\n\n\t// Determine if consent is required\n\t// Consent is ALWAYS required unless:\n\t// 1. The client is trusted (skipConsent = true)\n\t// 2. The user has already consented and prompt is not \"consent\"\n\tconst skipConsentForTrustedClient = client.skipConsent;\n\tconst hasAlreadyConsented = await ctx.context.adapter\n\t\t.findOne<{\n\t\t\tconsentGiven: boolean;\n\t\t\tscopes: string;\n\t\t}>({\n\t\t\tmodel: \"oauthConsent\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"clientId\",\n\t\t\t\t\tvalue: client.clientId,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\tvalue: session.user.id,\n\t\t\t\t},\n\t\t\t],\n\t\t})\n\t\t.then((res) => {\n\t\t\tif (!res?.consentGiven) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst consentedScopes = res.scopes ? res.scopes.split(\" \") : [];\n\t\t\tconst hasConsented = requestScope.every((scope) =>\n\t\t\t\tconsentedScopes.includes(scope),\n\t\t\t);\n\t\t\treturn hasConsented;\n\t\t});\n\n\tconst promptSet = parsePrompt(query.prompt ?? \"\");\n\n\t// Handle prompt=none per OIDC spec 3.1.2.1\n\t// The Authorization Server MUST NOT display any authentication or consent UI\n\tif (promptSet.has(\"none\")) {\n\t\t// If consent is required, return consent_required error\n\t\tif (!skipConsentForTrustedClient && !hasAlreadyConsented) {\n\t\t\treturn handleRedirect(\n\t\t\t\tformatErrorURL(\n\t\t\t\t\tquery.redirect_uri,\n\t\t\t\t\t\"consent_required\",\n\t\t\t\t\t\"Consent required but prompt is none\",\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\t\t// If we reach here, user is authenticated and consent is satisfied\n\t\t// Continue without any UI interaction\n\t}\n\n\t// Handle max_age parameter per OIDC spec 3.1.2.1\n\t// max_age=0 is equivalent to prompt=login\n\tlet requireLogin = promptSet.has(\"login\");\n\tif (query.max_age !== undefined) {\n\t\tconst maxAge = Number(query.max_age);\n\t\tif (Number.isInteger(maxAge) && maxAge >= 0) {\n\t\t\tconst sessionAge =\n\t\t\t\t(Date.now() - new Date(session.session.createdAt).getTime()) / 1000;\n\t\t\tif (sessionAge > maxAge) {\n\t\t\t\t// Session is older than max_age, force re-authentication\n\t\t\t\trequireLogin = true;\n\t\t\t}\n\t\t}\n\t\t// If max_age is invalid (not a non-negative integer), ignore it per OIDC spec\n\t}\n\n\tconst requireConsent =\n\t\t!skipConsentForTrustedClient &&\n\t\t(!hasAlreadyConsented || promptSet.has(\"consent\"));\n\n\ttry {\n\t\t/**\n\t\t * Save the code in the database\n\t\t */\n\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\tvalue: JSON.stringify({\n\t\t\t\tclientId: client.clientId,\n\t\t\t\tredirectURI: query.redirect_uri,\n\t\t\t\tscope: requestScope,\n\t\t\t\tuserId: session.user.id,\n\t\t\t\tauthTime: new Date(session.session.createdAt).getTime(),\n\t\t\t\t/**\n\t\t\t\t * Consent is required per OIDC spec unless:\n\t\t\t\t * 1. Client is trusted (skipConsent = true)\n\t\t\t\t * 2. User has already consented (and prompt is not \"consent\")\n\t\t\t\t *\n\t\t\t\t * When consent is required, the code needs to be treated as a\n\t\t\t\t * consent request. Once the user consents, the code will be\n\t\t\t\t * updated with the actual authorization code.\n\t\t\t\t */\n\t\t\t\trequireConsent,\n\t\t\t\tstate: requireConsent ? query.state : null,\n\t\t\t\tcodeChallenge: query.code_challenge,\n\t\t\t\tcodeChallengeMethod: query.code_challenge_method,\n\t\t\t\tnonce: query.nonce,\n\t\t\t}),\n\t\t\tidentifier: code,\n\t\t\texpiresAt,\n\t\t});\n\t} catch {\n\t\treturn handleRedirect(\n\t\t\tformatErrorURL(\n\t\t\t\tquery.redirect_uri,\n\t\t\t\t\"server_error\",\n\t\t\t\t\"An error occurred while processing the request\",\n\t\t\t),\n\t\t);\n\t}\n\n\tif (requireLogin) {\n\t\tawait ctx.setSignedCookie(\n\t\t\t\"oidc_login_prompt\",\n\t\t\tJSON.stringify(ctx.query),\n\t\t\tctx.context.secret,\n\t\t\t{\n\t\t\t\tmaxAge: 600,\n\t\t\t\tpath: \"/\",\n\t\t\t\tsameSite: \"lax\",\n\t\t\t},\n\t\t);\n\t\tawait ctx.setSignedCookie(\"oidc_consent_prompt\", code, ctx.context.secret, {\n\t\t\tmaxAge: 600,\n\t\t\tpath: \"/\",\n\t\t\tsameSite: \"lax\",\n\t\t});\n\n\t\tconst loginURI = `${options.loginPage}?${new URLSearchParams({\n\t\t\tclient_id: client.clientId,\n\t\t\tcode,\n\t\t\tstate: query.state,\n\t\t}).toString()}`;\n\t\treturn handleRedirect(loginURI);\n\t}\n\n\t// If consent is not required, redirect with the code immediately\n\tif (!requireConsent) {\n\t\tconst redirectURIWithCode = new URL(redirectURI);\n\t\tredirectURIWithCode.searchParams.set(\"code\", code);\n\t\tredirectURIWithCode.searchParams.set(\"state\", ctx.query.state);\n\t\treturn handleRedirect(redirectURIWithCode.toString());\n\t}\n\n\t// Consent is required - redirect to consent page or show consent HTML\n\n\tif (options?.consentPage) {\n\t\t// Set cookie to support cookie-based consent flows\n\t\tawait ctx.setSignedCookie(\"oidc_consent_prompt\", code, ctx.context.secret, {\n\t\t\tmaxAge: 600,\n\t\t\tpath: \"/\",\n\t\t\tsameSite: \"lax\",\n\t\t});\n\n\t\t// Pass the consent code as a URL parameter to support URL-based consent flows\n\t\tconst urlParams = new URLSearchParams();\n\t\turlParams.set(\"consent_code\", code);\n\t\turlParams.set(\"client_id\", client.clientId);\n\t\turlParams.set(\"scope\", requestScope.join(\" \"));\n\t\tconst consentURI = `${options.consentPage}?${urlParams.toString()}`;\n\n\t\treturn handleRedirect(consentURI);\n\t}\n\tconst htmlFn = options?.getConsentHTML;\n\n\tif (!htmlFn) {\n\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\tmessage: \"No consent page provided\",\n\t\t});\n\t}\n\n\treturn new Response(\n\t\thtmlFn({\n\t\t\tscopes: requestScope,\n\t\t\tclientMetadata: client.metadata,\n\t\t\tclientIcon: client?.icon,\n\t\t\tclientId: client.clientId,\n\t\t\tclientName: client.name,\n\t\t\tcode,\n\t\t}),\n\t\t{\n\t\t\theaders: {\n\t\t\t\t\"content-type\": \"text/html\",\n\t\t\t},\n\t\t},\n\t);\n}\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\nimport * as z from \"zod\";\n\nconst oAuthApplicationSchema = z.object({\n\t/**\n\t * Client ID\n\t *\n\t * size 32\n\t *\n\t * as described on https://www.rfc-editor.org/rfc/rfc6749.html#section-2.2\n\t */\n\tclientId: z.string(),\n\t/**\n\t * Client Secret\n\t *\n\t * A secret for the client, if required by the authorization server.\n\t * Optional for public clients using PKCE.\n\t *\n\t * size 32\n\t */\n\tclientSecret: z.string().optional(),\n\t/**\n\t * The client type\n\t *\n\t * as described on https://www.rfc-editor.org/rfc/rfc6749.html#section-2.1\n\t *\n\t * - web - A web application\n\t * - native - A mobile application\n\t * - user-agent-based - A user-agent-based application\n\t * - public - A public client (PKCE-enabled, no client_secret)\n\t */\n\ttype: z.enum([\"web\", \"native\", \"user-agent-based\", \"public\"]),\n\t/**\n\t * The name of the client.\n\t */\n\tname: z.string(),\n\t/**\n\t * The icon of the client.\n\t */\n\ticon: z.string().optional(),\n\t/**\n\t * Additional metadata about the client.\n\t */\n\tmetadata: z.string().optional(),\n\t/**\n\t * Whether the client is disabled or not.\n\t */\n\tdisabled: z.boolean().optional().default(false),\n\n\t// Database fields\n\tredirectUrls: z.string(),\n\tuserId: z.string().optional(),\n\tcreatedAt: z.date(),\n\tupdatedAt: z.date(),\n});\n\nexport type OAuthApplication = z.infer<typeof oAuthApplicationSchema>;\n\nexport const schema = {\n\toauthApplication: {\n\t\tmodelName: \"oauthApplication\",\n\t\tfields: {\n\t\t\tname: {\n\t\t\t\ttype: \"string\",\n\t\t\t},\n\t\t\ticon: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t\tmetadata: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t\tclientId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tunique: true,\n\t\t\t},\n\t\t\tclientSecret: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t},\n\t\t\tredirectUrls: {\n\t\t\t\ttype: \"string\",\n\t\t\t},\n\t\t\ttype: {\n\t\t\t\ttype: \"string\",\n\t\t\t},\n\t\t\tdisabled: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\trequired: false,\n\t\t\t\tdefaultValue: false,\n\t\t\t},\n\t\t\tuserId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t\treferences: {\n\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tonDelete: \"cascade\",\n\t\t\t\t},\n\t\t\t\tindex: true,\n\t\t\t},\n\t\t\tcreatedAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t},\n\t\t\tupdatedAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t},\n\t\t},\n\t},\n\toauthAccessToken: {\n\t\tmodelName: \"oauthAccessToken\",\n\t\tfields: {\n\t\t\taccessToken: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tunique: true,\n\t\t\t},\n\t\t\trefreshToken: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tunique: true,\n\t\t\t},\n\t\t\taccessTokenExpiresAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t},\n\t\t\trefreshTokenExpiresAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t},\n\t\t\tclientId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\treferences: {\n\t\t\t\t\tmodel: \"oauthApplication\",\n\t\t\t\t\tfield: \"clientId\",\n\t\t\t\t\tonDelete: \"cascade\",\n\t\t\t\t},\n\t\t\t\tindex: true,\n\t\t\t},\n\t\t\tuserId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t\treferences: {\n\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tonDelete: \"cascade\",\n\t\t\t\t},\n\t\t\t\tindex: true,\n\t\t\t},\n\t\t\tscopes: {\n\t\t\t\ttype: \"string\",\n\t\t\t},\n\t\t\tcreatedAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t},\n\t\t\tupdatedAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t},\n\t\t},\n\t},\n\toauthConsent: {\n\t\tmodelName: \"oauthConsent\",\n\t\tfields: {\n\t\t\tclientId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\treferences: {\n\t\t\t\t\tmodel: \"oauthApplication\",\n\t\t\t\t\tfield: \"clientId\",\n\t\t\t\t\tonDelete: \"cascade\",\n\t\t\t\t},\n\t\t\t\tindex: true,\n\t\t\t},\n\t\t\tuserId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\treferences: {\n\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tonDelete: \"cascade\",\n\t\t\t\t},\n\t\t\t\tindex: true,\n\t\t\t},\n\t\t\tscopes: {\n\t\t\t\ttype: \"string\",\n\t\t\t},\n\t\t\tcreatedAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t},\n\t\t\tupdatedAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t},\n\t\t\tconsentGiven: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t},\n\t\t},\n\t},\n} satisfies BetterAuthPluginDBSchema;\n", "import { base64Url } from \"@better-auth/utils/base64\";\nimport { createHash } from \"@better-auth/utils/hash\";\n\n/**\n * Default client secret hasher using SHA-256\n */\nexport const defaultClientSecretHasher = async (clientSecret: string) => {\n\tconst hash = await createHash(\"SHA-256\").digest(\n\t\tnew TextEncoder().encode(clientSecret),\n\t);\n\tconst hashed = base64Url.encode(new Uint8Array(hash), {\n\t\tpadding: false,\n\t});\n\treturn hashed;\n};\n", "import type {\n\tBetterAuthPlugin,\n\tGenericEndpointContext,\n} from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport { getCurrentAuthContext } from \"@better-auth/core/context\";\nimport { base64 } from \"@better-auth/utils/base64\";\nimport { createHash } from \"@better-auth/utils/hash\";\nimport type { OpenAPIParameter } from \"better-call\";\nimport { jwtVerify, SignJWT } from \"jose\";\nimport * as z from \"zod\";\nimport { APIError, getSessionFromCtx, sessionMiddleware } from \"../../api\";\nimport { parseSetCookieHeader } from \"../../cookies\";\nimport {\n\tgenerateRandomString,\n\tsymmetricDecrypt,\n\tsymmetricEncrypt,\n} from \"../../crypto\";\nimport { mergeSchema } from \"../../db\";\nimport { HIDE_METADATA } from \"../../utils\";\nimport type { jwt } from \"../jwt\";\nimport { getJwtToken, verifyJWT } from \"../jwt\";\nimport { authorize } from \"./authorize\";\nimport type { OAuthApplication } from \"./schema\";\nimport { schema } from \"./schema\";\nimport type {\n\tClient,\n\tCodeVerificationValue,\n\tOAuthAccessToken,\n\tOIDCMetadata,\n\tOIDCOptions,\n} from \"./types\";\nimport { defaultClientSecretHasher } from \"./utils\";\nimport { parsePrompt } from \"./utils/prompt\";\n\nconst getJwtPlugin = (ctx: GenericEndpointContext) => {\n\treturn ctx.context.options.plugins?.find(\n\t\t(plugin) => plugin.id === \"jwt\",\n\t) as ReturnType<typeof jwt>;\n};\n\n/**\n * Get a client by ID, checking trusted clients first, then database\n */\nexport async function getClient(\n\tclientId: string,\n\ttrustedClients: (Client & { skipConsent?: boolean | undefined })[] = [],\n): Promise<(Client & { skipConsent?: boolean | undefined }) | null> {\n\tconst {\n\t\tcontext: { adapter },\n\t} = await getCurrentAuthContext();\n\tconst trustedClient = trustedClients.find(\n\t\t(client) => client.clientId === clientId,\n\t);\n\tif (trustedClient) {\n\t\treturn trustedClient;\n\t}\n\treturn adapter\n\t\t.findOne<OAuthApplication>({\n\t\t\tmodel: \"oauthApplication\",\n\t\t\twhere: [{ field: \"clientId\", value: clientId }],\n\t\t})\n\t\t.then((res) => {\n\t\t\tif (!res) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\t// omit sensitive fields\n\t\t\treturn {\n\t\t\t\tclientId: res.clientId,\n\t\t\t\tclientSecret: res.clientSecret,\n\t\t\t\ttype: res.type,\n\t\t\t\tname: res.name,\n\t\t\t\ticon: res.icon,\n\t\t\t\tdisabled: res.disabled,\n\t\t\t\tredirectUrls: (res.redirectUrls ?? \"\").split(\",\"),\n\t\t\t\tmetadata: res.metadata ? JSON.parse(res.metadata) : {},\n\t\t\t} satisfies Client;\n\t\t});\n}\n\nexport const getMetadata = (\n\tctx: GenericEndpointContext,\n\toptions?: OIDCOptions | undefined,\n): OIDCMetadata => {\n\tconst jwtPlugin = getJwtPlugin(ctx);\n\tconst issuer =\n\t\tjwtPlugin && jwtPlugin.options?.jwt && jwtPlugin.options.jwt.issuer\n\t\t\t? jwtPlugin.options.jwt.issuer\n\t\t\t: (ctx.context.options.baseURL as string);\n\tconst baseURL = ctx.context.baseURL;\n\tconst supportedAlgs = options?.useJWTPlugin\n\t\t? [\"RS256\", \"EdDSA\", \"none\"]\n\t\t: [\"HS256\", \"none\"];\n\treturn {\n\t\tissuer,\n\t\tauthorization_endpoint: `${baseURL}/oauth2/authorize`,\n\t\ttoken_endpoint: `${baseURL}/oauth2/token`,\n\t\tuserinfo_endpoint: `${baseURL}/oauth2/userinfo`,\n\t\tjwks_uri: `${baseURL}/jwks`,\n\t\tregistration_endpoint: `${baseURL}/oauth2/register`,\n\t\tend_session_endpoint: `${baseURL}/oauth2/endsession`,\n\t\tscopes_supported: [\"openid\", \"profile\", \"email\", \"offline_access\"],\n\t\tresponse_types_supported: [\"code\"],\n\t\tresponse_modes_supported: [\"query\"],\n\t\tgrant_types_supported: [\"authorization_code\", \"refresh_token\"],\n\t\tacr_values_supported: [\n\t\t\t\"urn:mace:incommon:iap:silver\",\n\t\t\t\"urn:mace:incommon:iap:bronze\",\n\t\t],\n\t\tsubject_types_supported: [\"public\"],\n\t\tid_token_signing_alg_values_supported: supportedAlgs,\n\t\ttoken_endpoint_auth_methods_supported: [\n\t\t\t\"client_secret_basic\",\n\t\t\t\"client_secret_post\",\n\t\t\t\"none\",\n\t\t],\n\t\tcode_challenge_methods_supported: [\"S256\"],\n\t\tclaims_supported: [\n\t\t\t\"sub\",\n\t\t\t\"iss\",\n\t\t\t\"aud\",\n\t\t\t\"exp\",\n\t\t\t\"nbf\",\n\t\t\t\"iat\",\n\t\t\t\"jti\",\n\t\t\t\"email\",\n\t\t\t\"email_verified\",\n\t\t\t\"name\",\n\t\t],\n\t\t...options?.metadata,\n\t};\n};\n\nconst oAuthConsentBodySchema = z.object({\n\taccept: z.boolean(),\n\tconsent_code: z.string().optional().nullish(),\n});\n\nconst oAuth2TokenBodySchema = z.record(z.any(), z.any());\n\nconst registerOAuthApplicationBodySchema = z.object({\n\tredirect_uris: z.array(z.string()).meta({\n\t\tdescription:\n\t\t\t'A list of redirect URIs. Eg: [\"https://client.example.com/callback\"]',\n\t}),\n\ttoken_endpoint_auth_method: z\n\t\t.enum([\"none\", \"client_secret_basic\", \"client_secret_post\"])\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The authentication method for the token endpoint. Eg: \"client_secret_basic\"',\n\t\t})\n\t\t.default(\"client_secret_basic\")\n\t\t.optional(),\n\tgrant_types: z\n\t\t.array(\n\t\t\tz.enum([\n\t\t\t\t\"authorization_code\",\n\t\t\t\t\"implicit\",\n\t\t\t\t\"password\",\n\t\t\t\t\"client_credentials\",\n\t\t\t\t\"refresh_token\",\n\t\t\t\t\"urn:ietf:params:oauth:grant-type:jwt-bearer\",\n\t\t\t\t\"urn:ietf:params:oauth:grant-type:saml2-bearer\",\n\t\t\t]),\n\t\t)\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The grant types supported by the application. Eg: [\"authorization_code\"]',\n\t\t})\n\t\t.default([\"authorization_code\"])\n\t\t.optional(),\n\tresponse_types: z\n\t\t.array(z.enum([\"code\", \"token\"]))\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The response types supported by the application. Eg: [\"code\"]',\n\t\t})\n\t\t.default([\"code\"])\n\t\t.optional(),\n\tclient_name: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: 'The name of the application. Eg: \"My App\"',\n\t\t})\n\t\t.optional(),\n\tclient_uri: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The URI of the application. Eg: \"https://client.example.com\"',\n\t\t})\n\t\t.optional(),\n\tlogo_uri: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The URI of the application logo. Eg: \"https://client.example.com/logo.png\"',\n\t\t})\n\t\t.optional(),\n\tscope: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The scopes supported by the application. Separated by spaces. Eg: \"profile email\"',\n\t\t})\n\t\t.optional(),\n\tcontacts: z\n\t\t.array(z.string())\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The contact information for the application. Eg: [\"admin@example.com\"]',\n\t\t})\n\t\t.optional(),\n\ttos_uri: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The URI of the application terms of service. Eg: \"https://client.example.com/tos\"',\n\t\t})\n\t\t.optional(),\n\tpolicy_uri: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The URI of the application privacy policy. Eg: \"https://client.example.com/policy\"',\n\t\t})\n\t\t.optional(),\n\tjwks_uri: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The URI of the application JWKS. Eg: \"https://client.example.com/jwks\"',\n\t\t})\n\t\t.optional(),\n\tjwks: z\n\t\t.record(z.any(), z.any())\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The JWKS of the application. Eg: {\"keys\": [{\"kty\": \"RSA\", \"alg\": \"RS256\", \"use\": \"sig\", \"n\": \"...\", \"e\": \"...\"}]}',\n\t\t})\n\t\t.optional(),\n\tmetadata: z\n\t\t.record(z.any(), z.any())\n\t\t.meta({\n\t\t\tdescription: 'The metadata of the application. Eg: {\"key\": \"value\"}',\n\t\t})\n\t\t.optional(),\n\tsoftware_id: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: 'The software ID of the application. Eg: \"my-software\"',\n\t\t})\n\t\t.optional(),\n\tsoftware_version: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: 'The software version of the application. Eg: \"1.0.0\"',\n\t\t})\n\t\t.optional(),\n\tsoftware_statement: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The software statement of the application.\",\n\t\t})\n\t\t.optional(),\n});\n\nconst DEFAULT_CODE_EXPIRES_IN = 600;\nconst DEFAULT_ACCESS_TOKEN_EXPIRES_IN = 3600;\nconst DEFAULT_REFRESH_TOKEN_EXPIRES_IN = 604800;\n\n/**\n * OpenID Connect (OIDC) plugin for Better Auth. This plugin implements the\n * authorization code flow and the token exchange flow. It also implements the\n * userinfo endpoint.\n *\n * @param options - The options for the OIDC plugin.\n * @returns A Better Auth plugin.\n */\nexport const oidcProvider = (options: OIDCOptions) => {\n\tconst modelName = {\n\t\toauthClient: \"oauthApplication\",\n\t\toauthAccessToken: \"oauthAccessToken\",\n\t\toauthConsent: \"oauthConsent\",\n\t};\n\n\tconst opts = {\n\t\tcodeExpiresIn: DEFAULT_CODE_EXPIRES_IN,\n\t\tdefaultScope: \"openid\",\n\t\taccessTokenExpiresIn: DEFAULT_ACCESS_TOKEN_EXPIRES_IN,\n\t\trefreshTokenExpiresIn: DEFAULT_REFRESH_TOKEN_EXPIRES_IN,\n\t\tallowPlainCodeChallengeMethod: true,\n\t\tstoreClientSecret: \"plain\" as const,\n\t\t...options,\n\t\tscopes: [\n\t\t\t\"openid\",\n\t\t\t\"profile\",\n\t\t\t\"email\",\n\t\t\t\"offline_access\",\n\t\t\t...(options?.scopes || []),\n\t\t],\n\t};\n\n\tconst trustedClients = options.trustedClients || [];\n\n\t/**\n\t * Store client secret according to the configured storage method\n\t */\n\tasync function storeClientSecret(\n\t\tctx: GenericEndpointContext,\n\t\tclientSecret: string,\n\t) {\n\t\tif (opts.storeClientSecret === \"encrypted\") {\n\t\t\treturn await symmetricEncrypt({\n\t\t\t\tkey: ctx.context.secret,\n\t\t\t\tdata: clientSecret,\n\t\t\t});\n\t\t}\n\t\tif (opts.storeClientSecret === \"hashed\") {\n\t\t\treturn await defaultClientSecretHasher(clientSecret);\n\t\t}\n\t\tif (\n\t\t\ttypeof opts.storeClientSecret === \"object\" &&\n\t\t\t\"hash\" in opts.storeClientSecret\n\t\t) {\n\t\t\treturn await opts.storeClientSecret.hash(clientSecret);\n\t\t}\n\t\tif (\n\t\t\ttypeof opts.storeClientSecret === \"object\" &&\n\t\t\t\"encrypt\" in opts.storeClientSecret\n\t\t) {\n\t\t\treturn await opts.storeClientSecret.encrypt(clientSecret);\n\t\t}\n\n\t\treturn clientSecret;\n\t}\n\n\t/**\n\t * Verify stored client secret against provided client secret\n\t */\n\tasync function verifyStoredClientSecret(\n\t\tctx: GenericEndpointContext,\n\t\tstoredClientSecret: string,\n\t\tclientSecret: string,\n\t): Promise<boolean> {\n\t\tif (opts.storeClientSecret === \"encrypted\") {\n\t\t\treturn (\n\t\t\t\t(await symmetricDecrypt({\n\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\tdata: storedClientSecret,\n\t\t\t\t})) === clientSecret\n\t\t\t);\n\t\t}\n\t\tif (opts.storeClientSecret === \"hashed\") {\n\t\t\tconst hashedClientSecret = await defaultClientSecretHasher(clientSecret);\n\t\t\treturn hashedClientSecret === storedClientSecret;\n\t\t}\n\t\tif (\n\t\t\ttypeof opts.storeClientSecret === \"object\" &&\n\t\t\t\"hash\" in opts.storeClientSecret\n\t\t) {\n\t\t\tconst hashedClientSecret =\n\t\t\t\tawait opts.storeClientSecret.hash(clientSecret);\n\t\t\treturn hashedClientSecret === storedClientSecret;\n\t\t}\n\t\tif (\n\t\t\ttypeof opts.storeClientSecret === \"object\" &&\n\t\t\t\"decrypt\" in opts.storeClientSecret\n\t\t) {\n\t\t\tconst decryptedClientSecret =\n\t\t\t\tawait opts.storeClientSecret.decrypt(storedClientSecret);\n\t\t\treturn decryptedClientSecret === clientSecret;\n\t\t}\n\n\t\treturn clientSecret === storedClientSecret;\n\t}\n\n\treturn {\n\t\tid: \"oidc\",\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher() {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst loginPromptCookie = await ctx.getSignedCookie(\n\t\t\t\t\t\t\t\"oidc_login_prompt\",\n\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst cookieName = ctx.context.authCookies.sessionToken.name;\n\t\t\t\t\t\tconst parsedSetCookieHeader = parseSetCookieHeader(\n\t\t\t\t\t\t\tctx.context.responseHeaders?.get(\"set-cookie\") || \"\",\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst hasSessionToken = parsedSetCookieHeader.has(cookieName);\n\t\t\t\t\t\tif (!loginPromptCookie || !hasSessionToken) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tctx.setCookie(\"oidc_login_prompt\", \"\", {\n\t\t\t\t\t\t\tmaxAge: 0,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst sessionCookie = parsedSetCookieHeader.get(cookieName)?.value;\n\t\t\t\t\t\tconst sessionToken = sessionCookie?.split(\".\")[0]!;\n\t\t\t\t\t\tif (!sessionToken) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst session =\n\t\t\t\t\t\t\t(await ctx.context.internalAdapter.findSession(sessionToken)) ||\n\t\t\t\t\t\t\tctx.context.newSession;\n\t\t\t\t\t\tif (!session) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tctx.query = JSON.parse(loginPromptCookie);\n\n\t\t\t\t\t\t// Remove \"login\" from prompt since user just logged in\n\t\t\t\t\t\tconst promptSet = parsePrompt(String(ctx.query?.prompt));\n\t\t\t\t\t\tif (promptSet.has(\"login\")) {\n\t\t\t\t\t\t\tconst newPromptSet = new Set(promptSet);\n\t\t\t\t\t\t\tnewPromptSet.delete(\"login\");\n\t\t\t\t\t\t\tctx.query = {\n\t\t\t\t\t\t\t\t...ctx.query,\n\t\t\t\t\t\t\t\tprompt: Array.from(newPromptSet).join(\" \"),\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tctx.context.session = session;\n\t\t\t\t\t\tconst response = await authorize(ctx, opts);\n\t\t\t\t\t\treturn response;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tendpoints: {\n\t\t\tgetOpenIdConfig: createAuthEndpoint(\n\t\t\t\t\"/.well-known/openid-configuration\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\toperationId: \"getOpenIdConfig\",\n\t\t\t\t\tmetadata: HIDE_METADATA,\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst metadata = getMetadata(ctx, options);\n\t\t\t\t\treturn ctx.json(metadata);\n\t\t\t\t},\n\t\t\t),\n\t\t\toAuth2authorize: createAuthEndpoint(\n\t\t\t\t\"/oauth2/authorize\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\toperationId: \"oauth2Authorize\",\n\t\t\t\t\tquery: z.record(z.string(), z.any()),\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Authorize an OAuth2 request\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"Authorization response generated successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Authorization response, contents depend on the authorize function implementation\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\treturn authorize(ctx, opts);\n\t\t\t\t},\n\t\t\t),\n\t\t\toAuthConsent: createAuthEndpoint(\n\t\t\t\t\"/oauth2/consent\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\toperationId: \"oauth2Consent\",\n\t\t\t\t\tbody: oAuthConsentBodySchema,\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Handle OAuth2 consent. Supports both URL parameter-based flows (consent_code in body) and cookie-based flows (signed cookie).\",\n\t\t\t\t\t\t\trequestBody: {\n\t\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\taccept: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Whether the user accepts or denies the consent request\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tconsent_code: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The consent code from the authorization request. Optional if using cookie-based flow.\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequired: [\"accept\"],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"Consent processed successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tredirectURI: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The URI to redirect to, either with an authorization code or an error\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"redirectURI\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\t// Support both consent flow methods:\n\t\t\t\t\t// 1. URL parameter-based: consent_code in request body (standard OAuth2 pattern)\n\t\t\t\t\t// 2. Cookie-based: using signed cookie for stateful consent flows\n\t\t\t\t\tlet consentCode: string | null = ctx.body.consent_code || null;\n\n\t\t\t\t\tif (!consentCode) {\n\t\t\t\t\t\t// Check for cookie-based consent flow\n\t\t\t\t\t\tconst cookieValue = await ctx.getSignedCookie(\n\t\t\t\t\t\t\t\"oidc_consent_prompt\",\n\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (cookieValue) {\n\t\t\t\t\t\t\tconsentCode = cookieValue;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!consentCode) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\"consent_code is required (either in body or cookie)\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst verification =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t\t\tconsentCode,\n\t\t\t\t\t\t);\n\t\t\t\t\tif (!verification) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"Invalid code\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (verification.expiresAt < new Date()) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"Code expired\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// Clear the cookie\n\t\t\t\t\tctx.setCookie(\"oidc_consent_prompt\", \"\", {\n\t\t\t\t\t\tmaxAge: 0,\n\t\t\t\t\t});\n\n\t\t\t\t\tconst value = JSON.parse(verification.value) as CodeVerificationValue;\n\t\t\t\t\tif (!value.requireConsent) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"Consent not required\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!ctx.body.accept) {\n\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\t\tverification.id,\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\tredirectURI: `${value.redirectURI}?error=access_denied&error_description=User denied access`,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst code = generateRandomString(32, \"a-z\", \"A-Z\", \"0-9\");\n\t\t\t\t\tconst codeExpiresInMs =\n\t\t\t\t\t\t(opts?.codeExpiresIn ?? DEFAULT_CODE_EXPIRES_IN) * 1000;\n\t\t\t\t\tconst expiresAt = new Date(Date.now() + codeExpiresInMs);\n\t\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(\n\t\t\t\t\t\tverification.id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvalue: JSON.stringify({\n\t\t\t\t\t\t\t\t...value,\n\t\t\t\t\t\t\t\trequireConsent: false,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tidentifier: code,\n\t\t\t\t\t\t\texpiresAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\tmodel: modelName.oauthConsent,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tclientId: value.clientId,\n\t\t\t\t\t\t\tuserId: value.userId,\n\t\t\t\t\t\t\tscopes: value.scope.join(\" \"),\n\t\t\t\t\t\t\tconsentGiven: true,\n\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tconst redirectURI = new URL(value.redirectURI);\n\t\t\t\t\tredirectURI.searchParams.set(\"code\", code);\n\t\t\t\t\tif (value.state) redirectURI.searchParams.set(\"state\", value.state);\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tredirectURI: redirectURI.toString(),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\toAuth2token: createAuthEndpoint(\n\t\t\t\t\"/oauth2/token\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\toperationId: \"oauth2Token\",\n\t\t\t\t\tbody: oAuth2TokenBodySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...HIDE_METADATA,\n\t\t\t\t\t\tallowedMediaTypes: [\n\t\t\t\t\t\t\t\"application/x-www-form-urlencoded\",\n\t\t\t\t\t\t\t\"application/json\",\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tlet { body } = ctx;\n\t\t\t\t\tif (!body) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"request body not found\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (body instanceof FormData) {\n\t\t\t\t\t\tbody = Object.fromEntries(body.entries());\n\t\t\t\t\t}\n\t\t\t\t\tif (!(body instanceof Object)) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"request body is not an object\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tlet { client_id, client_secret } = body;\n\t\t\t\t\tconst authorization =\n\t\t\t\t\t\tctx.request?.headers.get(\"authorization\") || null;\n\t\t\t\t\tif (\n\t\t\t\t\t\tauthorization &&\n\t\t\t\t\t\t!client_id &&\n\t\t\t\t\t\t!client_secret &&\n\t\t\t\t\t\tauthorization.startsWith(\"Basic \")\n\t\t\t\t\t) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst encoded = authorization.replace(\"Basic \", \"\");\n\t\t\t\t\t\t\tconst decoded = new TextDecoder().decode(base64.decode(encoded));\n\t\t\t\t\t\t\tif (!decoded.includes(\":\")) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\t\terror_description: \"invalid authorization header format\",\n\t\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst [id, secret] = decoded.split(\":\");\n\t\t\t\t\t\t\tif (!id || !secret) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\t\terror_description: \"invalid authorization header format\",\n\t\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tclient_id = id;\n\t\t\t\t\t\t\tclient_secret = secret;\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"invalid authorization header format\",\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst now = Date.now();\n\t\t\t\t\tconst iat = Math.floor(now / 1000);\n\t\t\t\t\tconst exp = iat + (opts.accessTokenExpiresIn ?? 3600);\n\n\t\t\t\t\tconst accessTokenExpiresAt = new Date(exp * 1000);\n\t\t\t\t\tconst refreshTokenExpiresAt = new Date(\n\t\t\t\t\t\t(iat + (opts.refreshTokenExpiresIn ?? 604800)) * 1000,\n\t\t\t\t\t);\n\n\t\t\t\t\tconst {\n\t\t\t\t\t\tgrant_type,\n\t\t\t\t\t\tcode,\n\t\t\t\t\t\tredirect_uri,\n\t\t\t\t\t\trefresh_token,\n\t\t\t\t\t\tcode_verifier,\n\t\t\t\t\t} = body;\n\t\t\t\t\tif (grant_type === \"refresh_token\") {\n\t\t\t\t\t\tif (!refresh_token) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror_description: \"refresh_token is required\",\n\t\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst token = await ctx.context.adapter.findOne<OAuthAccessToken>({\n\t\t\t\t\t\t\tmodel: modelName.oauthAccessToken,\n\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tfield: \"refreshToken\",\n\t\t\t\t\t\t\t\t\tvalue: refresh_token.toString(),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (!token) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"invalid refresh token\",\n\t\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (token.clientId !== client_id?.toString()) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"invalid client_id\",\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (token.refreshTokenExpiresAt < new Date()) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"refresh token expired\",\n\t\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst accessToken = generateRandomString(32, \"a-z\", \"A-Z\");\n\t\t\t\t\t\tconst newRefreshToken = generateRandomString(32, \"a-z\", \"A-Z\");\n\n\t\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\t\tmodel: modelName.oauthAccessToken,\n\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\taccessToken,\n\t\t\t\t\t\t\t\trefreshToken: newRefreshToken,\n\t\t\t\t\t\t\t\taccessTokenExpiresAt,\n\t\t\t\t\t\t\t\trefreshTokenExpiresAt,\n\t\t\t\t\t\t\t\tclientId: client_id.toString(),\n\t\t\t\t\t\t\t\tuserId: token.userId,\n\t\t\t\t\t\t\t\tscopes: token.scopes,\n\t\t\t\t\t\t\t\tcreatedAt: new Date(iat * 1000),\n\t\t\t\t\t\t\t\tupdatedAt: new Date(iat * 1000),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\taccess_token: accessToken,\n\t\t\t\t\t\t\ttoken_type: \"Bearer\",\n\t\t\t\t\t\t\texpires_in: opts.accessTokenExpiresIn,\n\t\t\t\t\t\t\trefresh_token: newRefreshToken,\n\t\t\t\t\t\t\tscope: token.scopes,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!code) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"code is required\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (options.requirePKCE && !code_verifier) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"code verifier is missing\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t/**\n\t\t\t\t\t * We need to check if the code is valid before we can proceed\n\t\t\t\t\t * with the rest of the request.\n\t\t\t\t\t */\n\t\t\t\t\tconst verificationValue =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t\t\tcode.toString(),\n\t\t\t\t\t\t);\n\t\t\t\t\tif (!verificationValue) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid code\",\n\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (verificationValue.expiresAt < new Date()) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"code expired\",\n\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t);\n\t\t\t\t\tif (!client_id) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"client_id is required\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (!grant_type) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"grant_type is required\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (grant_type !== \"authorization_code\") {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"grant_type must be 'authorization_code'\",\n\t\t\t\t\t\t\terror: \"unsupported_grant_type\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!redirect_uri) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"redirect_uri is required\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst client = await getClient(client_id.toString(), trustedClients);\n\t\t\t\t\tif (!client) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid client_id\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (client.disabled) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"client is disabled\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst value = JSON.parse(\n\t\t\t\t\t\tverificationValue.value,\n\t\t\t\t\t) as CodeVerificationValue;\n\t\t\t\t\tif (value.clientId !== client_id.toString()) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid client_id\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (value.redirectURI !== redirect_uri.toString()) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid redirect_uri\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (value.codeChallenge && !code_verifier) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"code verifier is missing\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (client.type === \"public\") {\n\t\t\t\t\t\t// For public clients (type: 'public'), validate PKCE instead of client_secret\n\t\t\t\t\t\tif (!code_verifier) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"code verifier is required for public clients\",\n\t\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// PKCE validation happens later in the flow, so we skip client_secret validation\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (!client.clientSecret || !client_secret) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"client_secret is required for confidential clients\",\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst isValidSecret = await verifyStoredClientSecret(\n\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\tclient.clientSecret,\n\t\t\t\t\t\t\tclient_secret.toString(),\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (!isValidSecret) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"invalid client_secret\",\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tconst challenge =\n\t\t\t\t\t\tvalue.codeChallengeMethod === \"plain\"\n\t\t\t\t\t\t\t? code_verifier\n\t\t\t\t\t\t\t: await createHash(\"SHA-256\", \"base64urlnopad\").digest(\n\t\t\t\t\t\t\t\t\tcode_verifier,\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\tif (challenge !== value.codeChallenge) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"code verification failed\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst requestedScopes = value.scope;\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t);\n\t\t\t\t\tconst accessToken = generateRandomString(32, \"a-z\", \"A-Z\");\n\t\t\t\t\tconst refreshToken = generateRandomString(32, \"A-Z\", \"a-z\");\n\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\tmodel: modelName.oauthAccessToken,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\taccessToken,\n\t\t\t\t\t\t\trefreshToken,\n\t\t\t\t\t\t\taccessTokenExpiresAt,\n\t\t\t\t\t\t\trefreshTokenExpiresAt,\n\t\t\t\t\t\t\tclientId: client_id.toString(),\n\t\t\t\t\t\t\tuserId: value.userId,\n\t\t\t\t\t\t\tscopes: requestedScopes.join(\" \"),\n\t\t\t\t\t\t\tcreatedAt: new Date(iat * 1000),\n\t\t\t\t\t\t\tupdatedAt: new Date(iat * 1000),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tconst user = await ctx.context.internalAdapter.findUserById(\n\t\t\t\t\t\tvalue.userId,\n\t\t\t\t\t);\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"user not found\",\n\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst profile = {\n\t\t\t\t\t\tgiven_name: user.name.split(\" \")[0]!,\n\t\t\t\t\t\tfamily_name: user.name.split(\" \")[1]!,\n\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\tprofile: user.image,\n\t\t\t\t\t\tupdated_at: new Date(user.updatedAt).toISOString(),\n\t\t\t\t\t};\n\t\t\t\t\tconst email = {\n\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\temail_verified: user.emailVerified,\n\t\t\t\t\t};\n\t\t\t\t\tconst userClaims = {\n\t\t\t\t\t\t...(requestedScopes.includes(\"profile\") ? profile : {}),\n\t\t\t\t\t\t...(requestedScopes.includes(\"email\") ? email : {}),\n\t\t\t\t\t};\n\n\t\t\t\t\tconst additionalUserClaims = options.getAdditionalUserInfoClaim\n\t\t\t\t\t\t? await options.getAdditionalUserInfoClaim(\n\t\t\t\t\t\t\t\tuser,\n\t\t\t\t\t\t\t\trequestedScopes,\n\t\t\t\t\t\t\t\tclient,\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t: {};\n\n\t\t\t\t\tconst payload = {\n\t\t\t\t\t\tsub: user.id,\n\t\t\t\t\t\taud: client_id.toString(),\n\t\t\t\t\t\tiat: iat,\n\t\t\t\t\t\tauth_time: ctx.context.session\n\t\t\t\t\t\t\t? new Date(ctx.context.session.session.createdAt).getTime()\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\tnonce: value.nonce,\n\t\t\t\t\t\tacr: \"urn:mace:incommon:iap:silver\", // default to silver -  this should be configurable and should be validated against the client's metadata\n\t\t\t\t\t\t...userClaims,\n\t\t\t\t\t\t...additionalUserClaims,\n\t\t\t\t\t};\n\t\t\t\t\tconst expirationTime =\n\t\t\t\t\t\tMath.floor(Date.now() / 1000) +\n\t\t\t\t\t\t(opts?.accessTokenExpiresIn ?? DEFAULT_ACCESS_TOKEN_EXPIRES_IN);\n\n\t\t\t\t\tlet idToken: string;\n\n\t\t\t\t\t// The JWT plugin is enabled, so we use the JWKS keys to sign\n\t\t\t\t\tif (options.useJWTPlugin) {\n\t\t\t\t\t\tconst jwtPlugin = getJwtPlugin(ctx);\n\t\t\t\t\t\tif (!jwtPlugin) {\n\t\t\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t\t\t\"OIDC: `useJWTPlugin` is enabled but the JWT plugin is not available. Make sure you have the JWT Plugin in your plugins array or set `useJWTPlugin` to false.\",\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\t\t\terror_description: \"JWT plugin is not enabled\",\n\t\t\t\t\t\t\t\terror: \"internal_server_error\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tidToken = await getJwtToken(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t...ctx,\n\t\t\t\t\t\t\t\tcontext: {\n\t\t\t\t\t\t\t\t\t...ctx.context,\n\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\tid: generateRandomString(32, \"a-z\", \"A-Z\"),\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: new Date(iat * 1000),\n\t\t\t\t\t\t\t\t\t\t\tupdatedAt: new Date(iat * 1000),\n\t\t\t\t\t\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\t\t\t\t\t\texpiresAt: accessTokenExpiresAt,\n\t\t\t\t\t\t\t\t\t\t\ttoken: accessToken,\n\t\t\t\t\t\t\t\t\t\t\tipAddress: ctx.request?.headers.get(\"x-forwarded-for\"),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tuser,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t...jwtPlugin.options,\n\t\t\t\t\t\t\t\tjwt: {\n\t\t\t\t\t\t\t\t\t...jwtPlugin.options?.jwt,\n\t\t\t\t\t\t\t\t\tgetSubject: () => user.id,\n\t\t\t\t\t\t\t\t\taudience: client_id.toString(),\n\t\t\t\t\t\t\t\t\tissuer:\n\t\t\t\t\t\t\t\t\t\tjwtPlugin.options?.jwt?.issuer ??\n\t\t\t\t\t\t\t\t\t\tctx.context.options.baseURL,\n\t\t\t\t\t\t\t\t\texpirationTime,\n\t\t\t\t\t\t\t\t\tdefinePayload: () => payload,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// If the JWT token is not enabled, create a key and use it to sign\n\t\t\t\t\t} else {\n\t\t\t\t\t\tidToken = await new SignJWT(payload)\n\t\t\t\t\t\t\t.setProtectedHeader({ alg: \"HS256\" })\n\t\t\t\t\t\t\t.setIssuedAt(iat)\n\t\t\t\t\t\t\t.setExpirationTime(accessTokenExpiresAt)\n\t\t\t\t\t\t\t.sign(new TextEncoder().encode(client.clientSecret));\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ctx.json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\taccess_token: accessToken,\n\t\t\t\t\t\t\ttoken_type: \"Bearer\",\n\t\t\t\t\t\t\texpires_in: opts.accessTokenExpiresIn,\n\t\t\t\t\t\t\trefresh_token: requestedScopes.includes(\"offline_access\")\n\t\t\t\t\t\t\t\t? refreshToken\n\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\t\tscope: requestedScopes.join(\" \"),\n\t\t\t\t\t\t\tid_token: requestedScopes.includes(\"openid\")\n\t\t\t\t\t\t\t\t? idToken\n\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\"Cache-Control\": \"no-store\",\n\t\t\t\t\t\t\t\tPragma: \"no-cache\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t),\n\t\t\toAuth2userInfo: createAuthEndpoint(\n\t\t\t\t\"/oauth2/userinfo\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\toperationId: \"oauth2Userinfo\",\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...HIDE_METADATA,\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Get OAuth2 user information\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"User information retrieved successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsub: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Subject identifier (user ID)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"User's email address, included if 'email' scope is granted\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"User's full name, included if 'profile' scope is granted\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tpicture: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"User's profile picture URL, included if 'profile' scope is granted\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tgiven_name: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"User's given name, included if 'profile' scope is granted\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tfamily_name: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"User's family name, included if 'profile' scope is granted\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temail_verified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Whether the email is verified, included if 'email' scope is granted\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"sub\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tif (!ctx.request) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"request not found\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst authorization = ctx.request.headers.get(\"authorization\");\n\t\t\t\t\tif (!authorization) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"authorization header not found\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst token = authorization.replace(\"Bearer \", \"\");\n\t\t\t\t\tconst accessToken =\n\t\t\t\t\t\tawait ctx.context.adapter.findOne<OAuthAccessToken>({\n\t\t\t\t\t\t\tmodel: modelName.oauthAccessToken,\n\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tfield: \"accessToken\",\n\t\t\t\t\t\t\t\t\tvalue: token,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t});\n\t\t\t\t\tif (!accessToken) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid access token\",\n\t\t\t\t\t\t\terror: \"invalid_token\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (accessToken.accessTokenExpiresAt < new Date()) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"The Access Token expired\",\n\t\t\t\t\t\t\terror: \"invalid_token\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst client = await getClient(accessToken.clientId, trustedClients);\n\t\t\t\t\tif (!client) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"client not found\",\n\t\t\t\t\t\t\terror: \"invalid_token\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = await ctx.context.internalAdapter.findUserById(\n\t\t\t\t\t\taccessToken.userId,\n\t\t\t\t\t);\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"user not found\",\n\t\t\t\t\t\t\terror: \"invalid_token\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst requestedScopes = accessToken.scopes.split(\" \");\n\t\t\t\t\tconst baseUserClaims = {\n\t\t\t\t\t\tsub: user.id,\n\t\t\t\t\t\temail: requestedScopes.includes(\"email\") ? user.email : undefined,\n\t\t\t\t\t\tname: requestedScopes.includes(\"profile\") ? user.name : undefined,\n\t\t\t\t\t\tpicture: requestedScopes.includes(\"profile\")\n\t\t\t\t\t\t\t? user.image\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\tgiven_name: requestedScopes.includes(\"profile\")\n\t\t\t\t\t\t\t? user.name.split(\" \")[0]!\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\tfamily_name: requestedScopes.includes(\"profile\")\n\t\t\t\t\t\t\t? user.name.split(\" \")[1]!\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\temail_verified: requestedScopes.includes(\"email\")\n\t\t\t\t\t\t\t? user.emailVerified\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t};\n\t\t\t\t\tconst userClaims = options.getAdditionalUserInfoClaim\n\t\t\t\t\t\t? await options.getAdditionalUserInfoClaim(\n\t\t\t\t\t\t\t\tuser,\n\t\t\t\t\t\t\t\trequestedScopes,\n\t\t\t\t\t\t\t\tclient,\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t: baseUserClaims;\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t...baseUserClaims,\n\t\t\t\t\t\t...userClaims,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/oauth2/register`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.registerOAuthApplication`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.oauth2.register`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/oidc-provider#api-method-oauth2-register)\n\t\t\t */\n\t\t\tregisterOAuthApplication: createAuthEndpoint(\n\t\t\t\t\"/oauth2/register\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: registerOAuthApplicationBodySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Register an OAuth2 application\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"OAuth2 application registered successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Name of the OAuth2 application\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\ticon: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Icon URL for the application\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Additional metadata for the application\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tclientId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier for the client\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tclientSecret: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Secret key for the client\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tredirectURLs: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\titems: { type: \"string\", format: \"uri\" },\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"List of allowed redirect URLs\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Type of the client\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tenum: [\"web\"],\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tauthenticationScheme: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Authentication scheme used by the client\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tenum: [\"client_secret\"],\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabled: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the client is disabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tenum: [false],\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"ID of the user who registered the client, null if registered anonymously\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Creation timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Last update timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"clientId\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"clientSecret\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"redirectURLs\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"type\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"authenticationScheme\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"disabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst body = ctx.body;\n\t\t\t\t\tconst session = await getSessionFromCtx(ctx);\n\n\t\t\t\t\t// Check authorization\n\t\t\t\t\tif (!session && !options.allowDynamicClientRegistration) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror: \"invalid_token\",\n\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\"Authentication required for client registration\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// Validate redirect URIs for redirect-based flows\n\t\t\t\t\tif (\n\t\t\t\t\t\t(!body.grant_types ||\n\t\t\t\t\t\t\tbody.grant_types.includes(\"authorization_code\") ||\n\t\t\t\t\t\t\tbody.grant_types.includes(\"implicit\")) &&\n\t\t\t\t\t\t(!body.redirect_uris || body.redirect_uris.length === 0)\n\t\t\t\t\t) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror: \"invalid_redirect_uri\",\n\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\"Redirect URIs are required for authorization_code and implicit grant types\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// Validate correlation between grant_types and response_types\n\t\t\t\t\tif (body.grant_types && body.response_types) {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tbody.grant_types.includes(\"authorization_code\") &&\n\t\t\t\t\t\t\t!body.response_types.includes(\"code\")\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_client_metadata\",\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"When 'authorization_code' grant type is used, 'code' response type must be included\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tbody.grant_types.includes(\"implicit\") &&\n\t\t\t\t\t\t\t!body.response_types.includes(\"token\")\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_client_metadata\",\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"When 'implicit' grant type is used, 'token' response type must be included\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst clientId =\n\t\t\t\t\t\toptions.generateClientId?.() ||\n\t\t\t\t\t\tgenerateRandomString(32, \"a-z\", \"A-Z\");\n\t\t\t\t\tconst clientSecret =\n\t\t\t\t\t\toptions.generateClientSecret?.() ||\n\t\t\t\t\t\tgenerateRandomString(32, \"a-z\", \"A-Z\");\n\n\t\t\t\t\tconst storedClientSecret = await storeClientSecret(ctx, clientSecret);\n\n\t\t\t\t\t// Create the client with the existing schema\n\t\t\t\t\tconst client: Client = await ctx.context.adapter.create({\n\t\t\t\t\t\tmodel: modelName.oauthClient,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tname: body.client_name,\n\t\t\t\t\t\t\ticon: body.logo_uri,\n\t\t\t\t\t\t\tmetadata: body.metadata ? JSON.stringify(body.metadata) : null,\n\t\t\t\t\t\t\tclientId: clientId,\n\t\t\t\t\t\t\tclientSecret: storedClientSecret,\n\t\t\t\t\t\t\tredirectUrls: body.redirect_uris.join(\",\"),\n\t\t\t\t\t\t\ttype: \"web\",\n\t\t\t\t\t\t\tauthenticationScheme:\n\t\t\t\t\t\t\t\tbody.token_endpoint_auth_method || \"client_secret_basic\",\n\t\t\t\t\t\t\tdisabled: false,\n\t\t\t\t\t\t\tuserId: session?.session.userId,\n\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\t// Format the response according to RFC7591\n\t\t\t\t\treturn ctx.json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tclient_id: clientId,\n\t\t\t\t\t\t\t...(client.type !== \"public\"\n\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\tclient_secret: clientSecret,\n\t\t\t\t\t\t\t\t\t\tclient_secret_expires_at: 0, // 0 means it doesn't expire\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t\tclient_id_issued_at: Math.floor(Date.now() / 1000),\n\t\t\t\t\t\t\tclient_secret_expires_at: 0, // 0 means it doesn't expire\n\t\t\t\t\t\t\tredirect_uris: body.redirect_uris,\n\t\t\t\t\t\t\ttoken_endpoint_auth_method:\n\t\t\t\t\t\t\t\tbody.token_endpoint_auth_method || \"client_secret_basic\",\n\t\t\t\t\t\t\tgrant_types: body.grant_types || [\"authorization_code\"],\n\t\t\t\t\t\t\tresponse_types: body.response_types || [\"code\"],\n\t\t\t\t\t\t\tclient_name: body.client_name,\n\t\t\t\t\t\t\tclient_uri: body.client_uri,\n\t\t\t\t\t\t\tlogo_uri: body.logo_uri,\n\t\t\t\t\t\t\tscope: body.scope,\n\t\t\t\t\t\t\tcontacts: body.contacts,\n\t\t\t\t\t\t\ttos_uri: body.tos_uri,\n\t\t\t\t\t\t\tpolicy_uri: body.policy_uri,\n\t\t\t\t\t\t\tjwks_uri: body.jwks_uri,\n\t\t\t\t\t\t\tjwks: body.jwks,\n\t\t\t\t\t\t\tsoftware_id: body.software_id,\n\t\t\t\t\t\t\tsoftware_version: body.software_version,\n\t\t\t\t\t\t\tsoftware_statement: body.software_statement,\n\t\t\t\t\t\t\tmetadata: body.metadata,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstatus: 201,\n\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\"Cache-Control\": \"no-store\",\n\t\t\t\t\t\t\t\tPragma: \"no-cache\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t),\n\t\t\tgetOAuthClient: createAuthEndpoint(\n\t\t\t\t\"/oauth2/client/:id\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Get OAuth2 client details\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"OAuth2 client retrieved successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tclientId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier for the client\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Name of the OAuth2 application\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\ticon: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Icon URL for the application\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"clientId\", \"name\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (\n\t\t\t\t\tctx,\n\t\t\t\t): Promise<{\n\t\t\t\t\tclientId: string;\n\t\t\t\t\tname: string;\n\t\t\t\t\ticon: string | null;\n\t\t\t\t}> => {\n\t\t\t\t\tconst client = await getClient(ctx.params.id, trustedClients);\n\t\t\t\t\tif (!client) {\n\t\t\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\t\t\terror_description: \"client not found\",\n\t\t\t\t\t\t\terror: \"not_found\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tclientId: client.clientId,\n\t\t\t\t\t\tname: client.name,\n\t\t\t\t\t\ticon: client.icon || null,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * GET/POST `/oauth2/endsession`\n\t\t\t *\n\t\t\t * Implements RP-Initiated Logout as per OpenID Connect RP-Initiated Logout 1.0.\n\t\t\t * Allows relying parties to request that an OpenID Provider log out the end-user.\n\t\t\t *\n\t\t\t * @see [OpenID Connect RP-Initiated Logout Spec](https://openid.net/specs/openid-connect-rpinitiated-1_0.html)\n\t\t\t */\n\t\t\tendSession: createAuthEndpoint(\n\t\t\t\t\"/oauth2/endsession\",\n\t\t\t\t{\n\t\t\t\t\tmethod: [\"GET\", \"POST\"],\n\t\t\t\t\tquery: z\n\t\t\t\t\t\t.object({\n\t\t\t\t\t\t\tid_token_hint: z.string().optional(),\n\t\t\t\t\t\t\tlogout_hint: z.string().optional(),\n\t\t\t\t\t\t\tclient_id: z.string().optional(),\n\t\t\t\t\t\t\tpost_logout_redirect_uri: z.string().optional(),\n\t\t\t\t\t\t\tstate: z.string().optional(),\n\t\t\t\t\t\t\tui_locales: z.string().optional(),\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...HIDE_METADATA,\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"RP-Initiated Logout endpoint. Logs out the end-user and optionally redirects to a post-logout URI.\",\n\t\t\t\t\t\t\tparameters: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tname: \"id_token_hint\",\n\t\t\t\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\"Previously issued ID Token passed as a hint about the End-User's current authenticated session\",\n\t\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\t\tschema: { type: \"string\" },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tname: \"logout_hint\",\n\t\t\t\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\"Hint to the Authorization Server about the End-User that is logging out\",\n\t\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\t\tschema: { type: \"string\" },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tname: \"client_id\",\n\t\t\t\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\"OAuth 2.0 Client Identifier. Required if post_logout_redirect_uri is used without id_token_hint\",\n\t\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\t\tschema: { type: \"string\" },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tname: \"post_logout_redirect_uri\",\n\t\t\t\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\"URL to which the RP is requesting that the End-User's User Agent be redirected after a logout has been performed\",\n\t\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\t\tschema: { type: \"string\", format: \"uri\" },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tname: \"state\",\n\t\t\t\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\"Opaque value used by the RP to maintain state between the logout request and the callback\",\n\t\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\t\tschema: { type: \"string\" },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tname: \"ui_locales\",\n\t\t\t\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\"End-User's preferred languages and scripts for the user interface\",\n\t\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\t\tschema: { type: \"string\" },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t] as OpenAPIParameter[],\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"302\": {\n\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\"Redirect to post_logout_redirect_uri or logout confirmation page\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"Logout completed successfully\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst { id_token_hint, client_id, post_logout_redirect_uri, state } =\n\t\t\t\t\t\tctx.query || {};\n\n\t\t\t\t\tlet validatedClientId: string | null = null;\n\t\t\t\t\tlet validatedUserId: string | null = null;\n\n\t\t\t\t\t// Validate id_token_hint if provided\n\t\t\t\t\tif (id_token_hint) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst jwtPlugin = getJwtPlugin(ctx);\n\t\t\t\t\t\t\tif (jwtPlugin && jwtPlugin.options && options?.useJWTPlugin) {\n\t\t\t\t\t\t\t\t// For JWT plugin tokens, verify using JWKS\n\t\t\t\t\t\t\t\tconst verified = await verifyJWT(\n\t\t\t\t\t\t\t\t\tid_token_hint,\n\t\t\t\t\t\t\t\t\tjwtPlugin.options,\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tif (verified) {\n\t\t\t\t\t\t\t\t\tvalidatedUserId = verified.sub;\n\t\t\t\t\t\t\t\t\tvalidatedClientId = verified.aud\n\t\t\t\t\t\t\t\t\t\t? typeof verified.aud === \"string\"\n\t\t\t\t\t\t\t\t\t\t\t? verified.aud\n\t\t\t\t\t\t\t\t\t\t\t: verified.aud[0]!\n\t\t\t\t\t\t\t\t\t\t: null;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// For HS256 tokens, we need the client_id to verify\n\t\t\t\t\t\t\t\tif (client_id) {\n\t\t\t\t\t\t\t\t\tconst client = await getClient(client_id, trustedClients);\n\t\t\t\t\t\t\t\t\tif (client && client.clientSecret) {\n\t\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\t\tconst { payload } = await jwtVerify(\n\t\t\t\t\t\t\t\t\t\t\t\tid_token_hint,\n\t\t\t\t\t\t\t\t\t\t\t\tnew TextEncoder().encode(client.clientSecret),\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\tvalidatedUserId = payload.sub as string;\n\t\t\t\t\t\t\t\t\t\t\tvalidatedClientId = payload.aud as string;\n\t\t\t\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\t\t\t\t// Invalid token, continue with logout but no validation\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t// Invalid id_token_hint, but we continue with logout anyway\n\t\t\t\t\t\t\tctx.context.logger.debug(\n\t\t\t\t\t\t\t\t\"Invalid id_token_hint provided to end_session endpoint\",\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Validate client_id if provided\n\t\t\t\t\tif (client_id) {\n\t\t\t\t\t\tconst client = await getClient(client_id, trustedClients);\n\t\t\t\t\t\tif (!client) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t\terror_description: \"Invalid client_id\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// If we have a validated client from the token, ensure they match\n\t\t\t\t\t\tif (validatedClientId && validatedClientId !== client_id) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"client_id does not match the ID Token's audience\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvalidatedClientId = client_id;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Validate post_logout_redirect_uri if provided\n\t\t\t\t\tif (post_logout_redirect_uri) {\n\t\t\t\t\t\tif (!validatedClientId) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"client_id is required when using post_logout_redirect_uri without a valid id_token_hint\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst client = await getClient(validatedClientId, trustedClients);\n\t\t\t\t\t\tif (!client) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t\terror_description: \"Invalid client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst isValidRedirectUri = client.redirectUrls.some(\n\t\t\t\t\t\t\t(registeredUri) => post_logout_redirect_uri === registeredUri,\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (!isValidRedirectUri) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"post_logout_redirect_uri is not registered for this client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst session = await getSessionFromCtx(ctx);\n\n\t\t\t\t\tif (validatedUserId || session) {\n\t\t\t\t\t\tconst userId = validatedUserId || session?.user.id;\n\t\t\t\t\t\tif (userId) {\n\t\t\t\t\t\t\tawait ctx.context.adapter.deleteMany({\n\t\t\t\t\t\t\t\tmodel: modelName.oauthAccessToken,\n\t\t\t\t\t\t\t\twhere: [{ field: \"userId\", value: userId }],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (session) {\n\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteSession(\n\t\t\t\t\t\t\tsession.session.token,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tctx.setSignedCookie(\n\t\t\t\t\t\t\tctx.context.authCookies.sessionToken.name,\n\t\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tmaxAge: 0,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (post_logout_redirect_uri) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst redirectUrl = new URL(post_logout_redirect_uri);\n\t\t\t\t\t\t\tif (state) {\n\t\t\t\t\t\t\t\tredirectUrl.searchParams.set(\"state\", state);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn ctx.redirect(redirectUrl.toString());\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t\t\terror_description: \"Invalid post_logout_redirect_uri format\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\tmessage: \"Logout successful\",\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\tschema: mergeSchema(schema, options?.schema),\n\t\tget options() {\n\t\t\treturn opts;\n\t\t},\n\t} satisfies BetterAuthPlugin;\n};\nexport type * from \"./types\";\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { APIError } from \"better-call\";\nimport { getSessionFromCtx } from \"../../api\";\nimport { generateRandomString } from \"../../crypto\";\nimport type { OAuthApplication } from \"../oidc-provider/schema\";\nimport type {\n\tAuthorizationQuery,\n\tClient,\n\tOIDCOptions,\n} from \"../oidc-provider/types\";\n\nfunction redirectErrorURL(url: string, error: string, description: string) {\n\treturn `${\n\t\turl.includes(\"?\") ? \"&\" : \"?\"\n\t}error=${error}&error_description=${description}`;\n}\n\nexport async function authorizeMCPOAuth(\n\tctx: GenericEndpointContext,\n\toptions: OIDCOptions,\n) {\n\tctx.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n\tctx.setHeader(\"Access-Control-Allow-Methods\", \"POST, OPTIONS\");\n\tctx.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type, Authorization\");\n\tctx.setHeader(\"Access-Control-Max-Age\", \"86400\");\n\tconst opts = {\n\t\tcodeExpiresIn: 600,\n\t\tdefaultScope: \"openid\",\n\t\t...options,\n\t\tscopes: [\n\t\t\t\"openid\",\n\t\t\t\"profile\",\n\t\t\t\"email\",\n\t\t\t\"offline_access\",\n\t\t\t...(options?.scopes || []),\n\t\t],\n\t};\n\tif (!ctx.request) {\n\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\terror_description: \"request not found\",\n\t\t\terror: \"invalid_request\",\n\t\t});\n\t}\n\tconst session = await getSessionFromCtx(ctx);\n\tif (!session) {\n\t\t/**\n\t\t * If the user is not logged in, we need to redirect them to the\n\t\t * login page.\n\t\t */\n\t\tawait ctx.setSignedCookie(\n\t\t\t\"oidc_login_prompt\",\n\t\t\tJSON.stringify(ctx.query),\n\t\t\tctx.context.secret,\n\t\t\t{\n\t\t\t\tmaxAge: 600,\n\t\t\t\tpath: \"/\",\n\t\t\t\tsameSite: \"lax\",\n\t\t\t},\n\t\t);\n\t\tconst queryFromURL = ctx.request.url?.split(\"?\")[1]!;\n\t\tthrow ctx.redirect(`${options.loginPage}?${queryFromURL}`);\n\t}\n\n\tconst query = ctx.query as AuthorizationQuery;\n\tif (!query.client_id) {\n\t\tthrow ctx.redirect(`${ctx.context.baseURL}/error?error=invalid_client`);\n\t}\n\n\tif (!query.response_type) {\n\t\tthrow ctx.redirect(\n\t\t\tredirectErrorURL(\n\t\t\t\t`${ctx.context.baseURL}/error`,\n\t\t\t\t\"invalid_request\",\n\t\t\t\t\"response_type is required\",\n\t\t\t),\n\t\t);\n\t}\n\n\tconst client = await ctx.context.adapter\n\t\t.findOne<OAuthApplication>({\n\t\t\tmodel: \"oauthApplication\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"clientId\",\n\t\t\t\t\tvalue: ctx.query.client_id,\n\t\t\t\t},\n\t\t\t],\n\t\t})\n\t\t.then((res) => {\n\t\t\tif (!res) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\t...res,\n\t\t\t\tredirectUrls: res.redirectUrls.split(\",\"),\n\t\t\t\tmetadata: res.metadata ? JSON.parse(res.metadata) : {},\n\t\t\t} as Client;\n\t\t});\n\tif (!client) {\n\t\tthrow ctx.redirect(`${ctx.context.baseURL}/error?error=invalid_client`);\n\t}\n\tconst redirectURI = client.redirectUrls.find(\n\t\t(url) => url === ctx.query.redirect_uri,\n\t);\n\n\tif (!redirectURI || !query.redirect_uri) {\n\t\t/**\n\t\t * show UI error here warning the user that the redirect URI is invalid\n\t\t */\n\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\tmessage: \"Invalid redirect URI\",\n\t\t});\n\t}\n\tif (client.disabled) {\n\t\tthrow ctx.redirect(`${ctx.context.baseURL}/error?error=client_disabled`);\n\t}\n\n\tif (query.response_type !== \"code\") {\n\t\tthrow ctx.redirect(\n\t\t\t`${ctx.context.baseURL}/error?error=unsupported_response_type`,\n\t\t);\n\t}\n\n\tconst requestScope =\n\t\tquery.scope?.split(\" \").filter((s) => s) || opts.defaultScope.split(\" \");\n\tconst invalidScopes = requestScope.filter((scope) => {\n\t\treturn !opts.scopes.includes(scope);\n\t});\n\tif (invalidScopes.length) {\n\t\tthrow ctx.redirect(\n\t\t\tredirectErrorURL(\n\t\t\t\tquery.redirect_uri,\n\t\t\t\t\"invalid_scope\",\n\t\t\t\t`The following scopes are invalid: ${invalidScopes.join(\", \")}`,\n\t\t\t),\n\t\t);\n\t}\n\n\tif (\n\t\t(!query.code_challenge || !query.code_challenge_method) &&\n\t\toptions.requirePKCE\n\t) {\n\t\tthrow ctx.redirect(\n\t\t\tredirectErrorURL(\n\t\t\t\tquery.redirect_uri,\n\t\t\t\t\"invalid_request\",\n\t\t\t\t\"pkce is required\",\n\t\t\t),\n\t\t);\n\t}\n\n\tif (!query.code_challenge_method) {\n\t\tquery.code_challenge_method = \"plain\";\n\t}\n\n\tif (\n\t\t![\n\t\t\t\"s256\",\n\t\t\toptions.allowPlainCodeChallengeMethod ? \"plain\" : \"s256\",\n\t\t].includes(query.code_challenge_method?.toLowerCase() || \"\")\n\t) {\n\t\tthrow ctx.redirect(\n\t\t\tredirectErrorURL(\n\t\t\t\tquery.redirect_uri,\n\t\t\t\t\"invalid_request\",\n\t\t\t\t\"invalid code_challenge method\",\n\t\t\t),\n\t\t);\n\t}\n\n\tconst code = generateRandomString(32, \"a-z\", \"A-Z\", \"0-9\");\n\tconst codeExpiresInMs = opts.codeExpiresIn * 1000;\n\tconst expiresAt = new Date(Date.now() + codeExpiresInMs);\n\ttry {\n\t\t/**\n\t\t * Save the code in the database\n\t\t */\n\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\tvalue: JSON.stringify({\n\t\t\t\tclientId: client.clientId,\n\t\t\t\tredirectURI: query.redirect_uri,\n\t\t\t\tscope: requestScope,\n\t\t\t\tuserId: session.user.id,\n\t\t\t\tauthTime: new Date(session.session.createdAt).getTime(),\n\t\t\t\t/**\n\t\t\t\t * If the prompt is set to `consent`, then we need\n\t\t\t\t * to require the user to consent to the scopes.\n\t\t\t\t *\n\t\t\t\t * This means the code now needs to be treated as a\n\t\t\t\t * consent request.\n\t\t\t\t *\n\t\t\t\t * once the user consents, the code will be updated\n\t\t\t\t * with the actual code. This is to prevent the\n\t\t\t\t * client from using the code before the user\n\t\t\t\t * consents.\n\t\t\t\t */\n\t\t\t\trequireConsent: query.prompt === \"consent\",\n\t\t\t\tstate: query.prompt === \"consent\" ? query.state : null,\n\t\t\t\tcodeChallenge: query.code_challenge,\n\t\t\t\tcodeChallengeMethod: query.code_challenge_method,\n\t\t\t\tnonce: query.nonce,\n\t\t\t}),\n\t\t\tidentifier: code,\n\t\t\texpiresAt,\n\t\t});\n\t} catch {\n\t\tthrow ctx.redirect(\n\t\t\tredirectErrorURL(\n\t\t\t\tquery.redirect_uri,\n\t\t\t\t\"server_error\",\n\t\t\t\t\"An error occurred while processing the request\",\n\t\t\t),\n\t\t);\n\t}\n\n\t// Consent is NOT required - redirect with the code immediately\n\tif (query.prompt !== \"consent\") {\n\t\tconst redirectURIWithCode = new URL(redirectURI);\n\t\tredirectURIWithCode.searchParams.set(\"code\", code);\n\t\tif (ctx.query.state) {\n\t\t\tredirectURIWithCode.searchParams.set(\"state\", ctx.query.state);\n\t\t}\n\t\tthrow ctx.redirect(redirectURIWithCode.toString());\n\t}\n\n\t// Consent is REQUIRED - redirect to consent page or show consent HTML\n\tif (options?.consentPage) {\n\t\t// Set cookie to support cookie-based consent flows\n\t\tawait ctx.setSignedCookie(\"oidc_consent_prompt\", code, ctx.context.secret, {\n\t\t\tmaxAge: 600,\n\t\t\tpath: \"/\",\n\t\t\tsameSite: \"lax\",\n\t\t});\n\n\t\t// Pass the consent code as a URL parameter to support URL-BASED consent flows\n\t\tconst urlParams = new URLSearchParams();\n\t\turlParams.set(\"consent_code\", code);\n\t\turlParams.set(\"client_id\", client.clientId);\n\t\turlParams.set(\"scope\", requestScope.join(\" \"));\n\t\tconst consentURI = `${options.consentPage}?${urlParams.toString()}`;\n\n\t\tthrow ctx.redirect(consentURI);\n\t}\n\n\t// No consent page configured - fall back to direct redirect with code\n\tconst redirectURIWithCode = new URL(redirectURI);\n\tredirectURIWithCode.searchParams.set(\"code\", code);\n\tif (ctx.query.state) {\n\t\tredirectURIWithCode.searchParams.set(\"state\", ctx.query.state);\n\t}\n\tthrow ctx.redirect(redirectURIWithCode.toString());\n}\n", "import type {\n\tBetterAuthOptions,\n\tBetterAuthPlugin,\n\tGenericEndpointContext,\n} from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport { isProduction, logger } from \"@better-auth/core/env\";\nimport { getWebcryptoSubtle } from \"@better-auth/utils\";\nimport { base64 } from \"@better-auth/utils/base64\";\nimport { createHash } from \"@better-auth/utils/hash\";\nimport { SignJWT } from \"jose\";\nimport * as z from \"zod\";\nimport { APIError, getSessionFromCtx } from \"../../api\";\nimport { parseSetCookieHeader } from \"../../cookies\";\nimport { generateRandomString } from \"../../crypto\";\nimport { HIDE_METADATA } from \"../../utils\";\nimport { getBaseURL } from \"../../utils/url\";\nimport type {\n\tClient,\n\tCodeVerificationValue,\n\tOAuthAccessToken,\n\tOIDCMetadata,\n\tOIDCOptions,\n} from \"../oidc-provider\";\nimport { oidcProvider } from \"../oidc-provider\";\nimport { schema } from \"../oidc-provider/schema\";\nimport { parsePrompt } from \"../oidc-provider/utils/prompt\";\nimport { authorizeMCPOAuth } from \"./authorize\";\n\ninterface MCPOptions {\n\tloginPage: string;\n\tresource?: string | undefined;\n\toidcConfig?: OIDCOptions | undefined;\n}\n\nexport const getMCPProviderMetadata = (\n\tctx: GenericEndpointContext,\n\toptions?: OIDCOptions | undefined,\n): OIDCMetadata => {\n\tconst issuer = ctx.context.options.baseURL as string;\n\tconst baseURL = ctx.context.baseURL;\n\tif (!issuer || !baseURL) {\n\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\terror: \"invalid_issuer\",\n\t\t\terror_description:\n\t\t\t\t\"issuer or baseURL is not set. If you're the app developer, please make sure to set the `baseURL` in your auth config.\",\n\t\t});\n\t}\n\treturn {\n\t\tissuer,\n\t\tauthorization_endpoint: `${baseURL}/mcp/authorize`,\n\t\ttoken_endpoint: `${baseURL}/mcp/token`,\n\t\tuserinfo_endpoint: `${baseURL}/mcp/userinfo`,\n\t\tjwks_uri: `${baseURL}/mcp/jwks`,\n\t\tregistration_endpoint: `${baseURL}/mcp/register`,\n\t\tscopes_supported: [\"openid\", \"profile\", \"email\", \"offline_access\"],\n\t\tresponse_types_supported: [\"code\"],\n\t\tresponse_modes_supported: [\"query\"],\n\t\tgrant_types_supported: [\"authorization_code\", \"refresh_token\"],\n\t\tacr_values_supported: [\n\t\t\t\"urn:mace:incommon:iap:silver\",\n\t\t\t\"urn:mace:incommon:iap:bronze\",\n\t\t],\n\t\tsubject_types_supported: [\"public\"],\n\t\tid_token_signing_alg_values_supported: [\"RS256\", \"none\"],\n\t\ttoken_endpoint_auth_methods_supported: [\n\t\t\t\"client_secret_basic\",\n\t\t\t\"client_secret_post\",\n\t\t\t\"none\",\n\t\t],\n\t\tcode_challenge_methods_supported: [\"S256\"],\n\t\tclaims_supported: [\n\t\t\t\"sub\",\n\t\t\t\"iss\",\n\t\t\t\"aud\",\n\t\t\t\"exp\",\n\t\t\t\"nbf\",\n\t\t\t\"iat\",\n\t\t\t\"jti\",\n\t\t\t\"email\",\n\t\t\t\"email_verified\",\n\t\t\t\"name\",\n\t\t],\n\t\t...options?.metadata,\n\t};\n};\n\nexport const getMCPProtectedResourceMetadata = (\n\tctx: GenericEndpointContext,\n\toptions?: MCPOptions | undefined,\n) => {\n\tconst baseURL = ctx.context.baseURL;\n\tconst origin = new URL(baseURL).origin;\n\n\treturn {\n\t\tresource: options?.resource ?? origin,\n\t\tauthorization_servers: [origin],\n\t\tjwks_uri: options?.oidcConfig?.metadata?.jwks_uri ?? `${baseURL}/mcp/jwks`,\n\t\tscopes_supported: options?.oidcConfig?.metadata?.scopes_supported ?? [\n\t\t\t\"openid\",\n\t\t\t\"profile\",\n\t\t\t\"email\",\n\t\t\t\"offline_access\",\n\t\t],\n\t\tbearer_methods_supported: [\"header\"],\n\t\tresource_signing_alg_values_supported: [\"RS256\", \"none\"],\n\t};\n};\n\nconst registerMcpClientBodySchema = z.object({\n\tredirect_uris: z.array(z.string()),\n\ttoken_endpoint_auth_method: z\n\t\t.enum([\"none\", \"client_secret_basic\", \"client_secret_post\"])\n\t\t.default(\"client_secret_basic\")\n\t\t.optional(),\n\tgrant_types: z\n\t\t.array(\n\t\t\tz.enum([\n\t\t\t\t\"authorization_code\",\n\t\t\t\t\"implicit\",\n\t\t\t\t\"password\",\n\t\t\t\t\"client_credentials\",\n\t\t\t\t\"refresh_token\",\n\t\t\t\t\"urn:ietf:params:oauth:grant-type:jwt-bearer\",\n\t\t\t\t\"urn:ietf:params:oauth:grant-type:saml2-bearer\",\n\t\t\t]),\n\t\t)\n\t\t.default([\"authorization_code\"])\n\t\t.optional(),\n\tresponse_types: z\n\t\t.array(z.enum([\"code\", \"token\"]))\n\t\t.default([\"code\"])\n\t\t.optional(),\n\tclient_name: z.string().optional(),\n\tclient_uri: z.string().optional(),\n\tlogo_uri: z.string().optional(),\n\tscope: z.string().optional(),\n\tcontacts: z.array(z.string()).optional(),\n\ttos_uri: z.string().optional(),\n\tpolicy_uri: z.string().optional(),\n\tjwks_uri: z.string().optional(),\n\tjwks: z.record(z.string(), z.any()).optional(),\n\tmetadata: z.record(z.any(), z.any()).optional(),\n\tsoftware_id: z.string().optional(),\n\tsoftware_version: z.string().optional(),\n\tsoftware_statement: z.string().optional(),\n});\n\nconst mcpOAuthTokenBodySchema = z.record(z.any(), z.any());\n\nexport const mcp = (options: MCPOptions) => {\n\tconst opts = {\n\t\tcodeExpiresIn: 600,\n\t\tdefaultScope: \"openid\",\n\t\taccessTokenExpiresIn: 3600,\n\t\trefreshTokenExpiresIn: 604800,\n\t\tallowPlainCodeChallengeMethod: true,\n\t\t...options.oidcConfig,\n\t\tloginPage: options.loginPage,\n\t\tscopes: [\n\t\t\t\"openid\",\n\t\t\t\"profile\",\n\t\t\t\"email\",\n\t\t\t\"offline_access\",\n\t\t\t...(options.oidcConfig?.scopes || []),\n\t\t],\n\t};\n\tconst modelName = {\n\t\toauthClient: \"oauthApplication\",\n\t\toauthAccessToken: \"oauthAccessToken\",\n\t\toauthConsent: \"oauthConsent\",\n\t};\n\tconst provider = oidcProvider(opts);\n\treturn {\n\t\tid: \"mcp\",\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher() {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst cookie = await ctx.getSignedCookie(\n\t\t\t\t\t\t\t\"oidc_login_prompt\",\n\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst cookieName = ctx.context.authCookies.sessionToken.name;\n\t\t\t\t\t\tconst parsedSetCookieHeader = parseSetCookieHeader(\n\t\t\t\t\t\t\tctx.context.responseHeaders?.get(\"set-cookie\") || \"\",\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst hasSessionToken = parsedSetCookieHeader.has(cookieName);\n\t\t\t\t\t\tif (!cookie || !hasSessionToken) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tctx.setCookie(\"oidc_login_prompt\", \"\", {\n\t\t\t\t\t\t\tmaxAge: 0,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst sessionCookie = parsedSetCookieHeader.get(cookieName)?.value;\n\t\t\t\t\t\tconst sessionToken = sessionCookie?.split(\".\")[0]!;\n\t\t\t\t\t\tif (!sessionToken) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst session =\n\t\t\t\t\t\t\t(await ctx.context.internalAdapter.findSession(sessionToken)) ||\n\t\t\t\t\t\t\tctx.context.newSession;\n\t\t\t\t\t\tif (!session) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Remove \"login\" from prompt since user just logged in\n\t\t\t\t\t\tconst promptSet = parsePrompt(String(ctx.query?.prompt));\n\t\t\t\t\t\tif (promptSet.has(\"login\")) {\n\t\t\t\t\t\t\tconst newPromptSet = new Set(promptSet);\n\t\t\t\t\t\t\tnewPromptSet.delete(\"login\");\n\t\t\t\t\t\t\tctx.query = {\n\t\t\t\t\t\t\t\t...ctx.query,\n\t\t\t\t\t\t\t\tprompt: Array.from(newPromptSet).join(\" \"),\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tctx.context.session = session;\n\t\t\t\t\t\tconst response = await authorizeMCPOAuth(ctx, opts);\n\t\t\t\t\t\treturn response;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tendpoints: {\n\t\t\toAuthConsent: provider.endpoints.oAuthConsent,\n\t\t\tgetMcpOAuthConfig: createAuthEndpoint(\n\t\t\t\t\"/.well-known/oauth-authorization-server\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tmetadata: HIDE_METADATA,\n\t\t\t\t},\n\t\t\t\tasync (c) => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst metadata = getMCPProviderMetadata(c, options);\n\t\t\t\t\t\treturn c.json(metadata);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tconsole.log(e);\n\t\t\t\t\t\treturn c.json(null);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t),\n\t\t\tgetMCPProtectedResource: createAuthEndpoint(\n\t\t\t\t\"/.well-known/oauth-protected-resource\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tmetadata: HIDE_METADATA,\n\t\t\t\t},\n\t\t\t\tasync (c) => {\n\t\t\t\t\tconst metadata = getMCPProtectedResourceMetadata(c, options);\n\t\t\t\t\treturn c.json(metadata);\n\t\t\t\t},\n\t\t\t),\n\t\t\tmcpOAuthAuthorize: createAuthEndpoint(\n\t\t\t\t\"/mcp/authorize\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tquery: z.record(z.string(), z.any()),\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Authorize an OAuth2 request using MCP\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"Authorization response generated successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Authorization response, contents depend on the authorize function implementation\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\treturn authorizeMCPOAuth(ctx, opts);\n\t\t\t\t},\n\t\t\t),\n\t\t\tmcpOAuthToken: createAuthEndpoint(\n\t\t\t\t\"/mcp/token\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: mcpOAuthTokenBodySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...HIDE_METADATA,\n\t\t\t\t\t\tallowedMediaTypes: [\n\t\t\t\t\t\t\t\"application/x-www-form-urlencoded\",\n\t\t\t\t\t\t\t\"application/json\",\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\t//cors\n\t\t\t\t\tctx.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n\t\t\t\t\tctx.setHeader(\"Access-Control-Allow-Methods\", \"POST, OPTIONS\");\n\t\t\t\t\tctx.setHeader(\n\t\t\t\t\t\t\"Access-Control-Allow-Headers\",\n\t\t\t\t\t\t\"Content-Type, Authorization\",\n\t\t\t\t\t);\n\t\t\t\t\tctx.setHeader(\"Access-Control-Max-Age\", \"86400\");\n\n\t\t\t\t\tlet { body } = ctx;\n\t\t\t\t\tif (!body) {\n\t\t\t\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"request body not found\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (body instanceof FormData) {\n\t\t\t\t\t\tbody = Object.fromEntries(body.entries());\n\t\t\t\t\t}\n\t\t\t\t\tif (!(body instanceof Object)) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"request body is not an object\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tlet { client_id, client_secret } = body;\n\t\t\t\t\tconst authorization =\n\t\t\t\t\t\tctx.request?.headers.get(\"authorization\") || null;\n\t\t\t\t\tif (\n\t\t\t\t\t\tauthorization &&\n\t\t\t\t\t\t!client_id &&\n\t\t\t\t\t\t!client_secret &&\n\t\t\t\t\t\tauthorization.startsWith(\"Basic \")\n\t\t\t\t\t) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst encoded = authorization.replace(\"Basic \", \"\");\n\t\t\t\t\t\t\tconst decoded = new TextDecoder().decode(base64.decode(encoded));\n\t\t\t\t\t\t\tif (!decoded.includes(\":\")) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\t\terror_description: \"invalid authorization header format\",\n\t\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst [id, secret] = decoded.split(\":\");\n\t\t\t\t\t\t\tif (!id || !secret) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\t\terror_description: \"invalid authorization header format\",\n\t\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tclient_id = id;\n\t\t\t\t\t\t\tclient_secret = secret;\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"invalid authorization header format\",\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tconst {\n\t\t\t\t\t\tgrant_type,\n\t\t\t\t\t\tcode,\n\t\t\t\t\t\tredirect_uri,\n\t\t\t\t\t\trefresh_token,\n\t\t\t\t\t\tcode_verifier,\n\t\t\t\t\t} = body;\n\t\t\t\t\tif (grant_type === \"refresh_token\") {\n\t\t\t\t\t\tif (!refresh_token) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror_description: \"refresh_token is required\",\n\t\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst token = await ctx.context.adapter.findOne<OAuthAccessToken>({\n\t\t\t\t\t\t\tmodel: \"oauthAccessToken\",\n\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tfield: \"refreshToken\",\n\t\t\t\t\t\t\t\t\tvalue: refresh_token.toString(),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (!token) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"invalid refresh token\",\n\t\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (token.clientId !== client_id?.toString()) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"invalid client_id\",\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (token.refreshTokenExpiresAt < new Date()) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"refresh token expired\",\n\t\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst accessToken = generateRandomString(32, \"a-z\", \"A-Z\");\n\t\t\t\t\t\tconst newRefreshToken = generateRandomString(32, \"a-z\", \"A-Z\");\n\t\t\t\t\t\tconst accessTokenExpiresAt = new Date(\n\t\t\t\t\t\t\tDate.now() + opts.accessTokenExpiresIn * 1000,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst refreshTokenExpiresAt = new Date(\n\t\t\t\t\t\t\tDate.now() + opts.refreshTokenExpiresIn * 1000,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\t\tmodel: modelName.oauthAccessToken,\n\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\taccessToken,\n\t\t\t\t\t\t\t\trefreshToken: newRefreshToken,\n\t\t\t\t\t\t\t\taccessTokenExpiresAt,\n\t\t\t\t\t\t\t\trefreshTokenExpiresAt,\n\t\t\t\t\t\t\t\tclientId: client_id.toString(),\n\t\t\t\t\t\t\t\tuserId: token.userId,\n\t\t\t\t\t\t\t\tscopes: token.scopes,\n\t\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\taccess_token: accessToken,\n\t\t\t\t\t\t\ttoken_type: \"bearer\",\n\t\t\t\t\t\t\texpires_in: opts.accessTokenExpiresIn,\n\t\t\t\t\t\t\trefresh_token: newRefreshToken,\n\t\t\t\t\t\t\tscope: token.scopes,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!code) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"code is required\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (opts.requirePKCE && !code_verifier) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"code verifier is missing\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t/**\n\t\t\t\t\t * We need to check if the code is valid before we can proceed\n\t\t\t\t\t * with the rest of the request.\n\t\t\t\t\t */\n\t\t\t\t\tconst verificationValue =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t\t\tcode.toString(),\n\t\t\t\t\t\t);\n\t\t\t\t\tif (!verificationValue) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid code\",\n\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (verificationValue.expiresAt < new Date()) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"code expired\",\n\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t);\n\n\t\t\t\t\tif (!client_id) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"client_id is required\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (!grant_type) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"grant_type is required\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (grant_type !== \"authorization_code\") {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"grant_type must be 'authorization_code'\",\n\t\t\t\t\t\t\terror: \"unsupported_grant_type\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!redirect_uri) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"redirect_uri is required\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst client = await ctx.context.adapter\n\t\t\t\t\t\t.findOne<Record<string, any>>({\n\t\t\t\t\t\t\tmodel: modelName.oauthClient,\n\t\t\t\t\t\t\twhere: [{ field: \"clientId\", value: client_id.toString() }],\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then((res) => {\n\t\t\t\t\t\t\tif (!res) {\n\t\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t...res,\n\t\t\t\t\t\t\t\tredirectUrls: res.redirectUrls.split(\",\"),\n\t\t\t\t\t\t\t\tmetadata: res.metadata ? JSON.parse(res.metadata) : {},\n\t\t\t\t\t\t\t} as Client;\n\t\t\t\t\t\t});\n\t\t\t\t\tif (!client) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid client_id\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (client.disabled) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"client is disabled\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// For public clients (type: 'public'), validate PKCE instead of client_secret\n\t\t\t\t\tif (client.type === \"public\") {\n\t\t\t\t\t\t// Public clients must use PKCE\n\t\t\t\t\t\tif (!code_verifier) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"code verifier is required for public clients\",\n\t\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// PKCE validation happens later in the flow, so we skip client_secret validation\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// For confidential clients, validate client_secret\n\t\t\t\t\t\tif (!client_secret) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"client_secret is required for confidential clients\",\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst isValidSecret =\n\t\t\t\t\t\t\tclient.clientSecret === client_secret.toString();\n\t\t\t\t\t\tif (!isValidSecret) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\terror_description: \"invalid client_secret\",\n\t\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tconst value = JSON.parse(\n\t\t\t\t\t\tverificationValue.value,\n\t\t\t\t\t) as CodeVerificationValue;\n\t\t\t\t\tif (value.clientId !== client_id.toString()) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid client_id\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (value.redirectURI !== redirect_uri.toString()) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"invalid redirect_uri\",\n\t\t\t\t\t\t\terror: \"invalid_client\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (value.codeChallenge && !code_verifier) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror_description: \"code verifier is missing\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst challenge =\n\t\t\t\t\t\tvalue.codeChallengeMethod === \"plain\"\n\t\t\t\t\t\t\t? code_verifier\n\t\t\t\t\t\t\t: await createHash(\"SHA-256\", \"base64urlnopad\").digest(\n\t\t\t\t\t\t\t\t\tcode_verifier,\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\tif (challenge !== value.codeChallenge) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"code verification failed\",\n\t\t\t\t\t\t\terror: \"invalid_request\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst requestedScopes = value.scope;\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t);\n\t\t\t\t\tconst accessToken = generateRandomString(32, \"a-z\", \"A-Z\");\n\t\t\t\t\tconst refreshToken = generateRandomString(32, \"A-Z\", \"a-z\");\n\t\t\t\t\tconst accessTokenExpiresAt = new Date(\n\t\t\t\t\t\tDate.now() + opts.accessTokenExpiresIn * 1000,\n\t\t\t\t\t);\n\t\t\t\t\tconst refreshTokenExpiresAt = new Date(\n\t\t\t\t\t\tDate.now() + opts.refreshTokenExpiresIn * 1000,\n\t\t\t\t\t);\n\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\tmodel: modelName.oauthAccessToken,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\taccessToken,\n\t\t\t\t\t\t\trefreshToken,\n\t\t\t\t\t\t\taccessTokenExpiresAt,\n\t\t\t\t\t\t\trefreshTokenExpiresAt,\n\t\t\t\t\t\t\tclientId: client_id.toString(),\n\t\t\t\t\t\t\tuserId: value.userId,\n\t\t\t\t\t\t\tscopes: requestedScopes.join(\" \"),\n\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tconst user = await ctx.context.internalAdapter.findUserById(\n\t\t\t\t\t\tvalue.userId,\n\t\t\t\t\t);\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\terror_description: \"user not found\",\n\t\t\t\t\t\t\terror: \"invalid_grant\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tlet secretKey = {\n\t\t\t\t\t\talg: \"HS256\",\n\t\t\t\t\t\tkey: await getWebcryptoSubtle().generateKey(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tname: \"HMAC\",\n\t\t\t\t\t\t\t\thash: \"SHA-256\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t\t[\"sign\", \"verify\"],\n\t\t\t\t\t\t),\n\t\t\t\t\t};\n\t\t\t\t\tconst profile = {\n\t\t\t\t\t\tgiven_name: user.name.split(\" \")[0]!,\n\t\t\t\t\t\tfamily_name: user.name.split(\" \")[1]!,\n\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\tprofile: user.image,\n\t\t\t\t\t\tupdated_at: Math.floor(new Date(user.updatedAt).getTime() / 1000),\n\t\t\t\t\t};\n\t\t\t\t\tconst email = {\n\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\temail_verified: user.emailVerified,\n\t\t\t\t\t};\n\t\t\t\t\tconst userClaims = {\n\t\t\t\t\t\t...(requestedScopes.includes(\"profile\") ? profile : {}),\n\t\t\t\t\t\t...(requestedScopes.includes(\"email\") ? email : {}),\n\t\t\t\t\t};\n\n\t\t\t\t\tconst additionalUserClaims = opts.getAdditionalUserInfoClaim\n\t\t\t\t\t\t? await opts.getAdditionalUserInfoClaim(\n\t\t\t\t\t\t\t\tuser,\n\t\t\t\t\t\t\t\trequestedScopes,\n\t\t\t\t\t\t\t\tclient,\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t: {};\n\n\t\t\t\t\tconst idToken = await new SignJWT({\n\t\t\t\t\t\tsub: user.id,\n\t\t\t\t\t\taud: client_id.toString(),\n\t\t\t\t\t\tiat: Date.now(),\n\t\t\t\t\t\tauth_time: ctx.context.session\n\t\t\t\t\t\t\t? new Date(ctx.context.session.session.createdAt).getTime()\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\tnonce: value.nonce,\n\t\t\t\t\t\tacr: \"urn:mace:incommon:iap:silver\", // default to silver -  this should be configurable and should be validated against the client's metadata\n\t\t\t\t\t\t...userClaims,\n\t\t\t\t\t\t...additionalUserClaims,\n\t\t\t\t\t})\n\t\t\t\t\t\t.setProtectedHeader({ alg: secretKey.alg })\n\t\t\t\t\t\t.setIssuedAt()\n\t\t\t\t\t\t.setExpirationTime(\n\t\t\t\t\t\t\tMath.floor(Date.now() / 1000) + opts.accessTokenExpiresIn,\n\t\t\t\t\t\t)\n\t\t\t\t\t\t.sign(secretKey.key);\n\t\t\t\t\treturn ctx.json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\taccess_token: accessToken,\n\t\t\t\t\t\t\ttoken_type: \"Bearer\",\n\t\t\t\t\t\t\texpires_in: opts.accessTokenExpiresIn,\n\t\t\t\t\t\t\trefresh_token: requestedScopes.includes(\"offline_access\")\n\t\t\t\t\t\t\t\t? refreshToken\n\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\t\tscope: requestedScopes.join(\" \"),\n\t\t\t\t\t\t\tid_token: requestedScopes.includes(\"openid\")\n\t\t\t\t\t\t\t\t? idToken\n\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\"Cache-Control\": \"no-store\",\n\t\t\t\t\t\t\t\tPragma: \"no-cache\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t),\n\t\t\tregisterMcpClient: createAuthEndpoint(\n\t\t\t\t\"/mcp/register\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: registerMcpClientBodySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Register an OAuth2 application\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"OAuth2 application registered successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Name of the OAuth2 application\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\ticon: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Icon URL for the application\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Additional metadata for the application\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tclientId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier for the client\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tclientSecret: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Secret key for the client. Not included for public clients.\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tredirectUrls: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\titems: { type: \"string\", format: \"uri\" },\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"List of allowed redirect URLs\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Type of the client\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tenum: [\"web\", \"public\"],\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tauthenticationScheme: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Authentication scheme used by the client\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tenum: [\"client_secret\", \"none\"],\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabled: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the client is disabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tenum: [false],\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"ID of the user who registered the client, null if registered anonymously\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Creation timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Last update timestamp\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"clientId\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"redirectUrls\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"type\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"authenticationScheme\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"disabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst body = ctx.body;\n\t\t\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\t\t\tctx.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n\t\t\t\t\tctx.setHeader(\"Access-Control-Allow-Methods\", \"POST, OPTIONS\");\n\t\t\t\t\tctx.setHeader(\n\t\t\t\t\t\t\"Access-Control-Allow-Headers\",\n\t\t\t\t\t\t\"Content-Type, Authorization\",\n\t\t\t\t\t);\n\t\t\t\t\tctx.setHeader(\"Access-Control-Max-Age\", \"86400\");\n\t\t\t\t\tctx.headers?.set(\"Access-Control-Max-Age\", \"86400\");\n\t\t\t\t\tif (\n\t\t\t\t\t\t(!body.grant_types ||\n\t\t\t\t\t\t\tbody.grant_types.includes(\"authorization_code\") ||\n\t\t\t\t\t\t\tbody.grant_types.includes(\"implicit\")) &&\n\t\t\t\t\t\t(!body.redirect_uris || body.redirect_uris.length === 0)\n\t\t\t\t\t) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\terror: \"invalid_redirect_uri\",\n\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\"Redirect URIs are required for authorization_code and implicit grant types\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (body.grant_types && body.response_types) {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tbody.grant_types.includes(\"authorization_code\") &&\n\t\t\t\t\t\t\t!body.response_types.includes(\"code\")\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_client_metadata\",\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"When 'authorization_code' grant type is used, 'code' response type must be included\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tbody.grant_types.includes(\"implicit\") &&\n\t\t\t\t\t\t\t!body.response_types.includes(\"token\")\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\terror: \"invalid_client_metadata\",\n\t\t\t\t\t\t\t\terror_description:\n\t\t\t\t\t\t\t\t\t\"When 'implicit' grant type is used, 'token' response type must be included\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst clientId =\n\t\t\t\t\t\topts.generateClientId?.() || generateRandomString(32, \"a-z\", \"A-Z\");\n\t\t\t\t\tconst clientSecret =\n\t\t\t\t\t\topts.generateClientSecret?.() ||\n\t\t\t\t\t\tgenerateRandomString(32, \"a-z\", \"A-Z\");\n\n\t\t\t\t\t// Determine client type based on auth method\n\t\t\t\t\tconst clientType =\n\t\t\t\t\t\tbody.token_endpoint_auth_method === \"none\" ? \"public\" : \"web\";\n\t\t\t\t\tconst finalClientSecret = clientType === \"public\" ? \"\" : clientSecret;\n\n\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\tmodel: modelName.oauthClient,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tname: body.client_name,\n\t\t\t\t\t\t\ticon: body.logo_uri,\n\t\t\t\t\t\t\tmetadata: body.metadata ? JSON.stringify(body.metadata) : null,\n\t\t\t\t\t\t\tclientId: clientId,\n\t\t\t\t\t\t\tclientSecret: finalClientSecret,\n\t\t\t\t\t\t\tredirectUrls: body.redirect_uris.join(\",\"),\n\t\t\t\t\t\t\ttype: clientType,\n\t\t\t\t\t\t\tauthenticationScheme:\n\t\t\t\t\t\t\t\tbody.token_endpoint_auth_method || \"client_secret_basic\",\n\t\t\t\t\t\t\tdisabled: false,\n\t\t\t\t\t\t\tuserId: session?.session.userId,\n\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\tconst responseData = {\n\t\t\t\t\t\tclient_id: clientId,\n\t\t\t\t\t\tclient_id_issued_at: Math.floor(Date.now() / 1000),\n\t\t\t\t\t\tredirect_uris: body.redirect_uris,\n\t\t\t\t\t\ttoken_endpoint_auth_method:\n\t\t\t\t\t\t\tbody.token_endpoint_auth_method || \"client_secret_basic\",\n\t\t\t\t\t\tgrant_types: body.grant_types || [\"authorization_code\"],\n\t\t\t\t\t\tresponse_types: body.response_types || [\"code\"],\n\t\t\t\t\t\tclient_name: body.client_name,\n\t\t\t\t\t\tclient_uri: body.client_uri,\n\t\t\t\t\t\tlogo_uri: body.logo_uri,\n\t\t\t\t\t\tscope: body.scope,\n\t\t\t\t\t\tcontacts: body.contacts,\n\t\t\t\t\t\ttos_uri: body.tos_uri,\n\t\t\t\t\t\tpolicy_uri: body.policy_uri,\n\t\t\t\t\t\tjwks_uri: body.jwks_uri,\n\t\t\t\t\t\tjwks: body.jwks,\n\t\t\t\t\t\tsoftware_id: body.software_id,\n\t\t\t\t\t\tsoftware_version: body.software_version,\n\t\t\t\t\t\tsoftware_statement: body.software_statement,\n\t\t\t\t\t\tmetadata: body.metadata,\n\t\t\t\t\t\t...(clientType !== \"public\"\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tclient_secret: finalClientSecret,\n\t\t\t\t\t\t\t\t\tclient_secret_expires_at: 0, // 0 means it doesn't expire\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t};\n\n\t\t\t\t\treturn new Response(JSON.stringify(responseData), {\n\t\t\t\t\t\tstatus: 201,\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\t\t\t\"Cache-Control\": \"no-store\",\n\t\t\t\t\t\t\tPragma: \"no-cache\",\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\tgetMcpSession: createAuthEndpoint(\n\t\t\t\t\"/mcp/get-session\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\trequireHeaders: true,\n\t\t\t\t},\n\t\t\t\tasync (c) => {\n\t\t\t\t\tconst accessToken = c.headers\n\t\t\t\t\t\t?.get(\"Authorization\")\n\t\t\t\t\t\t?.replace(\"Bearer \", \"\");\n\t\t\t\t\tif (!accessToken) {\n\t\t\t\t\t\tc.headers?.set(\"WWW-Authenticate\", \"Bearer\");\n\t\t\t\t\t\treturn c.json(null);\n\t\t\t\t\t}\n\t\t\t\t\tconst accessTokenData =\n\t\t\t\t\t\tawait c.context.adapter.findOne<OAuthAccessToken>({\n\t\t\t\t\t\t\tmodel: modelName.oauthAccessToken,\n\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tfield: \"accessToken\",\n\t\t\t\t\t\t\t\t\tvalue: accessToken,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t});\n\t\t\t\t\tif (!accessTokenData) {\n\t\t\t\t\t\treturn c.json(null);\n\t\t\t\t\t}\n\t\t\t\t\treturn c.json(accessTokenData);\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\tschema,\n\t\toptions,\n\t} satisfies BetterAuthPlugin;\n};\n\nexport const withMcpAuth = <\n\tAuth extends {\n\t\tapi: {\n\t\t\tgetMcpSession: (...args: any) => Promise<OAuthAccessToken | null>;\n\t\t};\n\t\toptions: BetterAuthOptions;\n\t},\n>(\n\tauth: Auth,\n\thandler: (\n\t\treq: Request,\n\t\tsession: OAuthAccessToken,\n\t) => Response | Promise<Response>,\n) => {\n\treturn async (req: Request) => {\n\t\tconst baseURL = getBaseURL(auth.options.baseURL, auth.options.basePath);\n\t\tif (!baseURL && !isProduction) {\n\t\t\tlogger.warn(\"Unable to get the baseURL, please check your config!\");\n\t\t}\n\t\tconst session = await auth.api.getMcpSession({\n\t\t\theaders: req.headers,\n\t\t});\n\t\tconst wwwAuthenticateValue = `Bearer resource_metadata=\"${baseURL}/.well-known/oauth-protected-resource\"`;\n\t\tif (!session) {\n\t\t\treturn Response.json(\n\t\t\t\t{\n\t\t\t\t\tjsonrpc: \"2.0\",\n\t\t\t\t\terror: {\n\t\t\t\t\t\tcode: -32000,\n\t\t\t\t\t\tmessage: \"Unauthorized: Authentication required\",\n\t\t\t\t\t\t\"www-authenticate\": wwwAuthenticateValue,\n\t\t\t\t\t},\n\t\t\t\t\tid: null,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tstatus: 401,\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t\"WWW-Authenticate\": wwwAuthenticateValue,\n\t\t\t\t\t\t// we also add this headers otherwise browser based clients will not be able to read the `www-authenticate` header\n\t\t\t\t\t\t\"Access-Control-Expose-Headers\": \"WWW-Authenticate\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\t\treturn handler(req, session);\n\t};\n};\n\nexport const oAuthDiscoveryMetadata = <\n\tAuth extends {\n\t\tapi: {\n\t\t\tgetMcpOAuthConfig: (...args: any) => any;\n\t\t};\n\t},\n>(\n\tauth: Auth,\n) => {\n\treturn async (request: Request) => {\n\t\tconst res = await auth.api.getMcpOAuthConfig();\n\t\treturn new Response(JSON.stringify(res), {\n\t\t\tstatus: 200,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\"Access-Control-Allow-Origin\": \"*\",\n\t\t\t\t\"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n\t\t\t\t\"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\n\t\t\t\t\"Access-Control-Max-Age\": \"86400\",\n\t\t\t},\n\t\t});\n\t};\n};\n\nexport const oAuthProtectedResourceMetadata = <\n\tAuth extends {\n\t\tapi: {\n\t\t\tgetMCPProtectedResource: (...args: any) => any;\n\t\t};\n\t},\n>(\n\tauth: Auth,\n) => {\n\treturn async (request: Request) => {\n\t\tconst res = await auth.api.getMCPProtectedResource();\n\t\treturn new Response(JSON.stringify(res), {\n\t\t\tstatus: 200,\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\t\"Access-Control-Allow-Origin\": \"*\",\n\t\t\t\t\"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n\t\t\t\t\"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\n\t\t\t\t\"Access-Control-Max-Age\": \"86400\",\n\t\t\t},\n\t\t});\n\t};\n};\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport { defineErrorCodes } from \"@better-auth/core/utils\";\nimport * as z from \"zod\";\nimport { APIError, sessionMiddleware } from \"../../api\";\nimport {\n\tdeleteSessionCookie,\n\tparseCookies,\n\tparseSetCookieHeader,\n\tsetSessionCookie,\n} from \"../../cookies\";\n\nexport interface MultiSessionConfig {\n\t/**\n\t * The maximum number of sessions a user can have\n\t * at a time\n\t * @default 5\n\t */\n\tmaximumSessions?: number | undefined;\n}\n\nconst ERROR_CODES = defineErrorCodes({\n\tINVALID_SESSION_TOKEN: \"Invalid session token\",\n});\n\nconst setActiveSessionBodySchema = z.object({\n\tsessionToken: z.string().meta({\n\t\tdescription: \"The session token to set as active\",\n\t}),\n});\n\nconst revokeDeviceSessionBodySchema = z.object({\n\tsessionToken: z.string().meta({\n\t\tdescription: \"The session token to revoke\",\n\t}),\n});\n\nexport const multiSession = (options?: MultiSessionConfig | undefined) => {\n\tconst opts = {\n\t\tmaximumSessions: 5,\n\t\t...options,\n\t};\n\n\tconst isMultiSessionCookie = (key: string) => key.includes(\"_multi-\");\n\n\treturn {\n\t\tid: \"multi-session\",\n\t\tendpoints: {\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * GET `/multi-session/list-device-sessions`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.listDeviceSessions`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.multiSession.listDeviceSessions`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/multi-session#api-method-multi-session-list-device-sessions)\n\t\t\t */\n\t\t\tlistDeviceSessions: createAuthEndpoint(\n\t\t\t\t\"/multi-session/list-device-sessions\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\trequireHeaders: true,\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst cookieHeader = ctx.headers?.get(\"cookie\");\n\t\t\t\t\tif (!cookieHeader) return ctx.json([]);\n\n\t\t\t\t\tconst cookies = Object.fromEntries(parseCookies(cookieHeader));\n\t\t\t\t\tconst sessionTokens = (\n\t\t\t\t\t\tawait Promise.all(\n\t\t\t\t\t\t\tObject.entries(cookies)\n\t\t\t\t\t\t\t\t.filter(([key]) => isMultiSessionCookie(key))\n\t\t\t\t\t\t\t\t.map(\n\t\t\t\t\t\t\t\t\tasync ([key]) =>\n\t\t\t\t\t\t\t\t\t\tawait ctx.getSignedCookie(key, ctx.context.secret),\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t)\n\t\t\t\t\t).filter((v) => typeof v === \"string\");\n\n\t\t\t\t\tif (!sessionTokens.length) return ctx.json([]);\n\t\t\t\t\tconst sessions =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.findSessions(sessionTokens);\n\t\t\t\t\tconst validSessions = sessions.filter(\n\t\t\t\t\t\t(session) => session && session.session.expiresAt > new Date(),\n\t\t\t\t\t);\n\t\t\t\t\tconst uniqueUserSessions = validSessions.reduce(\n\t\t\t\t\t\t(acc, session) => {\n\t\t\t\t\t\t\tif (!acc.find((s) => s.user.id === session.user.id)) {\n\t\t\t\t\t\t\t\tacc.push(session);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn acc;\n\t\t\t\t\t\t},\n\t\t\t\t\t\t[] as typeof validSessions,\n\t\t\t\t\t);\n\t\t\t\t\treturn ctx.json(uniqueUserSessions);\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/multi-session/set-active`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.setActiveSession`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.multiSession.setActive`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/multi-session#api-method-multi-session-set-active)\n\t\t\t */\n\t\t\tsetActiveSession: createAuthEndpoint(\n\t\t\t\t\"/multi-session/set-active\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: setActiveSessionBodySchema,\n\t\t\t\t\trequireHeaders: true,\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Set the active session\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst sessionToken = ctx.body.sessionToken;\n\t\t\t\t\tconst multiSessionCookieName = `${\n\t\t\t\t\t\tctx.context.authCookies.sessionToken.name\n\t\t\t\t\t}_multi-${sessionToken.toLowerCase()}`;\n\t\t\t\t\tconst sessionCookie = await ctx.getSignedCookie(\n\t\t\t\t\t\tmultiSessionCookieName,\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t);\n\t\t\t\t\tif (!sessionCookie) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_SESSION_TOKEN,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst session =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.findSession(sessionToken);\n\t\t\t\t\tif (!session || session.session.expiresAt < new Date()) {\n\t\t\t\t\t\tctx.setCookie(multiSessionCookieName, \"\", {\n\t\t\t\t\t\t\t...ctx.context.authCookies.sessionToken.options,\n\t\t\t\t\t\t\tmaxAge: 0,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_SESSION_TOKEN,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tawait setSessionCookie(ctx, session);\n\t\t\t\t\treturn ctx.json(session);\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/multi-session/revoke`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.revokeDeviceSession`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.multiSession.revoke`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/multi-session#api-method-multi-session-revoke)\n\t\t\t */\n\t\t\trevokeDeviceSession: createAuthEndpoint(\n\t\t\t\t\"/multi-session/revoke\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: revokeDeviceSessionBodySchema,\n\t\t\t\t\trequireHeaders: true,\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Revoke a device session\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst sessionToken = ctx.body.sessionToken;\n\t\t\t\t\tconst multiSessionCookieName = `${\n\t\t\t\t\t\tctx.context.authCookies.sessionToken.name\n\t\t\t\t\t}_multi-${sessionToken.toLowerCase()}`;\n\t\t\t\t\tconst sessionCookie = await ctx.getSignedCookie(\n\t\t\t\t\t\tmultiSessionCookieName,\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t);\n\t\t\t\t\tif (!sessionCookie) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_SESSION_TOKEN,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteSession(sessionToken);\n\t\t\t\t\tctx.setCookie(multiSessionCookieName, \"\", {\n\t\t\t\t\t\t...ctx.context.authCookies.sessionToken.options,\n\t\t\t\t\t\tmaxAge: 0,\n\t\t\t\t\t});\n\t\t\t\t\tconst isActive = ctx.context.session?.session.token === sessionToken;\n\t\t\t\t\tif (!isActive) return ctx.json({ status: true });\n\n\t\t\t\t\tconst cookieHeader = ctx.headers?.get(\"cookie\");\n\t\t\t\t\tif (cookieHeader) {\n\t\t\t\t\t\tconst cookies = Object.fromEntries(parseCookies(cookieHeader));\n\n\t\t\t\t\t\tconst sessionTokens = (\n\t\t\t\t\t\t\tawait Promise.all(\n\t\t\t\t\t\t\t\tObject.entries(cookies)\n\t\t\t\t\t\t\t\t\t.filter(([key]) => isMultiSessionCookie(key))\n\t\t\t\t\t\t\t\t\t.map(\n\t\t\t\t\t\t\t\t\t\tasync ([key]) =>\n\t\t\t\t\t\t\t\t\t\t\tawait ctx.getSignedCookie(key, ctx.context.secret),\n\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t).filter((v) => typeof v === \"string\");\n\t\t\t\t\t\tconst internalAdapter = ctx.context.internalAdapter;\n\n\t\t\t\t\t\tif (sessionTokens.length > 0) {\n\t\t\t\t\t\t\tconst sessions =\n\t\t\t\t\t\t\t\tawait internalAdapter.findSessions(sessionTokens);\n\t\t\t\t\t\t\tconst validSessions = sessions.filter(\n\t\t\t\t\t\t\t\t(session) => session && session.session.expiresAt > new Date(),\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tif (validSessions.length > 0) {\n\t\t\t\t\t\t\t\tconst nextSession = validSessions[0]!;\n\t\t\t\t\t\t\t\tawait setSessionCookie(ctx, nextSession);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tdeleteSessionCookie(ctx);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdeleteSessionCookie(ctx);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdeleteSessionCookie(ctx);\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tstatus: true,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher: () => true,\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst cookieString = ctx.context.responseHeaders?.get(\"set-cookie\");\n\t\t\t\t\t\tif (!cookieString) return;\n\t\t\t\t\t\tconst setCookies = parseSetCookieHeader(cookieString);\n\t\t\t\t\t\tconst sessionCookieConfig = ctx.context.authCookies.sessionToken;\n\t\t\t\t\t\tconst sessionToken = ctx.context.newSession?.session.token;\n\t\t\t\t\t\tif (!sessionToken) return;\n\t\t\t\t\t\tconst cookies = parseCookies(ctx.headers?.get(\"cookie\") || \"\");\n\n\t\t\t\t\t\tconst cookieName = `${\n\t\t\t\t\t\t\tsessionCookieConfig.name\n\t\t\t\t\t\t}_multi-${sessionToken.toLowerCase()}`;\n\n\t\t\t\t\t\tif (setCookies.get(cookieName) || cookies.get(cookieName)) return;\n\n\t\t\t\t\t\tconst currentMultiSessions =\n\t\t\t\t\t\t\tObject.keys(Object.fromEntries(cookies)).filter(\n\t\t\t\t\t\t\t\tisMultiSessionCookie,\n\t\t\t\t\t\t\t).length + (cookieString.includes(\"session_token\") ? 1 : 0);\n\n\t\t\t\t\t\tif (currentMultiSessions >= opts.maximumSessions) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tawait ctx.setSignedCookie(\n\t\t\t\t\t\t\tcookieName,\n\t\t\t\t\t\t\tsessionToken,\n\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t\tsessionCookieConfig.options,\n\t\t\t\t\t\t);\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tmatcher: (context) => context.path === \"/sign-out\",\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst cookieHeader = ctx.headers?.get(\"cookie\");\n\t\t\t\t\t\tif (!cookieHeader) return;\n\t\t\t\t\t\tconst cookies = Object.fromEntries(parseCookies(cookieHeader));\n\t\t\t\t\t\tconst multiSessionKeys = Object.keys(cookies).filter((key) =>\n\t\t\t\t\t\t\tisMultiSessionCookie(key),\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst verifiedTokens = (\n\t\t\t\t\t\t\tawait Promise.all(\n\t\t\t\t\t\t\t\tmultiSessionKeys.map(async (key) => {\n\t\t\t\t\t\t\t\t\tconst verifiedToken = await ctx.getSignedCookie(\n\t\t\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\tif (verifiedToken) {\n\t\t\t\t\t\t\t\t\t\tctx.setCookie(\n\t\t\t\t\t\t\t\t\t\t\tkey.toLowerCase().replace(\"__secure-\", \"__Secure-\"),\n\t\t\t\t\t\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t...ctx.context.authCookies.sessionToken.options,\n\t\t\t\t\t\t\t\t\t\t\t\tmaxAge: 0,\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\treturn verifiedToken;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t).filter((v) => typeof v === \"string\");\n\t\t\t\t\t\tif (verifiedTokens.length > 0) {\n\t\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteSessions(verifiedTokens);\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\toptions,\n\t\t$ERROR_CODES: ERROR_CODES,\n\t} satisfies BetterAuthPlugin;\n};\n", "import { env } from \"@better-auth/core/env\";\nimport type { EndpointContext } from \"better-call\";\nimport { getOrigin } from \"../../utils/url\";\nimport type { OAuthProxyOptions } from \"./index\";\n\n/**\n * Strip trailing slashes from URL to prevent double slashes\n */\nexport function stripTrailingSlash(url: string | undefined): string {\n\tif (!url) return \"\";\n\treturn url.replace(/\\/+$/, \"\");\n}\n\n/**\n * Get base URL from vendor-specific environment variables\n */\nfunction getVendorBaseURL() {\n\tconst vercel = env.VERCEL_URL ? `https://${env.VERCEL_URL}` : undefined;\n\tconst netlify = env.NETLIFY_URL;\n\tconst render = env.RENDER_URL;\n\tconst aws = env.AWS_LAMBDA_FUNCTION_NAME;\n\tconst google = env.GOOGLE_CLOUD_FUNCTION_NAME;\n\tconst azure = env.AZURE_FUNCTION_NAME;\n\n\treturn vercel || netlify || render || aws || google || azure;\n}\n\n/**\n * Resolve the current URL from various sources\n */\nexport function resolveCurrentURL(\n\tctx: EndpointContext<string, any>,\n\topts?: OAuthProxyOptions,\n) {\n\treturn new URL(\n\t\topts?.currentURL ||\n\t\t\tctx.request?.url ||\n\t\t\tgetVendorBaseURL() ||\n\t\t\tctx.context.baseURL,\n\t);\n}\n\n/**\n * Check if the proxy should be skipped for this request\n */\nexport function checkSkipProxy(\n\tctx: EndpointContext<string, any>,\n\topts?: OAuthProxyOptions,\n) {\n\t// If skip proxy header is set, we don't need to proxy\n\tconst skipProxyHeader = ctx.request?.headers.get(\"x-skip-oauth-proxy\");\n\tif (skipProxyHeader) {\n\t\treturn true;\n\t}\n\n\tconst productionURL = opts?.productionURL || env.BETTER_AUTH_URL;\n\tif (!productionURL) {\n\t\treturn false;\n\t}\n\n\tconst currentURL = ctx.request?.url || getVendorBaseURL();\n\tif (!currentURL) {\n\t\treturn false;\n\t}\n\n\tconst productionOrigin = getOrigin(productionURL);\n\tconst currentOrigin = getOrigin(currentURL);\n\n\treturn productionOrigin === currentOrigin;\n}\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport type { CookieOptions } from \"better-call\";\nimport * as z from \"zod\";\nimport { originCheck } from \"../../api\";\nimport { parseJSON } from \"../../client/parser\";\nimport { parseSetCookieHeader, stripSecureCookiePrefix } from \"../../cookies\";\nimport { symmetricDecrypt, symmetricEncrypt } from \"../../crypto\";\nimport { getOrigin } from \"../../utils/url\";\nimport type { AuthContextWithSnapshot, OAuthProxyStatePackage } from \"./types\";\nimport { checkSkipProxy, resolveCurrentURL, stripTrailingSlash } from \"./utils\";\n\nexport interface OAuthProxyOptions {\n\t/**\n\t * The current URL of the application.\n\t * The plugin will attempt to infer the current URL from your environment\n\t * by checking the base URL from popular hosting providers,\n\t * from the request URL if invoked by a client,\n\t * or as a fallback, from the `baseURL` in your auth config.\n\t * If the URL is not inferred correctly, you can provide a value here.\"\n\t */\n\tcurrentURL?: string | undefined;\n\t/**\n\t * If a request in a production url it won't be proxied.\n\t *\n\t * default to `BETTER_AUTH_URL`\n\t */\n\tproductionURL?: string | undefined;\n\t/**\n\t * Maximum age in seconds for the encrypted cookies payload.\n\t * Payloads older than this will be rejected to prevent replay attacks.\n\t *\n\t * Keep this value short (e.g., 30-60 seconds) to minimize the window\n\t * for potential replay attacks while still allowing normal OAuth flows.\n\t *\n\t * @default 60 (1 minute)\n\t */\n\tmaxAge?: number | undefined;\n}\n\ninterface EncryptedCookiesPayload {\n\tcookies: string;\n\ttimestamp: number;\n}\n\nconst oAuthProxyQuerySchema = z.object({\n\tcallbackURL: z.string().meta({\n\t\tdescription: \"The URL to redirect to after the proxy\",\n\t}),\n\tcookies: z.string().meta({\n\t\tdescription: \"The cookies to set after the proxy\",\n\t}),\n});\n\nexport const oAuthProxy = <O extends OAuthProxyOptions>(opts?: O) => {\n\tconst maxAge = opts?.maxAge ?? 60; // Default 60 seconds\n\n\treturn {\n\t\tid: \"oauth-proxy\",\n\t\toptions: opts as NoInfer<O>,\n\t\tendpoints: {\n\t\t\toAuthProxy: createAuthEndpoint(\n\t\t\t\t\"/oauth-proxy-callback\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\toperationId: \"oauthProxyCallback\",\n\t\t\t\t\tquery: oAuthProxyQuerySchema,\n\t\t\t\t\tuse: [originCheck((ctx) => ctx.query.callbackURL)],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\toperationId: \"oauthProxyCallback\",\n\t\t\t\t\t\t\tdescription: \"OAuth Proxy Callback\",\n\t\t\t\t\t\t\tparameters: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\t\t\t\tname: \"callbackURL\",\n\t\t\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\t\t\tdescription: \"The URL to redirect to after the proxy\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\t\t\t\tname: \"cookies\",\n\t\t\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\t\t\tdescription: \"The cookies to set after the proxy\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t302: {\n\t\t\t\t\t\t\t\t\tdescription: \"Redirect\",\n\t\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\t\tLocation: {\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The URL to redirect to\",\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tlet decryptedPayload: string | null = null;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdecryptedPayload = await symmetricDecrypt({\n\t\t\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\t\t\tdata: ctx.query.cookies,\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t\t\"Failed to decrypt OAuth proxy cookies:\",\n\t\t\t\t\t\t\te,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!decryptedPayload) {\n\t\t\t\t\t\tconst errorURL =\n\t\t\t\t\t\t\tctx.context.options.onAPIError?.errorURL ||\n\t\t\t\t\t\t\t`${stripTrailingSlash(ctx.context.options.baseURL)}/api/auth/error`;\n\n\t\t\t\t\t\tthrow ctx.redirect(\n\t\t\t\t\t\t\t`${errorURL}?error=OAuthProxy - Invalid cookies or secret`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tlet payload: EncryptedCookiesPayload;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tpayload = parseJSON<EncryptedCookiesPayload>(decryptedPayload);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tctx.context.logger.error(\"Failed to parse OAuth proxy payload:\", e);\n\t\t\t\t\t\tconst errorURL =\n\t\t\t\t\t\t\tctx.context.options.onAPIError?.errorURL ||\n\t\t\t\t\t\t\t`${stripTrailingSlash(ctx.context.options.baseURL)}/api/auth/error`;\n\n\t\t\t\t\t\tthrow ctx.redirect(\n\t\t\t\t\t\t\t`${errorURL}?error=OAuthProxy - Invalid payload format`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif (\n\t\t\t\t\t\t!payload.cookies ||\n\t\t\t\t\t\ttypeof payload.cookies !== \"string\" ||\n\t\t\t\t\t\ttypeof payload.timestamp !== \"number\"\n\t\t\t\t\t) {\n\t\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t\t\"OAuth proxy payload missing required fields\",\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst errorURL =\n\t\t\t\t\t\t\tctx.context.options.onAPIError?.errorURL ||\n\t\t\t\t\t\t\t`${stripTrailingSlash(ctx.context.options.baseURL)}/api/auth/error`;\n\n\t\t\t\t\t\tthrow ctx.redirect(\n\t\t\t\t\t\t\t`${errorURL}?error=OAuthProxy - Invalid payload structure`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst now = Date.now();\n\t\t\t\t\tconst age = (now - payload.timestamp) / 1000;\n\n\t\t\t\t\t// Allow up to 10 seconds of future skew for clock differences\n\t\t\t\t\tif (age > maxAge || age < -10) {\n\t\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t\t`OAuth proxy payload expired or invalid (age: ${age}s, maxAge: ${maxAge}s)`,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst errorURL =\n\t\t\t\t\t\t\tctx.context.options.onAPIError?.errorURL ||\n\t\t\t\t\t\t\t`${stripTrailingSlash(ctx.context.options.baseURL)}/api/auth/error`;\n\n\t\t\t\t\t\tthrow ctx.redirect(\n\t\t\t\t\t\t\t`${errorURL}?error=OAuthProxy - Payload expired or invalid`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst decryptedCookies = payload.cookies;\n\n\t\t\t\t\tconst currentURL = resolveCurrentURL(ctx, opts);\n\t\t\t\t\tconst isSecureContext = currentURL.protocol === \"https:\";\n\n\t\t\t\t\tconst parsedCookies = parseSetCookieHeader(decryptedCookies);\n\t\t\t\t\tconst processedCookies = Array.from(parsedCookies.entries()).map(\n\t\t\t\t\t\t([name, attrs]) => {\n\t\t\t\t\t\t\tconst options: CookieOptions = {};\n\t\t\t\t\t\t\tif (attrs.path) {\n\t\t\t\t\t\t\t\toptions.path = attrs.path;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (attrs.expires) {\n\t\t\t\t\t\t\t\toptions.expires = attrs.expires;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (attrs.samesite) {\n\t\t\t\t\t\t\t\toptions.sameSite = attrs.samesite;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (attrs.httponly) {\n\t\t\t\t\t\t\t\toptions.httpOnly = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (attrs[\"max-age\"] !== undefined) {\n\t\t\t\t\t\t\t\toptions.maxAge = attrs[\"max-age\"];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (isSecureContext) {\n\t\t\t\t\t\t\t\toptions.secure = true;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Remove __Secure- or __Host- prefix for non-HTTPS contexts\n\t\t\t\t\t\t\tconst cookieName = isSecureContext\n\t\t\t\t\t\t\t\t? name\n\t\t\t\t\t\t\t\t: stripSecureCookiePrefix(name);\n\n\t\t\t\t\t\t\t// URI-decoded value because `ctx.setCookie` will URI-encode it again\n\t\t\t\t\t\t\tlet cookieValue: string;\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tcookieValue = decodeURIComponent(attrs.value);\n\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\tcookieValue = attrs.value;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tname: cookieName,\n\t\t\t\t\t\t\t\tvalue: cookieValue,\n\t\t\t\t\t\t\t\toptions,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\n\t\t\t\t\tfor (const cookie of processedCookies) {\n\t\t\t\t\t\t// using `ctx.setHeader` overrides previous Set-Cookie headers\n\t\t\t\t\t\t// so use ctx.setCookie helper instead\n\t\t\t\t\t\t// https://github.com/Bekacru/better-call/blob/d27ac20e64b329a4851e97adf864098a9bc2a260/src/context.ts#L217\n\t\t\t\t\t\tctx.setCookie(cookie.name, cookie.value, cookie.options);\n\t\t\t\t\t}\n\t\t\t\t\tthrow ctx.redirect(ctx.query.callbackURL);\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\thooks: {\n\t\t\tbefore: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn !!(\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/sign-in/social\") ||\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/sign-in/oauth2\")\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst skipProxy = checkSkipProxy(ctx, opts);\n\t\t\t\t\t\tif (skipProxy) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst currentURL = resolveCurrentURL(ctx, opts);\n\t\t\t\t\t\tconst productionURL = opts?.productionURL;\n\t\t\t\t\t\tconst originalCallbackURL =\n\t\t\t\t\t\t\tctx.body?.callbackURL || ctx.context.baseURL;\n\n\t\t\t\t\t\t// Override baseURL to production so redirect_uri points to production\n\t\t\t\t\t\t// This ensures OAuth provider callbacks go to the production server\n\t\t\t\t\t\tif (productionURL) {\n\t\t\t\t\t\t\tconst productionBaseURL = `${stripTrailingSlash(productionURL)}${ctx.context.options.basePath || \"/api/auth\"}`;\n\t\t\t\t\t\t\tctx.context.baseURL = productionBaseURL;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Construct proxy callback URL\n\t\t\t\t\t\tconst newCallbackURL = `${stripTrailingSlash(currentURL.origin)}${\n\t\t\t\t\t\t\tctx.context.options.basePath || \"/api/auth\"\n\t\t\t\t\t\t}/oauth-proxy-callback?callbackURL=${encodeURIComponent(\n\t\t\t\t\t\t\toriginalCallbackURL,\n\t\t\t\t\t\t)}`;\n\n\t\t\t\t\t\tif (!ctx.body) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tctx.body.callbackURL = newCallbackURL;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn !!(\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/callback\") ||\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/oauth2/callback\")\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst state = ctx.query?.state || ctx.body?.state;\n\t\t\t\t\t\tif (!state || typeof state !== \"string\") {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Try to decrypt and parse OAuth proxy state package\n\t\t\t\t\t\tlet statePackage: OAuthProxyStatePackage | undefined;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst decryptedPackage = await symmetricDecrypt({\n\t\t\t\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\t\t\t\tdata: state,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tstatePackage =\n\t\t\t\t\t\t\t\tparseJSON<OAuthProxyStatePackage>(decryptedPackage);\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t// Not an OAuth proxy state, continue normally\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t!statePackage.isOAuthProxy ||\n\t\t\t\t\t\t\t!statePackage.state ||\n\t\t\t\t\t\t\t!statePackage.stateCookie\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Decrypt the state cookie content\n\t\t\t\t\t\tlet stateCookieValue: string;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tstateCookieValue = await symmetricDecrypt({\n\t\t\t\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\t\t\t\tdata: statePackage.stateCookie,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tparseJSON(stateCookieValue);\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t\t\t\"Failed to decrypt OAuth proxy state cookie:\",\n\t\t\t\t\t\t\t\te,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Snapshot original configuration for restoration in after hook\n\t\t\t\t\t\t(ctx.context as AuthContextWithSnapshot)._oauthProxySnapshot = {\n\t\t\t\t\t\t\tstoreStateStrategy: ctx.context.oauthConfig.storeStateStrategy,\n\t\t\t\t\t\t\tskipStateCookieCheck:\n\t\t\t\t\t\t\t\tctx.context.oauthConfig.skipStateCookieCheck,\n\t\t\t\t\t\t\tinternalAdapter: ctx.context.internalAdapter,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t// Temporarily switch to database mode and inject verification value\n\t\t\t\t\t\t// This allows the OAuth callback handler to retrieve state data without database\n\t\t\t\t\t\tconst originalAdapter = ctx.context.internalAdapter;\n\t\t\t\t\t\tconst capturedStatePackage = statePackage;\n\t\t\t\t\t\tctx.context.oauthConfig.storeStateStrategy = \"database\";\n\t\t\t\t\t\tctx.context.internalAdapter = {\n\t\t\t\t\t\t\t...ctx.context.internalAdapter,\n\t\t\t\t\t\t\tfindVerificationValue: async (identifier: string) => {\n\t\t\t\t\t\t\t\tif (identifier === capturedStatePackage.state) {\n\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\tid: `oauth-proxy-${capturedStatePackage.state}`,\n\t\t\t\t\t\t\t\t\t\tidentifier: capturedStatePackage.state,\n\t\t\t\t\t\t\t\t\t\tvalue: stateCookieValue,\n\t\t\t\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t\t\t\t\t// Align expiration time with `generateState` in oauth2\n\t\t\t\t\t\t\t\t\t\texpiresAt: new Date(Date.now() + 10 * 60 * 1000),\n\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\treturn originalAdapter.findVerificationValue(identifier);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t// Restore original state parameter\n\t\t\t\t\t\tif (ctx.query?.state) {\n\t\t\t\t\t\t\tctx.query.state = statePackage.state;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (ctx.body?.state) {\n\t\t\t\t\t\t\tctx.body.state = statePackage.state;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Enable skipStateCookieCheck for database mode\n\t\t\t\t\t\tctx.context.oauthConfig.skipStateCookieCheck = true;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tmatcher() {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tif (ctx.path !== \"/callback/:id\") {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (ctx.context.oauthConfig.storeStateStrategy === \"cookie\") {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Skip if OAuth proxy stateless flow already handled by previous hook\n\t\t\t\t\t\tif ((ctx.context as AuthContextWithSnapshot)._oauthProxySnapshot) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst state = ctx.query?.state || ctx.body?.state;\n\t\t\t\t\t\tif (!state) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst data =\n\t\t\t\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(state);\n\t\t\t\t\t\tif (!data) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet parsedState: { callbackURL?: string } | undefined;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tparsedState = parseJSON<{ callbackURL?: string }>(data.value);\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\tparsedState = undefined;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!parsedState?.callbackURL?.includes(\"/oauth-proxy-callback\")) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Snapshot original configuration for restoration in after hook\n\t\t\t\t\t\t(ctx.context as AuthContextWithSnapshot)._oauthProxySnapshot = {\n\t\t\t\t\t\t\tstoreStateStrategy: ctx.context.oauthConfig.storeStateStrategy,\n\t\t\t\t\t\t\tskipStateCookieCheck:\n\t\t\t\t\t\t\t\tctx.context.oauthConfig.skipStateCookieCheck,\n\t\t\t\t\t\t\tinternalAdapter: ctx.context.internalAdapter,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tctx.context.oauthConfig.skipStateCookieCheck = true;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn !!(\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/sign-in/social\") ||\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/sign-in/oauth2\")\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst skipProxy = checkSkipProxy(ctx, opts);\n\t\t\t\t\t\tif (skipProxy) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Only process in stateless mode\n\t\t\t\t\t\tif (ctx.context.oauthConfig.storeStateStrategy !== \"cookie\") {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Extract OAuth provider URL from sign-in response\n\t\t\t\t\t\tconst signInResponse = ctx.context.returned;\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t!signInResponse ||\n\t\t\t\t\t\t\ttypeof signInResponse !== \"object\" ||\n\t\t\t\t\t\t\t!(\"url\" in signInResponse)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst { url: providerURL } = signInResponse;\n\t\t\t\t\t\tif (typeof providerURL !== \"string\") {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Parse provider URL and extract state parameter\n\t\t\t\t\t\tconst oauthURL = new URL(providerURL);\n\t\t\t\t\t\tconst originalState = oauthURL.searchParams.get(\"state\");\n\t\t\t\t\t\tif (!originalState) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Extract state cookie from response headers\n\t\t\t\t\t\tconst headers = ctx.context.responseHeaders;\n\t\t\t\t\t\tconst setCookieHeader = headers?.get(\"set-cookie\");\n\t\t\t\t\t\tif (!setCookieHeader) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst stateCookie = ctx.context.createAuthCookie(\"oauth_state\");\n\t\t\t\t\t\tconst parsedStateCookies = parseSetCookieHeader(setCookieHeader);\n\t\t\t\t\t\tconst stateCookieAttrs = parsedStateCookies.get(stateCookie.name);\n\t\t\t\t\t\tif (!stateCookieAttrs?.value) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst stateCookieValue = stateCookieAttrs.value;\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t// Create and encrypt state package\n\t\t\t\t\t\t\tconst statePackage: OAuthProxyStatePackage = {\n\t\t\t\t\t\t\t\tstate: originalState,\n\t\t\t\t\t\t\t\tstateCookie: stateCookieValue,\n\t\t\t\t\t\t\t\tisOAuthProxy: true,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tconst encryptedPackage = await symmetricEncrypt({\n\t\t\t\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\t\t\t\tdata: JSON.stringify(statePackage),\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t// Replace state parameter with encrypted package\n\t\t\t\t\t\t\toauthURL.searchParams.set(\"state\", encryptedPackage);\n\n\t\t\t\t\t\t\t// Update response with modified URL\n\t\t\t\t\t\t\tctx.context.returned = {\n\t\t\t\t\t\t\t\t...signInResponse,\n\t\t\t\t\t\t\t\turl: oauthURL.toString(),\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t\t\t\"Failed to encrypt OAuth proxy state package:\",\n\t\t\t\t\t\t\t\te,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t// Continue without proxy\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn !!(\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/callback\") ||\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/oauth2/callback\")\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst headers = ctx.context.responseHeaders;\n\t\t\t\t\t\tconst location = headers?.get(\"location\");\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t!location?.includes(\"/oauth-proxy-callback?callbackURL\") ||\n\t\t\t\t\t\t\t!location.startsWith(\"http\")\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst productionURL =\n\t\t\t\t\t\t\topts?.productionURL ||\n\t\t\t\t\t\t\tctx.context.options.baseURL ||\n\t\t\t\t\t\t\tctx.context.baseURL;\n\t\t\t\t\t\tconst productionOrigin = getOrigin(productionURL);\n\n\t\t\t\t\t\tconst locationURL = new URL(location);\n\t\t\t\t\t\tconst locationOrigin = locationURL.origin;\n\n\t\t\t\t\t\t//\n\t\t\t\t\t\t// Same origin: unwrap proxy redirect to original destination\n\t\t\t\t\t\t//\n\t\t\t\t\t\tif (locationOrigin === productionOrigin) {\n\t\t\t\t\t\t\tconst newLocation = locationURL.searchParams.get(\"callbackURL\");\n\t\t\t\t\t\t\tif (!newLocation) {\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tctx.setHeader(\"location\", newLocation);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//\n\t\t\t\t\t\t// Cross-origin: encrypt and forward cookies through proxy\n\t\t\t\t\t\t//\n\t\t\t\t\t\tconst setCookies = headers?.get(\"set-cookie\");\n\t\t\t\t\t\tif (!setCookies) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Create payload with timestamp for replay attack protection\n\t\t\t\t\t\tconst payload: EncryptedCookiesPayload = {\n\t\t\t\t\t\t\tcookies: setCookies,\n\t\t\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst encryptedCookies = await symmetricEncrypt({\n\t\t\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\t\t\tdata: JSON.stringify(payload),\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst locationWithCookies = `${location}&cookies=${encodeURIComponent(\n\t\t\t\t\t\t\tencryptedCookies,\n\t\t\t\t\t\t)}`;\n\n\t\t\t\t\t\tctx.setHeader(\"location\", locationWithCookies);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t// Restore OAuth config after processing callback\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn !!(\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/callback\") ||\n\t\t\t\t\t\t\tcontext.path?.startsWith(\"/oauth2/callback\")\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst contextWithSnapshot = ctx.context as AuthContextWithSnapshot;\n\t\t\t\t\t\tconst snapshot = contextWithSnapshot._oauthProxySnapshot;\n\t\t\t\t\t\tif (snapshot) {\n\t\t\t\t\t\t\tctx.context.oauthConfig.storeStateStrategy =\n\t\t\t\t\t\t\t\tsnapshot.storeStateStrategy;\n\t\t\t\t\t\t\tctx.context.oauthConfig.skipStateCookieCheck =\n\t\t\t\t\t\t\t\tsnapshot.skipStateCookieCheck;\n\t\t\t\t\t\t\tctx.context.internalAdapter = snapshot.internalAdapter;\n\n\t\t\t\t\t\t\t// Clear the temporary extended context value\n\t\t\t\t\t\t\tcontextWithSnapshot._oauthProxySnapshot = undefined;\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t} satisfies BetterAuthPlugin;\n};\n", "export function toBoolean(value: any): boolean {\n\treturn value === \"true\" || value === true;\n}\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { createRemoteJWKSet, jwtVerify } from \"jose\";\nimport * as z from \"zod\";\nimport { APIError } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { toBoolean } from \"../../utils/boolean\";\n\nexport interface OneTapOptions {\n\t/**\n\t * Disable the signup flow\n\t *\n\t * @default false\n\t */\n\tdisableSignup?: boolean | undefined;\n\t/**\n\t * Google Client ID\n\t *\n\t * If a client ID is provided in the social provider configuration,\n\t * it will be used.\n\t */\n\tclientId?: string | undefined;\n}\n\nconst oneTapCallbackBodySchema = z.object({\n\tidToken: z.string().meta({\n\t\tdescription:\n\t\t\t\"Google ID token, which the client obtains from the One Tap API\",\n\t}),\n});\n\nexport const oneTap = (options?: OneTapOptions | undefined) =>\n\t({\n\t\tid: \"one-tap\",\n\t\tendpoints: {\n\t\t\toneTapCallback: createAuthEndpoint(\n\t\t\t\t\"/one-tap/callback\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: oneTapCallbackBodySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tsummary: \"One tap callback\",\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Use this endpoint to authenticate with Google One Tap\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Successful response\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t400: {\n\t\t\t\t\t\t\t\t\tdescription: \"Invalid token\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst { idToken } = ctx.body;\n\t\t\t\t\tlet payload: any;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst JWKS = createRemoteJWKSet(\n\t\t\t\t\t\t\tnew URL(\"https://www.googleapis.com/oauth2/v3/certs\"),\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst { payload: verifiedPayload } = await jwtVerify(\n\t\t\t\t\t\t\tidToken,\n\t\t\t\t\t\t\tJWKS,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tissuer: [\"https://accounts.google.com\", \"accounts.google.com\"],\n\t\t\t\t\t\t\t\taudience:\n\t\t\t\t\t\t\t\t\toptions?.clientId ||\n\t\t\t\t\t\t\t\t\tctx.context.options.socialProviders?.google?.clientId,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t\tpayload = verifiedPayload;\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: \"invalid id token\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst { email, email_verified, name, picture, sub } = payload;\n\t\t\t\t\tif (!email) {\n\t\t\t\t\t\treturn ctx.json({ error: \"Email not available in token\" });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tif (options?.disableSignup) {\n\t\t\t\t\t\t\tthrow new APIError(\"BAD_GATEWAY\", {\n\t\t\t\t\t\t\t\tmessage: \"User not found\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst newUser = await ctx.context.internalAdapter.createOAuthUser(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\temail,\n\t\t\t\t\t\t\t\temailVerified:\n\t\t\t\t\t\t\t\t\ttypeof email_verified === \"boolean\"\n\t\t\t\t\t\t\t\t\t\t? email_verified\n\t\t\t\t\t\t\t\t\t\t: toBoolean(email_verified),\n\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\timage: picture,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tproviderId: \"google\",\n\t\t\t\t\t\t\t\taccountId: sub,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (!newUser) {\n\t\t\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\t\t\tmessage: \"Could not create user\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\t\tnewUser.user.id,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\t\tuser: newUser.user,\n\t\t\t\t\t\t\tsession,\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\ttoken: session.token,\n\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\tid: newUser.user.id,\n\t\t\t\t\t\t\t\temail: newUser.user.email,\n\t\t\t\t\t\t\t\temailVerified: newUser.user.emailVerified,\n\t\t\t\t\t\t\t\tname: newUser.user.name,\n\t\t\t\t\t\t\t\timage: newUser.user.image,\n\t\t\t\t\t\t\t\tcreatedAt: newUser.user.createdAt,\n\t\t\t\t\t\t\t\tupdatedAt: newUser.user.updatedAt,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst account = await ctx.context.internalAdapter.findAccount(sub);\n\t\t\t\t\tif (!account) {\n\t\t\t\t\t\tconst accountLinking = ctx.context.options.account?.accountLinking;\n\t\t\t\t\t\tconst shouldLinkAccount =\n\t\t\t\t\t\t\taccountLinking?.enabled !== false &&\n\t\t\t\t\t\t\t(accountLinking?.trustedProviders?.includes(\"google\") ||\n\t\t\t\t\t\t\t\temail_verified);\n\t\t\t\t\t\tif (shouldLinkAccount) {\n\t\t\t\t\t\t\tawait ctx.context.internalAdapter.linkAccount({\n\t\t\t\t\t\t\t\tuserId: user.user.id,\n\t\t\t\t\t\t\t\tproviderId: \"google\",\n\t\t\t\t\t\t\t\taccountId: sub,\n\t\t\t\t\t\t\t\tscope: \"openid,profile,email\",\n\t\t\t\t\t\t\t\tidToken,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\tmessage: \"Google sub doesn't match\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\tuser.user.id,\n\t\t\t\t\t);\n\n\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\tuser: user.user,\n\t\t\t\t\t\tsession,\n\t\t\t\t\t});\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\ttoken: session.token,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tid: user.user.id,\n\t\t\t\t\t\t\temail: user.user.email,\n\t\t\t\t\t\t\temailVerified: user.user.emailVerified,\n\t\t\t\t\t\t\tname: user.user.name,\n\t\t\t\t\t\t\timage: user.user.image,\n\t\t\t\t\t\t\tcreatedAt: user.user.createdAt,\n\t\t\t\t\t\t\tupdatedAt: user.user.updatedAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\toptions,\n\t}) satisfies BetterAuthPlugin;\n", "import { base64Url } from \"@better-auth/utils/base64\";\nimport { createHash } from \"@better-auth/utils/hash\";\nexport const defaultKeyHasher = async (token: string) => {\n\tconst hash = await createHash(\"SHA-256\").digest(\n\t\tnew TextEncoder().encode(token),\n\t);\n\tconst hashed = base64Url.encode(new Uint8Array(hash), {\n\t\tpadding: false,\n\t});\n\treturn hashed;\n};\n", "import type {\n\tBetterAuthPlugin,\n\tGenericEndpointContext,\n} from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport * as z from \"zod\";\nimport { sessionMiddleware } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { generateRandomString } from \"../../crypto\";\nimport type { Session, User } from \"../../types\";\nimport { defaultKeyHasher } from \"./utils\";\n\nexport interface OneTimeTokenOptions {\n\t/**\n\t * Expires in minutes\n\t *\n\t * @default 3\n\t */\n\texpiresIn?: number | undefined;\n\t/**\n\t * Only allow server initiated requests\n\t */\n\tdisableClientRequest?: boolean | undefined;\n\t/**\n\t * Generate a custom token\n\t */\n\tgenerateToken?:\n\t\t| ((\n\t\t\t\tsession: {\n\t\t\t\t\tuser: User & Record<string, any>;\n\t\t\t\t\tsession: Session & Record<string, any>;\n\t\t\t\t},\n\t\t\t\tctx: GenericEndpointContext,\n\t\t  ) => Promise<string>)\n\t\t| undefined;\n\t/**\n\t * Disable setting the session cookie when the token is verified\n\t */\n\tdisableSetSessionCookie?: boolean;\n\t/**\n\t * This option allows you to configure how the token is stored in your database.\n\t * Note: This will not affect the token that's sent, it will only affect the token stored in your database.\n\t *\n\t * @default \"plain\"\n\t */\n\tstoreToken?:\n\t\t| (\n\t\t\t\t| \"plain\"\n\t\t\t\t| \"hashed\"\n\t\t\t\t| { type: \"custom-hasher\"; hash: (token: string) => Promise<string> }\n\t\t  )\n\t\t| undefined;\n\t/**\n\t * Set the OTT header on new sessions\n\t */\n\tsetOttHeaderOnNewSession?: boolean;\n}\n\nconst verifyOneTimeTokenBodySchema = z.object({\n\ttoken: z.string().meta({\n\t\tdescription: 'The token to verify. Eg: \"some-token\"',\n\t}),\n});\n\nexport const oneTimeToken = (options?: OneTimeTokenOptions | undefined) => {\n\tconst opts = {\n\t\tstoreToken: \"plain\",\n\t\t...options,\n\t} satisfies OneTimeTokenOptions;\n\n\tasync function storeToken(ctx: GenericEndpointContext, token: string) {\n\t\tif (opts.storeToken === \"hashed\") {\n\t\t\treturn await defaultKeyHasher(token);\n\t\t}\n\t\tif (\n\t\t\ttypeof opts.storeToken === \"object\" &&\n\t\t\t\"type\" in opts.storeToken &&\n\t\t\topts.storeToken.type === \"custom-hasher\"\n\t\t) {\n\t\t\treturn await opts.storeToken.hash(token);\n\t\t}\n\n\t\treturn token;\n\t}\n\n\tasync function generateToken(\n\t\tc: GenericEndpointContext,\n\t\tsession: {\n\t\t\tsession: Session;\n\t\t\tuser: User;\n\t\t},\n\t) {\n\t\tconst token = opts?.generateToken\n\t\t\t? await opts.generateToken(session, c)\n\t\t\t: generateRandomString(32);\n\t\tconst expiresAt = new Date(Date.now() + (opts?.expiresIn ?? 3) * 60 * 1000);\n\t\tconst storedToken = await storeToken(c, token);\n\t\tawait c.context.internalAdapter.createVerificationValue({\n\t\t\tvalue: session.session.token,\n\t\t\tidentifier: `one-time-token:${storedToken}`,\n\t\t\texpiresAt,\n\t\t});\n\t\treturn token;\n\t}\n\n\treturn {\n\t\tid: \"one-time-token\",\n\t\tendpoints: {\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * GET `/one-time-token/generate`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.generateOneTimeToken`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.oneTimeToken.generate`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/one-time-token#api-method-one-time-token-generate)\n\t\t\t */\n\t\t\tgenerateOneTimeToken: createAuthEndpoint(\n\t\t\t\t\"/one-time-token/generate\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t},\n\t\t\t\tasync (c) => {\n\t\t\t\t\t//if request exist, it means it's a client request\n\t\t\t\t\tif (opts?.disableClientRequest && c.request) {\n\t\t\t\t\t\tthrow c.error(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: \"Client requests are disabled\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst session = c.context.session;\n\t\t\t\t\tconst token = await generateToken(c, session);\n\t\t\t\t\treturn c.json({ token });\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/one-time-token/verify`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.verifyOneTimeToken`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.oneTimeToken.verify`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/one-time-token#api-method-one-time-token-verify)\n\t\t\t */\n\t\t\tverifyOneTimeToken: createAuthEndpoint(\n\t\t\t\t\"/one-time-token/verify\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: verifyOneTimeTokenBodySchema,\n\t\t\t\t},\n\t\t\t\tasync (c) => {\n\t\t\t\t\tconst { token } = c.body;\n\t\t\t\t\tconst storedToken = await storeToken(c, token);\n\t\t\t\t\tconst verificationValue =\n\t\t\t\t\t\tawait c.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t\t\t`one-time-token:${storedToken}`,\n\t\t\t\t\t\t);\n\t\t\t\t\tif (!verificationValue) {\n\t\t\t\t\t\tthrow c.error(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: \"Invalid token\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tawait c.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\tverificationValue.id,\n\t\t\t\t\t);\n\t\t\t\t\tif (verificationValue.expiresAt < new Date()) {\n\t\t\t\t\t\tthrow c.error(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: \"Token expired\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst session = await c.context.internalAdapter.findSession(\n\t\t\t\t\t\tverificationValue.value,\n\t\t\t\t\t);\n\t\t\t\t\tif (!session) {\n\t\t\t\t\t\tthrow c.error(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: \"Session not found\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (!opts?.disableSetSessionCookie) {\n\t\t\t\t\t\tawait setSessionCookie(c, session);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (session.session.expiresAt < new Date()) {\n\t\t\t\t\t\tthrow c.error(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: \"Session expired\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\treturn c.json(session);\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher: () => true,\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tif (ctx.context.newSession) {\n\t\t\t\t\t\t\tif (!opts?.setOttHeaderOnNewSession) {\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst exposedHeaders =\n\t\t\t\t\t\t\t\tctx.context.responseHeaders?.get(\n\t\t\t\t\t\t\t\t\t\"access-control-expose-headers\",\n\t\t\t\t\t\t\t\t) || \"\";\n\t\t\t\t\t\t\tconst headersSet = new Set(\n\t\t\t\t\t\t\t\texposedHeaders\n\t\t\t\t\t\t\t\t\t.split(\",\")\n\t\t\t\t\t\t\t\t\t.map((header) => header.trim())\n\t\t\t\t\t\t\t\t\t.filter(Boolean),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\theadersSet.add(\"set-ott\");\n\t\t\t\t\t\t\tconst token = await generateToken(ctx, ctx.context.newSession);\n\t\t\t\t\t\t\tctx.setHeader(\"set-ott\", token);\n\t\t\t\t\t\t\tctx.setHeader(\n\t\t\t\t\t\t\t\t\"Access-Control-Expose-Headers\",\n\t\t\t\t\t\t\t\tArray.from(headersSet).join(\", \"),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\toptions,\n\t} satisfies BetterAuthPlugin;\n};\n", "import type { AuthContext, BetterAuthOptions } from \"@better-auth/core\";\nimport type {\n\tDBFieldAttribute,\n\tDBFieldAttributeConfig,\n\tDBFieldType,\n} from \"@better-auth/core/db\";\nimport type {\n\tEndpoint,\n\tEndpointOptions,\n\tOpenAPIParameter,\n\tOpenAPISchemaType,\n} from \"better-call\";\nimport * as z from \"zod\";\nimport { getEndpoints } from \"../../api\";\nimport { getAuthTables } from \"../../db\";\n\nexport interface Path {\n\tget?:\n\t\t| {\n\t\t\t\ttags?: string[];\n\t\t\t\toperationId?: string;\n\t\t\t\tdescription?: string;\n\t\t\t\tsecurity?: [{ bearerAuth: string[] }];\n\t\t\t\tparameters?: OpenAPIParameter[];\n\t\t\t\tresponses?: {\n\t\t\t\t\t[key in string]: {\n\t\t\t\t\t\tdescription?: string;\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype?: OpenAPISchemaType;\n\t\t\t\t\t\t\t\t\tproperties?: Record<string, any>;\n\t\t\t\t\t\t\t\t\trequired?: string[];\n\t\t\t\t\t\t\t\t\t$ref?: string;\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t};\n\t\t\t\t\t};\n\t\t\t\t};\n\t\t  }\n\t\t| undefined;\n\tpost?:\n\t\t| {\n\t\t\t\ttags?: string[];\n\t\t\t\toperationId?: string;\n\t\t\t\tdescription?: string;\n\t\t\t\tsecurity?: [{ bearerAuth: string[] }];\n\t\t\t\tparameters?: OpenAPIParameter[];\n\t\t\t\trequestBody?: {\n\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\ttype?: OpenAPISchemaType;\n\t\t\t\t\t\t\t\tproperties?: Record<string, any>;\n\t\t\t\t\t\t\t\trequired?: string[];\n\t\t\t\t\t\t\t\t$ref?: string;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t};\n\t\t\t\t\t};\n\t\t\t\t};\n\t\t\t\tresponses?: {\n\t\t\t\t\t[key in string]: {\n\t\t\t\t\t\tdescription?: string;\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype?: OpenAPISchemaType;\n\t\t\t\t\t\t\t\t\tproperties?: Record<string, any>;\n\t\t\t\t\t\t\t\t\trequired?: string[];\n\t\t\t\t\t\t\t\t\t$ref?: string;\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t};\n\t\t\t\t\t};\n\t\t\t\t};\n\t\t  }\n\t\t| undefined;\n}\n\ntype AllowedType = \"string\" | \"number\" | \"boolean\" | \"array\" | \"object\";\nconst allowedType = new Set([\"string\", \"number\", \"boolean\", \"array\", \"object\"]);\nfunction getTypeFromZodType(zodType: z.ZodType<any>) {\n\tconst type = zodType.type;\n\treturn allowedType.has(type) ? (type as AllowedType) : \"string\";\n}\n\nexport type FieldSchema = {\n\ttype: DBFieldType;\n\tdefault?:\n\t\t| (DBFieldAttributeConfig[\"defaultValue\"] | \"Generated at runtime\")\n\t\t| undefined;\n\treadOnly?: boolean | undefined;\n\tformat?: string;\n};\n\nexport type OpenAPIModelSchema = {\n\ttype: \"object\";\n\tproperties: Record<string, FieldSchema>;\n\trequired?: string[] | undefined;\n};\n\nfunction getFieldSchema(field: DBFieldAttribute) {\n\tconst schema: FieldSchema = {\n\t\ttype: field.type === \"date\" ? \"string\" : field.type,\n\t\t...(field.type === \"date\" && { format: \"date-time\" }),\n\t};\n\n\tif (field.defaultValue !== undefined) {\n\t\tschema.default =\n\t\t\ttypeof field.defaultValue === \"function\"\n\t\t\t\t? \"Generated at runtime\"\n\t\t\t\t: field.defaultValue;\n\t}\n\n\tif (field.input === false) {\n\t\tschema.readOnly = true;\n\t}\n\n\treturn schema;\n}\n\nfunction getParameters(options: EndpointOptions) {\n\tconst parameters: OpenAPIParameter[] = [];\n\tif (options.metadata?.openapi?.parameters) {\n\t\tparameters.push(...options.metadata.openapi.parameters);\n\t\treturn parameters;\n\t}\n\tif (options.query instanceof z.ZodObject) {\n\t\tObject.entries(options.query.shape).forEach(([key, value]) => {\n\t\t\tif (value instanceof z.ZodType) {\n\t\t\t\tparameters.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\tin: \"query\",\n\t\t\t\t\tschema: {\n\t\t\t\t\t\t...processZodType(value as z.ZodType<any>),\n\t\t\t\t\t\t...(\"minLength\" in value && (value as any).minLength\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tminLength: (value as any).minLength as number,\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\treturn parameters;\n}\n\nfunction getRequestBody(options: EndpointOptions): any {\n\tif (options.metadata?.openapi?.requestBody) {\n\t\treturn options.metadata.openapi.requestBody;\n\t}\n\tif (!options.body) return undefined;\n\tif (\n\t\toptions.body instanceof z.ZodObject ||\n\t\toptions.body instanceof z.ZodOptional\n\t) {\n\t\t// @ts-expect-error\n\t\tconst shape = options.body.shape;\n\t\tif (!shape) return undefined;\n\t\tconst properties: Record<string, any> = {};\n\t\tconst required: string[] = [];\n\t\tObject.entries(shape).forEach(([key, value]) => {\n\t\t\tif (value instanceof z.ZodType) {\n\t\t\t\tproperties[key] = processZodType(value as z.ZodType<any>);\n\t\t\t\tif (!(value instanceof z.ZodOptional)) {\n\t\t\t\t\trequired.push(key);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn {\n\t\t\trequired:\n\t\t\t\toptions.body instanceof z.ZodOptional\n\t\t\t\t\t? false\n\t\t\t\t\t: options.body\n\t\t\t\t\t\t? true\n\t\t\t\t\t\t: false,\n\t\t\tcontent: {\n\t\t\t\t\"application/json\": {\n\t\t\t\t\tschema: {\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\tproperties,\n\t\t\t\t\t\trequired,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t}\n\treturn undefined;\n}\n\nfunction processZodType(zodType: z.ZodType<any>): any {\n\t// optional unwrapping\n\tif (zodType instanceof z.ZodOptional) {\n\t\tconst innerType = (zodType as any)._def.innerType;\n\t\tconst innerSchema = processZodType(innerType);\n\t\tif (innerSchema.type) {\n\t\t\tconst type = Array.isArray(innerSchema.type)\n\t\t\t\t? innerSchema.type\n\t\t\t\t: [innerSchema.type];\n\t\t\treturn {\n\t\t\t\t...innerSchema,\n\t\t\t\ttype: Array.from(new Set([...type, \"null\"])),\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tanyOf: [innerSchema, { type: \"null\" }],\n\t\t};\n\t}\n\t// object unwrapping\n\tif (zodType instanceof z.ZodObject) {\n\t\tconst shape = (zodType as any).shape;\n\t\tif (shape) {\n\t\t\tconst properties: Record<string, any> = {};\n\t\t\tconst required: string[] = [];\n\t\t\tObject.entries(shape).forEach(([key, value]) => {\n\t\t\t\tif (value instanceof z.ZodType) {\n\t\t\t\t\tproperties[key] = processZodType(value as z.ZodType<any>);\n\t\t\t\t\tif (!(value instanceof z.ZodOptional)) {\n\t\t\t\t\t\trequired.push(key);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn {\n\t\t\t\ttype: \"object\",\n\t\t\t\tproperties,\n\t\t\t\t...(required.length > 0 ? { required } : {}),\n\t\t\t\tdescription: (zodType as any).description,\n\t\t\t};\n\t\t}\n\t}\n\n\t// For primitive types, get the correct type from the unwrapped ZodType\n\tconst baseSchema = {\n\t\ttype: getTypeFromZodType(zodType),\n\t\tdescription: (zodType as any).description,\n\t};\n\n\treturn baseSchema;\n}\n\nfunction getResponse(responses?: Record<string, any> | undefined) {\n\treturn {\n\t\t\"400\": {\n\t\t\tcontent: {\n\t\t\t\t\"application/json\": {\n\t\t\t\t\tschema: {\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\trequired: [\"message\"],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tdescription:\n\t\t\t\t\"Bad Request. Usually due to missing parameters, or invalid parameters.\",\n\t\t},\n\t\t\"401\": {\n\t\t\tcontent: {\n\t\t\t\t\"application/json\": {\n\t\t\t\t\tschema: {\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\trequired: [\"message\"],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tdescription: \"Unauthorized. Due to missing or invalid authentication.\",\n\t\t},\n\t\t\"403\": {\n\t\t\tcontent: {\n\t\t\t\t\"application/json\": {\n\t\t\t\t\tschema: {\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tdescription:\n\t\t\t\t\"Forbidden. You do not have permission to access this resource or to perform this action.\",\n\t\t},\n\t\t\"404\": {\n\t\t\tcontent: {\n\t\t\t\t\"application/json\": {\n\t\t\t\t\tschema: {\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tdescription: \"Not Found. The requested resource was not found.\",\n\t\t},\n\t\t\"429\": {\n\t\t\tcontent: {\n\t\t\t\t\"application/json\": {\n\t\t\t\t\tschema: {\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tdescription:\n\t\t\t\t\"Too Many Requests. You have exceeded the rate limit. Try again later.\",\n\t\t},\n\t\t\"500\": {\n\t\t\tcontent: {\n\t\t\t\t\"application/json\": {\n\t\t\t\t\tschema: {\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tdescription:\n\t\t\t\t\"Internal Server Error. This is a problem with the server that you cannot fix.\",\n\t\t},\n\t\t...responses,\n\t} as any;\n}\n\nfunction toOpenApiPath(path: string) {\n\t// /reset-password/:token -> /reset-password/{token}\n\t// replace all : with {}\n\treturn path\n\t\t.split(\"/\")\n\t\t.map((part) => (part.startsWith(\":\") ? `{${part.slice(1)}}` : part))\n\t\t.join(\"/\");\n}\n\nexport async function generator(ctx: AuthContext, options: BetterAuthOptions) {\n\tconst baseEndpoints = getEndpoints(ctx, {\n\t\t...options,\n\t\tplugins: [],\n\t});\n\n\tconst tables = getAuthTables({\n\t\t...options,\n\t\tsession: {\n\t\t\t...options.session,\n\t\t\tstoreSessionInDatabase: true, // Forcing this to true to return the session table schema\n\t\t},\n\t});\n\tconst models = Object.entries(tables).reduce<\n\t\tRecord<string, OpenAPIModelSchema>\n\t>((acc, [key, value]) => {\n\t\tconst modelName = key.charAt(0).toUpperCase() + key.slice(1);\n\t\tconst fields = value.fields;\n\t\tconst required: string[] = [];\n\t\tconst properties: Record<string, FieldSchema> = {\n\t\t\tid: { type: \"string\" },\n\t\t};\n\t\tObject.entries(fields).forEach(([fieldKey, fieldValue]) => {\n\t\t\tif (!fieldValue) return;\n\t\t\tproperties[fieldKey] = getFieldSchema(fieldValue);\n\t\t\tif (fieldValue.required && fieldValue.input !== false) {\n\t\t\t\trequired.push(fieldKey);\n\t\t\t}\n\t\t});\n\n\t\tObject.entries(properties).forEach(([key, prop]) => {\n\t\t\tconst field = value.fields[key];\n\t\t\tif (field && field.type === \"date\" && prop.type === \"string\") {\n\t\t\t\tprop.format = \"date-time\";\n\t\t\t}\n\t\t});\n\t\tacc[modelName] = {\n\t\t\ttype: \"object\",\n\t\t\tproperties,\n\t\t\trequired,\n\t\t};\n\t\treturn acc;\n\t}, {});\n\n\tconst components = {\n\t\tschemas: {\n\t\t\t...models,\n\t\t},\n\t};\n\n\tconst paths: Record<string, Path> = {};\n\n\tObject.entries(baseEndpoints.api).forEach(([_, value]) => {\n\t\tif (!value.path || ctx.options.disabledPaths?.includes(value.path)) return;\n\t\tconst options = value.options as EndpointOptions;\n\t\tif (options.metadata?.SERVER_ONLY) return;\n\t\tconst path = toOpenApiPath(value.path);\n\t\tif (options.method === \"GET\" || options.method === \"DELETE\") {\n\t\t\tpaths[path] = {\n\t\t\t\t...paths[path],\n\t\t\t\t[options.method.toLowerCase()]: {\n\t\t\t\t\ttags: [\"Default\", ...(options.metadata?.openapi?.tags || [])],\n\t\t\t\t\tdescription: options.metadata?.openapi?.description,\n\t\t\t\t\toperationId: options.metadata?.openapi?.operationId,\n\t\t\t\t\tsecurity: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbearerAuth: [],\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tparameters: getParameters(options),\n\t\t\t\t\tresponses: getResponse(options.metadata?.openapi?.responses),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\toptions.method === \"POST\" ||\n\t\t\toptions.method === \"PATCH\" ||\n\t\t\toptions.method === \"PUT\"\n\t\t) {\n\t\t\tconst body = getRequestBody(options);\n\t\t\tpaths[path] = {\n\t\t\t\t...paths[path],\n\t\t\t\t[options.method.toLowerCase()]: {\n\t\t\t\t\ttags: [\"Default\", ...(options.metadata?.openapi?.tags || [])],\n\t\t\t\t\tdescription: options.metadata?.openapi?.description,\n\t\t\t\t\toperationId: options.metadata?.openapi?.operationId,\n\t\t\t\t\tsecurity: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbearerAuth: [],\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tparameters: getParameters(options),\n\t\t\t\t\t...(body\n\t\t\t\t\t\t? { requestBody: body }\n\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\trequestBody: {\n\t\t\t\t\t\t\t\t\t//set body none\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}),\n\t\t\t\t\tresponses: getResponse(options.metadata?.openapi?.responses),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\t});\n\n\tfor (const plugin of options.plugins || []) {\n\t\tif (plugin.id === \"open-api\") {\n\t\t\tcontinue;\n\t\t}\n\t\tconst pluginEndpoints = getEndpoints(ctx, {\n\t\t\t...options,\n\t\t\tplugins: [plugin],\n\t\t});\n\t\tconst api = Object.keys(pluginEndpoints.api)\n\t\t\t.map((key) => {\n\t\t\t\tif (\n\t\t\t\t\tbaseEndpoints.api[key as keyof typeof baseEndpoints.api] === undefined\n\t\t\t\t) {\n\t\t\t\t\treturn pluginEndpoints.api[key as keyof typeof pluginEndpoints.api];\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t})\n\t\t\t.filter((x) => x !== null) as Endpoint[];\n\t\tObject.entries(api).forEach(([key, value]) => {\n\t\t\tif (!value.path || ctx.options.disabledPaths?.includes(value.path))\n\t\t\t\treturn;\n\t\t\tconst options = value.options as EndpointOptions;\n\t\t\tif (options.metadata?.SERVER_ONLY) return;\n\t\t\tconst path = toOpenApiPath(value.path);\n\t\t\tif (options.method === \"GET\" || options.method === \"DELETE\") {\n\t\t\t\tpaths[path] = {\n\t\t\t\t\t...paths[path],\n\t\t\t\t\t[options.method.toLowerCase()]: {\n\t\t\t\t\t\ttags: options.metadata?.openapi?.tags || [\n\t\t\t\t\t\t\tplugin.id.charAt(0).toUpperCase() + plugin.id.slice(1),\n\t\t\t\t\t\t],\n\t\t\t\t\t\tdescription: options.metadata?.openapi?.description,\n\t\t\t\t\t\toperationId: options.metadata?.openapi?.operationId,\n\t\t\t\t\t\tsecurity: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tbearerAuth: [],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t\tparameters: getParameters(options),\n\t\t\t\t\t\tresponses: getResponse(options.metadata?.openapi?.responses),\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t}\n\t\t\tif (\n\t\t\t\toptions.method === \"POST\" ||\n\t\t\t\toptions.method === \"PATCH\" ||\n\t\t\t\toptions.method === \"PUT\"\n\t\t\t) {\n\t\t\t\tpaths[path] = {\n\t\t\t\t\t...paths[path],\n\t\t\t\t\t[options.method.toLowerCase()]: {\n\t\t\t\t\t\ttags: options.metadata?.openapi?.tags || [\n\t\t\t\t\t\t\tplugin.id.charAt(0).toUpperCase() + plugin.id.slice(1),\n\t\t\t\t\t\t],\n\t\t\t\t\t\tdescription: options.metadata?.openapi?.description,\n\t\t\t\t\t\toperationId: options.metadata?.openapi?.operationId,\n\t\t\t\t\t\tsecurity: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tbearerAuth: [],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t\tparameters: getParameters(options),\n\t\t\t\t\t\trequestBody: getRequestBody(options),\n\t\t\t\t\t\tresponses: getResponse(options.metadata?.openapi?.responses),\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\t}\n\n\tconst res = {\n\t\topenapi: \"3.1.1\",\n\t\tinfo: {\n\t\t\ttitle: \"Better Auth\",\n\t\t\tdescription: \"API Reference for your Better Auth Instance\",\n\t\t\tversion: \"1.1.0\",\n\t\t},\n\t\tcomponents: {\n\t\t\t...components,\n\t\t\tsecuritySchemes: {\n\t\t\t\tapiKeyCookie: {\n\t\t\t\t\ttype: \"apiKey\",\n\t\t\t\t\tin: \"cookie\",\n\t\t\t\t\tname: \"apiKeyCookie\",\n\t\t\t\t\tdescription: \"API Key authentication via cookie\",\n\t\t\t\t},\n\t\t\t\tbearerAuth: {\n\t\t\t\t\ttype: \"http\",\n\t\t\t\t\tscheme: \"bearer\",\n\t\t\t\t\tdescription: \"Bearer token authentication\",\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tsecurity: [\n\t\t\t{\n\t\t\t\tapiKeyCookie: [],\n\t\t\t\tbearerAuth: [],\n\t\t\t},\n\t\t],\n\t\tservers: [\n\t\t\t{\n\t\t\t\turl: ctx.baseURL,\n\t\t\t},\n\t\t],\n\t\ttags: [\n\t\t\t{\n\t\t\t\tname: \"Default\",\n\t\t\t\tdescription:\n\t\t\t\t\t\"Default endpoints that are included with Better Auth by default. These endpoints are not part of any plugin.\",\n\t\t\t},\n\t\t],\n\t\tpaths,\n\t};\n\treturn res;\n}\n", "export const logo = `<svg width=\"75\" height=\"75\" viewBox=\"0 0 75 75\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<rect width=\"75\" height=\"75\" fill=\"url(#pattern0_21_12)\"/>\n<defs>\n<pattern id=\"pattern0_21_12\" patternContentUnits=\"objectBoundingBox\" width=\"1\" height=\"1\">\n<use xlink:href=\"#image0_21_12\" transform=\"scale(0.00094697)\"/>\n</pattern>\n<image id=\"image0_21_12\" width=\"1056\" height=\"1056\" xlink:href=\"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QBARXhpZgAATU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAEIKADAAQAAAABAAAEIAAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAAAAAABDUHYzZjwCyBOmACZjs+EJ+/+ICKElDQ19QUk9GSUxFAAEBAAACGGFwcGwEAAAAbW50clJHQiBYWVogB+YAAQABAAAAAAAAYWNzcEFQUEwAAAAAQVBQTAAAAAAAAAAAAAAAAAAAAAAAAPbWAAEAAAAA0y1hcHBs7P2jjjiFR8NttL1PetoYLwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKZGVzYwAAAPwAAAAwY3BydAAAASwAAABQd3RwdAAAAXwAAAAUclhZWgAAAZAAAAAUZ1hZWgAAAaQAAAAUYlhZWgAAAbgAAAAUclRSQwAAAcwAAAAgY2hhZAAAAewAAAAsYlRSQwAAAcwAAAAgZ1RSQwAAAcwAAAAgbWx1YwAAAAAAAAABAAAADGVuVVMAAAAUAAAAHABEAGkAcwBwAGwAYQB5ACAAUAAzbWx1YwAAAAAAAAABAAAADGVuVVMAAAA0AAAAHABDAG8AcAB5AHIAaQBnAGgAdAAgAEEAcABwAGwAZQAgAEkAbgBjAC4ALAAgADIAMAAyADJYWVogAAAAAAAA9tUAAQAAAADTLFhZWiAAAAAAAACD3wAAPb////+7WFlaIAAAAAAAAEq/AACxNwAACrlYWVogAAAAAAAAKDgAABELAADIuXBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbc2YzMgAAAAAAAQxCAAAF3v//8yYAAAeTAAD9kP//+6L///2jAAAD3AAAwG7/wAARCAQgBCADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9sAQwACAgICAgIDAgIDBAMDAwQFBAQEBAUHBQUFBQUHCAcHBwcHBwgICAgICAgICgoKCgoKCwsLCwsNDQ0NDQ0NDQ0N/9sAQwECAgIDAwMGAwMGDQkHCQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0N/90ABABC/9oADAMBAAIRAxEAPwD9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//T/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9b9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9H9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9T9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//V/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Ln/gq38a/in8Dvgp4T8R/CfxFdeG9SvvFMdlcXFoELyW5srqQxnzEcY3op4Gciv1Gr8Z/+C2X/JvXgj/sc4v/AE33lAH4z/8ADwv9tD/oq2tf9823/wAZo/4eF/tof9FW1r/vm2/+M18Z0UAfZn/Dwv8AbQ/6KtrX/fNt/wDGaP8Ah4X+2h/0VbWv++bb/wCM18Z0UAfZn/Dwv9tD/oq2tf8AfNt/8Zo/4eF/tof9FW1r/vm2/wDjNfGdFAH2Z/w8L/bQ/wCira1/3zbf/GaP+Hhf7aH/AEVbWv8Avm2/+M18Z0UAfZn/AA8L/bQ/6KtrX/fNt/8AGaP+Hhf7aH/RVta/75tv/jNfGdFAH2Z/w8L/AG0P+ira1/3zbf8Axmj/AIeF/tof9FW1r/vm2/8AjNfGdFAH63/sVftq/tTfEb9qb4deCfG3xF1TVtD1bVGgvbKdYBHPGIJW2ttiVsblB4I6V/UbX8Z//BPT/k9D4U/9hpv/AEmmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+M/wD4eF/tof8ARVta/wC+bb/4zR/w8L/bQ/6KtrX/AHzbf/Ga+M6KAPsz/h4X+2h/0VbWv++bb/4zR/w8L/bQ/wCira1/3zbf/Ga+M6KAPsz/AIeF/tof9FW1r/vm2/8AjNH/AA8L/bQ/6KtrX/fNt/8AGa+M6KAPsz/h4X+2h/0VbWv++bb/AOM0f8PC/wBtD/oq2tf9823/AMZr4zooA+zP+Hhf7aH/AEVbWv8Avm2/+M0f8PC/20P+ira1/wB823/xmvjOigD7M/4eF/tof9FW1r/vm2/+M0f8PC/20P8Aoq2tf9823/xmvjOigD7M/wCHhf7aH/RVta/75tv/AIzR/wAPC/20P+ira1/3zbf/ABmvjOigD7M/4eF/tof9FW1r/vm2/wDjNH/Dwv8AbQ/6KtrX/fNt/wDGa+M6KAPsz/h4X+2h/wBFW1r/AL5tv/jNH/Dwv9tD/oq2tf8AfNt/8Zr4zooA+zP+Hhf7aH/RVta/75tv/jNH/Dwv9tD/AKKtrX/fNt/8Zr4zooA+zP8Ah4X+2h/0VbWv++bb/wCM0f8ADwv9tD/oq2tf9823/wAZr4zooA+zP+Hhf7aH/RVta/75tv8A4zR/w8L/AG0P+ira1/3zbf8AxmvjOigD7M/4eF/tof8ARVta/wC+bb/4zR/w8L/bQ/6KtrX/AHzbf/Ga+M6KAP6tv+CUnxr+Kfxx+CnizxH8WPEV14k1Kx8UyWVvcXYQPHbiytZBGPLRBje7HkZya/Uavxn/AOCJv/JvXjf/ALHOX/032dfsxQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfxn/APBPT/k9D4U/9hpv/Saav7MKACiiigAooooAKKKKACiiigAooooAKKKKAP4A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfwq/BT4r638Dvin4d+LHhy0tb7UvDd0bu3t70ObeRzG0eJBGyPjDnowOa/Ub/h9l+0L/ANCR4M/79ah/8m0Af0yUV/M3/wAPsv2hf+hI8Gf9+tQ/+TaP+H2X7Qv/AEJHgz/v1qH/AMm0Af0yUV/M3/w+y/aF/wChI8Gf9+tQ/wDk2j/h9l+0L/0JHgz/AL9ah/8AJtAH9MlFfzN/8Psv2hf+hI8Gf9+tQ/8Ak2j/AIfZftC/9CR4M/79ah/8m0Af0yUV/M3/AMPsv2hf+hI8Gf8AfrUP/k2j/h9l+0L/ANCR4M/79ah/8m0Af0yUV/M3/wAPsv2hf+hI8Gf9+tQ/+TaP+H2X7Qv/AEJHgz/v1qH/AMm0Af0yUV/M3/w+y/aF/wChI8Gf9+tQ/wDk2j/h9l+0L/0JHgz/AL9ah/8AJtAH4z0V/TJ/w5N/Z6/6Hfxn/wB/dP8A/kKj/hyb+z1/0O/jP/v7p/8A8hUAfzN0V/TJ/wAOTf2ev+h38Z/9/dP/APkKj/hyb+z1/wBDv4z/AO/un/8AyFQB/M3RX9Mn/Dk39nr/AKHfxn/390//AOQqP+HJv7PX/Q7+M/8Av7p//wAhUAfzN0V/TJ/w5N/Z6/6Hfxn/AN/dP/8AkKj/AIcm/s9f9Dv4z/7+6f8A/IVAH8zdFf0yf8OTf2ev+h38Z/8Af3T/AP5Co/4cm/s9f9Dv4z/7+6f/APIVAH8zdFf0yf8ADk39nr/od/Gf/f3T/wD5Co/4cm/s9f8AQ7+M/wDv7p//AMhUAfzN0V/TJ/w5N/Z6/wCh38Z/9/dP/wDkKvwV/ag+FGifA74++M/hP4cu7q+03w3fi0t7i9KG4kQxRyZkMaomcueigYoA8FooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/AOxzl/8ATfZ1+zFfjP8A8ETf+TevG/8A2Ocv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v8ooooAKKKKACiiigAooooAKKKKACiiigAr+M//goX/wAnofFb/sNL/wCk0Nf2YV/Gf/wUL/5PQ+K3/YaX/wBJoaAPjOiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP7/KKKKACiiigAooooAKKKKACiiigAooooAK/jP/4KF/8AJ6HxW/7DS/8ApNDX9mFfxn/8FC/+T0Pit/2Gl/8ASaGgD4zooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/yiiigAooooAKKKKACiiigAooooAKKKKACv4z/+Chf/ACeh8Vv+w0v/AKTQ1/ZhX8Z//BQv/k9D4rf9hpf/AEmhoA+M6KKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v8ooooAKKKKACiiigAooooAKKKKACiiigAr+M//goX/wAnofFb/sNL/wCk0Nf2YV/Gf/wUL/5PQ+K3/YaX/wBJoaAPjOiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP7/KKKKACiiigAooooAKKKKACiiigAooooAK/jP/4KF/8AJ6HxW/7DS/8ApNDX9mFfxn/8FC/+T0Pit/2Gl/8ASaGgD4zooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/yiiigAooooAKKKKACiiigAooooAKKKKACv4z/+Chf/ACeh8Vv+w0v/AKTQ1/ZhX8Z//BQv/k9D4rf9hpf/AEmhoA+M6KKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD1L4KfCjW/jj8U/Dvwn8OXdrY6l4kujaW9xelxbxuI2kzIY1d8YQ9FJzX6jf8OTf2hf8Aod/Bn/f3UP8A5Cr4z/4J6f8AJ6Hwp/7DTf8ApNNX9mFAH8zf/Dk39oX/AKHfwZ/391D/AOQqP+HJv7Qv/Q7+DP8Av7qH/wAhV/TJRQB/M3/w5N/aF/6HfwZ/391D/wCQqP8Ahyb+0L/0O/gz/v7qH/yFX9MlFAH8zf8Aw5N/aF/6HfwZ/wB/dQ/+QqP+HJv7Qv8A0O/gz/v7qH/yFX9MlFAH8zf/AA5N/aF/6HfwZ/391D/5Co/4cm/tC/8AQ7+DP+/uof8AyFX9MlFAH8zf/Dk39oX/AKHfwZ/391D/AOQqP+HJv7Qv/Q7+DP8Av7qH/wAhV/TJRQB/M3/w5N/aF/6HfwZ/391D/wCQqP8Ahyb+0L/0O/gz/v7qH/yFX9MlFAH4z/8AD7L9nr/oSPGf/frT/wD5No/4fZfs9f8AQkeM/wDv1p//AMm1/M3RQB/TJ/w+y/Z6/wChI8Z/9+tP/wDk2j/h9l+z1/0JHjP/AL9af/8AJtfzN0UAf0yf8Psv2ev+hI8Z/wDfrT//AJNo/wCH2X7PX/QkeM/+/Wn/APybX8zdFAH9Mn/D7L9nr/oSPGf/AH60/wD+TaP+H2X7PX/QkeM/+/Wn/wDybX8zdFAH9Mn/AA+y/Z6/6Ejxn/360/8A+TaP+H2X7PX/AEJHjP8A79af/wDJtfzN0UAf0yf8Psv2ev8AoSPGf/frT/8A5No/4fZfs9f9CR4z/wC/Wn//ACbX8zdFAH9Mn/D7L9nr/oSPGf8A360//wCTa/BX9qD4r6J8cfj74z+LHhy0urHTfEl+Lu3t70ILiNBFHHiQRs6Zyh6MRivBaKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/ACb143/7HOX/ANN9nX7MV+M//BE3/k3rxv8A9jnL/wCm+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfxn/APBPT/k9D4U/9hpv/Saav7MKACiiigAooooAKKKKACiiigAooooAKKKKAP4A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+XP/BVv4KfFP44/BTwn4c+E/h268SalY+KY724t7QoHjtxZXUZkPmOgxvdRwc5NAH8pNFfZn/DvT9tD/olOtf99W3/AMeo/wCHen7aH/RKda/76tv/AI9QB8Z0V9mf8O9P20P+iU61/wB9W3/x6j/h3p+2h/0SnWv++rb/AOPUAfGdFfZn/DvT9tD/AKJTrX/fVt/8eo/4d6ftof8ARKda/wC+rb/49QB8Z0V9mf8ADvT9tD/olOtf99W3/wAeo/4d6ftof9Ep1r/vq2/+PUAfGdFfZn/DvT9tD/olOtf99W3/AMeo/wCHen7aH/RKda/76tv/AI9QB8Z0V9mf8O9P20P+iU61/wB9W3/x6j/h3p+2h/0SnWv++rb/AOPUAH/BPT/k9D4U/wDYab/0mmr+zCv5cv2Kv2Kv2pvhz+1N8OvG3jb4dappOh6TqjT3t7O0BjgjMEq7m2ys2NzAcA9a/qNoAKKKKACiiigAooooAKKKKACiiigAooooA/gDor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD9mP+CJv/JvXjf8A7HOX/wBN9nX7MV+XP/BKT4KfFP4HfBTxZ4c+LHh268N6lfeKZL23t7soXktzZWsYkHlu4xvRhyc5FfqNQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//T/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9b9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9H9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9T9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//V/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9f9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/2Q==\"/>\n</defs>\n</svg>\n`;\n", "import type { BetterAuthPlugin, LiteralString } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { APIError } from \"../../api\";\nimport { HIDE_METADATA } from \"../../utils\";\nimport { generator } from \"./generator\";\nimport { logo } from \"./logo\";\n\nexport type { FieldSchema, OpenAPIModelSchema, Path } from \"./generator\";\n\ntype ScalarTheme =\n\t| \"alternate\"\n\t| \"default\"\n\t| \"moon\"\n\t| \"purple\"\n\t| \"solarized\"\n\t| \"bluePlanet\"\n\t| \"saturn\"\n\t| \"kepler\"\n\t| \"mars\"\n\t| \"deepSpace\"\n\t| \"laserwave\"\n\t| \"none\";\n\nconst getHTML = (\n\tapiReference: Record<string, any>,\n\ttheme?: ScalarTheme | undefined,\n\tnonce?: string | undefined,\n) => {\n\tconst nonceAttr = nonce ? `nonce=\"${nonce}\"` : \"\";\n\treturn `<!doctype html>\n<html>\n  <head>\n    <title>Scalar API Reference</title>\n    <meta charset=\"utf-8\" />\n    <meta\n      name=\"viewport\"\n      content=\"width=device-width, initial-scale=1\" />\n  </head>\n  <body>\n    <script\n      id=\"api-reference\"\n      type=\"application/json\">\n    ${JSON.stringify(apiReference)}\n    </script>\n\t <script ${nonceAttr}>\n      var configuration = {\n\t  \tfavicon: \"data:image/svg+xml;utf8,${encodeURIComponent(logo)}\",\n\t   \ttheme: \"${theme || \"default\"}\",\n        metaData: {\n\t\t\ttitle: \"Better Auth API\",\n\t\t\tdescription: \"API Reference for your Better Auth Instance\",\n\t\t}\n      }\n\n      document.getElementById('api-reference').dataset.configuration =\n        JSON.stringify(configuration)\n    </script>\n\t  <script src=\"https://cdn.jsdelivr.net/npm/@scalar/api-reference\" ${nonceAttr}></script>\n  </body>\n</html>`;\n};\n\nexport interface OpenAPIOptions {\n\t/**\n\t * The path to the OpenAPI reference page\n\t *\n\t * keep in mind that this path will be appended to the base URL `/api/auth` path\n\t * by default, so if you set this to `/reference`, the full path will be `/api/auth/reference`\n\t *\n\t * @default \"/reference\"\n\t */\n\tpath?: LiteralString | undefined;\n\t/**\n\t * Disable the default reference page that is generated by Scalar\n\t *\n\t * @default false\n\t */\n\tdisableDefaultReference?: boolean | undefined;\n\t/**\n\t * Theme of the OpenAPI reference page.\n\t *\n\t * @default \"default\"\n\t */\n\ttheme?: ScalarTheme | undefined;\n\t/**\n\t * A 'nonce' string to be attached to inline scripts\n\t * for Content Security Policy (CSP) compliance.\n\t * @default undefined\n\t */\n\tnonce?: string | undefined;\n}\n\nexport const openAPI = <O extends OpenAPIOptions>(options?: O | undefined) => {\n\tconst path = (options?.path ?? \"/reference\") as \"/reference\";\n\treturn {\n\t\tid: \"open-api\",\n\t\tendpoints: {\n\t\t\tgenerateOpenAPISchema: createAuthEndpoint(\n\t\t\t\t\"/open-api/generate-schema\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst schema = await generator(ctx.context, ctx.context.options);\n\t\t\t\t\treturn ctx.json(schema);\n\t\t\t\t},\n\t\t\t),\n\t\t\topenAPIReference: createAuthEndpoint(\n\t\t\t\tpath,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\tmetadata: HIDE_METADATA,\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tif (options?.disableDefaultReference) {\n\t\t\t\t\t\tthrow new APIError(\"NOT_FOUND\");\n\t\t\t\t\t}\n\t\t\t\t\tconst schema = await generator(ctx.context, ctx.context.options);\n\t\t\t\t\treturn new Response(getHTML(schema, options?.theme, options?.nonce), {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\"Content-Type\": \"text/html\",\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\toptions: options as NoInfer<O>,\n\t} satisfies BetterAuthPlugin;\n};\n\nexport type * from \"./generator\";\n", "import type { AuthContext, GenericEndpointContext } from \"@better-auth/core\";\nimport { getCurrentAdapter } from \"@better-auth/core/context\";\nimport { BetterAuthError } from \"@better-auth/core/error\";\nimport { parseJSON } from \"../../client/parser\";\nimport type { InferAdditionalFieldsFromPluginOptions } from \"../../db\";\nimport type { Session, User } from \"../../types\";\nimport { getDate } from \"../../utils/date\";\nimport type {\n\tInferInvitation,\n\tInferMember,\n\tInferOrganization,\n\tInferTeam,\n\tInvitationInput,\n\tMember,\n\tMemberInput,\n\tOrganizationInput,\n\tTeam,\n\tTeamInput,\n\tTeamMember,\n} from \"./schema\";\nimport type { OrganizationOptions } from \"./types\";\n\nexport const getOrgAdapter = <O extends OrganizationOptions>(\n\tcontext: AuthContext,\n\toptions?: O | undefined,\n) => {\n\tconst baseAdapter = context.adapter;\n\treturn {\n\t\tfindOrganizationBySlug: async (slug: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst organization = await adapter.findOne<InferOrganization<O, false>>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"slug\",\n\t\t\t\t\t\tvalue: slug,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn organization;\n\t\t},\n\t\tcreateOrganization: async (data: {\n\t\t\torganization: OrganizationInput &\n\t\t\t\t// This represents the additional fields from the plugin options\n\t\t\t\tRecord<string, any>;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst organization = await adapter.create<\n\t\t\t\tOrganizationInput,\n\t\t\t\tInferOrganization<O, false>\n\t\t\t>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\tdata: {\n\t\t\t\t\t...data.organization,\n\t\t\t\t\tmetadata: data.organization.metadata\n\t\t\t\t\t\t? JSON.stringify(data.organization.metadata)\n\t\t\t\t\t\t: undefined,\n\t\t\t\t},\n\t\t\t\tforceAllowId: true,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\t...organization,\n\t\t\t\tmetadata:\n\t\t\t\t\torganization.metadata && typeof organization.metadata === \"string\"\n\t\t\t\t\t\t? JSON.parse(organization.metadata)\n\t\t\t\t\t\t: undefined,\n\t\t\t} as typeof organization;\n\t\t},\n\t\tfindMemberByEmail: async (data: {\n\t\t\temail: string;\n\t\t\torganizationId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst user = await adapter.findOne<User>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"email\",\n\t\t\t\t\t\tvalue: data.email.toLowerCase(),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tconst member = await adapter.findOne<InferMember<O, false>>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\t...member,\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.id,\n\t\t\t\t\tname: user.name,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\timage: user.image,\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tlistMembers: async (data: {\n\t\t\torganizationId?: string | undefined;\n\t\t\tlimit?: number | undefined;\n\t\t\toffset?: number | undefined;\n\t\t\tsortBy?: string | undefined;\n\t\t\tsortOrder?: (\"asc\" | \"desc\") | undefined;\n\t\t\tfilter?:\n\t\t\t\t| {\n\t\t\t\t\t\tfield: string;\n\t\t\t\t\t\toperator?: \"eq\" | \"ne\" | \"lt\" | \"lte\" | \"gt\" | \"gte\" | \"contains\";\n\t\t\t\t\t\tvalue: any;\n\t\t\t\t  }\n\t\t\t\t| undefined;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst members = await Promise.all([\n\t\t\t\tadapter.findMany<InferMember<O, false>>({\n\t\t\t\t\tmodel: \"member\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{ field: \"organizationId\", value: data.organizationId },\n\t\t\t\t\t\t...(data.filter?.field\n\t\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tfield: data.filter?.field,\n\t\t\t\t\t\t\t\t\t\tvalue: data.filter?.value,\n\t\t\t\t\t\t\t\t\t\t...(data.filter.operator\n\t\t\t\t\t\t\t\t\t\t\t? { operator: data.filter.operator }\n\t\t\t\t\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t: []),\n\t\t\t\t\t],\n\t\t\t\t\tlimit: data.limit || options?.membershipLimit || 100,\n\t\t\t\t\toffset: data.offset || 0,\n\t\t\t\t\tsortBy: data.sortBy\n\t\t\t\t\t\t? { field: data.sortBy, direction: data.sortOrder || \"asc\" }\n\t\t\t\t\t\t: undefined,\n\t\t\t\t}),\n\t\t\t\tadapter.count({\n\t\t\t\t\tmodel: \"member\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{ field: \"organizationId\", value: data.organizationId },\n\t\t\t\t\t\t...(data.filter?.field\n\t\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tfield: data.filter?.field,\n\t\t\t\t\t\t\t\t\t\tvalue: data.filter?.value,\n\t\t\t\t\t\t\t\t\t\t...(data.filter.operator\n\t\t\t\t\t\t\t\t\t\t\t? { operator: data.filter.operator }\n\t\t\t\t\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t: []),\n\t\t\t\t\t],\n\t\t\t\t}),\n\t\t\t]);\n\t\t\tconst users = await adapter.findMany<User>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: members[0].map((member) => member.userId),\n\t\t\t\t\t\toperator: \"in\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tmembers: members[0].map((member) => {\n\t\t\t\t\tconst user = users.find((user) => user.id === member.userId);\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tthrow new BetterAuthError(\n\t\t\t\t\t\t\t\"Unexpected error: User not found for member\",\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...member,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t\t\ttotal: members[1],\n\t\t\t};\n\t\t},\n\t\tfindMemberByOrgId: async (data: {\n\t\t\tuserId: string;\n\t\t\torganizationId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findOne<\n\t\t\t\tInferMember<O, false> & { user: User }\n\t\t\t>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\tuser: true,\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!result || !result.user) return null;\n\t\t\tconst { user, ...member } = result;\n\n\t\t\treturn {\n\t\t\t\t...member,\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.id,\n\t\t\t\t\tname: user.name,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\timage: user.image,\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tfindMemberById: async (memberId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findOne<\n\t\t\t\tInferMember<O, false> & { user: User }\n\t\t\t>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: memberId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\tuser: true,\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!result) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tconst { user, ...member } = result;\n\n\t\t\treturn {\n\t\t\t\t...(member as unknown as InferMember<O, false>),\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.id,\n\t\t\t\t\tname: user.name,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\timage: user.image,\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tcreateMember: async (\n\t\t\tdata: Omit<MemberInput, \"id\"> &\n\t\t\t\t// Additional fields from the plugin options\n\t\t\t\tRecord<string, any>,\n\t\t) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.create<\n\t\t\t\ttypeof data,\n\t\t\t\tMember & InferAdditionalFieldsFromPluginOptions<\"member\", O, false>\n\t\t\t>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\tdata: {\n\t\t\t\t\t...data,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn member;\n\t\t},\n\t\tupdateMember: async (memberId: string, role: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.update<InferMember<O, false>>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: memberId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\trole,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn member;\n\t\t},\n\t\tdeleteMember: async ({\n\t\t\tmemberId,\n\t\t\torganizationId,\n\t\t\tuserId: _userId,\n\t\t}: {\n\t\t\tmemberId: string;\n\t\t\torganizationId: string;\n\t\t\tuserId?: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tlet userId: string;\n\t\t\tif (!_userId) {\n\t\t\t\tconst member = await adapter.findOne<Member>({\n\t\t\t\t\tmodel: \"member\",\n\t\t\t\t\twhere: [{ field: \"id\", value: memberId }],\n\t\t\t\t});\n\t\t\t\tif (!member) {\n\t\t\t\t\tthrow new BetterAuthError(\"Member not found\");\n\t\t\t\t}\n\t\t\t\tuserId = member.userId;\n\t\t\t} else {\n\t\t\t\tuserId = _userId;\n\t\t\t}\n\t\t\tconst member = await adapter.delete<InferMember<O, false>>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: memberId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\t// remove member from all teams they're part of\n\t\t\tif (options?.teams?.enabled) {\n\t\t\t\tconst teams = await adapter.findMany<Team>({\n\t\t\t\t\tmodel: \"team\",\n\t\t\t\t\twhere: [{ field: \"organizationId\", value: organizationId }],\n\t\t\t\t});\n\t\t\t\tawait Promise.all(\n\t\t\t\t\tteams.map((team) =>\n\t\t\t\t\t\tadapter.deleteMany({\n\t\t\t\t\t\t\tmodel: \"teamMember\",\n\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t{ field: \"teamId\", value: team.id },\n\t\t\t\t\t\t\t\t{ field: \"userId\", value: userId },\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn member;\n\t\t},\n\t\tupdateOrganization: async (\n\t\t\torganizationId: string,\n\t\t\tdata: Partial<OrganizationInput>,\n\t\t) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst organization = await adapter.update<InferOrganization<O, false>>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\t...data,\n\t\t\t\t\tmetadata:\n\t\t\t\t\t\ttypeof data.metadata === \"object\"\n\t\t\t\t\t\t\t? JSON.stringify(data.metadata)\n\t\t\t\t\t\t\t: data.metadata,\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!organization) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\t...organization,\n\t\t\t\tmetadata: organization.metadata\n\t\t\t\t\t? parseJSON<Record<string, any>>(organization.metadata)\n\t\t\t\t\t: undefined,\n\t\t\t};\n\t\t},\n\t\tdeleteOrganization: async (organizationId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tawait adapter.deleteMany({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tawait adapter.deleteMany({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tawait adapter.delete<InferOrganization<O, false>>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn organizationId;\n\t\t},\n\t\tsetActiveOrganization: async (\n\t\t\tsessionToken: string,\n\t\t\torganizationId: string | null,\n\t\t\tctx: GenericEndpointContext,\n\t\t) => {\n\t\t\tconst session = await context.internalAdapter.updateSession(\n\t\t\t\tsessionToken,\n\t\t\t\t{\n\t\t\t\t\tactiveOrganizationId: organizationId,\n\t\t\t\t},\n\t\t\t);\n\t\t\treturn session as Session;\n\t\t},\n\t\tfindOrganizationById: async (organizationId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst organization = await adapter.findOne<InferOrganization<O, false>>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn organization;\n\t\t},\n\t\tcheckMembership: async ({\n\t\t\tuserId,\n\t\t\torganizationId,\n\t\t}: {\n\t\t\tuserId: string;\n\t\t\torganizationId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.findOne<InferMember<O, false>>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: userId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn member;\n\t\t},\n\t\t/**\n\t\t * @requires db\n\t\t */\n\t\tfindFullOrganization: async ({\n\t\t\torganizationId,\n\t\t\tisSlug,\n\t\t\tincludeTeams,\n\t\t\tmembersLimit,\n\t\t}: {\n\t\t\torganizationId: string;\n\t\t\tisSlug?: boolean | undefined;\n\t\t\tincludeTeams?: boolean | undefined;\n\t\t\tmembersLimit?: number | undefined;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findOne<\n\t\t\t\tInferOrganization<O, false> & {\n\t\t\t\t\tinvitation: InferInvitation<O>[];\n\t\t\t\t\tmember: InferMember<O>[];\n\t\t\t\t\tteam: InferTeam<O>[] | undefined;\n\t\t\t\t}\n\t\t\t>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [{ field: isSlug ? \"slug\" : \"id\", value: organizationId }],\n\t\t\t\tjoin: {\n\t\t\t\t\tinvitation: true,\n\t\t\t\t\tmember: membersLimit ? { limit: membersLimit } : true,\n\t\t\t\t\t...(includeTeams ? { team: true } : {}),\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!result) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst {\n\t\t\t\tinvitation: invitations,\n\t\t\t\tmember: members,\n\t\t\t\tteam: teams,\n\t\t\t\t...org\n\t\t\t} = result;\n\t\t\tconst userIds = members.map((member) => member.userId);\n\t\t\tconst users =\n\t\t\t\tuserIds.length > 0\n\t\t\t\t\t? await adapter.findMany<User>({\n\t\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\t\twhere: [{ field: \"id\", value: userIds, operator: \"in\" }],\n\t\t\t\t\t\t\tlimit: options?.membershipLimit || 100,\n\t\t\t\t\t\t})\n\t\t\t\t\t: [];\n\n\t\t\tconst userMap = new Map(users.map((user) => [user.id, user]));\n\t\t\tconst membersWithUsers = members.map((member) => {\n\t\t\t\tconst user = userMap.get(member.userId);\n\t\t\t\tif (!user) {\n\t\t\t\t\tthrow new BetterAuthError(\n\t\t\t\t\t\t\"Unexpected error: User not found for member\",\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\t...member,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\t...org,\n\t\t\t\tinvitations,\n\t\t\t\tmembers: membersWithUsers,\n\t\t\t\tteams,\n\t\t\t};\n\t\t},\n\t\tlistOrganizations: async (userId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findMany<\n\t\t\t\tInferMember<O, false> & { organization: InferOrganization<O, false> }\n\t\t\t>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\torganization: true,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (!result || result.length === 0) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tconst organizations = result.map((member) => member.organization);\n\n\t\t\treturn organizations;\n\t\t},\n\t\tcreateTeam: async (data: Omit<TeamInput, \"id\">) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst team = await adapter.create<\n\t\t\t\tOmit<TeamInput, \"id\">,\n\t\t\t\tInferTeam<O, false>\n\t\t\t>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\tdata,\n\t\t\t});\n\t\t\treturn team;\n\t\t},\n\t\tfindTeamById: async <IncludeMembers extends boolean>({\n\t\t\tteamId,\n\t\t\torganizationId,\n\t\t\tincludeTeamMembers,\n\t\t}: {\n\t\t\tteamId: string;\n\t\t\torganizationId?: string | undefined;\n\t\t\tincludeTeamMembers?: IncludeMembers | undefined;\n\t\t}): Promise<\n\t\t\t| (InferTeam<O> &\n\t\t\t\t\t(IncludeMembers extends true ? { members: TeamMember[] } : {}))\n\t\t\t| null\n\t\t> => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findOne<\n\t\t\t\tInferTeam<O> & { teamMember: TeamMember[] }\n\t\t\t>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t\t...(organizationId\n\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t: []),\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\t// In the future when `join` support is better, we can apply the `membershipLimit` here. Right now we're just querying 100.\n\t\t\t\t\t...(includeTeamMembers ? { teamMember: true } : {}),\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!result) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tconst { teamMember, ...team } = result;\n\n\t\t\treturn {\n\t\t\t\t...team,\n\t\t\t\t...(includeTeamMembers ? { members: teamMember } : {}),\n\t\t\t} as any;\n\t\t},\n\t\tupdateTeam: async (\n\t\t\tteamId: string,\n\t\t\tdata: {\n\t\t\t\tname?: string | undefined;\n\t\t\t\tdescription?: string | undefined;\n\t\t\t\tstatus?: string | undefined;\n\t\t\t},\n\t\t) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tif (\"id\" in data) data.id = undefined;\n\t\t\tconst team = await adapter.update<\n\t\t\t\tInferTeam<O, false> & InferAdditionalFieldsFromPluginOptions<\"team\", O>\n\t\t\t>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\t...data,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn team;\n\t\t},\n\n\t\tdeleteTeam: async (teamId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tawait adapter.deleteMany({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\tconst team = await adapter.delete<InferTeam<O, false>>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn team;\n\t\t},\n\n\t\tlistTeams: async (organizationId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst teams = await adapter.findMany<InferTeam<O, false>>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn teams;\n\t\t},\n\n\t\tcreateTeamInvitation: async ({\n\t\t\temail,\n\t\t\trole,\n\t\t\tteamId,\n\t\t\torganizationId,\n\t\t\tinviterId,\n\t\t\texpiresIn = 1000 * 60 * 60 * 48, // Default expiration: 48 hours\n\t\t}: {\n\t\t\temail: string;\n\t\t\trole: string;\n\t\t\tteamId: string;\n\t\t\torganizationId: string;\n\t\t\tinviterId: string;\n\t\t\texpiresIn?: number | undefined;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst expiresAt = getDate(expiresIn); // Get expiration date\n\n\t\t\tconst invitation = await adapter.create<\n\t\t\t\tInvitationInput,\n\t\t\t\tInferInvitation<O>\n\t\t\t>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\tdata: {\n\t\t\t\t\temail,\n\t\t\t\t\trole,\n\t\t\t\t\torganizationId,\n\t\t\t\t\tteamId,\n\t\t\t\t\tinviterId,\n\t\t\t\t\tstatus: \"pending\",\n\t\t\t\t\texpiresAt,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn invitation;\n\t\t},\n\n\t\tsetActiveTeam: async (\n\t\t\tsessionToken: string,\n\t\t\tteamId: string | null,\n\t\t\tctx: GenericEndpointContext,\n\t\t) => {\n\t\t\tconst session = await context.internalAdapter.updateSession(\n\t\t\t\tsessionToken,\n\t\t\t\t{\n\t\t\t\t\tactiveTeamId: teamId,\n\t\t\t\t},\n\t\t\t);\n\t\t\treturn session as Session;\n\t\t},\n\n\t\tlistTeamMembers: async (data: { teamId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst members = await adapter.findMany<TeamMember>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: data.teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\treturn members;\n\t\t},\n\t\tcountTeamMembers: async (data: { teamId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst count = await adapter.count({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [{ field: \"teamId\", value: data.teamId }],\n\t\t\t});\n\t\t\treturn count;\n\t\t},\n\t\tcountMembers: async (data: { organizationId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst count = await adapter.count({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [{ field: \"organizationId\", value: data.organizationId }],\n\t\t\t});\n\t\t\treturn count;\n\t\t},\n\t\tlistTeamsByUser: async (data: { userId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst results = await adapter.findMany<TeamMember & { team: Team }>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\tteam: true,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn results.map((result) => result.team);\n\t\t},\n\n\t\tfindTeamMember: async (data: { teamId: string; userId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.findOne<TeamMember>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: data.teamId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\treturn member;\n\t\t},\n\n\t\tfindOrCreateTeamMember: async (data: {\n\t\t\tteamId: string;\n\t\t\tuserId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.findOne<TeamMember>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: data.teamId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\tif (member) return member;\n\n\t\t\treturn await adapter.create<Omit<TeamMember, \"id\">, TeamMember>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\tdata: {\n\t\t\t\t\tteamId: data.teamId,\n\t\t\t\t\tuserId: data.userId,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\tremoveTeamMember: async (data: { teamId: string; userId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\t// use `deleteMany` instead of `delete` since Prisma requires 1 unique field for normal `delete` operations\n\t\t\t// FKs do not count thus breaking the operation. As a solution, we'll use `deleteMany` instead.\n\t\t\tawait adapter.deleteMany({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: data.teamId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t},\n\t\tfindInvitationsByTeamId: async (teamId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitations = await adapter.findMany<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitations;\n\t\t},\n\t\tlistUserInvitations: async (email: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitations = await adapter.findMany<\n\t\t\t\tInferInvitation<O, false> & {\n\t\t\t\t\torganization: InferOrganization<O, false>;\n\t\t\t\t}\n\t\t\t>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [{ field: \"email\", value: email.toLowerCase() }],\n\t\t\t\tjoin: {\n\t\t\t\t\torganization: true,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn invitations.map(({ organization, ...inv }) => ({\n\t\t\t\t...inv,\n\t\t\t\torganizationName: organization.name,\n\t\t\t}));\n\t\t},\n\t\tcreateInvitation: async ({\n\t\t\tinvitation,\n\t\t\tuser,\n\t\t}: {\n\t\t\tinvitation: {\n\t\t\t\temail: string;\n\t\t\t\trole: string;\n\t\t\t\torganizationId: string;\n\t\t\t\tteamIds: string[];\n\t\t\t} & Record<string, any>; // This represents the additionalFields for the invitation\n\t\t\tuser: User;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst defaultExpiration = 60 * 60 * 48;\n\t\t\tconst expiresAt = getDate(\n\t\t\t\toptions?.invitationExpiresIn || defaultExpiration,\n\t\t\t\t\"sec\",\n\t\t\t);\n\t\t\tconst invite = await adapter.create<\n\t\t\t\tOmit<InvitationInput, \"id\">,\n\t\t\t\tInferInvitation<O, false>\n\t\t\t>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\tdata: {\n\t\t\t\t\tstatus: \"pending\",\n\t\t\t\t\texpiresAt,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\tinviterId: user.id,\n\t\t\t\t\t...invitation,\n\t\t\t\t\tteamId:\n\t\t\t\t\t\tinvitation.teamIds.length > 0 ? invitation.teamIds.join(\",\") : null,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn invite;\n\t\t},\n\t\tfindInvitationById: async (id: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitation = await adapter.findOne<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: id,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitation;\n\t\t},\n\t\tfindPendingInvitation: async (data: {\n\t\t\temail: string;\n\t\t\torganizationId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitation = await adapter.findMany<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"email\",\n\t\t\t\t\t\tvalue: data.email.toLowerCase(),\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"status\",\n\t\t\t\t\t\tvalue: \"pending\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitation.filter(\n\t\t\t\t(invite) => new Date(invite.expiresAt) > new Date(),\n\t\t\t);\n\t\t},\n\t\tfindPendingInvitations: async (data: { organizationId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitations = await adapter.findMany<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"status\",\n\t\t\t\t\t\tvalue: \"pending\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitations.filter(\n\t\t\t\t(invite) => new Date(invite.expiresAt) > new Date(),\n\t\t\t);\n\t\t},\n\t\tlistInvitations: async (data: { organizationId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitations = await adapter.findMany<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitations;\n\t\t},\n\t\tupdateInvitation: async (data: {\n\t\t\tinvitationId: string;\n\t\t\tstatus: \"accepted\" | \"canceled\" | \"rejected\";\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitation = await adapter.update<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: data.invitationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\tstatus: data.status,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn invitation;\n\t\t},\n\t};\n};\n", "import { createAccessControl } from \"../../access\";\n\nexport const defaultStatements = {\n\torganization: [\"update\", \"delete\"],\n\tmember: [\"create\", \"update\", \"delete\"],\n\tinvitation: [\"create\", \"cancel\"],\n\tteam: [\"create\", \"update\", \"delete\"],\n\tac: [\"create\", \"read\", \"update\", \"delete\"],\n} as const;\n\nexport const defaultAc = createAccessControl(defaultStatements);\n\nexport const adminAc = defaultAc.newRole({\n\torganization: [\"update\"],\n\tinvitation: [\"create\", \"cancel\"],\n\tmember: [\"create\", \"update\", \"delete\"],\n\tteam: [\"create\", \"update\", \"delete\"],\n\tac: [\"create\", \"read\", \"update\", \"delete\"],\n});\n\nexport const ownerAc = defaultAc.newRole({\n\torganization: [\"update\", \"delete\"],\n\tmember: [\"create\", \"update\", \"delete\"],\n\tinvitation: [\"create\", \"cancel\"],\n\tteam: [\"create\", \"update\", \"delete\"],\n\tac: [\"create\", \"read\", \"update\", \"delete\"],\n});\n\nexport const memberAc = defaultAc.newRole({\n\torganization: [],\n\tmember: [],\n\tinvitation: [],\n\tteam: [],\n\tac: [\"read\"], // Allow members to see all roles for their org.\n});\n\nexport const defaultRoles = {\n\tadmin: adminAc,\n\towner: ownerAc,\n\tmember: memberAc,\n};\n", "export const shimContext = <T extends Record<string, any>>(\n\toriginalObject: T,\n\tnewContext: Record<string, any>,\n) => {\n\tconst shimmedObj: Record<string, any> = {};\n\tfor (const [key, value] of Object.entries(originalObject)) {\n\t\tshimmedObj[key] = (ctx: Record<string, any>) => {\n\t\t\treturn value({\n\t\t\t\t...ctx,\n\t\t\t\tcontext: {\n\t\t\t\t\t...newContext,\n\t\t\t\t\t...ctx.context,\n\t\t\t\t},\n\t\t\t});\n\t\t};\n\t\tshimmedObj[key].path = value.path;\n\t\tshimmedObj[key].method = value.method;\n\t\tshimmedObj[key].options = value.options;\n\t\tshimmedObj[key].headers = value.headers;\n\t}\n\treturn shimmedObj as T;\n};\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { createAuthMiddleware } from \"@better-auth/core/api\";\nimport { sessionMiddleware } from \"../../api\";\nimport type { Session, User } from \"../../types\";\nimport type { Role } from \"../access\";\nimport type { defaultRoles } from \"./access/statement\";\nimport type { OrganizationOptions } from \"./types\";\n\nexport const orgMiddleware = createAuthMiddleware(async () => {\n\treturn {} as {\n\t\torgOptions: OrganizationOptions;\n\t\troles: typeof defaultRoles & {\n\t\t\t[key: string]: Role<{}>;\n\t\t};\n\t\tgetSession: (context: GenericEndpointContext) => Promise<{\n\t\t\tsession: Session & {\n\t\t\t\tactiveTeamId?: string | undefined;\n\t\t\t\tactiveOrganizationId?: string | undefined;\n\t\t\t};\n\t\t\tuser: User;\n\t\t}>;\n\t};\n});\n\n/**\n * The middleware forces the endpoint to require a valid session by utilizing the `sessionMiddleware`.\n * It also appends additional types to the session type regarding organizations.\n */\nexport const orgSessionMiddleware = createAuthMiddleware(\n\t{\n\t\tuse: [sessionMiddleware],\n\t},\n\tasync (ctx) => {\n\t\tconst session = ctx.context.session as {\n\t\t\tsession: Session & {\n\t\t\t\tactiveTeamId?: string | undefined;\n\t\t\t\tactiveOrganizationId?: string | undefined;\n\t\t\t};\n\t\t\tuser: User;\n\t\t};\n\t\treturn {\n\t\t\tsession,\n\t\t};\n\t},\n);\n", "import { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const ORGANIZATION_ERROR_CODES = defineErrorCodes({\n\tYOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION:\n\t\t\"You are not allowed to create a new organization\",\n\tYOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS:\n\t\t\"You have reached the maximum number of organizations\",\n\tORGANIZATION_ALREADY_EXISTS: \"Organization already exists\",\n\tORGANIZATION_SLUG_ALREADY_TAKEN: \"Organization slug already taken\",\n\tORGANIZATION_NOT_FOUND: \"Organization not found\",\n\tUSER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION:\n\t\t\"User is not a member of the organization\",\n\tYOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION:\n\t\t\"You are not allowed to update this organization\",\n\tYOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION:\n\t\t\"You are not allowed to delete this organization\",\n\tNO_ACTIVE_ORGANIZATION: \"No active organization\",\n\tUSER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION:\n\t\t\"User is already a member of this organization\",\n\tMEMBER_NOT_FOUND: \"Member not found\",\n\tROLE_NOT_FOUND: \"Role not found\",\n\tYOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_TEAM:\n\t\t\"You are not allowed to create a new team\",\n\tTEAM_ALREADY_EXISTS: \"Team already exists\",\n\tTEAM_NOT_FOUND: \"Team not found\",\n\tYOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER:\n\t\t\"You cannot leave the organization as the only owner\",\n\tYOU_CANNOT_LEAVE_THE_ORGANIZATION_WITHOUT_AN_OWNER:\n\t\t\"You cannot leave the organization without an owner\",\n\tYOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER:\n\t\t\"You are not allowed to delete this member\",\n\tYOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION:\n\t\t\"You are not allowed to invite users to this organization\",\n\tUSER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION:\n\t\t\"User is already invited to this organization\",\n\tINVITATION_NOT_FOUND: \"Invitation not found\",\n\tYOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION:\n\t\t\"You are not the recipient of the invitation\",\n\tEMAIL_VERIFICATION_REQUIRED_BEFORE_ACCEPTING_OR_REJECTING_INVITATION:\n\t\t\"Email verification required before accepting or rejecting invitation\",\n\tYOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION:\n\t\t\"You are not allowed to cancel this invitation\",\n\tINVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION:\n\t\t\"Inviter is no longer a member of the organization\",\n\tYOU_ARE_NOT_ALLOWED_TO_INVITE_USER_WITH_THIS_ROLE:\n\t\t\"You are not allowed to invite a user with this role\",\n\tFAILED_TO_RETRIEVE_INVITATION: \"Failed to retrieve invitation\",\n\tYOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_TEAMS:\n\t\t\"You have reached the maximum number of teams\",\n\tUNABLE_TO_REMOVE_LAST_TEAM: \"Unable to remove last team\",\n\tYOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_MEMBER:\n\t\t\"You are not allowed to update this member\",\n\tORGANIZATION_MEMBERSHIP_LIMIT_REACHED:\n\t\t\"Organization membership limit reached\",\n\tYOU_ARE_NOT_ALLOWED_TO_CREATE_TEAMS_IN_THIS_ORGANIZATION:\n\t\t\"You are not allowed to create teams in this organization\",\n\tYOU_ARE_NOT_ALLOWED_TO_DELETE_TEAMS_IN_THIS_ORGANIZATION:\n\t\t\"You are not allowed to delete teams in this organization\",\n\tYOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_TEAM:\n\t\t\"You are not allowed to update this team\",\n\tYOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_TEAM:\n\t\t\"You are not allowed to delete this team\",\n\tINVITATION_LIMIT_REACHED: \"Invitation limit reached\",\n\tTEAM_MEMBER_LIMIT_REACHED: \"Team member limit reached\",\n\tUSER_IS_NOT_A_MEMBER_OF_THE_TEAM: \"User is not a member of the team\",\n\tYOU_CAN_NOT_ACCESS_THE_MEMBERS_OF_THIS_TEAM:\n\t\t\"You are not allowed to list the members of this team\",\n\tYOU_DO_NOT_HAVE_AN_ACTIVE_TEAM: \"You do not have an active team\",\n\tYOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_TEAM_MEMBER:\n\t\t\"You are not allowed to create a new member\",\n\tYOU_ARE_NOT_ALLOWED_TO_REMOVE_A_TEAM_MEMBER:\n\t\t\"You are not allowed to remove a team member\",\n\tYOU_ARE_NOT_ALLOWED_TO_ACCESS_THIS_ORGANIZATION:\n\t\t\"You are not allowed to access this organization as an owner\",\n\tYOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION:\n\t\t\"You are not a member of this organization\",\n\tMISSING_AC_INSTANCE:\n\t\t\"Dynamic Access Control requires a pre-defined ac instance on the server auth plugin. Read server logs for more information\",\n\tYOU_MUST_BE_IN_AN_ORGANIZATION_TO_CREATE_A_ROLE:\n\t\t\"You must be in an organization to create a role\",\n\tYOU_ARE_NOT_ALLOWED_TO_CREATE_A_ROLE: \"You are not allowed to create a role\",\n\tYOU_ARE_NOT_ALLOWED_TO_UPDATE_A_ROLE: \"You are not allowed to update a role\",\n\tYOU_ARE_NOT_ALLOWED_TO_DELETE_A_ROLE: \"You are not allowed to delete a role\",\n\tYOU_ARE_NOT_ALLOWED_TO_READ_A_ROLE: \"You are not allowed to read a role\",\n\tYOU_ARE_NOT_ALLOWED_TO_LIST_A_ROLE: \"You are not allowed to list a role\",\n\tYOU_ARE_NOT_ALLOWED_TO_GET_A_ROLE: \"You are not allowed to get a role\",\n\tTOO_MANY_ROLES: \"This organization has too many roles\",\n\tINVALID_RESOURCE: \"The provided permission includes an invalid resource\",\n\tROLE_NAME_IS_ALREADY_TAKEN: \"That role name is already taken\",\n\tCANNOT_DELETE_A_PRE_DEFINED_ROLE: \"Cannot delete a pre-defined role\",\n});\n", "import type { Role } from \"../access\";\nimport type { OrganizationOptions } from \"./types\";\n\nexport const hasPermissionFn = (\n\tinput: HasPermissionBaseInput,\n\tacRoles: {\n\t\t[x: string]: Role<any> | undefined;\n\t},\n) => {\n\tif (!input.permissions && !input.permission) return false;\n\n\tconst roles = input.role.split(\",\");\n\tconst creatorRole = input.options.creatorRole || \"owner\";\n\tconst isCreator = roles.includes(creatorRole);\n\n\tconst allowCreatorsAllPermissions = input.allowCreatorAllPermissions || false;\n\tif (isCreator && allowCreatorsAllPermissions) return true;\n\n\tfor (const role of roles) {\n\t\tconst _role = acRoles[role as keyof typeof acRoles];\n\t\tconst result = _role?.authorize(input.permissions ?? input.permission);\n\t\tif (result?.success) {\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n};\n\nexport type PermissionExclusive =\n\t| {\n\t\t\t/**\n\t\t\t * @deprecated Use `permissions` instead\n\t\t\t */\n\t\t\tpermission: { [key: string]: string[] };\n\t\t\tpermissions?: never | undefined;\n\t  }\n\t| {\n\t\t\tpermissions: { [key: string]: string[] };\n\t\t\tpermission?: never | undefined;\n\t  };\n\nexport let cacheAllRoles = new Map<\n\tstring,\n\t{\n\t\t[x: string]: Role<any> | undefined;\n\t}\n>();\n\nexport type HasPermissionBaseInput = {\n\trole: string;\n\toptions: OrganizationOptions;\n\tallowCreatorAllPermissions?: boolean | undefined;\n} & PermissionExclusive;\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport * as z from \"zod\";\nimport { APIError } from \"../../api\";\nimport type { Role } from \"../access\";\nimport { defaultRoles } from \"./access\";\nimport type { HasPermissionBaseInput } from \"./permission\";\nimport { cacheAllRoles, hasPermissionFn } from \"./permission\";\nimport type { OrganizationRole } from \"./schema\";\n\nexport const hasPermission = async (\n\tinput: {\n\t\torganizationId: string;\n\t\t/**\n\t\t * If true, will use the in-memory cache of the roles.\n\t\t * Keep in mind to use this in a stateless mindset, the purpose of this is to avoid unnecessary database calls when running multiple\n\t\t * hasPermission calls in a row.\n\t\t *\n\t\t * @default false\n\t\t */\n\t\tuseMemoryCache?: boolean | undefined;\n\t} & HasPermissionBaseInput,\n\tctx: GenericEndpointContext,\n) => {\n\tlet acRoles: {\n\t\t[x: string]: Role<any> | undefined;\n\t} = { ...(input.options.roles || defaultRoles) };\n\n\tif (\n\t\tctx &&\n\t\tinput.organizationId &&\n\t\tinput.options.dynamicAccessControl?.enabled &&\n\t\tinput.options.ac &&\n\t\t!input.useMemoryCache\n\t) {\n\t\t// Load roles from database\n\t\tconst roles = await ctx.context.adapter.findMany<\n\t\t\tOrganizationRole & { permission: string }\n\t\t>({\n\t\t\tmodel: \"organizationRole\",\n\t\t\twhere: [\n\t\t\t\t{\n\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\tvalue: input.organizationId,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\tfor (const { role, permission: permissionsString } of roles) {\n\t\t\t// If it's for an existing role, skip as we shouldn't override hard-coded roles.\n\t\t\tif (role in acRoles) continue;\n\n\t\t\tconst result = z\n\t\t\t\t.record(z.string(), z.array(z.string()))\n\t\t\t\t.safeParse(JSON.parse(permissionsString));\n\n\t\t\tif (!result.success) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\"[hasPermission] Invalid permissions for role \" + role,\n\t\t\t\t\t{\n\t\t\t\t\t\tpermissions: JSON.parse(permissionsString),\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: \"Invalid permissions for role \" + role,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tacRoles[role] = input.options.ac.newRole(result.data);\n\t\t}\n\t}\n\n\tif (input.useMemoryCache) {\n\t\tacRoles = cacheAllRoles.get(input.organizationId) || acRoles;\n\t}\n\tcacheAllRoles.set(input.organizationId, acRoles);\n\n\treturn hasPermissionFn(input, acRoles);\n};\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport type { Where } from \"@better-auth/core/db/adapter\";\nimport * as z from \"zod\";\nimport { APIError } from \"../../../api\";\nimport type { InferAdditionalFieldsFromPluginOptions } from \"../../../db\";\nimport { toZodSchema } from \"../../../db\";\nimport type { User } from \"../../../types\";\nimport type { AccessControl } from \"../../access\";\nimport { orgSessionMiddleware } from \"../call\";\nimport { ORGANIZATION_ERROR_CODES } from \"../error-codes\";\nimport { hasPermission } from \"../has-permission\";\nimport type { Member, OrganizationRole } from \"../schema\";\nimport type { OrganizationOptions } from \"../types\";\n\ntype IsExactlyEmptyObject<T> = keyof T extends never // no keys\n\t? T extends {} // is assignable to {}\n\t\t? {} extends T\n\t\t\t? true\n\t\t\t: false // and {} is assignable to it\n\t\t: false\n\t: false;\n\nconst normalizeRoleName = (role: string) => role.toLowerCase();\nconst DEFAULT_MAXIMUM_ROLES_PER_ORGANIZATION = Number.POSITIVE_INFINITY;\n\nconst getAdditionalFields = <\n\tO extends OrganizationOptions,\n\tAllPartial extends boolean = false,\n>(\n\toptions: O,\n\tshouldBePartial: AllPartial = false as AllPartial,\n) => {\n\tlet additionalFields =\n\t\toptions?.schema?.organizationRole?.additionalFields || {};\n\tif (shouldBePartial) {\n\t\tfor (const key in additionalFields) {\n\t\t\tadditionalFields[key]!.required = false;\n\t\t}\n\t}\n\tconst additionalFieldsSchema = toZodSchema({\n\t\tfields: additionalFields,\n\t\tisClientSide: true,\n\t});\n\ttype AdditionalFields = AllPartial extends true\n\t\t? Partial<InferAdditionalFieldsFromPluginOptions<\"organizationRole\", O>>\n\t\t: InferAdditionalFieldsFromPluginOptions<\"organizationRole\", O>;\n\ttype ReturnAdditionalFields = InferAdditionalFieldsFromPluginOptions<\n\t\t\"organizationRole\",\n\t\tO,\n\t\tfalse\n\t>;\n\n\treturn {\n\t\tadditionalFieldsSchema,\n\t\t$AdditionalFields: {} as AdditionalFields,\n\t\t$ReturnAdditionalFields: {} as ReturnAdditionalFields,\n\t};\n};\n\nconst baseCreateOrgRoleSchema = z.object({\n\torganizationId: z.string().optional().meta({\n\t\tdescription:\n\t\t\t\"The id of the organization to create the role in. If not provided, the user's active organization will be used.\",\n\t}),\n\trole: z.string().meta({\n\t\tdescription: \"The name of the role to create\",\n\t}),\n\tpermission: z.record(z.string(), z.array(z.string())).meta({\n\t\tdescription: \"The permission to assign to the role\",\n\t}),\n});\n\nexport const createOrgRole = <O extends OrganizationOptions>(options: O) => {\n\tconst { additionalFieldsSchema, $AdditionalFields, $ReturnAdditionalFields } =\n\t\tgetAdditionalFields<O>(options, false);\n\ttype AdditionalFields = typeof $AdditionalFields;\n\ttype ReturnAdditionalFields = typeof $ReturnAdditionalFields;\n\n\treturn createAuthEndpoint(\n\t\t\"/organization/create-role\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: baseCreateOrgRoleSchema.safeExtend({\n\t\t\t\tadditionalFields: z\n\t\t\t\t\t.object({ ...additionalFieldsSchema.shape })\n\t\t\t\t\t.optional(),\n\t\t\t}),\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\torganizationId?: string | undefined;\n\t\t\t\t\t\trole: string;\n\t\t\t\t\t\tpermission: Record<string, string[]>;\n\t\t\t\t\t} & (IsExactlyEmptyObject<AdditionalFields> extends true\n\t\t\t\t\t\t? { additionalFields?: {} | undefined }\n\t\t\t\t\t\t: { additionalFields: AdditionalFields }),\n\t\t\t\t},\n\t\t\t},\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { session, user } = ctx.context.session;\n\t\t\tlet roleName = ctx.body.role;\n\t\t\tconst permission = ctx.body.permission;\n\t\t\tconst additionalFields = ctx.body.additionalFields;\n\n\t\t\tconst ac = options.ac;\n\t\t\tif (!ac) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The organization plugin is missing a pre-defined ac instance.`,\n\t\t\t\t\t`\\nPlease refer to the documentation here: https://better-auth.com/docs/plugins/organization#dynamic-access-control`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"NOT_IMPLEMENTED\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MISSING_AC_INSTANCE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Get the organization id where the role will be created.\n\t\t\t// We can verify if the org id is valid and associated with the user in the next step when we try to find the member.\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId ?? session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The session is missing an active organization id to create a role. Either set an active org id, or pass an organizationId in the request body.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_MUST_BE_IN_AN_ORGANIZATION_TO_CREATE_A_ROLE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\troleName = normalizeRoleName(roleName);\n\n\t\t\tawait checkIfRoleNameIsTakenByPreDefinedRole({\n\t\t\t\trole: roleName,\n\t\t\t\torganizationId,\n\t\t\t\toptions,\n\t\t\t\tctx,\n\t\t\t});\n\n\t\t\t// Get the user's role associated with the organization.\n\t\t\t// This also serves as a check to ensure the org id is valid.\n\t\t\tconst member = await ctx.context.adapter.findOne<Member>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not a member of the organization to create a role.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canCreateRole = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\toptions,\n\t\t\t\t\torganizationId,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tac: [\"create\"],\n\t\t\t\t\t},\n\t\t\t\t\trole: member.role,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (!canCreateRole) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not permitted to create a role. If this is unexpected, please make sure the role associated to that member has the \"ac\" resource with the \"create\" permission.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CREATE_A_ROLE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst maximumRolesPerOrganization =\n\t\t\t\ttypeof options.dynamicAccessControl?.maximumRolesPerOrganization ===\n\t\t\t\t\"function\"\n\t\t\t\t\t? await options.dynamicAccessControl.maximumRolesPerOrganization(\n\t\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\t)\n\t\t\t\t\t: (options.dynamicAccessControl?.maximumRolesPerOrganization ??\n\t\t\t\t\t\tDEFAULT_MAXIMUM_ROLES_PER_ORGANIZATION);\n\t\t\tconst rolesInDB = await ctx.context.adapter.count({\n\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (rolesInDB >= maximumRolesPerOrganization) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] Failed to create a new role, the organization has too many roles. Maximum allowed roles is ${maximumRolesPerOrganization}.`,\n\t\t\t\t\t{\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\tmaximumRolesPerOrganization,\n\t\t\t\t\t\trolesInDB,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TOO_MANY_ROLES,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait checkForInvalidResources({ ac, ctx, permission });\n\n\t\t\tawait checkIfMemberHasPermission({\n\t\t\t\tctx,\n\t\t\t\tmember,\n\t\t\t\toptions,\n\t\t\t\torganizationId,\n\t\t\t\tpermissionRequired: permission,\n\t\t\t\tuser,\n\t\t\t\taction: \"create\",\n\t\t\t});\n\n\t\t\tawait checkIfRoleNameIsTakenByRoleInDB({\n\t\t\t\tctx,\n\t\t\t\torganizationId,\n\t\t\t\trole: roleName,\n\t\t\t});\n\n\t\t\tconst newRole = ac.newRole(permission);\n\n\t\t\tconst newRoleInDB = await ctx.context.adapter.create<\n\t\t\t\tOmit<OrganizationRole, \"permission\"> & { permission: string }\n\t\t\t>({\n\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\tdata: {\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\torganizationId,\n\t\t\t\t\tpermission: JSON.stringify(permission),\n\t\t\t\t\trole: roleName,\n\t\t\t\t\t...additionalFields,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tconst data = {\n\t\t\t\t...newRoleInDB,\n\t\t\t\tpermission,\n\t\t\t} as OrganizationRole & ReturnAdditionalFields;\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t\troleData: data,\n\t\t\t\tstatements: newRole.statements,\n\t\t\t});\n\t\t},\n\t);\n};\n\nconst deleteOrgRoleBodySchema = z\n\t.object({\n\t\torganizationId: z.string().optional().meta({\n\t\t\tdescription:\n\t\t\t\t\"The id of the organization to create the role in. If not provided, the user's active organization will be used.\",\n\t\t}),\n\t})\n\t.and(\n\t\tz.union([\n\t\t\tz.object({\n\t\t\t\troleName: z.string().nonempty().meta({\n\t\t\t\t\tdescription: \"The name of the role to delete\",\n\t\t\t\t}),\n\t\t\t}),\n\t\t\tz.object({\n\t\t\t\troleId: z.string().nonempty().meta({\n\t\t\t\t\tdescription: \"The id of the role to delete\",\n\t\t\t\t}),\n\t\t\t}),\n\t\t]),\n\t);\n\nexport const deleteOrgRole = <O extends OrganizationOptions>(options: O) => {\n\treturn createAuthEndpoint(\n\t\t\"/organization/delete-role\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: deleteOrgRoleBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgSessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\troleName?: string | undefined;\n\t\t\t\t\t\troleId?: string | undefined;\n\t\t\t\t\t\torganizationId?: string | undefined;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { session, user } = ctx.context.session;\n\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId ?? session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The session is missing an active organization id to delete a role. Either set an active org id, or pass an organizationId in the request body.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst member = await ctx.context.adapter.findOne<Member>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not a member of the organization to delete a role.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canDeleteRole = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\toptions,\n\t\t\t\t\torganizationId,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tac: [\"delete\"],\n\t\t\t\t\t},\n\t\t\t\t\trole: member.role,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (!canDeleteRole) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not permitted to delete a role. If this is unexpected, please make sure the role associated to that member has the \"ac\" resource with the \"delete\" permission.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_DELETE_A_ROLE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (ctx.body.roleName) {\n\t\t\t\tconst roleName = ctx.body.roleName;\n\t\t\t\tconst defaultRoles = options.roles\n\t\t\t\t\t? Object.keys(options.roles)\n\t\t\t\t\t: [\"owner\", \"admin\", \"member\"];\n\t\t\t\tif (defaultRoles.includes(roleName)) {\n\t\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\t`[Dynamic Access Control] Cannot delete a pre-defined role.`,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\troleName,\n\t\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\t\tdefaultRoles,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.CANNOT_DELETE_A_PRE_DEFINED_ROLE,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet condition: Where;\n\t\t\tif (ctx.body.roleName) {\n\t\t\t\tcondition = {\n\t\t\t\t\tfield: \"role\",\n\t\t\t\t\tvalue: ctx.body.roleName,\n\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t};\n\t\t\t} else if (ctx.body.roleId) {\n\t\t\t\tcondition = {\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: ctx.body.roleId,\n\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\t// shouldn't be able to reach here given the schema validation.\n\t\t\t\t// But just in case, throw an error.\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The role name/id is not provided in the request body.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ROLE_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst existingRoleInDB =\n\t\t\t\tawait ctx.context.adapter.findOne<OrganizationRole>({\n\t\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcondition,\n\t\t\t\t\t],\n\t\t\t\t});\n\t\t\tif (!existingRoleInDB) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The role name/id does not exist in the database.`,\n\t\t\t\t\t{\n\t\t\t\t\t\t...(\"roleName\" in ctx.body\n\t\t\t\t\t\t\t? { roleName: ctx.body.roleName }\n\t\t\t\t\t\t\t: { roleId: ctx.body.roleId }),\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ROLE_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\texistingRoleInDB.permission = JSON.parse(\n\t\t\t\texistingRoleInDB.permission as never as string,\n\t\t\t);\n\n\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\tcondition,\n\t\t\t\t],\n\t\t\t});\n\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t});\n\t\t},\n\t);\n};\n\nconst listOrgRolesQuerySchema = z\n\t.object({\n\t\torganizationId: z.string().optional().meta({\n\t\t\tdescription:\n\t\t\t\t\"The id of the organization to list roles for. If not provided, the user's active organization will be used.\",\n\t\t}),\n\t})\n\t.optional();\n\nexport const listOrgRoles = <O extends OrganizationOptions>(options: O) => {\n\tconst { $ReturnAdditionalFields } = getAdditionalFields<O>(options, false);\n\ttype ReturnAdditionalFields = typeof $ReturnAdditionalFields;\n\n\treturn createAuthEndpoint(\n\t\t\"/organization/list-roles\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgSessionMiddleware],\n\t\t\tquery: listOrgRolesQuerySchema,\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { session, user } = ctx.context.session;\n\n\t\t\tconst organizationId =\n\t\t\t\tctx.query?.organizationId ?? session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The session is missing an active organization id to list roles. Either set an active org id, or pass an organizationId in the request query.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst member = await ctx.context.adapter.findOne<Member>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not a member of the organization to list roles.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canListRoles = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\toptions,\n\t\t\t\t\torganizationId,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tac: [\"read\"],\n\t\t\t\t\t},\n\t\t\t\t\trole: member.role,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (!canListRoles) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not permitted to list roles.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_LIST_A_ROLE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet roles = await ctx.context.adapter.findMany<\n\t\t\t\tOrganizationRole & ReturnAdditionalFields\n\t\t\t>({\n\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\troles = roles.map((x) => ({\n\t\t\t\t...x,\n\t\t\t\tpermission: JSON.parse(x.permission as never as string),\n\t\t\t}));\n\n\t\t\treturn ctx.json(roles);\n\t\t},\n\t);\n};\n\nconst getOrgRoleQuerySchema = z\n\t.object({\n\t\torganizationId: z.string().optional().meta({\n\t\t\tdescription:\n\t\t\t\t\"The id of the organization to read a role for. If not provided, the user's active organization will be used.\",\n\t\t}),\n\t})\n\t.and(\n\t\tz.union([\n\t\t\tz.object({\n\t\t\t\troleName: z.string().nonempty().meta({\n\t\t\t\t\tdescription: \"The name of the role to read\",\n\t\t\t\t}),\n\t\t\t}),\n\t\t\tz.object({\n\t\t\t\troleId: z.string().nonempty().meta({\n\t\t\t\t\tdescription: \"The id of the role to read\",\n\t\t\t\t}),\n\t\t\t}),\n\t\t]),\n\t)\n\t.optional();\n\nexport const getOrgRole = <O extends OrganizationOptions>(options: O) => {\n\tconst { $ReturnAdditionalFields } = getAdditionalFields<O>(options, false);\n\ttype ReturnAdditionalFields = typeof $ReturnAdditionalFields;\n\treturn createAuthEndpoint(\n\t\t\"/organization/get-role\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgSessionMiddleware],\n\t\t\tquery: getOrgRoleQuerySchema,\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tquery: {} as {\n\t\t\t\t\t\torganizationId?: string | undefined;\n\t\t\t\t\t\troleName?: string | undefined;\n\t\t\t\t\t\troleId?: string | undefined;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { session, user } = ctx.context.session;\n\n\t\t\tconst organizationId =\n\t\t\t\tctx.query?.organizationId ?? session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The session is missing an active organization id to read a role. Either set an active org id, or pass an organizationId in the request query.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst member = await ctx.context.adapter.findOne<Member>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not a member of the organization to read a role.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canListRoles = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\toptions,\n\t\t\t\t\torganizationId,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tac: [\"read\"],\n\t\t\t\t\t},\n\t\t\t\t\trole: member.role,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (!canListRoles) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not permitted to read a role.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_READ_A_ROLE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet condition: Where;\n\t\t\tif (ctx.query.roleName) {\n\t\t\t\tcondition = {\n\t\t\t\t\tfield: \"role\",\n\t\t\t\t\tvalue: ctx.query.roleName,\n\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t};\n\t\t\t} else if (ctx.query.roleId) {\n\t\t\t\tcondition = {\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: ctx.query.roleId,\n\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\t// shouldn't be able to reach here given the schema validation.\n\t\t\t\t// But just in case, throw an error.\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The role name/id is not provided in the request query.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ROLE_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tlet role = await ctx.context.adapter.findOne<OrganizationRole>({\n\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\tcondition,\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!role) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The role name/id does not exist in the database.`,\n\t\t\t\t\t{\n\t\t\t\t\t\t...(\"roleName\" in ctx.query\n\t\t\t\t\t\t\t? { roleName: ctx.query.roleName }\n\t\t\t\t\t\t\t: { roleId: ctx.query.roleId }),\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ROLE_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\trole.permission = JSON.parse(role.permission as never as string);\n\n\t\t\treturn ctx.json(role as OrganizationRole & ReturnAdditionalFields);\n\t\t},\n\t);\n};\n\nconst roleNameOrIdSchema = z.union([\n\tz.object({\n\t\troleName: z.string().nonempty().meta({\n\t\t\tdescription: \"The name of the role to update\",\n\t\t}),\n\t}),\n\tz.object({\n\t\troleId: z.string().nonempty().meta({\n\t\t\tdescription: \"The id of the role to update\",\n\t\t}),\n\t}),\n]);\n\nexport const updateOrgRole = <O extends OrganizationOptions>(options: O) => {\n\tconst { additionalFieldsSchema, $AdditionalFields, $ReturnAdditionalFields } =\n\t\tgetAdditionalFields<O, true>(options, true);\n\ttype AdditionalFields = typeof $AdditionalFields;\n\ttype ReturnAdditionalFields = typeof $ReturnAdditionalFields;\n\n\treturn createAuthEndpoint(\n\t\t\"/organization/update-role\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: z\n\t\t\t\t.object({\n\t\t\t\t\torganizationId: z.string().optional().meta({\n\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\"The id of the organization to update the role in. If not provided, the user's active organization will be used.\",\n\t\t\t\t\t}),\n\t\t\t\t\tdata: z.object({\n\t\t\t\t\t\tpermission: z\n\t\t\t\t\t\t\t.record(z.string(), z.array(z.string()))\n\t\t\t\t\t\t\t.optional()\n\t\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\t\tdescription: \"The permission to update the role with\",\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\troleName: z.string().optional().meta({\n\t\t\t\t\t\t\tdescription: \"The name of the role to update\",\n\t\t\t\t\t\t}),\n\t\t\t\t\t\t...additionalFieldsSchema.shape,\n\t\t\t\t\t}),\n\t\t\t\t})\n\t\t\t\t.and(roleNameOrIdSchema),\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\torganizationId?: string | undefined;\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tpermission?: Record<string, string[]> | undefined;\n\t\t\t\t\t\t\troleName?: string | undefined;\n\t\t\t\t\t\t} & AdditionalFields;\n\t\t\t\t\t\troleName?: string | undefined;\n\t\t\t\t\t\troleId?: string | undefined;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { session, user } = ctx.context.session;\n\n\t\t\tconst ac = options.ac;\n\t\t\tif (!ac) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The organization plugin is missing a pre-defined ac instance.`,\n\t\t\t\t\t`\\nPlease refer to the documentation here: https://better-auth.com/docs/plugins/organization#dynamic-access-control`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"NOT_IMPLEMENTED\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MISSING_AC_INSTANCE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId ?? session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The session is missing an active organization id to update a role. Either set an active org id, or pass an organizationId in the request body.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst member = await ctx.context.adapter.findOne<Member>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not a member of the organization to update a role.`,\n\t\t\t\t\t{\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canUpdateRole = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\toptions,\n\t\t\t\t\torganizationId,\n\t\t\t\t\trole: member.role,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tac: [\"update\"],\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (!canUpdateRole) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The user is not permitted to update a role.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_A_ROLE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet condition: Where;\n\t\t\tif (ctx.body.roleName) {\n\t\t\t\tcondition = {\n\t\t\t\t\tfield: \"role\",\n\t\t\t\t\tvalue: ctx.body.roleName,\n\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t};\n\t\t\t} else if (ctx.body.roleId) {\n\t\t\t\tcondition = {\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: ctx.body.roleId,\n\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\t// shouldn't be able to reach here given the schema validation.\n\t\t\t\t// But just in case, throw an error.\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The role name/id is not provided in the request body.`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ROLE_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tlet role = await ctx.context.adapter.findOne<OrganizationRole>({\n\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\tcondition,\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!role) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t`[Dynamic Access Control] The role name/id does not exist in the database.`,\n\t\t\t\t\t{\n\t\t\t\t\t\t...(\"roleName\" in ctx.body\n\t\t\t\t\t\t\t? { roleName: ctx.body.roleName }\n\t\t\t\t\t\t\t: { roleId: ctx.body.roleId }),\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ROLE_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\trole.permission = role.permission\n\t\t\t\t? JSON.parse(role.permission as never as string)\n\t\t\t\t: undefined;\n\n\t\t\tconst {\n\t\t\t\tpermission: _,\n\t\t\t\troleName: __,\n\t\t\t\t...additionalFields\n\t\t\t} = ctx.body.data;\n\n\t\t\tlet updateData: Partial<OrganizationRole> = {\n\t\t\t\t...additionalFields,\n\t\t\t};\n\n\t\t\tif (ctx.body.data.permission) {\n\t\t\t\tlet newPermission = ctx.body.data.permission;\n\n\t\t\t\tawait checkForInvalidResources({ ac, ctx, permission: newPermission });\n\n\t\t\t\tawait checkIfMemberHasPermission({\n\t\t\t\t\tctx,\n\t\t\t\t\tmember,\n\t\t\t\t\toptions,\n\t\t\t\t\torganizationId,\n\t\t\t\t\tpermissionRequired: newPermission,\n\t\t\t\t\tuser,\n\t\t\t\t\taction: \"update\",\n\t\t\t\t});\n\n\t\t\t\tupdateData.permission = newPermission;\n\t\t\t}\n\t\t\tif (ctx.body.data.roleName) {\n\t\t\t\tlet newRoleName = ctx.body.data.roleName;\n\n\t\t\t\tnewRoleName = normalizeRoleName(newRoleName);\n\n\t\t\t\tawait checkIfRoleNameIsTakenByPreDefinedRole({\n\t\t\t\t\trole: newRoleName,\n\t\t\t\t\torganizationId,\n\t\t\t\t\toptions,\n\t\t\t\t\tctx,\n\t\t\t\t});\n\t\t\t\tawait checkIfRoleNameIsTakenByRoleInDB({\n\t\t\t\t\trole: newRoleName,\n\t\t\t\t\torganizationId,\n\t\t\t\t\tctx,\n\t\t\t\t});\n\n\t\t\t\tupdateData.role = newRoleName;\n\t\t\t}\n\n\t\t\t// -----\n\t\t\t// Apply the updates\n\t\t\tconst update = {\n\t\t\t\t...updateData,\n\t\t\t\t...(updateData.permission\n\t\t\t\t\t? { permission: JSON.stringify(updateData.permission) }\n\t\t\t\t\t: {}),\n\t\t\t};\n\t\t\tawait ctx.context.adapter.update<OrganizationRole>({\n\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\tconnector: \"AND\",\n\t\t\t\t\t},\n\t\t\t\t\tcondition,\n\t\t\t\t],\n\t\t\t\tupdate,\n\t\t\t});\n\n\t\t\t// -----\n\t\t\t// Return the updated role\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t\troleData: {\n\t\t\t\t\t...role,\n\t\t\t\t\t...update,\n\t\t\t\t\tpermission: updateData.permission || role.permission || null,\n\t\t\t\t} as OrganizationRole & ReturnAdditionalFields,\n\t\t\t});\n\t\t},\n\t);\n};\n\nasync function checkForInvalidResources({\n\tac,\n\tctx,\n\tpermission,\n}: {\n\tac: AccessControl;\n\tctx: GenericEndpointContext;\n\tpermission: Record<string, string[]>;\n}) {\n\tconst validResources = Object.keys(ac.statements);\n\tconst providedResources = Object.keys(permission);\n\tconst hasInvalidResource = providedResources.some(\n\t\t(r) => !validResources.includes(r),\n\t);\n\tif (hasInvalidResource) {\n\t\tctx.context.logger.error(\n\t\t\t`[Dynamic Access Control] The provided permission includes an invalid resource.`,\n\t\t\t{\n\t\t\t\tprovidedResources,\n\t\t\t\tvalidResources,\n\t\t\t},\n\t\t);\n\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\tmessage: ORGANIZATION_ERROR_CODES.INVALID_RESOURCE,\n\t\t});\n\t}\n}\n\nasync function checkIfMemberHasPermission({\n\tctx,\n\tpermissionRequired: permission,\n\toptions,\n\torganizationId,\n\tmember,\n\tuser,\n\taction,\n}: {\n\tctx: GenericEndpointContext;\n\tpermissionRequired: Record<string, string[]>;\n\toptions: OrganizationOptions;\n\torganizationId: string;\n\tmember: Member;\n\tuser: User;\n\taction: \"create\" | \"update\" | \"delete\" | \"read\" | \"list\" | \"get\";\n}) {\n\tconst hasNecessaryPermissions: {\n\t\tresource: { [x: string]: string[] };\n\t\thasPermission: boolean;\n\t}[] = [];\n\tconst permissionEntries = Object.entries(permission);\n\tfor await (const [resource, permissions] of permissionEntries) {\n\t\tfor await (const perm of permissions) {\n\t\t\thasNecessaryPermissions.push({\n\t\t\t\tresource: { [resource]: [perm] },\n\t\t\t\thasPermission: await hasPermission(\n\t\t\t\t\t{\n\t\t\t\t\t\toptions,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\tpermissions: { [resource]: [perm] },\n\t\t\t\t\t\tuseMemoryCache: true,\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t),\n\t\t\t});\n\t\t}\n\t}\n\tconst missingPermissions = hasNecessaryPermissions\n\t\t.filter((x) => x.hasPermission === false)\n\t\t.map((x) => {\n\t\t\tconst key = Object.keys(x.resource)[0]!;\n\t\t\treturn `${key}:${x.resource[key]![0]}` as const;\n\t\t});\n\tif (missingPermissions.length > 0) {\n\t\tctx.context.logger.error(\n\t\t\t`[Dynamic Access Control] The user is missing permissions necessary to ${action} a role with those set of permissions.\\n`,\n\t\t\t{\n\t\t\t\tuserId: user.id,\n\t\t\t\torganizationId,\n\t\t\t\trole: member.role,\n\t\t\t\tmissingPermissions,\n\t\t\t},\n\t\t);\n\t\tlet errorMessage: string;\n\t\tif (action === \"create\")\n\t\t\terrorMessage =\n\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CREATE_A_ROLE;\n\t\telse if (action === \"update\")\n\t\t\terrorMessage =\n\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_A_ROLE;\n\t\telse if (action === \"delete\")\n\t\t\terrorMessage =\n\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_DELETE_A_ROLE;\n\t\telse if (action === \"read\")\n\t\t\terrorMessage =\n\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_READ_A_ROLE;\n\t\telse if (action === \"list\")\n\t\t\terrorMessage =\n\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_LIST_A_ROLE;\n\t\telse\n\t\t\terrorMessage = ORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_GET_A_ROLE;\n\n\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\tmessage: errorMessage,\n\t\t\tmissingPermissions,\n\t\t});\n\t}\n}\n\nasync function checkIfRoleNameIsTakenByPreDefinedRole({\n\toptions,\n\torganizationId,\n\trole,\n\tctx,\n}: {\n\toptions: OrganizationOptions;\n\torganizationId: string;\n\trole: string;\n\tctx: GenericEndpointContext;\n}) {\n\tconst defaultRoles = options.roles\n\t\t? Object.keys(options.roles)\n\t\t: [\"owner\", \"admin\", \"member\"];\n\tif (defaultRoles.includes(role)) {\n\t\tctx.context.logger.error(\n\t\t\t`[Dynamic Access Control] The role name \"${role}\" is already taken by a pre-defined role.`,\n\t\t\t{\n\t\t\t\trole,\n\t\t\t\torganizationId,\n\t\t\t\tdefaultRoles,\n\t\t\t},\n\t\t);\n\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\tmessage: ORGANIZATION_ERROR_CODES.ROLE_NAME_IS_ALREADY_TAKEN,\n\t\t});\n\t}\n}\n\nasync function checkIfRoleNameIsTakenByRoleInDB({\n\torganizationId,\n\trole,\n\tctx,\n}: {\n\tctx: GenericEndpointContext;\n\torganizationId: string;\n\trole: string;\n}) {\n\tconst existingRoleInDB = await ctx.context.adapter.findOne<OrganizationRole>({\n\t\tmodel: \"organizationRole\",\n\t\twhere: [\n\t\t\t{\n\t\t\t\tfield: \"organizationId\",\n\t\t\t\tvalue: organizationId,\n\t\t\t\toperator: \"eq\",\n\t\t\t\tconnector: \"AND\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tfield: \"role\",\n\t\t\t\tvalue: role,\n\t\t\t\toperator: \"eq\",\n\t\t\t\tconnector: \"AND\",\n\t\t\t},\n\t\t],\n\t});\n\tif (existingRoleInDB) {\n\t\tctx.context.logger.error(\n\t\t\t`[Dynamic Access Control] The role name \"${role}\" is already taken by a role in the database.`,\n\t\t\t{\n\t\t\t\trole,\n\t\t\t\torganizationId,\n\t\t\t},\n\t\t);\n\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\tmessage: ORGANIZATION_ERROR_CODES.ROLE_NAME_IS_ALREADY_TAKEN,\n\t\t});\n\t}\n}\n", "import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { getSessionFromCtx } from \"../../../api/routes\";\nimport { setSessionCookie } from \"../../../cookies\";\nimport type { InferAdditionalFieldsFromPluginOptions } from \"../../../db\";\nimport { toZodSchema } from \"../../../db\";\nimport { getDate } from \"../../../utils/date\";\nimport { defaultRoles } from \"../access/statement\";\nimport { getOrgAdapter } from \"../adapter\";\nimport { orgMiddleware, orgSessionMiddleware } from \"../call\";\nimport { ORGANIZATION_ERROR_CODES } from \"../error-codes\";\nimport { hasPermission } from \"../has-permission\";\nimport { parseRoles } from \"../organization\";\nimport type {\n\tInferInvitation,\n\tInferOrganizationRolesFromOption,\n\tInvitation,\n\tMember,\n} from \"../schema\";\nimport type { OrganizationOptions } from \"../types\";\n\nconst baseInvitationSchema = z.object({\n\temail: z.string().meta({\n\t\tdescription: \"The email address of the user to invite\",\n\t}),\n\trole: z\n\t\t.union([\n\t\t\tz.string().meta({\n\t\t\t\tdescription: \"The role to assign to the user\",\n\t\t\t}),\n\t\t\tz.array(\n\t\t\t\tz.string().meta({\n\t\t\t\t\tdescription: \"The roles to assign to the user\",\n\t\t\t\t}),\n\t\t\t),\n\t\t])\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The role(s) to assign to the user. It can be `admin`, `member`, owner. Eg: \"member\"',\n\t\t}),\n\torganizationId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The organization ID to invite the user to\",\n\t\t})\n\t\t.optional(),\n\tresend: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Resend the invitation email, if the user is already invited. Eg: true\",\n\t\t})\n\t\t.optional(),\n\tteamId: z.union([\n\t\tz\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription: \"The team ID to invite the user to\",\n\t\t\t})\n\t\t\t.optional(),\n\t\tz\n\t\t\t.array(z.string())\n\t\t\t.meta({\n\t\t\t\tdescription: \"The team IDs to invite the user to\",\n\t\t\t})\n\t\t\t.optional(),\n\t]),\n});\n\nexport const createInvitation = <O extends OrganizationOptions>(option: O) => {\n\tconst additionalFieldsSchema = toZodSchema({\n\t\tfields: option?.schema?.invitation?.additionalFields || {},\n\t\tisClientSide: true,\n\t});\n\n\treturn createAuthEndpoint(\n\t\t\"/organization/invite-member\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\tbody: z.object({\n\t\t\t\t...baseInvitationSchema.shape,\n\t\t\t\t...additionalFieldsSchema.shape,\n\t\t\t}),\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * The email address of the user\n\t\t\t\t\t\t * to invite\n\t\t\t\t\t\t */\n\t\t\t\t\t\temail: string;\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * The role to assign to the user\n\t\t\t\t\t\t */\n\t\t\t\t\t\trole:\n\t\t\t\t\t\t\t| InferOrganizationRolesFromOption<O>\n\t\t\t\t\t\t\t| InferOrganizationRolesFromOption<O>[];\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * The organization ID to invite\n\t\t\t\t\t\t * the user to\n\t\t\t\t\t\t */\n\t\t\t\t\t\torganizationId?: string | undefined;\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * Resend the invitation email, if\n\t\t\t\t\t\t * the user is already invited\n\t\t\t\t\t\t */\n\t\t\t\t\t\tresend?: boolean | undefined;\n\t\t\t\t\t} & (O extends { teams: { enabled: true } }\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t/**\n\t\t\t\t\t\t\t\t * The team the user is\n\t\t\t\t\t\t\t\t * being invited to.\n\t\t\t\t\t\t\t\t */\n\t\t\t\t\t\t\t\tteamId?: (string | string[]) | undefined;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: {}) &\n\t\t\t\t\t\tInferAdditionalFieldsFromPluginOptions<\"invitation\", O, false>,\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"createOrganizationInvitation\",\n\t\t\t\t\tdescription: \"Create an invitation to an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trole: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tinviterId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\"email\",\n\t\t\t\t\t\t\t\t\t\t\t\"role\",\n\t\t\t\t\t\t\t\t\t\t\t\"organizationId\",\n\t\t\t\t\t\t\t\t\t\t\t\"inviterId\",\n\t\t\t\t\t\t\t\t\t\t\t\"status\",\n\t\t\t\t\t\t\t\t\t\t\t\"expiresAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId || session.session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst email = ctx.body.email.toLowerCase();\n\t\t\tconst isValidEmail = z.email().safeParse(email);\n\t\t\tif (!isValidEmail.success) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, option as O);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst canInvite = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: member.role,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tinvitation: [\"create\"],\n\t\t\t\t\t},\n\t\t\t\t\torganizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!canInvite) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst creatorRole = ctx.context.orgOptions.creatorRole || \"owner\";\n\n\t\t\tconst roles = parseRoles(ctx.body.role);\n\n\t\t\tconst rolesArray = roles\n\t\t\t\t.split(\",\")\n\t\t\t\t.map((r) => r.trim())\n\t\t\t\t.filter(Boolean);\n\t\t\tconst defaults = Object.keys(defaultRoles);\n\t\t\tconst customRoles = Object.keys(ctx.context.orgOptions.roles || {});\n\t\t\tconst validStaticRoles = new Set([...defaults, ...customRoles]);\n\n\t\t\tconst unknownRoles = rolesArray.filter(\n\t\t\t\t(role) => !validStaticRoles.has(role),\n\t\t\t);\n\n\t\t\tif (unknownRoles.length > 0) {\n\t\t\t\tif (ctx.context.orgOptions.dynamicAccessControl?.enabled) {\n\t\t\t\t\tconst foundRoles = await ctx.context.adapter.findMany({\n\t\t\t\t\t\tmodel: \"organizationRole\",\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{ field: \"organizationId\", value: organizationId },\n\t\t\t\t\t\t\t{ field: \"role\", value: unknownRoles, operator: \"in\" },\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\tconst foundRoleNames = foundRoles.map((r: any) => r.role);\n\t\t\t\t\tconst stillInvalid = unknownRoles.filter(\n\t\t\t\t\t\t(r) => !foundRoleNames.includes(r),\n\t\t\t\t\t);\n\n\t\t\t\t\tif (stillInvalid.length > 0) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: `${ORGANIZATION_ERROR_CODES.ROLE_NOT_FOUND}: ${stillInvalid.join(\", \")}`,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: `${ORGANIZATION_ERROR_CODES.ROLE_NOT_FOUND}: ${unknownRoles.join(\", \")}`,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tmember.role !== creatorRole &&\n\t\t\t\troles.split(\",\").includes(creatorRole)\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_INVITE_USER_WITH_THIS_ROLE,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst alreadyMember = await adapter.findMemberByEmail({\n\t\t\t\temail: email,\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\t\t\tif (alreadyMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst alreadyInvited = await adapter.findPendingInvitation({\n\t\t\t\temail: email,\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\t\t\tif (alreadyInvited.length && !ctx.body.resend) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(organizationId);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// If resend is true and there's an existing invitation, reuse it\n\t\t\tif (alreadyInvited.length && ctx.body.resend) {\n\t\t\t\tconst existingInvitation = alreadyInvited[0];\n\n\t\t\t\t// Update the invitation's expiration date using the same logic as createInvitation\n\t\t\t\tconst defaultExpiration = 60 * 60 * 48; // 48 hours in seconds\n\t\t\t\tconst newExpiresAt = getDate(\n\t\t\t\t\tctx.context.orgOptions.invitationExpiresIn || defaultExpiration,\n\t\t\t\t\t\"sec\",\n\t\t\t\t);\n\n\t\t\t\tawait ctx.context.adapter.update({\n\t\t\t\t\tmodel: \"invitation\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\tvalue: existingInvitation!.id,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tupdate: {\n\t\t\t\t\t\texpiresAt: newExpiresAt,\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tconst updatedInvitation = {\n\t\t\t\t\t...existingInvitation,\n\t\t\t\t\texpiresAt: newExpiresAt,\n\t\t\t\t};\n\n\t\t\t\tif (ctx.context.orgOptions.sendInvitationEmail) {\n\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\tctx.context.orgOptions.sendInvitationEmail(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tid: updatedInvitation.id!,\n\t\t\t\t\t\t\t\trole: updatedInvitation.role! as string,\n\t\t\t\t\t\t\t\temail: updatedInvitation.email!.toLowerCase(),\n\t\t\t\t\t\t\t\torganization: organization,\n\t\t\t\t\t\t\t\tinviter: {\n\t\t\t\t\t\t\t\t\t...member,\n\t\t\t\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tinvitation: updatedInvitation as unknown as Invitation,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tctx.request,\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\treturn ctx.json(updatedInvitation as InferInvitation<O, false>);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\talreadyInvited.length &&\n\t\t\t\tctx.context.orgOptions.cancelPendingInvitationsOnReInvite\n\t\t\t) {\n\t\t\t\tawait adapter.updateInvitation({\n\t\t\t\t\tinvitationId: alreadyInvited[0]!.id,\n\t\t\t\t\tstatus: \"canceled\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst invitationLimit =\n\t\t\t\ttypeof ctx.context.orgOptions.invitationLimit === \"function\"\n\t\t\t\t\t? await ctx.context.orgOptions.invitationLimit(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t\t\t\torganization,\n\t\t\t\t\t\t\t\tmember: member as Member,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tctx.context,\n\t\t\t\t\t\t)\n\t\t\t\t\t: (ctx.context.orgOptions.invitationLimit ?? 100);\n\n\t\t\tconst pendingInvitations = await adapter.findPendingInvitations({\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\n\t\t\tif (pendingInvitations.length >= invitationLimit) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.INVITATION_LIMIT_REACHED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tctx.context.orgOptions.teams &&\n\t\t\t\tctx.context.orgOptions.teams.enabled &&\n\t\t\t\ttypeof ctx.context.orgOptions.teams.maximumMembersPerTeam !==\n\t\t\t\t\t\"undefined\" &&\n\t\t\t\t\"teamId\" in ctx.body &&\n\t\t\t\tctx.body.teamId\n\t\t\t) {\n\t\t\t\tconst teamIds =\n\t\t\t\t\ttypeof ctx.body.teamId === \"string\"\n\t\t\t\t\t\t? [ctx.body.teamId as string]\n\t\t\t\t\t\t: (ctx.body.teamId as string[]);\n\n\t\t\t\tfor (const teamId of teamIds) {\n\t\t\t\t\tconst team = await adapter.findTeamById({\n\t\t\t\t\t\tteamId,\n\t\t\t\t\t\torganizationId: organizationId,\n\t\t\t\t\t\tincludeTeamMembers: true,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!team) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_NOT_FOUND,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst maximumMembersPerTeam =\n\t\t\t\t\t\ttypeof ctx.context.orgOptions.teams.maximumMembersPerTeam ===\n\t\t\t\t\t\t\"function\"\n\t\t\t\t\t\t\t? await ctx.context.orgOptions.teams.maximumMembersPerTeam({\n\t\t\t\t\t\t\t\t\tteamId,\n\t\t\t\t\t\t\t\t\tsession: session,\n\t\t\t\t\t\t\t\t\torganizationId: organizationId,\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t: ctx.context.orgOptions.teams.maximumMembersPerTeam;\n\t\t\t\t\tif (team.members.length >= maximumMembersPerTeam) {\n\t\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_MEMBER_LIMIT_REACHED,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst teamIds: string[] =\n\t\t\t\t\"teamId\" in ctx.body\n\t\t\t\t\t? typeof ctx.body.teamId === \"string\"\n\t\t\t\t\t\t? [ctx.body.teamId as string]\n\t\t\t\t\t\t: ((ctx.body.teamId as string[]) ?? [])\n\t\t\t\t\t: [];\n\n\t\t\tconst {\n\t\t\t\temail: _,\n\t\t\t\trole: __,\n\t\t\t\torganizationId: ___,\n\t\t\t\tresend: ____,\n\t\t\t\t...additionalFields\n\t\t\t} = ctx.body;\n\n\t\t\tlet invitationData = {\n\t\t\t\trole: roles,\n\t\t\t\temail: email,\n\t\t\t\torganizationId: organizationId,\n\t\t\t\tteamIds,\n\t\t\t\t...(additionalFields ? additionalFields : {}),\n\t\t\t};\n\n\t\t\t// Run beforeCreateInvitation hook\n\t\t\tif (option?.organizationHooks?.beforeCreateInvitation) {\n\t\t\t\tconst response = await option?.organizationHooks.beforeCreateInvitation(\n\t\t\t\t\t{\n\t\t\t\t\t\tinvitation: {\n\t\t\t\t\t\t\t...invitationData,\n\t\t\t\t\t\t\tinviterId: session.user.id,\n\t\t\t\t\t\t\tteamId: teamIds.length > 0 ? teamIds[0] : undefined,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinviter: session.user,\n\t\t\t\t\t\torganization,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\tinvitationData = {\n\t\t\t\t\t\t...invitationData,\n\t\t\t\t\t\t...response.data,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst invitation = await adapter.createInvitation({\n\t\t\t\tinvitation: invitationData,\n\t\t\t\tuser: session.user,\n\t\t\t});\n\n\t\t\tif (ctx.context.orgOptions.sendInvitationEmail) {\n\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\tctx.context.orgOptions.sendInvitationEmail(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: invitation.id,\n\t\t\t\t\t\t\trole: invitation.role,\n\t\t\t\t\t\t\temail: invitation.email.toLowerCase(),\n\t\t\t\t\t\t\torganization: organization,\n\t\t\t\t\t\t\tinviter: {\n\t\t\t\t\t\t\t\t...(member as Member),\n\t\t\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tinvitation,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tctx.request,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Run afterCreateInvitation hook\n\t\t\tif (option?.organizationHooks?.afterCreateInvitation) {\n\t\t\t\tawait option?.organizationHooks.afterCreateInvitation({\n\t\t\t\t\tinvitation: invitation as unknown as Invitation,\n\t\t\t\t\tinviter: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json(invitation);\n\t\t},\n\t);\n};\n\nconst acceptInvitationBodySchema = z.object({\n\tinvitationId: z.string().meta({\n\t\tdescription: \"The ID of the invitation to accept\",\n\t}),\n});\n\nexport const acceptInvitation = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/accept-invitation\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: acceptInvitationBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Accept an invitation to an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tinvitation: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tmember: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst invitation = await adapter.findInvitationById(\n\t\t\t\tctx.body.invitationId,\n\t\t\t);\n\n\t\t\tif (\n\t\t\t\t!invitation ||\n\t\t\t\tinvitation.expiresAt < new Date() ||\n\t\t\t\tinvitation.status !== \"pending\"\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.INVITATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (invitation.email.toLowerCase() !== session.user.email.toLowerCase()) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tctx.context.orgOptions.requireEmailVerificationOnInvitation &&\n\t\t\t\t!session.user.emailVerified\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.EMAIL_VERIFICATION_REQUIRED_BEFORE_ACCEPTING_OR_REJECTING_INVITATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst membershipLimit = ctx.context.orgOptions?.membershipLimit || 100;\n\t\t\tconst membersCount = await adapter.countMembers({\n\t\t\t\torganizationId: invitation.organizationId,\n\t\t\t});\n\n\t\t\tif (membersCount >= membershipLimit) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.ORGANIZATION_MEMBERSHIP_LIMIT_REACHED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(\n\t\t\t\tinvitation.organizationId,\n\t\t\t);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run beforeAcceptInvitation hook\n\t\t\tif (options?.organizationHooks?.beforeAcceptInvitation) {\n\t\t\t\tawait options?.organizationHooks.beforeAcceptInvitation({\n\t\t\t\t\tinvitation: invitation as unknown as Invitation,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst acceptedI = await adapter.updateInvitation({\n\t\t\t\tinvitationId: ctx.body.invitationId,\n\t\t\t\tstatus: \"accepted\",\n\t\t\t});\n\t\t\tif (!acceptedI) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.FAILED_TO_RETRIEVE_INVITATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (\n\t\t\t\tctx.context.orgOptions.teams &&\n\t\t\t\tctx.context.orgOptions.teams.enabled &&\n\t\t\t\t\"teamId\" in acceptedI &&\n\t\t\t\tacceptedI.teamId\n\t\t\t) {\n\t\t\t\tconst teamIds = (acceptedI.teamId as string).split(\",\");\n\t\t\t\tconst onlyOne = teamIds.length === 1;\n\n\t\t\t\tfor (const teamId of teamIds) {\n\t\t\t\t\tawait adapter.findOrCreateTeamMember({\n\t\t\t\t\t\tteamId: teamId,\n\t\t\t\t\t\tuserId: session.user.id,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (\n\t\t\t\t\t\ttypeof ctx.context.orgOptions.teams.maximumMembersPerTeam !==\n\t\t\t\t\t\t\"undefined\"\n\t\t\t\t\t) {\n\t\t\t\t\t\tconst members = await adapter.countTeamMembers({ teamId });\n\n\t\t\t\t\t\tconst maximumMembersPerTeam =\n\t\t\t\t\t\t\ttypeof ctx.context.orgOptions.teams.maximumMembersPerTeam ===\n\t\t\t\t\t\t\t\"function\"\n\t\t\t\t\t\t\t\t? await ctx.context.orgOptions.teams.maximumMembersPerTeam({\n\t\t\t\t\t\t\t\t\t\tteamId,\n\t\t\t\t\t\t\t\t\t\tsession: session,\n\t\t\t\t\t\t\t\t\t\torganizationId: invitation.organizationId,\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t: ctx.context.orgOptions.teams.maximumMembersPerTeam;\n\n\t\t\t\t\t\tif (members >= maximumMembersPerTeam) {\n\t\t\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_MEMBER_LIMIT_REACHED,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (onlyOne) {\n\t\t\t\t\tconst teamId = teamIds[0]!;\n\t\t\t\t\tconst updatedSession = await adapter.setActiveTeam(\n\t\t\t\t\t\tsession.session.token,\n\t\t\t\t\t\tteamId,\n\t\t\t\t\t\tctx,\n\t\t\t\t\t);\n\n\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\tsession: updatedSession,\n\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst member = await adapter.createMember({\n\t\t\t\torganizationId: invitation.organizationId,\n\t\t\t\tuserId: session.user.id,\n\t\t\t\trole: invitation.role,\n\t\t\t\tcreatedAt: new Date(),\n\t\t\t});\n\n\t\t\tawait adapter.setActiveOrganization(\n\t\t\t\tsession.session.token,\n\t\t\t\tinvitation.organizationId,\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (!acceptedI) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\tbody: {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.INVITATION_NOT_FOUND,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (options?.organizationHooks?.afterAcceptInvitation) {\n\t\t\t\tawait options?.organizationHooks.afterAcceptInvitation({\n\t\t\t\t\tinvitation: acceptedI as unknown as Invitation,\n\t\t\t\t\tmember,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\tinvitation: acceptedI,\n\t\t\t\tmember,\n\t\t\t});\n\t\t},\n\t);\n\nconst rejectInvitationBodySchema = z.object({\n\tinvitationId: z.string().meta({\n\t\tdescription: \"The ID of the invitation to reject\",\n\t}),\n});\n\nexport const rejectInvitation = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/reject-invitation\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: rejectInvitationBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Reject an invitation to an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tinvitation: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tmember: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst adapter = getOrgAdapter(ctx.context, ctx.context.orgOptions);\n\t\t\tconst invitation = await adapter.findInvitationById(\n\t\t\t\tctx.body.invitationId,\n\t\t\t);\n\t\t\tif (\n\t\t\t\t!invitation ||\n\t\t\t\tinvitation.expiresAt < new Date() ||\n\t\t\t\tinvitation.status !== \"pending\"\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"Invitation not found!\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (invitation.email.toLowerCase() !== session.user.email.toLowerCase()) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tctx.context.orgOptions.requireEmailVerificationOnInvitation &&\n\t\t\t\t!session.user.emailVerified\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.EMAIL_VERIFICATION_REQUIRED_BEFORE_ACCEPTING_OR_REJECTING_INVITATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(\n\t\t\t\tinvitation.organizationId,\n\t\t\t);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run beforeRejectInvitation hook\n\t\t\tif (options?.organizationHooks?.beforeRejectInvitation) {\n\t\t\t\tawait options?.organizationHooks.beforeRejectInvitation({\n\t\t\t\t\tinvitation: invitation as unknown as Invitation,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst rejectedI = await adapter.updateInvitation({\n\t\t\t\tinvitationId: ctx.body.invitationId,\n\t\t\t\tstatus: \"rejected\",\n\t\t\t});\n\n\t\t\t// Run afterRejectInvitation hook\n\t\t\tif (options?.organizationHooks?.afterRejectInvitation) {\n\t\t\t\tawait options?.organizationHooks.afterRejectInvitation({\n\t\t\t\t\tinvitation: rejectedI || (invitation as unknown as Invitation),\n\t\t\t\t\tuser: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\tinvitation: rejectedI,\n\t\t\t\tmember: null,\n\t\t\t});\n\t\t},\n\t);\n\nconst cancelInvitationBodySchema = z.object({\n\tinvitationId: z.string().meta({\n\t\tdescription: \"The ID of the invitation to cancel\",\n\t}),\n});\n\nexport const cancelInvitation = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/cancel-invitation\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: cancelInvitationBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\topenapi: {\n\t\t\t\toperationId: \"cancelOrganizationInvitation\",\n\t\t\t\tdescription: \"Cancel an invitation to an organization\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tinvitation: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst invitation = await adapter.findInvitationById(\n\t\t\t\tctx.body.invitationId,\n\t\t\t);\n\t\t\tif (!invitation) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.INVITATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: invitation.organizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst canCancel = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: member.role,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tinvitation: [\"cancel\"],\n\t\t\t\t\t},\n\t\t\t\t\torganizationId: invitation.organizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!canCancel) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(\n\t\t\t\tinvitation.organizationId,\n\t\t\t);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run beforeCancelInvitation hook\n\t\t\tif (options?.organizationHooks?.beforeCancelInvitation) {\n\t\t\t\tawait options?.organizationHooks.beforeCancelInvitation({\n\t\t\t\t\tinvitation: invitation as unknown as Invitation,\n\t\t\t\t\tcancelledBy: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canceledI = await adapter.updateInvitation({\n\t\t\t\tinvitationId: ctx.body.invitationId,\n\t\t\t\tstatus: \"canceled\",\n\t\t\t});\n\n\t\t\t// Run afterCancelInvitation hook\n\t\t\tif (options?.organizationHooks?.afterCancelInvitation) {\n\t\t\t\tawait options?.organizationHooks.afterCancelInvitation({\n\t\t\t\t\tinvitation: (canceledI as unknown as Invitation) || invitation,\n\t\t\t\t\tcancelledBy: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json(canceledI);\n\t\t},\n\t);\n\nconst getInvitationQuerySchema = z.object({\n\tid: z.string().meta({\n\t\tdescription: \"The ID of the invitation to get\",\n\t}),\n});\n\nexport const getInvitation = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/get-invitation\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tuse: [orgMiddleware],\n\t\t\trequireHeaders: true,\n\t\t\tquery: getInvitationQuerySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Get an invitation by ID\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trole: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tinviterId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\torganizationName: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\torganizationSlug: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tinviterEmail: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\"email\",\n\t\t\t\t\t\t\t\t\t\t\t\"role\",\n\t\t\t\t\t\t\t\t\t\t\t\"organizationId\",\n\t\t\t\t\t\t\t\t\t\t\t\"inviterId\",\n\t\t\t\t\t\t\t\t\t\t\t\"status\",\n\t\t\t\t\t\t\t\t\t\t\t\"expiresAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"organizationName\",\n\t\t\t\t\t\t\t\t\t\t\t\"organizationSlug\",\n\t\t\t\t\t\t\t\t\t\t\t\"inviterEmail\",\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\tif (!session) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: \"Not authenticated\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst invitation = await adapter.findInvitationById(ctx.query.id);\n\t\t\tif (\n\t\t\t\t!invitation ||\n\t\t\t\tinvitation.status !== \"pending\" ||\n\t\t\t\tinvitation.expiresAt < new Date()\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"Invitation not found!\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (invitation.email.toLowerCase() !== session.user.email.toLowerCase()) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst organization = await adapter.findOrganizationById(\n\t\t\t\tinvitation.organizationId,\n\t\t\t);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: invitation.inviterId,\n\t\t\t\torganizationId: invitation.organizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\t...invitation,\n\t\t\t\torganizationName: organization.name,\n\t\t\t\torganizationSlug: organization.slug,\n\t\t\t\tinviterEmail: member.user.email,\n\t\t\t});\n\t\t},\n\t);\n\nconst listInvitationQuerySchema = z\n\t.object({\n\t\torganizationId: z\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription: \"The ID of the organization to list invitations for\",\n\t\t\t})\n\t\t\t.optional(),\n\t})\n\t.optional();\n\nexport const listInvitations = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/list-invitations\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\tquery: listInvitationQuerySchema,\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\tif (!session) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: \"Not authenticated\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst orgId =\n\t\t\t\tctx.query?.organizationId || session.session.activeOrganizationId;\n\t\t\tif (!orgId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"Organization ID is required\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst isMember = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: orgId,\n\t\t\t});\n\t\t\tif (!isMember) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: \"You are not a member of this organization\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst invitations = await adapter.listInvitations({\n\t\t\t\torganizationId: orgId,\n\t\t\t});\n\t\t\treturn ctx.json(invitations);\n\t\t},\n\t);\n\n/**\n * List all invitations a user has received\n */\nexport const listUserInvitations = <O extends OrganizationOptions>(\n\toptions: O,\n) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/list-user-invitations\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tuse: [orgMiddleware],\n\t\t\tquery: z\n\t\t\t\t.object({\n\t\t\t\t\temail: z\n\t\t\t\t\t\t.string()\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"The email of the user to list invitations for. This only works for server side API calls.\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.optional(),\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"List all invitations a user has received\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trole: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\torganizationName: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tinviterId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The ID of the user who created the invitation\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tteamId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The ID of the team associated with the invitation\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"role\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"organizationId\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"organizationName\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"inviterId\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"status\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"expiresAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\n\t\t\tif (ctx.request && ctx.query?.email) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"User email cannot be passed for client side API calls.\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst userEmail = session?.user.email || ctx.query?.email;\n\t\t\tif (!userEmail) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"Missing session headers, or email query parameter.\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\n\t\t\tconst invitations = await adapter.listUserInvitations(userEmail);\n\t\t\treturn ctx.json(invitations);\n\t\t},\n\t);\n", "import type { LiteralString } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { getSessionFromCtx, sessionMiddleware } from \"../../../api\";\nimport type { InferAdditionalFieldsFromPluginOptions } from \"../../../db\";\nimport { toZodSchema } from \"../../../db/to-zod\";\nimport { getOrgAdapter } from \"../adapter\";\nimport { orgMiddleware, orgSessionMiddleware } from \"../call\";\nimport { ORGANIZATION_ERROR_CODES } from \"../error-codes\";\nimport { hasPermission } from \"../has-permission\";\nimport { parseRoles } from \"../organization\";\nimport type {\n\tInferMember,\n\tInferOrganizationRolesFromOption,\n\tMember,\n} from \"../schema\";\nimport type { OrganizationOptions } from \"../types\";\n\nconst baseMemberSchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription:\n\t\t\t'The user Id which represents the user to be added as a member. If `null` is provided, then it\\'s expected to provide session headers. Eg: \"user-id\"',\n\t}),\n\trole: z.union([z.string(), z.array(z.string())]).meta({\n\t\tdescription:\n\t\t\t'The role(s) to assign to the new member. Eg: [\"admin\", \"sale\"]',\n\t}),\n\torganizationId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'An optional organization ID to pass. If not provided, will default to the user\\'s active organization. Eg: \"org-id\"',\n\t\t})\n\t\t.optional(),\n\tteamId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: 'An optional team ID to add the member to. Eg: \"team-id\"',\n\t\t})\n\t\t.optional(),\n});\n\nexport const addMember = <O extends OrganizationOptions>(option: O) => {\n\tconst additionalFieldsSchema = toZodSchema({\n\t\tfields: option?.schema?.member?.additionalFields || {},\n\t\tisClientSide: true,\n\t});\n\treturn createAuthEndpoint(\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: z.object({\n\t\t\t\t...baseMemberSchema.shape,\n\t\t\t\t...additionalFieldsSchema.shape,\n\t\t\t}),\n\t\t\tuse: [orgMiddleware],\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\tuserId: string;\n\t\t\t\t\t\trole:\n\t\t\t\t\t\t\t| InferOrganizationRolesFromOption<O>\n\t\t\t\t\t\t\t| InferOrganizationRolesFromOption<O>[];\n\t\t\t\t\t\torganizationId?: string | undefined;\n\t\t\t\t\t} & (O extends { teams: { enabled: true } }\n\t\t\t\t\t\t? { teamId?: string | undefined }\n\t\t\t\t\t\t: {}) &\n\t\t\t\t\t\tInferAdditionalFieldsFromPluginOptions<\"member\", O>,\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"addOrganizationMember\",\n\t\t\t\t\tdescription: \"Add a member to an organization\",\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.body.userId\n\t\t\t\t? await getSessionFromCtx<{\n\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\tactiveOrganizationId?: string | undefined;\n\t\t\t\t\t\t};\n\t\t\t\t\t}>(ctx).catch((e) => null)\n\t\t\t\t: null;\n\t\t\tconst orgId =\n\t\t\t\tctx.body.organizationId || session?.session.activeOrganizationId;\n\t\t\tif (!orgId) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\tbody: {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst teamId =\n\t\t\t\t\"teamId\" in ctx.body ? (ctx.body.teamId as string) : undefined;\n\t\t\tif (teamId && !ctx.context.orgOptions.teams?.enabled) {\n\t\t\t\tctx.context.logger.error(\"Teams are not enabled\");\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"Teams are not enabled\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, option);\n\n\t\t\tconst user = await ctx.context.internalAdapter.findUserById(\n\t\t\t\tctx.body.userId,\n\t\t\t);\n\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst alreadyMember = await adapter.findMemberByEmail({\n\t\t\t\temail: user.email,\n\t\t\t\torganizationId: orgId,\n\t\t\t});\n\n\t\t\tif (alreadyMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (teamId) {\n\t\t\t\tconst team = await adapter.findTeamById({\n\t\t\t\t\tteamId,\n\t\t\t\t\torganizationId: orgId,\n\t\t\t\t});\n\t\t\t\tif (!team || team.organizationId !== orgId) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst membershipLimit = ctx.context.orgOptions?.membershipLimit || 100;\n\t\t\tconst count = await adapter.countMembers({ organizationId: orgId });\n\n\t\t\tif (count >= membershipLimit) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.ORGANIZATION_MEMBERSHIP_LIMIT_REACHED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst {\n\t\t\t\trole: _,\n\t\t\t\tuserId: __,\n\t\t\t\torganizationId: ___,\n\t\t\t\t...additionalFields\n\t\t\t} = ctx.body;\n\n\t\t\tconst organization = await adapter.findOrganizationById(orgId);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet memberData = {\n\t\t\t\torganizationId: orgId,\n\t\t\t\tuserId: user.id,\n\t\t\t\trole: parseRoles(ctx.body.role),\n\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t...(additionalFields ? additionalFields : {}),\n\t\t\t};\n\n\t\t\t// Run beforeAddMember hook\n\t\t\tif (option?.organizationHooks?.beforeAddMember) {\n\t\t\t\tconst response = await option?.organizationHooks.beforeAddMember({\n\t\t\t\t\tmember: {\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId: orgId,\n\t\t\t\t\t\trole: parseRoles(ctx.body.role as string | string[]),\n\t\t\t\t\t\t...additionalFields,\n\t\t\t\t\t},\n\t\t\t\t\tuser,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\tmemberData = {\n\t\t\t\t\t\t...memberData,\n\t\t\t\t\t\t...response.data,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst createdMember = await adapter.createMember(memberData);\n\n\t\t\tif (teamId) {\n\t\t\t\tawait adapter.findOrCreateTeamMember({\n\t\t\t\t\tuserId: user.id,\n\t\t\t\t\tteamId,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run afterAddMember hook\n\t\t\tif (option?.organizationHooks?.afterAddMember) {\n\t\t\t\tawait option?.organizationHooks.afterAddMember({\n\t\t\t\t\tmember: createdMember,\n\t\t\t\t\tuser,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json(createdMember);\n\t\t},\n\t);\n};\n\nconst removeMemberBodySchema = z.object({\n\tmemberIdOrEmail: z.string().meta({\n\t\tdescription: \"The ID or email of the member to remove\",\n\t}),\n\t/**\n\t * If not provided, the active organization will be used\n\t */\n\torganizationId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The ID of the organization to remove the member from. If not provided, the active organization will be used. Eg: \"org-id\"',\n\t\t})\n\t\t.optional(),\n});\n\nexport const removeMember = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/remove-member\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: removeMemberBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Remove a member from an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tmember: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\trole: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"id\", \"userId\", \"organizationId\", \"role\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"member\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId || session.session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\tbody: {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tlet toBeRemovedMember: InferMember<O, false> | null = null;\n\t\t\tif (ctx.body.memberIdOrEmail.includes(\"@\")) {\n\t\t\t\ttoBeRemovedMember = await adapter.findMemberByEmail({\n\t\t\t\t\temail: ctx.body.memberIdOrEmail,\n\t\t\t\t\torganizationId: organizationId,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tconst result = await adapter.findMemberById(ctx.body.memberIdOrEmail);\n\t\t\t\tif (!result) toBeRemovedMember = null;\n\t\t\t\telse {\n\t\t\t\t\tconst { user: _user, ...member } = result;\n\t\t\t\t\ttoBeRemovedMember = member as unknown as InferMember<O, false>;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!toBeRemovedMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst roles = toBeRemovedMember.role.split(\",\");\n\t\t\tconst creatorRole = ctx.context.orgOptions?.creatorRole || \"owner\";\n\t\t\tconst isOwner = roles.includes(creatorRole);\n\t\t\tif (isOwner) {\n\t\t\t\tif (member.role !== creatorRole) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst { members } = await adapter.listMembers({\n\t\t\t\t\torganizationId: organizationId,\n\t\t\t\t});\n\t\t\t\tconst owners = members.filter((member) => {\n\t\t\t\t\tconst roles = member.role.split(\",\");\n\t\t\t\t\treturn roles.includes(creatorRole);\n\t\t\t\t});\n\t\t\t\tif (owners.length <= 1) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst canDeleteMember = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: member.role,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tmember: [\"delete\"],\n\t\t\t\t\t},\n\t\t\t\t\torganizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!canDeleteMember) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (toBeRemovedMember?.organizationId !== organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(organizationId);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst userBeingRemoved = await ctx.context.internalAdapter.findUserById(\n\t\t\t\ttoBeRemovedMember.userId,\n\t\t\t);\n\t\t\tif (!userBeingRemoved) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"User not found\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run beforeRemoveMember hook\n\t\t\tif (options?.organizationHooks?.beforeRemoveMember) {\n\t\t\t\tawait options?.organizationHooks.beforeRemoveMember({\n\t\t\t\t\tmember: toBeRemovedMember,\n\t\t\t\t\tuser: userBeingRemoved,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\t\t\tawait adapter.deleteMember({\n\t\t\t\tmemberId: toBeRemovedMember.id,\n\t\t\t\torganizationId: organizationId,\n\t\t\t\tuserId: toBeRemovedMember.userId,\n\t\t\t});\n\t\t\tif (\n\t\t\t\tsession.user.id === toBeRemovedMember.userId &&\n\t\t\t\tsession.session.activeOrganizationId ===\n\t\t\t\t\ttoBeRemovedMember.organizationId\n\t\t\t) {\n\t\t\t\tawait adapter.setActiveOrganization(session.session.token, null, ctx);\n\t\t\t}\n\n\t\t\t// Run afterRemoveMember hook\n\t\t\tif (options?.organizationHooks?.afterRemoveMember) {\n\t\t\t\tawait options?.organizationHooks.afterRemoveMember({\n\t\t\t\t\tmember: toBeRemovedMember,\n\t\t\t\t\tuser: userBeingRemoved,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\tmember: toBeRemovedMember,\n\t\t\t});\n\t\t},\n\t);\n\nconst updateMemberRoleBodySchema = z.object({\n\trole: z.union([z.string(), z.array(z.string())]).meta({\n\t\tdescription:\n\t\t\t'The new role to be applied. This can be a string or array of strings representing the roles. Eg: [\"admin\", \"sale\"]',\n\t}),\n\tmemberId: z.string().meta({\n\t\tdescription: 'The member id to apply the role update to. Eg: \"member-id\"',\n\t}),\n\torganizationId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'An optional organization ID which the member is a part of to apply the role update. If not provided, you must provide session headers to get the active organization. Eg: \"organization-id\"',\n\t\t})\n\t\t.optional(),\n});\n\nexport const updateMemberRole = <O extends OrganizationOptions>(option: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/update-member-role\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: updateMemberRoleBodySchema,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\trequireHeaders: true,\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\trole:\n\t\t\t\t\t\t\t| InferOrganizationRolesFromOption<O>\n\t\t\t\t\t\t\t| InferOrganizationRolesFromOption<O>[]\n\t\t\t\t\t\t\t| LiteralString\n\t\t\t\t\t\t\t| LiteralString[];\n\t\t\t\t\t\tmemberId: string;\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * If not provided, the active organization will be used\n\t\t\t\t\t\t */\n\t\t\t\t\t\torganizationId?: string | undefined;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"updateOrganizationMemberRole\",\n\t\t\t\t\tdescription: \"Update the role of a member in an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tmember: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\trole: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"id\", \"userId\", \"organizationId\", \"role\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"member\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\n\t\t\tif (!ctx.body.role) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\");\n\t\t\t}\n\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId || session.session.activeOrganizationId;\n\n\t\t\tif (!organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst adapter = getOrgAdapter(ctx.context, ctx.context.orgOptions);\n\t\t\tconst roleToSet: string[] = Array.isArray(ctx.body.role)\n\t\t\t\t? ctx.body.role\n\t\t\t\t: ctx.body.role\n\t\t\t\t\t? [ctx.body.role]\n\t\t\t\t\t: [];\n\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst toBeUpdatedMember =\n\t\t\t\tmember.id !== ctx.body.memberId\n\t\t\t\t\t? await adapter.findMemberById(ctx.body.memberId)\n\t\t\t\t\t: member;\n\n\t\t\tif (!toBeUpdatedMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst memberBelongsToOrganization =\n\t\t\t\ttoBeUpdatedMember.organizationId === organizationId;\n\n\t\t\tif (!memberBelongsToOrganization) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_MEMBER,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst creatorRole = ctx.context.orgOptions?.creatorRole || \"owner\";\n\n\t\t\tconst updatingMemberRoles = member.role.split(\",\");\n\t\t\tconst toBeUpdatedMemberRoles = toBeUpdatedMember.role.split(\",\");\n\n\t\t\tconst isUpdatingCreator = toBeUpdatedMemberRoles.includes(creatorRole);\n\t\t\tconst updaterIsCreator = updatingMemberRoles.includes(creatorRole);\n\n\t\t\tconst isSettingCreatorRole = roleToSet.includes(creatorRole);\n\n\t\t\tconst memberIsUpdatingThemselves = member.id === toBeUpdatedMember.id;\n\n\t\t\tif (\n\t\t\t\t(isUpdatingCreator && !updaterIsCreator) ||\n\t\t\t\t(isSettingCreatorRole && !updaterIsCreator)\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_MEMBER,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (updaterIsCreator && memberIsUpdatingThemselves) {\n\t\t\t\tconst members = await ctx.context.adapter.findMany<Member>({\n\t\t\t\t\tmodel: \"member\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t});\n\t\t\t\tconst owners = members.filter((member: Member) => {\n\t\t\t\t\tconst roles = member.role.split(\",\");\n\t\t\t\t\treturn roles.includes(creatorRole);\n\t\t\t\t});\n\t\t\t\tif (owners.length <= 1 && !isSettingCreatorRole) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_CANNOT_LEAVE_THE_ORGANIZATION_WITHOUT_AN_OWNER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst canUpdateMember = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: member.role,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tmember: [\"update\"],\n\t\t\t\t\t},\n\t\t\t\t\tallowCreatorAllPermissions: true,\n\t\t\t\t\torganizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!canUpdateMember) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_MEMBER,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(organizationId);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst userBeingUpdated = await ctx.context.internalAdapter.findUserById(\n\t\t\t\ttoBeUpdatedMember.userId,\n\t\t\t);\n\t\t\tif (!userBeingUpdated) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"User not found\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst previousRole = toBeUpdatedMember.role;\n\t\t\tconst newRole = parseRoles(ctx.body.role as string | string[]);\n\n\t\t\t// Run beforeUpdateMemberRole hook\n\t\t\tif (option?.organizationHooks?.beforeUpdateMemberRole) {\n\t\t\t\tconst response = await option?.organizationHooks.beforeUpdateMemberRole(\n\t\t\t\t\t{\n\t\t\t\t\t\tmember: toBeUpdatedMember,\n\t\t\t\t\t\tnewRole,\n\t\t\t\t\t\tuser: userBeingUpdated,\n\t\t\t\t\t\torganization,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\t// Allow the hook to modify the role\n\t\t\t\t\tconst updatedMember = await adapter.updateMember(\n\t\t\t\t\t\tctx.body.memberId,\n\t\t\t\t\t\tresponse.data.role || newRole,\n\t\t\t\t\t);\n\t\t\t\t\tif (!updatedMember) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// Run afterUpdateMemberRole hook\n\t\t\t\t\tif (option?.organizationHooks?.afterUpdateMemberRole) {\n\t\t\t\t\t\tawait option?.organizationHooks.afterUpdateMemberRole({\n\t\t\t\t\t\t\tmember: updatedMember,\n\t\t\t\t\t\t\tpreviousRole,\n\t\t\t\t\t\t\tuser: userBeingUpdated,\n\t\t\t\t\t\t\torganization,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ctx.json(updatedMember);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst updatedMember = await adapter.updateMember(\n\t\t\t\tctx.body.memberId,\n\t\t\t\tnewRole,\n\t\t\t);\n\t\t\tif (!updatedMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run afterUpdateMemberRole hook\n\t\t\tif (option?.organizationHooks?.afterUpdateMemberRole) {\n\t\t\t\tawait option?.organizationHooks.afterUpdateMemberRole({\n\t\t\t\t\tmember: updatedMember,\n\t\t\t\t\tpreviousRole,\n\t\t\t\t\tuser: userBeingUpdated,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json(updatedMember);\n\t\t},\n\t);\n\nexport const getActiveMember = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/get-active-member\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\trequireHeaders: true,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Get the member details of the active organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trole: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"id\", \"userId\", \"organizationId\", \"role\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst organizationId = session.session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\tbody: {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\tbody: {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn ctx.json(member);\n\t\t},\n\t);\n\nconst leaveOrganizationBodySchema = z.object({\n\torganizationId: z.string().meta({\n\t\tdescription:\n\t\t\t'The organization Id for the member to leave. Eg: \"organization-id\"',\n\t}),\n});\n\nexport const leaveOrganization = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/leave\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: leaveOrganizationBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [sessionMiddleware, orgMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: ctx.body.organizationId,\n\t\t\t});\n\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.MEMBER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst creatorRole = ctx.context.orgOptions?.creatorRole || \"owner\";\n\t\t\tconst isOwnerLeaving = member.role.split(\",\").includes(creatorRole);\n\t\t\tif (isOwnerLeaving) {\n\t\t\t\tconst members = await ctx.context.adapter.findMany<Member>({\n\t\t\t\t\tmodel: \"member\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\t\tvalue: ctx.body.organizationId,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t});\n\t\t\t\tconst owners = members.filter((member) =>\n\t\t\t\t\tmember.role.split(\",\").includes(creatorRole),\n\t\t\t\t);\n\t\t\t\tif (owners.length <= 1) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tawait adapter.deleteMember({\n\t\t\t\tmemberId: member.id,\n\t\t\t\torganizationId: ctx.body.organizationId,\n\t\t\t\tuserId: session.user.id,\n\t\t\t});\n\t\t\tif (session.session.activeOrganizationId === ctx.body.organizationId) {\n\t\t\t\tawait adapter.setActiveOrganization(session.session.token, null, ctx);\n\t\t\t}\n\t\t\treturn ctx.json(member);\n\t\t},\n\t);\n\nexport const listMembers = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/list-members\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: z\n\t\t\t\t.object({\n\t\t\t\t\tlimit: z\n\t\t\t\t\t\t.string()\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription: \"The number of users to return\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.or(z.number())\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\toffset: z\n\t\t\t\t\t\t.string()\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription: \"The offset to start from\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.or(z.number())\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\tsortBy: z\n\t\t\t\t\t\t.string()\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription: \"The field to sort by\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\tsortDirection: z\n\t\t\t\t\t\t.enum([\"asc\", \"desc\"])\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription: \"The direction to sort by\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\tfilterField: z\n\t\t\t\t\t\t.string()\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription: \"The field to filter by\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\tfilterValue: z\n\t\t\t\t\t\t.string()\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription: \"The value to filter by\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.or(z.number())\n\t\t\t\t\t\t.or(z.boolean())\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\tfilterOperator: z\n\t\t\t\t\t\t.enum([\"eq\", \"ne\", \"lt\", \"lte\", \"gt\", \"gte\", \"contains\"])\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription: \"The operator to use for the filter\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\torganizationId: z\n\t\t\t\t\t\t.string()\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t'The organization ID to list members for. If not provided, will default to the user\\'s active organization. Eg: \"organization-id\"',\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.optional(),\n\t\t\t\t\torganizationSlug: z\n\t\t\t\t\t\t.string()\n\t\t\t\t\t\t.meta({\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t'The organization slug to list members for. If not provided, will default to the user\\'s active organization. Eg: \"organization-slug\"',\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.optional(),\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tlet organizationId =\n\t\t\t\tctx.query?.organizationId || session.session.activeOrganizationId;\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tif (ctx.query?.organizationSlug) {\n\t\t\t\tconst organization = await adapter.findOrganizationBySlug(\n\t\t\t\t\tctx.query?.organizationSlug,\n\t\t\t\t);\n\t\t\t\tif (!organization) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\torganizationId = organization.id;\n\t\t\t}\n\t\t\tif (!organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst isMember = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId,\n\t\t\t});\n\t\t\tif (!isMember) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst { members, total } = await adapter.listMembers({\n\t\t\t\torganizationId,\n\t\t\t\tlimit: ctx.query?.limit ? Number(ctx.query.limit) : undefined,\n\t\t\t\toffset: ctx.query?.offset ? Number(ctx.query.offset) : undefined,\n\t\t\t\tsortBy: ctx.query?.sortBy,\n\t\t\t\tsortOrder: ctx.query?.sortDirection,\n\t\t\t\tfilter: ctx.query?.filterField\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tfield: ctx.query?.filterField,\n\t\t\t\t\t\t\toperator: ctx.query.filterOperator,\n\t\t\t\t\t\t\tvalue: ctx.query.filterValue,\n\t\t\t\t\t\t}\n\t\t\t\t\t: undefined,\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\tmembers,\n\t\t\t\ttotal,\n\t\t\t});\n\t\t},\n\t);\n\nconst getActiveMemberRoleQuerySchema = z\n\t.object({\n\t\tuserId: z\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription:\n\t\t\t\t\t\"The user ID to get the role for. If not provided, will default to the current user's\",\n\t\t\t})\n\t\t\t.optional(),\n\t\torganizationId: z\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription:\n\t\t\t\t\t'The organization ID to list members for. If not provided, will default to the user\\'s active organization. Eg: \"organization-id\"',\n\t\t\t})\n\t\t\t.optional(),\n\t\torganizationSlug: z\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription:\n\t\t\t\t\t'The organization slug to list members for. If not provided, will default to the user\\'s active organization. Eg: \"organization-slug\"',\n\t\t\t})\n\t\t\t.optional(),\n\t})\n\t.optional();\n\nexport const getActiveMemberRole = <O extends OrganizationOptions>(\n\toptions: O,\n) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/get-active-member-role\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: getActiveMemberRoleQuerySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tlet organizationId =\n\t\t\t\tctx.query?.organizationId || session.session.activeOrganizationId;\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tif (ctx.query?.organizationSlug) {\n\t\t\t\tconst organization = await adapter.findOrganizationBySlug(\n\t\t\t\t\tctx.query?.organizationSlug,\n\t\t\t\t);\n\t\t\t\tif (!organization) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\torganizationId = organization.id;\n\t\t\t}\n\t\t\tif (!organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst isMember = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId,\n\t\t\t});\n\t\t\tif (!isMember) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (!ctx.query?.userId) {\n\t\t\t\treturn ctx.json({\n\t\t\t\t\trole: isMember.role,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst userIdToGetRole = ctx.query?.userId;\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: userIdToGetRole,\n\t\t\t\torganizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\trole: member?.role,\n\t\t\t});\n\t\t},\n\t);\n", "import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { getSessionFromCtx, requestOnlySessionMiddleware } from \"../../../api\";\nimport { setSessionCookie } from \"../../../cookies\";\nimport type { InferAdditionalFieldsFromPluginOptions } from \"../../../db\";\nimport { toZodSchema } from \"../../../db\";\nimport { getOrgAdapter } from \"../adapter\";\nimport { orgMiddleware, orgSessionMiddleware } from \"../call\";\nimport { ORGANIZATION_ERROR_CODES } from \"../error-codes\";\nimport { hasPermission } from \"../has-permission\";\nimport type {\n\tInferInvitation,\n\tInferMember,\n\tInferOrganization,\n\tInferTeam,\n\tMember,\n\tTeamMember,\n} from \"../schema\";\nimport type { OrganizationOptions } from \"../types\";\n\nconst baseOrganizationSchema = z.object({\n\tname: z.string().min(1).meta({\n\t\tdescription: \"The name of the organization\",\n\t}),\n\tslug: z.string().min(1).meta({\n\t\tdescription: \"The slug of the organization\",\n\t}),\n\tuserId: z.coerce\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The user id of the organization creator. If not provided, the current user will be used. Should only be used by admins or when called by the server. server-only. Eg: \"user-id\"',\n\t\t})\n\t\t.optional(),\n\tlogo: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The logo of the organization\",\n\t\t})\n\t\t.optional(),\n\tmetadata: z\n\t\t.record(z.string(), z.any())\n\t\t.meta({\n\t\t\tdescription: \"The metadata of the organization\",\n\t\t})\n\t\t.optional(),\n\tkeepCurrentActiveOrganization: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Whether to keep the current active organization active after creating a new one. Eg: true\",\n\t\t})\n\t\t.optional(),\n});\n\nexport const createOrganization = <O extends OrganizationOptions>(\n\toptions?: O | undefined,\n) => {\n\tconst additionalFieldsSchema = toZodSchema({\n\t\tfields: options?.schema?.organization?.additionalFields || {},\n\t\tisClientSide: true,\n\t});\n\n\ttype Body = InferAdditionalFieldsFromPluginOptions<\"organization\", O> &\n\t\tz.infer<typeof baseOrganizationSchema>;\n\n\treturn createAuthEndpoint(\n\t\t\"/organization/create\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: z.object({\n\t\t\t\t...baseOrganizationSchema.shape,\n\t\t\t\t...additionalFieldsSchema.shape,\n\t\t\t}),\n\t\t\tuse: [orgMiddleware],\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as Body,\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Create an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The organization that was created\",\n\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Organization\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\n\t\t\tif (!session && (ctx.request || ctx.headers)) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t\t\t}\n\t\t\tlet user = session?.user || null;\n\t\t\tif (!user) {\n\t\t\t\tif (!ctx.body.userId) {\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t\t\t\t}\n\t\t\t\tuser = await ctx.context.internalAdapter.findUserById(ctx.body.userId);\n\t\t\t}\n\t\t\tif (!user) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 401,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst options = ctx.context.orgOptions;\n\t\t\tconst canCreateOrg =\n\t\t\t\ttypeof options?.allowUserToCreateOrganization === \"function\"\n\t\t\t\t\t? await options.allowUserToCreateOrganization(user)\n\t\t\t\t\t: options?.allowUserToCreateOrganization === undefined\n\t\t\t\t\t\t? true\n\t\t\t\t\t\t: options.allowUserToCreateOrganization;\n\n\t\t\tconst isSystemAction = !session && ctx.body.userId;\n\n\t\t\tif (!canCreateOrg && !isSystemAction) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options as O);\n\n\t\t\tconst userOrganizations = await adapter.listOrganizations(user.id);\n\t\t\tconst hasReachedOrgLimit =\n\t\t\t\ttypeof options.organizationLimit === \"number\"\n\t\t\t\t\t? userOrganizations.length >= options.organizationLimit\n\t\t\t\t\t: typeof options.organizationLimit === \"function\"\n\t\t\t\t\t\t? await options.organizationLimit(user)\n\t\t\t\t\t\t: false;\n\n\t\t\tif (hasReachedOrgLimit) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst existingOrganization = await adapter.findOrganizationBySlug(\n\t\t\t\tctx.body.slug,\n\t\t\t);\n\t\t\tif (existingOrganization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_ALREADY_EXISTS,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet {\n\t\t\t\tkeepCurrentActiveOrganization: _,\n\t\t\t\tuserId: __,\n\t\t\t\t...orgData\n\t\t\t} = ctx.body;\n\n\t\t\tif (options.organizationCreation?.beforeCreate) {\n\t\t\t\tconst response = await options.organizationCreation.beforeCreate(\n\t\t\t\t\t{\n\t\t\t\t\t\torganization: {\n\t\t\t\t\t\t\t...orgData,\n\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tuser,\n\t\t\t\t\t},\n\t\t\t\t\tctx.request,\n\t\t\t\t);\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\torgData = {\n\t\t\t\t\t\t...ctx.body,\n\t\t\t\t\t\t...response.data,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (options?.organizationHooks?.beforeCreateOrganization) {\n\t\t\t\tconst response =\n\t\t\t\t\tawait options?.organizationHooks.beforeCreateOrganization({\n\t\t\t\t\t\torganization: orgData,\n\t\t\t\t\t\tuser,\n\t\t\t\t\t});\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\torgData = {\n\t\t\t\t\t\t...ctx.body,\n\t\t\t\t\t\t...response.data,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst organization = await adapter.createOrganization({\n\t\t\t\torganization: {\n\t\t\t\t\t...orgData,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tlet member:\n\t\t\t\t| (Member & InferAdditionalFieldsFromPluginOptions<\"member\", O, false>)\n\t\t\t\t| undefined;\n\t\t\tlet teamMember: TeamMember | null = null;\n\t\t\tlet data = {\n\t\t\t\tuserId: user.id,\n\t\t\t\torganizationId: organization.id,\n\t\t\t\trole: ctx.context.orgOptions.creatorRole || \"owner\",\n\t\t\t};\n\t\t\tif (options?.organizationHooks?.beforeAddMember) {\n\t\t\t\tconst response = await options?.organizationHooks.beforeAddMember({\n\t\t\t\t\tmember: {\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\torganizationId: organization.id,\n\t\t\t\t\t\trole: ctx.context.orgOptions.creatorRole || \"owner\",\n\t\t\t\t\t},\n\t\t\t\t\tuser,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\tdata = {\n\t\t\t\t\t\t...data,\n\t\t\t\t\t\t...response.data,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t\tmember = await adapter.createMember(data);\n\t\t\tif (options?.organizationHooks?.afterAddMember) {\n\t\t\t\tawait options?.organizationHooks.afterAddMember({\n\t\t\t\t\tmember,\n\t\t\t\t\tuser,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (\n\t\t\t\toptions?.teams?.enabled &&\n\t\t\t\toptions.teams.defaultTeam?.enabled !== false\n\t\t\t) {\n\t\t\t\tlet teamData = {\n\t\t\t\t\torganizationId: organization.id,\n\t\t\t\t\tname: `${organization.name}`,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t};\n\t\t\t\tif (options?.organizationHooks?.beforeCreateTeam) {\n\t\t\t\t\tconst response = await options?.organizationHooks.beforeCreateTeam({\n\t\t\t\t\t\tteam: {\n\t\t\t\t\t\t\torganizationId: organization.id,\n\t\t\t\t\t\t\tname: `${organization.name}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tuser,\n\t\t\t\t\t\torganization,\n\t\t\t\t\t});\n\t\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\t\tteamData = {\n\t\t\t\t\t\t\t...teamData,\n\t\t\t\t\t\t\t...response.data,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tconst defaultTeam =\n\t\t\t\t\t(await options.teams.defaultTeam?.customCreateDefaultTeam?.(\n\t\t\t\t\t\torganization,\n\t\t\t\t\t\tctx,\n\t\t\t\t\t)) || (await adapter.createTeam(teamData));\n\n\t\t\t\tteamMember = await adapter.findOrCreateTeamMember({\n\t\t\t\t\tteamId: defaultTeam.id,\n\t\t\t\t\tuserId: user.id,\n\t\t\t\t});\n\n\t\t\t\tif (options?.organizationHooks?.afterCreateTeam) {\n\t\t\t\t\tawait options?.organizationHooks.afterCreateTeam({\n\t\t\t\t\t\tteam: defaultTeam,\n\t\t\t\t\t\tuser,\n\t\t\t\t\t\torganization,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (options.organizationCreation?.afterCreate) {\n\t\t\t\tawait options.organizationCreation.afterCreate(\n\t\t\t\t\t{\n\t\t\t\t\t\torganization,\n\t\t\t\t\t\tuser,\n\t\t\t\t\t\tmember,\n\t\t\t\t\t},\n\t\t\t\t\tctx.request,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (options?.organizationHooks?.afterCreateOrganization) {\n\t\t\t\tawait options?.organizationHooks.afterCreateOrganization({\n\t\t\t\t\torganization,\n\t\t\t\t\tuser,\n\t\t\t\t\tmember,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (ctx.context.session && !ctx.body.keepCurrentActiveOrganization) {\n\t\t\t\tawait adapter.setActiveOrganization(\n\t\t\t\t\tctx.context.session.session.token,\n\t\t\t\t\torganization.id,\n\t\t\t\t\tctx,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tteamMember &&\n\t\t\t\tctx.context.session &&\n\t\t\t\t!ctx.body.keepCurrentActiveOrganization\n\t\t\t) {\n\t\t\t\tawait adapter.setActiveTeam(\n\t\t\t\t\tctx.context.session.session.token,\n\t\t\t\t\tteamMember.teamId,\n\t\t\t\t\tctx,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\t...organization,\n\t\t\t\tmetadata:\n\t\t\t\t\torganization.metadata && typeof organization.metadata === \"string\"\n\t\t\t\t\t\t? JSON.parse(organization.metadata)\n\t\t\t\t\t\t: organization.metadata,\n\t\t\t\tmembers: [member],\n\t\t\t});\n\t\t},\n\t);\n};\n\nconst checkOrganizationSlugBodySchema = z.object({\n\tslug: z.string().meta({\n\t\tdescription: 'The organization slug to check. Eg: \"my-org\"',\n\t}),\n});\n\nexport const checkOrganizationSlug = <O extends OrganizationOptions>(\n\toptions: O,\n) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/check-slug\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: checkOrganizationSlugBodySchema,\n\t\t\tuse: [requestOnlySessionMiddleware, orgMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst orgAdapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst org = await orgAdapter.findOrganizationBySlug(ctx.body.slug);\n\t\t\tif (!org) {\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t});\n\t\t\t}\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"slug is taken\",\n\t\t\t});\n\t\t},\n\t);\n\nconst baseUpdateOrganizationSchema = z.object({\n\tname: z\n\t\t.string()\n\t\t.min(1)\n\t\t.meta({\n\t\t\tdescription: \"The name of the organization\",\n\t\t})\n\t\t.optional(),\n\tslug: z\n\t\t.string()\n\t\t.min(1)\n\t\t.meta({\n\t\t\tdescription: \"The slug of the organization\",\n\t\t})\n\t\t.optional(),\n\tlogo: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The logo of the organization\",\n\t\t})\n\t\t.optional(),\n\tmetadata: z\n\t\t.record(z.string(), z.any())\n\t\t.meta({\n\t\t\tdescription: \"The metadata of the organization\",\n\t\t})\n\t\t.optional(),\n});\n\nexport const updateOrganization = <O extends OrganizationOptions>(\n\toptions?: O | undefined,\n) => {\n\tconst additionalFieldsSchema = toZodSchema({\n\t\tfields: options?.schema?.organization?.additionalFields || {},\n\t\tisClientSide: true,\n\t});\n\ttype Body = {\n\t\tdata: {\n\t\t\tname?: string | undefined;\n\t\t\tslug?: string | undefined;\n\t\t\tlogo?: string | undefined;\n\t\t\tmetadata?: Record<string, any> | undefined;\n\t\t} & Partial<InferAdditionalFieldsFromPluginOptions<\"organization\", O>>;\n\t\torganizationId?: string | undefined;\n\t};\n\treturn createAuthEndpoint(\n\t\t\"/organization/update\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: z.object({\n\t\t\t\tdata: z\n\t\t\t\t\t.object({\n\t\t\t\t\t\t...additionalFieldsSchema.shape,\n\t\t\t\t\t\t...baseUpdateOrganizationSchema.shape,\n\t\t\t\t\t})\n\t\t\t\t\t.partial(),\n\t\t\t\torganizationId: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.meta({\n\t\t\t\t\t\tdescription: 'The organization ID. Eg: \"org-id\"',\n\t\t\t\t\t})\n\t\t\t\t\t.optional(),\n\t\t\t}),\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware],\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as Body,\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Update an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The updated organization\",\n\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Organization\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await ctx.context.getSession(ctx);\n\t\t\tif (!session) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: \"User not found\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId || session.session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst canUpdateOrg = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\torganization: [\"update\"],\n\t\t\t\t\t},\n\t\t\t\t\trole: member.role,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\torganizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (!canUpdateOrg) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\t// Check if slug is being updated and validate uniqueness\n\t\t\tif (typeof ctx.body.data.slug === \"string\") {\n\t\t\t\tconst existingOrganization = await adapter.findOrganizationBySlug(\n\t\t\t\t\tctx.body.data.slug,\n\t\t\t\t);\n\t\t\t\tif (\n\t\t\t\t\texistingOrganization &&\n\t\t\t\t\texistingOrganization.id !== organizationId\n\t\t\t\t) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_SLUG_ALREADY_TAKEN,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (options?.organizationHooks?.beforeUpdateOrganization) {\n\t\t\t\tconst response =\n\t\t\t\t\tawait options.organizationHooks.beforeUpdateOrganization({\n\t\t\t\t\t\torganization: ctx.body.data,\n\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t\tmember,\n\t\t\t\t\t});\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\tctx.body.data = {\n\t\t\t\t\t\t...ctx.body.data,\n\t\t\t\t\t\t...response.data,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst updatedOrg = await adapter.updateOrganization(\n\t\t\t\torganizationId,\n\t\t\t\tctx.body.data,\n\t\t\t);\n\t\t\tif (options?.organizationHooks?.afterUpdateOrganization) {\n\t\t\t\tawait options.organizationHooks.afterUpdateOrganization({\n\t\t\t\t\torganization: updatedOrg,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t\tmember,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn ctx.json(updatedOrg);\n\t\t},\n\t);\n};\n\nconst deleteOrganizationBodySchema = z.object({\n\torganizationId: z.string().meta({\n\t\tdescription: \"The organization id to delete\",\n\t}),\n});\n\nexport const deleteOrganization = <O extends OrganizationOptions>(\n\toptions: O,\n) => {\n\treturn createAuthEndpoint(\n\t\t\"/organization/delete\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: deleteOrganizationBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Delete an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The organization id that was deleted\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst disableOrganizationDeletion =\n\t\t\t\tctx.context.orgOptions.organizationDeletion?.disabled ||\n\t\t\t\tctx.context.orgOptions.disableOrganizationDeletion;\n\t\t\tif (disableOrganizationDeletion) {\n\t\t\t\tif (ctx.context.orgOptions.organizationDeletion?.disabled) {\n\t\t\t\t\tctx.context.logger.info(\n\t\t\t\t\t\t\"`organizationDeletion.disabled` is deprecated. Use `disableOrganizationDeletion` instead\",\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: \"Organization deletion is disabled\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst session = await ctx.context.getSession(ctx);\n\t\t\tif (!session) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", { status: 401 });\n\t\t\t}\n\n\t\t\tconst organizationId = ctx.body.organizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\tbody: {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: organizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst canDeleteOrg = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: member.role,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\torganization: [\"delete\"],\n\t\t\t\t\t},\n\t\t\t\t\torganizationId,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (!canDeleteOrg) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (organizationId === session.session.activeOrganizationId) {\n\t\t\t\t/**\n\t\t\t\t * If the organization is deleted, we set the active organization to null\n\t\t\t\t */\n\t\t\t\tawait adapter.setActiveOrganization(session.session.token, null, ctx);\n\t\t\t}\n\n\t\t\tconst org = await adapter.findOrganizationById(organizationId);\n\t\t\tif (!org) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\");\n\t\t\t}\n\t\t\tif (options?.organizationHooks?.beforeDeleteOrganization) {\n\t\t\t\tawait options.organizationHooks.beforeDeleteOrganization({\n\t\t\t\t\torganization: org,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t});\n\t\t\t}\n\t\t\tawait adapter.deleteOrganization(organizationId);\n\t\t\tif (options?.organizationHooks?.afterDeleteOrganization) {\n\t\t\t\tawait options.organizationHooks.afterDeleteOrganization({\n\t\t\t\t\torganization: org,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn ctx.json(org);\n\t\t},\n\t);\n};\n\nconst getFullOrganizationQuerySchema = z.optional(\n\tz.object({\n\t\torganizationId: z\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription: \"The organization id to get\",\n\t\t\t})\n\t\t\t.optional(),\n\t\torganizationSlug: z\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription: \"The organization slug to get\",\n\t\t\t})\n\t\t\t.optional(),\n\t\tmembersLimit: z\n\t\t\t.number()\n\t\t\t.or(z.string().transform((val) => parseInt(val)))\n\t\t\t.meta({\n\t\t\t\tdescription:\n\t\t\t\t\t\"The limit of members to get. By default, it uses the membershipLimit option which defaults to 100.\",\n\t\t\t})\n\t\t\t.optional(),\n\t}),\n);\n\nexport const getFullOrganization = <O extends OrganizationOptions>(\n\toptions: O,\n) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/get-full-organization\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: getFullOrganizationQuerySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"getOrganization\",\n\t\t\t\t\tdescription: \"Get the full organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The organization\",\n\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Organization\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst organizationId =\n\t\t\t\tctx.query?.organizationSlug ||\n\t\t\t\tctx.query?.organizationId ||\n\t\t\t\tsession.session.activeOrganizationId;\n\t\t\t// return null if no organization is found to avoid erroring since this is a usual scenario\n\t\t\tif (!organizationId) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 200,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst organization = await adapter.findFullOrganization({\n\t\t\t\torganizationId,\n\t\t\t\tisSlug: !!ctx.query?.organizationSlug,\n\t\t\t\tincludeTeams: ctx.context.orgOptions.teams?.enabled,\n\t\t\t\tmembersLimit: ctx.query?.membersLimit,\n\t\t\t});\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst isMember = await adapter.checkMembership({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: organization.id,\n\t\t\t});\n\t\t\tif (!isMember) {\n\t\t\t\tawait adapter.setActiveOrganization(session.session.token, null, ctx);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttype OrganizationReturn = O[\"teams\"] extends { enabled: true }\n\t\t\t\t? {\n\t\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\t\tteams: InferTeam<O, false>[];\n\t\t\t\t\t} & InferOrganization<O, false>\n\t\t\t\t: {\n\t\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\t} & InferOrganization<O, false>;\n\t\t\treturn ctx.json(organization as unknown as OrganizationReturn);\n\t\t},\n\t);\n\nconst setActiveOrganizationBodySchema = z.object({\n\torganizationId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The organization id to set as active. It can be null to unset the active organization. Eg: \"org-id\"',\n\t\t})\n\t\t.nullable()\n\t\t.optional(),\n\torganizationSlug: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The organization slug to set as active. It can be null to unset the active organization if organizationId is not provided. Eg: \"org-slug\"',\n\t\t})\n\t\t.optional(),\n});\n\nexport const setActiveOrganization = <O extends OrganizationOptions>(\n\toptions: O,\n) => {\n\treturn createAuthEndpoint(\n\t\t\"/organization/set-active\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: setActiveOrganizationBodySchema,\n\t\t\tuse: [orgSessionMiddleware, orgMiddleware],\n\t\t\trequireHeaders: true,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"setActiveOrganization\",\n\t\t\t\t\tdescription: \"Set the active organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The organization\",\n\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Organization\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst session = ctx.context.session;\n\t\t\tlet organizationId = ctx.body.organizationId;\n\t\t\tlet organizationSlug = ctx.body.organizationSlug;\n\n\t\t\tif (organizationId === null) {\n\t\t\t\tconst sessionOrgId = session.session.activeOrganizationId;\n\t\t\t\tif (!sessionOrgId) {\n\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t}\n\t\t\t\tconst updatedSession = await adapter.setActiveOrganization(\n\t\t\t\t\tsession.session.token,\n\t\t\t\t\tnull,\n\t\t\t\t\tctx,\n\t\t\t\t);\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession: updatedSession,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t});\n\t\t\t\treturn ctx.json(null);\n\t\t\t}\n\n\t\t\tif (!organizationId && !organizationSlug) {\n\t\t\t\tconst sessionOrgId = session.session.activeOrganizationId;\n\t\t\t\tif (!sessionOrgId) {\n\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t}\n\t\t\t\torganizationId = sessionOrgId;\n\t\t\t}\n\n\t\t\tif (organizationSlug && !organizationId) {\n\t\t\t\tconst organization =\n\t\t\t\t\tawait adapter.findOrganizationBySlug(organizationSlug);\n\t\t\t\tif (!organization) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\torganizationId = organization.id;\n\t\t\t}\n\n\t\t\tif (!organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst isMember = await adapter.checkMembership({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId,\n\t\t\t});\n\t\t\tif (!isMember) {\n\t\t\t\tawait adapter.setActiveOrganization(session.session.token, null, ctx);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet organization = await adapter.findOrganizationById(organizationId);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst updatedSession = await adapter.setActiveOrganization(\n\t\t\t\tsession.session.token,\n\t\t\t\torganization.id,\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\tsession: updatedSession,\n\t\t\t\tuser: session.user,\n\t\t\t});\n\t\t\ttype OrganizationReturn = O[\"teams\"] extends { enabled: true }\n\t\t\t\t? {\n\t\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\t\tteams: InferTeam<O, false>[];\n\t\t\t\t\t} & InferOrganization<O, false>\n\t\t\t\t: {\n\t\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\t} & InferOrganization<O, false>;\n\t\t\treturn ctx.json(organization as unknown as OrganizationReturn);\n\t\t},\n\t);\n};\n\nexport const listOrganizations = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/list\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\trequireHeaders: true,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"List all organizations\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Organization\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst organizations = await adapter.listOrganizations(\n\t\t\t\tctx.context.session.user.id,\n\t\t\t);\n\t\t\treturn ctx.json(organizations);\n\t\t},\n\t);\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\nimport type { Prettify } from \"better-call\";\nimport * as z from \"zod\";\nimport type { InferAdditionalFieldsFromPluginOptions } from \"../../db\";\nimport { generateId } from \"../../utils\";\nimport type { OrganizationOptions } from \"./types\";\n\ntype InferSchema<\n\tSchema extends BetterAuthPluginDBSchema,\n\tTableName extends string,\n\tDefaultFields,\n> = {\n\tmodelName: Schema[TableName] extends { modelName: infer M }\n\t\t? M extends string\n\t\t\t? M\n\t\t\t: string\n\t\t: string;\n\tfields: {\n\t\t[K in keyof DefaultFields]: DefaultFields[K];\n\t} & (Schema[TableName] extends { additionalFields: infer F } ? F : {});\n};\n\ninterface OrganizationRoleDefaultFields {\n\torganizationId: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\treferences: {\n\t\t\tmodel: \"organization\";\n\t\t\tfield: \"id\";\n\t\t};\n\t};\n\trole: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t};\n\tpermission: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t};\n\tcreatedAt: {\n\t\ttype: \"date\";\n\t\trequired: true;\n\t\tdefaultValue: Date;\n\t};\n\tupdatedAt: {\n\t\ttype: \"date\";\n\t\trequired: false;\n\t};\n}\n\ninterface TeamDefaultFields {\n\tname: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t};\n\torganizationId: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\treferences: {\n\t\t\tmodel: \"organization\";\n\t\t\tfield: \"id\";\n\t\t};\n\t};\n\tcreatedAt: {\n\t\ttype: \"date\";\n\t\trequired: true;\n\t};\n\tupdatedAt: {\n\t\ttype: \"date\";\n\t\trequired: false;\n\t};\n}\n\ninterface TeamMemberDefaultFields {\n\tteamId: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\treferences: {\n\t\t\tmodel: \"team\";\n\t\t\tfield: \"id\";\n\t\t};\n\t};\n\tuserId: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\treferences: {\n\t\t\tmodel: \"user\";\n\t\t\tfield: \"id\";\n\t\t};\n\t};\n\tcreatedAt: {\n\t\ttype: \"date\";\n\t\trequired: false;\n\t};\n}\n\ninterface OrganizationDefaultFields {\n\tname: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\tsortable: true;\n\t};\n\tslug: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\tunique: true;\n\t\tsortable: true;\n\t};\n\tlogo: {\n\t\ttype: \"string\";\n\t\trequired: false;\n\t};\n\tcreatedAt: {\n\t\ttype: \"date\";\n\t\trequired: true;\n\t};\n\tupdatedAt: {\n\t\ttype: \"date\";\n\t\trequired: false;\n\t};\n}\n\ninterface MemberDefaultFields {\n\torganizationId: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\treferences: {\n\t\t\tmodel: \"organization\";\n\t\t\tfield: \"id\";\n\t\t};\n\t};\n\tuserId: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\treferences: {\n\t\t\tmodel: \"user\";\n\t\t\tfield: \"id\";\n\t\t};\n\t};\n\trole: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\tdefaultValue: \"member\";\n\t};\n\tcreatedAt: {\n\t\ttype: \"date\";\n\t\trequired: true;\n\t};\n}\n\ninterface InvitationDefaultFields {\n\torganizationId: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\treferences: {\n\t\t\tmodel: \"organization\";\n\t\t\tfield: \"id\";\n\t\t};\n\t};\n\temail: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\tsortable: true;\n\t};\n\trole: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\tsortable: true;\n\t};\n\tstatus: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\tsortable: true;\n\t\tdefaultValue: \"pending\";\n\t};\n\texpiresAt: {\n\t\ttype: \"date\";\n\t\trequired: false;\n\t};\n\tcreatedAt: {\n\t\ttype: \"date\";\n\t\trequired: true;\n\t\tdefaultValue: Date;\n\t};\n\tinviterId: {\n\t\ttype: \"string\";\n\t\trequired: true;\n\t\treferences: {\n\t\t\tmodel: \"user\";\n\t\t\tfield: \"id\";\n\t\t};\n\t};\n}\n\ninterface SessionDefaultFields {\n\tactiveOrganizationId: {\n\t\ttype: \"string\";\n\t\trequired: false;\n\t};\n}\n\nexport type OrganizationSchema<O extends OrganizationOptions> =\n\tO[\"dynamicAccessControl\"] extends { enabled: true }\n\t\t? {\n\t\t\t\torganizationRole: InferSchema<\n\t\t\t\t\tO[\"schema\"] extends BetterAuthPluginDBSchema ? O[\"schema\"] : {},\n\t\t\t\t\t\"organizationRole\",\n\t\t\t\t\tOrganizationRoleDefaultFields\n\t\t\t\t>;\n\t\t\t} & {\n\t\t\t\tsession: {\n\t\t\t\t\tfields: InferSchema<\n\t\t\t\t\t\tO[\"schema\"] extends BetterAuthPluginDBSchema ? O[\"schema\"] : {},\n\t\t\t\t\t\t\"session\",\n\t\t\t\t\t\tSessionDefaultFields\n\t\t\t\t\t>[\"fields\"];\n\t\t\t\t};\n\t\t\t}\n\t\t: {} & (O[\"teams\"] extends { enabled: true }\n\t\t\t\t? {\n\t\t\t\t\t\tteam: InferSchema<\n\t\t\t\t\t\t\tO[\"schema\"] extends BetterAuthPluginDBSchema ? O[\"schema\"] : {},\n\t\t\t\t\t\t\t\"team\",\n\t\t\t\t\t\t\tTeamDefaultFields\n\t\t\t\t\t\t>;\n\t\t\t\t\t\tteamMember: InferSchema<\n\t\t\t\t\t\t\tO[\"schema\"] extends BetterAuthPluginDBSchema ? O[\"schema\"] : {},\n\t\t\t\t\t\t\t\"teamMember\",\n\t\t\t\t\t\t\tTeamMemberDefaultFields\n\t\t\t\t\t\t>;\n\t\t\t\t\t}\n\t\t\t\t: {}) & {\n\t\t\t\t\torganization: InferSchema<\n\t\t\t\t\t\tO[\"schema\"] extends BetterAuthPluginDBSchema ? O[\"schema\"] : {},\n\t\t\t\t\t\t\"organization\",\n\t\t\t\t\t\tOrganizationDefaultFields\n\t\t\t\t\t>;\n\t\t\t\t\tmember: InferSchema<\n\t\t\t\t\t\tO[\"schema\"] extends BetterAuthPluginDBSchema ? O[\"schema\"] : {},\n\t\t\t\t\t\t\"member\",\n\t\t\t\t\t\tMemberDefaultFields\n\t\t\t\t\t>;\n\t\t\t\t\tinvitation: {\n\t\t\t\t\t\tmodelName: O[\"schema\"] extends BetterAuthPluginDBSchema\n\t\t\t\t\t\t\t? InferSchema<\n\t\t\t\t\t\t\t\t\tO[\"schema\"],\n\t\t\t\t\t\t\t\t\t\"invitation\",\n\t\t\t\t\t\t\t\t\tInvitationDefaultFields\n\t\t\t\t\t\t\t\t>[\"modelName\"]\n\t\t\t\t\t\t\t: string;\n\t\t\t\t\t\tfields: InferSchema<\n\t\t\t\t\t\t\tO[\"schema\"] extends BetterAuthPluginDBSchema ? O[\"schema\"] : {},\n\t\t\t\t\t\t\t\"invitation\",\n\t\t\t\t\t\t\tInvitationDefaultFields\n\t\t\t\t\t\t>[\"fields\"] &\n\t\t\t\t\t\t\t(O extends { teams: { enabled: true } }\n\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\tteamId: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\";\n\t\t\t\t\t\t\t\t\t\t\trequired: false;\n\t\t\t\t\t\t\t\t\t\t\tsortable: true;\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t: {});\n\t\t\t\t\t};\n\t\t\t\t\tsession: {\n\t\t\t\t\t\tfields: InferSchema<\n\t\t\t\t\t\t\tO[\"schema\"] extends BetterAuthPluginDBSchema ? O[\"schema\"] : {},\n\t\t\t\t\t\t\t\"session\",\n\t\t\t\t\t\t\tSessionDefaultFields\n\t\t\t\t\t\t>[\"fields\"] &\n\t\t\t\t\t\t\t(O[\"teams\"] extends { enabled: true }\n\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\tactiveTeamId: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\";\n\t\t\t\t\t\t\t\t\t\t\trequired: false;\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t: {});\n\t\t\t\t\t};\n\t\t\t\t};\n\nexport const roleSchema = z.string();\nexport const invitationStatus = z\n\t.enum([\"pending\", \"accepted\", \"rejected\", \"canceled\"])\n\t.default(\"pending\");\n\nexport const organizationSchema = z.object({\n\tid: z.string().default(generateId),\n\tname: z.string(),\n\tslug: z.string(),\n\tlogo: z.string().nullish().optional(),\n\tmetadata: z\n\t\t.record(z.string(), z.unknown())\n\t\t.or(z.string().transform((v) => JSON.parse(v)))\n\t\t.optional(),\n\tcreatedAt: z.date(),\n});\n\nexport const memberSchema = z.object({\n\tid: z.string().default(generateId),\n\torganizationId: z.string(),\n\tuserId: z.coerce.string(),\n\trole: roleSchema,\n\tcreatedAt: z.date().default(() => new Date()),\n});\n\nexport const invitationSchema = z.object({\n\tid: z.string().default(generateId),\n\torganizationId: z.string(),\n\temail: z.string(),\n\trole: roleSchema,\n\tstatus: invitationStatus,\n\tteamId: z.string().nullish(),\n\tinviterId: z.string(),\n\texpiresAt: z.date(),\n\tcreatedAt: z.date().default(() => new Date()),\n});\n\nexport const teamSchema = z.object({\n\tid: z.string().default(generateId),\n\tname: z.string().min(1),\n\torganizationId: z.string(),\n\tcreatedAt: z.date(),\n\tupdatedAt: z.date().optional(),\n});\n\nexport const teamMemberSchema = z.object({\n\tid: z.string().default(generateId),\n\tteamId: z.string(),\n\tuserId: z.string(),\n\tcreatedAt: z.date().default(() => new Date()),\n});\n\nexport const organizationRoleSchema = z.object({\n\tid: z.string().default(generateId),\n\torganizationId: z.string(),\n\trole: z.string(),\n\tpermission: z.record(z.string(), z.array(z.string())),\n\tcreatedAt: z.date().default(() => new Date()),\n\tupdatedAt: z.date().optional(),\n});\n\nexport type Organization = z.infer<typeof organizationSchema>;\nexport type Member = z.infer<typeof memberSchema>;\nexport type TeamMember = z.infer<typeof teamMemberSchema>;\nexport type Team = z.infer<typeof teamSchema>;\nexport type Invitation = z.infer<typeof invitationSchema>;\nexport type InvitationInput = z.input<typeof invitationSchema>;\nexport type MemberInput = z.input<typeof memberSchema>;\nexport type TeamMemberInput = z.input<typeof teamMemberSchema>;\nexport type OrganizationInput = z.input<typeof organizationSchema>;\nexport type TeamInput = z.infer<typeof teamSchema>;\nexport type OrganizationRole = z.infer<typeof organizationRoleSchema>;\n\nconst defaultRoles = [\"admin\", \"member\", \"owner\"] as const;\nexport const defaultRolesSchema = z.union([\n\tz.enum(defaultRoles),\n\tz.array(z.enum(defaultRoles)),\n]);\n\ntype CustomRolesSchema<O> = O extends { roles: { [key: string]: any } }\n\t? z.ZodType<keyof O[\"roles\"] | Array<keyof O[\"roles\"]>>\n\t: typeof defaultRolesSchema;\n\nexport type InferOrganizationZodRolesFromOption<\n\tO extends OrganizationOptions | undefined,\n> = CustomRolesSchema<O>;\n\nexport type InferOrganizationRolesFromOption<\n\tO extends OrganizationOptions | undefined,\n> = O extends { roles: any }\n\t? keyof O[\"roles\"] extends infer K extends string\n\t\t? K\n\t\t: \"admin\" | \"member\" | \"owner\"\n\t: \"admin\" | \"member\" | \"owner\";\n\nexport type InvitationStatus = \"pending\" | \"accepted\" | \"rejected\" | \"canceled\";\n\nexport type InferMember<\n\tO extends OrganizationOptions,\n\tisClientSide extends boolean = true,\n> = Prettify<\n\t(O[\"teams\"] extends {\n\t\tenabled: true;\n\t}\n\t\t? {\n\t\t\t\tid: string;\n\t\t\t\torganizationId: string;\n\t\t\t\trole: InferOrganizationRolesFromOption<O>;\n\t\t\t\tcreatedAt: Date;\n\t\t\t\tuserId: string;\n\t\t\t\tteamId?: string | undefined;\n\t\t\t\tuser: {\n\t\t\t\t\tid: string;\n\t\t\t\t\temail: string;\n\t\t\t\t\tname: string;\n\t\t\t\t\timage?: string | undefined;\n\t\t\t\t};\n\t\t\t}\n\t\t: {\n\t\t\t\tid: string;\n\t\t\t\torganizationId: string;\n\t\t\t\trole: InferOrganizationRolesFromOption<O>;\n\t\t\t\tcreatedAt: Date;\n\t\t\t\tuserId: string;\n\t\t\t\tuser: {\n\t\t\t\t\tid: string;\n\t\t\t\t\temail: string;\n\t\t\t\t\tname: string;\n\t\t\t\t\timage?: string | undefined;\n\t\t\t\t};\n\t\t\t}) &\n\t\tInferAdditionalFieldsFromPluginOptions<\"member\", O, isClientSide>\n>;\n\nexport type InferOrganization<\n\tO extends OrganizationOptions,\n\tisClientSide extends boolean = true,\n> = Prettify<\n\tOrganization &\n\t\tInferAdditionalFieldsFromPluginOptions<\"organization\", O, isClientSide>\n>;\n\nexport type InferTeam<\n\tO extends OrganizationOptions,\n\tisClientSide extends boolean = true,\n> = Prettify<\n\tTeam & InferAdditionalFieldsFromPluginOptions<\"team\", O, isClientSide>\n>;\n\nexport type InferInvitation<\n\tO extends OrganizationOptions,\n\tisClientSide extends boolean = true,\n> = Prettify<\n\t(O[\"teams\"] extends {\n\t\tenabled: true;\n\t}\n\t\t? {\n\t\t\t\tid: string;\n\t\t\t\torganizationId: string;\n\t\t\t\temail: string;\n\t\t\t\trole: InferOrganizationRolesFromOption<O>;\n\t\t\t\tstatus: InvitationStatus;\n\t\t\t\tinviterId: string;\n\t\t\t\texpiresAt: Date;\n\t\t\t\tcreatedAt: Date;\n\t\t\t\tteamId?: string | undefined;\n\t\t\t}\n\t\t: {\n\t\t\t\tid: string;\n\t\t\t\torganizationId: string;\n\t\t\t\temail: string;\n\t\t\t\trole: InferOrganizationRolesFromOption<O>;\n\t\t\t\tstatus: InvitationStatus;\n\t\t\t\tinviterId: string;\n\t\t\t\texpiresAt: Date;\n\t\t\t\tcreatedAt: Date;\n\t\t\t}) &\n\t\tInferAdditionalFieldsFromPluginOptions<\"invitation\", O, isClientSide>\n>;\n", "import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { getSessionFromCtx } from \"../../../api\";\nimport { setSessionCookie } from \"../../../cookies\";\nimport type { InferAdditionalFieldsFromPluginOptions } from \"../../../db\";\nimport { toZodSchema } from \"../../../db\";\nimport type { PrettifyDeep } from \"../../../types/helper\";\nimport { getOrgAdapter } from \"../adapter\";\nimport { orgMiddleware, orgSessionMiddleware } from \"../call\";\nimport { ORGANIZATION_ERROR_CODES } from \"../error-codes\";\nimport { hasPermission } from \"../has-permission\";\nimport { teamSchema } from \"../schema\";\nimport type { OrganizationOptions } from \"../types\";\n\nconst teamBaseSchema = z.object({\n\tname: z.string().meta({\n\t\tdescription: 'The name of the team. Eg: \"my-team\"',\n\t}),\n\torganizationId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t'The organization ID which the team will be created in. Defaults to the active organization. Eg: \"organization-id\"',\n\t\t})\n\t\t.optional(),\n});\n\nexport const createTeam = <O extends OrganizationOptions>(options: O) => {\n\tconst additionalFieldsSchema = toZodSchema({\n\t\tfields: options?.schema?.team?.additionalFields ?? {},\n\t\tisClientSide: true,\n\t});\n\treturn createAuthEndpoint(\n\t\t\"/organization/create-team\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: z.object({\n\t\t\t\t...teamBaseSchema.shape,\n\t\t\t\t...additionalFieldsSchema.shape,\n\t\t\t}),\n\t\t\tuse: [orgMiddleware],\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as z.infer<typeof teamBaseSchema> &\n\t\t\t\t\t\tInferAdditionalFieldsFromPluginOptions<\"team\", O>,\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Create a new team within an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Team created successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the created team\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Name of the team\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"ID of the organization the team belongs to\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Timestamp when the team was created\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Timestamp when the team was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\"name\",\n\t\t\t\t\t\t\t\t\t\t\t\"organizationId\",\n\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId || session?.session.activeOrganizationId;\n\t\t\tif (!session && (ctx.request || ctx.headers)) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t\t\t}\n\n\t\t\tif (!organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options as O);\n\t\t\tif (session) {\n\t\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\t\tuserId: session.user.id,\n\t\t\t\t\torganizationId,\n\t\t\t\t});\n\t\t\t\tif (!member) {\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst canCreate = await hasPermission(\n\t\t\t\t\t{\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\tteam: [\"create\"],\n\t\t\t\t\t\t},\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t);\n\n\t\t\t\tif (!canCreate) {\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CREATE_TEAMS_IN_THIS_ORGANIZATION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst existingTeams = await adapter.listTeams(organizationId);\n\t\t\tconst maximum =\n\t\t\t\ttypeof ctx.context.orgOptions.teams?.maximumTeams === \"function\"\n\t\t\t\t\t? await ctx.context.orgOptions.teams?.maximumTeams(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\t\t\tsession,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t)\n\t\t\t\t\t: ctx.context.orgOptions.teams?.maximumTeams;\n\n\t\t\tconst maxTeamsReached = maximum ? existingTeams.length >= maximum : false;\n\t\t\tif (maxTeamsReached) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_TEAMS,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst { name, organizationId: _, ...additionalFields } = ctx.body;\n\n\t\t\tconst organization = await adapter.findOrganizationById(organizationId);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet teamData = {\n\t\t\t\tname,\n\t\t\t\torganizationId,\n\t\t\t\tcreatedAt: new Date(),\n\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t...additionalFields,\n\t\t\t};\n\n\t\t\t// Run beforeCreateTeam hook\n\t\t\tif (options?.organizationHooks?.beforeCreateTeam) {\n\t\t\t\tconst response = await options?.organizationHooks.beforeCreateTeam({\n\t\t\t\t\tteam: {\n\t\t\t\t\t\tname,\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t\t...additionalFields,\n\t\t\t\t\t},\n\t\t\t\t\tuser: session?.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\tteamData = {\n\t\t\t\t\t\t...teamData,\n\t\t\t\t\t\t...response.data,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst createdTeam = await adapter.createTeam(teamData);\n\n\t\t\t// Run afterCreateTeam hook\n\t\t\tif (options?.organizationHooks?.afterCreateTeam) {\n\t\t\t\tawait options?.organizationHooks.afterCreateTeam({\n\t\t\t\t\tteam: createdTeam,\n\t\t\t\t\tuser: session?.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json(createdTeam);\n\t\t},\n\t);\n};\n\nconst removeTeamBodySchema = z.object({\n\tteamId: z.string().meta({\n\t\tdescription: `The team ID of the team to remove. Eg: \"team-id\"`,\n\t}),\n\torganizationId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: `The organization ID which the team falls under. If not provided, it will default to the user's active organization. Eg: \"organization-id\"`,\n\t\t})\n\t\t.optional(),\n});\n\nexport const removeTeam = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/remove-team\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: removeTeamBodySchema,\n\t\t\tuse: [orgMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Remove a team from an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Team removed successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Confirmation message indicating successful removal\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [\"Team removed successfully.\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"message\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.organizationId || session?.session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\tbody: {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (!session && (ctx.request || ctx.headers)) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tif (session) {\n\t\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\t\tuserId: session.user.id,\n\t\t\t\t\torganizationId,\n\t\t\t\t});\n\n\t\t\t\tif (!member || session.session?.activeTeamId === ctx.body.teamId) {\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_TEAM,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst canRemove = await hasPermission(\n\t\t\t\t\t{\n\t\t\t\t\t\trole: member.role,\n\t\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\tteam: [\"delete\"],\n\t\t\t\t\t\t},\n\t\t\t\t\t\torganizationId,\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t);\n\n\t\t\t\tif (!canRemove) {\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_DELETE_TEAMS_IN_THIS_ORGANIZATION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst team = await adapter.findTeamById({\n\t\t\t\tteamId: ctx.body.teamId,\n\t\t\t\torganizationId,\n\t\t\t});\n\t\t\tif (!team || team.organizationId !== organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (!ctx.context.orgOptions.teams?.allowRemovingAllTeams) {\n\t\t\t\tconst teams = await adapter.listTeams(organizationId);\n\t\t\t\tif (teams.length <= 1) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.UNABLE_TO_REMOVE_LAST_TEAM,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(organizationId);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run beforeDeleteTeam hook\n\t\t\tif (options?.organizationHooks?.beforeDeleteTeam) {\n\t\t\t\tawait options?.organizationHooks.beforeDeleteTeam({\n\t\t\t\t\tteam,\n\t\t\t\t\tuser: session?.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait adapter.deleteTeam(team.id);\n\n\t\t\t// Run afterDeleteTeam hook\n\t\t\tif (options?.organizationHooks?.afterDeleteTeam) {\n\t\t\t\tawait options?.organizationHooks.afterDeleteTeam({\n\t\t\t\t\tteam,\n\t\t\t\t\tuser: session?.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({ message: \"Team removed successfully.\" });\n\t\t},\n\t);\n\nexport const updateTeam = <O extends OrganizationOptions>(options: O) => {\n\tconst additionalFieldsSchema = toZodSchema({\n\t\tfields: options?.schema?.team?.additionalFields ?? {},\n\t\tisClientSide: true,\n\t});\n\n\ttype Body = {\n\t\tteamId: string;\n\t\tdata: Partial<\n\t\t\tPrettifyDeep<\n\t\t\t\tOmit<z.infer<typeof teamSchema>, \"id\" | \"createdAt\" | \"updatedAt\">\n\t\t\t> &\n\t\t\t\tInferAdditionalFieldsFromPluginOptions<\"team\", O>\n\t\t>;\n\t};\n\n\treturn createAuthEndpoint(\n\t\t\"/organization/update-team\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: z.object({\n\t\t\t\tteamId: z.string().meta({\n\t\t\t\t\tdescription: `The ID of the team to be updated. Eg: \"team-id\"`,\n\t\t\t\t}),\n\t\t\t\tdata: z\n\t\t\t\t\t.object({\n\t\t\t\t\t\t...teamSchema.shape,\n\t\t\t\t\t\t...additionalFieldsSchema.shape,\n\t\t\t\t\t})\n\t\t\t\t\t.partial(),\n\t\t\t}),\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\t$Infer: { body: {} as Body },\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Update an existing team in an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Team updated successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the updated team\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Updated name of the team\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"ID of the organization the team belongs to\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Timestamp when the team was created\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Timestamp when the team was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\"name\",\n\t\t\t\t\t\t\t\t\t\t\t\"organizationId\",\n\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst organizationId =\n\t\t\t\tctx.body.data.organizationId || session.session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\tstatus: 400,\n\t\t\t\t\tbody: {\n\t\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId,\n\t\t\t});\n\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_TEAM,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canUpdate = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: member.role,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tteam: [\"update\"],\n\t\t\t\t\t},\n\t\t\t\t\torganizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!canUpdate) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_TEAM,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst team = await adapter.findTeamById({\n\t\t\t\tteamId: ctx.body.teamId,\n\t\t\t\torganizationId,\n\t\t\t});\n\n\t\t\tif (!team || team.organizationId !== organizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst { name, organizationId: __, ...additionalFields } = ctx.body.data;\n\n\t\t\tconst organization = await adapter.findOrganizationById(organizationId);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst updates = {\n\t\t\t\tname,\n\t\t\t\t...additionalFields,\n\t\t\t};\n\n\t\t\t// Run beforeUpdateTeam hook\n\t\t\tif (options?.organizationHooks?.beforeUpdateTeam) {\n\t\t\t\tconst response = await options?.organizationHooks.beforeUpdateTeam({\n\t\t\t\t\tteam,\n\t\t\t\t\tupdates,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\t// Allow the hook to modify the updates\n\t\t\t\t\tconst modifiedUpdates = response.data;\n\t\t\t\t\tconst updatedTeam = await adapter.updateTeam(\n\t\t\t\t\t\tteam.id,\n\t\t\t\t\t\tmodifiedUpdates,\n\t\t\t\t\t);\n\n\t\t\t\t\t// Run afterUpdateTeam hook\n\t\t\t\t\tif (options?.organizationHooks?.afterUpdateTeam) {\n\t\t\t\t\t\tawait options?.organizationHooks.afterUpdateTeam({\n\t\t\t\t\t\t\tteam: updatedTeam,\n\t\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t\t\torganization,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ctx.json(updatedTeam);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst updatedTeam = await adapter.updateTeam(team.id, updates);\n\n\t\t\t// Run afterUpdateTeam hook\n\t\t\tif (options?.organizationHooks?.afterUpdateTeam) {\n\t\t\t\tawait options?.organizationHooks.afterUpdateTeam({\n\t\t\t\t\tteam: updatedTeam,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json(updatedTeam);\n\t\t},\n\t);\n};\n\nconst listOrganizationTeamsQuerySchema = z.optional(\n\tz.object({\n\t\torganizationId: z\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription: `The organization ID which the teams are under to list. Defaults to the users active organization. Eg: \"organization-id\"`,\n\t\t\t})\n\t\t\t.optional(),\n\t}),\n);\n\nexport const listOrganizationTeams = <O extends OrganizationOptions>(\n\toptions: O,\n) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/list-teams\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: listOrganizationTeamsQuerySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"List all teams in an organization\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Teams retrieved successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the team\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Name of the team\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"ID of the organization the team belongs to\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Timestamp when the team was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the team was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"organizationId\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\"Array of team objects within the organization\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst organizationId =\n\t\t\t\tctx.query?.organizationId || session?.session.activeOrganizationId;\n\t\t\tif (!organizationId) {\n\t\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: organizationId || \"\",\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_ACCESS_THIS_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst teams = await adapter.listTeams(organizationId);\n\t\t\treturn ctx.json(teams);\n\t\t},\n\t);\n\nconst setActiveTeamBodySchema = z.object({\n\tteamId: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"The team id to set as active. It can be null to unset the active team\",\n\t\t})\n\t\t.nullable()\n\t\t.optional(),\n});\n\nexport const setActiveTeam = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/set-active-team\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: setActiveTeamBodySchema,\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgSessionMiddleware, orgMiddleware],\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Set the active team\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The team\",\n\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Team\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst adapter = getOrgAdapter(ctx.context, ctx.context.orgOptions);\n\t\t\tconst session = ctx.context.session;\n\n\t\t\tif (ctx.body.teamId === null) {\n\t\t\t\tconst sessionTeamId = session.session.activeTeamId;\n\t\t\t\tif (!sessionTeamId) {\n\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t}\n\n\t\t\t\tconst updatedSession = await adapter.setActiveTeam(\n\t\t\t\t\tsession.session.token,\n\t\t\t\t\tnull,\n\t\t\t\t\tctx,\n\t\t\t\t);\n\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession: updatedSession,\n\t\t\t\t\tuser: session.user,\n\t\t\t\t});\n\n\t\t\t\treturn ctx.json(null);\n\t\t\t}\n\n\t\t\tlet teamId: string;\n\n\t\t\tif (!ctx.body.teamId) {\n\t\t\t\tconst sessionTeamId = session.session.activeTeamId;\n\t\t\t\tif (!sessionTeamId) {\n\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t} else {\n\t\t\t\t\tteamId = sessionTeamId;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tteamId = ctx.body.teamId;\n\t\t\t}\n\n\t\t\tconst team = await adapter.findTeamById({ teamId });\n\n\t\t\tif (!team) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst member = await adapter.findTeamMember({\n\t\t\t\tteamId,\n\t\t\t\tuserId: session.user.id,\n\t\t\t});\n\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_TEAM,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst updatedSession = await adapter.setActiveTeam(\n\t\t\t\tsession.session.token,\n\t\t\t\tteam.id,\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\tsession: updatedSession,\n\t\t\t\tuser: session.user,\n\t\t\t});\n\n\t\t\treturn ctx.json(team);\n\t\t},\n\t);\n\nexport const listUserTeams = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/list-user-teams\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"List all teams that the current user is a part of.\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Teams retrieved successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The team\",\n\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Team\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\"Array of team objects within the organization\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst adapter = getOrgAdapter(ctx.context, ctx.context.orgOptions);\n\t\t\tconst teams = await adapter.listTeamsByUser({\n\t\t\t\tuserId: session.user.id,\n\t\t\t});\n\n\t\t\treturn ctx.json(teams);\n\t\t},\n\t);\n\nconst listTeamMembersQuerySchema = z.optional(\n\tz.object({\n\t\tteamId: z.string().optional().meta({\n\t\t\tdescription:\n\t\t\t\t\"The team whose members we should return. If this is not provided the members of the current active team get returned.\",\n\t\t}),\n\t}),\n);\n\nexport const listTeamMembers = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/list-team-members\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\tquery: listTeamMembersQuerySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"List the members of the given team.\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Teams retrieved successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The team member\",\n\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the team member\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The user ID of the team member\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tteamId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The team ID of the team the team member is in\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the team member was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequired: [\"id\", \"userId\", \"teamId\", \"createdAt\"],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tdescription: \"Array of team member objects within the team\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst adapter = getOrgAdapter(ctx.context, ctx.context.orgOptions);\n\t\t\tlet teamId = ctx.query?.teamId || session?.session.activeTeamId;\n\t\t\tif (!teamId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.YOU_DO_NOT_HAVE_AN_ACTIVE_TEAM,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst member = await adapter.findTeamMember({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\tteamId,\n\t\t\t});\n\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_TEAM,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst members = await adapter.listTeamMembers({\n\t\t\t\tteamId,\n\t\t\t});\n\t\t\treturn ctx.json(members);\n\t\t},\n\t);\n\nconst addTeamMemberBodySchema = z.object({\n\tteamId: z.string().meta({\n\t\tdescription: \"The team the user should be a member of.\",\n\t}),\n\n\tuserId: z.coerce.string().meta({\n\t\tdescription:\n\t\t\t\"The user Id which represents the user to be added as a member.\",\n\t}),\n});\n\nexport const addTeamMember = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/add-team-member\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: addTeamMemberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"The newly created member\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Team member created successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The team member\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the team member\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The user ID of the team member\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tteamId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"The team ID of the team the team member is in\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the team member was created\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"id\", \"userId\", \"teamId\", \"createdAt\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst adapter = getOrgAdapter(ctx.context, ctx.context.orgOptions);\n\n\t\t\tif (!session.session.activeOrganizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst currentMember = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: session.session.activeOrganizationId,\n\t\t\t});\n\n\t\t\tif (!currentMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canUpdateMember = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: currentMember.role,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tmember: [\"update\"],\n\t\t\t\t\t},\n\t\t\t\t\torganizationId: session.session.activeOrganizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!canUpdateMember) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_TEAM_MEMBER,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst toBeAddedMember = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: ctx.body.userId,\n\t\t\t\torganizationId: session.session.activeOrganizationId,\n\t\t\t});\n\n\t\t\tif (!toBeAddedMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst team = await adapter.findTeamById({\n\t\t\t\tteamId: ctx.body.teamId,\n\t\t\t\torganizationId: session.session.activeOrganizationId,\n\t\t\t});\n\n\t\t\tif (!team) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(\n\t\t\t\tsession.session.activeOrganizationId,\n\t\t\t);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst userBeingAdded = await ctx.context.internalAdapter.findUserById(\n\t\t\t\tctx.body.userId,\n\t\t\t);\n\t\t\tif (!userBeingAdded) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"User not found\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run beforeAddTeamMember hook\n\t\t\tif (options?.organizationHooks?.beforeAddTeamMember) {\n\t\t\t\tconst response = await options?.organizationHooks.beforeAddTeamMember({\n\t\t\t\t\tteamMember: {\n\t\t\t\t\t\tteamId: ctx.body.teamId,\n\t\t\t\t\t\tuserId: ctx.body.userId,\n\t\t\t\t\t},\n\t\t\t\t\tteam,\n\t\t\t\t\tuser: userBeingAdded,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t\tif (response && typeof response === \"object\" && \"data\" in response) {\n\t\t\t\t\t// Allow the hook to modify the data\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst teamMember = await adapter.findOrCreateTeamMember({\n\t\t\t\tteamId: ctx.body.teamId,\n\t\t\t\tuserId: ctx.body.userId,\n\t\t\t});\n\n\t\t\t// Run afterAddTeamMember hook\n\t\t\tif (options?.organizationHooks?.afterAddTeamMember) {\n\t\t\t\tawait options?.organizationHooks.afterAddTeamMember({\n\t\t\t\t\tteamMember,\n\t\t\t\t\tteam,\n\t\t\t\t\tuser: userBeingAdded,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json(teamMember);\n\t\t},\n\t);\n\nconst removeTeamMemberBodySchema = z.object({\n\tteamId: z.string().meta({\n\t\tdescription: \"The team the user should be removed from.\",\n\t}),\n\n\tuserId: z.coerce.string().meta({\n\t\tdescription: \"The user which should be removed from the team.\",\n\t}),\n});\n\nexport const removeTeamMember = <O extends OrganizationOptions>(options: O) =>\n\tcreateAuthEndpoint(\n\t\t\"/organization/remove-team-member\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: removeTeamMemberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Remove a member from a team\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Team member removed successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Confirmation message indicating successful removal\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [\"Team member removed successfully.\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"message\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\trequireHeaders: true,\n\t\t\tuse: [orgMiddleware, orgSessionMiddleware],\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst adapter = getOrgAdapter(ctx.context, ctx.context.orgOptions);\n\n\t\t\tif (!session.session.activeOrganizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst currentMember = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\torganizationId: session.session.activeOrganizationId,\n\t\t\t});\n\n\t\t\tif (!currentMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst canDeleteMember = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: currentMember.role,\n\t\t\t\t\toptions: ctx.context.orgOptions,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tmember: [\"delete\"],\n\t\t\t\t\t},\n\t\t\t\t\torganizationId: session.session.activeOrganizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!canDeleteMember) {\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.YOU_ARE_NOT_ALLOWED_TO_REMOVE_A_TEAM_MEMBER,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst toBeAddedMember = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: ctx.body.userId,\n\t\t\t\torganizationId: session.session.activeOrganizationId,\n\t\t\t});\n\n\t\t\tif (!toBeAddedMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst team = await adapter.findTeamById({\n\t\t\t\tteamId: ctx.body.teamId,\n\t\t\t\torganizationId: session.session.activeOrganizationId,\n\t\t\t});\n\n\t\t\tif (!team) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.TEAM_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst organization = await adapter.findOrganizationById(\n\t\t\t\tsession.session.activeOrganizationId,\n\t\t\t);\n\t\t\tif (!organization) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.ORGANIZATION_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst userBeingRemoved = await ctx.context.internalAdapter.findUserById(\n\t\t\t\tctx.body.userId,\n\t\t\t);\n\t\t\tif (!userBeingRemoved) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"User not found\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst teamMember = await adapter.findTeamMember({\n\t\t\t\tteamId: ctx.body.teamId,\n\t\t\t\tuserId: ctx.body.userId,\n\t\t\t});\n\n\t\t\tif (!teamMember) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_TEAM,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Run beforeRemoveTeamMember hook\n\t\t\tif (options?.organizationHooks?.beforeRemoveTeamMember) {\n\t\t\t\tawait options?.organizationHooks.beforeRemoveTeamMember({\n\t\t\t\t\tteamMember,\n\t\t\t\t\tteam,\n\t\t\t\t\tuser: userBeingRemoved,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait adapter.removeTeamMember({\n\t\t\t\tteamId: ctx.body.teamId,\n\t\t\t\tuserId: ctx.body.userId,\n\t\t\t});\n\n\t\t\t// Run afterRemoveTeamMember hook\n\t\t\tif (options?.organizationHooks?.afterRemoveTeamMember) {\n\t\t\t\tawait options?.organizationHooks.afterRemoveTeamMember({\n\t\t\t\t\tteamMember,\n\t\t\t\t\tteam,\n\t\t\t\t\tuser: userBeingRemoved,\n\t\t\t\t\torganization,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({ message: \"Team member removed successfully.\" });\n\t\t},\n\t);\n", "import type { AuthContext, BetterAuthPlugin } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { getSessionFromCtx } from \"../../api\";\nimport { shimContext } from \"../../utils/shim\";\nimport type { AccessControl } from \"../access\";\nimport type { defaultStatements } from \"./access\";\nimport { defaultRoles } from \"./access\";\nimport { getOrgAdapter } from \"./adapter\";\nimport { orgSessionMiddleware } from \"./call\";\nimport { ORGANIZATION_ERROR_CODES } from \"./error-codes\";\nimport { hasPermission } from \"./has-permission\";\nimport {\n\tcreateOrgRole,\n\tdeleteOrgRole,\n\tgetOrgRole,\n\tlistOrgRoles,\n\tupdateOrgRole,\n} from \"./routes/crud-access-control\";\nimport {\n\tacceptInvitation,\n\tcancelInvitation,\n\tcreateInvitation,\n\tgetInvitation,\n\tlistInvitations,\n\tlistUserInvitations,\n\trejectInvitation,\n} from \"./routes/crud-invites\";\nimport {\n\taddMember,\n\tgetActiveMember,\n\tgetActiveMemberRole,\n\tleaveOrganization,\n\tlistMembers,\n\tremoveMember,\n\tupdateMemberRole,\n} from \"./routes/crud-members\";\nimport {\n\tcheckOrganizationSlug,\n\tcreateOrganization,\n\tdeleteOrganization,\n\tgetFullOrganization,\n\tlistOrganizations,\n\tsetActiveOrganization,\n\tupdateOrganization,\n} from \"./routes/crud-org\";\nimport {\n\taddTeamMember,\n\tcreateTeam,\n\tlistOrganizationTeams,\n\tlistTeamMembers,\n\tlistUserTeams,\n\tremoveTeam,\n\tremoveTeamMember,\n\tsetActiveTeam,\n\tupdateTeam,\n} from \"./routes/crud-team\";\nimport type {\n\tInferInvitation,\n\tInferMember,\n\tInferOrganization,\n\tInferTeam,\n\tOrganizationSchema,\n\tTeam,\n\tTeamMember,\n} from \"./schema\";\nimport type { OrganizationOptions } from \"./types\";\n\nexport function parseRoles(roles: string | string[]): string {\n\treturn Array.isArray(roles) ? roles.join(\",\") : roles;\n}\n\nexport type DynamicAccessControlEndpoints<O extends OrganizationOptions> = {\n\tcreateOrgRole: ReturnType<typeof createOrgRole<O>>;\n\tdeleteOrgRole: ReturnType<typeof deleteOrgRole<O>>;\n\tlistOrgRoles: ReturnType<typeof listOrgRoles<O>>;\n\tgetOrgRole: ReturnType<typeof getOrgRole<O>>;\n\tupdateOrgRole: ReturnType<typeof updateOrgRole<O>>;\n};\n\nexport type TeamEndpoints<O extends OrganizationOptions> = {\n\tcreateTeam: ReturnType<typeof createTeam<O>>;\n\tlistOrganizationTeams: ReturnType<typeof listOrganizationTeams<O>>;\n\tremoveTeam: ReturnType<typeof removeTeam<O>>;\n\tupdateTeam: ReturnType<typeof updateTeam<O>>;\n\tsetActiveTeam: ReturnType<typeof setActiveTeam<O>>;\n\tlistUserTeams: ReturnType<typeof listUserTeams<O>>;\n\tlistTeamMembers: ReturnType<typeof listTeamMembers<O>>;\n\taddTeamMember: ReturnType<typeof addTeamMember<O>>;\n\tremoveTeamMember: ReturnType<typeof removeTeamMember<O>>;\n};\n\nexport type OrganizationEndpoints<O extends OrganizationOptions> = {\n\tcreateOrganization: ReturnType<typeof createOrganization<O>>;\n\tupdateOrganization: ReturnType<typeof updateOrganization<O>>;\n\tdeleteOrganization: ReturnType<typeof deleteOrganization<O>>;\n\tsetActiveOrganization: ReturnType<typeof setActiveOrganization<O>>;\n\tgetFullOrganization: ReturnType<typeof getFullOrganization<O>>;\n\tlistOrganizations: ReturnType<typeof listOrganizations<O>>;\n\tcreateInvitation: ReturnType<typeof createInvitation<O>>;\n\tcancelInvitation: ReturnType<typeof cancelInvitation<O>>;\n\tacceptInvitation: ReturnType<typeof acceptInvitation<O>>;\n\tgetInvitation: ReturnType<typeof getInvitation<O>>;\n\trejectInvitation: ReturnType<typeof rejectInvitation<O>>;\n\tlistInvitations: ReturnType<typeof listInvitations<O>>;\n\tgetActiveMember: ReturnType<typeof getActiveMember<O>>;\n\tcheckOrganizationSlug: ReturnType<typeof checkOrganizationSlug<O>>;\n\taddMember: ReturnType<typeof addMember<O>>;\n\tremoveMember: ReturnType<typeof removeMember<O>>;\n\tupdateMemberRole: ReturnType<typeof updateMemberRole<O>>;\n\tleaveOrganization: ReturnType<typeof leaveOrganization<O>>;\n\tlistUserInvitations: ReturnType<typeof listUserInvitations<O>>;\n\tlistMembers: ReturnType<typeof listMembers<O>>;\n\tgetActiveMemberRole: ReturnType<typeof getActiveMemberRole<O>>;\n\thasPermission: ReturnType<typeof createHasPermission<O>>;\n};\n\nconst createHasPermissionBodySchema = z\n\t.object({\n\t\torganizationId: z.string().optional(),\n\t})\n\t.and(\n\t\tz.union([\n\t\t\tz.object({\n\t\t\t\tpermission: z.record(z.string(), z.array(z.string())),\n\t\t\t\tpermissions: z.undefined(),\n\t\t\t}),\n\t\t\tz.object({\n\t\t\t\tpermission: z.undefined(),\n\t\t\t\tpermissions: z.record(z.string(), z.array(z.string())),\n\t\t\t}),\n\t\t]),\n\t);\n\nconst createHasPermission = <O extends OrganizationOptions>(options: O) => {\n\ttype DefaultStatements = typeof defaultStatements;\n\ttype Statements =\n\t\tO[\"ac\"] extends AccessControl<infer S> ? S : DefaultStatements;\n\ttype PermissionType = {\n\t\t[key in keyof Statements]?: Array<\n\t\t\tStatements[key] extends readonly unknown[]\n\t\t\t\t? Statements[key][number]\n\t\t\t\t: never\n\t\t>;\n\t};\n\ttype PermissionExclusive =\n\t\t| {\n\t\t\t\t/**\n\t\t\t\t * @deprecated Use `permissions` instead\n\t\t\t\t */\n\t\t\t\tpermission: PermissionType;\n\t\t\t\tpermissions?: never | undefined;\n\t\t  }\n\t\t| {\n\t\t\t\tpermissions: PermissionType;\n\t\t\t\tpermission?: never | undefined;\n\t\t  };\n\n\treturn createAuthEndpoint(\n\t\t\"/organization/has-permission\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\trequireHeaders: true,\n\t\t\tbody: createHasPermissionBodySchema,\n\t\t\tuse: [orgSessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as PermissionExclusive & {\n\t\t\t\t\t\torganizationId?: string | undefined;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Check if the user has permission\",\n\t\t\t\t\trequestBody: {\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tpermission: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The permission to check\",\n\t\t\t\t\t\t\t\t\t\t\tdeprecated: true,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The permission to check\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"permissions\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"success\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst activeOrganizationId =\n\t\t\t\tctx.body.organizationId ||\n\t\t\t\tctx.context.session.session.activeOrganizationId;\n\t\t\tif (!activeOrganizationId) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: ORGANIZATION_ERROR_CODES.NO_ACTIVE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst adapter = getOrgAdapter<O>(ctx.context, options);\n\t\t\tconst member = await adapter.findMemberByOrgId({\n\t\t\t\tuserId: ctx.context.session.user.id,\n\t\t\t\torganizationId: activeOrganizationId,\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tORGANIZATION_ERROR_CODES.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst result = await hasPermission(\n\t\t\t\t{\n\t\t\t\t\trole: member.role,\n\t\t\t\t\toptions: options || {},\n\t\t\t\t\tpermissions: (ctx.body.permissions ?? ctx.body.permission) as any,\n\t\t\t\t\torganizationId: activeOrganizationId,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\treturn ctx.json({\n\t\t\t\terror: null,\n\t\t\t\tsuccess: result,\n\t\t\t});\n\t\t},\n\t);\n};\n\nexport type OrganizationPlugin<O extends OrganizationOptions> = {\n\tid: \"organization\";\n\tendpoints: OrganizationEndpoints<O> &\n\t\t(O extends { teams: { enabled: true } } ? TeamEndpoints<O> : {}) &\n\t\t(O extends { dynamicAccessControl: { enabled: true } }\n\t\t\t? DynamicAccessControlEndpoints<O>\n\t\t\t: {});\n\tschema: OrganizationSchema<O>;\n\t$Infer: {\n\t\tOrganization: InferOrganization<O>;\n\t\tInvitation: InferInvitation<O>;\n\t\tMember: InferMember<O>;\n\t\tTeam: O[\"teams\"] extends { enabled: true } ? Team : any;\n\t\tTeamMember: O[\"teams\"] extends { enabled: true } ? TeamMember : any;\n\t\tActiveOrganization: O[\"teams\"] extends { enabled: true }\n\t\t\t? {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\tteams: InferTeam<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>\n\t\t\t: {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>;\n\t};\n\t$ERROR_CODES: typeof ORGANIZATION_ERROR_CODES;\n\toptions: NoInfer<O>;\n};\n\n/**\n * Organization plugin for Better Auth. Organization allows you to create teams, members,\n * and manage access control for your users.\n *\n * @example\n * ```ts\n * const auth = betterAuth({\n *  plugins: [\n *    organization({\n *      allowUserToCreateOrganization: true,\n *    }),\n *  ],\n * });\n * ```\n */\nexport function organization<\n\tO extends OrganizationOptions & {\n\t\tteams: { enabled: true };\n\t},\n>(\n\toptions?: O | undefined,\n): {\n\tid: \"organization\";\n\tendpoints: OrganizationEndpoints<O> & TeamEndpoints<O>;\n\tschema: OrganizationSchema<O>;\n\t$Infer: {\n\t\tOrganization: InferOrganization<O>;\n\t\tInvitation: InferInvitation<O>;\n\t\tMember: InferMember<O>;\n\t\tTeam: O[\"teams\"] extends { enabled: true } ? Team : unknown;\n\t\tTeamMember: O[\"teams\"] extends { enabled: true } ? TeamMember : unknown;\n\t\tActiveOrganization: O[\"teams\"] extends { enabled: true }\n\t\t\t? {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\tteams: InferTeam<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>\n\t\t\t: {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>;\n\t};\n\t$ERROR_CODES: typeof ORGANIZATION_ERROR_CODES;\n\toptions: NoInfer<O>;\n};\nexport function organization<\n\tO extends OrganizationOptions & {\n\t\tteams: { enabled: true };\n\t\tdynamicAccessControl: { enabled: true };\n\t},\n>(\n\toptions?: O | undefined,\n): {\n\tid: \"organization\";\n\tendpoints: OrganizationEndpoints<O> &\n\t\tTeamEndpoints<O> &\n\t\tDynamicAccessControlEndpoints<O>;\n\tschema: OrganizationSchema<O>;\n\t$Infer: {\n\t\tOrganization: InferOrganization<O>;\n\t\tInvitation: InferInvitation<O>;\n\t\tMember: InferMember<O>;\n\t\tTeam: O[\"teams\"] extends { enabled: true } ? Team : any;\n\t\tTeamMember: O[\"teams\"] extends { enabled: true } ? TeamMember : any;\n\t\tActiveOrganization: O[\"teams\"] extends { enabled: true }\n\t\t\t? {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\tteams: InferTeam<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>\n\t\t\t: {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>;\n\t};\n\t$ERROR_CODES: typeof ORGANIZATION_ERROR_CODES;\n\toptions: NoInfer<O>;\n};\nexport function organization<\n\tO extends OrganizationOptions & {\n\t\tdynamicAccessControl: { enabled: true };\n\t},\n>(\n\toptions?: O | undefined,\n): {\n\tid: \"organization\";\n\tendpoints: OrganizationEndpoints<O> & DynamicAccessControlEndpoints<O>;\n\tschema: OrganizationSchema<O>;\n\t$Infer: {\n\t\tOrganization: InferOrganization<O>;\n\t\tInvitation: InferInvitation<O>;\n\t\tMember: InferMember<O>;\n\t\tTeam: O[\"teams\"] extends { enabled: true } ? Team : any;\n\t\tTeamMember: O[\"teams\"] extends { enabled: true } ? TeamMember : any;\n\t\tActiveOrganization: O[\"teams\"] extends { enabled: true }\n\t\t\t? {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\tteams: InferTeam<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>\n\t\t\t: {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>;\n\t};\n\t$ERROR_CODES: typeof ORGANIZATION_ERROR_CODES;\n\toptions: NoInfer<O>;\n};\nexport function organization<O extends OrganizationOptions>(\n\toptions?: O | undefined,\n): {\n\tid: \"organization\";\n\tendpoints: OrganizationEndpoints<O>;\n\tschema: OrganizationSchema<O>;\n\t$Infer: {\n\t\tOrganization: InferOrganization<O>;\n\t\tInvitation: InferInvitation<O>;\n\t\tMember: InferMember<O>;\n\t\tTeam: O[\"teams\"] extends { enabled: true } ? Team : any;\n\t\tTeamMember: O[\"teams\"] extends { enabled: true } ? TeamMember : any;\n\t\tActiveOrganization: O[\"teams\"] extends { enabled: true }\n\t\t\t? {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\tteams: InferTeam<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>\n\t\t\t: {\n\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t} & InferOrganization<O, false>;\n\t};\n\t$ERROR_CODES: typeof ORGANIZATION_ERROR_CODES;\n\toptions: NoInfer<O>;\n};\nexport function organization<O extends OrganizationOptions>(\n\toptions?: O | undefined,\n): any {\n\tlet endpoints = {\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/create`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.createOrganization`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.create`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-create)\n\t\t */\n\t\tcreateOrganization: createOrganization(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/update`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.updateOrganization`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.update`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-update)\n\t\t */\n\t\tupdateOrganization: updateOrganization(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/delete`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.deleteOrganization`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.delete`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-delete)\n\t\t */\n\t\tdeleteOrganization: deleteOrganization(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/set-active`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.setActiveOrganization`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.setActive`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-set-active)\n\t\t */\n\t\tsetActiveOrganization: setActiveOrganization(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/get-full-organization`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.getFullOrganization`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.getFullOrganization`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-get-full-organization)\n\t\t */\n\t\tgetFullOrganization: getFullOrganization(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/list`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.listOrganizations`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.list`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-list)\n\t\t */\n\t\tlistOrganizations: listOrganizations(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/invite-member`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.createInvitation`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.inviteMember`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-invite-member)\n\t\t */\n\t\tcreateInvitation: createInvitation(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/cancel-invitation`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.cancelInvitation`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.cancelInvitation`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-cancel-invitation)\n\t\t */\n\t\tcancelInvitation: cancelInvitation(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/accept-invitation`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.acceptInvitation`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.acceptInvitation`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-accept-invitation)\n\t\t */\n\t\tacceptInvitation: acceptInvitation(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/get-invitation`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.getInvitation`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.getInvitation`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-get-invitation)\n\t\t */\n\t\tgetInvitation: getInvitation(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/reject-invitation`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.rejectInvitation`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.rejectInvitation`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-reject-invitation)\n\t\t */\n\t\trejectInvitation: rejectInvitation(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/list-invitations`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.listInvitations`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.listInvitations`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-list-invitations)\n\t\t */\n\t\tlistInvitations: listInvitations(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/get-active-member`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.getActiveMember`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.getActiveMember`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-get-active-member)\n\t\t */\n\t\tgetActiveMember: getActiveMember(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/check-slug`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.checkOrganizationSlug`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.checkSlug`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-check-slug)\n\t\t */\n\t\tcheckOrganizationSlug: checkOrganizationSlug(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/add-member`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.addMember`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-add-member)\n\t\t */\n\n\t\taddMember: addMember<O>(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/remove-member`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.removeMember`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.removeMember`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-remove-member)\n\t\t */\n\t\tremoveMember: removeMember(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/update-member-role`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.updateMemberRole`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.updateMemberRole`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-update-member-role)\n\t\t */\n\t\tupdateMemberRole: updateMemberRole(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/leave`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.leaveOrganization`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.leave`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-leave)\n\t\t */\n\t\tleaveOrganization: leaveOrganization(options as O),\n\t\tlistUserInvitations: listUserInvitations(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/list-members`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.listMembers`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.listMembers`\n\t\t */\n\t\tlistMembers: listMembers(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/get-active-member-role`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.getActiveMemberRole`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.getActiveMemberRole`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-get-active-member-role)\n\t\t */\n\t\tgetActiveMemberRole: getActiveMemberRole(options as O),\n\t};\n\tconst teamSupport = options?.teams?.enabled;\n\tconst teamEndpoints = {\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/create-team`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.createTeam`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.createTeam`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-create-team)\n\t\t */\n\t\tcreateTeam: createTeam(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/list-teams`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.listOrganizationTeams`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.listTeams`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-list-teams)\n\t\t */\n\t\tlistOrganizationTeams: listOrganizationTeams(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/remove-team`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.removeTeam`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.removeTeam`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-remove-team)\n\t\t */\n\t\tremoveTeam: removeTeam(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/update-team`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.updateTeam`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.updateTeam`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-method-organization-update-team)\n\t\t */\n\t\tupdateTeam: updateTeam(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/set-active-team`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.setActiveTeam`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.setActiveTeam`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-set-active-team)\n\t\t */\n\t\tsetActiveTeam: setActiveTeam(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * GET `/organization/list-user-teams`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.listUserTeams`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.listUserTeams`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-set-active-team)\n\t\t */\n\t\tlistUserTeams: listUserTeams(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/list-team-members`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.listTeamMembers`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.listTeamMembers`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-set-active-team)\n\t\t */\n\t\tlistTeamMembers: listTeamMembers(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/add-team-member`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.addTeamMember`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.addTeamMember`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-add-team-member)\n\t\t */\n\t\taddTeamMember: addTeamMember(options as O),\n\t\t/**\n\t\t * ### Endpoint\n\t\t *\n\t\t * POST `/organization/remove-team-member`\n\t\t *\n\t\t * ### API Methods\n\t\t *\n\t\t * **server:**\n\t\t * `auth.api.removeTeamMember`\n\t\t *\n\t\t * **client:**\n\t\t * `authClient.organization.removeTeamMember`\n\t\t *\n\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/organization#api-remove-team-member)\n\t\t */\n\t\tremoveTeamMember: removeTeamMember(options as O),\n\t};\n\tif (teamSupport) {\n\t\tendpoints = {\n\t\t\t...endpoints,\n\t\t\t...teamEndpoints,\n\t\t};\n\t}\n\n\tconst dynamicAccessControlEndpoints = {\n\t\tcreateOrgRole: createOrgRole(options as O),\n\t\tdeleteOrgRole: deleteOrgRole(options as O),\n\t\tlistOrgRoles: listOrgRoles(options as O),\n\t\tgetOrgRole: getOrgRole(options as O),\n\t\tupdateOrgRole: updateOrgRole(options as O),\n\t};\n\tif (options?.dynamicAccessControl?.enabled) {\n\t\tendpoints = {\n\t\t\t...endpoints,\n\t\t\t...dynamicAccessControlEndpoints,\n\t\t};\n\t}\n\tconst roles = {\n\t\t...defaultRoles,\n\t\t...options?.roles,\n\t};\n\n\t// Build team schema in a way that never introduces undefined values when spreading\n\tconst teamSchema = teamSupport\n\t\t? ({\n\t\t\t\tteam: {\n\t\t\t\t\tmodelName: options?.schema?.team?.modelName,\n\t\t\t\t\tfields: {\n\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\tfieldName: options?.schema?.team?.fields?.name,\n\t\t\t\t\t\t},\n\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\treferences: {\n\t\t\t\t\t\t\t\tmodel: \"organization\",\n\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tfieldName: options?.schema?.team?.fields?.organizationId,\n\t\t\t\t\t\t\tindex: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\tfieldName: options?.schema?.team?.fields?.createdAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\tfieldName: options?.schema?.team?.fields?.updatedAt,\n\t\t\t\t\t\t\tonUpdate: () => new Date(),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t...(options?.schema?.team?.additionalFields || {}),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tteamMember: {\n\t\t\t\t\tmodelName: options?.schema?.teamMember?.modelName,\n\t\t\t\t\tfields: {\n\t\t\t\t\t\tteamId: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\treferences: {\n\t\t\t\t\t\t\t\tmodel: \"team\",\n\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tfieldName: options?.schema?.teamMember?.fields?.teamId,\n\t\t\t\t\t\t\tindex: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\treferences: {\n\t\t\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tfieldName: options?.schema?.teamMember?.fields?.userId,\n\t\t\t\t\t\t\tindex: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\tfieldName: options?.schema?.teamMember?.fields?.createdAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t} satisfies BetterAuthPluginDBSchema)\n\t\t: {};\n\n\tconst organizationRoleSchema = options?.dynamicAccessControl?.enabled\n\t\t? ({\n\t\t\t\torganizationRole: {\n\t\t\t\t\tfields: {\n\t\t\t\t\t\torganizationId: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\treferences: {\n\t\t\t\t\t\t\t\tmodel: \"organization\",\n\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tfieldName:\n\t\t\t\t\t\t\t\toptions?.schema?.organizationRole?.fields?.organizationId,\n\t\t\t\t\t\t\tindex: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t\trole: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\tfieldName: options?.schema?.organizationRole?.fields?.role,\n\t\t\t\t\t\t\tindex: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tpermission: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\tfieldName: options?.schema?.organizationRole?.fields?.permission,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\t\tdefaultValue: () => new Date(),\n\t\t\t\t\t\t\tfieldName: options?.schema?.organizationRole?.fields?.createdAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\tfieldName: options?.schema?.organizationRole?.fields?.updatedAt,\n\t\t\t\t\t\t\tonUpdate: () => new Date(),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t...(options?.schema?.organizationRole?.additionalFields || {}),\n\t\t\t\t\t},\n\t\t\t\t\tmodelName: options?.schema?.organizationRole?.modelName,\n\t\t\t\t},\n\t\t\t} satisfies BetterAuthPluginDBSchema)\n\t\t: {};\n\n\tconst schema = {\n\t\t...({\n\t\t\torganization: {\n\t\t\t\tmodelName: options?.schema?.organization?.modelName,\n\t\t\t\tfields: {\n\t\t\t\t\tname: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\tfieldName: options?.schema?.organization?.fields?.name,\n\t\t\t\t\t},\n\t\t\t\t\tslug: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tunique: true,\n\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\tfieldName: options?.schema?.organization?.fields?.slug,\n\t\t\t\t\t\tindex: true,\n\t\t\t\t\t},\n\t\t\t\t\tlogo: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tfieldName: options?.schema?.organization?.fields?.logo,\n\t\t\t\t\t},\n\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tfieldName: options?.schema?.organization?.fields?.createdAt,\n\t\t\t\t\t},\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tfieldName: options?.schema?.organization?.fields?.metadata,\n\t\t\t\t\t},\n\t\t\t\t\t...(options?.schema?.organization?.additionalFields || {}),\n\t\t\t\t},\n\t\t\t},\n\t\t} satisfies BetterAuthPluginDBSchema),\n\t\t...organizationRoleSchema,\n\t\t...teamSchema,\n\t\t...({\n\t\t\tmember: {\n\t\t\t\tmodelName: options?.schema?.member?.modelName,\n\t\t\t\tfields: {\n\t\t\t\t\torganizationId: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\treferences: {\n\t\t\t\t\t\t\tmodel: \"organization\",\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfieldName: options?.schema?.member?.fields?.organizationId,\n\t\t\t\t\t\tindex: true,\n\t\t\t\t\t},\n\t\t\t\t\tuserId: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tfieldName: options?.schema?.member?.fields?.userId,\n\t\t\t\t\t\treferences: {\n\t\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tindex: true,\n\t\t\t\t\t},\n\t\t\t\t\trole: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\tdefaultValue: \"member\",\n\t\t\t\t\t\tfieldName: options?.schema?.member?.fields?.role,\n\t\t\t\t\t},\n\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tfieldName: options?.schema?.member?.fields?.createdAt,\n\t\t\t\t\t},\n\t\t\t\t\t...(options?.schema?.member?.additionalFields || {}),\n\t\t\t\t},\n\t\t\t},\n\t\t\tinvitation: {\n\t\t\t\tmodelName: options?.schema?.invitation?.modelName,\n\t\t\t\tfields: {\n\t\t\t\t\torganizationId: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\treferences: {\n\t\t\t\t\t\t\tmodel: \"organization\",\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfieldName: options?.schema?.invitation?.fields?.organizationId,\n\t\t\t\t\t\tindex: true,\n\t\t\t\t\t},\n\t\t\t\t\temail: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\tfieldName: options?.schema?.invitation?.fields?.email,\n\t\t\t\t\t\tindex: true,\n\t\t\t\t\t},\n\t\t\t\t\trole: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\tfieldName: options?.schema?.invitation?.fields?.role,\n\t\t\t\t\t},\n\t\t\t\t\t...(teamSupport\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tteamId: {\n\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\t\t\t\tfieldName: options?.schema?.invitation?.fields?.teamId,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: {}),\n\t\t\t\t\tstatus: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tsortable: true,\n\t\t\t\t\t\tdefaultValue: \"pending\",\n\t\t\t\t\t\tfieldName: options?.schema?.invitation?.fields?.status,\n\t\t\t\t\t},\n\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tfieldName: options?.schema?.invitation?.fields?.expiresAt,\n\t\t\t\t\t},\n\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\ttype: \"date\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tfieldName: options?.schema?.invitation?.fields?.createdAt,\n\t\t\t\t\t\tdefaultValue: () => new Date(),\n\t\t\t\t\t},\n\t\t\t\t\tinviterId: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\treferences: {\n\t\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfieldName: options?.schema?.invitation?.fields?.inviterId,\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t},\n\t\t\t\t\t...(options?.schema?.invitation?.additionalFields || {}),\n\t\t\t\t},\n\t\t\t},\n\t\t} satisfies BetterAuthPluginDBSchema),\n\t};\n\n\t/**\n\t * the orgMiddleware type-asserts an empty object representing org options, roles, and a getSession function.\n\t * This `shimContext` function is used to add those missing properties to the context object.\n\t */\n\tconst api = shimContext(endpoints, {\n\t\torgOptions: options || {},\n\t\troles,\n\t\tgetSession: async (context: AuthContext) => {\n\t\t\t//@ts-expect-error\n\t\t\treturn await getSessionFromCtx(context);\n\t\t},\n\t});\n\n\treturn {\n\t\tid: \"organization\",\n\t\tendpoints: {\n\t\t\t...(api as OrganizationEndpoints<O>),\n\t\t\thasPermission: createHasPermission(options as O),\n\t\t},\n\t\tschema: {\n\t\t\t...(schema as BetterAuthPluginDBSchema),\n\t\t\tsession: {\n\t\t\t\tfields: {\n\t\t\t\t\tactiveOrganizationId: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tfieldName: options?.schema?.session?.fields?.activeOrganizationId,\n\t\t\t\t\t},\n\t\t\t\t\t...(teamSupport\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tactiveTeamId: {\n\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\t\t\t\tfieldName: options?.schema?.session?.fields?.activeTeamId,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: {}),\n\t\t\t\t} as unknown as O[\"teams\"] extends {\n\t\t\t\t\tenabled: true;\n\t\t\t\t}\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tactiveTeamId: {\n\t\t\t\t\t\t\t\ttype: \"string\";\n\t\t\t\t\t\t\t\trequired: false;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tactiveOrganizationId: {\n\t\t\t\t\t\t\t\ttype: \"string\";\n\t\t\t\t\t\t\t\trequired: false;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t: {\n\t\t\t\t\t\t\tactiveOrganizationId: {\n\t\t\t\t\t\t\t\ttype: \"string\";\n\t\t\t\t\t\t\t\trequired: false;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\t$Infer: {\n\t\t\tOrganization: {} as InferOrganization<O>,\n\t\t\tInvitation: {} as InferInvitation<O>,\n\t\t\tMember: {} as InferMember<O>,\n\t\t\tTeam: teamSupport ? ({} as Team) : ({} as any),\n\t\t\tTeamMember: teamSupport ? ({} as TeamMember) : ({} as any),\n\t\t\tActiveOrganization: {} as O[\"teams\"] extends { enabled: true }\n\t\t\t\t? {\n\t\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\t\tteams: InferTeam<O, false>[];\n\t\t\t\t\t} & InferOrganization<O, false>\n\t\t\t\t: {\n\t\t\t\t\t\tmembers: InferMember<O, false>[];\n\t\t\t\t\t\tinvitations: InferInvitation<O, false>[];\n\t\t\t\t\t} & InferOrganization<O, false>,\n\t\t},\n\t\t$ERROR_CODES: ORGANIZATION_ERROR_CODES,\n\t\toptions: options as NoInfer<O>,\n\t} satisfies BetterAuthPlugin;\n}\n", "import { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const PHONE_NUMBER_ERROR_CODES = defineErrorCodes({\n\tINVALID_PHONE_NUMBER: \"Invalid phone number\",\n\tPHONE_NUMBER_EXIST: \"Phone number already exists\",\n\tPHONE_NUMBER_NOT_EXIST: \"phone number isn't registered\",\n\tINVALID_PHONE_NUMBER_OR_PASSWORD: \"Invalid phone number or password\",\n\tUNEXPECTED_ERROR: \"Unexpected error\",\n\tOTP_NOT_FOUND: \"OTP not found\",\n\tOTP_EXPIRED: \"OTP expired\",\n\tINVALID_OTP: \"Invalid OTP\",\n\tPHONE_NUMBER_NOT_VERIFIED: \"Phone number not verified\",\n\tPHONE_NUMBER_CANNOT_BE_UPDATED: \"Phone number cannot be updated\",\n\tSEND_OTP_NOT_IMPLEMENTED: \"sendOTP not implemented\",\n\tTOO_MANY_ATTEMPTS: \"Too many attempts\",\n});\n", "import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { getSessionFromCtx } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { generateRandomString } from \"../../crypto/random\";\nimport type { User } from \"../../types\";\nimport { getDate } from \"../../utils/date\";\nimport { PHONE_NUMBER_ERROR_CODES } from \"./error-codes\";\nimport type { PhoneNumberOptions, UserWithPhoneNumber } from \"./types\";\n\nexport type RequiredPhoneNumberOptions = PhoneNumberOptions & {\n\texpiresIn: number;\n\totpLength: number;\n\tphoneNumber: string;\n\tphoneNumberVerified: string;\n\tcode: string;\n\tcreatedAt: string;\n};\n\nconst signInPhoneNumberBodySchema = z.object({\n\tphoneNumber: z.string().meta({\n\t\tdescription: 'Phone number to sign in. Eg: \"+1234567890\"',\n\t}),\n\tpassword: z.string().meta({\n\t\tdescription: \"Password to use for sign in.\",\n\t}),\n\trememberMe: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"Remember the session. Eg: true\",\n\t\t})\n\t\t.optional(),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/sign-in/phone-number`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.signInPhoneNumber`\n *\n * **client:**\n * `authClient.signIn.phoneNumber`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/phone-number#api-method-sign-in-phone-number)\n */\nexport const signInPhoneNumber = (opts: RequiredPhoneNumberOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/sign-in/phone-number\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: signInPhoneNumberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Sign in with phone number\",\n\t\t\t\t\tdescription: \"Use this endpoint to sign in with phone number\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t400: {\n\t\t\t\t\t\t\tdescription: \"Invalid phone number or password\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { password, phoneNumber } = ctx.body;\n\n\t\t\tif (opts.phoneNumberValidator) {\n\t\t\t\tconst isValidNumber = await opts.phoneNumberValidator(\n\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t);\n\t\t\t\tif (!isValidNumber) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst user = await ctx.context.adapter.findOne<UserWithPhoneNumber>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"phoneNumber\",\n\t\t\t\t\t\tvalue: phoneNumber,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (opts.requireVerification) {\n\t\t\t\tif (!user.phoneNumberVerified) {\n\t\t\t\t\tconst otp = generateOTP(opts.otpLength);\n\t\t\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\t\t\tvalue: otp,\n\t\t\t\t\t\tidentifier: phoneNumber,\n\t\t\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t\t\t});\n\t\t\t\t\tif (opts.sendOTP) {\n\t\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\t\topts.sendOTP(\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tphoneNumber,\n\t\t\t\t\t\t\t\t\tcode: otp,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.PHONE_NUMBER_NOT_VERIFIED,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst accounts = await ctx.context.internalAdapter.findAccountByUserId(\n\t\t\t\tuser.id,\n\t\t\t);\n\t\t\tconst credentialAccount = accounts.find(\n\t\t\t\t(a) => a.providerId === \"credential\",\n\t\t\t);\n\t\t\tif (!credentialAccount) {\n\t\t\t\tctx.context.logger.error(\"Credential account not found\", {\n\t\t\t\t\tphoneNumber,\n\t\t\t\t});\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst currentPassword = credentialAccount?.password;\n\t\t\tif (!currentPassword) {\n\t\t\t\tctx.context.logger.error(\"Password not found\", { phoneNumber });\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.UNEXPECTED_ERROR,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst validPassword = await ctx.context.password.verify({\n\t\t\t\thash: currentPassword,\n\t\t\t\tpassword,\n\t\t\t});\n\t\t\tif (!validPassword) {\n\t\t\t\tctx.context.logger.error(\"Invalid password\");\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\tuser.id,\n\t\t\t\tctx.body.rememberMe === false,\n\t\t\t);\n\t\t\tif (!session) {\n\t\t\t\tctx.context.logger.error(\"Failed to create session\");\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait setSessionCookie(\n\t\t\t\tctx,\n\t\t\t\t{\n\t\t\t\t\tsession,\n\t\t\t\t\tuser: user,\n\t\t\t\t},\n\t\t\t\tctx.body.rememberMe === false,\n\t\t\t);\n\t\t\treturn ctx.json({\n\t\t\t\ttoken: session.token,\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.id,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\temailVerified: user.emailVerified,\n\t\t\t\t\tname: user.name,\n\t\t\t\t\timage: user.image,\n\t\t\t\t\tphoneNumber: user.phoneNumber,\n\t\t\t\t\tphoneNumberVerified: user.phoneNumberVerified,\n\t\t\t\t\tcreatedAt: user.createdAt,\n\t\t\t\t\tupdatedAt: user.updatedAt,\n\t\t\t\t} as UserWithPhoneNumber,\n\t\t\t});\n\t\t},\n\t);\n\nconst sendPhoneNumberOTPBodySchema = z.object({\n\tphoneNumber: z.string().meta({\n\t\tdescription: 'Phone number to send OTP. Eg: \"+1234567890\"',\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/phone-number/send-otp`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.sendPhoneNumberOTP`\n *\n * **client:**\n * `authClient.phoneNumber.sendOtp`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/phone-number#api-method-phone-number-send-otp)\n */\nexport const sendPhoneNumberOTP = (opts: RequiredPhoneNumberOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/phone-number/send-otp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: sendPhoneNumberOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Send OTP to phone number\",\n\t\t\t\t\tdescription: \"Use this endpoint to send OTP to phone number\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (!opts?.sendOTP) {\n\t\t\t\tctx.context.logger.warn(\"sendOTP not implemented\");\n\t\t\t\tthrow new APIError(\"NOT_IMPLEMENTED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.SEND_OTP_NOT_IMPLEMENTED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (opts.phoneNumberValidator) {\n\t\t\t\tconst isValidNumber = await opts.phoneNumberValidator(\n\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t);\n\t\t\t\tif (!isValidNumber) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst code = generateOTP(opts.otpLength);\n\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\tvalue: `${code}:0`,\n\t\t\t\tidentifier: ctx.body.phoneNumber,\n\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t});\n\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\topts.sendOTP(\n\t\t\t\t\t{\n\t\t\t\t\t\tphoneNumber: ctx.body.phoneNumber,\n\t\t\t\t\t\tcode,\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t),\n\t\t\t);\n\t\t\treturn ctx.json({ message: \"code sent\" });\n\t\t},\n\t);\n\nconst verifyPhoneNumberBodySchema = z.object({\n\t/**\n\t * Phone number\n\t */\n\tphoneNumber: z.string().meta({\n\t\tdescription: 'Phone number to verify. Eg: \"+1234567890\"',\n\t}),\n\t/**\n\t * OTP code\n\t */\n\tcode: z.string().meta({\n\t\tdescription: 'OTP code. Eg: \"123456\"',\n\t}),\n\t/**\n\t * Disable session creation after verification\n\t * @default false\n\t */\n\tdisableSession: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"Disable session creation after verification. Eg: false\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * This checks if there is a session already\n\t * and updates the phone number with the provided\n\t * phone number\n\t */\n\tupdatePhoneNumber: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Check if there is a session and update the phone number. Eg: true\",\n\t\t})\n\t\t.optional(),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/phone-number/verify`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.verifyPhoneNumber`\n *\n * **client:**\n * `authClient.phoneNumber.verify`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/phone-number#api-method-phone-number-verify)\n */\nexport const verifyPhoneNumber = (opts: RequiredPhoneNumberOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/phone-number/verify\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: verifyPhoneNumberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Verify phone number\",\n\t\t\t\t\tdescription: \"Use this endpoint to verify phone number\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Phone number verified successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the verification was successful\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Session token if session is created, null if disableSession is true or no session is created\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's email address\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temailVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the email is verified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's profile image URL\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tphoneNumber: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's phone number\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tphoneNumberVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the phone number is verified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Timestamp when the user was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the user was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"phoneNumber\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"phoneNumberVerified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"User object with phone number details, null if no user is created or found\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t400: {\n\t\t\t\t\t\t\tdescription: \"Invalid OTP\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (opts?.verifyOTP) {\n\t\t\t\t// Use custom verifyOTP if provided\n\t\t\t\tconst isValid = await opts.verifyOTP(\n\t\t\t\t\t{\n\t\t\t\t\t\tphoneNumber: ctx.body.phoneNumber,\n\t\t\t\t\t\tcode: ctx.body.code,\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t);\n\n\t\t\t\tif (!isValid) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_OTP,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Clean up verification value\n\t\t\t\tconst otp = await ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t);\n\t\t\t\tif (otp) {\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(otp.id);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Default internal verification logic\n\t\t\t\tconst otp = await ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t);\n\n\t\t\t\tif (!otp || otp.expiresAt < new Date()) {\n\t\t\t\t\tif (otp && otp.expiresAt < new Date()) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.OTP_EXPIRED,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.OTP_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst [otpValue, attempts] = otp.value.split(\":\");\n\t\t\t\tconst allowedAttempts = opts?.allowedAttempts || 3;\n\t\t\t\tif (attempts && parseInt(attempts) >= allowedAttempts) {\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(otp.id);\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.TOO_MANY_ATTEMPTS,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (otpValue !== ctx.body.code) {\n\t\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(otp.id, {\n\t\t\t\t\t\tvalue: `${otpValue}:${parseInt(attempts || \"0\") + 1}`,\n\t\t\t\t\t});\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_OTP,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(otp.id);\n\t\t\t}\n\n\t\t\tif (ctx.body.updatePhoneNumber) {\n\t\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\t\tif (!session) {\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst existingUser =\n\t\t\t\t\tawait ctx.context.adapter.findMany<UserWithPhoneNumber>({\n\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"phoneNumber\",\n\t\t\t\t\t\t\t\tvalue: ctx.body.phoneNumber,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\tif (existingUser.length) {\n\t\t\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.PHONE_NUMBER_EXIST,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tlet user =\n\t\t\t\t\tawait ctx.context.internalAdapter.updateUser<UserWithPhoneNumber>(\n\t\t\t\t\t\tsession.user.id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t[opts.phoneNumber]: ctx.body.phoneNumber,\n\t\t\t\t\t\t\t[opts.phoneNumberVerified]: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t\ttoken: session.session.token,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\temailVerified: user.emailVerified,\n\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t\tphoneNumber: user.phoneNumber,\n\t\t\t\t\t\tphoneNumberVerified: user.phoneNumberVerified,\n\t\t\t\t\t\tcreatedAt: user.createdAt,\n\t\t\t\t\t\tupdatedAt: user.updatedAt,\n\t\t\t\t\t} as UserWithPhoneNumber,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet user = await ctx.context.adapter.findOne<UserWithPhoneNumber>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: ctx.body.phoneNumber,\n\t\t\t\t\t\tfield: opts.phoneNumber,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\tif (opts?.signUpOnVerification) {\n\t\t\t\t\tuser =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.createUser<UserWithPhoneNumber>({\n\t\t\t\t\t\t\temail: opts.signUpOnVerification.getTempEmail(\n\t\t\t\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tname: opts.signUpOnVerification.getTempName\n\t\t\t\t\t\t\t\t? opts.signUpOnVerification.getTempName(ctx.body.phoneNumber)\n\t\t\t\t\t\t\t\t: ctx.body.phoneNumber,\n\t\t\t\t\t\t\t[opts.phoneNumber]: ctx.body.phoneNumber,\n\t\t\t\t\t\t\t[opts.phoneNumberVerified]: true,\n\t\t\t\t\t\t});\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_USER,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tuser =\n\t\t\t\t\tawait ctx.context.internalAdapter.updateUser<UserWithPhoneNumber>(\n\t\t\t\t\t\tuser.id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t[opts.phoneNumberVerified]: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t}\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_UPDATE_USER,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait opts?.callbackOnVerification?.(\n\t\t\t\t{\n\t\t\t\t\tphoneNumber: ctx.body.phoneNumber,\n\t\t\t\t\tuser,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!ctx.body.disableSession) {\n\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\tuser.id,\n\t\t\t\t);\n\t\t\t\tif (!session) {\n\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession,\n\t\t\t\t\tuser,\n\t\t\t\t});\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t\ttoken: session.token,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\temailVerified: user.emailVerified,\n\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t\tphoneNumber: user.phoneNumber,\n\t\t\t\t\t\tphoneNumberVerified: user.phoneNumberVerified,\n\t\t\t\t\t\tcreatedAt: user.createdAt,\n\t\t\t\t\t\tupdatedAt: user.updatedAt,\n\t\t\t\t\t} as UserWithPhoneNumber,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t\ttoken: null,\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.id,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\temailVerified: user.emailVerified,\n\t\t\t\t\tname: user.name,\n\t\t\t\t\timage: user.image,\n\t\t\t\t\tphoneNumber: user.phoneNumber,\n\t\t\t\t\tphoneNumberVerified: user.phoneNumberVerified,\n\t\t\t\t\tcreatedAt: user.createdAt,\n\t\t\t\t\tupdatedAt: user.updatedAt,\n\t\t\t\t} as UserWithPhoneNumber,\n\t\t\t});\n\t\t},\n\t);\n\nconst requestPasswordResetPhoneNumberBodySchema = z.object({\n\tphoneNumber: z.string(),\n});\n\nexport const requestPasswordResetPhoneNumber = (\n\topts: RequiredPhoneNumberOptions,\n) =>\n\tcreateAuthEndpoint(\n\t\t\"/phone-number/request-password-reset\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: requestPasswordResetPhoneNumberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Request OTP for password reset via phone number\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"OTP sent successfully for password reset\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the OTP was sent successfully\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst user = await ctx.context.adapter.findOne<UserWithPhoneNumber>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: ctx.body.phoneNumber,\n\t\t\t\t\t\tfield: opts.phoneNumber,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tconst code = generateOTP(opts.otpLength);\n\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\tvalue: `${code}:0`,\n\t\t\t\tidentifier: `${ctx.body.phoneNumber}-request-password-reset`,\n\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t});\n\t\t\t// to avoid leaking the existence of the phone number\n\t\t\tif (!user) {\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (opts.sendPasswordResetOTP) {\n\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\topts.sendPasswordResetOTP(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tphoneNumber: ctx.body.phoneNumber,\n\t\t\t\t\t\t\tcode,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tctx,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst resetPasswordPhoneNumberBodySchema = z.object({\n\totp: z.string().meta({\n\t\tdescription: 'The one time password to reset the password. Eg: \"123456\"',\n\t}),\n\tphoneNumber: z.string().meta({\n\t\tdescription:\n\t\t\t'The phone number to the account which intends to reset the password for. Eg: \"+1234567890\"',\n\t}),\n\tnewPassword: z.string().meta({\n\t\tdescription: `The new password. Eg: \"new-and-secure-password\"`,\n\t}),\n});\n\nexport const resetPasswordPhoneNumber = (opts: RequiredPhoneNumberOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/phone-number/reset-password\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: resetPasswordPhoneNumberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Reset password using phone number OTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Password reset successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the password was reset successfully\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst verification =\n\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t`${ctx.body.phoneNumber}-request-password-reset`,\n\t\t\t\t);\n\t\t\tif (!verification) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.OTP_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (verification.expiresAt < new Date()) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.OTP_EXPIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst [otpValue, attempts] = verification.value.split(\":\");\n\t\t\tconst allowedAttempts = opts?.allowedAttempts || 3;\n\t\t\tif (attempts && parseInt(attempts) >= allowedAttempts) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverification.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.TOO_MANY_ATTEMPTS,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (ctx.body.otp !== otpValue) {\n\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(\n\t\t\t\t\tverification.id,\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: `${otpValue}:${parseInt(attempts || \"0\") + 1}`,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = await ctx.context.adapter.findOne<User>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"phoneNumber\",\n\t\t\t\t\t\tvalue: ctx.body.phoneNumber,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.UNEXPECTED_ERROR,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst minLength = ctx.context.password.config.minPasswordLength;\n\t\t\tconst maxLength = ctx.context.password.config.maxPasswordLength;\n\t\t\tif (ctx.body.newPassword.length < minLength) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_SHORT,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (ctx.body.newPassword.length > maxLength) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_LONG,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst hashedPassword = await ctx.context.password.hash(\n\t\t\t\tctx.body.newPassword,\n\t\t\t);\n\t\t\tawait ctx.context.internalAdapter.updatePassword(user.id, hashedPassword);\n\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\tverification.id,\n\t\t\t);\n\n\t\t\tif (ctx.context.options.emailAndPassword?.revokeSessionsOnPasswordReset) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteSessions(user.id);\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t},\n\t);\n\nfunction generateOTP(size: number) {\n\treturn generateRandomString(size, \"0-9\");\n}\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\n\nexport const schema = {\n\tuser: {\n\t\tfields: {\n\t\t\tphoneNumber: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: false,\n\t\t\t\tunique: true,\n\t\t\t\tsortable: true,\n\t\t\t\treturned: true,\n\t\t\t},\n\t\t\tphoneNumberVerified: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\trequired: false,\n\t\t\t\treturned: true,\n\t\t\t\tinput: false,\n\t\t\t},\n\t\t},\n\t},\n} satisfies BetterAuthPluginDBSchema;\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { createAuthMiddleware } from \"@better-auth/core/api\";\nimport { APIError } from \"better-call\";\nimport { mergeSchema } from \"../../db/schema\";\nimport { PHONE_NUMBER_ERROR_CODES } from \"./error-codes\";\nimport type { RequiredPhoneNumberOptions } from \"./routes\";\nimport {\n\trequestPasswordResetPhoneNumber,\n\tresetPasswordPhoneNumber,\n\tsendPhoneNumberOTP,\n\tsignInPhoneNumber,\n\tverifyPhoneNumber,\n} from \"./routes\";\nimport { schema } from \"./schema\";\nimport type { PhoneNumberOptions, UserWithPhoneNumber } from \"./types\";\n\nexport type { PhoneNumberOptions, UserWithPhoneNumber };\n\nexport const phoneNumber = (options?: PhoneNumberOptions | undefined) => {\n\tconst opts = {\n\t\texpiresIn: options?.expiresIn || 300,\n\t\totpLength: options?.otpLength || 6,\n\t\t...options,\n\t\tphoneNumber: \"phoneNumber\",\n\t\tphoneNumberVerified: \"phoneNumberVerified\",\n\t\tcode: \"code\",\n\t\tcreatedAt: \"createdAt\",\n\t};\n\n\treturn {\n\t\tid: \"phone-number\",\n\t\thooks: {\n\t\t\tbefore: [\n\t\t\t\t{\n\t\t\t\t\t// Stop any requests attempting to update the user's phone number\n\t\t\t\t\tmatcher: (ctx) =>\n\t\t\t\t\t\tctx.path === \"/update-user\" && \"phoneNumber\" in ctx.body,\n\t\t\t\t\thandler: createAuthMiddleware(async (_ctx) => {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.PHONE_NUMBER_CANNOT_BE_UPDATED,\n\t\t\t\t\t\t});\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tendpoints: {\n\t\t\tsignInPhoneNumber: signInPhoneNumber(opts as RequiredPhoneNumberOptions),\n\t\t\tsendPhoneNumberOTP: sendPhoneNumberOTP(\n\t\t\t\topts as RequiredPhoneNumberOptions,\n\t\t\t),\n\t\t\tverifyPhoneNumber: verifyPhoneNumber(opts as RequiredPhoneNumberOptions),\n\t\t\trequestPasswordResetPhoneNumber: requestPasswordResetPhoneNumber(\n\t\t\t\topts as RequiredPhoneNumberOptions,\n\t\t\t),\n\t\t\tresetPasswordPhoneNumber: resetPasswordPhoneNumber(\n\t\t\t\topts as RequiredPhoneNumberOptions,\n\t\t\t),\n\t\t},\n\t\tschema: mergeSchema(schema, options?.schema),\n\t\trateLimit: [\n\t\t\t{\n\t\t\t\tpathMatcher(path) {\n\t\t\t\t\treturn path.startsWith(\"/phone-number\");\n\t\t\t\t},\n\t\t\t\twindow: 60 * 1000,\n\t\t\t\tmax: 10,\n\t\t\t},\n\t\t],\n\t\toptions,\n\t\t$ERROR_CODES: PHONE_NUMBER_ERROR_CODES,\n\t} satisfies BetterAuthPlugin;\n};\n", "/**\n * SHA3 (keccak) hash function, based on a new \"Sponge function\" design.\n * Different from older hashes, the internal state is bigger than output size.\n *\n * Check out [FIPS-202](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf),\n * [Website](https://keccak.team/keccak.html),\n * [the differences between SHA-3 and Keccak](https://crypto.stackexchange.com/questions/15727/what-are-the-key-differences-between-the-draft-sha-3-standard-and-the-keccak-sub).\n *\n * Check out `sha3-addons` module for cSHAKE, k12, and others.\n * @module\n */\nimport { rotlBH, rotlBL, rotlSH, rotlSL, split } from './_u64.ts';\n// prettier-ignore\nimport {\n  abytes, aexists, anumber, aoutput,\n  clean, createHasher,\n  oidNist,\n  swap32IfBE,\n  u32,\n  type CHash, type CHashXOF,\n  type Hash,\n  type HashInfo,\n  type HashXOF\n} from './utils.ts';\n\n// No __PURE__ annotations in sha3 header:\n// EVERYTHING is in fact used on every export.\n// Various per round constants calculations\nconst _0n = BigInt(0);\nconst _1n = BigInt(1);\nconst _2n = BigInt(2);\nconst _7n = BigInt(7);\nconst _256n = BigInt(256);\nconst _0x71n = BigInt(0x71);\nconst SHA3_PI: number[] = [];\nconst SHA3_ROTL: number[] = [];\nconst _SHA3_IOTA: bigint[] = []; // no pure annotation: var is always used\nfor (let round = 0, R = _1n, x = 1, y = 0; round < 24; round++) {\n  // Pi\n  [x, y] = [y, (2 * x + 3 * y) % 5];\n  SHA3_PI.push(2 * (5 * y + x));\n  // Rotational\n  SHA3_ROTL.push((((round + 1) * (round + 2)) / 2) % 64);\n  // Iota\n  let t = _0n;\n  for (let j = 0; j < 7; j++) {\n    R = ((R << _1n) ^ ((R >> _7n) * _0x71n)) % _256n;\n    if (R & _2n) t ^= _1n << ((_1n << BigInt(j)) - _1n);\n  }\n  _SHA3_IOTA.push(t);\n}\nconst IOTAS = split(_SHA3_IOTA, true);\nconst SHA3_IOTA_H = IOTAS[0];\nconst SHA3_IOTA_L = IOTAS[1];\n\n// Left rotation (without 0, 32, 64)\nconst rotlH = (h: number, l: number, s: number) => (s > 32 ? rotlBH(h, l, s) : rotlSH(h, l, s));\nconst rotlL = (h: number, l: number, s: number) => (s > 32 ? rotlBL(h, l, s) : rotlSL(h, l, s));\n\n/** `keccakf1600` internal function, additionally allows to adjust round count. */\nexport function keccakP(s: Uint32Array, rounds: number = 24): void {\n  const B = new Uint32Array(5 * 2);\n  // NOTE: all indices are x2 since we store state as u32 instead of u64 (bigints to slow in js)\n  for (let round = 24 - rounds; round < 24; round++) {\n    // Theta \n    for (let x = 0; x < 10; x++) B[x] = s[x] ^ s[x + 10] ^ s[x + 20] ^ s[x + 30] ^ s[x + 40];\n    for (let x = 0; x < 10; x += 2) {\n      const idx1 = (x + 8) % 10;\n      const idx0 = (x + 2) % 10;\n      const B0 = B[idx0];\n      const B1 = B[idx0 + 1];\n      const Th = rotlH(B0, B1, 1) ^ B[idx1];\n      const Tl = rotlL(B0, B1, 1) ^ B[idx1 + 1];\n      for (let y = 0; y < 50; y += 10) {\n        s[x + y] ^= Th;\n        s[x + y + 1] ^= Tl;\n      }\n    }\n    // Rho () and Pi ()\n    let curH = s[2];\n    let curL = s[3];\n    for (let t = 0; t < 24; t++) {\n      const shift = SHA3_ROTL[t];\n      const Th = rotlH(curH, curL, shift);\n      const Tl = rotlL(curH, curL, shift);\n      const PI = SHA3_PI[t];\n      curH = s[PI];\n      curL = s[PI + 1];\n      s[PI] = Th;\n      s[PI + 1] = Tl;\n    }\n    // Chi ()\n    for (let y = 0; y < 50; y += 10) {\n      for (let x = 0; x < 10; x++) B[x] = s[y + x];\n      for (let x = 0; x < 10; x++) s[y + x] ^= ~B[(x + 2) % 10] & B[(x + 4) % 10];\n    }\n    // Iota ()\n    s[0] ^= SHA3_IOTA_H[round];\n    s[1] ^= SHA3_IOTA_L[round];\n  }\n  clean(B);\n}\n\n/** Keccak sponge function. */\nexport class Keccak implements Hash<Keccak>, HashXOF<Keccak> {\n  protected state: Uint8Array;\n  protected pos = 0;\n  protected posOut = 0;\n  protected finished = false;\n  protected state32: Uint32Array;\n  protected destroyed = false;\n\n  public blockLen: number;\n  public suffix: number;\n  public outputLen: number;\n  protected enableXOF = false;\n  protected rounds: number;\n\n  // NOTE: we accept arguments in bytes instead of bits here.\n  constructor(\n    blockLen: number,\n    suffix: number,\n    outputLen: number,\n    enableXOF = false,\n    rounds: number = 24\n  ) {\n    this.blockLen = blockLen;\n    this.suffix = suffix;\n    this.outputLen = outputLen;\n    this.enableXOF = enableXOF;\n    this.rounds = rounds;\n    // Can be passed from user as dkLen\n    anumber(outputLen, 'outputLen');\n    // 1600 = 5x5 matrix of 64bit.  1600 bits === 200 bytes\n    // 0 < blockLen < 200\n    if (!(0 < blockLen && blockLen < 200))\n      throw new Error('only keccak-f1600 function is supported');\n    this.state = new Uint8Array(200);\n    this.state32 = u32(this.state);\n  }\n  clone(): Keccak {\n    return this._cloneInto();\n  }\n  protected keccak(): void {\n    swap32IfBE(this.state32);\n    keccakP(this.state32, this.rounds);\n    swap32IfBE(this.state32);\n    this.posOut = 0;\n    this.pos = 0;\n  }\n  update(data: Uint8Array): this {\n    aexists(this);\n    abytes(data);\n    const { blockLen, state } = this;\n    const len = data.length;\n    for (let pos = 0; pos < len; ) {\n      const take = Math.min(blockLen - this.pos, len - pos);\n      for (let i = 0; i < take; i++) state[this.pos++] ^= data[pos++];\n      if (this.pos === blockLen) this.keccak();\n    }\n    return this;\n  }\n  protected finish(): void {\n    if (this.finished) return;\n    this.finished = true;\n    const { state, suffix, pos, blockLen } = this;\n    // Do the padding\n    state[pos] ^= suffix;\n    if ((suffix & 0x80) !== 0 && pos === blockLen - 1) this.keccak();\n    state[blockLen - 1] ^= 0x80;\n    this.keccak();\n  }\n  protected writeInto(out: Uint8Array): Uint8Array {\n    aexists(this, false);\n    abytes(out);\n    this.finish();\n    const bufferOut = this.state;\n    const { blockLen } = this;\n    for (let pos = 0, len = out.length; pos < len; ) {\n      if (this.posOut >= blockLen) this.keccak();\n      const take = Math.min(blockLen - this.posOut, len - pos);\n      out.set(bufferOut.subarray(this.posOut, this.posOut + take), pos);\n      this.posOut += take;\n      pos += take;\n    }\n    return out;\n  }\n  xofInto(out: Uint8Array): Uint8Array {\n    // Sha3/Keccak usage with XOF is probably mistake, only SHAKE instances can do XOF\n    if (!this.enableXOF) throw new Error('XOF is not possible for this instance');\n    return this.writeInto(out);\n  }\n  xof(bytes: number): Uint8Array {\n    anumber(bytes);\n    return this.xofInto(new Uint8Array(bytes));\n  }\n  digestInto(out: Uint8Array): Uint8Array {\n    aoutput(out, this);\n    if (this.finished) throw new Error('digest() was already called');\n    this.writeInto(out);\n    this.destroy();\n    return out;\n  }\n  digest(): Uint8Array {\n    return this.digestInto(new Uint8Array(this.outputLen));\n  }\n  destroy(): void {\n    this.destroyed = true;\n    clean(this.state);\n  }\n  _cloneInto(to?: Keccak): Keccak {\n    const { blockLen, suffix, outputLen, rounds, enableXOF } = this;\n    to ||= new Keccak(blockLen, suffix, outputLen, enableXOF, rounds);\n    to.state32.set(this.state32);\n    to.pos = this.pos;\n    to.posOut = this.posOut;\n    to.finished = this.finished;\n    to.rounds = rounds;\n    // Suffix can change in cSHAKE\n    to.suffix = suffix;\n    to.outputLen = outputLen;\n    to.enableXOF = enableXOF;\n    to.destroyed = this.destroyed;\n    return to;\n  }\n}\n\nconst genKeccak = (suffix: number, blockLen: number, outputLen: number, info: HashInfo = {}) =>\n  createHasher(() => new Keccak(blockLen, suffix, outputLen), info);\n\n/** SHA3-224 hash function. */\nexport const sha3_224: CHash = /* @__PURE__ */ genKeccak(\n  0x06,\n  144,\n  28,\n  /* @__PURE__ */ oidNist(0x07)\n);\n/** SHA3-256 hash function. Different from keccak-256. */\nexport const sha3_256: CHash = /* @__PURE__ */ genKeccak(\n  0x06,\n  136,\n  32,\n  /* @__PURE__ */ oidNist(0x08)\n);\n/** SHA3-384 hash function. */\nexport const sha3_384: CHash = /* @__PURE__ */ genKeccak(\n  0x06,\n  104,\n  48,\n  /* @__PURE__ */ oidNist(0x09)\n);\n/** SHA3-512 hash function. */\nexport const sha3_512: CHash = /* @__PURE__ */ genKeccak(\n  0x06,\n  72,\n  64,\n  /* @__PURE__ */ oidNist(0x0a)\n);\n\n/** keccak-224 hash function. */\nexport const keccak_224: CHash = /* @__PURE__ */ genKeccak(0x01, 144, 28);\n/** keccak-256 hash function. Different from SHA3-256. */\nexport const keccak_256: CHash = /* @__PURE__ */ genKeccak(0x01, 136, 32);\n/** keccak-384 hash function. */\nexport const keccak_384: CHash = /* @__PURE__ */ genKeccak(0x01, 104, 48);\n/** keccak-512 hash function. */\nexport const keccak_512: CHash = /* @__PURE__ */ genKeccak(0x01, 72, 64);\n\n/** Options for SHAKE XOF. */\nexport type ShakeOpts = { dkLen?: number };\n\nconst genShake = (suffix: number, blockLen: number, outputLen: number, info: HashInfo = {}) =>\n  createHasher<Keccak, ShakeOpts>(\n    (opts: ShakeOpts = {}) =>\n      new Keccak(blockLen, suffix, opts.dkLen === undefined ? outputLen : opts.dkLen, true),\n    info\n  );\n\n/** SHAKE128 XOF with 128-bit security. */\nexport const shake128: CHashXOF<Keccak, ShakeOpts> =\n  /* @__PURE__ */\n  genShake(0x1f, 168, 16, /* @__PURE__ */ oidNist(0x0b));\n/** SHAKE256 XOF with 256-bit security. */\nexport const shake256: CHashXOF<Keccak, ShakeOpts> =\n  /* @__PURE__ */\n  genShake(0x1f, 136, 32, /* @__PURE__ */ oidNist(0x0c));\n\n/** SHAKE128 XOF with 256-bit output (NIST version). */\nexport const shake128_32: CHashXOF<Keccak, ShakeOpts> =\n  /* @__PURE__ */\n  genShake(0x1f, 168, 32, /* @__PURE__ */ oidNist(0x0b));\n/** SHAKE256 XOF with 512-bit output (NIST version). */\nexport const shake256_64: CHashXOF<Keccak, ShakeOpts> =\n  /* @__PURE__ */\n  genShake(0x1f, 136, 64, /* @__PURE__ */ oidNist(0x0c));\n", "import { keccak_256 } from \"@noble/hashes/sha3.js\";\nimport { utf8ToBytes } from \"@noble/hashes/utils.js\";\n\n/**\n * TS implementation of ERC-55 (\"Mixed-case checksum address encoding\") using @noble/hashes\n * @param address - The address to convert to a checksum address\n * @returns The checksummed address\n */\nexport function toChecksumAddress(address: string) {\n\taddress = address.toLowerCase().replace(\"0x\", \"\");\n\t// Hash the address (treat it as UTF-8) and return as a hex string\n\tconst hash = [...keccak_256(utf8ToBytes(address))]\n\t\t.map((v) => v.toString(16).padStart(2, \"0\"))\n\t\t.join(\"\");\n\tlet ret = \"0x\";\n\n\tfor (let i = 0; i < 40; i++) {\n\t\tif (parseInt(hash[i]!, 16) >= 8) {\n\t\t\tret += address[i]!.toUpperCase();\n\t\t} else {\n\t\t\tret += address[i]!;\n\t\t}\n\t}\n\n\treturn ret;\n}\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\n\nexport const schema = {\n\twalletAddress: {\n\t\tfields: {\n\t\t\tuserId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\treferences: {\n\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t},\n\t\t\t\trequired: true,\n\t\t\t\tindex: true,\n\t\t\t},\n\t\t\taddress: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\tchainId: {\n\t\t\t\ttype: \"number\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t\tisPrimary: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdefaultValue: false,\n\t\t\t},\n\t\t\tcreatedAt: {\n\t\t\t\ttype: \"date\",\n\t\t\t\trequired: true,\n\t\t\t},\n\t\t},\n\t},\n} satisfies BetterAuthPluginDBSchema;\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport * as z from \"zod\";\nimport { APIError } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { mergeSchema } from \"../../db/schema\";\nimport type { InferOptionSchema, User } from \"../../types\";\nimport { toChecksumAddress } from \"../../utils/hashing\";\nimport { getOrigin } from \"../../utils/url\";\nimport { schema } from \"./schema\";\nimport type {\n\tENSLookupArgs,\n\tENSLookupResult,\n\tSIWEVerifyMessageArgs,\n\tWalletAddress,\n} from \"./types\";\n\nexport interface SIWEPluginOptions {\n\tdomain: string;\n\temailDomainName?: string | undefined;\n\tanonymous?: boolean | undefined;\n\tgetNonce: () => Promise<string>;\n\tverifyMessage: (args: SIWEVerifyMessageArgs) => Promise<boolean>;\n\tensLookup?: ((args: ENSLookupArgs) => Promise<ENSLookupResult>) | undefined;\n\tschema?: InferOptionSchema<typeof schema> | undefined;\n}\n\nconst getSiweNonceBodySchema = z.object({\n\twalletAddress: z\n\t\t.string()\n\t\t.regex(/^0[xX][a-fA-F0-9]{40}$/i)\n\t\t.length(42),\n\tchainId: z.number().int().positive().max(2147483647).optional().default(1),\n});\n\nexport const siwe = (options: SIWEPluginOptions) =>\n\t({\n\t\tid: \"siwe\",\n\t\tschema: mergeSchema(schema, options?.schema),\n\t\tendpoints: {\n\t\t\tgetSiweNonce: createAuthEndpoint(\n\t\t\t\t\"/siwe/nonce\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: getSiweNonceBodySchema,\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst { walletAddress: rawWalletAddress, chainId } = ctx.body;\n\t\t\t\t\tconst walletAddress = toChecksumAddress(rawWalletAddress);\n\t\t\t\t\tconst nonce = await options.getNonce();\n\n\t\t\t\t\t// Store nonce with wallet address and chain ID context\n\t\t\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\t\t\tidentifier: `siwe:${walletAddress}:${chainId}`,\n\t\t\t\t\t\tvalue: nonce,\n\t\t\t\t\t\texpiresAt: new Date(Date.now() + 15 * 60 * 1000),\n\t\t\t\t\t});\n\n\t\t\t\t\treturn ctx.json({ nonce });\n\t\t\t\t},\n\t\t\t),\n\t\t\tverifySiweMessage: createAuthEndpoint(\n\t\t\t\t\"/siwe/verify\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: z\n\t\t\t\t\t\t.object({\n\t\t\t\t\t\t\tmessage: z.string().min(1),\n\t\t\t\t\t\t\tsignature: z.string().min(1),\n\t\t\t\t\t\t\twalletAddress: z\n\t\t\t\t\t\t\t\t.string()\n\t\t\t\t\t\t\t\t.regex(/^0[xX][a-fA-F0-9]{40}$/i)\n\t\t\t\t\t\t\t\t.length(42),\n\t\t\t\t\t\t\tchainId: z\n\t\t\t\t\t\t\t\t.number()\n\t\t\t\t\t\t\t\t.int()\n\t\t\t\t\t\t\t\t.positive()\n\t\t\t\t\t\t\t\t.max(2147483647)\n\t\t\t\t\t\t\t\t.optional()\n\t\t\t\t\t\t\t\t.default(1),\n\t\t\t\t\t\t\temail: z.email().optional(),\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.refine((data) => options.anonymous !== false || !!data.email, {\n\t\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\t\t\"Email is required when the anonymous plugin option is disabled.\",\n\t\t\t\t\t\t\tpath: [\"email\"],\n\t\t\t\t\t\t}),\n\t\t\t\t\trequireRequest: true,\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst {\n\t\t\t\t\t\tmessage,\n\t\t\t\t\t\tsignature,\n\t\t\t\t\t\twalletAddress: rawWalletAddress,\n\t\t\t\t\t\tchainId,\n\t\t\t\t\t\temail,\n\t\t\t\t\t} = ctx.body;\n\t\t\t\t\tconst walletAddress = toChecksumAddress(rawWalletAddress);\n\t\t\t\t\tconst isAnon = options.anonymous ?? true;\n\n\t\t\t\t\tif (!isAnon && !email) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: \"Email is required when anonymous is disabled.\",\n\t\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Find stored nonce with wallet address and chain ID context\n\t\t\t\t\t\tconst verification =\n\t\t\t\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t\t\t\t`siwe:${walletAddress}:${chainId}`,\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// Ensure nonce is valid and not expired\n\t\t\t\t\t\tif (!verification || new Date() > verification.expiresAt) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\tmessage: \"Unauthorized: Invalid or expired nonce\",\n\t\t\t\t\t\t\t\tstatus: 401,\n\t\t\t\t\t\t\t\tcode: \"UNAUTHORIZED_INVALID_OR_EXPIRED_NONCE\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Verify SIWE message with enhanced parameters\n\t\t\t\t\t\tconst { value: nonce } = verification;\n\t\t\t\t\t\tconst verified = await options.verifyMessage({\n\t\t\t\t\t\t\tmessage,\n\t\t\t\t\t\t\tsignature,\n\t\t\t\t\t\t\taddress: walletAddress,\n\t\t\t\t\t\t\tchainId,\n\t\t\t\t\t\t\tcacao: {\n\t\t\t\t\t\t\t\th: { t: \"caip122\" },\n\t\t\t\t\t\t\t\tp: {\n\t\t\t\t\t\t\t\t\tdomain: options.domain,\n\t\t\t\t\t\t\t\t\taud: options.domain,\n\t\t\t\t\t\t\t\t\tnonce,\n\t\t\t\t\t\t\t\t\tiss: options.domain,\n\t\t\t\t\t\t\t\t\tversion: \"1\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\ts: { t: \"eip191\", s: signature },\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (!verified) {\n\t\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\t\tmessage: \"Unauthorized: Invalid SIWE signature\",\n\t\t\t\t\t\t\t\tstatus: 401,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Clean up used nonce\n\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\t\tverification.id,\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// Look for existing user by their wallet addresses\n\t\t\t\t\t\tlet user: User | null = null;\n\n\t\t\t\t\t\t// Check if there's a wallet address record for this exact address+chainId combination\n\t\t\t\t\t\tconst existingWalletAddress: WalletAddress | null =\n\t\t\t\t\t\t\tawait ctx.context.adapter.findOne({\n\t\t\t\t\t\t\t\tmodel: \"walletAddress\",\n\t\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t\t{ field: \"address\", operator: \"eq\", value: walletAddress },\n\t\t\t\t\t\t\t\t\t{ field: \"chainId\", operator: \"eq\", value: chainId },\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (existingWalletAddress) {\n\t\t\t\t\t\t\t// Get the user associated with this wallet address\n\t\t\t\t\t\t\tuser = await ctx.context.adapter.findOne({\n\t\t\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\t\t\t\t\tvalue: existingWalletAddress.userId,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// No exact match found, check if this address exists on any other chain\n\t\t\t\t\t\t\tconst anyWalletAddress: WalletAddress | null =\n\t\t\t\t\t\t\t\tawait ctx.context.adapter.findOne({\n\t\t\t\t\t\t\t\t\tmodel: \"walletAddress\",\n\t\t\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t\t\t{ field: \"address\", operator: \"eq\", value: walletAddress },\n\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif (anyWalletAddress) {\n\t\t\t\t\t\t\t\t// Same address exists on different chain, get that user\n\t\t\t\t\t\t\t\tuser = await ctx.context.adapter.findOne({\n\t\t\t\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\t\t\t\t\toperator: \"eq\",\n\t\t\t\t\t\t\t\t\t\t\tvalue: anyWalletAddress.userId,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Create new user if none exists\n\t\t\t\t\t\tif (!user) {\n\t\t\t\t\t\t\tconst domain =\n\t\t\t\t\t\t\t\toptions.emailDomainName ?? getOrigin(ctx.context.baseURL);\n\t\t\t\t\t\t\t// Use checksummed address for email generation\n\t\t\t\t\t\t\tconst userEmail =\n\t\t\t\t\t\t\t\t!isAnon && email ? email : `${walletAddress}@${domain}`;\n\t\t\t\t\t\t\tconst { name, avatar } =\n\t\t\t\t\t\t\t\t(await options.ensLookup?.({ walletAddress })) ?? {};\n\n\t\t\t\t\t\t\tuser = await ctx.context.internalAdapter.createUser({\n\t\t\t\t\t\t\t\tname: name ?? walletAddress,\n\t\t\t\t\t\t\t\temail: userEmail,\n\t\t\t\t\t\t\t\timage: avatar ?? \"\",\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t// Create wallet address record\n\t\t\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\t\t\tmodel: \"walletAddress\",\n\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\t\t\t\taddress: walletAddress,\n\t\t\t\t\t\t\t\t\tchainId,\n\t\t\t\t\t\t\t\t\tisPrimary: true, // First address is primary\n\t\t\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t// Create account record for wallet authentication\n\t\t\t\t\t\t\tawait ctx.context.internalAdapter.createAccount({\n\t\t\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\t\t\tproviderId: \"siwe\",\n\t\t\t\t\t\t\t\taccountId: `${walletAddress}:${chainId}`,\n\t\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// User exists, but check if this specific address/chain combo exists\n\t\t\t\t\t\t\tif (!existingWalletAddress) {\n\t\t\t\t\t\t\t\t// Add this new chainId to existing user's addresses\n\t\t\t\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\t\t\t\tmodel: \"walletAddress\",\n\t\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\t\t\t\t\taddress: walletAddress,\n\t\t\t\t\t\t\t\t\t\tchainId,\n\t\t\t\t\t\t\t\t\t\tisPrimary: false, // Additional addresses are not primary by default\n\t\t\t\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t// Create account record for this new wallet+chain combination\n\t\t\t\t\t\t\t\tawait ctx.context.internalAdapter.createAccount({\n\t\t\t\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\t\t\t\tproviderId: \"siwe\",\n\t\t\t\t\t\t\t\t\taccountId: `${walletAddress}:${chainId}`,\n\t\t\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\t\tuser.id,\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (!session) {\n\t\t\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\t\t\tmessage: \"Internal Server Error\",\n\t\t\t\t\t\t\t\tstatus: 500,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tawait setSessionCookie(ctx, { session, user });\n\n\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\ttoken: session.token,\n\t\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\t\t\twalletAddress,\n\t\t\t\t\t\t\t\tchainId,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (error: unknown) {\n\t\t\t\t\t\tif (error instanceof APIError) throw error;\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: \"Something went wrong. Please try again later.\",\n\t\t\t\t\t\t\terror: error instanceof Error ? error.message : \"Unknown error\",\n\t\t\t\t\t\t\tstatus: 401,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\toptions,\n\t}) satisfies BetterAuthPlugin;\n", "import { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const TWO_FACTOR_ERROR_CODES = defineErrorCodes({\n\tOTP_NOT_ENABLED: \"OTP not enabled\",\n\tOTP_HAS_EXPIRED: \"OTP has expired\",\n\tTOTP_NOT_ENABLED: \"TOTP not enabled\",\n\tTWO_FACTOR_NOT_ENABLED: \"Two factor isn't enabled\",\n\tBACKUP_CODES_NOT_ENABLED: \"Backup codes aren't enabled\",\n\tINVALID_BACKUP_CODE: \"Invalid backup code\",\n\tINVALID_CODE: \"Invalid code\",\n\tTOO_MANY_ATTEMPTS_REQUEST_NEW_CODE:\n\t\t\"Too many attempts. Please request a new code.\",\n\tINVALID_TWO_FACTOR_COOKIE: \"Invalid two factor cookie\",\n});\n", "export const TWO_FACTOR_COOKIE_NAME = \"two_factor\";\nexport const TRUST_DEVICE_COOKIE_NAME = \"trust_device\";\nexport const TRUST_DEVICE_COOKIE_MAX_AGE = 30 * 24 * 60 * 60; // 30 days\n", "import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { createHMAC } from \"@better-auth/utils/hmac\";\nimport { APIError } from \"better-call\";\nimport { getSessionFromCtx } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport {\n\tTRUST_DEVICE_COOKIE_MAX_AGE,\n\tTRUST_DEVICE_COOKIE_NAME,\n\tTWO_FACTOR_COOKIE_NAME,\n} from \"./constant\";\nimport { TWO_FACTOR_ERROR_CODES } from \"./error-code\";\nimport type { UserWithTwoFactor } from \"./types\";\n\nexport async function verifyTwoFactor(ctx: GenericEndpointContext) {\n\tconst invalid = (errorKey: keyof typeof TWO_FACTOR_ERROR_CODES) => {\n\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\tmessage: TWO_FACTOR_ERROR_CODES[errorKey],\n\t\t});\n\t};\n\n\tconst session = await getSessionFromCtx(ctx);\n\tif (!session) {\n\t\tconst cookieName = ctx.context.createAuthCookie(TWO_FACTOR_COOKIE_NAME);\n\t\tconst twoFactorCookie = await ctx.getSignedCookie(\n\t\t\tcookieName.name,\n\t\t\tctx.context.secret,\n\t\t);\n\t\tif (!twoFactorCookie) {\n\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.INVALID_TWO_FACTOR_COOKIE,\n\t\t\t});\n\t\t}\n\t\tconst verificationToken =\n\t\t\tawait ctx.context.internalAdapter.findVerificationValue(twoFactorCookie);\n\t\tif (!verificationToken) {\n\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.INVALID_TWO_FACTOR_COOKIE,\n\t\t\t});\n\t\t}\n\t\tconst user = (await ctx.context.internalAdapter.findUserById(\n\t\t\tverificationToken.value,\n\t\t)) as UserWithTwoFactor;\n\t\tif (!user) {\n\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.INVALID_TWO_FACTOR_COOKIE,\n\t\t\t});\n\t\t}\n\t\tconst dontRememberMe = await ctx.getSignedCookie(\n\t\t\tctx.context.authCookies.dontRememberToken.name,\n\t\t\tctx.context.secret,\n\t\t);\n\t\treturn {\n\t\t\tvalid: async (ctx: GenericEndpointContext) => {\n\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\tverificationToken.value,\n\t\t\t\t\t!!dontRememberMe,\n\t\t\t\t);\n\t\t\t\tif (!session) {\n\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\tmessage: \"failed to create session\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// Delete the verification token from the database after successful verification\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverificationToken.id,\n\t\t\t\t);\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession,\n\t\t\t\t\tuser,\n\t\t\t\t});\n\t\t\t\t// Always clear the two factor cookie after successful verification\n\t\t\t\tctx.setCookie(cookieName.name, \"\", {\n\t\t\t\t\tmaxAge: 0,\n\t\t\t\t});\n\t\t\t\tif (ctx.body.trustDevice) {\n\t\t\t\t\tconst trustDeviceCookie = ctx.context.createAuthCookie(\n\t\t\t\t\t\tTRUST_DEVICE_COOKIE_NAME,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmaxAge: TRUST_DEVICE_COOKIE_MAX_AGE,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t\t/**\n\t\t\t\t\t * create a token that will be used to\n\t\t\t\t\t * verify the device\n\t\t\t\t\t */\n\t\t\t\t\tconst token = await createHMAC(\"SHA-256\", \"base64urlnopad\").sign(\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t`${user.id}!${session.token}`,\n\t\t\t\t\t);\n\t\t\t\t\tawait ctx.setSignedCookie(\n\t\t\t\t\t\ttrustDeviceCookie.name,\n\t\t\t\t\t\t`${token}!${session.token}`,\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\ttrustDeviceCookie.attributes,\n\t\t\t\t\t);\n\t\t\t\t\t// delete the dont remember me cookie\n\t\t\t\t\tctx.setCookie(ctx.context.authCookies.dontRememberToken.name, \"\", {\n\t\t\t\t\t\tmaxAge: 0,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn ctx.json({\n\t\t\t\t\ttoken: session.token,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\temailVerified: user.emailVerified,\n\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t\tcreatedAt: user.createdAt,\n\t\t\t\t\t\tupdatedAt: user.updatedAt,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t},\n\t\t\tinvalid,\n\t\t\tsession: {\n\t\t\t\tsession: null,\n\t\t\t\tuser,\n\t\t\t},\n\t\t\tkey: twoFactorCookie,\n\t\t};\n\t}\n\treturn {\n\t\tvalid: async (ctx: GenericEndpointContext) => {\n\t\t\treturn ctx.json({\n\t\t\t\ttoken: session.session.token,\n\t\t\t\tuser: {\n\t\t\t\t\tid: session.user.id,\n\t\t\t\t\temail: session.user.email,\n\t\t\t\t\temailVerified: session.user.emailVerified,\n\t\t\t\t\tname: session.user.name,\n\t\t\t\t\timage: session.user.image,\n\t\t\t\t\tcreatedAt: session.user.createdAt,\n\t\t\t\t\tupdatedAt: session.user.updatedAt,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\tinvalid,\n\t\tsession,\n\t\tkey: `${session.user.id}!${session.session.id}`,\n\t};\n}\n", "import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { safeJSONParse } from \"@better-auth/core/utils\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { sessionMiddleware } from \"../../../api\";\nimport { symmetricDecrypt, symmetricEncrypt } from \"../../../crypto\";\nimport { generateRandomString } from \"../../../crypto/random\";\nimport { TWO_FACTOR_ERROR_CODES } from \"../error-code\";\nimport type {\n\tTwoFactorProvider,\n\tTwoFactorTable,\n\tUserWithTwoFactor,\n} from \"../types\";\nimport { verifyTwoFactor } from \"../verify-two-factor\";\n\nexport interface BackupCodeOptions {\n\t/**\n\t * The amount of backup codes to generate\n\t *\n\t * @default 10\n\t */\n\tamount?: number | undefined;\n\t/**\n\t * The length of the backup codes\n\t *\n\t * @default 10\n\t */\n\tlength?: number | undefined;\n\t/**\n\t * An optional custom function to generate backup codes\n\t */\n\tcustomBackupCodesGenerate?: (() => string[]) | undefined;\n\t/**\n\t * How to store the backup codes in the database, whether encrypted or plain.\n\t */\n\tstoreBackupCodes?:\n\t\t| (\n\t\t\t\t| \"plain\"\n\t\t\t\t| \"encrypted\"\n\t\t\t\t| {\n\t\t\t\t\t\tencrypt: (token: string) => Promise<string>;\n\t\t\t\t\t\tdecrypt: (token: string) => Promise<string>;\n\t\t\t\t  }\n\t\t  )\n\t\t| undefined;\n}\n\nfunction generateBackupCodesFn(options?: BackupCodeOptions | undefined) {\n\treturn Array.from({ length: options?.amount ?? 10 })\n\t\t.fill(null)\n\t\t.map(() => generateRandomString(options?.length ?? 10, \"a-z\", \"0-9\", \"A-Z\"))\n\t\t.map((code) => `${code.slice(0, 5)}-${code.slice(5)}`);\n}\n\nexport async function generateBackupCodes(\n\tsecret: string,\n\toptions?: BackupCodeOptions | undefined,\n) {\n\tconst backupCodes = options?.customBackupCodesGenerate\n\t\t? options.customBackupCodesGenerate()\n\t\t: generateBackupCodesFn(options);\n\tif (options?.storeBackupCodes === \"encrypted\") {\n\t\tconst encCodes = await symmetricEncrypt({\n\t\t\tdata: JSON.stringify(backupCodes),\n\t\t\tkey: secret,\n\t\t});\n\t\treturn {\n\t\t\tbackupCodes,\n\t\t\tencryptedBackupCodes: encCodes,\n\t\t};\n\t}\n\tif (\n\t\ttypeof options?.storeBackupCodes === \"object\" &&\n\t\t\"encrypt\" in options?.storeBackupCodes\n\t) {\n\t\treturn {\n\t\t\tbackupCodes,\n\t\t\tencryptedBackupCodes: await options?.storeBackupCodes.encrypt(\n\t\t\t\tJSON.stringify(backupCodes),\n\t\t\t),\n\t\t};\n\t}\n\treturn {\n\t\tbackupCodes,\n\t\tencryptedBackupCodes: JSON.stringify(backupCodes),\n\t};\n}\n\nexport async function verifyBackupCode(\n\tdata: {\n\t\tbackupCodes: string;\n\t\tcode: string;\n\t},\n\tkey: string,\n\toptions?: BackupCodeOptions | undefined,\n) {\n\tconst codes = await getBackupCodes(data.backupCodes, key, options);\n\tif (!codes) {\n\t\treturn {\n\t\t\tstatus: false,\n\t\t\tupdated: null,\n\t\t};\n\t}\n\treturn {\n\t\tstatus: codes.includes(data.code),\n\t\tupdated: codes.filter((code) => code !== data.code),\n\t};\n}\n\nexport async function getBackupCodes(\n\tbackupCodes: string,\n\tkey: string,\n\toptions?: BackupCodeOptions | undefined,\n) {\n\tif (options?.storeBackupCodes === \"encrypted\") {\n\t\tconst decrypted = await symmetricDecrypt({ key, data: backupCodes });\n\t\treturn safeJSONParse<string[]>(decrypted);\n\t}\n\tif (\n\t\ttypeof options?.storeBackupCodes === \"object\" &&\n\t\t\"decrypt\" in options?.storeBackupCodes\n\t) {\n\t\tconst decrypted = await options?.storeBackupCodes.decrypt(backupCodes);\n\t\treturn safeJSONParse<string[]>(decrypted);\n\t}\n\n\treturn safeJSONParse<string[]>(backupCodes);\n}\n\nconst verifyBackupCodeBodySchema = z.object({\n\tcode: z.string().meta({\n\t\tdescription: `A backup code to verify. Eg: \"123456\"`,\n\t}),\n\t/**\n\t * Disable setting the session cookie\n\t */\n\tdisableSession: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"If true, the session cookie will not be set.\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * if true, the device will be trusted\n\t * for 30 days. It'll be refreshed on\n\t * every sign in request within this time.\n\t */\n\ttrustDevice: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"If true, the device will be trusted for 30 days. It'll be refreshed on every sign in request within this time. Eg: true\",\n\t\t})\n\t\t.optional(),\n});\n\nconst viewBackupCodesBodySchema = z.object({\n\tuserId: z.coerce.string().meta({\n\t\tdescription: `The user ID to view all backup codes. Eg: \"user-id\"`,\n\t}),\n});\n\nconst generateBackupCodesBodySchema = z.object({\n\tpassword: z.string().meta({\n\t\tdescription: \"The users password.\",\n\t}),\n});\n\nexport const backupCode2fa = (opts: BackupCodeOptions) => {\n\tconst twoFactorTable = \"twoFactor\";\n\n\treturn {\n\t\tid: \"backup_code\",\n\t\tendpoints: {\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/verify-backup-code`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.verifyBackupCode`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.twoFactor.verifyBackupCode`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#api-method-two-factor-verify-backup-code)\n\t\t\t */\n\t\t\tverifyBackupCode: createAuthEndpoint(\n\t\t\t\t\"/two-factor/verify-backup-code\",\n\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: verifyBackupCodeBodySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription: \"Verify a backup code for two-factor authentication\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"Backup code verified successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's email address\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\temailVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the email is verified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's profile image URL\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttwoFactorEnabled: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Whether two-factor authentication is enabled for the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the user was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the user was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"twoFactorEnabled\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The authenticated user object with two-factor details\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Session token\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"ID of the user associated with the session\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the session was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\texpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the session expires\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"token\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"expiresAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"The current session object, included unless disableSession is true\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"user\", \"session\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst { session, valid } = await verifyTwoFactor(ctx);\n\t\t\t\t\tconst user = session.user as UserWithTwoFactor;\n\t\t\t\t\tconst twoFactor = await ctx.context.adapter.findOne<TwoFactorTable>({\n\t\t\t\t\t\tmodel: twoFactorTable,\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\tif (!twoFactor) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.BACKUP_CODES_NOT_ENABLED,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst validate = await verifyBackupCode(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbackupCodes: twoFactor.backupCodes,\n\t\t\t\t\t\t\tcode: ctx.body.code,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\topts,\n\t\t\t\t\t);\n\t\t\t\t\tif (!validate.status) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.INVALID_BACKUP_CODE,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst updatedBackupCodes = await symmetricEncrypt({\n\t\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\t\tdata: JSON.stringify(validate.updated),\n\t\t\t\t\t});\n\n\t\t\t\t\tconst updated = await ctx.context.adapter.updateMany({\n\t\t\t\t\t\tmodel: twoFactorTable,\n\t\t\t\t\t\tupdate: {\n\t\t\t\t\t\t\tbackupCodes: updatedBackupCodes,\n\t\t\t\t\t\t},\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"backupCodes\",\n\t\t\t\t\t\t\t\tvalue: twoFactor.backupCodes,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\tif (!updated) {\n\t\t\t\t\t\tthrow new APIError(\"CONFLICT\", {\n\t\t\t\t\t\t\tmessage: \"Failed to verify backup code. Please try again.\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!ctx.body.disableSession) {\n\t\t\t\t\t\treturn valid(ctx);\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\ttoken: session.session?.token,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tid: session.user?.id,\n\t\t\t\t\t\t\temail: session.user.email,\n\t\t\t\t\t\t\temailVerified: session.user.emailVerified,\n\t\t\t\t\t\t\tname: session.user.name,\n\t\t\t\t\t\t\timage: session.user.image,\n\t\t\t\t\t\t\tcreatedAt: session.user.createdAt,\n\t\t\t\t\t\t\tupdatedAt: session.user.updatedAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/generate-backup-codes`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.generateBackupCodes`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.twoFactor.generateBackupCodes`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#api-method-two-factor-generate-backup-codes)\n\t\t\t */\n\t\t\tgenerateBackupCodes: createAuthEndpoint(\n\t\t\t\t\"/two-factor/generate-backup-codes\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: generateBackupCodesBodySchema,\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Generate new backup codes for two-factor authentication\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\t\t\tdescription: \"Backup codes generated successfully\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the backup codes were generated successfully\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackupCodes: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\titems: { type: \"string\" },\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Array of generated backup codes in plain text\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"status\", \"backupCodes\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst user = ctx.context.session.user as UserWithTwoFactor;\n\t\t\t\t\tif (!user.twoFactorEnabled) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.TWO_FACTOR_NOT_ENABLED,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tawait ctx.context.password.checkPassword(user.id, ctx);\n\t\t\t\t\tconst backupCodes = await generateBackupCodes(\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\topts,\n\t\t\t\t\t);\n\t\t\t\t\tawait ctx.context.adapter.updateMany({\n\t\t\t\t\t\tmodel: twoFactorTable,\n\t\t\t\t\t\tupdate: {\n\t\t\t\t\t\t\tbackupCodes: backupCodes.encryptedBackupCodes,\n\t\t\t\t\t\t},\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\t\t\tvalue: ctx.context.session.user.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tstatus: true,\n\t\t\t\t\t\tbackupCodes: backupCodes.backupCodes,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/view-backup-codes`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.viewBackupCodes`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#api-method-two-factor-view-backup-codes)\n\t\t\t */\n\t\t\tviewBackupCodes: createAuthEndpoint(\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: viewBackupCodesBodySchema,\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst twoFactor = await ctx.context.adapter.findOne<TwoFactorTable>({\n\t\t\t\t\t\tmodel: twoFactorTable,\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\t\t\tvalue: ctx.body.userId,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\tif (!twoFactor) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.BACKUP_CODES_NOT_ENABLED,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst decryptedBackupCodes = await getBackupCodes(\n\t\t\t\t\t\ttwoFactor.backupCodes,\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\topts,\n\t\t\t\t\t);\n\n\t\t\t\t\tif (!decryptedBackupCodes) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.INVALID_BACKUP_CODE,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tstatus: true,\n\t\t\t\t\t\tbackupCodes: decryptedBackupCodes,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t} satisfies TwoFactorProvider;\n};\n", "import { base64Url } from \"@better-auth/utils/base64\";\nimport { createHash } from \"@better-auth/utils/hash\";\n\nexport const defaultKeyHasher = async (token: string) => {\n\tconst hash = await createHash(\"SHA-256\").digest(\n\t\tnew TextEncoder().encode(token),\n\t);\n\tconst hashed = base64Url.encode(new Uint8Array(hash), {\n\t\tpadding: false,\n\t});\n\treturn hashed;\n};\n", "import type { Awaitable, GenericEndpointContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { setSessionCookie } from \"../../../cookies\";\nimport {\n\tconstantTimeEqual,\n\tgenerateRandomString,\n\tsymmetricDecrypt,\n\tsymmetricEncrypt,\n} from \"../../../crypto\";\nimport { TWO_FACTOR_ERROR_CODES } from \"../error-code\";\nimport type { TwoFactorProvider, UserWithTwoFactor } from \"../types\";\nimport { defaultKeyHasher } from \"../utils\";\nimport { verifyTwoFactor } from \"../verify-two-factor\";\n\nexport interface OTPOptions {\n\t/**\n\t * How long the opt will be valid for in\n\t * minutes\n\t *\n\t * @default \"3 mins\"\n\t */\n\tperiod?: number | undefined;\n\t/**\n\t * Number of digits for the OTP code\n\t *\n\t * @default 6\n\t */\n\tdigits?: number | undefined;\n\t/**\n\t * Send the otp to the user\n\t *\n\t * @param user - The user to send the otp to\n\t * @param otp - The otp to send\n\t * @param request - The request object\n\t * @returns void | Promise<void>\n\t */\n\tsendOTP?:\n\t\t| ((\n\t\t\t\t/**\n\t\t\t\t * The user to send the otp to\n\t\t\t\t * @type UserWithTwoFactor\n\t\t\t\t * @default UserWithTwoFactors\n\t\t\t\t */\n\t\t\t\tdata: {\n\t\t\t\t\tuser: UserWithTwoFactor;\n\t\t\t\t\totp: string;\n\t\t\t\t},\n\t\t\t\t/**\n\t\t\t\t * The request object\n\t\t\t\t */\n\t\t\t\tctx?: GenericEndpointContext,\n\t\t  ) => Awaitable<void>)\n\t\t| undefined;\n\t/**\n\t * The number of allowed attempts for the OTP\n\t *\n\t * @default 5\n\t */\n\tallowedAttempts?: number | undefined;\n\tstoreOTP?:\n\t\t| (\n\t\t\t\t| \"plain\"\n\t\t\t\t| \"encrypted\"\n\t\t\t\t| \"hashed\"\n\t\t\t\t| { hash: (token: string) => Promise<string> }\n\t\t\t\t| {\n\t\t\t\t\t\tencrypt: (token: string) => Promise<string>;\n\t\t\t\t\t\tdecrypt: (token: string) => Promise<string>;\n\t\t\t\t  }\n\t\t  )\n\t\t| undefined;\n}\n\nconst verifyOTPBodySchema = z.object({\n\tcode: z.string().meta({\n\t\tdescription: 'The otp code to verify. Eg: \"012345\"',\n\t}),\n\t/**\n\t * if true, the device will be trusted\n\t * for 30 days. It'll be refreshed on\n\t * every sign in request within this time.\n\t */\n\ttrustDevice: z.boolean().optional().meta({\n\t\tdescription:\n\t\t\t\"If true, the device will be trusted for 30 days. It'll be refreshed on every sign in request within this time. Eg: true\",\n\t}),\n});\n\nconst send2FaOTPBodySchema = z\n\t.object({\n\t\t/**\n\t\t * if true, the device will be trusted\n\t\t * for 30 days. It'll be refreshed on\n\t\t * every sign in request within this time.\n\t\t */\n\t\ttrustDevice: z.boolean().optional().meta({\n\t\t\tdescription:\n\t\t\t\t\"If true, the device will be trusted for 30 days. It'll be refreshed on every sign in request within this time. Eg: true\",\n\t\t}),\n\t})\n\t.optional();\n\n/**\n * The otp adapter is created from the totp adapter.\n */\nexport const otp2fa = (options?: OTPOptions | undefined) => {\n\tconst opts = {\n\t\tstoreOTP: \"plain\",\n\t\tdigits: 6,\n\t\t...options,\n\t\tperiod: (options?.period || 3) * 60 * 1000,\n\t};\n\n\tasync function storeOTP(ctx: GenericEndpointContext, otp: string) {\n\t\tif (opts.storeOTP === \"hashed\") {\n\t\t\treturn await defaultKeyHasher(otp);\n\t\t}\n\t\tif (typeof opts.storeOTP === \"object\" && \"hash\" in opts.storeOTP) {\n\t\t\treturn await opts.storeOTP.hash(otp);\n\t\t}\n\t\tif (typeof opts.storeOTP === \"object\" && \"encrypt\" in opts.storeOTP) {\n\t\t\treturn await opts.storeOTP.encrypt(otp);\n\t\t}\n\t\tif (opts.storeOTP === \"encrypted\") {\n\t\t\treturn await symmetricEncrypt({\n\t\t\t\tkey: ctx.context.secret,\n\t\t\t\tdata: otp,\n\t\t\t});\n\t\t}\n\t\treturn otp;\n\t}\n\n\tasync function decryptOTP(ctx: GenericEndpointContext, otp: string) {\n\t\tif (opts.storeOTP === \"hashed\") {\n\t\t\treturn await defaultKeyHasher(otp);\n\t\t}\n\t\tif (opts.storeOTP === \"encrypted\") {\n\t\t\treturn await symmetricDecrypt({\n\t\t\t\tkey: ctx.context.secret,\n\t\t\t\tdata: otp,\n\t\t\t});\n\t\t}\n\t\tif (typeof opts.storeOTP === \"object\" && \"encrypt\" in opts.storeOTP) {\n\t\t\treturn await opts.storeOTP.decrypt(otp);\n\t\t}\n\t\tif (typeof opts.storeOTP === \"object\" && \"hash\" in opts.storeOTP) {\n\t\t\treturn await opts.storeOTP.hash(otp);\n\t\t}\n\t\treturn otp;\n\t}\n\n\t/**\n\t * Generate OTP and send it to the user.\n\t */\n\tconst send2FaOTP = createAuthEndpoint(\n\t\t\"/two-factor/send-otp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: send2FaOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Send two factor OTP\",\n\t\t\t\t\tdescription: \"Send two factor OTP to the user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Successful response\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (!options || !options.sendOTP) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\"send otp isn't configured. Please configure the send otp function on otp options.\",\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"otp isn't configured\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst { session, key } = await verifyTwoFactor(ctx);\n\t\t\tconst code = generateRandomString(opts.digits, \"0-9\");\n\t\t\tconst hashedCode = await storeOTP(ctx, code);\n\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\tvalue: `${hashedCode}:0`,\n\t\t\t\tidentifier: `2fa-otp-${key}`,\n\t\t\t\texpiresAt: new Date(Date.now() + opts.period),\n\t\t\t});\n\t\t\tconst sendOTPResult = options.sendOTP(\n\t\t\t\t{ user: session.user as UserWithTwoFactor, otp: code },\n\t\t\t\tctx,\n\t\t\t);\n\t\t\tif (sendOTPResult instanceof Promise) {\n\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\tsendOTPResult.catch((e: unknown) => {\n\t\t\t\t\t\tctx.context.logger.error(\"Failed to send two-factor OTP\", e);\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn ctx.json({ status: true });\n\t\t},\n\t);\n\n\tconst verifyOTP = createAuthEndpoint(\n\t\t\"/two-factor/verify-otp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: verifyOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Verify two factor OTP\",\n\t\t\t\t\tdescription: \"Verify two factor OTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Two-factor OTP verified successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Session token for the authenticated session\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's email address\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temailVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the email is verified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's profile image URL\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Timestamp when the user was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the user was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"id\", \"createdAt\", \"updatedAt\"],\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The authenticated user object\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"token\", \"user\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { session, key, valid, invalid } = await verifyTwoFactor(ctx);\n\t\t\tconst toCheckOtp =\n\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t`2fa-otp-${key}`,\n\t\t\t\t);\n\t\t\tconst [otp, counter] = toCheckOtp?.value?.split(\":\") ?? [];\n\t\t\tconst decryptedOtp = await decryptOTP(ctx, otp!);\n\t\t\tif (!toCheckOtp || toCheckOtp.expiresAt < new Date()) {\n\t\t\t\tif (toCheckOtp) {\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\t\ttoCheckOtp.id,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.OTP_HAS_EXPIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst allowedAttempts = options?.allowedAttempts || 5;\n\t\t\tif (parseInt(counter!) >= allowedAttempts) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\ttoCheckOtp.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.TOO_MANY_ATTEMPTS_REQUEST_NEW_CODE,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst isCodeValid = constantTimeEqual(\n\t\t\t\tnew TextEncoder().encode(decryptedOtp),\n\t\t\t\tnew TextEncoder().encode(ctx.body.code),\n\t\t\t);\n\t\t\tif (isCodeValid) {\n\t\t\t\tif (!session.user.twoFactorEnabled) {\n\t\t\t\t\tif (!session.session) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst updatedUser = await ctx.context.internalAdapter.updateUser(\n\t\t\t\t\t\tsession.user.id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttwoFactorEnabled: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t\tconst newSession = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\tsession.user.id,\n\t\t\t\t\t\tfalse,\n\t\t\t\t\t\tsession.session,\n\t\t\t\t\t);\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteSession(\n\t\t\t\t\t\tsession.session.token,\n\t\t\t\t\t);\n\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\tsession: newSession,\n\t\t\t\t\t\tuser: updatedUser,\n\t\t\t\t\t});\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\ttoken: newSession.token,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tid: updatedUser.id,\n\t\t\t\t\t\t\temail: updatedUser.email,\n\t\t\t\t\t\t\temailVerified: updatedUser.emailVerified,\n\t\t\t\t\t\t\tname: updatedUser.name,\n\t\t\t\t\t\t\timage: updatedUser.image,\n\t\t\t\t\t\t\tcreatedAt: updatedUser.createdAt,\n\t\t\t\t\t\t\tupdatedAt: updatedUser.updatedAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn valid(ctx);\n\t\t\t} else {\n\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(\n\t\t\t\t\ttoCheckOtp.id,\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: `${otp}:${(parseInt(counter!, 10) || 0) + 1}`,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\treturn invalid(\"INVALID_CODE\");\n\t\t\t}\n\t\t},\n\t);\n\n\treturn {\n\t\tid: \"otp\",\n\t\tendpoints: {\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/send-otp`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.send2FaOTP`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.twoFactor.sendOtp`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#api-method-two-factor-send-otp)\n\t\t\t */\n\t\t\tsendTwoFactorOTP: send2FaOTP,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/verify-otp`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.verifyOTP`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.twoFactor.verifyOtp`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#api-method-two-factor-verify-otp)\n\t\t\t */\n\t\t\tverifyTwoFactorOTP: verifyOTP,\n\t\t},\n\t} satisfies TwoFactorProvider;\n};\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\n\nexport const schema = {\n\tuser: {\n\t\tfields: {\n\t\t\ttwoFactorEnabled: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\trequired: false,\n\t\t\t\tdefaultValue: false,\n\t\t\t\tinput: false,\n\t\t\t},\n\t\t},\n\t},\n\ttwoFactor: {\n\t\tfields: {\n\t\t\tsecret: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t\treturned: false,\n\t\t\t\tindex: true,\n\t\t\t},\n\t\t\tbackupCodes: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t\treturned: false,\n\t\t\t},\n\t\t\tuserId: {\n\t\t\t\ttype: \"string\",\n\t\t\t\trequired: true,\n\t\t\t\treturned: false,\n\t\t\t\treferences: {\n\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t},\n\t\t\t\tindex: true,\n\t\t\t},\n\t\t},\n\t},\n} satisfies BetterAuthPluginDBSchema;\n", "function getAlphabet(hex) {\n  return hex ? \"0123456789ABCDEFGHIJKLMNOPQRSTUV\" : \"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567\";\n}\nfunction createDecodeMap(alphabet) {\n  const decodeMap = /* @__PURE__ */ new Map();\n  for (let i = 0; i < alphabet.length; i++) {\n    decodeMap.set(alphabet[i], i);\n  }\n  return decodeMap;\n}\nfunction base32Encode(data, alphabet, padding) {\n  let result = \"\";\n  let buffer = 0;\n  let shift = 0;\n  for (const byte of data) {\n    buffer = buffer << 8 | byte;\n    shift += 8;\n    while (shift >= 5) {\n      shift -= 5;\n      result += alphabet[buffer >> shift & 31];\n    }\n  }\n  if (shift > 0) {\n    result += alphabet[buffer << 5 - shift & 31];\n  }\n  if (padding) {\n    const padCount = (8 - result.length % 8) % 8;\n    result += \"=\".repeat(padCount);\n  }\n  return result;\n}\nfunction base32Decode(data, alphabet) {\n  const decodeMap = createDecodeMap(alphabet);\n  const result = [];\n  let buffer = 0;\n  let bitsCollected = 0;\n  for (const char of data) {\n    if (char === \"=\")\n      break;\n    const value = decodeMap.get(char);\n    if (value === void 0) {\n      throw new Error(`Invalid Base32 character: ${char}`);\n    }\n    buffer = buffer << 5 | value;\n    bitsCollected += 5;\n    while (bitsCollected >= 8) {\n      bitsCollected -= 8;\n      result.push(buffer >> bitsCollected & 255);\n    }\n  }\n  return Uint8Array.from(result);\n}\nconst base32 = {\n  /**\n   * Encodes data into a Base32 string.\n   * @param data - The data to encode (ArrayBuffer, TypedArray, or string).\n   * @param options - Encoding options.\n   * @returns The Base32 encoded string.\n   */\n  encode(data, options = {}) {\n    const alphabet = getAlphabet(false);\n    const buffer = typeof data === \"string\" ? new TextEncoder().encode(data) : new Uint8Array(data);\n    return base32Encode(buffer, alphabet, options.padding ?? true);\n  },\n  /**\n   * Decodes a Base32 string into a Uint8Array.\n   * @param data - The Base32 encoded string or ArrayBuffer/TypedArray.\n   * @returns The decoded Uint8Array.\n   */\n  decode(data) {\n    if (typeof data !== \"string\") {\n      data = new TextDecoder().decode(data);\n    }\n    const alphabet = getAlphabet(false);\n    return base32Decode(data, alphabet);\n  }\n};\nconst base32hex = {\n  /**\n   * Encodes data into a Base32hex string.\n   * @param data - The data to encode (ArrayBuffer, TypedArray, or string).\n   * @param options - Encoding options.\n   * @returns The Base32hex encoded string.\n   */\n  encode(data, options = {}) {\n    const alphabet = getAlphabet(true);\n    const buffer = typeof data === \"string\" ? new TextEncoder().encode(data) : new Uint8Array(data);\n    return base32Encode(buffer, alphabet, options.padding ?? true);\n  },\n  /**\n   * Decodes a Base32hex string into a Uint8Array.\n   * @param data - The Base32hex encoded string.\n   * @returns The decoded Uint8Array.\n   */\n  decode(data) {\n    const alphabet = getAlphabet(true);\n    return base32Decode(data, alphabet);\n  }\n};\n\nexport { base32, base32hex };\n", "import { base32 } from './base32.mjs';\nimport { createHMAC } from './hmac.mjs';\nimport './hex.mjs';\nimport './base64.mjs';\nimport './index.mjs';\n\nconst defaultPeriod = 30;\nconst defaultDigits = 6;\nasync function generateHOTP(secret, {\n  counter,\n  digits,\n  hash = \"SHA-1\"\n}) {\n  const _digits = digits ?? defaultDigits;\n  if (_digits < 1 || _digits > 8) {\n    throw new TypeError(\"Digits must be between 1 and 8\");\n  }\n  const buffer = new ArrayBuffer(8);\n  new DataView(buffer).setBigUint64(0, BigInt(counter), false);\n  const bytes = new Uint8Array(buffer);\n  const hmacResult = new Uint8Array(await createHMAC(hash).sign(secret, bytes));\n  const offset = hmacResult[hmacResult.length - 1] & 15;\n  const truncated = (hmacResult[offset] & 127) << 24 | (hmacResult[offset + 1] & 255) << 16 | (hmacResult[offset + 2] & 255) << 8 | hmacResult[offset + 3] & 255;\n  const otp = truncated % 10 ** _digits;\n  return otp.toString().padStart(_digits, \"0\");\n}\nasync function generateTOTP(secret, options) {\n  const digits = options?.digits ?? defaultDigits;\n  const period = options?.period ?? defaultPeriod;\n  const milliseconds = period * 1e3;\n  const counter = Math.floor(Date.now() / milliseconds);\n  return await generateHOTP(secret, { counter, digits, hash: options?.hash });\n}\nasync function verifyTOTP(otp, {\n  window = 1,\n  digits = defaultDigits,\n  secret,\n  period = defaultPeriod\n}) {\n  const milliseconds = period * 1e3;\n  const counter = Math.floor(Date.now() / milliseconds);\n  for (let i = -window; i <= window; i++) {\n    const generatedOTP = await generateHOTP(secret, {\n      counter: counter + i,\n      digits\n    });\n    if (otp === generatedOTP) {\n      return true;\n    }\n  }\n  return false;\n}\nfunction generateQRCode({\n  issuer,\n  account,\n  secret,\n  digits = defaultDigits,\n  period = defaultPeriod\n}) {\n  const encodedIssuer = encodeURIComponent(issuer);\n  const encodedAccountName = encodeURIComponent(account);\n  const baseURI = `otpauth://totp/${encodedIssuer}:${encodedAccountName}`;\n  const params = new URLSearchParams({\n    secret: base32.encode(secret, {\n      padding: false\n    }),\n    issuer\n  });\n  if (digits !== void 0) {\n    params.set(\"digits\", digits.toString());\n  }\n  if (period !== void 0) {\n    params.set(\"period\", period.toString());\n  }\n  return `${baseURI}?${params.toString()}`;\n}\nconst createOTP = (secret, opts) => {\n  const digits = opts?.digits ?? defaultDigits;\n  const period = opts?.period ?? defaultPeriod;\n  return {\n    hotp: (counter) => generateHOTP(secret, { counter, digits }),\n    totp: () => generateTOTP(secret, { digits, period }),\n    verify: (otp, options) => verifyTOTP(otp, { secret, digits, period, ...options }),\n    url: (issuer, account) => generateQRCode({ issuer, account, secret, digits, period })\n  };\n};\n\nexport { createOTP };\n", "import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { createOTP } from \"@better-auth/utils/otp\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { sessionMiddleware } from \"../../../api\";\nimport { setSessionCookie } from \"../../../cookies\";\nimport { symmetricDecrypt } from \"../../../crypto\";\nimport type { BackupCodeOptions } from \"../backup-codes\";\nimport { TWO_FACTOR_ERROR_CODES } from \"../error-code\";\nimport type {\n\tTwoFactorProvider,\n\tTwoFactorTable,\n\tUserWithTwoFactor,\n} from \"../types\";\nimport { verifyTwoFactor } from \"../verify-two-factor\";\n\nexport type TOTPOptions = {\n\t/**\n\t * Issuer\n\t */\n\tissuer?: string | undefined;\n\t/**\n\t * How many digits the otp to be\n\t *\n\t * @default 6\n\t */\n\tdigits?: (6 | 8) | undefined;\n\t/**\n\t * Period for otp in seconds.\n\t * @default 30\n\t */\n\tperiod?: number | undefined;\n\t/**\n\t * Backup codes configuration\n\t */\n\tbackupCodes?: BackupCodeOptions | undefined;\n\t/**\n\t * Disable totp\n\t */\n\tdisable?: boolean | undefined;\n};\n\nconst generateTOTPBodySchema = z.object({\n\tsecret: z.string().meta({\n\t\tdescription: \"The secret to generate the TOTP code\",\n\t}),\n});\n\nconst getTOTPURIBodySchema = z.object({\n\tpassword: z.string().meta({\n\t\tdescription: \"User password\",\n\t}),\n});\n\nconst verifyTOTPBodySchema = z.object({\n\tcode: z.string().meta({\n\t\tdescription: 'The otp code to verify. Eg: \"012345\"',\n\t}),\n\t/**\n\t * if true, the device will be trusted\n\t * for 30 days. It'll be refreshed on\n\t * every sign in request within this time.\n\t */\n\ttrustDevice: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"If true, the device will be trusted for 30 days. It'll be refreshed on every sign in request within this time. Eg: true\",\n\t\t})\n\t\t.optional(),\n});\n\nexport const totp2fa = (options?: TOTPOptions | undefined) => {\n\tconst opts = {\n\t\t...options,\n\t\tdigits: options?.digits || 6,\n\t\tperiod: options?.period || 30,\n\t};\n\n\tconst twoFactorTable = \"twoFactor\";\n\n\tconst generateTOTP = createAuthEndpoint(\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: generateTOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Generate TOTP code\",\n\t\t\t\t\tdescription: \"Use this endpoint to generate a TOTP code\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Successful response\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tcode: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (options?.disable) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\"totp isn't configured. please pass totp option on two factor plugin to enable totp\",\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"totp isn't configured\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst code = await createOTP(ctx.body.secret, {\n\t\t\t\tperiod: opts.period,\n\t\t\t\tdigits: opts.digits,\n\t\t\t}).totp();\n\t\t\treturn { code };\n\t\t},\n\t);\n\n\tconst getTOTPURI = createAuthEndpoint(\n\t\t\"/two-factor/get-totp-uri\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tuse: [sessionMiddleware],\n\t\t\tbody: getTOTPURIBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Get TOTP URI\",\n\t\t\t\t\tdescription: \"Use this endpoint to get the TOTP URI\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Successful response\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\ttotpURI: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (options?.disable) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\"totp isn't configured. please pass totp option on two factor plugin to enable totp\",\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"totp isn't configured\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = ctx.context.session.user as UserWithTwoFactor;\n\t\t\tconst twoFactor = await ctx.context.adapter.findOne<TwoFactorTable>({\n\t\t\t\tmodel: twoFactorTable,\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!twoFactor) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.TOTP_NOT_ENABLED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst secret = await symmetricDecrypt({\n\t\t\t\tkey: ctx.context.secret,\n\t\t\t\tdata: twoFactor.secret,\n\t\t\t});\n\t\t\tawait ctx.context.password.checkPassword(user.id, ctx);\n\t\t\tconst totpURI = createOTP(secret, {\n\t\t\t\tdigits: opts.digits,\n\t\t\t\tperiod: opts.period,\n\t\t\t}).url(options?.issuer || ctx.context.appName, user.email);\n\t\t\treturn {\n\t\t\t\ttotpURI,\n\t\t\t};\n\t\t},\n\t);\n\n\tconst verifyTOTP = createAuthEndpoint(\n\t\t\"/two-factor/verify-totp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: verifyTOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Verify two factor TOTP\",\n\t\t\t\t\tdescription: \"Verify two factor TOTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Successful response\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (options?.disable) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\"totp isn't configured. please pass totp option on two factor plugin to enable totp\",\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"totp isn't configured\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst { session, valid, invalid } = await verifyTwoFactor(ctx);\n\t\t\tconst user = session.user as UserWithTwoFactor;\n\t\t\tconst twoFactor = await ctx.context.adapter.findOne<TwoFactorTable>({\n\t\t\t\tmodel: twoFactorTable,\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\tif (!twoFactor) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: TWO_FACTOR_ERROR_CODES.TOTP_NOT_ENABLED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst decrypted = await symmetricDecrypt({\n\t\t\t\tkey: ctx.context.secret,\n\t\t\t\tdata: twoFactor.secret,\n\t\t\t});\n\t\t\tconst status = await createOTP(decrypted, {\n\t\t\t\tperiod: opts.period,\n\t\t\t\tdigits: opts.digits,\n\t\t\t}).verify(ctx.body.code);\n\t\t\tif (!status) {\n\t\t\t\treturn invalid(\"INVALID_CODE\");\n\t\t\t}\n\n\t\t\tif (!user.twoFactorEnabled) {\n\t\t\t\tif (!session.session) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst updatedUser = await ctx.context.internalAdapter.updateUser(\n\t\t\t\t\tuser.id,\n\t\t\t\t\t{\n\t\t\t\t\t\ttwoFactorEnabled: true,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tconst newSession = await ctx.context.internalAdapter\n\t\t\t\t\t.createSession(user.id, false, session.session)\n\t\t\t\t\t.catch((e) => {\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t});\n\n\t\t\t\tawait ctx.context.internalAdapter.deleteSession(session.session.token);\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession: newSession,\n\t\t\t\t\tuser: updatedUser,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn valid(ctx);\n\t\t},\n\t);\n\n\treturn {\n\t\tid: \"totp\",\n\t\tendpoints: {\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/totp/generate`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.generateTOTP`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#totp)\n\t\t\t */\n\t\t\tgenerateTOTP: generateTOTP,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/get-totp-uri`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.getTOTPURI`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.twoFactor.getTotpUri`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#getting-totp-uri)\n\t\t\t */\n\t\t\tgetTOTPURI: getTOTPURI,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/verify-totp`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.verifyTOTP`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.twoFactor.verifyTotp`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#verifying-totp)\n\t\t\t */\n\t\t\tverifyTOTP,\n\t\t},\n\t} satisfies TwoFactorProvider;\n};\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { createHMAC } from \"@better-auth/utils/hmac\";\nimport { createOTP } from \"@better-auth/utils/otp\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { sessionMiddleware } from \"../../api\";\nimport { deleteSessionCookie, setSessionCookie } from \"../../cookies\";\nimport { symmetricEncrypt } from \"../../crypto\";\nimport { generateRandomString } from \"../../crypto/random\";\nimport { mergeSchema } from \"../../db/schema\";\nimport { validatePassword } from \"../../utils/password\";\nimport type { BackupCodeOptions } from \"./backup-codes\";\nimport { backupCode2fa, generateBackupCodes } from \"./backup-codes\";\nimport {\n\tTRUST_DEVICE_COOKIE_MAX_AGE,\n\tTRUST_DEVICE_COOKIE_NAME,\n\tTWO_FACTOR_COOKIE_NAME,\n} from \"./constant\";\nimport { TWO_FACTOR_ERROR_CODES } from \"./error-code\";\nimport { otp2fa } from \"./otp\";\nimport { schema } from \"./schema\";\nimport { totp2fa } from \"./totp\";\nimport type { TwoFactorOptions, UserWithTwoFactor } from \"./types\";\n\nexport * from \"./error-code\";\n\nconst enableTwoFactorBodySchema = z.object({\n\tpassword: z.string().meta({\n\t\tdescription: \"User password\",\n\t}),\n\tissuer: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"Custom issuer for the TOTP URI\",\n\t\t})\n\t\t.optional(),\n});\n\nconst disableTwoFactorBodySchema = z.object({\n\tpassword: z.string().meta({\n\t\tdescription: \"User password\",\n\t}),\n});\n\nexport const twoFactor = <O extends TwoFactorOptions>(options?: O) => {\n\tconst opts = {\n\t\ttwoFactorTable: \"twoFactor\",\n\t};\n\tconst backupCodeOptions = {\n\t\tstoreBackupCodes: \"encrypted\",\n\t\t...options?.backupCodeOptions,\n\t} satisfies BackupCodeOptions;\n\tconst totp = totp2fa(options?.totpOptions);\n\tconst backupCode = backupCode2fa(backupCodeOptions);\n\tconst otp = otp2fa(options?.otpOptions);\n\n\treturn {\n\t\tid: \"two-factor\",\n\t\tendpoints: {\n\t\t\t...totp.endpoints,\n\t\t\t...otp.endpoints,\n\t\t\t...backupCode.endpoints,\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/enable`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.enableTwoFactor`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.twoFactor.enable`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#api-method-two-factor-enable)\n\t\t\t */\n\t\t\tenableTwoFactor: createAuthEndpoint(\n\t\t\t\t\"/two-factor/enable\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: enableTwoFactorBodySchema,\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tsummary: \"Enable two factor authentication\",\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Use this endpoint to enable two factor authentication. This will generate a TOTP URI and backup codes. Once the user verifies the TOTP URI, the two factor authentication will be enabled.\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Successful response\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttotpURI: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"TOTP URI\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackupCodes: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Backup codes\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst user = ctx.context.session.user as UserWithTwoFactor;\n\t\t\t\t\tconst { password, issuer } = ctx.body;\n\t\t\t\t\tconst isPasswordValid = await validatePassword(ctx, {\n\t\t\t\t\t\tpassword,\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t});\n\t\t\t\t\tif (!isPasswordValid) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_PASSWORD,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst secret = generateRandomString(32);\n\t\t\t\t\tconst encryptedSecret = await symmetricEncrypt({\n\t\t\t\t\t\tkey: ctx.context.secret,\n\t\t\t\t\t\tdata: secret,\n\t\t\t\t\t});\n\t\t\t\t\tconst backupCodes = await generateBackupCodes(\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\tbackupCodeOptions,\n\t\t\t\t\t);\n\t\t\t\t\tif (options?.skipVerificationOnEnable) {\n\t\t\t\t\t\tconst updatedUser = await ctx.context.internalAdapter.updateUser(\n\t\t\t\t\t\t\tuser.id,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttwoFactorEnabled: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst newSession = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\t\tupdatedUser.id,\n\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\tctx.context.session.session,\n\t\t\t\t\t\t);\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * Update the session cookie with the new user data\n\t\t\t\t\t\t */\n\t\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\t\tsession: newSession,\n\t\t\t\t\t\t\tuser: updatedUser,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t//remove current session\n\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteSession(\n\t\t\t\t\t\t\tctx.context.session.session.token,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t//delete existing two factor\n\t\t\t\t\tawait ctx.context.adapter.deleteMany({\n\t\t\t\t\t\tmodel: opts.twoFactorTable,\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\n\t\t\t\t\tawait ctx.context.adapter.create({\n\t\t\t\t\t\tmodel: opts.twoFactorTable,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tsecret: encryptedSecret,\n\t\t\t\t\t\t\tbackupCodes: backupCodes.encryptedBackupCodes,\n\t\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tconst totpURI = createOTP(secret, {\n\t\t\t\t\t\tdigits: options?.totpOptions?.digits || 6,\n\t\t\t\t\t\tperiod: options?.totpOptions?.period,\n\t\t\t\t\t}).url(issuer || options?.issuer || ctx.context.appName, user.email);\n\t\t\t\t\treturn ctx.json({ totpURI, backupCodes: backupCodes.backupCodes });\n\t\t\t\t},\n\t\t\t),\n\t\t\t/**\n\t\t\t * ### Endpoint\n\t\t\t *\n\t\t\t * POST `/two-factor/disable`\n\t\t\t *\n\t\t\t * ### API Methods\n\t\t\t *\n\t\t\t * **server:**\n\t\t\t * `auth.api.disableTwoFactor`\n\t\t\t *\n\t\t\t * **client:**\n\t\t\t * `authClient.twoFactor.disable`\n\t\t\t *\n\t\t\t * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/2fa#api-method-two-factor-disable)\n\t\t\t */\n\t\t\tdisableTwoFactor: createAuthEndpoint(\n\t\t\t\t\"/two-factor/disable\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: disableTwoFactorBodySchema,\n\t\t\t\t\tuse: [sessionMiddleware],\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tsummary: \"Disable two factor authentication\",\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Use this endpoint to disable two factor authentication.\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Successful response\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst user = ctx.context.session.user as UserWithTwoFactor;\n\t\t\t\t\tconst { password } = ctx.body;\n\t\t\t\t\tconst isPasswordValid = await validatePassword(ctx, {\n\t\t\t\t\t\tpassword,\n\t\t\t\t\t\tuserId: user.id,\n\t\t\t\t\t});\n\t\t\t\t\tif (!isPasswordValid) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_PASSWORD,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst updatedUser = await ctx.context.internalAdapter.updateUser(\n\t\t\t\t\t\tuser.id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttwoFactorEnabled: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t\tawait ctx.context.adapter.delete({\n\t\t\t\t\t\tmodel: opts.twoFactorTable,\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\t\t\tvalue: updatedUser.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\tconst newSession = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\tupdatedUser.id,\n\t\t\t\t\t\tfalse,\n\t\t\t\t\t\tctx.context.session.session,\n\t\t\t\t\t);\n\t\t\t\t\t/**\n\t\t\t\t\t * Update the session cookie with the new user data\n\t\t\t\t\t */\n\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\tsession: newSession,\n\t\t\t\t\t\tuser: updatedUser,\n\t\t\t\t\t});\n\t\t\t\t\t//remove current session\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteSession(\n\t\t\t\t\t\tctx.context.session.session.token,\n\t\t\t\t\t);\n\t\t\t\t\treturn ctx.json({ status: true });\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\toptions: options as NoInfer<O>,\n\t\thooks: {\n\t\t\tafter: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\tcontext.path === \"/sign-in/email\" ||\n\t\t\t\t\t\t\tcontext.path === \"/sign-in/username\" ||\n\t\t\t\t\t\t\tcontext.path === \"/sign-in/phone-number\"\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst data = ctx.context.newSession;\n\t\t\t\t\t\tif (!data) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!data?.user.twoFactorEnabled) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst trustDeviceCookieAttrs = ctx.context.createAuthCookie(\n\t\t\t\t\t\t\tTRUST_DEVICE_COOKIE_NAME,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tmaxAge: TRUST_DEVICE_COOKIE_MAX_AGE,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t\t// Check for trust device cookie\n\t\t\t\t\t\tconst trustDeviceCookie = await ctx.getSignedCookie(\n\t\t\t\t\t\t\ttrustDeviceCookieAttrs.name,\n\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (trustDeviceCookie) {\n\t\t\t\t\t\t\tconst [token, sessionToken] = trustDeviceCookie.split(\"!\");\n\t\t\t\t\t\t\tconst expectedToken = await createHMAC(\n\t\t\t\t\t\t\t\t\"SHA-256\",\n\t\t\t\t\t\t\t\t\"base64urlnopad\",\n\t\t\t\t\t\t\t).sign(ctx.context.secret, `${data.user.id}!${sessionToken}`);\n\n\t\t\t\t\t\t\t// Checks if the token is signed correctly, not that its the current session token\n\t\t\t\t\t\t\tif (token === expectedToken) {\n\t\t\t\t\t\t\t\t// Trust device cookie is valid, refresh it and skip 2FA\n\t\t\t\t\t\t\t\tconst newTrustDeviceCookie = ctx.context.createAuthCookie(\n\t\t\t\t\t\t\t\t\tTRUST_DEVICE_COOKIE_NAME,\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tmaxAge: TRUST_DEVICE_COOKIE_MAX_AGE,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tconst newToken = await createHMAC(\n\t\t\t\t\t\t\t\t\t\"SHA-256\",\n\t\t\t\t\t\t\t\t\t\"base64urlnopad\",\n\t\t\t\t\t\t\t\t).sign(\n\t\t\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t\t\t\t`${data.user.id}!${data.session.token}`,\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tawait ctx.setSignedCookie(\n\t\t\t\t\t\t\t\t\tnewTrustDeviceCookie.name,\n\t\t\t\t\t\t\t\t\t`${newToken}!${data.session.token}`,\n\t\t\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t\t\t\ttrustDeviceCookieAttrs.attributes,\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * remove the session cookie. It's set by the sign in credential\n\t\t\t\t\t\t */\n\t\t\t\t\t\tdeleteSessionCookie(ctx, true);\n\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteSession(data.session.token);\n\t\t\t\t\t\tconst maxAge = (options?.otpOptions?.period ?? 3) * 60; // 3 minutes\n\t\t\t\t\t\tconst twoFactorCookie = ctx.context.createAuthCookie(\n\t\t\t\t\t\t\tTWO_FACTOR_COOKIE_NAME,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tmaxAge,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst identifier = `2fa-${generateRandomString(20)}`;\n\t\t\t\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\t\t\t\tvalue: data.user.id,\n\t\t\t\t\t\t\tidentifier,\n\t\t\t\t\t\t\texpiresAt: new Date(Date.now() + maxAge * 1000),\n\t\t\t\t\t\t});\n\t\t\t\t\t\tawait ctx.setSignedCookie(\n\t\t\t\t\t\t\ttwoFactorCookie.name,\n\t\t\t\t\t\t\tidentifier,\n\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t\ttwoFactorCookie.attributes,\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\ttwoFactorRedirect: true,\n\t\t\t\t\t\t});\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\tschema: mergeSchema(schema, options?.schema),\n\t\trateLimit: [\n\t\t\t{\n\t\t\t\tpathMatcher(path) {\n\t\t\t\t\treturn path.startsWith(\"/two-factor/\");\n\t\t\t\t},\n\t\t\t\twindow: 10,\n\t\t\t\tmax: 3,\n\t\t\t},\n\t\t],\n\t\t$ERROR_CODES: TWO_FACTOR_ERROR_CODES,\n\t} satisfies BetterAuthPlugin;\n};\n\nexport * from \"./client\";\nexport * from \"./types\";\n", "import { defineErrorCodes } from \"@better-auth/core/utils\";\n\nexport const USERNAME_ERROR_CODES = defineErrorCodes({\n\tINVALID_USERNAME_OR_PASSWORD: \"Invalid username or password\",\n\tEMAIL_NOT_VERIFIED: \"Email not verified\",\n\tUNEXPECTED_ERROR: \"Unexpected error\",\n\tUSERNAME_IS_ALREADY_TAKEN: \"Username is already taken. Please try another.\",\n\tUSERNAME_TOO_SHORT: \"Username is too short\",\n\tUSERNAME_TOO_LONG: \"Username is too long\",\n\tINVALID_USERNAME: \"Username is invalid\",\n\tINVALID_DISPLAY_USERNAME: \"Display username is invalid\",\n});\n", "import type { BetterAuthPluginDBSchema } from \"@better-auth/core/db\";\n\nexport const getSchema = (normalizer: {\n\tusername: (username: string) => string;\n\tdisplayUsername: (displayUsername: string) => string;\n}) => {\n\treturn {\n\t\tuser: {\n\t\t\tfields: {\n\t\t\t\tusername: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\tsortable: true,\n\t\t\t\t\tunique: true,\n\t\t\t\t\treturned: true,\n\t\t\t\t\ttransform: {\n\t\t\t\t\t\tinput(value) {\n\t\t\t\t\t\t\treturn typeof value !== \"string\"\n\t\t\t\t\t\t\t\t? value\n\t\t\t\t\t\t\t\t: normalizer.username(value as string);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tdisplayUsername: {\n\t\t\t\t\ttype: \"string\",\n\t\t\t\t\trequired: false,\n\t\t\t\t\ttransform: {\n\t\t\t\t\t\tinput(value) {\n\t\t\t\t\t\t\treturn typeof value !== \"string\"\n\t\t\t\t\t\t\t\t? value\n\t\t\t\t\t\t\t\t: normalizer.displayUsername(value as string);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t} satisfies BetterAuthPluginDBSchema;\n};\n\nexport type UsernameSchema = ReturnType<typeof getSchema>;\n", "import type { BetterAuthPlugin } from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport type { Account, User } from \"@better-auth/core/db\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { createEmailVerificationToken } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { mergeSchema } from \"../../db\";\nimport type { InferOptionSchema } from \"../../types/plugins\";\nimport { USERNAME_ERROR_CODES as ERROR_CODES } from \"./error-codes\";\nimport type { UsernameSchema } from \"./schema\";\nimport { getSchema } from \"./schema\";\n\nexport { USERNAME_ERROR_CODES } from \"./error-codes\";\n\nexport type UsernameOptions = {\n\tschema?: InferOptionSchema<UsernameSchema> | undefined;\n\t/**\n\t * The minimum length of the username\n\t *\n\t * @default 3\n\t */\n\tminUsernameLength?: number | undefined;\n\t/**\n\t * The maximum length of the username\n\t *\n\t * @default 30\n\t */\n\tmaxUsernameLength?: number | undefined;\n\t/**\n\t * A function to validate the username\n\t *\n\t * By default, the username should only contain alphanumeric characters and underscores\n\t */\n\tusernameValidator?:\n\t\t| ((username: string) => boolean | Promise<boolean>)\n\t\t| undefined;\n\t/**\n\t * A function to validate the display username\n\t *\n\t * By default, no validation is applied to display username\n\t */\n\tdisplayUsernameValidator?:\n\t\t| ((displayUsername: string) => boolean | Promise<boolean>)\n\t\t| undefined;\n\t/**\n\t * A function to normalize the username\n\t *\n\t * @default (username) => username.toLowerCase()\n\t */\n\tusernameNormalization?: (((username: string) => string) | false) | undefined;\n\t/**\n\t * A function to normalize the display username\n\t *\n\t * @default false\n\t */\n\tdisplayUsernameNormalization?:\n\t\t| (((displayUsername: string) => string) | false)\n\t\t| undefined;\n\t/**\n\t * The order of validation\n\t *\n\t * @default { username: \"pre-normalization\", displayUsername: \"pre-normalization\" }\n\t */\n\tvalidationOrder?:\n\t\t| {\n\t\t\t\t/**\n\t\t\t\t * The order of username validation\n\t\t\t\t *\n\t\t\t\t * @default \"pre-normalization\"\n\t\t\t\t */\n\t\t\t\tusername?: \"pre-normalization\" | \"post-normalization\";\n\t\t\t\t/**\n\t\t\t\t * The order of display username validation\n\t\t\t\t *\n\t\t\t\t * @default \"pre-normalization\"\n\t\t\t\t */\n\t\t\t\tdisplayUsername?: \"pre-normalization\" | \"post-normalization\";\n\t\t  }\n\t\t| undefined;\n};\n\nfunction defaultUsernameValidator(username: string) {\n\treturn /^[a-zA-Z0-9_.]+$/.test(username);\n}\n\nconst signInUsernameBodySchema = z.object({\n\tusername: z.string().meta({ description: \"The username of the user\" }),\n\tpassword: z.string().meta({ description: \"The password of the user\" }),\n\trememberMe: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"Remember the user session\",\n\t\t})\n\t\t.optional(),\n\tcallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The URL to redirect to after email verification\",\n\t\t})\n\t\t.optional(),\n});\n\nconst isUsernameAvailableBodySchema = z.object({\n\tusername: z.string().meta({\n\t\tdescription: \"The username to check\",\n\t}),\n});\n\nexport const username = (options?: UsernameOptions | undefined) => {\n\tconst normalizer = (username: string) => {\n\t\tif (options?.usernameNormalization === false) {\n\t\t\treturn username;\n\t\t}\n\t\tif (options?.usernameNormalization) {\n\t\t\treturn options.usernameNormalization(username);\n\t\t}\n\t\treturn username.toLowerCase();\n\t};\n\n\tconst displayUsernameNormalizer = (displayUsername: string) => {\n\t\treturn options?.displayUsernameNormalization\n\t\t\t? options.displayUsernameNormalization(displayUsername)\n\t\t\t: displayUsername;\n\t};\n\n\treturn {\n\t\tid: \"username\",\n\t\tinit(ctx) {\n\t\t\treturn {\n\t\t\t\toptions: {\n\t\t\t\t\tdatabaseHooks: {\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tcreate: {\n\t\t\t\t\t\t\t\tasync before(user, context) {\n\t\t\t\t\t\t\t\t\tconst username =\n\t\t\t\t\t\t\t\t\t\t\"username\" in user ? (user.username as string) : null;\n\t\t\t\t\t\t\t\t\tconst displayUsername =\n\t\t\t\t\t\t\t\t\t\t\"displayUsername\" in user\n\t\t\t\t\t\t\t\t\t\t\t? (user.displayUsername as string)\n\t\t\t\t\t\t\t\t\t\t\t: null;\n\n\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\t\t\t...user,\n\t\t\t\t\t\t\t\t\t\t\t...(username ? { username: normalizer(username) } : {}),\n\t\t\t\t\t\t\t\t\t\t\t...(displayUsername\n\t\t\t\t\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisplayUsername:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisplayUsernameNormalizer(displayUsername),\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tupdate: {\n\t\t\t\t\t\t\t\tasync before(user, context) {\n\t\t\t\t\t\t\t\t\tconst username =\n\t\t\t\t\t\t\t\t\t\t\"username\" in user ? (user.username as string) : null;\n\t\t\t\t\t\t\t\t\tconst displayUsername =\n\t\t\t\t\t\t\t\t\t\t\"displayUsername\" in user\n\t\t\t\t\t\t\t\t\t\t\t? (user.displayUsername as string)\n\t\t\t\t\t\t\t\t\t\t\t: null;\n\n\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\t\t\t...user,\n\t\t\t\t\t\t\t\t\t\t\t...(username ? { username: normalizer(username) } : {}),\n\t\t\t\t\t\t\t\t\t\t\t...(displayUsername\n\t\t\t\t\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisplayUsername:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisplayUsernameNormalizer(displayUsername),\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tendpoints: {\n\t\t\tsignInUsername: createAuthEndpoint(\n\t\t\t\t\"/sign-in/username\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: signInUsernameBodySchema,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\topenapi: {\n\t\t\t\t\t\t\tsummary: \"Sign in with username\",\n\t\t\t\t\t\t\tdescription: \"Sign in with username\",\n\t\t\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Session token for the authenticated session\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\"token\", \"user\"],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t422: {\n\t\t\t\t\t\t\t\t\tdescription: \"Unprocessable Entity. Validation error\",\n\t\t\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tif (!ctx.body.username || !ctx.body.password) {\n\t\t\t\t\t\tctx.context.logger.error(\"Username or password not found\");\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME_OR_PASSWORD,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst username =\n\t\t\t\t\t\toptions?.validationOrder?.username === \"pre-normalization\"\n\t\t\t\t\t\t\t? normalizer(ctx.body.username)\n\t\t\t\t\t\t\t: ctx.body.username;\n\n\t\t\t\t\tconst minUsernameLength = options?.minUsernameLength || 3;\n\t\t\t\t\tconst maxUsernameLength = options?.maxUsernameLength || 30;\n\n\t\t\t\t\tif (username.length < minUsernameLength) {\n\t\t\t\t\t\tctx.context.logger.error(\"Username too short\", {\n\t\t\t\t\t\t\tusername,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\t\tcode: \"USERNAME_TOO_SHORT\",\n\t\t\t\t\t\t\tmessage: ERROR_CODES.USERNAME_TOO_SHORT,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (username.length > maxUsernameLength) {\n\t\t\t\t\t\tctx.context.logger.error(\"Username too long\", {\n\t\t\t\t\t\t\tusername,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.USERNAME_TOO_LONG,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst validator =\n\t\t\t\t\t\toptions?.usernameValidator || defaultUsernameValidator;\n\n\t\t\t\t\tconst valid = await validator(username);\n\t\t\t\t\tif (!valid) {\n\t\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = await ctx.context.adapter.findOne<\n\t\t\t\t\t\tUser & { username: string; displayUsername: string }\n\t\t\t\t\t>({\n\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"username\",\n\t\t\t\t\t\t\t\tvalue: normalizer(username),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\t// Hash password to prevent timing attacks from revealing valid usernames\n\t\t\t\t\t\t// By hashing passwords for invalid usernames, we ensure consistent response times\n\t\t\t\t\t\tawait ctx.context.password.hash(ctx.body.password);\n\t\t\t\t\t\tctx.context.logger.error(\"User not found\", {\n\t\t\t\t\t\t\tusername,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME_OR_PASSWORD,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst account = await ctx.context.adapter.findOne<Account>({\n\t\t\t\t\t\tmodel: \"account\",\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"providerId\",\n\t\t\t\t\t\t\t\tvalue: \"credential\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\tif (!account) {\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME_OR_PASSWORD,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst currentPassword = account?.password;\n\t\t\t\t\tif (!currentPassword) {\n\t\t\t\t\t\tctx.context.logger.error(\"Password not found\", {\n\t\t\t\t\t\t\tusername,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME_OR_PASSWORD,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst validPassword = await ctx.context.password.verify({\n\t\t\t\t\t\thash: currentPassword,\n\t\t\t\t\t\tpassword: ctx.body.password,\n\t\t\t\t\t});\n\t\t\t\t\tif (!validPassword) {\n\t\t\t\t\t\tctx.context.logger.error(\"Invalid password\");\n\t\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME_OR_PASSWORD,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tctx.context.options?.emailAndPassword?.requireEmailVerification &&\n\t\t\t\t\t\t!user.emailVerified\n\t\t\t\t\t) {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t!ctx.context.options?.emailVerification?.sendVerificationEmail\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\t\t\tmessage: ERROR_CODES.EMAIL_NOT_VERIFIED,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (ctx.context.options?.emailVerification?.sendOnSignIn) {\n\t\t\t\t\t\t\tconst token = await createEmailVerificationToken(\n\t\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t\t\tuser.email,\n\t\t\t\t\t\t\t\tundefined,\n\t\t\t\t\t\t\t\tctx.context.options.emailVerification?.expiresIn,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tconst url = `${ctx.context.baseURL}/verify-email?token=${token}&callbackURL=${\n\t\t\t\t\t\t\t\tctx.body.callbackURL || \"/\"\n\t\t\t\t\t\t\t}`;\n\t\t\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\t\t\tctx.context.options.emailVerification.sendVerificationEmail(\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuser: user,\n\t\t\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\t\t\ttoken,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tctx.request,\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.EMAIL_NOT_VERIFIED,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\tuser.id,\n\t\t\t\t\t\tctx.body.rememberMe === false,\n\t\t\t\t\t);\n\t\t\t\t\tif (!session) {\n\t\t\t\t\t\treturn ctx.json(null, {\n\t\t\t\t\t\t\tstatus: 500,\n\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tawait setSessionCookie(\n\t\t\t\t\t\tctx,\n\t\t\t\t\t\t{ session, user },\n\t\t\t\t\t\tctx.body.rememberMe === false,\n\t\t\t\t\t);\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\ttoken: session.token,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\t\temailVerified: user.emailVerified,\n\t\t\t\t\t\t\tusername: user.username,\n\t\t\t\t\t\t\tdisplayUsername: user.displayUsername,\n\t\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t\t\tcreatedAt: user.createdAt,\n\t\t\t\t\t\t\tupdatedAt: user.updatedAt,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t\tisUsernameAvailable: createAuthEndpoint(\n\t\t\t\t\"/is-username-available\",\n\t\t\t\t{\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tbody: isUsernameAvailableBodySchema,\n\t\t\t\t},\n\t\t\t\tasync (ctx) => {\n\t\t\t\t\tconst username = ctx.body.username;\n\t\t\t\t\tif (!username) {\n\t\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst minUsernameLength = options?.minUsernameLength || 3;\n\t\t\t\t\tconst maxUsernameLength = options?.maxUsernameLength || 30;\n\n\t\t\t\t\tif (username.length < minUsernameLength) {\n\t\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\t\tcode: \"USERNAME_TOO_SHORT\",\n\t\t\t\t\t\t\tmessage: ERROR_CODES.USERNAME_TOO_SHORT,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (username.length > maxUsernameLength) {\n\t\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.USERNAME_TOO_LONG,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst validator =\n\t\t\t\t\t\toptions?.usernameValidator || defaultUsernameValidator;\n\n\t\t\t\t\tconst valid = await validator(username);\n\t\t\t\t\tif (!valid) {\n\t\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst user = await ctx.context.adapter.findOne<User>({\n\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"username\",\n\t\t\t\t\t\t\t\tvalue: normalizer(username),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t\tif (user) {\n\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\tavailable: false,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tavailable: true,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t\tschema: mergeSchema(\n\t\t\tgetSchema({\n\t\t\t\tusername: normalizer,\n\t\t\t\tdisplayUsername: displayUsernameNormalizer,\n\t\t\t}),\n\t\t\toptions?.schema,\n\t\t),\n\t\thooks: {\n\t\t\tbefore: [\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\tcontext.path === \"/sign-up/email\" ||\n\t\t\t\t\t\t\tcontext.path === \"/update-user\"\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tconst username =\n\t\t\t\t\t\t\ttypeof ctx.body.username === \"string\" &&\n\t\t\t\t\t\t\toptions?.validationOrder?.username === \"post-normalization\"\n\t\t\t\t\t\t\t\t? normalizer(ctx.body.username)\n\t\t\t\t\t\t\t\t: ctx.body.username;\n\n\t\t\t\t\t\tif (username !== undefined && typeof username === \"string\") {\n\t\t\t\t\t\t\tconst minUsernameLength = options?.minUsernameLength || 3;\n\t\t\t\t\t\t\tconst maxUsernameLength = options?.maxUsernameLength || 30;\n\t\t\t\t\t\t\tif (username.length < minUsernameLength) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\t\tcode: \"USERNAME_TOO_SHORT\",\n\t\t\t\t\t\t\t\t\tmessage: ERROR_CODES.USERNAME_TOO_SHORT,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (username.length > maxUsernameLength) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\t\tmessage: ERROR_CODES.USERNAME_TOO_LONG,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst validator =\n\t\t\t\t\t\t\t\toptions?.usernameValidator || defaultUsernameValidator;\n\n\t\t\t\t\t\t\tconst valid = await validator(username);\n\t\t\t\t\t\t\tif (!valid) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_USERNAME,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst user = await ctx.context.adapter.findOne<User>({\n\t\t\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tfield: \"username\",\n\t\t\t\t\t\t\t\t\t\tvalue: username,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tconst blockChangeSignUp = ctx.path === \"/sign-up/email\" && user;\n\t\t\t\t\t\t\tconst blockChangeUpdateUser =\n\t\t\t\t\t\t\t\tctx.path === \"/update-user\" &&\n\t\t\t\t\t\t\t\tuser &&\n\t\t\t\t\t\t\t\tctx.context.session &&\n\t\t\t\t\t\t\t\tuser.id !== ctx.context.session.session.userId;\n\t\t\t\t\t\t\tif (blockChangeSignUp || blockChangeUpdateUser) {\n\t\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\t\tmessage: ERROR_CODES.USERNAME_IS_ALREADY_TAKEN,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst displayUsername =\n\t\t\t\t\t\t\ttypeof ctx.body.displayUsername === \"string\" &&\n\t\t\t\t\t\t\toptions?.validationOrder?.displayUsername === \"post-normalization\"\n\t\t\t\t\t\t\t\t? displayUsernameNormalizer(ctx.body.displayUsername)\n\t\t\t\t\t\t\t\t: ctx.body.displayUsername;\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tdisplayUsername !== undefined &&\n\t\t\t\t\t\t\ttypeof displayUsername === \"string\"\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tif (options?.displayUsernameValidator) {\n\t\t\t\t\t\t\t\tconst valid =\n\t\t\t\t\t\t\t\t\tawait options.displayUsernameValidator(displayUsername);\n\t\t\t\t\t\t\t\tif (!valid) {\n\t\t\t\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\t\t\t\tmessage: ERROR_CODES.INVALID_DISPLAY_USERNAME,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tmatcher(context) {\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\tcontext.path === \"/sign-up/email\" ||\n\t\t\t\t\t\t\tcontext.path === \"/update-user\"\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\thandler: createAuthMiddleware(async (ctx) => {\n\t\t\t\t\t\tif (ctx.body.username && !ctx.body.displayUsername) {\n\t\t\t\t\t\t\tctx.body.displayUsername = ctx.body.username;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (ctx.body.displayUsername && !ctx.body.username) {\n\t\t\t\t\t\t\tctx.body.username = ctx.body.displayUsername;\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\toptions,\n\t\t$ERROR_CODES: ERROR_CODES,\n\t} satisfies BetterAuthPlugin;\n};\n"],
  "mappings": "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",
  "names": ["role", "role", "email", "where: Where[]", "role", "schema", "email", "schema", "apiKey", "userIds: string[]", "apiKeys: ApiKey[]", "apiKey", "schema", "apiKey", "updated: ApiKey", "newApiKey: ApiKey | null", "deleteAllExpiredApiKeys", "apiKey: ApiKey | null", "schema", "deleteAllExpiredApiKeys", "start: string | null", "data: Omit<ApiKey, \"id\">", "apiKey: ApiKey", "apiKey", "generateId", "deleteAllExpiredApiKeys", "deleteApiKey", "schema", "deleteAllExpiredApiKeys", "apiKey: ApiKey | null", "apiKey", "deleteApiKeyFromStorage", "error: any", "getApiKey", "schema", "deleteAllExpiredApiKeys", "apiKey: ApiKey | null", "apiKey", "listApiKeys", "schema", "deleteAllExpiredApiKeys", "apiKeys: ApiKey[]", "listApiKeysFromStorage", "apiKey", "returningApiKey", "schema", "deleteAllExpiredApiKeys", "apiKey: ApiKey | null", "apiKey", "newValues: Partial<ApiKey>", "newApiKey: ApiKey", "updated: ApiKey", "error: any", "lastChecked: Date | null", "schema", "getApiKey", "date", "ms", "value", "schema", "options", "apiKey", "siteVerifyMap: Record<Provider, string>", "verifyHandlers.cloudflareTurnstile", "verifyHandlers.googleRecaptcha", "verifyHandlers.hCaptcha", "verifyHandlers.captchaFox", "deviceCode", "verificationUrl: URL", "schema", "schema", "defaultKeyHasher", "defaultKeyHasher", "ERROR_CODES", "email", "session", "defaultOTPGenerator", "email", "ERROR_CODES", "getUserInfo", "getUserInfo", "getUserInfo", "getUserInfo", "profile: LineUserInfo | LineIdTokenPayload | null", "getUserInfo", "getUserInfo", "getUserInfo", "getUserInfo", "tokens: OAuth2Tokens | undefined", "defaultErrorURL", "userInfo: Omit<User, \"createdAt\" | \"updatedAt\">", "userInfo", "email", "toRedirectTo: string", "toRedirectTo", "ERROR_CODES", "line", "jwk: Omit<Jwk, \"id\">", "jwt", "schema", "jwt", "verifyJWTHelper", "schema", "defaultKeyHasher", "defaultKeyHasher", "email", "query", "schema", "consentCode: string | null", "accessToken", "email", "idToken: string", "client: Client", "validatedClientId: string | null", "validatedUserId: string | null", "schema", "redirectURIWithCode", "accessToken", "accessTokenExpiresAt", "refreshTokenExpiresAt", "email", "schema", "ERROR_CODES", "decryptedPayload: string | null", "payload: EncryptedCookiesPayload", "options: CookieOptions", "cookieValue: string", "statePackage: OAuthProxyStatePackage | undefined", "stateCookieValue: string", "parsedState: { callbackURL?: string } | undefined", "statePackage: OAuthProxyStatePackage", "payload: any", "email", "session", "defaultKeyHasher", "defaultKeyHasher", "schema: FieldSchema", "schema", "parameters: OpenAPIParameter[]", "properties: Record<string, any>", "required: string[]", "properties: Record<string, FieldSchema>", "key", "paths: Record<string, Path>", "options", "schema", "organization", "user", "role", "userId: string", "member", "email", "defaultRoles", "shimmedObj: Record<string, any>", "role", "hasPermission", "acRoles: {\n\t\t[x: string]: Role<any> | undefined;\n\t}", "defaultRoles", "role", "role", "hasPermission", "defaultRoles", "condition: Where", "updateData: Partial<OrganizationRole>", "hasNecessaryPermissions: {\n\t\tresource: { [x: string]: string[] };\n\t\thasPermission: boolean;\n\t}[]", "errorMessage: string", "email", "hasPermission", "parseRoles", "defaultRoles", "role", "organization", "teamIds", "teamIds: string[]", "organization", "parseRoles", "toBeRemovedMember: InferMember<O, false> | null", "member", "hasPermission", "roleToSet: string[]", "updatedMember", "options", "organization", "member:\n\t\t\t\t| (Member & InferAdditionalFieldsFromPluginOptions<\"member\", O, false>)\n\t\t\t\t| undefined", "teamMember: TeamMember | null", "hasPermission", "defaultRoles", "hasPermission", "organization", "updatedTeam", "teamId: string", "parseRoles", "hasPermission", "defaultRoles", "teamSchema", "organizationRoleSchema", "schema", "phoneNumber", "user", "schema", "schema", "schema", "schema", "email", "user: User | null", "existingWalletAddress: WalletAddress | null", "anyWalletAddress: WalletAddress | null", "error: unknown", "session", "ctx", "twoFactor", "defaultKeyHasher", "storeOTP", "defaultKeyHasher", "schema", "twoFactor", "schema", "username", "ERROR_CODES"]
}
